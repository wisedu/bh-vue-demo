/**
 * emapJs
 * version: 1.7.2_EM9
 * author: WISEDU_FE
 */

 /***
 * 英文 i18n
 */
(function(WIS_I18N, undefined) {
    WIS_I18N.en = {
        /**
         * 高级搜索
         */
        'bh_aq_search': 'Search',
        'bh_aq_enter': 'Please enter ',
        'bh_aq_topScheme': 'Top scheme (Will appear on the search bar directly)',
        'bh_aq_otherScheme': 'Other scheme',
        'bh_aq_advancedSearchSheme': 'Advanced Search Scheme',
        'bh_aq_delete': 'Delete',
        'bh_aq_cancelTheTop': 'Cancel the top',
        'bh_aq_top': 'Top',
        'bh_aq_advancedSearch': 'Advanced Search',
        'bh_aq_commonScheme': 'Common Scheme',
        'bh_aq_more': 'More',
        'bh_aq_keyWord': 'KeyWord',
        'bh_aq_save': 'Save',
        'bh_aq_cancel': 'Cancel',
        'bh_aq_fixedToSearchBar': 'Fixed to Search Bar',
        'bh_aq_saveAsScheme': 'Save as Scheme',
        'bh_aq_closeAdvancedSearch': '[Close Advanced Search]',
        'bh_aq_doAdvancedSearch': 'Do Advanced Search',
        'bh_aq_addTheSearchField': 'Add the Search Field',
        'bh_aq_clearSearch': 'Clear Search',
        'bh_aq_recorders': 'recorders',
        'bh_aq_success': 'Success',

        /**
         * 条件搜索
         */
        'bh_fq_conditionFilter': 'condition filter',
        'bh_fq_expend': 'expend',
        'bh_fq_clearCondition': 'Clear condition',
        'bh_fq_moreCondition': 'More condition',
        'bh_fq_collapse': 'collapse',
        'bh_fq_search': 'Search',

        /**
         * 上传组件
         */
        'bh_up_batchUpload': 'Batch upload',
        'bh_up_uploadFile': 'Upload file',
        'bh_up_sortFile': 'Sort file',
        'bh_up_cancel': 'cancel',
        'bh_up_completeSorting': 'Complete sorting',
        'bh_up_dragToSort': 'Drag to sort',
        'bh_up_annotation': 'annotation',
        'bh_up_uploadAgain': 'Upload again',
        'bh_up_cancelTheUpload': 'Cancel the upload',

        /**
         * 批量编辑
         */
        'bh_be_unchooseTip': 'Unchoosed ! Please choose items then edit',
        'bh-be-choosed': 'You have choosed',
        'bh-be-piecesOfDatas': 'pieces of datas',
        'bh-be-keysList': 'KeyWord List',
        'bh-be-search': 'Search',
        'bh-be-bulkEdit': 'Bulk Edit',
        'bh-be-sureEdit': 'Sure Edit',
        'bh-be-willBulkEdit': 'This will bulk edit keyWords,are you sure ?',
        'bh-be-back': 'Back',
        'bh-be-piecesOfKeys': 'pieces of keys',

        /**
         * 下拉树
         */
        'bh-ddt-allChoose': 'All choose',
        'bh-ddt-search': 'Search',
        'bh-ddt-pleaseChoose': 'Please choose',
        'bh-ddt-empty': 'Empty',

        /**
         * 条件构造器
         */
        'bh-cc-search': 'Search',
        'bh-cc-condcons': 'Condition Constructor',
        'bh-cc-and': 'AND',
        'bh-cc-or': 'OR',
        'bh-cc-append': 'append',
        'bh-cc-save': 'Save',
        'bh_cc_delete': 'Delete',
        'bh-cc-clear': 'Clear',
        'bh-cc-back': 'Back',
        'bh-cc-takeConditionSearch': 'Run condition search',
        'bh-cc-saveAsScheme': 'Save as scheme',
        'bh-cc-pleaseInput': 'Please input',
        'bh-cc-pleaseFind': 'Please find',
        'bh-cc-backTip': 'This will clear the result after backing,sure?',
        'bh-cc-willClearConditions': 'This will clear the inputed conditions,sure?',
        'bh-cc-checkError': 'There is something wrong with your conditions inputed,maybe just as following,please check it carefully.',
        'bh-cc-checkBrackets': 'Brackets "()" donot match',
        'bh-cc-conditionsWithoutAndOr': 'There is no "AND" or "OR" betewwen conditons.',
        'bh-cc-andOrWithoutConditions': 'There is no conditon betewwen "AND" or "OR".',
        'bh-cc-error': 'Error!',
        'bh-cc-ok': 'Ok',

        /**
         * emap数据表格
         */
        'bh-dd-exportChoosedKeys': 'Export choosed keys',
        'bh-dd-showOrHideKeys': 'Show / Hide Keys',
        'bh-dd-exportRequestFailed': 'Fail to export request datas',
        'bh-dd-error': 'Error',
        'bh-dd-contactAdmin': 'Systerm is exception,please contact System Administrator',
        'bh-dd-choose': 'choose',

        /**
         * emap表单
         */
        'bh-fi-checkRuleExist': 'Check rules have existed! ',
        'bh-fi-notRight': 'Error',
        'bh-fi-lengthExit': ' overlength',
        'bh-fi-lengthNotPass': 'length cannot pass',
        'bh-fi-letters': 'letters',
        'bh-fi-now': 'Now',
        'bh-fi-wrongInUploadFiles': 'Wrong In Upload Files',


        /**
         * emap导入
         */
        'bh-ip-failToGetDownloadAddress': 'Fail to get download address',
        'bh-ip-importDatas': 'Import datas',
        'bh-ip-uploadRightExcel': 'Please upload the right Excel file',
        'bh-ip-uploading': 'Uploading',
        'bh-ip-importFailed': 'Fail to import',
        'bh-ip-numOfImportDatas': 'The total number of imported datas are',
        'bh-ip-piece': 'pieces',
        'bh-ip-successInImport': 'Import successfully!',
        'bh-ip-importFinished': 'Import finish',
        'bh-ip-numOfSuccess': 'The number of importing success is',
        'bh-ip-numOfFail': 'The number of importing fail is',
        'bh-ip-uploadFile': 'Upload files',
        'bh-ip-firstTimeTips': 'If it is the first time,we suggest you to ',
        'bh-ip-downloadModules': 'download the template of importing',
        'bh-ip-viewing': ' for reference.',
        'bh-ip-startUploading': 'Start uploading',
        'bh-ip-reupload': 'Reupload',
        'bh-ip-sureUpload': 'Sure to upload',
        'bh-ip-waitUploadedAutoImporting': 'After uploading files,it will import datas automatically',
        'bh-ip-finish': 'Finish',
        'bh-ip-importDetails': 'This file has imported 10000 datas,but fail 2 pieces',
        'bh-ip-viewDetails': 'View results',
        'bh-ip-downloadResult': 'Download datas from importing',
        'bh-ip-sureClose': 'Sure to close',


        /**
         * emap导入2
         */
        'bh-ip2-importDatas': 'Import datas',
        'bh-ip2-sureBack': 'Backing will lead uploading fail,sure?',
        'bh-ip2-notleave': 'Importing datas is soon,please not leaving!',
        'bh-ip2-uploading': 'Now it is uploading,',
        'bh-ip2-bePatient': 'Now it is uploading,please be patient!',
        'bh-ip2-uploadExcel': 'Please upload the right Excel file!',
        'bh-ip2-badNetwork': 'Bad network ,importing fail,please check the network!',
        'bh-ip2-bigFile': 'Big files!Please adjust the size blow 10M!',
        'bh-ip2-virusFile': 'Virus files!,please rechoose the files!',
        'bh-ip2-emptyFile': 'The upload files donot have datas,please reupload!',
        'bh-ip2-typeFile': 'Please upload the right Excel file!',
        'bh-ip2-importing': 'It is importing now!',
        'bh-ip2-freshNetwork': 'Bad network ,please contact it and view the imported result!',
        'bh-ip2-databaseError': 'Database error,fail in importing!please try again or contact the Systerm Administrator',
        'bh-ip2-30second': 'It will take 30 seconds.',
        'bh-ip2-1minute': 'It will take 1 minutes.',
        'bh-ip2-2minute': 'It will take 2 minutes.',
        'bh-ip2-4minute': 'It will take 4 minutes.',
        'bh-ip2-6minute': 'It will take 6 minutes.',
        'bh-ip2-longMinute': 'Big files ! Please be patient!',
        'bh-ip2-uploadFile': 'Upload files',
        'bh-ip2-checkDatas': 'Check datas',
        'bh-ip2-firstTime': 'If this is the first time in using,you should',
        'bh-ip2-chooseFiles': 'Choose files',
        'bh-ip2-downloadImportModel': 'Download importing model',
        'bh-ip2-uploadAfterInput': 'Uploading after inputing',
        'bh-ip2-server': 'Server',
        'bh-ip2-uploadingFilesNow': 'It is uploading files now!',
        'bh-ip2-takeTime': 'It has taked ',
        'bh-ip2-sureClose': 'Sure and close',
        'bh-ip2-rechoose': 'Rechoose',
        'bh-ip2-checkDatasAndWait': 'Checking datas is very fast,please be patient!',
        'bh-ip2-checkedResult': 'After checking , the total number of your datas is',
        'bh-ip2-piece': 'pieces',
        'bh-ip2-rightDatas': 'After checking , the right datas number is',
        'bh-ip2-wrongDatas': 'pieces,the wrong datas number is',
        'bh-ip2-downloadWrongFiles': 'Download wrong files',
        'bh-ip2-onlyImportRightDatas': 'Only import the right datas',
        'bh-ip2-successImport': 'The number of datas which is success in importing is',


        /**
         * emapQuery
         */
        'bh-q-setConditions': 'Set conditions',
        'bh-q-searchPlan': 'Search plans',
        'bh-q-viewMoreConditions': 'View more conditions',
        'bh-q-gather': 'Gather',
        'bh-q-clear': 'Clear',
        'bh-q-saveAsSearchPlan': 'Save as search plan',
        'bh-q-nowSearchCondition': 'Now search conditions',
        'bh-q-noPlan': 'No plan',
        'bh-q-newPlan': 'New plan',
        'bh-q-inputPlanName': 'Please input the name of plan',
        'bh-q-save': 'Save',
        'bh-q-cancel': 'Cancel',
        'bh-q-search': 'Search',
        'bh-q-sure': 'Sure',
        'bh-q-all': 'All',
        'bh-q-is': 'Is',
        'bh-q-delete': 'Delete',
        'bh-q-cancelSetTop': 'Cancel set top',
        'bh-q-setTop': 'Set top',
        'bh-q-addSearchKeys': 'Add search keys',

        /**
         * emapService
         */
        'bh-sv-noDatas': 'No datas',


        /**
         * emapSchema
         */
        'bh-sm-inputSchemaName': 'Please input the schema name',
        'bh-sm-schemaNameIsNull': 'The schema name is empty',
        'bh-sm-successSave': 'Success Save',
        'bh-sm-failSave': 'Fail Save',
        'bh-sm-successDelete': 'Success Delete',

        /**
         * emapRulesConstructor
         */
        'bh-rc-addAndConditions': '+ add[AND]condition',
        'bh-rc-addOrConditions': "+ add[OR]condition",
        'bh-rc-edit': 'Edit',
        'bh-rc-setConditionSchema': 'Set Condition Schema',
        'bh-rc-setSchemaTop': 'Set Schema Top(This will show on the search input)',
        'bh-rc-otherSchema': 'Other Schema',
        'bh-rc-delete': 'Delete',
        'bh-rc-cancelTop': 'Cancel Top',
        'bh-rc-setTop': 'Set Top',
        'bh-rc-makeSchema': 'Make Schema',
        'bh-rc-more': 'More',
        'bh-rc-pleaseInput': 'Please input',
        'bh-rc-search': 'Search',
        'bh-rc-chooseFindingTasks': "Choose finding tasks...",
        'bh-rc-pleaseFind': "Please find",
        'bh-rc-chooseConditions': "Choose conditions...",
        'bh-rc-onlyHave': '[undefined]Only have[Equel] [Not Equel] [Include]',
        'bh-rc-dropdownTreeTip': 'The max Number items of dropdown tree is 1000',
        'bh-rc-or': 'OR',
        'bh-rc-multiValueSpilt': 'multi value will split by ","',
        'bh-rc-and': 'AND',
        'bh-rc-conditionDesigner': 'Condition Designer',
        'bh-rc-takeConditionsSearch': 'Take Conditions Search',
        'bh-rc-inputPlanName': 'Please input schema name',
        'bh-rc-save': 'Save',
        'bh-rc-cancel': 'Cancel',
        'bh-rc-fixToSearchInput': 'Fixed on the search input',
        'bh-rc-saveAsPlan': 'Save as schema',
        'bh-rc-closeConditionDesigner': 'Close Condition Designer',

        /**
         * emapLinkage
         */
        'bh-la-pleaseChoose': 'Please choose...',

        /**
         * emapGrid
         */
        'bh-gd-customColumns': 'Custom Columns',
        'bh-gd-table': 'Table',
        'bh-gd-card': 'Card',

        /**
         * emapEditor
         */
        'bh-et-uploadRightType': 'Please upload the right type of images',

        /**
         * emapEditableDataTable
         */
        'bh-edt-originDatas': 'Origin Datas',
        'bh-edt-newRow': 'New row',

        /**
         * emapCard
         */
        'bh-cd-noDatas': 'No datas',

        /**
         * emapAvatarUpload
         */
        'bh-au-adjustHeadImage': 'Adjust Head Image',
        'bh-au-uploadFromLocal': 'Upload From Local',
        'bh-au-RecommondHeadImage': 'Recommond Head Image',
        'bh-au-wrongType': 'Wrong Type',
        'bh-au-passTheMax': 'The file size pass the max',
        'bh-au-imageUploadFail': 'Image Upload Fail',
        'bh-au-chooseImages': 'Choose Images',
        'bh-au-reupload': 'Reupload',
        'bh-au-uploadHeadImage': 'Upload Head Image',
        'bh-au-onlyHave': 'Only have',
        'bh-be-sizeNotPass': 'Size Not Pass',
        'bh-au-avatarFail': 'Avatar Fail',
        'bh-au-requestFail': 'Request Fail',

        /**
         * emapForm
         */
        'bh-fm-saveUploadFilesFail': 'Save Upload Files Fail',
        'bh-fm-gather': 'Flod',
        'bh-fm-expand': 'Expand',

        /**
         * emapFileDownload
         */
        'bh-fd-download': 'Download',
        'bh-fd-batchDownload': 'Batch Download',
        'bh-fd-none': ' None',

        /**
         * emapFilePhoto
         */
        'bh-fp-uploadSuccess': 'Upload Success',
        'bh-fp-upload': 'Upload',
        'bh-fp-typeError': 'File Type Error',
        'bh-fp-sizeOverflow': 'File Size Exceeded Limit',
        'bh-fp-uploadFail': 'File Size Upload Fail',

        /**
         * emapFileUpload
         */
        'bh-fu-warning': 'Warning',
        'bh-fu-warningContent': 'There is a file being uploaded. The operation may cause file loss. Do you want to continue?',
        'bh-fu-conFirmUpload': 'Confirm and Submit',
        'bh-fu-cancelUpload': 'Cancel',
        'bh-fu-upload': 'Upload',
        'bh-fu-saveFail': 'Save fail',
        'bh-fu-numberError': 'The number of files exceeded the limit',
        'bh-fu-typeError': 'The file type is incorrect',
        'bh-fu-sizeError': 'The file size is out of bounds',
        'bh-fu-chooseAttachment': 'Please upload attachments',
        'bh-fu-maxSize': 'Maximum file size is ',
        'bh-fu-typeLimit': 'type is ',
        'bh-fu-delete': 'Delete',
        'bh-fu-download': 'Download',
        'bh-fu-uploadSuccess': 'Upload successfully',

        /**
         * emapImageUpload
         */
        'bh-iu-warning': 'Warning',
        'bh-iu-warningContent': 'There is a file being uploaded. The operation may cause file loss. Do you want to continue?',
        'bh-iu-conFirmUpload': 'Confirm and Submit',
        'bh-iu-cancelUpload': 'Cancel',
        'bh-iu-saveFail': 'save Fail',
        'bh-iu-clickSubmit': 'Click Upload',
        'bh-iu-uploadImg': 'Please upload Image',
        'bh-iu-support': 'support ',
        'bh-iu-type': ' type',
        'bh-iu-sizeLimit': 'size within',
        'bh-iu-limit': ' limit',
        'bh-iu-quantityLimit': 'quantity within',
        'bh-iu-uploading': 'Uploading...',
        'bh-iu-delete': 'Delete',
        'bh-iu-quantityError': 'The number of files exceeded the limit',
        'bh-iu-typeError': 'The file type is incorrect',
        'bh-iu-sizeError': 'The file size is out of the limit',
        'bh-iu-uploadFail': 'upload fail',

        /**
         * emapImport
         */
        'bh-ei-uploadFile': 'Upload File',
        'bh-ei-suggest': ' If it is the first time, we suggest you to ',
        'bh-ei-downloadImportTmp': 'download the import template',
        'bh-ei-reference': ' for reference.',
        'bh-ei-startUpload': 'Start Upload',
        'bh-ei-reupload': 'Reupload',
        'bh-ei-confirmUpload': 'Confirm Upload',
        'bh-ei-importDatas': 'Import Datas',
        'bh-ei-waitingImport': 'Waiting for the data to be imported automatically after the file is uploaded',
        'bh-ei-complete': 'complete',
        'bh-ei-resultDetail': 'The file all imports data 10000, of which 2 failed',
        'bh-ei-specificResult': 'You can ',
        'bh-ei-downloadResult': 'download the import results ',
        'bh-ei-checkResult': 'to check details.',
        'bh-ei-confirmCloase': 'Confirm Cloase',
        'bh-ei-correctExcel': 'Please upload the correct Excel file',
        'bh-ei-uploading': 'uploading...',
        'bh-ei-this': 'This time, ',
        'bh-ei-imported': ' data was imported',
        'bh-ei-importeFail': 'data was imported',
        'bh-ei-importeComplete': 'Data import complete',
        'bh-ei-importSuccessTip': 'The import completed,',
        'bh-ei-importFailTip': ' data successed,',
        'bh-ei-importTiao': ' data failed',

        /**
         * emapSingleImageUpload
         */
        'bh-siu-warning': 'Warning',
        'bh-siu-warningContent': 'There is a file being uploaded. The operation may cause file loss. Do you want to continue?',
        'bh-siu-conFirmUpload': 'Confirm and Submit',
        'bh-siu-cancelUpload': 'Cancel',
        'bh-siu-saveFail': 'save Fail',
        'bh-siu-clickSubmit': 'Click Upload',
        'bh-siu-uploading': 'Uploading...',
        'bh-siu-reupload': 'Repload',
        'bh-siu-delete': 'Delete',
        'bh-siu-support': 'support ',
        'bh-siu-type': ' type',
        'bh-siu-sizeLimit': 'size within',
        'bh-siu-limit': ' limit',
        'bh-siu-typeError': 'The file type is incorrect',
        'bh-siu-sizeError': 'The file size is out of the limit',
        'bh-siu-uploadFail': 'upload fail',

        /**
         * emapUploadCore
         */
        'bh-uc-requestFail': 'Request Fail',
        'bh-uc-saveFail': 'Save Fail',

        /**
         * emapInput
         */
        'bh-eip-pleaseChoose': 'please choose...',
        'bh-eip-yes': 'YES',
        'bh-eip-no': 'NO',
        'bh-eip-empty': '[empty]',
        'bh-eip-pleaseSeach': 'Please Seach',
        'bh-eip-clear': 'clear',
        'bh-eip-today': 'today',

        /**
         * emapRules_validate
         */
        'bh-rv-noEmpty': '* is required',
        'bh-rv-inf': 'Invalid numeric format',
        'bh-rv-least': 'Least ',
        'bh-rv-character': ' characters',
        'bh-rv-most': 'Most ',
        'bh-rv-minimum': '* Minimum value is ',
        'bh-rv-maximum': '* Maximum value is ',
        'bh-rv-mostChoose': '* choose ',
        'bh-rv-items': ' items at most',
        'bh-rv-leastChoose': '* items at least',
        'bh-rv-passwordInconsistent': '* The password entered for the two time is inconsistent',
        'bh-rv-ifn': 'Invalid mobile phone number',
        'bh-rv-imfn': 'Invalid mobile phone number',
        'bh-rv-iea': 'Invalid email address',
        'bh-rv-oia': 'Only integers allowed',
        'bh-rv-onnia': 'Only none negative integers allowed',
        'bh-rv-oigtza': 'Only integers greater than zero allowed',
        'bh-rv-ia': 'Invalid amount',
        'bh-rv-is': 'Invalid score',
        'bh-rv-ona': 'Only numbers allowed',
        'bh-rv-idfmb': 'Invalid date. Format must be YYYY-MM-DD',
        'bh-rv-iia': 'Invalid IP address',
        'bh-rv-iweb': 'Invalid Website',
        'bh-rv-oela': 'Only english letters allowed',
        'bh-rv-onaela': 'Only numbers and english letters allowed',
        'bh-rv-idf': 'Invalid date format',
        'bh-rv-idotf': 'Invalid date or time format',
        'bh-rv-af': 'Acceptable format: ',
        'bh-rv-occa': 'Only Chinese characters allowed',
        'bh-rv-iin': 'Invalid ID number',
        'bh-rv-ipc': 'Invalid Postcode',
        'bh-rv-iqq': 'Invalid QQ number',
        'bh-rv-citl': 'Content is too long, over ',
        'bh-rv-or': ' or ',
        'bh-rv-noLaterThan': '*1 no later than *2',
        'bh-rv-noEarlierThan': '*1 no earlier than *2',

        /**
         * emapValidate
         */
        'bh-ev-noEmpty': " is required",
        'bh-ev-inf': "Invalid numeric format",
        'bh-ev-cnel': "Character number exceeded limit",
        'bh-ev-invalidNumber': "Invalid numeric format",
        'bh-ev-incorrectAmount': "Incorrect amount type",
        'bh-ev-incorrect': " is incorrect",
        'bh-ev-dateIncorrect': "Date format is incorrect",
        'bh-ev-mustLess': " must less than",
        'bh-ev-characters': " characters",
        'bh-ev-ChooseAtMost': "Choose at most ",
        'bh-ev-items': " items",
        'bh-ev-today': " today",

        /**
         * emapAdvancedQuery
         */
        'bh-eaq-schema': 'Advanced search scheme',
        'bh-eaq-topSchema': 'The top scheme (will appear directly in the search bar)',
        'bh-eaq-otherSchema': 'Other schemas',
        'bh-eaq-delete': 'delete',
        'bh-eaq-cancelTop': 'Cancel Top',
        'bh-eaq-top': 'Top',
        'bh-eaq-programmeSuccess': ' Programme implementation success',
        'bh-eaq-pleaseEnter': 'Please enter',
        'bh-eaq-search': 'Search',
        'bh-eaq-commonScheme': 'Common Scheme',
        'bh-eaq-more': 'More',
        'bh-eaq-advancedSearch': 'Advanced Search',
        'bh-eaq-keyWord': 'KeyWord',
        'bh-eaq-save': 'Save',
        'bh-eaq-cancel': 'Cancel',
        'bh-eaq-fixedToSearchBar': 'Fixed to Search Bar',
        'bh-eaq-saveAsScheme': 'Save as Scheme',
        'bh-eaq-closeAdvancedSearch': '[Close Advanced Search]',
        'bh-eaq-doAdvancedSearch': 'Do Advanced Search',
        'bh-eaq-addTheSearchField': 'Add the Search Field',
        'bh-eaq-clearSearch': 'Clear search',
        'bh-eaq-recorders': 'recorders',
        'bh-eaq-success': 'Success',
        'bh-eaq-enterSchemaName': 'Please enter scheme name',
        'bh-eaq-selectAll': 'Select All',
        'bh-eaq-addComplete': 'add complete',
        'bh-eaq-total': 'Total',
        'bh-eaq-data': 'data',

        /**
         * emapDataTable1.0
         */
        'bh-edt-exportField': 'Selecte keys to Export',
        'bh-edt-hideShow': 'Show / Hide keys',
        'bh-edt-exportFail': 'Export data request failed',
        'bh-edt-error': 'Error',
        'bh-edt-systemError': 'System exception, please contact the administrator',
        'bh-edt-selectAll': 'Select all',
        'bh-edt-availableField': 'Available field',
        'bh-edt-confirm': 'Confirm',
        'bh-edt-cancel': 'Cancel',

        /**
         * emapDropDownTree1.0
         */
        'bh-eddt-loading': 'Loading...',
        'bh-eddt-pleaseChoose': 'Please Choose...',
        'bh-eddt-empty': '[empty]',
        'bh-eddt-selectAll': 'Select all',
        'bh-eddt-search': 'Search...',

        /**
         * cacheUpload
         */
        'bh-cu-sorting': 'Sorting is not available. Please complete the sort or cancel the sort',
        'bh-cu-uploading': 'There is a file being uploaded. The operation may cause file loss. Do you want to continue?',
        'bh-cu-exceedNumber': 'The number of files exceeded the limit',
        'bh-cu-typeError': 'The file type is incorrect',
        'bh-cu-exceedSize': 'The file size is out of bounds',
        'bh-cu-none': 'No attachment',

        /**
         * cacheUploadAdaptor
         */
        'bh-cua-deleteTemFail': 'Failed to delete temporary file',
        'bh-cua-deleteFail': 'Deletion of official file failed',
        'bh-cua-tokenFail': 'Failed to request token data',
        'bh-cua-saveFail': 'Save failed',
        'bh-cua-rowFail': 'Failed to obtain import data rows',
        'bh-cua-downloadUrlFail': 'Failed to get the download address',
        'bh-cua-progreeeFail': 'Failed to get import progress',

        /**
         * cacheUploadCore
         */
        'bh-cuc-uploadFail': 'Failed to upload temporary file',

        /**
         * uploadView
         */
        'bh-uv-preview': 'Preview',
        'bh-uv-delete': 'Delete',
        'bh-uv-uploadFail': 'Upload Fail',
        'bh-uv-uploadSuccess': 'Upload Success',
        'bh-uv-cancelUpload': 'Cancel Upload',
        'bh-uv-reupload': 'Reupload',
        'bh-uv-retry': 'Retry',
        'bh-uv-canceled': 'Canceled',
        'bh-uv-onlySupport': 'Only support ',
        'bh-uv-typeFile': ' types file',
        'bh-uv-fileSize': 'Size within ',
        'bh-uv-within': '.',
        'bh-uv-deleteFileFail': 'Fail to delete file',
        'bh-uv-confirm': 'Confirm',
        'bh-uv-uploading': 'The file is uploading. Do you  confirm to cancel it?',
        'bh-uv-noSort': 'Can not sort because only one file',
        'bh-uv-toDeal': 'Deal',
        'bh-uv-has': '.',
        'bh-uv-uploadsort': 'files are uploading or uploading errors. They cannot be sorted!',
        'bh-uv-noFileSort': 'Unable to sort without file',
        'bh-uv-prompt': 'Prompt',

        'bh-atom-uploadFail': 'File upload failed'
    };
})(window.WIS_I18N = window.WIS_I18N || {});

/***
 * 中文 i18n
 */
(function(WIS_I18N, undefined) {
    WIS_I18N.zh = {
        /**
         * 高级搜索 V1.2
         */
        'bh_aq_search': '搜索',
        'bh_aq_enter': '请输入',
        'bh_aq_topScheme': '置顶方案（将直接出现在搜索栏上）',
        'bh_aq_otherScheme': '其他方案',
        'bh_aq_advancedSearchSheme': '高级搜索方案',
        'bh_aq_delete': '删除',
        'bh_aq_cancelTheTop': '取消置顶',
        'bh_aq_top': '置顶',
        'bh_aq_advancedSearch': '高级搜索',
        'bh_aq_commonScheme': '常用方案',
        'bh_aq_more': '更多',
        'bh_aq_keyWord': '关键词',
        'bh_aq_save': '保存',
        'bh_aq_cancel': '取消',
        'bh_aq_fixedToSearchBar': '固定至搜索栏',
        'bh_aq_saveAsScheme': '保存为方案',
        'bh_aq_closeAdvancedSearch': '[关闭高级搜索]',
        'bh_aq_doAdvancedSearch': '执行高级搜索',
        'bh_aq_addTheSearchField': '添加搜索字段',
        'bh_aq_clearSearch': '清空搜索',
        'bh_aq_recorders': '条数据',
        'bh_aq_success': '添加成功',

        /**
         * 条件搜索 V1.2
         */
        'bh_fq_conditionFilter': '条件筛选',
        'bh_fq_expend': '展开',
        'bh_fq_clearCondition': '清空条件',
        'bh_fq_moreCondition': '更多条件',
        'bh_fq_collapse': '收起',
        'bh_fq_search': '搜索',

        /**
         * 上传组件 V1.2
         */
        'bh_up_batchUpload': '批量上传',
        'bh_up_uploadFile': '上传文件',
        'bh_up_sortFile': '文件排序',
        'bh_up_cancel': '取消',
        'bh_up_completeSorting': '完成排序',
        'bh_up_dragToSort': '拖动以排序',
        'bh_up_annotation': '说明',
        'bh_up_uploadAgain': '重新上传',
        'bh_up_cancelTheUpload': '取消上传',

        /**
         * 批量编辑 V1.2
         */
        'bh_be_unchooseTip': '未选择数据，请选择数据后再编辑',
        'bh-be-choosed': '已选',
        'bh-be-piecesOfDatas': '条数据',
        'bh-be-keysList': '字段列表',
        'bh-be-search': '搜索',
        'bh-be-bulkEdit': '批量编辑',
        'bh-be-sureEdit': '确定编辑',
        'bh-be-willBulkEdit': '将批量修改字段,你确定吗？',
        'bh-be-back': '退出',
        'bh-be-piecesOfKeys': '个字段',

        /**
         * 下拉树 V1.2
         */
        'bh-ddt-allChoose': '未选择数据，请选择数据后再编辑',
        'bh-ddt-search': '搜索',
        'bh-ddt-pleaseChoose': '请选择',
        'bh-ddt-empty': '空',

        /**
         * 条件构造器 V1.2
         */
        'bh-cc-search': '搜索',
        'bh-cc-condcons': '条件构造器',
        'bh-cc-and': '且',
        'bh-cc-or': '或',
        'bh-cc-append': '插入',
        'bh-cc-save': '保存',
        'bh_cc_delete': '删除',
        'bh-cc-clear': '清空',
        'bh-cc-back': '退出',
        'bh-cc-takeConditionSearch': '执行条件搜索',
        'bh-cc-saveAsScheme': '保存为方案',
        'bh-cc-pleaseInput': '请输入',
        'bh-cc-pleaseFind': '请查找',
        'bh-cc-backTip': '退出后会清空当前搜索结果,确定吗？',
        'bh-cc-willClearConditions': '将清空已输入的条件,确定吗？',
        'bh-cc-checkError': '我们检测到你输入的条件存在语法错误，可能出现的错误如下，请仔细检查一下',
        'bh-cc-checkBrackets': '括号"()"没有匹配成对',
        'bh-cc-conditionsWithoutAndOr': '条件之间没有加"且"或"或"',
        'bh-cc-andOrWithoutConditions': '"且"或"或"之间没有插入条件',
        'bh-cc-error': '出错啦!',
        'bh-cc-ok': '好的',

        /**
         * emap数据表格 V1.2
         */
        'bh-dd-exportChoosedKeys': '导出选择字段',
        'bh-dd-showOrHideKeys': '显示/隐藏字段',
        'bh-dd-exportRequestFailed': '导出数据请求失败',
        'bh-dd-error': '错误',
        'bh-dd-contactAdmin': '系统异常，请联系管理员',
        'bh-dd-choose': '选择',

        /**
         * emap表单 V1.2
         */
        'bh-fi-checkRuleExit': '校验规则已存在！',
        'bh-fi-notRight': '不正确',
        'bh-fi-lengthExit': '长度超出限制',
        'bh-fi-lengthNotPass': '长度不能超过',
        'bh-fi-letters': '个字',
        'bh-fi-now': '当前',
        'bh-fi-wrongInUploadFiles': '上传文件有误',

        /**
         * emap导入 V1.2
         */
        'bh-ip-failToGetDownloadAddress': '获取下载地址失败',
        'bh-ip-importDatas': '导入数据',
        'bh-ip-uploadRightExcel': '请上传正确的Excel文件',
        'bh-ip-uploading': '上传中',
        'bh-ip-importFailed': '导入失败',
        'bh-ip-numOfImportDatas': '本次共导入数据',
        'bh-ip-piece': '条',
        'bh-ip-successInImport': '数据导入完成',
        'bh-ip-importFinished': '导入已完成',
        'bh-ip-numOfSuccess': '其中导入成功',
        'bh-ip-numOfFail': '导入失败',
        'bh-ip-uploadFile': '上传文件',
        'bh-ip-firstTimeTips': '如果您是初次使用，建议您',
        'bh-ip-downloadModules': '下载导入模板',
        'bh-ip-viewing': '进行查看。',
        'bh-ip-startUploading': '开始上传',
        'bh-ip-reupload': '重新上传',
        'bh-ip-sureUpload': '确认上传',
        'bh-ip-waitUploadedAutoImporting': '等待文件上传完毕后自动导入数据',
        'bh-ip-finish': '完成',
        'bh-ip-importDetails': '该文件全部导入数据10000条，其中失败导入2条',
        'bh-ip-viewDetails': '具体结果可查看',
        'bh-ip-downloadResult': '下载导入结果',
        'bh-ip-sureClose': '确定关闭',

        /**
         * emap导入2 V1.2
         */
        'bh-ip2-importDatas': '导入数据',
        'bh-ip2-sureBack': '确定退出？退出后将导致上传文件失败',
        'bh-ip2-notleave': '数据很快就将导入完，请勿离开',
        'bh-ip2-uploading': '正在为您上传文件，',
        'bh-ip2-bePatient': '正在为您上传文件，请耐心等待',
        'bh-ip2-uploadExcel': '请上传正确的Excel文件',
        'bh-ip2-badNetwork': '网络故障，导入文件失败，请检查网络后重试',
        'bh-ip2-bigFile': '文件过大，不得超过10M',
        'bh-ip2-virusFile': '文件为病毒文件，请重新选择文件上传',
        'bh-ip2-emptyFile': '上传的文件中没有数据内容，请重新选择文件上传',
        'bh-ip2-typeFile': '文件不是Excel格式文件，请重新上传正确格式的文件',
        'bh-ip2-importing': '正在为您导入',
        'bh-ip2-freshNetwork': '网络故障，请重新连接网络并刷新后查看导入结果',
        'bh-ip2-databaseError': '数据库异常，导入失败。请稍后重试或者联系实施人员解决',
        'bh-ip2-30second': '预计耗时30秒',
        'bh-ip2-1minute': '预计耗时1分钟',
        'bh-ip2-2minute': '预计耗时2分钟',
        'bh-ip2-4minute': '预计耗时4分钟',
        'bh-ip2-6minute': '预计耗时6分钟',
        'bh-ip2-longMinute': '文件过大，请耐心等待',
        'bh-ip2-uploadFile': '上传文件',
        'bh-ip2-checkDatas': '数据校验',
        'bh-ip2-firstTime': '如果您是初次使用，您可以',
        'bh-ip2-chooseFiles': '选择文件',
        'bh-ip2-downloadImportModel': '下载导入模板',
        'bh-ip2-uploadAfterInput': '填写后上传',
        'bh-ip2-server': '服务器',
        'bh-ip2-uploadingFilesNow': '正在为您上传文件',
        'bh-ip2-takeTime': '当前耗时',
        'bh-ip2-sureClose': '确定并关闭',
        'bh-ip2-rechoose': '重新选择',
        'bh-ip2-checkDatasAndWait': '正在为您校验数据，过程将很快，请耐心等待',
        'bh-ip2-checkedResult': '经校验，您的数据确认无误，共计',
        'bh-ip2-piece': '条',
        'bh-ip2-rightDatas': '经校验，正确数据为',
        'bh-ip2-wrongDatas': '条，错误数据为',
        'bh-ip2-downloadWrongFiles': '下载错误数据文件',
        'bh-ip2-onlyImportRightDatas': '只导入正确数据',
        'bh-ip2-successImport': '成功导入',


        /**
         * emapQuery V1.2
         */
        'bh-q-setConditions': '设置条件',
        'bh-q-searchPlan': '搜索方案',
        'bh-q-viewMoreConditions': '查看更多条件',
        'bh-q-gather': '收起',
        'bh-q-clear': '清空',
        'bh-q-saveAsSearchPlan': '保存为搜索方案',
        'bh-q-nowSearchCondition': '当前搜索条件',
        'bh-q-noPlan': '暂无方案',
        'bh-q-newPlan': '新建方案',
        'bh-q-inputPlanName': '请输入方案名称',
        'bh-q-save': '保存',
        'bh-q-cancel': '取消',
        'bh-q-search': '搜索',
        'bh-q-sure': '确定',
        'bh-q-all': '全部',
        'bh-q-is': '是',
        'bh-q-delete': '删除',
        'bh-q-cancelSetTop': '取消置顶',
        'bh-q-setTop': '置顶',
        'bh-q-addSearchKeys': '添加搜索字段',


        /**
         * emapService
         */
        'bh-sv-noDatas': '没有数据',


        /**
         * emapSchema
         */
        'bh-sm-inputSchemaName': '请输入方案名',
        'bh-sm-schemaNameIsNull': '方案名为空',
        'bh-sm-successSave': '保存成功',
        'bh-sm-failSave': '保存失败',
        'bh-sm-successDelete': '删除成功',


        /**
         * emapRulesConstructor
         */
        'bh-rc-addAndConditions': '+ 新增[且]条件',
        'bh-rc-addOrConditions': "+ 新增[或]条件",
        'bh-rc-edit': '编辑',
        'bh-rc-setConditionSchema': '条件构造方案',
        'bh-rc-setSchemaTop': '置顶方案(将直接出现在搜索栏上)',
        'bh-rc-otherSchema': '其他方案',
        'bh-rc-delete': '删除',
        'bh-rc-cancelTop': '取消置顶',
        'bh-rc-setTop': '置顶',
        'bh-rc-makeSchema': '构造方案',
        'bh-rc-more': '更多',
        'bh-rc-pleaseInput': '请输入',
        'bh-rc-search': '搜索',
        'bh-rc-chooseFindingTasks': "选择查询项目...",
        'bh-rc-pleaseFind': "请查找",
        'bh-rc-chooseConditions': "选择条件...",
        'bh-rc-onlyHave': '[空值]仅支持[等于] [不等于] [包含]',
        'bh-rc-dropdownTreeTip': '下拉树最多选择1000项',
        'bh-rc-or': '或',
        'bh-rc-multiValueSpilt': '多值请用逗号隔开',
        'bh-rc-and': '且',
        'bh-rc-conditionDesigner': '条件构造器',
        'bh-rc-takeConditionsSearch': '执行条件搜索',
        'bh-rc-inputPlanName': '请输入方案名称',
        'bh-rc-save': '保存',
        'bh-rc-cancel': '取消',
        'bh-rc-fixToSearchInput': '固定至搜索栏',
        'bh-rc-saveAsPlan': '保存为方案',
        'bh-rc-closeConditionDesigner': '关闭条件构造器',


        /**
         * emapLinkage
         */
        'bh-la-pleaseChoose': '请选择...',

        /**
         * emapGrid
         */
        'bh-gd-customColumns': '自定义列',
        'bh-gd-table': '列表',
        'bh-gd-card': '卡片',

        /**
         * emapEditor
         */
        'bh-et-uploadRightType': '请上传正确的图片类型',


        /**
         * emapEditableDataTable
         */
        'bh-edt-originDatas': '原有数据',
        'bh-edt-newRow': '新增行',


        /**
         * emapCard
         */
        'bh-cd-noDatas': '暂无数据',



        /**
         * emapAvatarUpload
         */
        'bh-au-adjustHeadImage': '修改头像',
        'bh-au-uploadFromLocal': '本地上传',
        'bh-au-RecommondHeadImage': '推荐头像',
        'bh-au-wrongType': '文件类型不正确',
        'bh-au-passTheMax': '文件大小超出限制',
        'bh-au-imageUploadFail': '图片上传失败',
        'bh-au-chooseImages': '选择图片',
        'bh-au-reupload': '重新上传',
        'bh-au-uploadHeadImage': '头像上传',
        'bh-au-onlyHave': '仅支持',
        'bh-be-sizeNotPass': '大小不超过',
        'bh-au-avatarFail': '裁剪失败',
        'bh-au-requestFail': '请求失败',



        /**
         * emapForm
         */
        'bh-fm-saveUploadFilesFail': '上传文件保存失败',
        'bh-fm-gather': '收起',
        'bh-fm-expand': '展开',

        /**
         * emapFileDownload
         */
        'bh-fd-download': '下载',
        'bh-fd-batchDownload': '批量下载',
        'bh-fd-none': ' 无',

        /**
         * emapFilePhoto
         */
        'bh-fp-uploadSuccess': '上传成功',
        'bh-fp-upload': '上传',
        'bh-fp-typeError': '文件类型错误',
        'bh-fp-sizeOverflow': '文件大小超出限制',
        'bh-fp-uploadFail': '上传失败',

        /**
         * emapFileUpload
         */
        'bh-fu-warning': '警告',
        'bh-fu-warningContent': '有文件正在上传中, 操作可能会造成文件丢失, 是否继续?',
        'bh-fu-conFirmUpload': '确认并提交',
        'bh-fu-cancelUpload': '取消',
        'bh-fu-upload': '上传',
        'bh-fu-saveFail': '保存失败',
        'bh-fu-numberError': '文件数量超出限制',
        'bh-fu-typeError': '文件类型不正确',
        'bh-fu-sizeError': '文件大小超出限制',
        'bh-fu-chooseAttachment': '请上传附件',
        'bh-fu-maxSize': '文件最大为',
        'bh-fu-typeLimit': '格式限制为',
        'bh-fu-delete': '删除',
        'bh-fu-download': '下载',
        'bh-fu-uploadSuccess': '上传成功',

        /**
         * emapImageUpload
         */
        'bh-iu-warning': '警告',
        'bh-iu-warningContent': '有文件正在上传中, 操作可能会造成文件丢失, 是否继续?',
        'bh-iu-conFirmUpload': '确认并提交',
        'bh-iu-cancelUpload': '取消',
        'bh-iu-saveFail': '保存失败',
        'bh-iu-clickSubmit': '点击上传',
        'bh-iu-uploadImg': '请上传图片',
        'bh-iu-support': '支持',
        'bh-iu-type': '类型',
        'bh-iu-sizeLimit': '大小在',
        'bh-iu-limit': '以内',
        'bh-iu-quantityLimit': '数量在',
        'bh-iu-uploading': '上传中...',
        'bh-iu-delete': '删除',
        'bh-iu-quantityError': '文件数量超出限制',
        'bh-iu-typeError': '文件类型不正确',
        'bh-iu-sizeError': '文件大小超出限制',
        'bh-iu-uploadFail': '上传失败',

        /**
         * emapImport
         */
        'bh-ei-uploadFile': '文件上传',
        'bh-ei-suggest': '如果您是初次使用，建议您',
        'bh-ei-downloadImportTmp': '下载导入模板',
        'bh-ei-reference': '进行查看。',
        'bh-ei-startUpload': '开始上传',
        'bh-ei-reupload': '重新上传',
        'bh-ei-confirmUpload': '确认上传',
        'bh-ei-importDatas': '导入数据',
        'bh-ei-waitingImport': '等待文件上传完毕后自动导入数据',
        'bh-ei-complete': '完成',
        'bh-ei-resultDetail': '该文件全部导入数据10000条，其中失败导入2条',
        'bh-ei-specificResult': '具体结果可查看',
        'bh-ei-downloadResult': '下载导入结果',
        'bh-ei-checkResult': '查看明细。',
        'bh-ei-confirmCloase': '确定关闭',
        'bh-ei-correctExcel': '请上传正确的Excel文件',
        'bh-ei-uploading': '上传中...',
        'bh-ei-this': '本次共导入数据',
        'bh-ei-imported': '条',
        'bh-ei-importeFail': '导入失败',
        'bh-ei-importeComplete': '数据导入完成',
        'bh-ei-importSuccessTip': '导入已完成， 其中导入成功',
        'bh-ei-importFailTip': '条，导入失败',
        'bh-ei-importTiao': '条',

        /**
         * emapSingleImageUpload
         */
        'bh-siu-warning': '警告',
        'bh-siu-warningContent': '有文件正在上传中, 操作可能会造成文件丢失, 是否继续?',
        'bh-siu-conFirmUpload': '确认并提交',
        'bh-siu-cancelUpload': '取消',
        'bh-siu-saveFail': 'save Fail',
        'bh-siu-clickSubmit': '点击上传',
        'bh-siu-uploading': '上传中...',
        'bh-siu-reupload': '重新上传',
        'bh-siu-delete': '删除',
        'bh-siu-uploadImg': '请上传图片',
        'bh-siu-support': '支持',
        'bh-siu-type': '类型',
        'bh-siu-sizeLimit': '大小在',
        'bh-siu-limit': '以内',
        'bh-siu-typeError': '文件类型不正确',
        'bh-siu-sizeError': '文件大小超出限制',
        'bh-siu-uploadFail': '上传失败',

        /**
         * emapUploadCore
         */
        'bh-uc-requestFail': '请求失败',
        'bh-uc-saveFail': '保存失败',

        /**
         * emapInput
         */
        'bh-eip-pleaseChoose': '请选择...',
        'bh-eip-yes': '是',
        'bh-eip-no': '否',
        'bh-eip-empty': '[空]',
        'bh-eip-pleaseSeach': '请查找',
        'bh-eip-clear': '清除',
        'bh-eip-today': '今天',

        /**
         * emapRules_validate
         */
        'bh-rv-noEmpty': '* 不能为空',
        'bh-rv-inf': '无效的数字格式',
        'bh-rv-no': '最少 ',
        'bh-rv-character': ' 个字符',
        'bh-rv-most': '最多 ',
        'bh-rv-minimum': '* 最小值为 ',
        'bh-rv-maximum': '* 最大值为 ',
        'bh-rv-mostChoose': '* 最多选择 ',
        'bh-rv-items': ' 个项目',
        'bh-rv-leastChoose': '* 最少选择 ',
        'bh-rv-passwordInconsistent': '* 两次输入的密码不一致',
        'bh-rv-ifn': '无效的电话号码',
        'bh-rv-imfn': '无效的手机号码',
        'bh-rv-iea': '无效的邮件地址',
        'bh-rv-oia': '只能填写整数',
        'bh-rv-onnia': '只能填写非负整数',
        'bh-rv-oigtza': '只能填大于零的整数',
        'bh-rv-ia': '无效的金额',
        'bh-rv-is': '无效的分数',
        'bh-rv-ona': '只能填写数字',
        'bh-rv-idfmb': '无效的日期，格式必需为 YYYY-MM-DD',
        'bh-rv-iia': '无效的 IP 地址',
        'bh-rv-iweb': '无效的网址',
        'bh-rv-oela': '只能填写英文字母',
        'bh-rv-onaela': '只能填写数字与英文字母',
        'bh-rv-idf': '无效的日期格式',
        'bh-rv-idotf': '无效的日期或时间格式',
        'bh-rv-af': '可接受的格式：',
        'bh-rv-occa': '只能填写中文汉字',
        'bh-rv-iin': '无效的身份证号码',
        'bh-rv-ipc': '无效的邮政编码',
        'bh-rv-iqq': '无效的 QQ 号码',
        'bh-rv-citl': '内容过长，超过 ',
        'bh-rv-or': ' 或 ',
        'bh-rv-noLaterThan': '*1不能晚于*2',
        'bh-rv-noEarlierThan': '*1不能早于*2',

        /**
         * emapValidate
         */
        'bh-ev-noEmpty': "不能为空",
        'bh-ev-inf': "无效的数字格式",
        'bh-ev-cnel': "长度超出限制",
        'bh-ev-invalidNumber': "无效的数字格式",
        'bh-ev-incorrectAmount': "金额类型不正确",
        'bh-ev-incorrect': "不正确",
        'bh-ev-dateIncorrect': "日期格式不正确",
        'bh-ev-mustLess': "必须小于",
        'bh-ev-characters': "个字",
        'bh-ev-items': "项",
        'bh-ev-today': " 今天",

        /**
         * emapAdvancedQuery1.0
         */
        'bh-eaq-schema': '高级搜索方案',
        'bh-eaq-topSchema': '置顶方案(将直接出现在搜索栏上)',
        'bh-eaq-otherSchema': '其他方案',
        'bh-eaq-delete': '删除',
        'bh-eaq-cancelTop': '取消置顶',
        'bh-eaq-top': '置顶',
        'bh-eaq-programmeSuccess': ' 方案执行成功',
        'bh-eaq-pleaseEnter': '请输入',
        'bh-eaq-search': '搜索',
        'bh-eaq-commonScheme': '常用方案',
        'bh-eaq-more': '更多',
        'bh-eaq-advancedSearch': '高级搜索',
        'bh-eaq-keyWord': '关键词',
        'bh-eaq-save': '保存',
        'bh-eaq-cancel': '取消',
        'bh-eaq-fixedToSearchBar': '固定至搜索栏',
        'bh-eaq-saveAsScheme': '保存为方案',
        'bh-eaq-closeAdvancedSearch': '[关闭高级搜索]',
        'bh-eaq-doAdvancedSearch': '执行高级搜索',
        'bh-eaq-addTheSearchField': '添加搜索字段',
        'bh-eaq-clearSearch': '清空搜索',
        'bh-eaq-recorders': '条数据',
        'bh-eaq-success': '添加成功',
        'bh-eaq-enterSchemaName': '请输入方案名称',
        'bh-eaq-selectAll': '全选',
        'bh-eaq-addComplete': '添加完成',
        'bh-eaq-total': '共',
        'bh-eaq-data': '条数据',

        /**
         * emapDataTable1.0
         */
        'bh-edt-exportField': '导出选择字段',
        'bh-edt-hideShow': '显示/隐藏字段',
        'bh-edt-exportFail': '导出数据请求失败',
        'bh-edt-error': '错误',
        'bh-edt-systemError': '系统异常，请联系管理员',
        'bh-edt-selectAll': '全选',
        'bh-edt-availableField': '可用字段',
        'bh-edt-confirm': '确认',
        'bh-edt-cancel': '取消',

        /**
         * emapDropDownTree1.0
         */
        'bh-eddt-loading': '加载中...',
        'bh-eddt-pleaseChoose': '请选择...',
        'bh-eddt-empty': '[空]',
        'bh-eddt-selectAll': '全选',
        'bh-eddt-search': '搜索...',

        /**
         * cacheUpload
         */
        'bh-cu-sorting': '正在排序中，无法保存，请完成排序或者取消排序',
        'bh-cu-uploading': '有文件正在上传中, 操作可能会造成文件丢失, 是否继续?',
        'bh-cu-exceedNumber': '文件数量超出限制',
        'bh-cu-typeError': '文件类型不正确',
        'bh-cu-exceedSize': '文件大小超出限制',
        'bh-cu-none': '无附件',

        /**
         * cacheUploadAdaptor
         */
        'bh-cua-deleteTemFail': '删除临时文件失败',
        'bh-cua-deleteFail': '删除正式文件失败',
        'bh-cua-tokenFail': '请求token数据失败',
        'bh-cua-saveFail': '保存失败',
        'bh-cua-rowFail': '获取导入数据行数失败',
        'bh-cua-downloadUrlFail': '获取下载地址失败',
        'bh-cua-progreeeFail': '获取导入进度失败',

        /**
         * cacheUploadCore
         */
        'bh-cuc-uploadFail': '上传临时文件失败',

        /**
         * uploadView
         */
        'bh-uv-preview': '预览',
        'bh-uv-delete': '删除',
        'bh-uv-uploadFail': '上传失败',
        'bh-uv-uploadSuccess': '上传成功',
        'bh-uv-cancelUpload': '取消上传',
        'bh-uv-reupload': '重新上传',
        'bh-uv-retry': '重试',
        'bh-uv-canceled': '已取消',
        'bh-uv-onlySupport': '仅支持',
        'bh-uv-typeFile': '类型文件',
        'bh-uv-fileSize': '文件大小',
        'bh-uv-within': '以内',
        'bh-uv-deleteFileFail': '文件删除失败',
        'bh-uv-confirm': '确定',
        'bh-uv-uploading': '文件正在上传, 确认取消吗?',
        'bh-uv-noSort': '只有一个文件，无法排序',
        'bh-uv-toDeal': '去处理',
        'bh-uv-has': '有',
        'bh-uv-uploadsort': '个文件正在上传或上传出错，无法排序！',
        'bh-uv-noFileSort': '没有文件，无法排序',
        'bh-uv-prompt': '提示',

        'bh-atom-uploadFail': '文件上传失败'
    };
})(window.WIS_I18N = window.WIS_I18N || {});

(function(WIS_I18N) {
    'use strict';

    var lang = 'zh';
    if (window.WIS_EMAP_CONFIG && WIS_EMAP_CONFIG.useI18n) {
        lang = getCookie('EMAP_LANG');
    }

    if (!$.i18n) {
        $.i18n = function(key) {
            var res = WIS_I18N[lang];
            if (res) {
                return res[key] || key;
            }
        };
        WIS_I18N.i18n = {};
        WIS_I18N.i18n.locale = lang;
        return console && console.warn && console.warn('缺少i18n依赖');
    }
    WIS_I18N.i18n = $.i18n();
    var useI18n = !!(window.APP_CONFIG && window.APP_CONFIG.USE_LANG) || false;
    if (useI18n) {
        lang = getCookie('EMAP_LANG');
    }

    for (var k in WIS_I18N) {
        if (k === 'i18n') continue;
        WIS_I18N.i18n.load(WIS_I18N[k], k);
    }

    WIS_I18N.i18n.locale = lang;

    function getCookie(c_name) {
        var c_start, c_end;　　　
        if (document.cookie.length > 0) {　　　　　　　　
            c_start = document.cookie.indexOf(c_name + "=");　　　　　　　　
            if (c_start != -1) {　　　　　　　　
                c_start = c_start + c_name.length + 1;　　　　　　　　　　
                c_end = document.cookie.indexOf(";", c_start);　　　　　　　　　　
                if (c_end == -1) c_end = document.cookie.length;　　　　　　　　　　
                return decodeURI(document.cookie.substring(c_start, c_end));　　　　　　　　
            }　　　　
        }　　　　
        return "";　　
    }　　
})(window.WIS_I18N = window.WIS_I18N || {});

/***
 * Sortable
 * @author  RubaXa   <trash@rubaxa.org>
 * @license MIT
 */
(function() {
    "use strict";

    if (typeof window == "undefined" || !window.document) {
        return function sortableError() {
            throw new Error("Sortable.js requires a window with a document");
        };
    }

    var dragEl,
        parentEl,
        ghostEl,
        cloneEl,
        rootEl,
        nextEl,

        scrollEl,
        scrollParentEl,
        scrollCustomFn,

        lastEl,
        lastCSS,
        lastParentCSS,

        oldIndex,
        newIndex,

        activeGroup,
        putSortable,

        autoScroll = {},

        tapEvt,
        touchEvt,

        moved,

        /** @const */
        RSPACE = /\s+/g,

        expando = 'Sortable' + (new Date).getTime(),

        win = window,
        document = win.document,
        parseInt = win.parseInt,

        $ = win.jQuery || win.Zepto,
        Polymer = win.Polymer,

        supportDraggable = !!('draggable' in document.createElement('div')),
        supportCssPointerEvents = (function (el) {
            // false when IE11
            if (!!navigator.userAgent.match(/Trident.*rv[ :]?11\./)) {
                return false;
            }
            el = document.createElement('x');
            el.style.cssText = 'pointer-events:auto';
            return el.style.pointerEvents === 'auto';
        })(),

        _silent = false,

        abs = Math.abs,
        min = Math.min,
        slice = [].slice,

        touchDragOverListeners = [],

        _autoScroll = _throttle(function (/**Event*/evt, /**Object*/options, /**HTMLElement*/rootEl) {
            // Bug: https://bugzilla.mozilla.org/show_bug.cgi?id=505521
            if (rootEl && options.scroll) {
                var el,
                    rect,
                    sens = options.scrollSensitivity,
                    speed = options.scrollSpeed,

                    x = evt.clientX,
                    y = evt.clientY,

                    winWidth = window.innerWidth,
                    winHeight = window.innerHeight,

                    vx,
                    vy,

                    scrollOffsetX,
                    scrollOffsetY
                ;

                // Delect scrollEl
                if (scrollParentEl !== rootEl) {
                    scrollEl = options.scroll;
                    scrollParentEl = rootEl;
                    scrollCustomFn = options.scrollFn;

                    if (scrollEl === true) {
                        scrollEl = rootEl;

                        do {
                            if ((scrollEl.offsetWidth < scrollEl.scrollWidth) ||
                                (scrollEl.offsetHeight < scrollEl.scrollHeight)
                            ) {
                                break;
                            }
                            /* jshint boss:true */
                        } while (scrollEl = scrollEl.parentNode);
                    }
                }

                if (scrollEl) {
                    el = scrollEl;
                    rect = scrollEl.getBoundingClientRect();
                    vx = (abs(rect.right - x) <= sens) - (abs(rect.left - x) <= sens);
                    vy = (abs(rect.bottom - y) <= sens) - (abs(rect.top - y) <= sens);
                }


                if (!(vx || vy)) {
                    vx = (winWidth - x <= sens) - (x <= sens);
                    vy = (winHeight - y <= sens) - (y <= sens);

                    /* jshint expr:true */
                    (vx || vy) && (el = win);
                }


                if (autoScroll.vx !== vx || autoScroll.vy !== vy || autoScroll.el !== el) {
                    autoScroll.el = el;
                    autoScroll.vx = vx;
                    autoScroll.vy = vy;

                    clearInterval(autoScroll.pid);

                    if (el) {
                        autoScroll.pid = setInterval(function () {
                            scrollOffsetY = vy ? vy * speed : 0;
                            scrollOffsetX = vx ? vx * speed : 0;

                            if ('function' === typeof(scrollCustomFn)) {
                                return scrollCustomFn.call(_this, scrollOffsetX, scrollOffsetY, evt);
                            }

                            if (el === win) {
                                win.scrollTo(win.pageXOffset + scrollOffsetX, win.pageYOffset + scrollOffsetY);
                            } else {
                                el.scrollTop += scrollOffsetY;
                                el.scrollLeft += scrollOffsetX;
                            }
                        }, 24);
                    }
                }
            }
        }, 30),

        _prepareGroup = function (options) {
            function toFn(value, pull) {
                if (value === void 0 || value === true) {
                    value = group.name;
                }

                if (typeof value === 'function') {
                    return value;
                } else {
                    return function (to, from) {
                        var fromGroup = from.options.group.name;

                        return pull
                            ? value
                            : value && (value.join
                                ? value.indexOf(fromGroup) > -1
                                : (fromGroup == value)
                            );
                    };
                }
            }

            var group = {};
            var originalGroup = options.group;

            if (!originalGroup || typeof originalGroup != 'object') {
                originalGroup = {name: originalGroup};
            }

            group.name = originalGroup.name;
            group.checkPull = toFn(originalGroup.pull, true);
            group.checkPut = toFn(originalGroup.put);

            options.group = group;
        }
    ;



    /***
     * @class  Sortable
     * @param  {HTMLElement}  el
     * @param  {Object}       [options]
     */
    function Sortable(el, options) {
        if (!(el && el.nodeType && el.nodeType === 1)) {
            throw 'Sortable: `el` must be HTMLElement, and not ' + {}.toString.call(el);
        }

        this.el = el; // root element
        this.options = options = _extend({}, options);


        // Export instance
        el[expando] = this;


        // Default options
        var defaults = {
            group: Math.random(),
            sort: true,
            disabled: false,
            store: null,
            handle: null,
            scroll: true,
            scrollSensitivity: 30,
            scrollSpeed: 10,
            draggable: /[uo]l/i.test(el.nodeName) ? 'li' : '>*',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            ignore: 'a, img',
            filter: null,
            animation: 0,
            setData: function (dataTransfer, dragEl) {
                dataTransfer.setData('Text', dragEl.textContent);
            },
            dropBubble: false,
            dragoverBubble: false,
            dataIdAttr: 'data-id',
            delay: 0,
            forceFallback: false,
            fallbackClass: 'sortable-fallback',
            fallbackOnBody: false,
            fallbackTolerance: 0,
            fallbackOffset: {x: 0, y: 0}
        };


        // Set default options
        for (var name in defaults) {
            !(name in options) && (options[name] = defaults[name]);
        }

        _prepareGroup(options);

        // Bind all private methods
        for (var fn in this) {
            if (fn.charAt(0) === '_' && typeof this[fn] === 'function') {
                this[fn] = this[fn].bind(this);
            }
        }

        // Setup drag mode
        this.nativeDraggable = options.forceFallback ? false : supportDraggable;

        // Bind events
        _on(el, 'mousedown', this._onTapStart);
        _on(el, 'touchstart', this._onTapStart);

        if (this.nativeDraggable) {
            _on(el, 'dragover', this);
            _on(el, 'dragenter', this);
        }

        touchDragOverListeners.push(this._onDragOver);

        // Restore sorting
        options.store && this.sort(options.store.get(this));
    }


    Sortable.prototype = /** @lends Sortable.prototype */ {
        constructor: Sortable,

        _onTapStart: function (/** Event|TouchEvent */evt) {
            var _this = this,
                el = this.el,
                options = this.options,
                type = evt.type,
                touch = evt.touches && evt.touches[0],
                target = (touch || evt).target,
                originalTarget = evt.target.shadowRoot && evt.path[0] || target,
                filter = options.filter,
                startIndex;

            // Don't trigger start event when an element is been dragged, otherwise the evt.oldindex always wrong when set option.group.
            if (dragEl) {
                return;
            }

            if (type === 'mousedown' && evt.button !== 0 || options.disabled) {
                return; // only left button or enabled
            }

            if (options.handle && !_closest(originalTarget, options.handle, el)) {
                return;
            }

            target = _closest(target, options.draggable, el);

            if (!target) {
                return;
            }

            // Get the index of the dragged element within its parent
            startIndex = _index(target, options.draggable);

            // Check filter
            if (typeof filter === 'function') {
                if (filter.call(this, evt, target, this)) {
                    _dispatchEvent(_this, originalTarget, 'filter', target, el, startIndex);
                    evt.preventDefault();
                    return; // cancel dnd
                }
            }
            else if (filter) {
                filter = filter.split(',').some(function (criteria) {
                    criteria = _closest(originalTarget, criteria.trim(), el);

                    if (criteria) {
                        _dispatchEvent(_this, criteria, 'filter', target, el, startIndex);
                        return true;
                    }
                });

                if (filter) {
                    evt.preventDefault();
                    return; // cancel dnd
                }
            }

            // Prepare `dragstart`
            this._prepareDragStart(evt, touch, target, startIndex);
        },

        _prepareDragStart: function (/** Event */evt, /** Touch */touch, /** HTMLElement */target, /** Number */startIndex) {
            var _this = this,
                el = _this.el,
                options = _this.options,
                ownerDocument = el.ownerDocument,
                dragStartFn;

            if (target && !dragEl && (target.parentNode === el)) {
                tapEvt = evt;

                rootEl = el;
                dragEl = target;
                parentEl = dragEl.parentNode;
                nextEl = dragEl.nextSibling;
                activeGroup = options.group;
                oldIndex = startIndex;

                this._lastX = (touch || evt).clientX;
                this._lastY = (touch || evt).clientY;

                dragEl.style['will-change'] = 'transform';

                dragStartFn = function () {
                    // Delayed drag has been triggered
                    // we can re-enable the events: touchmove/mousemove
                    _this._disableDelayedDrag();

                    // Make the element draggable
                    dragEl.draggable = _this.nativeDraggable;

                    // Chosen item
                    _toggleClass(dragEl, options.chosenClass, true);

                    // Bind the events: dragstart/dragend
                    _this._triggerDragStart(touch);

                    // Drag start event
                    _dispatchEvent(_this, rootEl, 'choose', dragEl, rootEl, oldIndex);
                };

                // Disable "draggable"
                options.ignore.split(',').forEach(function (criteria) {
                    _find(dragEl, criteria.trim(), _disableDraggable);
                });

                _on(ownerDocument, 'mouseup', _this._onDrop);
                _on(ownerDocument, 'touchend', _this._onDrop);
                _on(ownerDocument, 'touchcancel', _this._onDrop);

                if (options.delay) {
                    // If the user moves the pointer or let go the click or touch
                    // before the delay has been reached:
                    // disable the delayed drag
                    _on(ownerDocument, 'mouseup', _this._disableDelayedDrag);
                    _on(ownerDocument, 'touchend', _this._disableDelayedDrag);
                    _on(ownerDocument, 'touchcancel', _this._disableDelayedDrag);
                    _on(ownerDocument, 'mousemove', _this._disableDelayedDrag);
                    _on(ownerDocument, 'touchmove', _this._disableDelayedDrag);

                    _this._dragStartTimer = setTimeout(dragStartFn, options.delay);
                } else {
                    dragStartFn();
                }
            }
        },

        _disableDelayedDrag: function () {
            var ownerDocument = this.el.ownerDocument;

            clearTimeout(this._dragStartTimer);
            _off(ownerDocument, 'mouseup', this._disableDelayedDrag);
            _off(ownerDocument, 'touchend', this._disableDelayedDrag);
            _off(ownerDocument, 'touchcancel', this._disableDelayedDrag);
            _off(ownerDocument, 'mousemove', this._disableDelayedDrag);
            _off(ownerDocument, 'touchmove', this._disableDelayedDrag);
        },

        _triggerDragStart: function (/** Touch */touch) {
            if (touch) {
                // Touch device support
                tapEvt = {
                    target: dragEl,
                    clientX: touch.clientX,
                    clientY: touch.clientY
                };

                this._onDragStart(tapEvt, 'touch');
            }
            else if (!this.nativeDraggable) {
                this._onDragStart(tapEvt, true);
            }
            else {
                _on(dragEl, 'dragend', this);
                _on(rootEl, 'dragstart', this._onDragStart);
            }

            try {
                if (document.selection) {
                    // Timeout neccessary for IE9
                    setTimeout(function () {
                        document.selection.empty();
                    });
                } else {
                    window.getSelection().removeAllRanges();
                }
            } catch (err) {
            }
        },

        _dragStarted: function () {
            if (rootEl && dragEl) {
                var options = this.options;

                // Apply effect
                _toggleClass(dragEl, options.ghostClass, true);
                _toggleClass(dragEl, options.dragClass, false);

                Sortable.active = this;

                // Drag start event
                _dispatchEvent(this, rootEl, 'start', dragEl, rootEl, oldIndex);
            }
        },

        _emulateDragOver: function () {
            if (touchEvt) {
                if (this._lastX === touchEvt.clientX && this._lastY === touchEvt.clientY) {
                    return;
                }

                this._lastX = touchEvt.clientX;
                this._lastY = touchEvt.clientY;

                if (!supportCssPointerEvents) {
                    _css(ghostEl, 'display', 'none');
                }

                var target = document.elementFromPoint(touchEvt.clientX, touchEvt.clientY),
                    parent = target,
                    i = touchDragOverListeners.length;

                if (parent) {
                    do {
                        if (parent[expando]) {
                            while (i--) {
                                touchDragOverListeners[i]({
                                    clientX: touchEvt.clientX,
                                    clientY: touchEvt.clientY,
                                    target: target,
                                    rootEl: parent
                                });
                            }

                            break;
                        }

                        target = parent; // store last element
                    }
                    /* jshint boss:true */
                    while (parent = parent.parentNode);
                }

                if (!supportCssPointerEvents) {
                    _css(ghostEl, 'display', '');
                }
            }
        },


        _onTouchMove: function (/**TouchEvent*/evt) {
            if (tapEvt) {
                var options = this.options,
                    fallbackTolerance = options.fallbackTolerance,
                    fallbackOffset = options.fallbackOffset,
                    touch = evt.touches ? evt.touches[0] : evt,
                    dx = (touch.clientX - tapEvt.clientX) + fallbackOffset.x,
                    dy = (touch.clientY - tapEvt.clientY) + fallbackOffset.y,
                    translate3d = evt.touches ? 'translate3d(' + dx + 'px,' + dy + 'px,0)' : 'translate(' + dx + 'px,' + dy + 'px)';

                // only set the status to dragging, when we are actually dragging
                if (!Sortable.active) {
                    if (fallbackTolerance &&
                        min(abs(touch.clientX - this._lastX), abs(touch.clientY - this._lastY)) < fallbackTolerance
                    ) {
                        return;
                    }

                    this._dragStarted();
                }

                // as well as creating the ghost element on the document body
                this._appendGhost();

                moved = true;
                touchEvt = touch;

                _css(ghostEl, 'webkitTransform', translate3d);
                _css(ghostEl, 'mozTransform', translate3d);
                _css(ghostEl, 'msTransform', translate3d);
                _css(ghostEl, 'transform', translate3d);

                evt.preventDefault();
            }
        },

        _appendGhost: function () {
            if (!ghostEl) {
                var rect = dragEl.getBoundingClientRect(),
                    css = _css(dragEl),
                    options = this.options,
                    ghostRect;

                ghostEl = dragEl.cloneNode(true);

                _toggleClass(ghostEl, options.ghostClass, false);
                _toggleClass(ghostEl, options.fallbackClass, true);
                _toggleClass(ghostEl, options.dragClass, true);

                _css(ghostEl, 'top', rect.top - parseInt(css.marginTop, 10));
                _css(ghostEl, 'left', rect.left - parseInt(css.marginLeft, 10));
                _css(ghostEl, 'width', rect.width);
                _css(ghostEl, 'height', rect.height);
                _css(ghostEl, 'opacity', '0.8');
                _css(ghostEl, 'position', 'fixed');
                _css(ghostEl, 'zIndex', '100000');
                _css(ghostEl, 'pointerEvents', 'none');

                options.fallbackOnBody && document.body.appendChild(ghostEl) || rootEl.appendChild(ghostEl);

                // Fixing dimensions.
                ghostRect = ghostEl.getBoundingClientRect();
                _css(ghostEl, 'width', rect.width * 2 - ghostRect.width);
                _css(ghostEl, 'height', rect.height * 2 - ghostRect.height);
            }
        },

        _onDragStart: function (/**Event*/evt, /**boolean*/useFallback) {
            var dataTransfer = evt.dataTransfer,
                options = this.options;

            this._offUpEvents();

            if (activeGroup.checkPull(this, this, dragEl, evt) == 'clone') {
                cloneEl = _clone(dragEl);
                _css(cloneEl, 'display', 'none');
                rootEl.insertBefore(cloneEl, dragEl);
                _dispatchEvent(this, rootEl, 'clone', dragEl);
            }

            _toggleClass(dragEl, options.dragClass, true);

            if (useFallback) {
                if (useFallback === 'touch') {
                    // Bind touch events
                    _on(document, 'touchmove', this._onTouchMove);
                    _on(document, 'touchend', this._onDrop);
                    _on(document, 'touchcancel', this._onDrop);
                } else {
                    // Old brwoser
                    _on(document, 'mousemove', this._onTouchMove);
                    _on(document, 'mouseup', this._onDrop);
                }

                this._loopId = setInterval(this._emulateDragOver, 50);
            }
            else {
                if (dataTransfer) {
                    dataTransfer.effectAllowed = 'move';
                    options.setData && options.setData.call(this, dataTransfer, dragEl);
                }

                _on(document, 'drop', this);
                setTimeout(this._dragStarted, 0);
            }
        },

        _onDragOver: function (/**Event*/evt) {
            var el = this.el,
                target,
                dragRect,
                targetRect,
                revert,
                options = this.options,
                group = options.group,
                activeSortable = Sortable.active,
                isOwner = (activeGroup === group),
                canSort = options.sort;

            if (evt.preventDefault !== void 0) {
                evt.preventDefault();
                !options.dragoverBubble && evt.stopPropagation();
            }

            moved = true;

            if (activeGroup && !options.disabled &&
                (isOwner
                    ? canSort || (revert = !rootEl.contains(dragEl)) // Reverting item into the original list
                    : (
                        putSortable === this ||
                        activeGroup.checkPull(this, activeSortable, dragEl, evt) && group.checkPut(this, activeSortable, dragEl, evt)
                    )
                ) &&
                (evt.rootEl === void 0 || evt.rootEl === this.el) // touch fallback
            ) {
                // Smart auto-scrolling
                _autoScroll(evt, options, this.el);

                if (_silent) {
                    return;
                }

                target = _closest(evt.target, options.draggable, el);
                dragRect = dragEl.getBoundingClientRect();
                putSortable = this;

                if (revert) {
                    _cloneHide(true);
                    parentEl = rootEl; // actualization

                    if (cloneEl || nextEl) {
                        rootEl.insertBefore(dragEl, cloneEl || nextEl);
                    }
                    else if (!canSort) {
                        rootEl.appendChild(dragEl);
                    }

                    return;
                }


                if ((el.children.length === 0) || (el.children[0] === ghostEl) ||
                    (el === evt.target) && (target = _ghostIsLast(el, evt))
                ) {
                    if (target) {
                        if (target.animated) {
                            return;
                        }

                        targetRect = target.getBoundingClientRect();
                    }

                    _cloneHide(isOwner);

                    if (_onMove(rootEl, el, dragEl, dragRect, target, targetRect, evt) !== false) {
                        if (!dragEl.contains(el)) {
                            el.appendChild(dragEl);
                            parentEl = el; // actualization
                        }

                        this._animate(dragRect, dragEl);
                        target && this._animate(targetRect, target);
                    }
                }
                else if (target && !target.animated && target !== dragEl && (target.parentNode[expando] !== void 0)) {
                    if (lastEl !== target) {
                        lastEl = target;
                        lastCSS = _css(target);
                        lastParentCSS = _css(target.parentNode);
                    }

                    targetRect = target.getBoundingClientRect();

                    var width = targetRect.right - targetRect.left,
                        height = targetRect.bottom - targetRect.top,
                        floating = /left|right|inline/.test(lastCSS.cssFloat + lastCSS.display)
                            || (lastParentCSS.display == 'flex' && lastParentCSS['flex-direction'].indexOf('row') === 0),
                        isWide = (target.offsetWidth > dragEl.offsetWidth),
                        isLong = (target.offsetHeight > dragEl.offsetHeight),
                        halfway = (floating ? (evt.clientX - targetRect.left) / width : (evt.clientY - targetRect.top) / height) > 0.5,
                        nextSibling = target.nextElementSibling,
                        moveVector = _onMove(rootEl, el, dragEl, dragRect, target, targetRect, evt),
                        after
                    ;

                    if (moveVector !== false) {
                        _silent = true;
                        setTimeout(_unsilent, 30);

                        _cloneHide(isOwner);

                        if (moveVector === 1 || moveVector === -1) {
                            after = (moveVector === 1);
                        }
                        else if (floating) {
                            var elTop = dragEl.offsetTop,
                                tgTop = target.offsetTop;

                            if (elTop === tgTop) {
                                after = (target.previousElementSibling === dragEl) && !isWide || halfway && isWide;
                            }
                            else if (target.previousElementSibling === dragEl || dragEl.previousElementSibling === target) {
                                after = (evt.clientY - targetRect.top) / height > 0.5;
                            } else {
                                after = tgTop > elTop;
                            }
                        } else {
                            after = (nextSibling !== dragEl) && !isLong || halfway && isLong;
                        }

                        if (!dragEl.contains(el)) {
                            if (after && !nextSibling) {
                                el.appendChild(dragEl);
                            } else {
                                target.parentNode.insertBefore(dragEl, after ? nextSibling : target);
                            }
                        }

                        parentEl = dragEl.parentNode; // actualization

                        this._animate(dragRect, dragEl);
                        this._animate(targetRect, target);
                    }
                }
            }
        },

        _animate: function (prevRect, target) {
            var ms = this.options.animation;

            if (ms) {
                var currentRect = target.getBoundingClientRect();

                _css(target, 'transition', 'none');
                _css(target, 'transform', 'translate3d('
                    + (prevRect.left - currentRect.left) + 'px,'
                    + (prevRect.top - currentRect.top) + 'px,0)'
                );

                target.offsetWidth; // repaint

                _css(target, 'transition', 'all ' + ms + 'ms');
                _css(target, 'transform', 'translate3d(0,0,0)');

                clearTimeout(target.animated);
                target.animated = setTimeout(function () {
                    _css(target, 'transition', '');
                    _css(target, 'transform', '');
                    target.animated = false;
                }, ms);
            }
        },

        _offUpEvents: function () {
            var ownerDocument = this.el.ownerDocument;

            _off(document, 'touchmove', this._onTouchMove);
            _off(ownerDocument, 'mouseup', this._onDrop);
            _off(ownerDocument, 'touchend', this._onDrop);
            _off(ownerDocument, 'touchcancel', this._onDrop);
        },

        _onDrop: function (/**Event*/evt) {
            var el = this.el,
                options = this.options;

            clearInterval(this._loopId);
            clearInterval(autoScroll.pid);
            clearTimeout(this._dragStartTimer);

            // Unbind events
            _off(document, 'mousemove', this._onTouchMove);

            if (this.nativeDraggable) {
                _off(document, 'drop', this);
                _off(el, 'dragstart', this._onDragStart);
            }

            this._offUpEvents();

            if (evt) {
                if (moved) {
                    evt.preventDefault();
                    !options.dropBubble && evt.stopPropagation();
                }

                ghostEl && ghostEl.parentNode.removeChild(ghostEl);

                if (dragEl) {
                    if (this.nativeDraggable) {
                        _off(dragEl, 'dragend', this);
                    }

                    _disableDraggable(dragEl);
                    dragEl.style['will-change'] = '';

                    // Remove class's
                    _toggleClass(dragEl, this.options.ghostClass, false);
                    _toggleClass(dragEl, this.options.chosenClass, false);

                    if (rootEl !== parentEl) {
                        newIndex = _index(dragEl, options.draggable);

                        if (newIndex >= 0) {

                            // Add event
                            _dispatchEvent(null, parentEl, 'add', dragEl, rootEl, oldIndex, newIndex);

                            // Remove event
                            _dispatchEvent(this, rootEl, 'remove', dragEl, rootEl, oldIndex, newIndex);

                            // drag from one list and drop into another
                            _dispatchEvent(null, parentEl, 'sort', dragEl, rootEl, oldIndex, newIndex);
                            _dispatchEvent(this, rootEl, 'sort', dragEl, rootEl, oldIndex, newIndex);
                        }
                    }
                    else {
                        // Remove clone
                        cloneEl && cloneEl.parentNode.removeChild(cloneEl);

                        if (dragEl.nextSibling !== nextEl) {
                            // Get the index of the dragged element within its parent
                            newIndex = _index(dragEl, options.draggable);

                            if (newIndex >= 0) {
                                // drag & drop within the same list
                                _dispatchEvent(this, rootEl, 'update', dragEl, rootEl, oldIndex, newIndex);
                                _dispatchEvent(this, rootEl, 'sort', dragEl, rootEl, oldIndex, newIndex);
                            }
                        }
                    }

                    if (Sortable.active) {
                        /* jshint eqnull:true */
                        if (newIndex == null || newIndex === -1) {
                            newIndex = oldIndex;
                        }

                        _dispatchEvent(this, rootEl, 'end', dragEl, rootEl, oldIndex, newIndex);

                        // Save sorting
                        this.save();
                    }
                }

            }

            this._nulling();
        },

        _nulling: function() {
            rootEl =
            dragEl =
            parentEl =
            ghostEl =
            nextEl =
            cloneEl =

            scrollEl =
            scrollParentEl =

            tapEvt =
            touchEvt =

            moved =
            newIndex =

            lastEl =
            lastCSS =

            putSortable =
            activeGroup =
            Sortable.active = null;
        },

        handleEvent: function (/**Event*/evt) {
            var type = evt.type;

            if (type === 'dragover' || type === 'dragenter') {
                if (dragEl) {
                    this._onDragOver(evt);
                    _globalDragOver(evt);
                }
            }
            else if (type === 'drop' || type === 'dragend') {
                this._onDrop(evt);
            }
        },


        /***
         * Serializes the item into an array of string.
         * @returns {String[]}
         */
        toArray: function () {
            var order = [],
                el,
                children = this.el.children,
                i = 0,
                n = children.length,
                options = this.options;

            for (; i < n; i++) {
                el = children[i];
                if (_closest(el, options.draggable, this.el)) {
                    order.push(el.getAttribute(options.dataIdAttr) || _generateId(el));
                }
            }

            return order;
        },


        /**
         * Sorts the elements according to the array.
         * @param  {String[]}  order  order of the items
         */
        sort: function (order) {
            var items = {}, rootEl = this.el;

            this.toArray().forEach(function (id, i) {
                var el = rootEl.children[i];

                if (_closest(el, this.options.draggable, rootEl)) {
                    items[id] = el;
                }
            }, this);

            order.forEach(function (id) {
                if (items[id]) {
                    rootEl.removeChild(items[id]);
                    rootEl.appendChild(items[id]);
                }
            });
        },


        /***
         * Save the current sorting
         */
        save: function () {
            var store = this.options.store;
            store && store.set(this);
        },


        /***
         * For each element in the set, get the first element that matches the selector by testing the element itself and traversing up through its ancestors in the DOM tree.
         * @param   {HTMLElement}  el
         * @param   {String}       [selector]  default: `options.draggable`
         * @returns {HTMLElement|null}
         */
        closest: function (el, selector) {
            return _closest(el, selector || this.options.draggable, this.el);
        },


        /***
         * Set/get option
         * @param   {string} name
         * @param   {*}      [value]
         * @returns {*}
         */
        option: function (name, value) {
            var options = this.options;

            if (value === void 0) {
                return options[name];
            } else {
                options[name] = value;

                if (name === 'group') {
                    _prepareGroup(options);
                }
            }
        },


        /***
         * Destroy
         */
        destroy: function () {
            var el = this.el;

            el[expando] = null;

            _off(el, 'mousedown', this._onTapStart);
            _off(el, 'touchstart', this._onTapStart);

            if (this.nativeDraggable) {
                _off(el, 'dragover', this);
                _off(el, 'dragenter', this);
            }

            // Remove draggable attributes
            Array.prototype.forEach.call(el.querySelectorAll('[draggable]'), function (el) {
                el.removeAttribute('draggable');
            });

            touchDragOverListeners.splice(touchDragOverListeners.indexOf(this._onDragOver), 1);

            this._onDrop();

            this.el = el = null;
        }
    };


    function _cloneHide(state) {
        if (cloneEl && (cloneEl.state !== state)) {
            _css(cloneEl, 'display', state ? 'none' : '');
            !state && cloneEl.state && rootEl.insertBefore(cloneEl, dragEl);
            cloneEl.state = state;
        }
    }


    function _closest(/**HTMLElement*/el, /**String*/selector, /**HTMLElement*/ctx) {
        if (el) {
            ctx = ctx || document;

            do {
                if ((selector === '>*' && el.parentNode === ctx) || _matches(el, selector)) {
                    return el;
                }
                /* jshint boss:true */
            } while (el = _getParentOrHost(el));
        }

        return null;
    }


    function _getParentOrHost(el) {
        var parent = el.host;

        return (parent && parent.nodeType) ? parent : el.parentNode;
    }


    function _globalDragOver(/**Event*/evt) {
        if (evt.dataTransfer) {
            evt.dataTransfer.dropEffect = 'move';
        }
        evt.preventDefault();
    }


    function _on(el, event, fn) {
        el.addEventListener(event, fn, false);
    }


    function _off(el, event, fn) {
        el.removeEventListener(event, fn, false);
    }


    function _toggleClass(el, name, state) {
        if (el) {
            if (el.classList) {
                el.classList[state ? 'add' : 'remove'](name);
            }
            else {
                var className = (' ' + el.className + ' ').replace(RSPACE, ' ').replace(' ' + name + ' ', ' ');
                el.className = (className + (state ? ' ' + name : '')).replace(RSPACE, ' ');
            }
        }
    }


    function _css(el, prop, val) {
        var style = el && el.style;

        if (style) {
            if (val === void 0) {
                if (document.defaultView && document.defaultView.getComputedStyle) {
                    val = document.defaultView.getComputedStyle(el, '');
                }
                else if (el.currentStyle) {
                    val = el.currentStyle;
                }

                return prop === void 0 ? val : val[prop];
            }
            else {
                if (!(prop in style)) {
                    prop = '-webkit-' + prop;
                }

                style[prop] = val + (typeof val === 'string' ? '' : 'px');
            }
        }
    }


    function _find(ctx, tagName, iterator) {
        if (ctx) {
            var list = ctx.getElementsByTagName(tagName), i = 0, n = list.length;

            if (iterator) {
                for (; i < n; i++) {
                    iterator(list[i], i);
                }
            }

            return list;
        }

        return [];
    }



    function _dispatchEvent(sortable, rootEl, name, targetEl, fromEl, startIndex, newIndex) {
        sortable = (sortable || rootEl[expando]);

        var evt = document.createEvent('Event'),
            options = sortable.options,
            onName = 'on' + name.charAt(0).toUpperCase() + name.substr(1);

        evt.initEvent(name, true, true);

        evt.to = rootEl;
        evt.from = fromEl || rootEl;
        evt.item = targetEl || rootEl;
        evt.clone = cloneEl;

        evt.oldIndex = startIndex;
        evt.newIndex = newIndex;

        rootEl.dispatchEvent(evt);

        if (options[onName]) {
            options[onName].call(sortable, evt);
        }
    }


    function _onMove(fromEl, toEl, dragEl, dragRect, targetEl, targetRect, originalEvt) {
        var evt,
            sortable = fromEl[expando],
            onMoveFn = sortable.options.onMove,
            retVal;

        evt = document.createEvent('Event');
        evt.initEvent('move', true, true);

        evt.to = toEl;
        evt.from = fromEl;
        evt.dragged = dragEl;
        evt.draggedRect = dragRect;
        evt.related = targetEl || toEl;
        evt.relatedRect = targetRect || toEl.getBoundingClientRect();

        fromEl.dispatchEvent(evt);

        if (onMoveFn) {
            retVal = onMoveFn.call(sortable, evt, originalEvt);
        }

        return retVal;
    }


    function _disableDraggable(el) {
        el.draggable = false;
    }


    function _unsilent() {
        _silent = false;
    }


    /*** @returns {HTMLElement|false} */
    function _ghostIsLast(el, evt) {
        var lastEl = el.lastElementChild,
            rect = lastEl.getBoundingClientRect();

        // 5 — min delta
        // abs — нельзя добавлять, а то глюки при наведении сверху
        return (
            (evt.clientY - (rect.top + rect.height) > 5) ||
            (evt.clientX - (rect.right + rect.width) > 5)
        ) && lastEl;
    }


    /***
     * Generate id
     * @param   {HTMLElement} el
     * @returns {String}
     * @private
     */
    function _generateId(el) {
        var str = el.tagName + el.className + el.src + el.href + el.textContent,
            i = str.length,
            sum = 0;

        while (i--) {
            sum += str.charCodeAt(i);
        }

        return sum.toString(36);
    }

    /***
     * Returns the index of an element within its parent for a selected set of
     * elements
     * @param  {HTMLElement} el
     * @param  {selector} selector
     * @return {number}
     */
    function _index(el, selector) {
        var index = 0;

        if (!el || !el.parentNode) {
            return -1;
        }

        while (el && (el = el.previousElementSibling)) {
            if ((el.nodeName.toUpperCase() !== 'TEMPLATE') && (selector === '>*' || _matches(el, selector))) {
                index++;
            }
        }

        return index;
    }

    function _matches(/**HTMLElement*/el, /**String*/selector) {
        if (el) {
            selector = selector.split('.');

            var tag = selector.shift().toUpperCase(),
                re = new RegExp('\\s(' + selector.join('|') + ')(?=\\s)', 'g');

            return (
                (tag === '' || el.nodeName.toUpperCase() == tag) &&
                (!selector.length || ((' ' + el.className + ' ').match(re) || []).length == selector.length)
            );
        }

        return false;
    }

    function _throttle(callback, ms) {
        var args, _this;

        return function () {
            if (args === void 0) {
                args = arguments;
                _this = this;

                setTimeout(function () {
                    if (args.length === 1) {
                        callback.call(_this, args[0]);
                    } else {
                        callback.apply(_this, args);
                    }

                    args = void 0;
                }, ms);
            }
        };
    }

    function _extend(dst, src) {
        if (dst && src) {
            for (var key in src) {
                if (src.hasOwnProperty(key)) {
                    dst[key] = src[key];
                }
            }
        }

        return dst;
    }

    function _clone(el) {
        return $
            ? $(el).clone(true)[0]
            : (Polymer && Polymer.dom
                ? Polymer.dom(el).cloneNode(true)
                : el.cloneNode(true)
            );
    }


    // Export utils
    Sortable.utils = {
        on: _on,
        off: _off,
        css: _css,
        find: _find,
        is: function (el, selector) {
            return !!_closest(el, selector, el);
        },
        extend: _extend,
        throttle: _throttle,
        closest: _closest,
        toggleClass: _toggleClass,
        clone: _clone,
        index: _index
    };


    /***
     * Create sortable instance
     * @param {HTMLElement}  el
     * @param {Object}      [options]
     */
    Sortable.create = function (el, options) {
        return new Sortable(el, options);
    };


    // Export
    Sortable.version = '1.4.2';

    window['Sortable'] = Sortable;
})();

(function (WIS_EMAP_CONFIG, undefined) {
  WIS_EMAP_CONFIG.getOptionType = 'POST';

  // 配置高级搜索 条件构造器 条件搜索 高级搜索2.0组件中下拉控件是否展示空值选项
  WIS_EMAP_CONFIG.showBlankOptionInSearch = false;

  // 配置组件渲染时是都开启放xss的功能，暨为true时使用text(),为false时使用html()
  // 目前作用于只读表单的赋值渲染
  WIS_EMAP_CONFIG.xssSafeRender = true;

  // 配置下拉树是否开启级联的功能
  WIS_EMAP_CONFIG.dropdownTreeHasThreeStates = false;

  // 配置是否使用基于zTree的新的下拉树
  WIS_EMAP_CONFIG.useNewDropdownTree = false;
  WIS_EMAP_CONFIG.useNewDropdownTreeForm = false;

  WIS_EMAP_CONFIG.setOptions = function (obj) {
    if (typeof obj !== 'object') return console && console.error('传参必须为对象');
    for (var k in obj) {
      if (k === 'setOptions') return;
      WIS_EMAP_CONFIG[k] = obj[k];
    }
  };


  WIS_EMAP_CONFIG.dropDownOneKeySelect = false;

  WIS_EMAP_CONFIG.useI18n = !!(window.APP_CONFIG && window.APP_CONFIG.USE_LANG) || false;

  // 获取i18n国际化配置



  WIS_EMAP_CONFIG.setOptions = function (obj) {
    if (typeof obj !== 'object') return console && console.error('传参必须为对象');
    for (var k in obj) {
      if (k === 'setOptions') return;
      WIS_EMAP_CONFIG[k] = obj[k];
    }
  };

  function getCookie(name) {
    var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
    if (arr = document.cookie.match(reg))
      return unescape(arr[2]);
    else
      return null;
  }



  // 表格ajax完成后的回调 需要全局处理的时候使用
  // WIS_EMAP_CONFIG.dataTableAjaxCompleteCallback

  // WIS_EMAP_CONFIG.tableDataType = ''
})(window.WIS_EMAP_CONFIG = window.WIS_EMAP_CONFIG || {});

/**
 * @module WIS_EMAP_SERV
 * @alias 公共方法
 * @description 这是一个全局对象，包含了请求和数据相关的公共方法s
 */
;
(function(WIS_EMAP_SERV, undefined) {
    var fileTypeArray = ['7Z', 'AAC', 'ASP', 'AVI', 'BAT', 'BMP', 'CAD', 'CSS', 'DOC', 'DOCX', 'EXE', 'FLV', 'GIF', 'HTML', 'ISO', 'JAVA', 'JAR', 'JPEG', 'JPG', 'MOV', 'MP3', 'MP4', 'MPEG', 'PHP', 'PNG', 'PPT', 'PPTX', 'PSD', 'RAR', 'RMVB', 'SVG', 'SWF', 'BT', 'TXT', 'XLS', 'XLSX', 'ZIP']
    WIS_EMAP_SERV.getFileInfoByName = function(fileName) {
        var type = fileName.substring(fileName.lastIndexOf('.') + 1);
        type = type.toUpperCase();
        if (fileTypeArray.indexOf(type) > -1) {
            return {
                tag: type,
                text: type
            };
        } else {
            return {
                tag: 'unknown',
                text: '???'
            };
        }
    };

    // model 分组排序
    /**
     * @method _sortModel
     * @description 对含有groupName的数据模型进行分组
     * @param {Array} model - 数据模型对象数组
     * @return {Array} - 分组后的数据模型，格式为
     * [
     *  {
     *      "groupName": "aaa",
            "items": [{
                "name": "xxx",
                "xtype": "xxx",
                "caption": "xxx",
                ...
            }, ...]
     *  },
     *  ...
     * ]
     * @example
     * WIS_EMAP_SERV._sortModel([
     *  {
            "name": "xxx",
            "xtype": "xxx",
            "caption": "xxx",
            ...
     *  }
     * ])
     */
    WIS_EMAP_SERV._sortModel = function(model) {
        var result = [];
        for (var i = 0; i < model.length; i++) {
            var groupItem = result.filter(function(val) {
                return val.groupName == model[i].groupName;
            });
            if (groupItem.length == 0) {
                result.push({
                    "groupName": model[i].groupName,
                    "items": [model[i]]
                });
            } else {
                groupItem[0].items.push(model[i]);
            }
        }
        return result;
    };

    /**
     * @method getPageMeta
     * @description 获取emap pageMeta数据
     * @param  {String} pagePath - 页面地址
     * @param  {Object} params - 请求参数
     * @param  {Object} requestOption - 请求配置
     * @return {Object} pageMeta
     */
    WIS_EMAP_SERV.getPageMeta = function(pagePath, params, requestOption) {
        var params = $.extend({
            "*json": "1"
        }, params);
        var pageMeta = BH_UTILS.doSyncAjax(WIS_EMAP_SERV.getAbsPath(pagePath), params, null, requestOption);
        window._EMAP_PageMeta = window._EMAP_PageMeta || {};
        window._EMAP_PageMeta[pagePath] = pageMeta;
        if (typeof pageMeta.loginURL != 'undefined') {
            window._EMAP_PageMeta = {};
        }
        return pageMeta;
    };

    /**
     * @method getModel
     * @description 获取emap模型
     * @param  {String} pagePath -  页面地址
     * @param  {String} actionID - 动作名称
     * @param  {String} type - 请求模型的类型，可选值 form grid search
     * @param  {Object} [params] - 请求参数
     * @param  {String} [requestOption] - 请求配置
     * @example
     * var formModel = WIS_EMAP_SERV.getModel('modules/editForm.do', 'T_PXXX_XSJBXX_QUERY', 'form');
     */
    WIS_EMAP_SERV.getModel = function(pagePath, actionID, type, params, requestOption) {
        // window.sessionStorage.setItem();
        // window._EMAP_PageMeta = window._EMAP_PageMeta || {};

        // var pageMeta = window._EMAP_PageMeta[pagePath];
        // if (pageMeta === undefined) {
        //     pageMeta = this.getPageMeta(pagePath);
        // }

        // add by liujun emapform的meta直接通过对象传入
        if (typeof(pagePath) === 'object') {
            return this.convertModel(pagePath, type);
        }

        var pageMeta = this.getPageMeta(pagePath, params, requestOption);
        var model;

        if (type == "search") {
            var url = WIS_EMAP_SERV.getAbsPath(pagePath).replace('.do', '/' + actionID + '.do');
            pageMeta = BH_UTILS.doSyncAjax(url, $.extend({
                "*searchMeta": "1"
            }, params), null, requestOption);
            model = pageMeta.searchMeta;

        } else {
            var getData = pageMeta.models.filter(function(val) {
                return val.name == actionID
            });
            model = getData[0];
        }
        WIS_EMAP_SERV.modelName = model.modelName;
        WIS_EMAP_SERV.appName = model.appName;
        WIS_EMAP_SERV.url = model.url;
        WIS_EMAP_SERV.name = model.name;

        return this.convertModel(model, type);
    };

    /**
     * @method convertModel
     * @description 转换模型，给模型字段项加上get方法
     * @param {Object} model - 数据模型
     * @param {String} [type] - 类型 可选值  'form' 'grid' 'search'
     * @example
     * WIS_EMAP_SERV.convertModel(dataModel);
     */
    WIS_EMAP_SERV.convertModel = function(model, type) {
        if (model === undefined || model == null) {
            //getData = {code: 0,msg: "没有数据",models:[],datas:{}};
            return undefined;
        } else {
            if (type === undefined)
                return BH_UTILS.i18nObject(model.controls);
            else {
                if (model instanceof Array) {
                    BH_UTILS.i18nObject(model);
                    addGetMethod(model);
                    return model;
                } else {
                    BH_UTILS.i18nObject(model.controls);
                    addGetMethod(model.controls);
                    if (type == "search")
                        return model;
                    else
                        return model.controls;
                }
            }
        }

        function addGetMethod(model_array) {
            model_array.map(function(item) {
                item.get = function(field) {
                    if (this[type + "." + field] !== undefined && this[type + "." + field] !== "")
                        return this[type + "." + field];
                    else
                        return this[field];
                }
            })
        }
    };


    WIS_EMAP_SERV.getData = function(pagePath, actionID, queryKey) {
        window._EMAP_PageMeta = window._EMAP_PageMeta || {};
        var pageMeta = window._EMAP_PageMeta[pagePath];
        if (pageMeta === undefined)
            pageMeta = this.getPageMeta(pagePath);

        var model = pageMeta.models.filter(function(val) {
            return val.name == actionID
        });


        var modelPath = pagePath.substring(0, pagePath.indexOf("/")) + "/" + model[0].url;
        var getData = BH_UTILS.doSyncAjax(WIS_EMAP_SERV.getAbsPath(modelPath), queryKey);
        if (getData === undefined || getData == null) {
            getData = {
                code: 0,
                msg: $.i18n('bh-sv-noDatas'),
                datas: {}
            };
            return {
                rows: []
            };
        } else {
            if (getData.result !== undefined && getData.result.datas !== undefined)
                getData = getData.result;
            return getData.datas[actionID];
        }
    };

    WIS_EMAP_SERV.getCode = function(url, id, name, pid, searchValue) {
        var params = {};
        if (id) params["id"] = id;
        if (name) params["name"] = name;
        if (pid) params["pid"] = pid;
        if (searchValue) params["searchValue"] = searchValue;
        var codeData = BH_UTILS.doSyncAjax(url, params);
        if (codeData === undefined || codeData == null) {
            return undefined;
        } else {
            // 兼容公有云的数据格式
            if (codeData.datas.code === undefined && codeData.datas.rows !== undefined) {
                return codeData.datas.rows;
            }
            return codeData.datas.code.rows;
        }
    };

    //name 传入的是string，则只返回一个参数的查询条件
    //name 传入的是array，结构是：[{name:"", value:""},{name:"", value:""}]，则返回多个参数的查询条件
    WIS_EMAP_SERV.buildCodeSearchParam = function(name, value) {
        if ($.isArray(name)) {
            var list_map = name;
            var result = [];
            for (var i = list_map.length - 1; i >= 0; i--) {
                result.push({
                    name: list_map[i].name,
                    value: list_map[i].value,
                    linkOpt: "and",
                    builder: "equal"
                });
            };
            return {
                searchValue: JSON.stringify(result)
            };
        } else {
            return {
                searchValue: JSON.stringify([{
                    name: name,
                    value: value,
                    linkOpt: "and",
                    builder: "equal"
                }])
            };
        }
    };

    /**
     * @method getContextPath
     * @description 获取根路径
     * @return {String} - 应用页面的根路径
     * WIS_EMAP_SERV.getContextPath();
     * // 返回  '/emap'
     */
    WIS_EMAP_SERV.getContextPath = function() {
        var contextPath = "";
        var path = window.location.pathname;
        var end = path.indexOf('/sys/');

        return path.substring(0, end) || '/emap';
    };

    /**
     * @method getAppPath
     * @description 获取应用路径
     * @return {String} - 当前应用路径
     * @example
     * WIS_EMAP_SERV.getAppPath();
     * // 返回  "/emap/sys/student_app"
     */
    WIS_EMAP_SERV.getAppPath = function() {
        var path = window.location.pathname;
        var start = path.indexOf('/sys/') + '/sys/'.length;

        var tmpPath = path.substring(start, path.length);
        var app_path = tmpPath.substring(0, tmpPath.indexOf("/"));
        return WIS_EMAP_SERV.getContextPath() + "/sys/" + app_path;
    };

    /**
     * @method getAbsPath
     * @description 获取绝对路径
     * @param {String} page_path 传入的相对路径
     * @return {String} - 绝对路径
     * @example
     * WIS_EMAP_SERV.getAbsPath('modules/xsxxdbwh.do');
     * // 返回 "/emap/sys/student_app/modules/xsxxdbwh.do"
     */
    WIS_EMAP_SERV.getAbsPath = function(page_path) {
        if (page_path === undefined) {
            console && console.warn('WIS_EMAP_SERV.getAbsPath 传参为空');
            return;
        }
        if (page_path.substring(0, 7) == "http://" || page_path.substring(0, 8) == "https://") {
            return page_path;
        }
        if (page_path.substring(0, 1) == '/') {
            page_path = page_path.substring(1, page_path.length);
        }
        // if(page_path.substring(0, '*default/'.length) == '*default/'){
        //     page_path = page_path;
        // }

        //访问的是页面.do
        var page_found = page_path.match(/module*(.*?)\//);
        if (page_found == null) {
            // //路由的绝对路径
            // if(page_path.substring(0, 8) != 'modules/'){
            //     page_path = 'modules/' + page_path;
            // }

            // if(page_path.substring(0, 16) == 'modules/modules/'){
            //     page_path = page_path.slice(8);
            // }
            // if(page_path.substring(0, 15) == 'modules/http://' || page_path.substring(0, 16) == 'modules/https://'){
            //     page_path = page_path.slice(8);
            // }
        }

        var absPath = WIS_EMAP_SERV.getAppPath() + "/" + page_path;
        return absPath;
    };

    /**
     * @method clone对象
     * @description 深度克隆对象
     * @param {Object} obj - 需要克隆的对象
     * @returns {Object} - 克隆结果
     * @example
     * WIS_EMAP_SERV.cloneObj({
     *  a: xx,
     *  b: xx,
     *  ...
     * })
     */
    WIS_EMAP_SERV.cloneObj = function(obj) {
        var clone;
        if (obj instanceof Array) {
            clone = [];
            for (var i = 0; i < obj.length; i++) {
                clone.push(WIS_EMAP_SERV.cloneObj(obj[i]));
            }
        } else {
            clone = {};
            for (var k in obj) {
                if (typeof obj[k] == 'Object') {
                    clone[k] = WIS_EMAP_SERV.cloneObj(obj[k]);
                } else {
                    clone[k] = obj[k];
                }
            }
        }
        return clone;
    };


    /**
     * @method batchDownloadFiles
     * @description 批量下载文件
     * @param  {object} options - 传参
     * @param  {String} options.contextPath - 根路径
     * @param  {String|Array} options.tokens - 文件token，多个用，分隔, 或者是数组
     * @param  {Int} [options.imageSize=0] - 图片尺寸， 可选值0 - 原始， 1 - 中等， 2 - 小型
     * @param  {Int} [options.nameType=id] - 命名类型， 可选值0 - id， 1 - fielname
     * @param  {String} [options.zipName] - 自定义下载的zip 文件名
     * @example
     * WIS_EMAP_SERV.batchDownloadFiles({
     *     contextPath：'/emap',
     *      tokens: ['aaa', 'bbb', 'ccc']
     * })
     *
     * {
     *      contextPath：地址 //字符串
     *      tokens: token串 //数组或者字符串，字符串中间以逗号隔开
     *      imageSize: 0(默认) 原始  1 中等  2 小型
     *       nameType: 命名类型  0 (默认)id   1 fielname
     *       zipName: 自定义下载的zip 文件名 (可选)
     * }
     */
    WIS_EMAP_SERV.batchDownloadFiles = function(options) {
        if (options) {
            $('body').append('<form method="post" class="bh-hide"></form>');
            var $form = $('form').last();
            var type = $.type(options.tokens);
            $form.attr('action', (options.contextPath || '..') + '/sys/emapcomponent/file/getFileBatchByTokenArray.do');
            if (options.imageSize) {
                $form.append('<input type="hidden" name="imageSize" value="' + options.imageSize + '"/>');
            }

            if (options.nameType) {
                $form.append('<input type="hidden" name="nameType" value="' + options.nameType + '"/>');
            }

            if (options.zipName !== undefined && options.zipName !== null) {
                $form.append('<input type="hidden" name="zipName" value="' + options.zipName + '"/>');
            }
            if (type === 'array') {
                $form.append('<input type="hidden" name="fileTokenArray" value="' + options.tokens.join(',') + '"/>');
                $form.submit();
            }
            if (type === 'string') {
                $form.append('<input type="hidden" name="fileTokenArray" value="' + options.tokens + '"/>');
                $form.submit();
            }

            $form.remove();
        }
    };

    /**
     * 下载文件
     * @return {[type]} [description]
     */
    WIS_EMAP_SERV.downloadFile = function(url, blank) {
        if (window.ActiveXObject || "ActiveXObject" in window) {
            var gotoLink = document.createElement('a');
            gotoLink.href = url;
            if (blank) {
                gotoLink.setAttribute('target', '_blank');
            }
            document.body.appendChild(gotoLink);
            gotoLink.click();
        } else {
            if (blank) {
                window.open(url);
            } else {
                window.location.href = url;
            }
        }
    };

    WIS_EMAP_SERV._html2Escape = function(sHtml) {
        if (sHtml) {
            var escapeMap = {
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                '"': '&quot;'
            };
            return sHtml.replace(/[<>&"]/g, function(c) {
                return escapeMap[c];
            });
        }
        return sHtml;
    };

    WIS_EMAP_SERV._descape2html = function(str) {
        if (str) {
            var descapeMap = {
                '&lt;': '<',
                '&gt;': '>',
                '&amp;': '&',
                '&quot;': '"'
            };
            return str.replace(/&lt;|&gt;|&amp;|&quot;/g, function(c) {
                return descapeMap[c];
            });
        }
        return str;
    };

    /**
     * @method getAttr
     * @description 根据模型项获取配置信息
     * @param {Object} item - 模型JSON对象
     * @param {String} type - 取值类型可选值 form grid search
     * @returns {Object} - 模型配置信息
     */
    WIS_EMAP_SERV.getAttr = function(item, type) {
        if (!item.get) {
            if (type === undefined) {
                return console && console.error('数据模型缺少get方法或getAttr方法缺少type参数！');
            }
            item.get = function(field) {
                if (this[type + "." + field] !== undefined && this[type + "." + field] !== "")
                    return this[type + "." + field];
                else
                    return this[field];
            }
        }
        return {
            xtype: item.get("xtype") || 'text',
            dataType: item.get("dataType"),
            caption: item.get("caption"),
            col: item.get("col") ? item.get("col") : 1,
            url: item.get("url"),
            name: item.get("name"),
            hidden: item.get("hidden"),
            placeholder: item.get("placeholder") ? item.get("placeholder") : '',
            inputReadonly: item.get("readonly") ? true : false,
            required: item.get("required") ? "bh-required" : "",
            checkType: item.get("checkType") ? item.get("checkType") : false,
            checkSize: item.get("checkSize"),
            dataSize: item.get("dataSize") ? item.get("dataSize") : 99999,
            checkExp: item.get("checkExp"),
            JSONParam: item.get("JSONParam") ? item.get("JSONParam") : '{}',
            format: item.get("format"),
            defaultValue: item.get("defaultValue"),
            optionData: item.get("optionData"),
            quickSearch: item.get("quickSearch"),
            width: item.get("width"),
            minWidth: item.get("minWidth")
        }
    };

    WIS_EMAP_SERV.inputSetValue = function(val, $element, options) {
        if (options.readonly) {
            options.formValue = val;
            $element.find('[xtype]').each(function() {
                var name = $(this).data('name');
                var _this = $(this);
                var nameDisplay = null;
                if (val[name] !== undefined && val[name] !== null) {
                    switch ($(this).attr('xtype')) {
                        case 'multi-select':
                        case 'select':
                            if (val[name + '_DISPLAY']) {
                                setItemVal(val[name + '_DISPLAY'], val[name]);
                            } else {
                                WIS_EMAP_SERV._getInputOptions(_this.data("url"), function(res) {
                                    _this.data('model', res);
                                    var valueArr = val[name].split(',');
                                    var nameArr = [];
                                    $(res).each(function() {
                                        if ($.inArray(this.id, valueArr) > -1) {
                                            nameArr.push(this.name);
                                        }
                                    });
                                    setItemVal(nameArr.join(','), val[name]);
                                });
                            }
                            break;
                        case 'multi-select2':

                            break;
                        case 'radiolist':
                            if (val[name + '_DISPLAY']) {
                                setItemVal(val[name + '_DISPLAY'], val[name]);
                            } else {
                                WIS_EMAP_SERV._getInputOptions(_this.data("url"), function(res) {
                                    _this.data('model', res);
                                    $(res).each(function() {
                                        if (this.id == val[name]) {
                                            nameDisplay = this.name;
                                            return false;
                                        }
                                    });
                                });
                            }
                            break;

                        case 'checkboxlist':
                            if (val[name + '_DISPLAY']) {
                                setItemVal(val[name + '_DISPLAY'], val[name]);
                            } else {
                                WIS_EMAP_SERV._getInputOptions(_this.data("url"), function(res) {
                                    _this.data('model', res);
                                    var valueArr = val[name].split(',');
                                    var nameArr = [];
                                    $(res).each(function() {
                                        if ($.inArray(this.id, valueArr) > -1) {
                                            nameArr.push(this.name);
                                        }
                                    });
                                    setItemVal(nameArr.join(','), val[name]);
                                });
                            }

                            break;
                        case 'tree':
                            if (val[name + '_DISPLAY']) {
                                setItemVal(val[name + '_DISPLAY'], val[name]);
                            } else {
                                WIS_EMAP_SERV._getInputOptions(_this.data("url"), function(res) {
                                    _this.data('model', res);
                                    var valueArr = val[name].split(',');
                                    var nameArr = [];
                                    $(res).each(function() {
                                        if ($.inArray(this.id, valueArr) > -1) {
                                            nameArr.push(this.name);
                                        }
                                    });
                                    setItemVal(nameArr.join(','), val[name]);
                                });
                            }
                            break;
                        case 'uploadfile':
                            $(this).emapFileDownload($.extend({}, {
                                contextPath: options.root,
                                token: val[name]
                            }, JSON.parse(decodeURI($(this).data('jsonparam')))));
                            break;
                        case 'uploadsingleimage':
                        case 'uploadmuiltimage':
                            $(this).emapFileDownload($.extend({}, {
                                model: 'image',
                                contextPath: options.root,
                                token: val[name]
                            }, JSON.parse(decodeURI($(this).data('jsonparam')))));
                            break;
                        case 'uploadphoto':
                            $(this).emapFilePhoto('destroy');
                            $(this).emapFilePhoto($.extend({}, {
                                token: val[name],
                                contextPath: options.root
                            }, JSON.parse(decodeURI($(this).data('jsonparam')))));
                            $('a', this).hide();
                            break;
                        case 'switcher':
                            if (WIS_I18N.i18n.locale === 'zh') {
                                val[name + 'DISPLAY'] = parseInt(val[name]) ? '是' : '否';
                            } else {
                                val[name + 'DISPLAY'] = parseInt(val[name]) ? 'YES' : 'NO';
                            }
                            setItemVal(val[name + 'DISPLAY'], val[name]);
                            break;
                        default:
                            setItemVal(val[name]);
                    }
                }

                function setItemVal(val_dis, val) {
                    if (val_dis != null) {
                        _this.text(val_dis).attr('title', val_dis).data('value', val);
                    }
                }
            });
        } else {
            $element.find('[xtype]').each(function() {
                var name = $(this).data('name');
                var _this = $(this);
                var xtype = _this.attr('xtype');
                //qiyu 2016-1-2 清空表单时，传入字段值为空，需要重置该控件
                //qiyu 2016-3-17 清空表单请使用clear方法，以下这句话将被注释掉
                //if (val[name] == null) {val[name] = ""}

                // 为表格表单中的 只读字段赋值
                if (options.model == 't' && _this.hasClass('bh-form-static')) {
                    if (val[name] != null) {
                        if (val[name + '_DISPLAY'] !== undefined && val[name + '_DISPLAY'] !== null) {
                            _this.text(val[name + '_DISPLAY']).attr('title', val[name + '_DISPLAY']).data('value', val[name]);
                        } else {
                            _this.text(val[name]).attr('title', val[name]);
                        }
                    }
                }

                if (val === undefined) {

                } else if (val[name] !== undefined && val[name] !== null) {
                    WIS_EMAP_INPUT.setValue(_this, name, xtype, val, options.root);
                }
            });
        }
    };

    // 根据不同的文件后缀名获取不同的icon图标
    WIS_EMAP_SERV._getIconImgClass = function(fileName) {
        var iconImgClass = '';
        var suffixName = fileName.split('.').pop();
        switch (suffixName) {
            case 'docx':
                iconImgClass = 'icon-wenjiangeshidoc';
                break;
            case 'doc':
                iconImgClass = 'icon-wenjiangeshidoc';
                break;
            case 'pdf':
                iconImgClass = 'icon-wenjiangeshipdf';
                break;
            case 'rar':
                iconImgClass = 'icon-wenjiangeshirar';
                break;
            case 'txt':
                iconImgClass = 'icon-wenjiangeshitxt';
                break;
            case 'xls':
                iconImgClass = 'icon-wenjiangeshixls';
                break;
            case 'xlsx':
                iconImgClass = 'icon-wenjiangeshixls';
                break;
            case 'zip':
                iconImgClass = 'icon-wenjiangeshizip';
                break;
            default:
                iconImgClass = 'icon-wenjian';
        }
        return iconImgClass;
    };

    /**
     * @method _resetPageFooter
     * @description 重置页脚定位
     * @example
     * WIS_EMAP_SERV._resetPageFooter();
     */
    WIS_EMAP_SERV._resetPageFooter = function() {
        if ($.bhPaperPileDialog && $('[bh-paper-pile-dialog-role="bhPaperPileDialog"]').length) {
            $.bhPaperPileDialog.resetPageFooter(); //改变页面的页脚位置
            $.bhPaperPileDialog.resetDialogFooter(); //改变弹框的页脚位置
        }
    };

    /**
     * @method toDateStp
     * @description 日期格式转化成时间戳
     * @example
     * WIS_EMAP_SERV.toDateStp('2017-01-22');
     * // 返回 1485072901
     */
    WIS_EMAP_SERV.toDateStp = function(str) {
        if (!str) return false;
        var date = new Date();
        var arr = str.toString().split(' ');
        var dateArr = arr[0].split('-').map(function(t) {
            return t * 1;
        });
        date.setFullYear(dateArr[0]);
        date.setMonth(0);
        dateArr[2] ? date.setDate(dateArr[2]) : date.setDate(0);
        date.setMonth(dateArr[1] - 1);
        date.setMilliseconds(0);
        if (arr.length > 1) {
            var timeArr = arr[1].split(':').map(function(t) {
                return t * 1;
            });
            timeArr[0] ? date.setHours(timeArr[0]) : date.setHours(0);
            timeArr[1] ? date.setMinutes(timeArr[1]) : date.setMinutes(0);
            timeArr[2] ? date.setSeconds(timeArr[2]) : date.setSeconds(0);
        }
        return parseInt(date.getTime() / 1000);
    };

    /**
     * sonar扫描此处报错，不知道是谁加的，先注释掉了，
     * 全局对象应该是WIS_EMAP_CONFIG, 而不是WIS_CONFIG, 如果要还原此处的话， 请把全局对象名一起改掉
     */
    // if (window.WIS_CONFIG != undefined && (WIS_CONFIG.ROOT_PATH === undefined || WIS_CONFIG.ROOT_PATH == ""))
    //     WIS_CONFIG.ROOT_PATH = WIS_EMAP_SERV.getAppPath();

    /***
     *  以下为兼容性接口  准备废弃
     */

    WIS_EMAP_SERV._getAttr = function(item) {
        WIS_EMAP_SERV.getAttr(item);
    };

    // 表单控件赋值
    WIS_EMAP_SERV._setEditControlValue = function(_this, name, xtype, val, root) {
        WIS_EMAP_INPUT.setValue(_this, name, xtype, val, root);
    };

    // 获取表单选项数据
    WIS_EMAP_SERV._getInputOptions = function(url, callback) {
        WIS_EMAP_INPUT.getInputOptions(url, callback);
    };

    // 函数去抖
    WIS_EMAP_SERV.debounce = function(action, duration) {
        if ($.isFunction(action)) {
            var timer = null;
            return function() {
                var ctx = this;
                var args = arguments;
                clearTimeout(timer);
                timer = setTimeout(function() {
                    action.apply(ctx, args);
                }, duration);
            };
        }
        return action;
    };

    //获取index
    WIS_EMAP_SERV.indexOf = function(arr, cb) {
        var alength = arr.length;
        for (var i = 0; i < alength; i++) {
            var o = cb(arr[i], i);
            if (o === true) {
                return i;
            }
        }
        return -1;
    };

    //去掉数组中非真的项
    WIS_EMAP_SERV.compact = function(arr) {
        for (var i = 0; i < arr.length; i++) {
            if (!arr[i]) {
                arr.splice(i, 1);
                i--;
            }
        }
        return arr;
    };

})(window.WIS_EMAP_SERV = window.WIS_EMAP_SERV || {});

//下载
(function () {
    var Plugin, _init;
    /**
     * @module emapFileDownload
     * @alias 文件下载
     * @description 预览下载组件，用于浏览已上传的数据，不可编辑
     */
    Plugin = (function () {
        function Plugin(element, options) {
            if (options.mode) {
                options.model = options.mode;
            }
            this.options = $.extend({}, $.fn.emapFileDownload.defaults, options);
            this.$element = $(element);
            _init(this.$element, this.options);
        }

        /**
         * @method destroy
         * @description 销毁实例
         */
        Plugin.prototype.destroy = function () {
            this.$element.html('').removeClass('bh-clearfix').off('click');
            this.options = null;
            this.$element.data('emapfiledownload', false).empty();
        };

        /**
         * @method reload
         * @description 重新渲染 组件内的文件数据
         */
        Plugin.prototype.reload = function () {
            this.$element.html('');
            _initDownload(this.$element, this.options);
        };

        /**
         * @method getValue
         * @description 获取组件当前的token
         */
        Plugin.prototype.getValue = function () {
            return this.options.token;
        };

        return Plugin;
    })();

    _init = function (element, options) {
        options.contextPath = options.contextPath || WIS_EMAP_SERV.getContextPath();
        _initDownload(element, options);

        // 文件模式下 点击文件名 预览图片或者 下载文件
        $(element).on('click', '.bh-file-upload-filename, .bh-file-upload-file-icon', function () {
            var block = $(this).closest('.bh-file-upload-file');
            var fileName = $('.bh-file-upload-filename', block).attr('title');
            var fileUrl = $('.bh-file-upload-download', block).attr('href');

            if (new RegExp(/\.jpg|\.png|\.jpeg/g).test(fileName.toLowerCase())) {
                // 预览图片
                if (!$.bhGallery) {
                    console && console.warn('图片轮播插件Gallery未引入');
                    return;
                }
                var imgUrlArr = [];
                var imgSource = [];
                var show = 0;
                $(element).find('.bh-file-upload-file').each(function () {
                    var name = $('.bh-file-upload-filename', $(this)).attr('title');
                    if (new RegExp(/\.jpg|\.png|\.jpeg/g).test(name.toLowerCase())) {
                        var Url = $('.bh-file-upload-download', $(this)).attr('href')
                        imgUrlArr.push(Url)
                    }
                });

                $(imgUrlArr).each(function (i) {
                    if (fileUrl == this) {
                        show = i;
                    }
                    imgSource.push({
                        image: this
                    })
                });

                $.bhGallery({
                    dataSource: imgSource,
                    show: show
                });

            } else {
                // pdf
                if (/\.pdf$/g.test(fileName.toLowerCase())) {
                    block.trigger('bh.file.click.pdf', [fileName, fileUrl]);
                    if (options.canPreviewPDF) {
                        $.emapPDFViewer({
                            url: fileUrl
                        })
                    }
                    return;
                }
                // 下载文件
                location.href = $('.bh-file-upload-download', block).attr('href');
            }
        });

        // 图片模式下
        $(element).on('click', '.bh-file-img-table img', function () {
            if (!$.bhGallery) {
                console && console.warn('图片轮播插件Gallery未引入');
                return;
            }
            var curUrl = $(this).attr('src');
            var imgs = $(element).find('.bh-file-img-table img');
            var imgSource = [];
            var show = 0;
            if (imgs.length > 0) {
                imgs.each(function (i) {
                    if (!new RegExp(/\.jpg|\.png|\.jpeg/g).test($(this).attr('alt').toLowerCase())) {
                        return true;
                    }

                    if (curUrl == $(this).attr('src')) {
                        show = i;
                    }
                    imgSource.push({
                        image: $(this).attr('src')
                    })
                });

                $.bhGallery({
                    dataSource: imgSource,
                    show: show
                });
            }

        });

        // 点击批量下载
        $(element).on('click', '.bh-file-batch-download', function () {
            window.location.href = options.contextPath + '/sys/emapcomponent/file/getFileBatchByToken/' + options.token + '.do';
        })

    };

    function _initDownload(element, options) {
        $(element).addClass('bh-clearfix').css({
            'overflow': 'visible',
            'clear': 'none'
        });
        if (options.token === undefined || options.token === null) {
            $(element).append($.i18n('bh-fd-none'));
            return;
        }

        if (options.token instanceof Array) {
            options.batchTokens = true;
            options.token.map(function (token) {
                getTokenData(element, token, options);
            })
        } else {
            options.batchTokens = false;
            getTokenData(element, options.token, options);
        }
    }

    function getTokenData(element, token, options) {
        $.ajax({
            type: "post",
            url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + token + '.do',
            dataType: "json",
            success: function (res) {
                if (res.success) {
                    renderDownload(element, res.items, options);
                }
            }
        });
    }

    function renderDownload(element, items, options) {
        var fileHtml = '';
        if (!items || items.length == 0) {
            if (options.batchTokens) {
                if ($.trim($(element).html()) == "") {
                    fileHtml += $.i18n('bh-fd-none');
                } else {
                    return;
                }
            } else {
                fileHtml += $.i18n('bh-fd-none');
            }
            $(element).html(fileHtml).trigger('bh.file.download.done', [items]);
            return;
        }
        if (options.model == 'file') {
            if ($(element).html() == $.i18n('bh-fd-none')) {
                $(element).html('');
            }
            fileHtml += renderFile(items);
            $(element).append(fileHtml);
        } else if (options.model == 'image') {

            fileHtml += renderImage(items, options);
            $(element).css('overflow', 'hidden').append(fileHtml);
        }
        $(element).trigger('bh.file.download.done', [items]);

        if (options.batchDownload) {
            $(element).append('<p style="clear: both;"><a class="bh-file-batch-download" href="javascript:void(0)">' + $.i18n('bh-fd-batchDownload') + '</a></p>');
        }
    }

    function renderFile(items) {
        var renderHtml = '';
        $(items).each(function () {
            renderHtml += '<div class="bh-pull-left bh-file-upload-file" data-fileId="' + this.id + '" data-fileurl="' + this.fileUrl + '">' +
                '<div class="bh-file-upload-file-icon bh-pull-left"><i class="iconfont ' + WIS_EMAP_SERV._getIconImgClass(this.name) + '"></i></div>' +
                '<div class="bh-file-upload-file-info bh-pull-left">' +
                '<span class="bh-file-upload-filename"  title="' + this.name + '" style="cursor: pointer;">' + this.name + '</span>' +
                '<p><a class="bh-file-upload-download" target="_blank" href="' + this.fileUrl + '">' + $.i18n('bh-fd-download') + '</a></p>' +
                '</div>' +
                '</div>';
        });
        return renderHtml;
    }

    function renderImage(items, options) {
        var imgWidth = parseInt(options.width) - 6;
        var imgHeight = parseInt(options.height) - 6;
        var renderHtml = '';
        $(items).each(function () {
            renderHtml += '<div data-fileid="' + this.id + '" data-name="' + this.name + '" class="bh-file-img-block success" style="width: ' + options.width + 'px;height: ' + options.height + 'px;">' +
                '<div class="bh-file-img-table" style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                '<span style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                '<img style="max-width: ' + imgWidth + 'px;max-height: ' + imgHeight + 'px;" src="' + this.fileUrl + '" alt="' + this.name + '" />' +
                '</span>' +
                '</div>' +
                '</div>';
        });
        return renderHtml;
    }

    $.fn.emapFileDownload = function (options) {
        var instance;
        instance = this.data('emapfiledownload');
        if (!instance) {
            return this.each(function () {
                if (options == 'destroy') {
                    return $(this);
                }
                return $(this).data('emapfiledownload', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options]();
        return this;
    };

    /**
     * @memberof module:emapFileDownload
     * @prop {String|Array} token - 文件token(可以为多token)
     * @prop {String} [model=file] - 展示模式可选值 'file' 文件模式  'image' 图片模式（文件必须全部为图片类型）
     * @prop {Boolean} [canPreviewPDF=true] - 是否可预览pdf文件
     * @prop {Boolean} [batchDownload=false] - 是否显示批量下载按钮
     * @prop {Int} [width=200] - 图片模式下，文件容器的宽度
     * @prop {Int} [height=150] - 图片模式下，文件容器的高度
     * @prop {String} [contextPath] - 根路径
     */
    $.fn.emapFileDownload.defaults = {
        model: 'file',
        canPreviewPDF: true,
        batchDownload: false,
        width: 200,
        height: 150,
        contextPath: undefined
    };
}).call(this);
/****************************
 *
 *
 * 废弃
 *
 *
 *
 ****************************/


//上传头像
(function () {
    var Plugin, _init, defaultPhoto;
    var _imgLoad;
    var fileReader = 'FileReader' in window;
    defaultPhoto = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAABYCAMAAABGS8AGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAMAUExURQAAACagliejmSWnmyeimCqkmSilnECmiCmlmSikmiilmyinnCeimCekmieilyimmiagliiimCimmyikmiikmiikmieglielnCimnCilmyehlyekmSijmSalnCimmyikmyilmiaglvanL9ymUCeglt2pWuejQOqXMvaRItytXuOoTO+lO96pVnmmcPaVKPOcK+6pOd6hSeaeSO6oPYmqd2qgdu6rQd+rTtyeRuaZOueVMeesRieglimmnEgrG/aOH/qiHOrAp/LXvOvIrezBqPbZviWnnj8hEkkmFkgrHP2hFujLseK5oCapnx6mov+NGEgoGCWlm/qjHCaupUcqGkoiEf+hGR+kmyqmnPHXvRuhnfeOHv+iEiesoh6flUksHPbKtPmeHUsgD/HUue/Fq+nIrUBIOiehlym2SUYvIPTZvvrfw0ojEzCEeOnAp//bv/rDqTweD0YoGPmNG/LIr/WOH/yNGzB/cxqimhielfLWu/vMryKgmOq/puK/pyajmkynmS+hlem9oiqUif359P///+/KsTO0RkU2JySflfTCqCaxqC2Og0M7LKiDbVCwo/zZvkElFTCJfT2nmNK8o/uiGle0Sz21SDR0aCqbkZx9aGWqm49xXTGonb65pDN5bezEq+vWuyOmnv/ny3q1pfWlJs2VM/qNHeqkIdbDlimjmreaTWugdf+QGzpfUnZXRFehg2BCMPORJeTSuGxOPPXj0bepWfv18HqyoImzoJ26cEm0Qx22RsOnKManSlU3JjtaTNLQt6rFsJ+0ocLMtd61nLqXgOzPtVo8K8Kiij+ija6aUzxWSF+pit3Dp+rEqOmSJ/mOHYmnOGu1XnutOzdqXf+lIdGnP2ipgpepaummMFCqkZbBrveUJ4Cda7ONd2a2psGbhFmypGK1pfTax//9/NuUKUSqdpyiOuPDm4S3YGquP72bLLO/gn+baf6mKYVqVWxhUfLo2nNuXIyuRqaqL+bHoV6sX/qeHUo8LW+qis3LsIiob0QlFfieIdrSudHUgI4AAAA8dFJOUwDtjRAiCvsDGoPPFpni2DzeT+t5a6PGuvavuFYwyEVgc/zoIfczmdfsVYN3FPzn7NtfCsN1f+K4yIiAzsFKH5gAAAhNSURBVFjDpdn3XxPZGgfgkAAhVGmiItLsuvX2ezOTEDGF3RQkCSXEZCkhkICGEhAXkKIgAhqpIiqKiuva69pXd63rqqvu3bu93O3l9vbjnZn0nDMzwf3+AU/ez3vec2ZyhsGgS1BYVDInPiE0IiYmICAgInIWMyUxkMVm/KywQ6JSZkYEI3ikWq1Q2MIlEjCdEx0Y9MRs2BxmqB1FEGGOtH1rZU+ZtMxOc8umhSeGPBEbGJcwA3FGmtNzt7e8vPfuVmfReKZzZk+d5YQi7ki1u8qLVGKxuah8JLvMLXMjmVOjg1IiEc9oK1GVUoKiEqVKUu8lc6dxptCQOUnBXq70oKEIY/FIigzbWrheiUz2d82YMxDvaLeiCtQRhbIy2xvmpsYH+uNGJSG+0Y6oUFdUI0KubyKjaeeanRwDuptGnJ3AezGSkw3Ic2NppjqIE+zLSjcdrDSI3bDYUL9R2gLQ4WFULiseKDdHW29AxahHxKihPhtsxyyKRofNBN1tr0tUXi4mm9G77VJAnk4qsyDu1l5f1k73VgrL/JWDwD5oK7vMShQWc7nPRiG6Ae0zmwNxy8UoScTl9WCfw2GzEZcH9KGni9TF5K4eUI6F7AtgfrUHDWYJOSwxGzYCUzc3GhgIcL9tetesQCmiEL8rBdo8zXcBmeBAtFM1grQZ8T7n2Qxgw+UcIRkId8nmI+DMpXqddUFJkJ3Ra4Z71a7fM/e2Qw4kz/M5Nhjs8C4FvBNKnc4pixW7wA3IZbrdkEjAlUqPqOAFi8aO2py/oXq9BTyOprmfVpw8cG+UGYpgs6azHG/71AlLVIZt4BHKDXcVHIqAcHsXbIh1IuUN/fXjNp1jlGFz4S45DuwwdvrAdrNOZOurLakdtbj2dSUE5nIceyMBgcCVqOfu0OkkqA6ttqCYm1Fy/ZbIXrJCUQ+Dp4eQzDABK1ywstomIoKe+hxzMzJr+0TVjs0HhVMTiVONiVDCSpvtytGx0bG/jY3eaKrNzMBS0nbUoqSo2H7KwZYOf+Lbe6xTiq6M3hOYTKblpsYmgsVSe/uKhaLH9hNjTjAUbndsPMvxgQlThaBRIKh44UUnnKn/VCnCt15XTzYM5mKHHDsFgcJc+xyLbg1M4KrAC24a14/aRDqSOcbngs0ImgmFpdojRVgbq219ExX5Al84o6mktk9nge88Yi5YjJAIKIydFSJLNWq7dW+iWADCuPz5KYsIdlYQb+aBjKhgOKxt/2ffcZvoVKOpEQZnVI3XXu/7ezu8E1xuIiMZ7iINf949cVtnOSow5UNhbAVLVjdvX0MCpzA4cDd3x5urKkw3lFjFZDCW1TtbV8JhJiOeBP5i95Z8gen22E0KuKq7eR0JPIuRQAJ/tmU5hpnynUsHrTizezsJHMkIpYQFywU0MEmTIxgk05a7GW+FV6bUigBGDPni0cPki0cKIw2f5a+qoIYzu6tIx40czs7de3U3JVzVPLB95cYpw5i8Y/PV5eRw987+VlIXgyMQ0mQ3fOTZZ58t3X1uzUoulxwOJYfzsjfnV+TD4arM5nUbyV1s3BIQimRfc5Xc2Cg42dzU1OQaiDeoXGyDhFPB7mmuwHKyeXx8nHaCnVuaQ1lx7kf2mSs+3dHRcRZLR34bMWmrz1G62CGUjFCWjO0TAv6yYz2RszfbqI81R+JID3rnPtl8cpWj5K/Wr//qbHEb3uXVA+vWULrY0zQsAqGWvzhJdKO44vQ/Tn853kb0gdbFHk0kD1PPmq+uwvdJY/ELL7bZ3Z10Lv4wJXn8u4cZaei/Rixgxc1mYo4z3+inc/HHPyNqBk3JSG7etS1En50DvJLOxV9YGCFJdDDSsHdtsRO+v/Y12nodf8o4tHDu3rWlN4tx+H5p6drX6AsOZ5O+xgJwaemyDePjpX7BqdFktwk+y1dAwI740QrHizf0r4Kb3SMT5p3zhM+1thS8TAnHUvy5cbJCmaz/m0f3Nrjh2oH/fnOngIp2/5+ODSZrgkz29pl/DQ/9xwPe8MqFC9++dayggOIAcv31JykZZw8UXurs/EnvhvXnjcNfyx9gdANdwfAuY8398Mw+tVp9YMj4qMRVsv67IeMPGqtVfuKtO9B+pHI8/6RDniOyHe/vK1QP8vnqfxs7z+s3LMPZZfqS743DP8rreJpJ+YNPDkL6Ecryul8BZlnWf7kwi49HzX+Myff1RL77vtP40Krh4bEefrW1gO6OhQO47xUO8u1RH/jBaHz00ytYzg9dND6um+TZ844clMN979y8Twyh7H1HvXb5YedF4/DQ0PDFi8Pf8uQOl1dnlX9SQHFbQWS214G/J+9yId8d9eClxxc6jcbOCw/3y608V+rkr5Z5LWDAHPAaK9GzzbIPP/CE+Wo1/8ClSz/ufzApn6zzhPe3vuz9qINc6MV6wn/6Yxaf702r1Yfl1kmeV6wfH/PsBRN6jcz2eMWQPeVaOldW/E+j4flEc/iQBzyTRXu5KT1TyAfgl3hANPK/5LpfUkg/AwQ5axYil/2D8dWjdzHZccUgzHvPX3i/cyziKa+82bHEbOxZ94HfMNcOM1k0t/+J+DzL3v5rlp/w13dwOCCO/nPZ7ARi2gb9gnk1Hx/DTs/QKH8+hLA4MbJDar5/MD5vc8P9/SoUlQAZYzjMkx9Kip7CB8Jfpq3IyqKHNTW8p3/FmtL3sXnzn/WlARhjF8yfN+UvevMW/2JflqftDdfU1JxYsHjqLJ70RfOfxe3BQR9Yo6mxnlgw/7n0J/5q+nz6osV/SNu3YrAQ0+1wTc07dScWLvjdovTnf+aH3qVLFy1Z8ptfp6WlPbNw4cKnn/nt75c8l76Udj/8H1/k4P/j+w/zAAAAAElFTkSuQmCC';
    Plugin = (function () {
        function Plugin(element, options) {
            this.settings = $.extend({}, $.fn.emapFilePhoto.defaults, options);
            this.$element = $(element);
            _init(this.$element, this.settings);
        }

        return Plugin;
    })();

    _init = function (element, options) {

        if (options.token && options.token != "" && options.token != null) {
            options.defaultPhoto = options.contextPath + '/sys/emapcomponent/file/getFileByToken/' + options.token + '.do?date=' + new Date().getTime();
            options.scope = options.token.substring(0, options.token.length - 1);
            options.newToken = false;
        } else {
            options.scope = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
            options.token = options.scope + 1;
            options.newToken = true;
        }
        options.uploadUrl = options.contextPath + '/sys/emapcomponent/file/uploadTempFile/' + options.scope + '/' + options.token + '.do';


        $(element).addClass('bh-file-photo').append('<div class="bh-file-photo-block"></div>' +
            '<p class="bh-file-photo-info">' +
            '<span class="icon icon-spinner icon-pulse bh-file-photo-loading"></span>' +
            '<span class="bh-file-photo-error"></span>' +
            '<span class="bh-file-photo-success">' + $.i18n('bh-fp-uploadSuccess') + '</span>' +
            '</p>' +
            '<a class="bh-file-upload" href="javascript:void(0)"><input name="bhFile" type="file">' + $.i18n('bh-fp-upload') + '</a>');

        _imgLoad((options.defaultPhoto ? options.defaultPhoto : defaultPhoto), function (img) {
            var w = img.width, h = img.height;
            if (w > h) {
                $(img).css({
                    'position': 'absolute',
                    'height': '88px',
                    'top': 0,
                    'left': '50%',
                    'margin-left': '-' + w / 2 / h * 88 + 'px'
                });
            } else {
                $(img).css({
                    'position': 'absolute',
                    'width': '88px',
                    'left': 0,
                    'top': '50%',
                    'margin-top': '-' + h / 2 / w * 88 + 'px'
                });
            }

            $(element).find('.bh-file-photo-block').html(img);
        });

        $(element).find('input[type=file][name=bhFile]').fileupload({
            url: options.uploadUrl,
            autoUpload: true,
            dataType: 'json',
            formData: {storeId: 'image'},
            submit: function (e, data) {
                var file = data.files[0];

                $(element).addClass('loading');
                // 文件的大小 和类型校验
                if (options.type && options.type.length > 0) {
                    if (!new RegExp(options.type.join('|').toUpperCase()).test(file.name.toUpperCase())) {
                        $(element).removeClass('loading').addClass('error').find('.bh-file-photo-error').html($.i18n('bh-fp-typeError'));
                        return false;
                    }
                }

                if (fileReader && options.size) {
                    if (file.size / 1024 > options.size) {
                        $(element).removeClass('loading').addClass('error').find('.bh-file-photo-error').html($.i18n('bh-fp-sizeOverflow'));
                        return false;
                    }
                }

                if (options.submit) {
                    options.submit(e, data);
                }
            },
            done: function (e, data) {
                if (data.result.success) {



                    // 上传成功
                    $(element).removeClass('loading').addClass('success')
                    //.find('.bh-file-photo-block img').attr('src', data.result.tempFileUrl);
                    options.tempUrl = data.result.tempFileUrl;
                    options.fileUrl = data.result.fileUrl;

                    _imgLoad(data.result.tempFileUrl, function (img) {
                        var w = img.width, h = img.height;
                        if (w > h) {
                            $(img).css({
                                'position': 'absolute',
                                'height': '88px',
                                'top': 0,
                                'left': '50%',
                                'margin-left': '-' + w / 2 / h * 88 + 'px'
                            });
                        } else {
                            $(img).css({
                                'position': 'absolute',
                                'width': '88px',
                                'left': 0,
                                'top': '50%',
                                'margin-top': '-' + h / 2 / w * 88 + 'px'
                            });
                        }

                        $(element).find('.bh-file-photo-block').html(img);
                        if (options.done) {
                            options.done(e, data);
                        }
                    })

                } else {
                    // 上传失败
                    $(element).removeClass('loading').addClass('error').find('.bh-file-photo-error').html((data.result.error ? data.result.error : '上传失败'));
                    if (options.fail) {
                        options.fail(e, data);
                    }
                }


            },
            fail: function (e, data) {
                $(element).removeClass('loading').addClass('error').find('.bh-file-photo-error').html($.i18n('bh-fp-uploadFail'));
                if (options.fail) {
                    options.fail(e, data);
                }
            }
        });

        options.attachmentParams = {
            storeId: "image",
            scope: options.scope,
            fileToken: options.token
        };
    };

    _imgLoad = function (url, cb) {
        var img = new Image();
        img.src = url;
        if (img.conplete) {
            cb(img.width, img.height);
        } else {
            img.onload = function () {
                cb(img);
                img.onload = null;
            }
        }
    };
    // 公共方法

    // 保存临时文件
    Plugin.prototype.saveTempFile = function () {
        var resultFlag = false, self = this;
        if (!this.settings.tempUrl || this.settings.tempUrl.length < 1) {
            return resultFlag;
        }
        $.ajax({
            type: "post",
            url: this.settings.contextPath + '/sys/emapcomponent/file/deleteFileByToken/' + this.settings.token + '.do',
            async: false,
            dataType: "json",
            success: function (data) {
            }
        });
        $.ajax({
            type: "post",
            async: false,
            url: this.settings.contextPath
            + "/sys/emapcomponent/file/saveAttachment/"
            + this.settings.scope + "/" + this.settings.token + ".do",
            data: {
                attachmentParam: JSON.stringify(this.settings.attachmentParams)
            },
            dataType: "json",
            success: function (data) {
                self.settings.tempFileSaved = true;
                resultFlag = data;
            }
        });
        return resultFlag;
    };
    // 获取文件地址
    Plugin.prototype.getFileToken = function () {
        if (this.settings.newToken && (!this.settings.tempUrl || this.settings.tempUrl.length == 0)) {
            return null;
        } else {
            return this.settings.token;
        }
    };

    // 销毁实例
    Plugin.prototype.destroy = function () {
        this.settings = null;
        $(this.$element).data('plugin', false).removeClass('success error loading').empty().attr('class', 'bh-file-photo');
    };


    // 插件
    $.fn.emapFilePhoto = function (options) {
        var instance;
        instance = this.data('plugin');

        if (!instance) {
            return this.each(function () {
                if (options == 'destroy') {
                    return this;
                }
                return $(this).data('plugin', new Plugin(this, options));
            });
        }

        if (options === true) return instance;

        if ($.type(options) === 'string') return instance[options]();
        return this;

    };

    $.fn.emapFilePhoto.defaults = {
        storeId: 'image',
        type: ['jpg', 'png', 'bmp'],
        size: 2048
    };

}).call(this);
(function() {
    var EmapFileUpload, _eventBind;
    var fileReader = 'FileReader' in window;
    var _init, _getLimitInfo;
    /**
     * @module emapFileUpload
     * @alias 文件上传
     * @description 文件上传组件
     */
    EmapFileUpload = (function() {
        function EmapFileUpload(element, options) {
            this.options = $.extend({}, $.fn.emapFileUpload.defaults, options);
            this.$element = $(element);

            if (this.options.token && this.options.token != '') {
                this.options.newToken = options.newToken = false;
            } else {
                this.options.newToken = options.newToken = true;
            }

            _init(this.$element, this.options);
            _eventBind(this.$element, this.options);
        }

        /**
         * @method getFileToken
         * @description 获取token
         * @return {String} token,若无上传文件返回""
         */
        EmapFileUpload.prototype.getFileToken = function() {
            if (this.$element.emapFileUpload('getFileNum') == 0) {
                return "";
            }
            return this.options.fileInput.emapUploadCore('getFileToken');
        };

        /**
         * @method getFileUrl
         * @description 返回token下已有的正式文件的url数组
         * @return {Array} url数组
         */
        EmapFileUpload.prototype.getFileUrl = function() {
            return this.options.fileInput.emapUploadCore('getFileUrl');
        };

        /**
         * @method getFileData
         * @description 返回token下已有的正式文件的信息
         * @return {Array} 文件信息对象数组
         */
        EmapFileUpload.prototype.getFileData = function() {
            return this.options.fileInput.emapUploadCore('getFileData');
        };

        /**
         * @method saveTempFile
         * @param {Object} params - 保存请求附带参数
         * @description 保存token, 不建议使用, 用saveUpload方法替代
         */
        EmapFileUpload.prototype.saveTempFile = function(params) {
            // 先判断没有没正在上传的文件, 如果有弹出提示框
            var options = this.options;
            var result;
            var save_param = params || {};
            !save_param.attachmentParam && (save_param.attachmentParam = {});
            save_param.attachmentParam.orderMap = getOrderMap(options);
            result = saveAction(options, save_param);
            return result;

            function saveAction(options, params) {
                var result = options.fileInput.emapUploadCore('saveTempFile', params);
                // 将临时文件下载地址替换为正式文件下载地址
                $('.bh-file-upload-download', options.loadedCon).each(function() {
                    var href = $(this).attr('href');
                    if (new RegExp('getTempFile').test(href)) {
                        var fileBlock = $(this).closest('.bh-file-upload-file').data('save', true);
                        var fileId = fileBlock.data('fileid');
                        $(this).attr('href', options.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + fileId + '.do');
                    }
                });
                return result;
            }
        };

        /**
         * @method saveUpload
         * @description 该方法为异步的 保存方法, 会在 有文件正在上传时弹出确认框, 该方法返回一个defer对象
         * @param {Object} params - 保存请求附带参数
         * @return {Object} 异步方法的Defer对象，resolve带参格式 为
         * {
         *   success: true,
         *   token: "xxx",
         * }
         */
        EmapFileUpload.prototype.saveUpload = function(params) {
            var deferred = $.Deferred();
            // 先判断没有没正在上传的文件, 如果有弹出提示框
            var options = this.options;
            var save_param = params || {};
            !save_param.attachmentParam && (save_param.attachmentParam = {});
            save_param.attachmentParam.orderMap = getOrderMap(options);
            if ($('.bh-file-upload-file:not(.bh-error)', this.options.loadingCon).length > 0) {
                BH_UTILS.bhDialogWarning({
                    title: $.i18n('bh-fu-warning'),
                    content: $.i18n('bh-fu-warningContent'),
                    buttons: [{
                        text: $.i18n('bh-fu-conFirmUpload'),
                        className: 'bh-btn-warning',
                        callback: function() {
                            saveAction(options, deferred, save_param);
                        }
                    }, {
                        text: $.i18n('bh-fu-cancelUpload'),
                        className: 'bh-btn-default',
                        callback: function() {
                            deferred.reject();
                        }
                    }]
                })
            } else {
                saveAction(options, deferred, save_param);
            }
            return deferred;

            function saveAction(options, defer, params) {
                var resultObj = {};
                options.fileInput.emapUploadCore('saveUpload', params).done(function(res) {
                    resultObj.success = true;
                    resultObj.token = res.token;
                    defer.resolve(resultObj);
                    // 将临时文件下载地址替换为正式文件下载地址
                    $('.bh-file-upload-download', options.loadedCon).each(function() {
                        var href = $(this).attr('href');
                        if (new RegExp('getTempFile').test(href)) {
                            var fileBlock = $(this).closest('.bh-file-upload-file').data('save', true);
                            var fileId = fileBlock.data('fileid');
                            $(this).attr('href', options.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + fileId + '.do');
                        }
                    });
                }).fail(function(error) {
                    resultObj.success = false;
                    resultObj.msg = error.msg || $.i18n('bh-fu-saveFail');
                    defer.resolve(resultObj);
                });
            }
        };

        /**
         * @method getFileNum
         * @description 获取已上传的文件数量
         * @return {Int} 文件数量
         */
        EmapFileUpload.prototype.getFileNum = function() {
            return this.options.loadedCon.getFileNum();
        };

        /**
         * @method destroy
         * @description 销毁组件实例
         */
        EmapFileUpload.prototype.destroy = function() {
            this.options = null;
            $(this.$element).data('plugin', false).empty();
        };

        // 私有方法
        _init = function(element, options) {
            // contextPath 兼容
            if (!options.contextPath) {
                options.contextPath = WIS_EMAP_SERV.getContextPath();
            }

            // 未限制上传数量为1时,若传了fileName参数  则删除
            if (options.fileName && options.limit != 1) {
                delete options.fileName;
            }

            $(element).css('line-height', '28px').append('<a class="bh-file-upload" href="javascript:void(0)">' +
                '<input style="cursor: pointer;" name="bhFile" type="file" ' + (options.multiple ? 'multiple' : '') + ' />' + $.i18n('bh-fu-upload') +
                '</a>' +
                '<span class="bh-text-caption bh-color-caption bh-mh-8 bh-file-upload-info">(' + _getLimitInfo(options) + ')</span>' +
                '<div class="bh-file-upload-loading-wrap bh-clearfix"></div>' +
                '<div class="bh-file-upload-loaded-wrap bh-clearfix"></div>' +
                '<input type="hidden" class="file-array" value="" />');

            options.fileInput = $('input[type=file]', element).parent();
            options.loadingCon = $(element).find('.bh-file-upload-loading-wrap').bhFileUploadingList({
                onDelete: function(item) {
                    if (item.hasClass('bh-error')) {
                        // 删除上传失败的文件
                        item.remove();
                    } else {
                        // 删除正在上传的文件
                        item.data('xhr').abort();
                        item.remove();
                    }
                    element.trigger('bh.file.upload.done');
                }
            });
            options.loadedCon = $(element).find('.bh-file-upload-loaded-wrap').bhFileUploadedList({
                // 删除已上传文件
                onDelete: function(item) {
                    var fileBlock = $(item).closest('.bh-file-upload-file');

                    if (fileBlock.data('save')) {
                        // 删除正式文件
                        options.fileInput.emapUploadCore('deleteArrAdd', fileBlock.data('fileid'));
                        fileBlock.remove();
                        element.trigger('bh-file-upload-validate');
                    } else {
                        // 删除临时文件
                        options.fileInput.emapUploadCore('deleteTempFile', fileBlock.data('fileid'))
                            .done(function(res) {
                                if (res.success) {
                                    fileBlock.remove();
                                    element.trigger('bh-file-upload-validate');
                                }
                            });
                    }
                    element.trigger('bh.file.upload.delete', fileBlock);
                },
                canPreviewPDF: options.canPreviewPDF
            });


            options.fileInput.emapUploadCore($.extend({}, options, {
                add: function(e, data) {
                    var files = data.files;
                    var tmp = new Date().getTime();
                    $(files).each(function(i) {
                        data.files[i].bhId = tmp + i;
                        options.loadingCon.add(this.name, tmp + i);
                    });

                    if (options.add) {
                        options.add(e, data);
                    }
                },
                submit: function(e, data) {
                    var file = data.files[0];

                    // 文件数量限制的校验
                    if (options.limit) {
                        var currentCount = options.loadingCon.getFileNum() + options.loadedCon.getFileNum();
                        if (currentCount > options.limit) {
                            options.loadingCon.error($.i18n('bh-fu-numberError'), file.bhId);
                            WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                            return false;
                        }
                    }

                    // 文件的大小 和类型校验
                    if (options.type && options.type.length > 0) {
                        if (!new RegExp((options.type.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                            options.loadingCon.error($.i18n('bh-fu-typeError'), file.bhId);
                            WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                            return false;
                        }
                    }

                    if (fileReader && options.size) {
                        if (file.size / 1024 > options.size) {
                            options.loadingCon.error($.i18n('bh-fu-typeError'), file.bhId);
                            WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                            return false;
                        }
                    }

                    options.loadingCon._findFile(file.bhId).data('xhr', data);
                    if (options.submit) {
                        options.submit(e, data);
                    }
                },
                done: function(e, data) {
                    var file = data.files[0];
                    // 上传成功
                    options.loadingCon.remove(file.bhId);
                    if (options.storeId == 'image') {
                        options.loadedCon.addImage(data.result.name, file.bhId, data.result.id, data.result.tempFileUrl, function(item) {
                            item.data('deleteurl', data.result.deleteUrl);
                        });
                    } else {
                        options.loadedCon.add(data.result.name, file.bhId, data.result.id, data.result.tempFileUrl, function(item) {
                            item.data('deleteurl', data.result.deleteUrl);
                        });
                    }
                    if (options.done) {
                        options.done(e, data);
                    }

                    WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                },
                fail: function(e, data) {
                    // 上传失败
                    var file = data.files[0];
                    var errorMsg = '上传失败';
                    if (data.result && data.result.error) {
                        errorMsg = data.result.error;
                    }
                    options.loadingCon.error(errorMsg, file.bhId);
                    if (options.fail) {
                        options.fail(e, data)
                    }

                    WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                }
            }));

            // 获取token下已有的文件
            if (!options.newToken) {
                $.ajax({
                    type: "post",
                    url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                    dataType: "json",
                    success: function(res) {
                        if (res.success) {
                            if (!res.items || res.items.length == 0) return;
                            if (options.storeId == 'image') {
                                $(res.items).each(function() {
                                    options.loadedCon.addImage(this.name, '', this.id, this.fileUrl, function(item) {
                                        item.data('save', true);
                                    });
                                });
                            } else {
                                $(res.items).each(function() {
                                    options.loadedCon.add(this.name, '', this.id, this.fileUrl, function(item) {
                                        item.data('save', true);
                                    });
                                });
                            }
                            element.trigger('bh.file.upload.done', res);
                        }
                    }
                });
            }
        };

        function getOrderMap(options) {
            var list = $('.bh-file-upload-file', options.loadedCon);
            var orderMap = {};
            if (list.length) {
                list.each(function(index) {
                    orderMap[$(this).attr('data-fileid')] = index + 1;
                });
            }
            return orderMap;
        }


        // 生成描述信息
        _getLimitInfo = function(options) {
            var infoHtml = $.i18n('bh-fu-chooseAttachment');
            if (options.size) {
                infoHtml += ',' + $.i18n('bh-fu-maxSize') + (options.size < 1024 ? options.size + 'K' : options.size / 1024 + 'M');
            }
            if (options.type && options.type.length > 0) {
                infoHtml += ',' + $.i18n('bh-fu-typeLimit') + options.type.join(",").toUpperCase();
            }
            return infoHtml;
        };

        _eventBind = function(element, options) {};

        // 定义插件
        $.fn.emapFileUpload = function(options, params) {
            var instance;
            instance = this.data('plugin');

            // 判断是否已经实例化
            if (!instance) {
                return this.each(function() {
                    if (options == 'destroy') {
                        return this;
                    }
                    return $(this).data('plugin', new EmapFileUpload(this, options));
                });
            }
            if (options === true) {
                return instance;
            }
            if ($.type(options) === 'string') {
                return instance[options](params);
            }
        };

        /**
         * @memberof module:emapFileUpload
         * @prop {String} [contextPath] - 根路径
         * @prop {String} [token] - 文件token,不传则组件生成随机的新token， 传token则组件自动请求token下已有的文件信息并渲染到页面上
         * @prop {Boolean} [multiple=false] - 上传控件是否支持一次性选择多个
         * @prop {String} [storeId=file] - emap文件类型
         * @prop {Array} [type=[]] - 上传文件的格式要求
         * @prop {Int} [size=0] - 上传文件的大小要求，单位为KB
         * @prop {Int} [limit] - 上传文件的数量限制
         * @prop {Function} [add] - 添加文件的回调
         * @prop {Function} [submit] - 开始上传文件的回调
         * @prop {Function} [done] - 文件上传成功的回调
         * @prop {Function} [fail] - 文件上传失败的回调
         */
        $.fn.emapFileUpload.defaults = {
            multiple: false,
            storeId: 'file',
            type: [],
            size: 0,
            canPreviewPDF: true
        };


    })();

}).call(this);

// 上传中列表
$.fn.bhFileUploadingList = function(opt) {
    // 删除按钮的点击事件
    $(this).on("click", "a.bh-file-upload-delete", function() {
        if (opt.onDelete) {
            opt.onDelete($(this).closest('.bh-file-upload-file'));
        }
    });
    this.add = function(fileName, bhId, fileId) {
        $(this).append('<div class="bh-pull-left bh-file-upload-file" data-bhid="' + bhId + '" data-fileid="' + (fileId ? fileId : 0) + '">' +
            '<span class="bh-file-upload-filename" title="' + fileName + '">' + fileName + '</span>' +
            '<span class="bh-file-upload-error-msg"></span>' +
            '<i class="icon icon-spinner icon-pulse bh-file-uploading-icon">' +
            '<img style="vertical-align: top;width: 100%;" src="data:image/gif;base64,R0lGODlhIAAgAPYAAP///4qEhPz8/PHw8Ono6Orp6fb29v39/fr6+t7c3Lu3t6mkpK2pqcjFxevq6vn5+eTj46yoqIuFhZeSkvDv7/T09NLPz9XT0/j4+MnGxpWQkKKdnd7d3e/u7u3s7MG+vqWgoJyXl56ZmdbU1L+8vJCKipmUlNfV1bGtrfX19cfExJiTk4+JidjW1paRkeXk5JSOjo6IiJuWlsbDw+Lh4aahoZKMjL67u8zKysvJyZSPj8nHx93b25+bm9/e3s3Ly6ijo+zr69TS0uHg4Obl5efl5bOvr5qVlcrIyMPAwL66usTBwY2Hh+Df39nX18K/v87MzLm1tbq2ttza2u7t7bWystvZ2drY2MC9vejm5sXCwrKurqCcnOPi4vLx8fv7+/f39/Py8p2YmLazs7SxsfPz8725uQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4yNjQeGCCkCjoYpBDQFKYMCHDMElYQeKgw1DA1BkAg5QAmhghUfKxK0Jh8VBwcOPBWFFR0PiQIJILTGGwmQALmEKUtGTgiIDxYhxrUW0ocEGyUKBogIFyLXEiEnlIcVz9GIBwQMLNcMRMrqHsGJBiMLGjYuC4RgeFXoAAYPLVSQ2OEDHMFBCCBkIJGBwwAD6Rwx45QggoYSAF+8cmDBAoVBAxSUu5GvUYUnE0zscEhgQbkFvRxRMEJLQc4CDMoxyNkIA5QaC0YMBGCgwQRjLnBkbGSACBGHyxwo2GBiA4mTDwtS4HAigQOMYQ89eGEhBy97iZg2uoOAQsYEED82xSVigcZSdSRgGAMyJC6HGi42ZEPUAUUMYyFGKEOAQRtTEiVoRaGCqIKCzLRA+AAgoAiSJCdyYlABg0kJKUQLdtSgo8eMAbqMwCjRwwK4d0ZqGJkytdCDBDM+WOhwQJwMY0Y8CDrgoUkBy4gEVKiQD4GQI7RKRCcENxQB3bwt/E1LmsYMJSbZFxJggLujQAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEgwcVVFQpB4WNjo4PEEkoKEsvD4+ZjQI0RhoSEhpGEAKapgAVSxOgoBNJFaeFBg4EFQJBRkysoEZBsYIHDg0oDFhNREa7EiW9vwADJKsSOihOSdKgLq+CFRWMjwI8G7sTGTwoMKA2W0OlqUkDmQhCIcokFUVaDAwzBAjcUaI4yCTAyjhWK3JgQpAiBYJvAG4FKZWJgpJPEmAwgOBM3osnDCIoSIChYyMMBYYQCUKg1j+ThDA4MbIAhQVbMAsdGBKhBKgNJyDGQgDBAgGKD35gK0ECk7MORkIogAXgAY6lTTt6iCKDRDwAB5r0lMBiQwuhpxB0MUoRgAEnVZxq3syJFgDKIQQM5NQk4IAADA/q7nXLAQkUf6ceOOR7ZcGKI1GyCB6UwgKJESUfVVCQTsIRKE4dHbDSo0SNJhWjsJqAJHPEtmBHmJDAZUomDDhEMIGxIEGpAwWECCnQtoOSCEu+asYRRcoVvQA8SDGxIgoVQhVqmTqAgQJOsDx6gOrBY7LJISBAgRhivmOFHCFzUB2MvUiR+fQHBwIAIfkECQoAAAAsAAAAACAAIAAAB/+AAIKDhIUAB4aJiokHFUVdQQ+Lk4YHDksLNUYjFZSeABRPKxISJUAtkgcPGAieDwMFAwgCPkBMpBI6HwMYRBY4Jw4CixhOClsKPBUtXLilUQQnWyImGwovX4m0CyUlOgwJTRHOLk8XESW4LgpUiQYNOrgmOUEqR6QsEU4ZJs4SCxwQFUqRBAYuDRkMVLBghMGHLhWWxHO2ocWwQghOcIkhgQkIJ4gOKMQA4AGUe7hYAPFxsVAFFQt6RMgxQFEXFDbkfeigCEGFJi2GVBBoCMMVIz1CbLhBpJUhBBhCEu1ZwIkQHhSmCsJAQIiQAi09IZilrcmWEDKMQPhUSFW2QQa1VGggpUGLU7YAPEBxYmBQBRLpSim4y5YGil2DEFjg0m2DhbCfKnBoSqgCDiNGLNTEO+lACg8OOnEeTdoTBgNaSw86QADJEh+SKKUg4CU1oQ5RNMAACLnQgxw1lFCYBGEDKRNQYitKoQBGhCKTgmyBUeLj3QcUhg4ScEUKFNGKHjiJknkzAAwjoiQhQNQnSUoIKATpO8jBuCM53qsmVIBBiSM46LefIAZcoB57AxaCQXaEJUhaIAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhQcCB4WKi4yCBgRTTRSJjZWFDxdbG0BLBJSWlQdEDCUSEmIZFaCKCGAIgggtYqYSJVEOAhVFEEEPlgMtGRdBAghOIrS2BQQqDAtRLSmNFSobGj1JHQceYzC1GxYvWEemJRFTr4tFC7Q1CQAITQoLDBYePDW0EhpJqosvNZiY2mBF0IEKHSg8ENCihz5bHhhVUGCihIkoBBg1WVDKlIkZ/hQdeKHCyJImvhYN0NIjhgQYKDikW3TQQYWZigQ4yGGEgQIhQVLgXLUIQ5AuV3AsyXBlwCcwHQYMtXQAgoIeLkwAQeJvAI4tRloYIAqgAgkX+jZcACBgCoiXDLUyEiWQTx8MBfAshBjogywBhw/JADhAA8WEIwqCkA0SgYU+HUkEpeDRAAeRqY0e5GhpCgaDIYMQpDDwiaiHHQt6bIhyZSxZRge7OJlCAMNrUAdKK6pQIIxuRohAdViyQIEnS0GQJMA86MAVLqcspGyUYIEK17B9RNAB5MpMASlsEwJGRIClFC1ICAkp4EUDCyEFBQeFoMKDTwZUHInQ5fftQQ9YUANG/1VCAQcviFcgcP4tWGAgACH5BAkKAAAALAAAAAAgACAAAAf/gACCg4SFhoeIiQAYQURBD4qRhQ88UREKPBiSkgcFRjASMFFFB4OlmwgPpwc+GxKvQDwCAAgdRUGaiQcOFxZEkAcvESUSJQxdAgYJCgxRIxWJHVg9MlEQpRU/QGILFhUIQ1s6oQtWkIdDNa89FucVHBZN0Bg/Mq8SKzPQhgdEwxIbTpwTdAqAgRxH7rl4MgBRCgsoIjToULAQAh4LSjApAUJILn4ViNAYUNFQBQsMNkTYQVHRgZKHBFR4YYUHgQEYYG4CmWDHEgsEEBR6uXMQghYoTGgQoYDAqQdELFjZt7ODEWKvTGRIAWCXAjEgLgyUBKHHvWJGOnSFsECCCxVcyHcScXWvRBQqgjwkqcFgitCdA6KMeyUGSS4BHXy8MFCUVoIqXEKASFKg4AEBOhEdMBAEQgsoP1oEmdWYEAICOaKgUGDBQc7ShYJgEfEKxgIhcQ8d6PDCS2YEFjYwuSeKAGlDHT4sQEK1kAEtg++BsHK8EIEtExSoPZRiSfRXNaZUJ1Thwo1MhAS8Bs7lrA4jpBI9+Jb+BVBBQZ70sFFCQwTcpT0AkROlCFAADlEYocAJze0kgH0OmFKBAwVQ8FFpAqgC24YcdhgIACH5BAkKAAAALAAAAAAgACAAAAf/gACCg4SFhoeIiYIHD1+Kj4cYL0JTFAKQmAddRj1AOQOYkA9QJhIlW0QHgweqkAeXgw8WMqZGBKoHFC9EFa2IBl1XQbACRWYgDBYVAAcESgsRM0G+hQIJWyBJHoMIDlMQvQApSLQSG0IYiBgNExILPtSFFAolEhIrWsuHCC0RPQq3ElVoUIoFF2UCr1jo8kARAghSNtTAQgDWoQMIMFhM9IDAFR4OGobKxOrBg40jESEIcuXECwOEDmCogCAlAAEQonDpkQwmswpCZjQRGWrAk3amUEAQhGAIChkfQI0kgKKevR4nBhFQEAGKvlBBolhlAoIHtwJdpI5MIQSIDhgiyT50KBTP1QMPFqJE2VGkps1BAgb4GNGiCwECFVCmPBAkw4IeIG4wfFS3UAoLG+xJCJFkrkAeBPwCAFNg14AvBaLA0CwhwpDKN4cwyFCGGYUfDLiAUJCgSVXWC5rAZoxkCoYDFTBrnmDkwo0VmmFEIaDoQIqGOH9rlpGhRZUjOiZEuJAilAAeNVhLgIHFwZAdCpJM+QpJQJMITFjrmEGzQocK6aQUhBIuaBYDCC0Q9RcADzRhhAklwACCCp4tGMsLGUShxAUdKFZIIAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4wCFR0pB4yTggUZChYVlIwIFhsaKBCSm4mdIiULNKMAGBQUD4wYYbCDBElGUJqCFRZSCk4pigZXWjwYgwgUBRUCggddDDAuRkTNiARGRwpBig8jIRISNTwIiQMqEUgDis8MLiZRRauGAg4cQdaJBk4kT8aLBwTMS/SAwgBapBIq7DaAgoGBACBOqiAkSpQfHlY9cABB16YHToDAkLABioFBA3ZEaSIxUYUMLsKViEJlUIoTOwi0RGTgBzgJLpR4ZFWhHKkDL6L0EIGixTFDAXcaegDhRw4eQwUJoOBjxBUCJxcJEIAgRQWEg+qpWMBlQ5QrYdEPpSiSoGPLCkh6lAinwQiNfIQqjDBSg0GODhAP0EARrnGIHBUOgPFSFAACDhFGlthgIVghBFNqxGgsQQMWBzRUGMEUpAKUnxJ0KOkAdQgD0hJWLJlixESJElxUELHQo/GED7QNeXhigonMBRYyyCC9oAUHIy5KwAAyIi4hBEOicJkQIgKUISR0kBZhYcAUKSiMWKCQCMPwGTmmuJqxgvSGFghgQEAXBETGDgYVpFDOAzwssFduUhAwSEALpWDBFhvUoMAQaC0kiH1XcNCBUYoEAgAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4wAB18HjZIADwQ+HZGTi0FPKFAVmotEKCEfA4QPBg+Nj5mCFRZPPBiDFS0NLaCKAh0+A64CKRS0ggJDDCYMCQiKBhZbLcSICE5cEhsXq4kPTTtEzIkHBQoRJASuiBgV2ooIlgTshQcCCAIH6Lv26Q4+Vl0UAkIdejAESwQgKHZ4wLfoAAYMAQEIIBJlhQQJJUTk0NXInYUcPkClsNDjoskIRBgiCoJFxJEtHBAM+ODC5EUuHFQaOjBkwUUxPwxUaGDCpgQQTSI2JGBERwkQQh48uBKhhEkYChaySjEiCooMDu51QFJjAgwZDKZIa1SBSJcO4OB4nVCBRYUFHwUqKGV0z9CDCgVOfNgSBQeBvYUEVOigNxGCF1GOlIDBRUuHaUR2KMjwDVEKHEdsApkCjtABB1gkH1FQQGWFJzpsirBQIUUQAlRWCfDh8+ICHqUJVchQ9CKTDSOCXJCC4kMTDAiGVMW4wEfwQQg4MNDBRMLqJiMWwJBgIsqLBx1UbDCxYYnWQ7aiRGBAggMBmia5WDCAoICFJRYQcJ1pFRDAQRMO2KZEbBf1AIUBACBQAQWNLSLAhZHA0kN3JUTAQzwCRVjAEkBwwYAFFIRoCC9XXBCSToQEAgA7AAAAAAAAAAAA">' +
            '</i>' +
            '<a class="bh-file-upload-delete" href="javascript:void(0)">' + $.i18n('bh-fu-delete') + '</a>' +
            '</div>');
        $(this).trigger('bh-file-upload-validate');
    };

    this._findFile = function(bhId, fileId) {
        var id = fileId ? fileId : bhId;
        var selector = fileId ? 'fileid' : 'bhid';
        return $(this).find(".bh-file-upload-file[data-" + selector + "=" + id + "]");

    };

    this.error = function(errorMsg, bhId, fileId) {
        var block = this._findFile(bhId, fileId);
        if (block.length > 0) {
            block.addClass('bh-error').find('.bh-file-upload-error-msg').text(errorMsg);
            $(this).trigger('bh-file-upload-validate');
        }
    };

    this.remove = function(bhId, fileId) {
        var block = this._findFile(bhId, fileId);
        if (block.length > 0) {
            block.remove();
            $(this).trigger('bh-file-upload-validate');
        }
    };

    // 获取文件个数
    this.getFileNum = function() {
        return $(this).find(".bh-file-upload-file:not(.bh-error)").length;
    };

    return this;
};

//已上传列表
/**
 *
 *  delete
 * 点击删除 的回调
 * func
 */
$.fn.bhFileUploadedList = function(opt) {
    //删除按钮的点击事件
    $(this).on("click", "a.bh-file-upload-delete", function() {
        if (opt.onDelete) {
            opt.onDelete($(this).closest('.bh-file-upload-file'));
        }
    });

    // 点击文件名预览图片 或者下载文件
    $(this).on('click', 'a.bh-file-upload-name-a, .bh-file-upload-file-icon', function() {
        var block = $(this).closest('.bh-file-upload-file');
        var fileName = $('.bh-file-upload-filename', block).attr('title');
        var fileUrl = $('.bh-file-upload-download', block).attr('href');

        if (new RegExp(/\.jpg|\.png|\.jpeg/g).test(fileName.toLowerCase())) {
            // 预览图片
            if (!$.bhGallery) {
                console && console.warn('图片轮播插件Gallery未引入');
                return;
            }
            var imgUrlArr = [];
            var imgSource = [];
            var show = 0;
            $(this).closest('.bh-file-upload-loaded-wrap').find('.bh-file-upload-file').each(function() {
                var name = $('.bh-file-upload-filename', $(this)).attr('title');
                if (new RegExp(/\.jpg|\.png|\.jpeg/g).test(name.toLowerCase())) {
                    var Url = $('.bh-file-upload-download', $(this)).attr('href')
                    imgUrlArr.push(Url)
                }
            });

            $(imgUrlArr).each(function(i) {
                if (fileUrl == this) {
                    show = i;
                }
                imgSource.push({
                    image: this
                })
            });

            $.bhGallery({
                dataSource: imgSource,
                show: show
            });

        } else {
            if (/\.pdf$/g.test(fileName.toLowerCase())) {
                if (opt.canPreviewPDF) {
                    $.emapPDFViewer({
                        url: fileUrl
                    })
                }

                // block.trigger('bh.file.click.pdf', [fileName, fileUrl]);
                return;
            }

            // 下载文件
            location.href = $('.bh-file-upload-download', block).attr('href');
        }
    });

    this.add = function(fileName, bhId, fileId, fileSrc, cb) {
        var iconClass = WIS_EMAP_SERV._getIconImgClass(fileName);
        var item = $('<div class="bh-pull-left bh-file-upload-file" data-bhid="' + bhId + '" data-fileId="' + (fileId ? fileId : 0) + '">' +
            '<div class="bh-file-upload-file-icon bh-pull-left"><i class="iconfont icon-insertdrivefile icon-setstyle ' + iconClass + '"></i></div>' +
            '<div class="bh-file-upload-file-info bh-pull-left">' +
            '<a class="bh-file-upload-name-a" href="javascript:void(0)" style="color:#333;"><span class="bh-file-upload-filename" title="' + fileName + '">' + fileName + '</span></a>' +
            '<p style="white-space: nowrap">' +
            // '<span class="bh-file-upload-success-info">上传成功</span> ' +
            '<a class="bh-file-upload-download bh-mr-8" href="' + fileSrc + '">' + $.i18n('bh-fu-download') + '</a>' +
            '<a class="bh-file-upload-delete" href="javascript:void(0)">' + $.i18n('bh-fu-delete') + '</a></p>' +
            '</div>' +
            '</div>');
        $(this).append(item);
        if (cb) {
            cb(item);
        }
    };

    this.addImage = function(fileName, bhId, fileId, fileSrc, cb) {
        var item = $('<div class="bh-pull-left bh-file-upload-file bh-file-upload-img" data-bhid="' + bhId + '" data-fileId="' + (fileId ? fileId : 0) + '">' +
            '<div class="bh-file-upload-img-block"><span><img src="' + fileSrc + '" /></span></div>' +
            '<div class="bh-file-upload-file-info">' +
            '<span class="bh-file-upload-filename" title="' + fileName + '">' + fileName + '</span>' +
            '<p><span class="bh-file-upload-success-info">' + $.i18n('bh-fu-uploadSuccess') + '</span> <a class="bh-file-upload-delete" href="javascript:void(0)">' + $.i18n('bh-fu-delete') + '</a></p>' +
            '</div>' +
            '</div>');
        $(this).append(item);
        if (cb) {
            cb(item)
        }
    };

    this._findFile = function(bhId, fileId) {
        var id = fileId ? fileId : bhId;
        var selector = fileId ? 'fileid' : 'bhid';
        return $(this).find(".bh-file-upload-file[data-" + selector + "=" + id + "]");

    };

    this.remove = function(bhId, fileId) {
        var block = this._findFile(bhId, fileId);
        if (block.length > 0) {
            block.remove();
        }
    };

    // 获取文件个数
    this.getFileNum = function() {
        return $(this).find(".bh-file-upload-file").length;
    };

    return this;
};
(function() {
    var Plugin;
    var fileReader = 'FileReader' in window;
    var _init, _getLimitInfo, _refreshFileInput; //私有方法

    /**
     * @module emapImageUpload
     * @alias 多图片上传
     * @description 多图片上传
     */
    Plugin = (function() {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapImageUpload.defaults, options);
            this.$element = $(element);

            _init(this.$element, this.options);

        }

        /**
         * @method getFileToken
         * @description 获取token
         * @return {String} token,若无上传文件返回""
         */
        Plugin.prototype.getFileToken = function() {
            if (this.$element.emapImageUpload('getFileNum') == 0) {
                return "";
            }
            return this.options.fileInput.emapUploadCore('getFileToken');
        };

        /**
         * @method getFileUrl
         * @description 返回token下已有的正式文件的url数组
         * @return {Array} url数组
         */
        Plugin.prototype.getFileUrl = function() {
            return this.options.fileInput.emapUploadCore('getFileUrl');
        };

        /**
         * @method saveTempFile
         * @param {Object} params - 保存请求附带参数
         * @description 保存token, 不建议使用, 用saveUpload方法替代
         */
        Plugin.prototype.saveTempFile = function(params) {
            var options = this.options;
            var result = this.options.fileInput.emapUploadCore('saveTempFile', params);
            // 将临时文件下载地址替换为正式文件下载地址
            $('.bh-file-img-block img', this.$element).each(function() {
                var src = $(this).attr('src');
                var imgBlock = $(this).closest('.bh-file-img-block');
                if (new RegExp('getTempFile').test(src)) {
                    var fileId = imgBlock.data('fileid');
                    $(this).attr('src', options.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + fileId + '.do');
                }
            });
            return result;
        };

        /**
         * @method saveUpload
         * @description 该方法为异步的 保存方法, 会在 有文件正在上传时弹出确认框, 该方法返回一个defer对象
         * @param {Object} params - 保存请求附带参数
         * @return {Object} 异步方法的Defer对象，resolve带参格式 为
         * {
         *   success: true,
         *   token: "xxx",
         * }
         */
        Plugin.prototype.saveUpload = function(params) {
            var deferred = $.Deferred();
            // 先判断没有没正在上传的文件, 如果有弹出提示框
            var options = this.options;
            if ($('.bh-file-img-container .loading', this.$element).length > 0) {
                BH_UTILS.bhDialogWarning({
                    title: $.i18n('bh-iu-warning'),
                    content: $.i18n('bh-iu-warningContent'),
                    buttons: [{
                        text: $.i18n('bh-iu-conFirmUpload'),
                        className: 'bh-btn-warning',
                        callback: function() {
                            saveAction(options, deferred, params);
                        }
                    }, {
                        text: $.i18n('bh-iu-cancelUpload'),
                        className: 'bh-btn-default',
                        callback: function() {
                            deferred.reject();
                        }
                    }]
                })
            } else {
                saveAction(options, deferred, params);
            }
            return deferred;

            function saveAction(options, defer, params) {
                var resultObj = {};
                options.fileInput.emapUploadCore('saveUpload', params).done(function(res) {
                    resultObj.success = true;
                    resultObj.token = res.token;
                    defer.resolve(resultObj);
                    // 将临时文件下载地址替换为正式文件下载地址
                    $('.bh-file-img-block.success img', options.listConteiner).each(function() {
                        var src = $(this).attr('src');
                        if (new RegExp('getTempFile').test(src)) {
                            var fileBlock = $(this).closest('.bh-file-img-block');
                            var fileId = fileBlock.data('fileid');
                            $(this).attr('src', options.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + fileId + '.do');
                        }
                    });
                }).fail(function(error) {
                    resultObj.success = false;
                    resultObj.msg = error.msg || $.i18n('bh-iu-saveFail');
                    defer.resolve(resultObj);
                });
            }
        };

        /**
         * @method getFileNum
         * @description 获取已上传的文件数量
         * @return {Int} 文件数量
         */
        Plugin.prototype.getFileNum = function() {
            return $('.bh-file-img-container .saved, .bh-file-img-container .success', this.$element).length;
        };

        /**
         * @method destroy
         * @description 销毁组件实例
         */
        Plugin.prototype.destroy = function() {
            this.options = null;
            $(this.$element).off('click')
            $(this.$element).data('plugin', false).empty();
        };

        // 私有方法
        _init = function(element, options) {
            var imgWidth = parseInt(options.width) - 6;
            var imgHeight = parseInt(options.height) - 6;

            // 未限制上传数量为1时,若传了fileName参数  则删除
            if (options.fileName && options.limit != 1) {
                delete options.fileName;
            }

            $(element).addClass('bh-clearfix').append('<p class="bh-file-img-info"></p>' +
                '<div class="bh-file-img-container">' +
                '<div class="bh-file-img-input bh-file-img-block" style="width: ' + options.width + 'px;height: ' + options.height + 'px;">' +
                '<span>' +
                '<span class="bh-file-img-plus">+</span>' +
                '<span class="bh-file-img-text">' + $.i18n('bh-iu-clickSubmit') + '</span>' +
                '</span>' +
                '<input type="file" ' + (options.multiple ? 'multiple' : '') + '>' +
                '</div>' +
                '</div>');

            options.fileInput = $('input[type=file]', element).parent();
            options.listConteiner = $('.bh-file-img-container', element); // 上传列表容器
            // 生成描述信息
            var introText = $.i18n('bh-iu-uploadImg');
            if (options.type && options.type.length > 0) {
                introText += ', ' + $.i18n('bh-iu-support') + options.type.join(',').toUpperCase() + $.i18n('bh-iu-type');
            }

            if (options.size && options.size > 0) {
                introText += ',' + $.i18n('bh-iu-sizeLimit') + (options.size < 1024 ? options.size + 'K' : options.size / 1024 + 'M') + $.i18n('bh-iu-limit');
            }

            if (options.limit && options.limit > 0) {
                introText += ',' + $.i18n('bh-iu-quantityLimit') + options.limit + $.i18n('bh-iu-limit');
            }


            $('.bh-file-img-info', element).html(introText);

            if (options.height <= 100) {
                $('.bh-file-img-text', element).hide();
            }


            // 获取token下已有的文件
            if (!options.newToken) {
                $.ajax({
                    type: "post",
                    url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                    dataType: "json",
                    success: function(res) {
                        if (res.success) {
                            // console.log(res)
                            var itemHtml = '';
                            $(res.items).each(function() {
                                itemHtml += '<div class="bh-file-img-block saved" data-fileid="' + this.id + '" style="width: ' + options.width + 'px;height: ' + options.height + 'px;">' +
                                    '<div class="bh-file-img-loading" style="line-height: ' + imgHeight + 'px;">' + $.i18n('bh-iu-uploading') + '</div>' +
                                    '<div class="bh-file-img-fail"></div>' +
                                    '<div class="bh-file-img-table" style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                                    '<span style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                                    '<img src="' + this.fileUrl + '" style="max-width: ' + imgWidth + 'px;max-height: ' + imgHeight + 'px;" />' +
                                    '</span>' +
                                    '</div>' +
                                    '<a href="javascript:void(0)" class="bh-file-img-delete">' + $.i18n('bh-iu-delete') + '</a>' +
                                    '</div>';
                            });
                            $('.bh-file-img-input', element).before(itemHtml);
                            element.trigger('bh.file.upload.done', res);
                        }
                    }
                });
            }


            options.fileInput.emapUploadCore($.extend({}, options, {
                add: function(e, data) {
                    var files = data.files;
                    var tmp = new Date().getTime();

                    $(files).each(function(i) {
                        data.files[i].bhId = tmp + i;

                        $('.bh-file-img-input', element).before('<div class="bh-file-img-block loading" data-bhid="' + data.files[i].bhId + '" style="width: ' + options.width + 'px;height: ' + options.height + 'px;">' +
                            '<div class="bh-file-img-loading" style="line-height: ' + imgHeight + 'px;">' + $.i18n('bh-iu-uploading') + '</div>' +
                            '<div class="bh-file-img-fail"></div>' +
                            '<div class="bh-file-img-table" style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                            '<span style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                            '<img style="max-width: ' + imgWidth + 'px;max-height: ' + imgHeight + 'px;" />' +
                            '</span>' +
                            '</div>' +
                            '<a href="javascript:void(0)" class="bh-file-img-delete">' + $.i18n('bh-iu-delete') + '</a>' +
                            '</div>');
                    });

                    if (options.add) {
                        options.add(e, data);
                    }
                    data.submit();

                },
                submit: function(e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-block[data-bhid=' + file.bhId + ']', element);

                    // 文件数量限制的校验
                    if (options.limit) {
                        var currentCount = $('.bh-file-img-block', element).length - 1;
                        if (currentCount > options.limit) {
                            imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html($.i18n('bh-iu-quantityError'));
                            return false;
                        }
                    }

                    // 文件的大小 和类型校验
                    if (options.type && options.type.length > 0) {
                        if (!new RegExp((options.type.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                            imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html($.i18n('bh-iu-typeError'));
                            return false;
                        }
                    }

                    if (fileReader && options.size) {
                        if (file.size / 1024 > options.size) {
                            imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html($.i18n('bh-iu-sizeError'));
                            return false;
                        }
                    }
                    imgBlock.data('xhr', data);

                    if (options.submit) {
                        options.submit(e, data);
                    }
                },
                done: function(e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-block[data-bhid=' + file.bhId + ']', element);

                    // 上传成功
                    imgBlock.removeClass('loading').addClass('success');

                    $('img', imgBlock).attr('src', data.result.tempFileUrl);
                    imgBlock.data({
                        'fileid': data.result.id,
                        'deleteurl': data.result.deleteUrl
                    });
                    if (options.done) {
                        options.done(e, data)
                    }

                    if ($.bhPaperPileDialog) {
                        $.bhPaperPileDialog.resetPageFooter(); //改变页面的页脚位置
                        $.bhPaperPileDialog.resetDialogFooter(); //改变弹框的页脚位置
                    }

                },
                fail: function(e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-block[data-bhid=' + file.bhId + ']', element);
                    imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html(data.result.error ? data.result.error : $.i18n('bh-iu-uploadFail'));
                    if (options.fail) {
                        options.fail(e, data)
                    }

                    if ($.bhPaperPileDialog) {
                        $.bhPaperPileDialog.resetPageFooter(); //改变页面的页脚位置
                        $.bhPaperPileDialog.resetDialogFooter(); //改变弹框的页脚位置
                    }
                }
            }));


            // 删除事件绑定
            $(element).on('click', '.bh-file-img-delete', function() {
                var imgBlock = $(this).closest('.bh-file-img-block');
                if (imgBlock.hasClass('success')) {
                    // 删除临时文件
                    options.fileInput.emapUploadCore('deleteTempFile', imgBlock.data('fileid'))
                        .done(function(res) {
                            if (res.success) {
                                imgBlock.remove();
                            }
                        })

                } else if (imgBlock.hasClass('error')) {
                    // 错误文件直接删除
                    imgBlock.remove();
                } else if (imgBlock.hasClass('loading')) {
                    //  删除正在上传的文件
                    imgBlock.data('xhr').abort();
                    imgBlock.remove();
                } else if (imgBlock.hasClass('saved')) {
                    // 删除正式文件
                    options.fileInput.emapUploadCore('deleteArrAdd', imgBlock.data('fileid'));

                    imgBlock.remove();
                }

            });

            // 图片预览  事件绑定
            $(element).on('click', '.bh-file-img-table img', function() {
                if (!$.bhGallery) {
                    console && console.warn('图片轮播插件Gallery未引入');
                    return;
                }
                var curUrl = $(this).attr('src');
                var imgs = $(this).closest('.bh-file-img-container').find('.bh-file-img-table img');
                var imgSource = [];
                var show = 0;
                if (imgs.length > 0) {
                    imgs.each(function(i) {
                        if (curUrl == $(this).attr('src')) {
                            show = i;
                        }
                        imgSource.push({
                            image: $(this).attr('src')
                        })
                    });

                    $.bhGallery({
                        dataSource: imgSource,
                        show: show
                    });
                }

            })
        };

        // 刷新上传控件的显示或隐藏
        _refreshFileInput = function(element, options) {
            var currentCount = $('.bh-file-img-block', element).length - 1;
            var fileInput = $('.bh-file-img-input', element);
            if (currentCount >= options.limit) {
                // 数量达到上限 上传控件隐藏
                fileInput.hide();
            } else {
                // 数量未达到上限 上传控件显示
                fileInput.show();
            }
        };

        // 定义插件
        $.fn.emapImageUpload = function(options, params) {
            var instance;
            instance = this.data('plugin');

            // 判断是否已经实例化
            if (!instance) {
                return this.each(function() {
                    if (options == 'destroy') {
                        return this;
                    }
                    return $(this).data('plugin', new Plugin(this, options));
                });
            }
            if (options === true) {
                return instance;
            }
            if ($.type(options) === 'string') {
                return instance[options](params);
            }
        };
        /**
         * @memberof module:emapImageUpload
         * @prop {String} [contextPath] - 根路径
         * @prop {String} [token] - 文件token,不传则组件生成随机的新token， 传token则组件自动请求token下已有的文件信息并渲染到页面上
         * @prop {Boolean} [multiple=false] - 上传控件是否支持一次性选择多个
         * @prop {String} [storeId=image] - emap文件类型
         * @prop {Array} [type=['jpg', 'jpeg', 'png']] - 上传文件的格式要求
         * @prop {Int} [size=0] - 上传文件的大小要求，单位为KB
         * @prop {Int} [limit] - 上传文件的数量限制
         * @prop {Function} [add] - 添加文件的回调
         * @prop {Function} [submit] - 开始上传文件的回调
         * @prop {Function} [done] - 文件上传成功的回调
         * @prop {Function} [fail] - 文件上传失败的回调
         */
        $.fn.emapImageUpload.defaults = {
            multiple: false,
            storeId: 'image',
            width: 200,
            height: 150,
            type: ['jpg', 'jpeg', 'png'],
            size: 0
        };
    })();
}).call(this);

(function () {
    var Plugin;
    var fileReader = 'FileReader' in window;
    var _init, _renderSize;

    /**
     * @module emapSingleImageUpload
     * @alias 单图片上传
     * @description 单张图片上传
     */
    Plugin = (function () {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapSingleImageUpload.defaults, options);
            this.$element = $(element);

            _init(this.$element, this.options);

        }
        /**

         * @method getFileToken
         * @description 获取token
         * @returns {String} token,若无上传文件返回""
         */
        Plugin.prototype.getFileToken = function () {
            if (this.$element.emapSingleImageUpload('getFileNum') == 0) {
                return "";
            }
            return this.options.fileInput.emapUploadCore('getFileToken');
        };

        /**
         * @method getFileUrl
         * @description 返回token下已有的正式文件的url数组
         * @returns {Array} url数组
         */
        Plugin.prototype.getFileUrl = function () {
            return this.options.fileInput.emapUploadCore('getFileToken');

        };

         /**
         * @method saveTempFile
         * @param {Object} params - 保存请求附带参数
         * @description 保存token, 不建议使用, 用saveUpload方法替代
         */
        Plugin.prototype.saveTempFile = function (params) {
            var result = this.options.fileInput.emapUploadCore('saveTempFile', params);
            $('.bh-file-img-container', this.$element).removeClass('success').addClass('saved');
            return result;
        };

        /**
         * @method saveUpload
         * @description 该方法为异步的 保存方法, 会在 有文件正在上传时弹出确认框, 该方法返回一个defer对象
         * @param {Object} params - 保存请求附带参数
         * @returns {Object} 异步方法的Defer对象，resolve带参格式 为
         * {
         *   success: true,
         *   token: "xxx",
         * }
         */
        Plugin.prototype.saveUpload = function (params) {
            var deferred = $.Deferred();
            // 先判断没有没正在上传的文件, 如果有弹出提示框
            var options = this.options;
            if ($('.bh-file-img-container.loading', this.$element).length > 0) {
                BH_UTILS.bhDialogWarning({
                    title: $.i18n('bh-siu-warning'),
                    content: $.i18n('bh-siu-warningContent'),
                    buttons: [{
                        text: $.i18n('bh-siu-conFirmUpload'),
                        className: 'bh-btn-warning',
                        callback: function () {
                            saveAction(options, deferred, params);
                        }
                    }, {
                        text: $.i18n('bh-siu-cancelUpload'),
                        className: 'bh-btn-default',
                        callback: function () {
                            deferred.reject();
                        }
                    }]
                })
            } else {
                saveAction(options, deferred, params);
            }
            return deferred;

            function saveAction(options, defer, params) {
                var resultObj = {};
                options.fileInput.emapUploadCore('saveUpload', params).done(function (res) {
                    resultObj.success = true;
                    resultObj.token = res.token;
                    defer.resolve(resultObj);
                    // 将临时文件下载地址替换为正式文件下载地址
                    $('.bh-file-img-table img', options.listConteiner).each(function () {
                        var src = $(this).attr('src');
                        if (new RegExp('getTempFile').test(src)) {
                            var fileBlock = $(this).closest('.bh-file-img-container').removeClass('success').addClass('saved');
                            var fileId = fileBlock.data('fileid');
                            $(this).attr('src', options.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + fileId + '.do');
                        }
                    });
                }).fail(function (error) {
                    resultObj.success = false;
                    resultObj.msg = error.msg || $.i18n('bh-siu-saveFail');
                    defer.resolve(resultObj);
                });
            }
        };


        Plugin.prototype.getFileNum = function () {
            return $('.bh-file-img-container.saved, .bh-file-img-container.success', this.$element).length;
        };

        /**
         * @method destroy
         * @description 销毁组件实例
         */
        Plugin.prototype.destroy = function () {
            $(this.$element).off('click');
            this.options = null;
            $(this.$element).data('plugin', false).empty();
        };

        _renderSize = function (options) {
            if (options.size < 1024) {
                return options.size + 'K';
            } else {
                return parseInt(options.size / 1024 * 100) / 100 + 'M';
            }
        };

        // 私有方法
        _init = function (element, options) {
            if (!options.contextPath) {
                options.contextPath = WIS_EMAP_SERV.getContextPath();
            }
            var imgWidth = parseInt(options.width) - 6;
            var imgHeight = parseInt(options.height) - 6;

            $(element).addClass('bh-clearfix').append('<p class="bh-file-img-info"></p>' +
                '<div class="bh-file-img-container" style="width: ' + options.width + 'px;">' +
                '<div class="bh-file-img-input bh-file-img-block bh-file-img-single-block" style="width: ' + options.width + 'px;height: ' + options.height + 'px;">' +
                '<span class="bh-file-img-single-info">' +
                '<span class="bh-file-img-plus">+</span>' +
                '<span class="bh-file-img-text">' + $.i18n('bh-siu-clickSubmit') + '</span>' +
                '</span>' +
                '<input type="file">' +
                '<div class="bh-file-img-loading" style="line-height: ' + imgHeight + 'px;">' + $.i18n('bh-siu-uploading') + '</div>' +
                '<div class="bh-file-img-fail"></div>' +
                '<div class="bh-file-img-table" style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                '<span style="width: ' + imgWidth + 'px;height: ' + imgHeight + 'px;">' +
                '<img style="max-width: ' + imgWidth + 'px;max-height: ' + imgHeight + 'px;" />' +
                '</span>' +
                '</div>' +
                '</div>' +
                '<div class="bh-file-img-single-edit">' +
                '<a href="javascript:void(0)" class="bh-file-img-retry">' + $.i18n('bh-siu-reupload') + '</a>' +
                '<a href="javascript:void(0)" class="bh-file-img-delete">' + $.i18n('bh-siu-delete') + '</a>' +
                '</div>' +
                '</div>');

            // ie9 下隐藏 重新上传按钮
            if (document.documentMode == 9) {
                $('.bh-file-img-retry', element).hide();
            }

            // 生成描述信息
            var introText = $.i18n('bh-siu-uploadImg');
            if (options.type && options.type.length > 0) {
                introText += ', ' + $.i18n('bh-siu-support') + options.type.join(',').toUpperCase() + $.i18n('bh-siu-type');
            }

            if (options.size && options.size > 0) {
                introText += ',' + $.i18n('bh-siu-sizeLimit') + _renderSize(options) + $.i18n('bh-iu-limit');
            }

            $('.bh-file-img-info', element).html(introText);

            if (options.height <= 100) {
                $('.bh-file-img-text', element).hide();
            }

            // 获取token下已有的文件
            if (!options.newToken) {
                $.ajax({
                    type: "post",
                    url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                    dataType: "json",
                    success: function (res) {
                        if (res.success && res.items && res.items.length > 0) {
                            // console.log(res)
                            var imgBlock = $('.bh-file-img-container', element);
                            $('.bh-file-img-table img', imgBlock).attr('src', res.items[0].fileUrl);
                            imgBlock.addClass('saved').data({
                                'fileid': res.items[0].id
                            });
                        }
                        res.isInit = true
                        element.trigger('bh.file.upload.done', res);
                    }
                });
            }

            options.fileInput = $('input[type=file]', element).parent();

            options.fileInput.emapUploadCore($.extend({}, options, {
                isSingle: "1",
                add: function (e, data) {
                    var file = data.files[0];
                    var block = $('.bh-file-img-container', element);
                    if (block.hasClass('success') || block.hasClass('saved')) { // 文件重新上传
                        deleteFile(block, options);
                    }
                    block.addClass('loading');
                    if (options.add) {
                        options.add(e, data);
                    }
                    data.submit();

                },
                submit: function (e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-container', element);
                    // 文件的大小 和类型校验
                    if (options.type && options.type.length > 0) {
                        if (!new RegExp((options.type.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                            imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html($.i18n('bh-siu-typeError'));
                            return false;
                        }
                    }

                    if (fileReader && options.size) {
                        if (file.size / 1024 > options.size) {
                            imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html($.i18n('bh-siu-sizeError'));
                            return false;
                        }
                    }
                    imgBlock.data('xhr', data);
                    if (options.submit) {
                        options.submit(e, data);
                    }
                },
                done: function (e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-container', element);

                    // 上传成功
                    imgBlock.removeClass('loading').addClass('success');
                    options.tempUpload = true;
                    $('img', imgBlock).attr('src', data.result.tempFileUrl);
                    imgBlock.data({
                        'fileid': data.result.id,
                        'deleteurl': data.result.deleteUrl
                    });
                    if (options.done) {
                        options.done(e, data)
                    }
                    element.trigger('bh.file.upload.done', data);
                },
                fail: function (e, data) {
                    var file = data.files[0];
                    var imgBlock = $('.bh-file-img-container', element);
                    imgBlock.removeClass('loading').addClass('error').find('.bh-file-img-fail').html(data.result.error ? data.result.error : $.i18n('bh-siu-uploadFail'));
                    if (options.fail) {
                        options.fail(e, data)
                    }
                }
            }));


            // 删除事件绑定
            $(element).on('click', '.bh-file-img-delete', function () {
                var imgBlock = $(this).closest('.bh-file-img-container');
                deleteFile(imgBlock, options);
            });

            // 重新上传事件绑定
            $(element).on('click', '.bh-file-img-retry', function () {
                var imgBlock = $('.bh-file-img-container', element);

                // if (imgBlock.hasClass('saved')) {
                //     // 正式文件
                //     options.fileInput.emapUploadCore('deleteArrAdd', imgBlock.data('fileid'));
                // } else if (imgBlock.hasClass('success')) {
                //     // 临时文件
                //     options.fileInput.emapUploadCore('deleteTempFile', imgBlock.data('fileid'));
                // }

                // imgBlock.removeClass('saved success fail loading error');
                // $('.bh-file-img-table img', imgBlock).attr('src', '');
                if (document.documentMode != 9) {
                    $('input[type=file]', imgBlock).click();
                }

            });

            // 图片预览  事件绑定
            $(element).on('click', '.bh-file-img-table img', function () {
                if (!$.bhGallery) {
                    console && console.warn('图片轮播插件Gallery未引入');
                    return;
                }
                $.bhGallery({
                    dataSource: [{
                        image: $(this).attr('src')
                    }]
                });

            })

        };

        function deleteFile(ele, options) {
            var imgBlock = $(ele);
            if (imgBlock.hasClass('success')) {
                // 删除临时文件
                options.fileInput.emapUploadCore('deleteTempFile', imgBlock.data('fileid')).done(function (res) {
                    if (res.success) {
                        imgBlock.removeClass('success');
                        $('.bh-file-img-table img', imgBlock).attr('src', '');
                    }

                })

            } else if (imgBlock.hasClass('error')) {
                // 错误文件直接删除
                imgBlock.removeClass('error');
            } else if (imgBlock.hasClass('loading')) {
                //  删除正在上传的文件
                imgBlock.data('xhr').abort();
                imgBlock.removeClass('loading');
            } else if (imgBlock.hasClass('saved')) {
                // 删除正式文件
                // 在保存时  正式图片才被删除
                options.fileInput.emapUploadCore('deleteArrAdd', imgBlock.data('fileid'));
                imgBlock.removeClass('saved');
                $('.bh-file-img-table img', imgBlock).attr('src', '');
                options.tempUpload = true;
            }
        }

        // 定义插件
        $.fn.emapSingleImageUpload = function (options, params) {
            var instance;
            instance = this.data('plugin');

            // 判断是否已经实例化
            if (!instance) {
                return this.each(function () {
                    if (options == 'destroy') {
                        return this;
                    }
                    return $(this).data('plugin', new Plugin(this, options));
                });
            }
            if (options === true) {
                return instance;
            }
            if ($.type(options) === 'string') {
                return instance[options](params);
            }
        };

        /**
         * @memberof module:emapSingleImageUpload
         * @prop {String} [contextPath] - 根路径
         * @prop {String} [token] - 文件token,不传则组件生成随机的新token， 传token则组件自动请求token下已有的文件信息并渲染到页面上
         * @prop {String} [storeId=image] - emap文件类型
         * @prop {Array} [type=['jpg', 'jpeg', 'png']] - 上传文件的格式要求
         * @prop {Int} [size=0] - 上传文件的大小要求，单位为KB
         * @prop {Function} [add] - 添加文件的回调
         * @prop {Function} [submit] - 开始上传文件的回调
         * @prop {Function} [done] - 文件上传成功的回调
         * @prop {Function} [fail] - 文件上传失败的回调
         */
        $.fn.emapSingleImageUpload.defaults = {
            tempUpload: false,
            multiple: false,
            storeId: 'image',
            width: 200,
            height: 150,
            type: ['jpg', 'jpeg', 'png'],
            size: 0
        };

    })();

}).call(this);
(function () {
    var Plugin;
    var fileReader = 'FileReader' in window;
    var _init;

    Plugin = (function () {
        /**
         * @module emapUploadCore
         * @alias 上传核心模块
         * @description 上传核心模块，此模块等装了emap上传相关的各项请求方法，被 文件上传、图片上传、单图片上传等组件复用，也可单独使用
         */
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapUploadCore.defaults, options);
            this.$element = $(element);

            this.options.contextPath = options.contextPath || WIS_EMAP_SERV.getContextPath();

            if (this.options.token && this.options.token != '') {
                this.options.scope = this.options.token.substring(0, this.options.token.length - 1);
                this.options.newToken = options.newToken = false;
            } else {
                this.options.scope = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
                this.options.token = this.options.scope + 1;
                this.options.newToken = options.newToken = true;
            }
            this.options.arrToDelete = [];
            this.options.tempArrToDelete = [];

            // 对于有传参uploadUrl的情况， 直接使用uploadUrl作为上传地址
            if (!options.uploadUrl) {
                //在outform情况下，上传路径的地址由外部outformUploadUrl穿入  --added for outform by zsl
                if (options.outForm === true) {
                    if (this.options.outFormUploadUrl) {
                        this.options.uploadUrl = this.options.contextPath + this.options.outFormUploadUrl.replace('{scope}', this.options.scope).replace('{scope}', this.options.token);
                    } else {
                        console && console.error('使用表单外fileupload组件时，必须指定outFormUploadUrl');
                    }

                } else {
                    this.options.uploadUrl = this.options.contextPath + '/sys/emapcomponent/file/uploadTempFile.do';
                }
            }
            _init(this.$element, this.options);
        }
        /**
         * @method getFileToken
         * @description 获取token
         * @return {string} token
         */
        Plugin.prototype.getFileToken = function () {
            return this.options.token;
        };

        /**
         * @method getFileUrl
         * @description 返回token下已有的正式文件的url数组
         * @return {Array} url数组
         */
        Plugin.prototype.getFileUrl = function () {
            var options = this.options;
            var fileArr;
            $.ajax({
                type: "post",
                url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                dataType: "json",
                async: false,
                success: function (res) {
                    if (res.success) {
                        fileArr = $(res.items).map(function () {
                            return this.fileUrl;
                        }).get();
                    }
                }
            });
            return fileArr;
        };

        /**
         * @method getFileData
         * @description 返回token下已有的正式文件的信息
         * @return {Array} 文件信息对象数组
         */
        Plugin.prototype.getFileData = function () {
            var options = this.options;
            var fileArr;
            $.ajax({
                type: "post",
                url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                dataType: "json",
                async: false,
                success: function (res) {
                    if (res.success) {
                        fileArr = res.items;
                    }
                }
            });
            return fileArr;
        };

        /**
         * @method deleteArrAdd
         * @param {String} id - 文件id
         * @description 将正式文件添加到待删除 数组中
         */
        Plugin.prototype.deleteArrAdd = function (id) {
            var defer = $.Deferred();
            if (this.options.arrToDelete.indexOf(id) == -1) {
                this.options.arrToDelete.push(id);
            }
            defer.resolve();
        };

        /**
         * @method deleteArrRemove
         * @param {String} id - 文件id
         * @description 将正式文件从待删除数组中  剔除
         */
        Plugin.prototype.deleteArrRemove = function (id) {
            var defer = $.Deferred();
            var index = this.options.arrToDelete.indexOf(id);
            if (index > -1) {
                this.options.arrToDelete.splice(index, 1);
            }
            defer.resolve();
        };

        /**
         * @method tempDeleteArrAdd
         * @param {String} id - 文件id
         * @description 将临时文件添加到 临时文件待删除数组中
         */
        Plugin.prototype.tempDeleteArrAdd = function (id) {
            var defer = $.Deferred();
            if (this.options.tempArrToDelete.indexOf(id) == -1) {
                this.options.tempArrToDelete.push(id);
            }
            defer.resolve();
        };

        /**
         * @method tempDeleteArrRemove
         * @param {String} id - 文件id
         * @description 将临时文件从  临时文件待删除数组中剔除
         */
        Plugin.prototype.tempDeleteArrRemove = function (id) {
            var defer = $.Deferred();
            var index = this.options.tempArrToDelete.indexOf(id);
            if (index > -1) {
                this.options.tempArrToDelete.splice(index, 1);
            }
            defer.resolve
        };

        /**
         * @method saveTempFile
         * @param {Object} [params] - 保存请求参数
         * @description 保存token, 不建议使用, 用saveUpload方法替代
         */
        Plugin.prototype.saveTempFile = function (params) {
            // 删除 已经删除的正式文件
            var options = this.options;
            var element = this.$element;
            var param_data = params || {};
            if (!this.$element.emapUploadCore('deleteFormalFile')) {
                console && console.error('删除临时文件失败');
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-uc-requestFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
                return;
            }

            // 删除 待删除临时文件
            if (options.tempArrToDelete && options.tempArrToDelete.length > 0) {
                options.tempArrToDelete.map(function (item) {
                    element.emapUploadCore('deleteTempFile', item).done(function (res) {});
                })
            }
            if (param_data) {
                param_data.attachmentParam = $.extend({}, this.options.attachmentParam, param_data.attachmentParam);
                param_data.attachmentParam = JSON.stringify(param_data.attachmentParam);
            }

            var result = false;
            var saveOpt = {
                type: "post",
                async: false,
                url: options.contextPath +
                    "/sys/emapcomponent/file/saveAttachment/" +
                    options.scope + "/" + options.token + ".do",
                data: param_data,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        options.arrToDelete = [];
                        // token下没有文件时, 返回的token为空
                        if (element.emapUploadCore('getFileUrl').length > 0) {
                            result = options.token;
                        } else {
                            result = "";
                        }
                    }
                }
            };
            if (options.arrToDelete.length) {
                var widArray = [];
                options.arrToDelete.map(function (item) {
                    var wid = item.replace(/_[1|2]$/g, "");
                    widArray.push(wid);
                    widArray.push(wid + '_1');
                    widArray.push(wid + '_2');
                });
                saveOpt.data.widsOfAttsToDelete = widArray.join(',');
            }
            $.ajax(saveOpt);
            return result;
        };

        /**
         * @method saveUpload
         * @param {Object} [params] - 保存请求参数
         * @description 该方法为异步的 保存方法, 会在 有文件正在上传时弹出确认框, 该方法返回一个defer对象
         * @return {Object} 异步方法的Defer对象，resolve带参格式 为
         * {
         *   success: true,
         *   token: "xxx",
         * }
         */
        Plugin.prototype.saveUpload = function (params) {
            // 删除 已经删除的正式文件
            var options = this.options;
            var element = this.$element;
            var param_data = params || {};
            if (!this.$element.emapUploadCore('deleteFormalFile')) {
                console && console.error('删除临时文件失败');
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-uc-requestFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
                return;
            }

            // 删除 待删除临时文件
            if (options.tempArrToDelete && options.tempArrToDelete.length > 0) {
                options.tempArrToDelete.map(function (item) {
                    element.emapUploadCore('deleteTempFile', item).done(function (res) {});
                })
            }
            if (param_data) {
                param_data.attachmentParam = $.extend({}, this.options.attachmentParam, param_data.attachmentParam);
                param_data.attachmentParam = JSON.stringify(param_data.attachmentParam);
            }

            var result = $.Deferred();
            var saveOpt = {
                type: "post",
                url: options.contextPath +
                    "/sys/emapcomponent/file/saveAttachment/" +
                    options.scope + "/" + options.token + ".do",
                data: param_data,
                dataType: "json",
                success: function (data) {
                    if (data.success) {
                        options.arrToDelete = [];
                        // token下没有文件时, 返回的token为空
                        if (element.emapUploadCore('getFileUrl').length > 0) {
                            data.token = options.token;
                        } else {
                            data.token = "";
                        }
                        result.resolve(data);
                    } else {
                        result.reject(data);
                        $.bhTip && $.bhTip({
                            content: data.msg || $.i18n('bh-uc-saveFail'),
                            state: 'danger',
                            iconClass: 'icon-close'
                        });
                    }
                },
                error: function (error) {
                    result.reject(error);
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-uc-saveFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                }
            };
            if (options.arrToDelete.length) {
                var widArray = [];
                options.arrToDelete.map(function (item) {
                    var wid = item.replace(/_[1|2]$/g, "");
                    widArray.push(wid);
                    widArray.push(wid + '_1');
                    widArray.push(wid + '_2');
                });
                saveOpt.data.widsOfAttsToDelete = widArray.join(',');
            }
            $.ajax(saveOpt);
            return result;

        };

        /**
         * @method deleteFormalFile
         * @param {String} id - 文件id
         * @description 删除正式文件
         */
        Plugin.prototype.deleteFormalFile = function (id) {
            var result = true;
            var options = this.options;
            if (id) {
                deleteAjax(id);
            } else {
                var delArr = this.options.arrToDelete;
                if (delArr.length > 0) {
                    for (var i = 0; i < delArr.length; i++) {
                        deleteAjax(delArr[i]);
                    }
                }
            }
            return result;

            function deleteAjax(id) {

                id = id.replace(/_[1|2]$/g, "");
                var idArr = [id, id + '_1', id + '_2'];
                idArr.map(function (val) {
                    var ajaxOpt = {
                        type: "post",
                        url: options.contextPath + '/sys/emapcomponent/file/deleteFileByWid/' + val + '.do',
                        dataType: "json",
                        success: function (data) {}
                    };
                    if (val == id) {
                        ajaxOpt.async = false;
                        ajaxOpt.success = function (res) {
                            console.log(res)
                            if (res.success && res.count) {

                            } else {
                                result = false;
                            }
                        }
                    }
                    $.ajax(ajaxOpt);
                })

            }

        };

        /**
         * @method deleteTempFile
         * @param {String} id - 文件id
         * @description 删除临时文件
         */
        Plugin.prototype.deleteTempFile = function (id) {
            var options = this.options;
            var url = options.contextPath + '/sys/emapcomponent/file/deleteTempFile.do';
            return $.ajax({
                type: "post",
                url: url,
                dataType: "json",
                async: false,
                data: {
                    scope: options.scope,
                    fileToken: options.token,
                    // attachId: id,
                    fileWid: id,
                    attachmentParam: JSON.stringify({
                        storeId: options.storeId,
                        scope: options.scope,
                        fileToken: options.token
                    })
                }
            });
        };

        /**
         * @method deleteFileByToken
         * @description 删除token下的所有正式文件
         */
        Plugin.prototype.deleteFileByToken = function () {
            var options = this.options;

            return $.ajax({
                type: "post",
                url: options.contextPath + '/sys/emapcomponent/file/deleteFileByToken/' + options.token + '.do',
                async: false,
                dataType: "json"
            });
        };

        /**
         * @method destroy
         * @description 销毁
         */
        Plugin.prototype.destroy = function () {
            this.options = null;
            $(this.$element).data('plugin', false).empty();
        };

        /**
         * @method reload
         * @description 刷新实例的token
         */
        Plugin.prototype.reload = function () {
            var options = this.options;
            options.newToken = true;
            options.scope = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
            options.token = this.options.scope + 1;
            options.uploadUrl = this.options.contextPath + '/sys/emapcomponent/file/uploadTempFile/' + this.options.scope + '/' + this.options.token + '.do';
            options.arrToDelete = [];
            options.tempArrToDelete = [];

            options.attachmentParam = {
                storeId: options.storeId,
                scope: options.scope,
                fileToken: options.token,
                params: options.params
            };
            $('input[type=file]', this.$element).fileupload({
                url: options.uploadUrl
            })
        };

        /**
         * @method getFileBatch
         * @description 批量下载
         */
        Plugin.prototype.getFileBatch = function () {
            window.location.href = options.contextPath + '/sys/emapcomponent/file/getFileBatchByToken/' + options.token + '.do';
            // $.ajax({
            //     type: "post",
            //     url: options.contextPath + '/sys/emapcomponent/file/getFileBatchByToken/' + options.token + '.do',
            //     async: false,
            //     dataType: "json"
            // }).done(function(res){console.log(res)});
        };

        // 私有方法
        _init = function (element, options) {
            // 处理config配置
            options.config = options.config || {};

            // 初始化时 先删除 原有token下的所有临时文件
            if (!options.newToken) {
                $.ajax({
                    type: 'post',
                    url: options.contextPath + '/sys/emapcomponent/file/deleteTempFile.do',
                    async: false,
                    data: {
                        scope: options.scope,
                        fileToken: options.token
                    },
                    success: function () {}
                });
            }


            options.attachmentParam = {
                storeId: options.storeId,
                scope: options.scope,
                fileToken: options.token,
                params: options.params
            };

            var fileInput;
            if (element[0].nodeName == 'INPUT' && element[0].getAttribute('type') == 'file') {
                fileInput = element;
            } else {
                if ($('input[type=file]', element).length == 0) {
                    element.append('<input type="file" name="bhFile" />')
                }

                fileInput = $('input[type=file]', element);
            }

            var formData = $.extend({}, {
                scope: options.scope,
                fileToken: options.token,
                size: options.size,
                type: options.type,
                storeId: options.storeId,
                isSingle: options.isSingle == "1" ? "1" : "0",
                fileName: options.fileName ? options.fileName : ""
            }, options.config.params);

            fileInput.fileupload({
                url: options.uploadUrl,
                autoUpload: true,
                multiple: true,
                dataType: 'json',
                limitMultiFileUploads: 10,
                formData: formData,
                add: function (e, data) {
                    var addResult = true;
                    if (options.add) {
                        addResult = options.add(e, data);
                    }
                    if (addResult === false) {
                        return false
                    }
                    data.submit();
                },
                submit: function (e, data) {
                    var submitResult = true;
                    if (options.submit) {
                        submitResult = options.submit(e, data);
                    }
                    if (submitResult === false) {
                        element.trigger('bh.file.upload.done', data);
                        return false;
                    }
                },
                done: function (e, data) {
                    var file = data.files[0];
                    if (data.result.success) {
                        // 上传成功
                        if (options.done) {
                            options.done(e, data)
                        }
                        element.trigger('bh.file.upload.done', data);
                    } else {
                        // 上传失败
                        if (options.fail) {
                            options.fail(e, data)
                        }
                    }
                },
                fail: function (e, data) {
                    if (options.fail) {
                        options.fail(e, data)
                    }
                }
            });
        };

        // 定义插件
        $.fn.emapUploadCore = function (options, params) {
            var instance;
            instance = this.data('emapuploadcore');

            // 判断是否已经实例化
            if (!instance) {
                return this.each(function () {
                    if (options == 'destroy') {
                        return this;
                    }
                    return $(this).data('emapuploadcore', new Plugin(this, options));
                });
            }
            if (options === true) {
                return instance;
            }
            if ($.type(options) === 'string') {
                return instance[options](params);
            }
        };

        /**
         * @memberof module:emapUploadCore
         * @prop {String} [contextPath] - 根路径
         * @prop {String} [token] - 文件token,不传则组件生成随机的新token， 传token则组件自动请求token下已有的文件信息并渲染到页面上
         * @prop {Boolean} [multiple=false] - 上传控件是否支持一次性选择多个
         * @prop {String} [storeId=file] - emap文件类型
         * @prop {Array} [type=[]] - 上传文件的格式要求
         * @prop {Int} [size=0] - 上传文件的大小要求，单位为KB
         * @prop {Function} [add] - 添加文件的回调
         * @prop {Function} [submit] - 开始上传文件的回调
         * @prop {Function} [done] - 文件上传成功的回调
         * @prop {Function} [fail] - 文件上传失败的回调
         */
        $.fn.emapUploadCore.defaults = {
            multiple: false,
            storeId: 'file',
            type: [],
            size: 0
        };


    })();

}).call(this);
/*! jQuery UI - v1.11.4+CommonJS - 2015-08-28
 * http://jqueryui.com
 * Includes: widget.js
 * Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */
(function (c) {
    /*!
     * jQuery UI Widget 1.11.4
     * http://jqueryui.com
     *
     * Copyright jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     *
     * http://api.jqueryui.com/jQuery.widget/
     */
    var d = 0, a = Array.prototype.slice;
    c.cleanData = (function (e) {
        return function (f) {
            var h, j, g;
            for (g = 0; (j = f[g]) != null; g++) {
                try {
                    h = c._data(j, "events");
                    if (h && h.remove) {
                        c(j).triggerHandler("remove")
                    }
                } catch (k) {
                }
            }
            e(f)
        }
    })(c.cleanData);
    c.widget = function (e, f, m) {
        var j, k, h, l, g = {}, i = e.split(".")[0];
        e = e.split(".")[1];
        j = i + "-" + e;
        if (!m) {
            m = f;
            f = c.Widget
        }
        c.expr[":"][j.toLowerCase()] = function (n) {
            return !!c.data(n, j)
        };
        c[i] = c[i] || {};
        k = c[i][e];
        h = c[i][e] = function (n, o) {
            if (!this._createWidget) {
                return new h(n, o)
            }
            if (arguments.length) {
                this._createWidget(n, o)
            }
        };
        c.extend(h, k, {version: m.version, _proto: c.extend({}, m), _childConstructors: []});
        l = new f();
        l.options = c.widget.extend({}, l.options);
        c.each(m, function (o, n) {
            if (!c.isFunction(n)) {
                g[o] = n;
                return
            }
            g[o] = (function () {
                var p = function () {
                    return f.prototype[o].apply(this, arguments)
                }, q = function (r) {
                    return f.prototype[o].apply(this, r)
                };
                return function () {
                    var t = this._super, r = this._superApply, s;
                    this._super = p;
                    this._superApply = q;
                    s = n.apply(this, arguments);
                    this._super = t;
                    this._superApply = r;
                    return s
                }
            })()
        });
        h.prototype = c.widget.extend(l, {widgetEventPrefix: k ? (l.widgetEventPrefix || e) : e}, g, {
            constructor: h,
            namespace: i,
            widgetName: e,
            widgetFullName: j
        });
        if (k) {
            c.each(k._childConstructors, function (o, p) {
                var n = p.prototype;
                c.widget(n.namespace + "." + n.widgetName, h, p._proto)
            });
            delete k._childConstructors
        } else {
            f._childConstructors.push(h)
        }
        c.widget.bridge(e, h);
        return h
    };
    c.widget.extend = function (j) {
        var f = a.call(arguments, 1), i = 0, e = f.length, g, h;
        for (; i < e; i++) {
            for (g in f[i]) {
                h = f[i][g];
                if (f[i].hasOwnProperty(g) && h !== undefined) {
                    if (c.isPlainObject(h)) {
                        j[g] = c.isPlainObject(j[g]) ? c.widget.extend({}, j[g], h) : c.widget.extend({}, h)
                    } else {
                        j[g] = h
                    }
                }
            }
        }
        return j
    };
    c.widget.bridge = function (f, e) {
        var g = e.prototype.widgetFullName || f;
        c.fn[f] = function (j) {
            var h = typeof j === "string", i = a.call(arguments, 1), k = this;
            if (h) {
                this.each(function () {
                    var m, l = c.data(this, g);
                    if (j === "instance") {
                        k = l;
                        return false
                    }
                    if (!l) {
                        return c.error("cannot call methods on " + f + " prior to initialization; " + "attempted to call method '" + j + "'")
                    }
                    if (!c.isFunction(l[j]) || j.charAt(0) === "_") {
                        return c.error("no such method '" + j + "' for " + f + " widget instance")
                    }
                    m = l[j].apply(l, i);
                    if (m !== l && m !== undefined) {
                        k = m && m.jquery ? k.pushStack(m.get()) : m;
                        return false
                    }
                })
            } else {
                if (i.length) {
                    j = c.widget.extend.apply(null, [j].concat(i))
                }
                this.each(function () {
                    var l = c.data(this, g);
                    if (l) {
                        l.option(j || {});
                        if (l._init) {
                            l._init()
                        }
                    } else {
                        c.data(this, g, new e(j, this))
                    }
                })
            }
            return k
        }
    };
    c.Widget = function () {
    };
    c.Widget._childConstructors = [];
    c.Widget.prototype = {
        widgetName: "widget",
        widgetEventPrefix: "",
        defaultElement: "<div>",
        options: {disabled: false, create: null},
        _createWidget: function (e, f) {
            f = c(f || this.defaultElement || this)[0];
            this.element = c(f);
            this.uuid = d++;
            this.eventNamespace = "." + this.widgetName + this.uuid;
            this.bindings = c();
            this.hoverable = c();
            this.focusable = c();
            if (f !== this) {
                c.data(f, this.widgetFullName, this);
                this._on(true, this.element, {
                    remove: function (g) {
                        if (g.target === f) {
                            this.destroy()
                        }
                    }
                });
                this.document = c(f.style ? f.ownerDocument : f.document || f);
                this.window = c(this.document[0].defaultView || this.document[0].parentWindow)
            }
            this.options = c.widget.extend({}, this.options, this._getCreateOptions(), e);
            this._create();
            this._trigger("create", null, this._getCreateEventData());
            this._init()
        },
        _getCreateOptions: c.noop,
        _getCreateEventData: c.noop,
        _create: c.noop,
        _init: c.noop,
        destroy: function () {
            this._destroy();
            this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData(c.camelCase(this.widgetFullName));
            this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName + "-disabled " + "ui-state-disabled");
            this.bindings.unbind(this.eventNamespace);
            this.hoverable.removeClass("ui-state-hover");
            this.focusable.removeClass("ui-state-focus")
        },
        _destroy: c.noop,
        widget: function () {
            return this.element
        },
        option: function (h, j) {
            var e = h, k, g, f;
            if (arguments.length === 0) {
                return c.widget.extend({}, this.options)
            }
            if (typeof h === "string") {
                e = {};
                k = h.split(".");
                h = k.shift();
                if (k.length) {
                    g = e[h] = c.widget.extend({}, this.options[h]);
                    for (f = 0; f < k.length - 1; f++) {
                        g[k[f]] = g[k[f]] || {};
                        g = g[k[f]]
                    }
                    h = k.pop();
                    if (arguments.length === 1) {
                        return g[h] === undefined ? null : g[h]
                    }
                    g[h] = j
                } else {
                    if (arguments.length === 1) {
                        return this.options[h] === undefined ? null : this.options[h]
                    }
                    e[h] = j
                }
            }
            this._setOptions(e);
            return this
        },
        _setOptions: function (e) {
            var f;
            for (f in e) {
                this._setOption(f, e[f])
            }
            return this
        },
        _setOption: function (e, f) {
            this.options[e] = f;
            if (e === "disabled") {
                this.widget().toggleClass(this.widgetFullName + "-disabled", !!f);
                if (f) {
                    this.hoverable.removeClass("ui-state-hover");
                    this.focusable.removeClass("ui-state-focus")
                }
            }
            return this
        },
        enable: function () {
            return this._setOptions({disabled: false})
        },
        disable: function () {
            return this._setOptions({disabled: true})
        },
        _on: function (h, g, f) {
            var i, e = this;
            if (typeof h !== "boolean") {
                f = g;
                g = h;
                h = false
            }
            if (!f) {
                f = g;
                g = this.element;
                i = this.widget()
            } else {
                g = i = c(g);
                this.bindings = this.bindings.add(g)
            }
            c.each(f, function (o, n) {
                function l() {
                    if (!h && (e.options.disabled === true || c(this).hasClass("ui-state-disabled"))) {
                        return
                    }
                    return (typeof n === "string" ? e[n] : n).apply(e, arguments)
                }

                if (typeof n !== "string") {
                    l.guid = n.guid = n.guid || l.guid || c.guid++
                }
                var m = o.match(/^([\w:-]*)\s*(.*)$/), k = m[1] + e.eventNamespace, j = m[2];
                if (j) {
                    i.delegate(j, k, l)
                } else {
                    g.bind(k, l)
                }
            })
        },
        _off: function (f, e) {
            e = (e || "").split(" ").join(this.eventNamespace + " ") + this.eventNamespace;
            f.unbind(e).undelegate(e);
            this.bindings = c(this.bindings.not(f).get());
            this.focusable = c(this.focusable.not(f).get());
            this.hoverable = c(this.hoverable.not(f).get())
        },
        _delay: function (h, g) {
            function f() {
                return (typeof h === "string" ? e[h] : h).apply(e, arguments)
            }

            var e = this;
            return setTimeout(f, g || 0)
        },
        _hoverable: function (e) {
            this.hoverable = this.hoverable.add(e);
            this._on(e, {
                mouseenter: function (f) {
                    c(f.currentTarget).addClass("ui-state-hover")
                }, mouseleave: function (f) {
                    c(f.currentTarget).removeClass("ui-state-hover")
                }
            })
        },
        _focusable: function (e) {
            this.focusable = this.focusable.add(e);
            this._on(e, {
                focusin: function (f) {
                    c(f.currentTarget).addClass("ui-state-focus")
                }, focusout: function (f) {
                    c(f.currentTarget).removeClass("ui-state-focus")
                }
            })
        },
        _trigger: function (e, f, g) {
            var j, i, h = this.options[e];
            g = g || {};
            f = c.Event(f);
            f.type = (e === this.widgetEventPrefix ? e : this.widgetEventPrefix + e).toLowerCase();
            f.target = this.element[0];
            i = f.originalEvent;
            if (i) {
                for (j in i) {
                    if (!(j in f)) {
                        f[j] = i[j]
                    }
                }
            }
            this.element.trigger(f, g);
            return !(c.isFunction(h) && h.apply(this.element[0], [f].concat(g)) === false || f.isDefaultPrevented())
        }
    };
    c.each({show: "fadeIn", hide: "fadeOut"}, function (f, e) {
        c.Widget.prototype["_" + f] = function (i, h, k) {
            if (typeof h === "string") {
                h = {effect: h}
            }
            var j, g = !h ? f : h === true || typeof h === "number" ? e : h.effect || e;
            h = h || {};
            if (typeof h === "number") {
                h = {duration: h}
            }
            j = !c.isEmptyObject(h);
            h.complete = k;
            if (h.delay) {
                i.delay(h.delay)
            }
            if (j && c.effects && c.effects.effect[g]) {
                i[f](h)
            } else {
                if (g !== f && i[g]) {
                    i[g](h.duration, h.easing, k)
                } else {
                    i.queue(function (l) {
                        c(this)[f]();
                        if (k) {
                            k.call(i[0])
                        }
                        l()
                    })
                }
            }
        }
    });
    var b = c.widget
})(jQuery);

(function (b) {
    var a = 0;
    b.ajaxTransport("iframe", function (d) {
        if (d.async) {
            var c = d.initialIframeSrc || "javascript:false;", f, e, g;
            return {
                send: function (h, i) {
                    f = b('<form style="display:none;"></form>');
                    f.attr("accept-charset", d.formAcceptCharset);
                    g = /\?/.test(d.url) ? "&" : "?";
                    if (d.type === "DELETE") {
                        d.url = d.url + g + "_method=DELETE";
                        d.type = "POST"
                    } else {
                        if (d.type === "PUT") {
                            d.url = d.url + g + "_method=PUT";
                            d.type = "POST"
                        } else {
                            if (d.type === "PATCH") {
                                d.url = d.url + g + "_method=PATCH";
                                d.type = "POST"
                            }
                        }
                    }
                    a += 1;
                    e = b('<iframe src="' + c + '" name="iframe-transport-' + a + '"></iframe>').bind("load", function () {
                        var j, k = b.isArray(d.paramName) ? d.paramName : [d.paramName];
                        e.unbind("load").bind("load", function () {
                            var l;
                            try {
                                l = e.contents();
                                if (!l.length || !l[0].firstChild) {
                                    throw new Error()
                                }
                            } catch (m) {
                                l = undefined
                            }
                            i(200, "success", {"iframe": l});
                            b('<iframe src="' + c + '"></iframe>').appendTo(f);
                            window.setTimeout(function () {
                                f.remove()
                            }, 0)
                        });
                        f.prop("target", e.prop("name")).prop("action", d.url).prop("method", d.type);
                        if (d.formData) {
                            b.each(d.formData, function (l, m) {
                                b('<input type="hidden"/>').prop("name", m.name).val(m.value).appendTo(f)
                            })
                        }
                        if (d.fileInput && d.fileInput.length && d.type === "POST") {
                            j = d.fileInput.clone();
                            d.fileInput.after(function (l) {
                                return j[l]
                            });
                            if (d.paramName) {
                                d.fileInput.each(function (l) {
                                    b(this).prop("name", k[l] || d.paramName)
                                })
                            }
                            f.append(d.fileInput).prop("enctype", "multipart/form-data").prop("encoding", "multipart/form-data");
                            d.fileInput.removeAttr("form")
                        }
                        f.submit();
                        if (j && j.length) {
                            d.fileInput.each(function (m, l) {
                                var n = b(j[m]);
                                b(l).prop("name", n.prop("name")).attr("form", n.attr("form"));
                                n.replaceWith(l)
                            })
                        }
                    });
                    f.append(e).appendTo(document.body)
                }, abort: function () {
                    if (e) {
                        e.unbind("load").prop("src", c)
                    }
                    if (f) {
                        f.remove()
                    }
                }
            }
        }
    });
    b.ajaxSetup({
        converters: {
            "iframe text": function (c) {
                return c && b(c[0].body).text()
            }, "iframe json": function (c) {
                return c && b.parseJSON(b(c[0].body).text())
            }, "iframe html": function (c) {
                return c && b(c[0].body).html()
            }, "iframe xml": function (c) {
                var d = c && c[0];
                return d && b.isXMLDoc(d) ? d : b.parseXML((d.XMLDocument && d.XMLDocument.xml) || b(d.body).html())
            }, "iframe script": function (c) {
                return c && b.globalEval(b(c[0].body).text())
            }
        }
    })
})(jQuery);
(function (b) {
    b.support.fileInput = !(new RegExp("(Android (1\\.[0156]|2\\.[01]))" + "|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)" + "|(w(eb)?OSBrowser)|(webOS)" + "|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(window.navigator.userAgent) || b('<input type="file">').prop("disabled"));
    b.support.xhrFileUpload = !!(window.ProgressEvent && window.FileReader);
    b.support.xhrFormDataFileUpload = !!window.FormData;
    b.support.blobSlice = window.Blob && (Blob.prototype.slice || Blob.prototype.webkitSlice || Blob.prototype.mozSlice);
    function a(c) {
        var d = c === "dragover";
        return function (g) {
            g.dataTransfer = g.originalEvent && g.originalEvent.dataTransfer;
            var f = g.dataTransfer;
            if (f && b.inArray("Files", f.types) !== -1 && this._trigger(c, b.Event(c, {delegatedEvent: g})) !== false) {
                g.preventDefault();
                if (d) {
                    f.dropEffect = "copy"
                }
            }
        }
    }

    b.widget("blueimp.fileupload", {
        options: {
            dropZone: b(document),
            pasteZone: undefined,
            fileInput: undefined,
            replaceFileInput: true,
            paramName: undefined,
            singleFileUploads: true,
            limitMultiFileUploads: undefined,
            limitMultiFileUploadSize: undefined,
            limitMultiFileUploadSizeOverhead: 512,
            sequentialUploads: false,
            limitConcurrentUploads: undefined,
            forceIframeTransport: false,
            redirect: undefined,
            redirectParamName: undefined,
            postMessage: undefined,
            multipart: true,
            maxChunkSize: undefined,
            uploadedBytes: undefined,
            recalculateProgress: true,
            progressInterval: 100,
            bitrateInterval: 500,
            autoUpload: true,
            messages: {uploadedBytes: "Uploaded bytes exceed file size"},
            i18n: function (d, c) {
                d = this.messages[d] || d.toString();
                if (c) {
                    b.each(c, function (e, f) {
                        d = d.replace("{" + e + "}", f)
                    })
                }
                return d
            },
            formData: function (c) {
                return c.serializeArray()
            },
            add: function (d, c) {
                if (d.isDefaultPrevented()) {
                    return false
                }
                if (c.autoUpload || (c.autoUpload !== false && b(this).fileupload("option", "autoUpload"))) {
                    c.process().done(function () {
                        c.submit()
                    })
                }
            },
            processData: false,
            contentType: false,
            cache: false,
            timeout: 0
        },
        _specialOptions: ["fileInput", "dropZone", "pasteZone", "multipart", "forceIframeTransport"],
        _blobSlice: b.support.blobSlice && function () {
            var c = this.slice || this.webkitSlice || this.mozSlice;
            return c.apply(this, arguments)
        },
        _BitrateTimer: function () {
            this.timestamp = ((Date.now) ? Date.now() : (new Date()).getTime());
            this.loaded = 0;
            this.bitrate = 0;
            this.getBitrate = function (e, d, c) {
                var f = e - this.timestamp;
                if (!this.bitrate || !c || f > c) {
                    this.bitrate = (d - this.loaded) * (1000 / f) * 8;
                    this.loaded = d;
                    this.timestamp = e
                }
                return this.bitrate
            }
        },
        _isXHRUpload: function (c) {
            return !c.forceIframeTransport && ((!c.multipart && b.support.xhrFileUpload) || b.support.xhrFormDataFileUpload)
        },
        _getFormData: function (c) {
            var d;
            if (b.type(c.formData) === "function") {
                return c.formData(c.form)
            }
            if (b.isArray(c.formData)) {
                return c.formData
            }
            if (b.type(c.formData) === "object") {
                d = [];
                b.each(c.formData, function (e, f) {
                    d.push({name: e, value: f})
                });
                return d
            }
            return []
        },
        _getTotal: function (d) {
            var c = 0;
            b.each(d, function (e, f) {
                c += f.size || 1
            });
            return c
        },
        _initProgressObject: function (d) {
            var c = {loaded: 0, total: 0, bitrate: 0};
            if (d._progress) {
                b.extend(d._progress, c)
            } else {
                d._progress = c
            }
        },
        _initResponseObject: function (c) {
            var d;
            if (c._response) {
                for (d in c._response) {
                    if (c._response.hasOwnProperty(d)) {
                        delete c._response[d]
                    }
                }
            } else {
                c._response = {}
            }
        },
        _onProgress: function (g, f) {
            if (g.lengthComputable) {
                var d = ((Date.now) ? Date.now() : (new Date()).getTime()), c;
                if (f._time && f.progressInterval && (d - f._time < f.progressInterval) && g.loaded !== g.total) {
                    return
                }
                f._time = d;
                c = Math.floor(g.loaded / g.total * (f.chunkSize || f._progress.total)) + (f.uploadedBytes || 0);
                this._progress.loaded += (c - f._progress.loaded);
                this._progress.bitrate = this._bitrateTimer.getBitrate(d, this._progress.loaded, f.bitrateInterval);
                f._progress.loaded = f.loaded = c;
                f._progress.bitrate = f.bitrate = f._bitrateTimer.getBitrate(d, c, f.bitrateInterval);
                this._trigger("progress", b.Event("progress", {delegatedEvent: g}), f);
                this._trigger("progressall", b.Event("progressall", {delegatedEvent: g}), this._progress)
            }
        },
        _initProgressListener: function (c) {
            var d = this, e = c.xhr ? c.xhr() : b.ajaxSettings.xhr();
            if (e.upload) {
                b(e.upload).bind("progress", function (f) {
                    var g = f.originalEvent;
                    f.lengthComputable = g.lengthComputable;
                    f.loaded = g.loaded;
                    f.total = g.total;
                    d._onProgress(f, c)
                });
                c.xhr = function () {
                    return e
                }
            }
        },
        _isInstanceOf: function (c, d) {
            return Object.prototype.toString.call(d) === "[object " + c + "]"
        },
        _initXHRData: function (d) {
            var f = this, h, e = d.files[0], c = d.multipart || !b.support.xhrFileUpload, g = b.type(d.paramName) === "array" ? d.paramName[0] : d.paramName;
            d.headers = b.extend({}, d.headers);
            if (d.contentRange) {
                d.headers["Content-Range"] = d.contentRange
            }
            if (!c || d.blob || !this._isInstanceOf("File", e)) {
                d.headers["Content-Disposition"] = 'attachment; filename="' + encodeURI(e.name) + '"'
            }
            if (!c) {
                d.contentType = e.type || "application/octet-stream";
                d.data = d.blob || e
            } else {
                if (b.support.xhrFormDataFileUpload) {
                    if (d.postMessage) {
                        h = this._getFormData(d);
                        if (d.blob) {
                            h.push({name: g, value: d.blob})
                        } else {
                            b.each(d.files, function (i, j) {
                                h.push({name: (b.type(d.paramName) === "array" && d.paramName[i]) || g, value: j})
                            })
                        }
                    } else {
                        if (f._isInstanceOf("FormData", d.formData)) {
                            h = d.formData
                        } else {
                            h = new FormData();
                            b.each(this._getFormData(d), function (i, j) {
                                h.append(j.name, j.value)
                            })
                        }
                        if (d.blob) {
                            h.append(g, d.blob, e.name)
                        } else {
                            b.each(d.files, function (i, j) {
                                if (f._isInstanceOf("File", j) || f._isInstanceOf("Blob", j)) {
                                    h.append((b.type(d.paramName) === "array" && d.paramName[i]) || g, j, j.uploadName || j.name)
                                }
                            })
                        }
                    }
                    d.data = h
                }
            }
            d.blob = null
        },
        _initIframeSettings: function (c) {
            var d = b("<a></a>").prop("href", c.url).prop("host");
            c.dataType = "iframe " + (c.dataType || "");
            c.formData = this._getFormData(c);
            if (c.redirect && d && d !== location.host) {
                c.formData.push({name: c.redirectParamName || "redirect", value: c.redirect})
            }
        },
        _initDataSettings: function (c) {
            if (this._isXHRUpload(c)) {
                if (!this._chunkedUpload(c, true)) {
                    if (!c.data) {
                        this._initXHRData(c)
                    }
                    this._initProgressListener(c)
                }
                if (c.postMessage) {
                    c.dataType = "postmessage " + (c.dataType || "")
                }
            } else {
                this._initIframeSettings(c)
            }
        },
        _getParamName: function (c) {
            var d = b(c.fileInput), e = c.paramName;
            if (!e) {
                e = [];
                d.each(function () {
                    var f = b(this), g = f.prop("name") || "files[]", h = (f.prop("files") || [1]).length;
                    while (h) {
                        e.push(g);
                        h -= 1
                    }
                });
                if (!e.length) {
                    e = [d.prop("name") || "files[]"]
                }
            } else {
                if (!b.isArray(e)) {
                    e = [e]
                }
            }
            return e
        },
        _initFormSettings: function (c) {
            if (!c.form || !c.form.length) {
                c.form = b(c.fileInput.prop("form"));
                if (!c.form.length) {
                    c.form = b(this.options.fileInput.prop("form"))
                }
            }
            c.paramName = this._getParamName(c);
            if (!c.url) {
                c.url = c.form.prop("action") || location.href
            }
            c.type = (c.type || (b.type(c.form.prop("method")) === "string" && c.form.prop("method")) || "").toUpperCase();
            if (c.type !== "POST" && c.type !== "PUT" && c.type !== "PATCH") {
                c.type = "POST"
            }
            if (!c.formAcceptCharset) {
                c.formAcceptCharset = c.form.attr("accept-charset")
            }
        },
        _getAJAXSettings: function (d) {
            var c = b.extend({}, this.options, d);
            this._initFormSettings(c);
            this._initDataSettings(c);
            return c
        },
        _getDeferredState: function (c) {
            if (c.state) {
                return c.state()
            }
            if (c.isResolved()) {
                return "resolved"
            }
            if (c.isRejected()) {
                return "rejected"
            }
            return "pending"
        },
        _enhancePromise: function (c) {
            c.success = c.done;
            c.error = c.fail;
            c.complete = c.always;
            return c
        },
        _getXHRPromise: function (f, e, d) {
            var c = b.Deferred(), g = c.promise();
            e = e || this.options.context || g;
            if (f === true) {
                c.resolveWith(e, d)
            } else {
                if (f === false) {
                    c.rejectWith(e, d)
                }
            }
            g.abort = c.promise;
            return this._enhancePromise(g)
        },
        _addConvenienceMethods: function (g, f) {
            var d = this, c = function (e) {
                return b.Deferred().resolveWith(d, e).promise()
            };
            f.process = function (h, e) {
                if (h || e) {
                    f._processQueue = this._processQueue = (this._processQueue || c([this])).pipe(function () {
                        if (f.errorThrown) {
                            return b.Deferred().rejectWith(d, [f]).promise()
                        }
                        return c(arguments)
                    }).pipe(h, e)
                }
                return this._processQueue || c([this])
            };
            f.submit = function () {
                if (this.state() !== "pending") {
                    f.jqXHR = this.jqXHR = (d._trigger("submit", b.Event("submit", {delegatedEvent: g}), this) !== false) && d._onSend(g, this)
                }
                return this.jqXHR || d._getXHRPromise()
            };
            f.abort = function () {
                if (this.jqXHR) {
                    return this.jqXHR.abort()
                }
                this.errorThrown = "abort";
                d._trigger("fail", null, this);
                return d._getXHRPromise(false)
            };
            f.state = function () {
                if (this.jqXHR) {
                    return d._getDeferredState(this.jqXHR)
                }
                if (this._processQueue) {
                    return d._getDeferredState(this._processQueue)
                }
            };
            f.processing = function () {
                return !this.jqXHR && this._processQueue && d._getDeferredState(this._processQueue) === "pending"
            };
            f.progress = function () {
                return this._progress
            };
            f.response = function () {
                return this._response
            }
        },
        _getUploadedBytes: function (e) {
            var c = e.getResponseHeader("Range"), f = c && c.split("-"), d = f && f.length > 1 && parseInt(f[1], 10);
            return d && d + 1
        },
        _chunkedUpload: function (n, h) {
            n.uploadedBytes = n.uploadedBytes || 0;
            var g = this, e = n.files[0], f = e.size, c = n.uploadedBytes, d = n.maxChunkSize || f, j = this._blobSlice, k = b.Deferred(), m = k.promise(), i, l;
            if (!(this._isXHRUpload(n) && j && (c || d < f)) || n.data) {
                return false
            }
            if (h) {
                return true
            }
            if (c >= f) {
                e.error = n.i18n("uploadedBytes");
                return this._getXHRPromise(false, n.context, [null, "error", e.error])
            }
            l = function () {
                var q = b.extend({}, n), p = q._progress.loaded;
                q.blob = j.call(e, c, c + d, e.type);
                q.chunkSize = q.blob.size;
                q.contentRange = "bytes " + c + "-" + (c + q.chunkSize - 1) + "/" + f;
                g._initXHRData(q);
                g._initProgressListener(q);
                i = ((g._trigger("chunksend", null, q) !== false && b.ajax(q)) || g._getXHRPromise(false, q.context)).done(function (o, s, r) {
                    c = g._getUploadedBytes(r) || (c + q.chunkSize);
                    if (p + q.chunkSize - q._progress.loaded) {
                        g._onProgress(b.Event("progress", {
                            lengthComputable: true,
                            loaded: c - q.uploadedBytes,
                            total: c - q.uploadedBytes
                        }), q)
                    }
                    n.uploadedBytes = q.uploadedBytes = c;
                    q.result = o;
                    q.textStatus = s;
                    q.jqXHR = r;
                    g._trigger("chunkdone", null, q);
                    g._trigger("chunkalways", null, q);
                    if (c < f) {
                        l()
                    } else {
                        k.resolveWith(q.context, [o, s, r])
                    }
                }).fail(function (o, s, r) {
                    q.jqXHR = o;
                    q.textStatus = s;
                    q.errorThrown = r;
                    g._trigger("chunkfail", null, q);
                    g._trigger("chunkalways", null, q);
                    k.rejectWith(q.context, [o, s, r])
                })
            };
            this._enhancePromise(m);
            m.abort = function () {
                return i.abort()
            };
            l();
            return m
        },
        _beforeSend: function (d, c) {
            if (this._active === 0) {
                this._trigger("start");
                this._bitrateTimer = new this._BitrateTimer();
                this._progress.loaded = this._progress.total = 0;
                this._progress.bitrate = 0
            }
            this._initResponseObject(c);
            this._initProgressObject(c);
            c._progress.loaded = c.loaded = c.uploadedBytes || 0;
            c._progress.total = c.total = this._getTotal(c.files) || 1;
            c._progress.bitrate = c.bitrate = 0;
            this._active += 1;
            this._progress.loaded += c.loaded;
            this._progress.total += c.total
        },
        _onDone: function (c, h, g, e) {
            var f = e._progress.total, d = e._response;
            if (e._progress.loaded < f) {
                this._onProgress(b.Event("progress", {lengthComputable: true, loaded: f, total: f}), e)
            }
            d.result = e.result = c;
            d.textStatus = e.textStatus = h;
            d.jqXHR = e.jqXHR = g;
            this._trigger("done", null, e)
        },
        _onFail: function (e, g, f, d) {
            var c = d._response;
            if (d.recalculateProgress) {
                this._progress.loaded -= d._progress.loaded;
                this._progress.total -= d._progress.total
            }
            c.jqXHR = d.jqXHR = e;
            c.textStatus = d.textStatus = g;
            c.errorThrown = d.errorThrown = f;
            this._trigger("fail", null, d)
        },
        _onAlways: function (e, f, d, c) {
            this._trigger("always", null, c)
        },
        _onSend: function (i, g) {
            if (!g.submit) {
                this._addConvenienceMethods(i, g)
            }
            var h = this, k, c, j, d, l = h._getAJAXSettings(g), f = function () {
                h._sending += 1;
                l._bitrateTimer = new h._BitrateTimer();
                k = k || (((c || h._trigger("send", b.Event("send", {delegatedEvent: i}), l) === false) && h._getXHRPromise(false, l.context, c)) || h._chunkedUpload(l) || b.ajax(l)).done(function (e, n, m) {
                            h._onDone(e, n, m, l)
                        }).fail(function (e, n, m) {
                            h._onFail(e, n, m, l)
                        }).always(function (n, o, m) {
                            h._onAlways(n, o, m, l);
                            h._sending -= 1;
                            h._active -= 1;
                            if (l.limitConcurrentUploads && l.limitConcurrentUploads > h._sending) {
                                var e = h._slots.shift();
                                while (e) {
                                    if (h._getDeferredState(e) === "pending") {
                                        e.resolve();
                                        break
                                    }
                                    e = h._slots.shift()
                                }
                            }
                            if (h._active === 0) {
                                h._trigger("stop")
                            }
                        });
                return k
            };
            this._beforeSend(i, l);
            if (this.options.sequentialUploads || (this.options.limitConcurrentUploads && this.options.limitConcurrentUploads <= this._sending)) {
                if (this.options.limitConcurrentUploads > 1) {
                    j = b.Deferred();
                    this._slots.push(j);
                    d = j.pipe(f)
                } else {
                    this._sequence = this._sequence.pipe(f, f);
                    d = this._sequence
                }
                d.abort = function () {
                    c = [undefined, "abort", "abort"];
                    if (!k) {
                        if (j) {
                            j.rejectWith(l.context, c)
                        }
                        return f()
                    }
                    return k.abort()
                };
                return this._enhancePromise(d)
            }
            return f()
        },
        _onAdd: function (q, m) {
            var p = this, v = true, u = b.extend({}, this.options, m), f = m.files, s = f.length, g = u.limitMultiFileUploads, k = u.limitMultiFileUploadSize, t = u.limitMultiFileUploadSizeOverhead, o = 0, n = this._getParamName(u), d, c, r, l, h = 0;
            if (!s) {
                return false
            }
            if (k && f[0].size === undefined) {
                k = undefined
            }
            if (!(u.singleFileUploads || g || k) || !this._isXHRUpload(u)) {
                r = [f];
                d = [n]
            } else {
                if (!(u.singleFileUploads || k) && g) {
                    r = [];
                    d = [];
                    for (l = 0; l < s; l += g) {
                        r.push(f.slice(l, l + g));
                        c = n.slice(l, l + g);
                        if (!c.length) {
                            c = n
                        }
                        d.push(c)
                    }
                } else {
                    if (!u.singleFileUploads && k) {
                        r = [];
                        d = [];
                        for (l = 0; l < s; l = l + 1) {
                            o += f[l].size + t;
                            if (l + 1 === s || ((o + f[l + 1].size + t) > k) || (g && l + 1 - h >= g)) {
                                r.push(f.slice(h, l + 1));
                                c = n.slice(h, l + 1);
                                if (!c.length) {
                                    c = n
                                }
                                d.push(c);
                                h = l + 1;
                                o = 0
                            }
                        }
                    } else {
                        d = n
                    }
                }
            }
            m.originalFiles = f;
            b.each(r || f, function (e, i) {
                var j = b.extend({}, m);
                j.files = r ? i : [i];
                j.paramName = d[e];
                p._initResponseObject(j);
                p._initProgressObject(j);
                p._addConvenienceMethods(q, j);
                v = p._trigger("add", b.Event("add", {delegatedEvent: q}), j);
                return v
            });
            return v
        },
        _replaceFileInput: function (f) {
            var c = f.fileInput, d = c.clone(true), e = c.is(document.activeElement);
            f.fileInputClone = d;
            b("<form></form>").append(d)[0].reset();
            c.after(d).detach();
            if (e) {
                d.focus()
            }
            b.cleanData(c.unbind("remove"));
            this.options.fileInput = this.options.fileInput.map(function (g, h) {
                if (h === c[0]) {
                    return d[0]
                }
                return h
            });
            if (c[0] === this.element[0]) {
                this.element = d
            }
        },
        _handleFileTreeEntry: function (h, j) {
            var e = this, i = b.Deferred(), d = function (l) {
                if (l && !l.entry) {
                    l.entry = h
                }
                i.resolve([l])
            }, f = function (l) {
                e._handleFileTreeEntries(l, j + h.name + "/").done(function (m) {
                    i.resolve(m)
                }).fail(d)
            }, g = function () {
                k.readEntries(function (l) {
                    if (!l.length) {
                        f(c)
                    } else {
                        c = c.concat(l);
                        g()
                    }
                }, d)
            }, k, c = [];
            j = j || "";
            if (h.isFile) {
                if (h._file) {
                    h._file.relativePath = j;
                    i.resolve(h._file)
                } else {
                    h.file(function (l) {
                        l.relativePath = j;
                        i.resolve(l)
                    }, d)
                }
            } else {
                if (h.isDirectory) {
                    k = h.createReader();
                    g()
                } else {
                    i.resolve([])
                }
            }
            return i.promise()
        },
        _handleFileTreeEntries: function (c, e) {
            var d = this;
            return b.when.apply(b, b.map(c, function (f) {
                return d._handleFileTreeEntry(f, e)
            })).pipe(function () {
                return Array.prototype.concat.apply([], arguments)
            })
        },
        _getDroppedFiles: function (d) {
            d = d || {};
            var c = d.items;
            if (c && c.length && (c[0].webkitGetAsEntry || c[0].getAsEntry)) {
                return this._handleFileTreeEntries(b.map(c, function (f) {
                    var e;
                    if (f.webkitGetAsEntry) {
                        e = f.webkitGetAsEntry();
                        if (e) {
                            e._file = f.getAsFile()
                        }
                        return e
                    }
                    return f.getAsEntry()
                }))
            }
            return b.Deferred().resolve(b.makeArray(d.files)).promise()
        },
        _getSingleFileInputFiles: function (e) {
            e = b(e);
            var c = e.prop("webkitEntries") || e.prop("entries"), d, f;
            if (c && c.length) {
                return this._handleFileTreeEntries(c)
            }
            d = b.makeArray(e.prop("files"));
            if (!d.length) {
                f = e.prop("value");
                if (!f) {
                    return b.Deferred().resolve([]).promise()
                }
                d = [{name: f.replace(/^.*\\/, "")}]
            } else {
                if (d[0].name === undefined && d[0].fileName) {
                    b.each(d, function (g, h) {
                        h.name = h.fileName;
                        h.size = h.fileSize
                    })
                }
            }
            return b.Deferred().resolve(d).promise()
        },
        _getFileInputFiles: function (c) {
            if (!(c instanceof b) || c.length === 1) {
                return this._getSingleFileInputFiles(c)
            }
            return b.when.apply(b, b.map(c, this._getSingleFileInputFiles)).pipe(function () {
                return Array.prototype.concat.apply([], arguments)
            })
        },
        _onChange: function (f) {
            var c = this, d = {fileInput: b(f.target), form: b(f.target.form)};
            this._getFileInputFiles(d.fileInput).always(function (e) {
                d.files = e;
                if (c.options.replaceFileInput) {
                    c._replaceFileInput(d)
                }
                if (c._trigger("change", b.Event("change", {delegatedEvent: f}), d) !== false) {
                    c._onAdd(f, d)
                }
            })
        },
        _onPaste: function (f) {
            var c = f.originalEvent && f.originalEvent.clipboardData && f.originalEvent.clipboardData.items, d = {files: []};
            if (c && c.length) {
                b.each(c, function (e, h) {
                    var g = h.getAsFile && h.getAsFile();
                    if (g) {
                        d.files.push(g)
                    }
                });
                if (this._trigger("paste", b.Event("paste", {delegatedEvent: f}), d) !== false) {
                    this._onAdd(f, d)
                }
            }
        },
        _onDrop: function (g) {
            g.dataTransfer = g.originalEvent && g.originalEvent.dataTransfer;
            var c = this, f = g.dataTransfer, d = {};
            if (f && f.files && f.files.length) {
                g.preventDefault();
                this._getDroppedFiles(f).always(function (e) {
                    d.files = e;
                    if (c._trigger("drop", b.Event("drop", {delegatedEvent: g}), d) !== false) {
                        c._onAdd(g, d)
                    }
                })
            }
        },
        _onDragOver: a("dragover"),
        _onDragEnter: a("dragenter"),
        _onDragLeave: a("dragleave"),
        _initEventHandlers: function () {
            if (this._isXHRUpload(this.options)) {
                this._on(this.options.dropZone, {
                    dragover: this._onDragOver,
                    drop: this._onDrop,
                    dragenter: this._onDragEnter,
                    dragleave: this._onDragLeave
                });
                this._on(this.options.pasteZone, {paste: this._onPaste})
            }
            if (b.support.fileInput) {
                this._on(this.options.fileInput, {change: this._onChange})
            }
        },
        _destroyEventHandlers: function () {
            this._off(this.options.dropZone, "dragenter dragleave dragover drop");
            this._off(this.options.pasteZone, "paste");
            this._off(this.options.fileInput, "change")
        },
        _setOption: function (c, d) {
            var e = b.inArray(c, this._specialOptions) !== -1;
            if (e) {
                this._destroyEventHandlers()
            }
            this._super(c, d);
            if (e) {
                this._initSpecialOptions();
                this._initEventHandlers()
            }
        },
        _initSpecialOptions: function () {
            var c = this.options;
            if (c.fileInput === undefined) {
                c.fileInput = this.element.is('input[type="file"]') ? this.element : this.element.find('input[type="file"]')
            } else {
                if (!(c.fileInput instanceof b)) {
                    c.fileInput = b(c.fileInput)
                }
            }
            if (!(c.dropZone instanceof b)) {
                c.dropZone = b(c.dropZone)
            }
            if (!(c.pasteZone instanceof b)) {
                c.pasteZone = b(c.pasteZone)
            }
        },
        _getRegExp: function (e) {
            var d = e.split("/"), c = d.pop();
            d.shift();
            return new RegExp(d.join("/"), c)
        },
        _isRegExpOption: function (c, d) {
            return c !== "url" && b.type(d) === "string" && /^\/.*\/[igm]{0,3}$/.test(d)
        },
        _initDataAttributes: function () {
            var d = this, c = this.options, e = this.element.data();
            b.each(this.element[0].attributes, function (g, f) {
                var h = f.name.toLowerCase(), i;
                if (/^data-/.test(h)) {
                    h = h.slice(5).replace(/-[a-z]/g, function (j) {
                        return j.charAt(1).toUpperCase()
                    });
                    i = e[h];
                    if (d._isRegExpOption(h, i)) {
                        i = d._getRegExp(i)
                    }
                    c[h] = i
                }
            })
        },
        _create: function () {
            this._initDataAttributes();
            this._initSpecialOptions();
            this._slots = [];
            this._sequence = this._getXHRPromise(true);
            this._sending = this._active = 0;
            this._initProgressObject(this);
            this._initEventHandlers()
        },
        active: function () {
            return this._active
        },
        progress: function () {
            return this._progress
        },
        add: function (d) {
            var c = this;
            if (!d || this.options.disabled) {
                return
            }
            if (d.fileInput && !d.files) {
                this._getFileInputFiles(d.fileInput).always(function (e) {
                    d.files = e;
                    c._onAdd(null, d)
                })
            } else {
                d.files = b.makeArray(d.files);
                this._onAdd(null, d)
            }
        },
        send: function (g) {
            if (g && !this.options.disabled) {
                if (g.fileInput && !g.files) {
                    var e = this, c = b.Deferred(), h = c.promise(), d, f;
                    h.abort = function () {
                        f = true;
                        if (d) {
                            return d.abort()
                        }
                        c.reject(null, "abort", "abort");
                        return h
                    };
                    this._getFileInputFiles(g.fileInput).always(function (i) {
                        if (f) {
                            return
                        }
                        if (!i.length) {
                            c.reject();
                            return
                        }
                        g.files = i;
                        d = e._onSend(null, g);
                        d.then(function (j, l, k) {
                            c.resolve(j, l, k)
                        }, function (j, l, k) {
                            c.reject(j, l, k)
                        })
                    });
                    return this._enhancePromise(h)
                }
                g.files = b.makeArray(g.files);
                if (g.files.length) {
                    return this._onSend(null, g)
                }
            }
            return this._getXHRPromise(false, g && g.context)
        }
    })
})(jQuery);

$.fn.emapFormInputInit = function (opt) {
    WIS_EMAP_INPUT.init($(this), opt);
};

(function (WIS_EMAP_INPUT, undefined) {
  /**
   * @module WIS_EMAP_INPUT
   * @alias 表单控件公共方法
   * @description WIS_EMAP_INPUT是一个封装了常用表单组件方法的全局对象，表单控件是以标签上的xtype属性作为控件类型的标识符，
   * 所有带有xtype属性的标签都认为是一个表单控件，以data-name属性为字段name 的标识符
   * @example
   WIS_EMAP_INPUT.init($form, {root: '/emap'})
   */


  /**
   * @method init
   * @description 表单控件初始化
   * @param {Object} element - 要实例化的控件占位DOM, 可以是单个控件占位或者表单外框
   * @param {Object=} opt - 表单控件options 对象
   * @example
   * WIS_EMAP_INPUT.init($container, {});
   */
  WIS_EMAP_INPUT.init = function (element, opt) {
    //控件初始化
    opt = opt || {};
    var options = $.extend({}, {
      'root': ''
    }, opt);
    if ($(element).attr('xtype')) {
      if ($(element).hasClass('bh-form-static') || $(element).attr('data-disabled') === true || $(element).attr('data-disabled') === 'true') {
        var readonly = WIS_EMAP_INPUT.component[$(element).attr('xtype')].readonly
        if (readonly) {
          inputInit(element, options, 'readonly');
        }
        return;
      } // 静态展示字段不做实例化
      inputInit(element, options);
    } else {
      opt._inputInitCount = 0;
      opt._inputInitCounter = 0;
      $(element).find('[xtype]').each(function () {
        if ($(this).hasClass('bh-form-static') || $(this).attr('data-disabled') === true || $(this).attr('data-disabled') === 'true' || (this.nodeName == 'TEXTAREA' && this.hasAttribute('readOnly'))) {
          if (WIS_EMAP_INPUT.component[$(this).attr('xtype')]['readonly']) {
            inputInit(this, options, 'readonly');
          } else {
            return true;
          }
        } else {
          // checkboxlist  radiolist 使用了jqx.dataAdapter 是同步请求渲染，不算在异步计数内
          if ($.inArray($(this).attr('xtype'), ['buttonlist', 'multi-buttonlist', 'uploadfile', 'uploadsingleimage', 'uploadmuiltimage']) > -1) {
            opt._inputInitCount++;
          }
          inputInit(this, options);
        }
      });
      if (opt._inputInitCount === 0) {
        // 当表单内不存在异步渲染的控件时
        $(element).trigger('_init');
      } else {
        $(element).on('bhInputInitComplete', function () {
          opt._inputInitCounter++;
          if (opt._inputInitCounter == opt._inputInitCount) {
            $(this).trigger('_init');
          }
        });
      }
    }

    function inputInit(ele, options, method) {
      var _this = $(ele);
      var attr = _this.data('attr');
      var jsonParam = {};
      if (attr) {
        jsonParam = attr.JSONParam || {};
      }else{
        jsonParam = _this.data('jsonparam') || {};
      }
      var metd = method || 'init';
      if (typeof jsonParam == 'string') {
        try {
          jsonParam = JSON.parse(jsonParam.replace(/'/g, '"'));
        } catch (e) {
          console && console.warn('无效的json param格式!');
          jsonParam = {};
        }
      }

      var inputParam = options.defaultOptions ? (options.defaultOptions[_this.attr('xtype')] || {}) : {};
      // 对 itemOptions 的处理
      if (options.itemOptions && options.itemOptions[_this.data('name')]) {
        $.extend(inputParam, options.itemOptions[_this.data('name')]);
      }
      var params = $.extend({}, inputParam, jsonParam);
      var xtype = _this.attr('xtype') || 'text';
      if (!WIS_EMAP_INPUT.component[xtype]) {
        return console && console.error(xtype + '控件类型未定义！');
      }
      WIS_EMAP_INPUT.component[xtype][metd](_this, params, options);
    }
  };

  /**
   * @method setValue
   * @description 表单控件赋值
   * @param {Object} element - 需要初始化的控件DOM
   * @param {String} name - 字段的name
   * @param {String} xtype - 控件类型
   * @param {Object} val - 数据对象 如 {WID: 123}
   * @param {String} root - emap跟路径, 上传控件时必传
   * @example
   * WIS_EMAP_INPUT.setValue($itemElement, 'WID', 'text', {WID: '123456', ''})
   */
  WIS_EMAP_INPUT.setValue = function (element, name, xtype, val, root) {
    var _this = $(element);
    if (!name) {
      name = _this.data('name');
    }

    if (xtype == "undefined") xtype = "text";
    xtype = xtype || 'text';
    WIS_EMAP_INPUT.component[xtype].setValue(element, name, val, root);
  };

  /**
   * @method formSetValue
   * @description 表单赋值
   * @param {Object} element - 表单容器
   * @param {Object} val - 数据对象  如 {WID: 123}
   * @param {Object} options - 表单的options对象
   * @example
   * WIS_EMAP_INPUT.formSetValue($container, {
   *      'WID': '123456',
   *      'XB': '1',
   *      'XB_DISPLAY': '男'
   * })
   */
  WIS_EMAP_INPUT.formSetValue = function (element, val, options) {
    var $element = $(element);
    if (options && options.readonly) {
      // 只读表单
      $element.find('[xtype]').each(function () {
        var name = $(this).data('name');
        var _this = $(this);
        var nameDisplay = null;
        if (val[name] !== undefined && val[name] !== null) {
          switch ($(this).attr('xtype')) {
          case 'multi-select':
          case 'select':
          case 'multi-select2':
            if (val[name + '_DISPLAY']) {
              setItemVal(val[name + '_DISPLAY'], val[name]);
            } else {
              var valueArr = val[name].split(',');
              var nameArr = [];
              if (_this.data('attr') && _this.data('attr').optionData) {
                var option_data = _this.data('attr').optionData;
                if (option_data) {
                  if (typeof option_data === 'string') {
                    try {
                      option_data = JSON.parse(option_data);
                    } catch (e) {
                      conosle && console.error('非法的 optionData json 格式！！')
                    }
                  }
                  $(option_data).each(function () {
                    if ($.inArray(this.id, valueArr) > -1) {
                      nameArr.push(this.name);
                    }
                  });
                  setItemVal(nameArr.join(','), val[name]);
                } else {
                  option_data = WIS_EMAP_SERV.cloneObj(option_data)
                }
              } else {
                if (!_this.data("url")) return console && console.error('缺少url配置');
                WIS_EMAP_INPUT.getInputOptions(_this.data("url"), function (res) {
                  _this.data('model', res);

                  $(res).each(function () {
                    if ($.inArray(this.id, valueArr) > -1) {
                      nameArr.push(this.name);
                    }
                  });
                  setItemVal(nameArr.join(','), val[name]);
                });
              }
            }
            break;
          case 'radiolist':
            if (val[name + '_DISPLAY']) {
              setItemVal(val[name + '_DISPLAY'], val[name]);
            } else {
              WIS_EMAP_INPUT.getInputOptions(_this.data("url"), function (res) {
                _this.data('model', res);
                $(res).each(function () {
                  if (this.id == val[name]) {
                    nameDisplay = this.name;
                    return false;
                  }
                });
              });
            }
            break;

          case 'checkboxlist':
            if (val[name + '_DISPLAY']) {
              setItemVal(val[name + '_DISPLAY'], val[name]);
            } else {
              WIS_EMAP_INPUT.getInputOptions(_this.data("url"), function (res) {
                _this.data('model', res);
                var valueArr = val[name].split(',');
                var nameArr = [];
                $(res).each(function () {
                  if ($.inArray(this.id, valueArr) > -1) {
                    nameArr.push(this.name);
                  }
                });
                setItemVal(nameArr.join(','), val[name]);
              });
            }

            break;
          case 'tree':
            if (val[name + '_DISPLAY']) {
              setItemVal(val[name + '_DISPLAY'], val[name]);
            } else {
              WIS_EMAP_INPUT.getInputOptions(_this.data("url"), function (res) {
                _this.data('model', res);
                var valueArr = val[name].split(',');
                var nameArr = [];
                $(res).each(function () {
                  if ($.inArray(this.id, valueArr) > -1) {
                    nameArr.push(this.name);
                  }
                });
                setItemVal(nameArr.join(','), val[name]);
              });
            }
            break;
          case 'uploadfile':
            $(this).emapFileDownload('destroy');
            $(this).emapFileDownload($.extend({}, {
              contextPath: options.root,
              token: val[name],
            }, JSON.parse(
              decodeURI($(this).data('jsonparam')).replace(/"/g, '').replace(/'/g, '"')
            )));
            break;
          case 'uploadsingleimage':
          case 'uploadmuiltimage':
            $(this).emapFileDownload('destroy');
            $(this).emapFileDownload($.extend({}, {
              model: 'image',
              contextPath: options.root,
              token: val[name]
            }, JSON.parse(
              decodeURI($(this).data('jsonparam')).replace(/"/g, '').replace(/'/g, '"')
            )));
            break;
          case 'uploadphoto':
            $(this).emapFilePhoto('destroy');
            $(this).emapFilePhoto($.extend({}, {
              token: val[name],
              contextPath: options.root
            }, JSON.parse(
              decodeURI($(this).data('jsonparam')).replace(/"/g, '').replace(/'/g, '"')
            )));
            $('a', this).hide();
            break;
          case 'cache-upload':
            $(this).cacheUpload('destroy');
            $(this).cacheUpload($.extend({}, {
              token: val[name],
              readonly: true,
            }, JSON.parse(
              decodeURI($(this).data('jsonparam')).replace(/"/g, '').replace(/'/g, '"')
            )));
            break;
          case 'switcher':
            val[name + '_DISPLAY'] = parseInt(val[name]) ? '是' : '否';
            setItemVal(val[name + '_DISPLAY'], val[name]);
            break;
          case 'textarea':
            setItemVal(val[name], _this.data('attr'));
            _this.trigger('input')
          break;
          default:
            // 存在自定义组件含有字典值的情况
            if (val[name + '_DISPLAY'] !== undefined) {
              setItemVal(val[name + '_DISPLAY'], val[name], _this.data('attr'));
            } else {
              setItemVal(val[name], _this.data('attr'));
            }
          }
        }

        function setItemVal(val_dis, val, attr) {
          if (val_dis != null) {
            _this.text(val_dis).attr('title', val_dis).data('value', val);
          } else if (attr) {
            var option_data = attr.optionData;
            var valueArr = val.split(',');
            var nameArr = [];
            if (option_data) {
              if (typeof option_data === 'string') {
                try {
                  option_data = JSON.parse(option_data);
                } catch (e) {
                  return console && console.error('无效的optionData json 格式！！');
                }
              } else {
                option_data = WIS_EMAP_SERV.cloneObj(option_data);
              }

              $(option_data).each(function () {
                if ($.inArray(this.id, valueArr) > -1) {
                  nameArr.push(this.name);
                }
              });
              var renderMethod = WIS_EMAP_CONFIG.xssSafeRender ? 'text' : 'html';
              _this[renderMethod](nameArr.join(',')).attr('title', nameArr.join(',')).data('value', val[name]);
            }
          }
        }
      });
      options.formValue = options.formValue || {};
      $.extend(options.formValue, val);
    } else {
      // 编辑表单
      $element.find('[xtype]').each(function () {
        var name = $(this).data('name');
        var _this = $(this);
        var xtype = _this.attr('xtype');
        var renderMethod = WIS_EMAP_CONFIG.xssSafeRender ? 'text' : 'html';
        //qiyu 2016-1-2 清空表单时，传入字段值为空，需要重置该控件
        //qiyu 2016-3-17 清空表单请使用clear方法，以下这句话将被注释掉
        //if (val[name] == null) {val[name] = ""}

        // 为表格表单中的 只读字段赋值 & 只读的textarea赋值
        // if (options && options.model == 't') {
        if (_this.hasClass('bh-form-static') || _this.attr('xtype') == 'static') {
          if (val[name] != null) {
            if (val[name + '_DISPLAY'] !== undefined && val[name + '_DISPLAY'] !== null) {

              _this[renderMethod](val[name + '_DISPLAY']).attr('title', val[name + '_DISPLAY']).data('value', val[name]);
            } else {
              if (_this.data('attr') && _this.data('attr').optionData) {
                var option_data = _this.data('attr').optionData;
                var valueArr = val[name].toString().split(',');
                var nameArr = [];
                if (option_data) {
                  if (typeof option_data === 'string') {
                    try {
                      option_data = JSON.parse(option_data);
                    } catch (e) {
                      return console && console.error('无效的optionData json 格式！！');
                    }
                  } else {
                    option_data = WIS_EMAP_SERV.cloneObj(option_data);
                  }
                  $(option_data).each(function () {
                    if ($.inArray(this.id + '', valueArr) > -1) {
                      nameArr.push(this.name);
                    }
                  });
                  _this[renderMethod](nameArr.join(',')).attr('title', nameArr.join(',')).data('value', val[name]);
                }
              } else {
                _this[renderMethod](val[name]).attr('title', val[name]).data('value', val[name]);
              }
            }
          }
          return;
        } else if (_this.attr('xtype') == 'textarea' && _this.attr('readonly')) {
          if (val[name] != null) {
            var v = WIS_EMAP_CONFIG.xssSafeRender ? val[name] : BH_UTILS.uxss(val[name]);
            _this.val(v);
            _this.data('value',v);
          }
          return;
        }

        // }


        if (val === undefined) {

        } else if (val[name] !== undefined && val[name] !== null) {
          options = options || {}
          WIS_EMAP_INPUT.setValue(_this, name, xtype, val, options.root || "");
        }
      });
    }
  };

  /**
   * @method getInputOptions
   * @description 获取表单选项数据
   * @param {String} url - 请求地址
   * @param {function} callback - 请求成功的回调函数
   * @description
   * WIS_EMAP_INPUT.getInputOptions($item.data('url'), function (res) {
   *      $item.jqxDropdownList({source: res});
   * })
   */
  WIS_EMAP_INPUT.getInputOptions = function (url, callback) {
    // var dataAdapter = new $.jqx.dataAdapter({
    //     url: url,
    //     datatype: "json",
    //     //async: false,
    //     root: "datas>code>rows"
    // }, {
    //     loadComplete: function(records) {
    //         callback(records.datas.code.rows);
    //     }
    // });

    //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
    var source = {
      url: url,
      datatype: "json",
      //async: false,
      root: "datas>code>rows"
    }
    if (typeof window.MOCK_CONFIG != 'undefined') {
      source = getSourceMock(source);
    }
    var dataAdapter = new $.jqx.dataAdapter(source, {
      loadComplete: function (records) {
        callback(records.datas.code.rows);
      }
    });

    dataAdapter.dataBind();
  };

  /**
   * @method formClear
   * @description 表单附件清空,如果不传参数val，则清空表单中所有值; 如果传入参数是个数组，则清空该数组中为字段名称的控件值
   * @param {Object} element - 表单容器DOM
   * @param {String | Array} [val] - 需要清空的字段name,若不传则清空容器内所有的字段
   * @param {Object} [options] - 表单options参数
   * @example
   * WIS_EMAP_INPUT.formClear($container, ['WID', 'XM', 'XH'])
   */
  WIS_EMAP_INPUT.formClear = function (element, val, options) {
    var $element = $(element);
    options = options || {};
    if (options && options.readonly) { // clear只读表单
      if (val == undefined) {
        $element.find('[xtype]').each(function () {
          $(this).html("");
        });
        options.formValue = {};

      } else {
        for (var i = 0; i < val.length; i++) {
          $element.find('[data-name=' + val[i] + '][xtype]').html("");
          options.formValue[val[i]] = "";
        }
      }
    } else {
      if (val === undefined) {
        $element.find('[xtype]').each(function () {
          var name = $(this).data('name');
          var xtype = $(this).attr('xtype');
          var _this = $(this);
          WIS_EMAP_INPUT.setValue(_this, name, xtype, "", options.root);
        });
      } else {
        for (var i = 0; i < val.length; i++) {
          var name = val[i];
          var _this = $element.find('[data-name=' + name + '][xtype]');
          var xtype = _this.attr('xtype');
          var blank_val = {};
          blank_val[name] = "";
          WIS_EMAP_INPUT.setValue(_this, name, xtype, blank_val, options.root);
        }
      }
    }
  };

  /**
   * @method formGetValue
   * @description 表单取值
   * @param {Object} element - 表单容器DOM
   * @param {Object} [options] - 表单options对象
   * @returns {Object} 表单数据JSON对象
   * @example
   * WIS_EMAP_INPUT.formGetValue($container);
   */
  WIS_EMAP_INPUT.formGetValue = function (element, options) {
    var $element = $(element);
    var formData;
    if (options && options.readonly) {
      formData = options.formValue || {};
      options.data.map(function (item) {
        if (formData[item.name] === undefined) {
          formData[item.name] = '';
        }
      });
      return formData;
    } else {
      formData = {};
      $element.find('[xtype]').each(function () {
        var itemVal = "";

        // 表格表单静态展示项
        if ($(this).hasClass('bh-form-static') || ($(this).attr('readOnly') && $(this).attr('xtype') === 'textarea')) {

          if ($.inArray($(this).attr('xtype'), ['radiolist', 'checkboxlist', 'tree', 'multi-select', 'select']) > -1) {
            formData[$(this).data('name') + "_DISPLAY"] = $(this).text();
            itemVal = $(this).data('value');
          } else {
            itemVal = $(this).data('value');
          }
        } else {
          itemVal = WIS_EMAP_INPUT.component[$(this).attr('xtype')].getValue($(this), formData);
        }

        formData[$(this).data('name')] = itemVal;
      });
      return formData;
    }
  };

  /**
   * @method getValue
   * @description 表单项控件取值
   * @param {Object} ele - 表单项控件DOM
   * @param {Object} [formData] - 用于存放控件_DISPLAY 值的对象，若字段取值是字典，则将_DISPLAY值写到改对象上
   * @returns {Object} 表单数据JSON对象
   * @example
   * var formData = {};
   * WIS_EMAP_INPUT.getValue($item, formData);
   */
  WIS_EMAP_INPUT.getValue = function (ele, formData) {
    if (!$(ele).length) return console && console.error('WIS_EMAP_INPUT.getValue 方法 ele参数不能为空');
    var xtype = $(ele).attr('xtype') || 'text';
    var itemVal = "";
    // 表格表单静态展示项
    if ($(ele).hasClass('bh-form-static') || ($(ele).attr('readOnly') && $(ele).attr('xtype') === 'textarea')) {

      if ($.inArray($(ele).attr('xtype'), ['radiolist', 'checkboxlist', 'tree', 'multi-select', 'select']) > -1) {
        formData[$(ele).data('name') + "_DISPLAY"] = $(ele).text();
        itemVal = $(ele).data('value');
      } else {
        itemVal = $(ele).data('value');
      }
    } else {
      itemVal = WIS_EMAP_INPUT.component[$(ele).attr('xtype')].getValue($(ele), formData);
    }
    return itemVal === undefined ? '' : itemVal;
  }

  /**
   * @method disable
   * @description 表单控件 disable
   * @param {Object} element - 控件DOM
   * @example
   * WIS_EMAP_INPUT.disable($('[data-name="WID"]'))
   */
  WIS_EMAP_INPUT.disable = function (element) {
    if (!element || $(element).length == 0) {
      console && console.warn('Can not find field ');
      return;
    }
    var item = $(element);
    WIS_EMAP_INPUT.component[item.attr('xtype')].disable(item);
    var formGroup = item.closest('.bh-form-group');
    if (formGroup.length) {
      formGroup.addClass('bh-disabled');
    }
  };

  /**
   * @method formDisable
   * @description 表单disable
   * @param {Object} element - 表单DOM
   * @param {String | Array} [names] - 需要disable的字段name, 若不传则禁用表单中所有字段
   * @example
   * WIS_EMAP_INPUT.formDisable($container, ['WID', 'XB'])
   */
  WIS_EMAP_INPUT.formDisable = function (element, names) {
    if (!names) {
      // 禁用整个表单
      $('[xtype]', $(element)).each(function () {
        WIS_EMAP_INPUT.disable(this);
      });
    } else if (names instanceof Array) {
      // 多字段禁用
      names.map(function (item) {
        var inputElement = $('[data-name=' + item + ']', $(element));
        if (inputElement.length == 0) {
          console && console.warn('Can not find field ' + item);
          return;
        }
        WIS_EMAP_INPUT.disable(inputElement);
      });
    } else {
      // 单字段禁用
      var inputElements = $('[data-name=' + names + ']', $(element));
      if (inputElements.length == 0) {
        console && console.warn('Can not find field ' + names);
        return;
      }
      inputElements.each(function () {
        WIS_EMAP_INPUT.disable(this);
      });
    }
  };

  /**
   * @method enable
   * @description 表单控件enable
   * @param {Object} element - 控件DOM
   * @example
   * WIS_EMAP_INPUT.enable($('[data-name="WID"]'))
   */
  WIS_EMAP_INPUT.enable = function (element) {
    if (!element || $(element).length == 0) {
      console && console.warn('Can not find field ');
      return;
    }
    var item = $(element);
    WIS_EMAP_INPUT.component[item.attr('xtype')].enable(item);
    var formGroup = item.closest('.bh-form-group');
    if (formGroup.length) {
      formGroup.removeClass('bh-disabled');
    }
  };

  /**
   * @method formEnable
   * @description 表单enable
   * @param {Object} element - 表单DOM
   * @param {String | Array} [names] - 需要enable的字段name, 若不传则启用表单中所有字段
   * @example
   *  WIS_EMAP_INPUT.formEnable($container, ['WID', 'XB', 'NL'])
   */
  WIS_EMAP_INPUT.formEnable = function (element, names) {
    if (!names) {
      // 启用整个表单
      $('[xtype]', $(element)).each(function () {
        WIS_EMAP_INPUT.enable(this);
      });
    } else if (names instanceof Array) {
      // 多字段启用
      names.map(function (item) {
        var inputElement = $('[data-name=' + item + ']', $(element));
        if (inputElement.length == 0) {
          console && console.warn('Can not find field ' + item);
          return;
        }
        WIS_EMAP_INPUT.enable(inputElement);
      });
    } else {
      // 单字段启用
      var inputElements = $('[data-name=' + names + ']', $(element));
      if (inputElements.length == 0) {
        console && console.warn('Can not find field ' + names);
        return;
      }
      inputElements.each(function () {
        WIS_EMAP_INPUT.enable(this);
      });
    }
  };

  /**
   * @method renderPlaceHolder
   * @description 根据数据模型项渲染单个字段的placeholder
   * @param {Object} item - 字段数据模型
   * @param {String} type - 取值类型，可选值： 'form' 'search' 'grid';
   * @param {Object} [params] - 其他参数
   * @param {Boolean} [params.showPlaceholder=false] - 是否添加placeHolder
   * @returns {string}
   * @example
   * WIS_EMAP_INPUT.renderPlaceHolder({
   *      xtype: 'text',
   *      name: 'WID',
   *      caption: '编号'
   * })
   */
  WIS_EMAP_INPUT.renderPlaceHolder = function (item, type, params) {
    var attr = WIS_EMAP_SERV.getAttr(item, type);
    var pam = params || {};
    if (attr.inputReadonly && !WIS_EMAP_INPUT.component[attr.xtype]['readonly']) {
      if ($.inArray(attr.xtype, ['uploadfile', 'uploadsingleimage', 'uploadmuiltimage', 'cache-upload', 'direct-upload']) == -1) {
        attr.xtype = "static";
      }
    }
    var controlHtml = "";
    switch (attr.xtype) {
    case undefined:
    case "text":
      attr.xtype = "text";
      controlHtml = '<input class="bh-form-control" data-caption="{{caption}}" data-type="{{dataType}}" data-name="{{name}}" name="{{name}}" xtype="{{xtype}}" type="{{xtype}}" {{checkType}} {{JSONParam}}  {{dataSize}} {{checkSize}} {{checkExp}} ' + (attr.inputReadonly ? 'readOnly' : '') + ' ' + (pam.showPlaceholder ? 'placeholder="' + attr.placeholder + '"' : '') + ' />';
      break;
    case "textarea":
      controlHtml = '<div xtype="{{xtype}}" data-caption="{{caption}}" data-type="{{dataType}}" data-name="{{name}}" {{checkType}} {{dataSize}} {{checkSize}} {{checkExp}} {{JSONParam}} ' + (attr.inputReadonly ? 'readOnly' : '') + ' ></div>';
      break;
    case "radiolist":
      controlHtml = '<div xtype="{{xtype}}" data-caption="{{caption}}" data-type="{{dataType}}" class="bh-radio jqx-radio-group" data-name="{{name}}" {{url}} {{checkSize}} data-disabled={{inputReadonly}}></div>';
      break;
    case "checkboxlist":
      controlHtml = '<div xtype="{{xtype}}" data-caption="{{caption}}" data-type="{{dataType}}" class="bh-checkbox" data-name="{{name}}" {{checkType}} {{url}} {{checkSize}} data-disabled={{inputReadonly}}></div>';
      break;
    case "selecttable":
    case "select":
    case "multi-select2":
    case "tree":
    case "multi-tree":
    case "date-local":
    case "date-ym":
    case "date-full":
    case "date-range":
    case "date-area":
    case "switcher":
    case "uploadfile":
    case "uploadphoto":
    case "uploadsingleimage":
    case "uploadmuiltimage":
    case "buttonlist":
    case "multi-buttonlist":
    case "multi-select":
    case "div":
    case "static":
    case "number":
    case "number-range":
    default:
      controlHtml = '<div xtype="{{xtype}}" data-caption="{{caption}}" data-type="{{dataType}}" data-name="{{name}}" {{url}} {{format}} {{checkType}} {{JSONParam}} {{checkSize}} data-disabled={{inputReadonly}} ' +
        (pam.showPlaceholder ? 'data-placeholder="' + attr.placeholder + '"' : '') +
        '></div>';
      break;

    }
    controlHtml = controlHtml.replace(/\{\{xtype\}\}/g, attr.xtype)
      .replace(/\{\{name\}\}/g, attr.name)
      .replace(/\{\{dataType\}\}/g, attr.dataType)
      .replace(/\{\{inputReadonly\}\}/g, attr.inputReadonly)
      .replace(/\{\{caption\}\}/g, attr.caption);

    // 解决 $$ 在replace中被 转义为$ 的问题
    controlHtml = controlHtml.replace(/\{\{url\}\}/g, function () {
      return attr.url ? ('data-url="' + attr.url + '"') : '';
    });
    controlHtml = controlHtml.replace(/\{\{format\}\}/g, attr.format ? ('data-format="' + attr.format + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkType\}\}/g, attr.checkType ? ('data-checktype="' + encodeURI(attr.checkType) + '"') : '');
    controlHtml = controlHtml.replace(/\{\{dataSize\}\}/g, attr.dataSize ? ('data-size="' + attr.dataSize + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkSize\}\}/g, attr.checkSize ? ('data-checksize="' + attr.checkSize + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkExp\}\}/g, attr.checkExp ? ('data-checkexp=' + encodeURI(attr.checkExp)) : '');

    controlHtml = $(controlHtml);
    if (attr.optionData) { // optionData 为下拉项数据
      controlHtml.data('optiondata', attr.optionData);
    }
    if (attr.xtype == 'buttonlist' || attr.xtype == 'multi-buttonlist') {
      controlHtml.addClass('bh-label-radio-group');
    }

    controlHtml.data('jsonparam', attr.JSONParam);
    controlHtml.data('attr', attr);
    //处理表格模式下单元格高度不齐问题
    if (attr.xtype === 'switcher') {
      controlHtml.css('margin','2px 0');
    }
    return controlHtml;
  };


  /**
   * @method placeHolder
   * @description ie9下为文本框/文本域添加placeholder
   * @param {object} ele 包含文本框的DOM容器 或者 文本框DOM
   * @method {String} [method=] 执行的方法， 默认为fix， 可选值 resize 用于重新定位 placeHolder
   * @example WIS_EMAP_INPUT.placeHolder($container);
   */
  WIS_EMAP_INPUT.placeHolder = function (ele, method) {
    if (document.documentMode == 9) {
      if (!ele) return;

      if (method == 'resize') {
        if ($(ele)[0].nodeName == 'INPUT') {
          JPlaceHolder.resize($(ele).parent());
        } else {
          JPlaceHolder.resize(ele);
        }
        return
      }
      if ($(ele)[0].nodeName == 'INPUT' || $(ele)[0].nodeName == 'TEXTAREA') {
        JPlaceHolder.fix($(ele).parent());
      } else {
        JPlaceHolder.fix(ele);
      }
    }
  };

  /**
   * @method extend
   * @description 表单控件扩展方法
   * @param {Object} component - 需要注册的表单控件方法对象
   * @param {String} component.xtype - 表单控件的xtype
   * @param {String} component.init - 表单控件的实例化方法 function默认参数  ele, params
   * @param {String} component.setValue - 表单控件的赋值方法 function默认参数  ele, name, val, root
   * @param {String} component.getValue - 表单控件的取值方法 function默认参数  ele, formData
   * @param {String} component.disable - 表单控件的禁用方法 function默认参数  ele
   * @param {String} component.enable - 表单控件的启用方法 function默认参数  ele
   * @example
   * WIS_EMAP_INPUT.extend({
   *  xtype: 'xxx',
   *  init: function(ele, params) {},
   *  setValue: function(ele, name, val, root) {},
   *  getValue: function(ele, formData) {},
   *  disable: function(ele) {},
   *  enable: function(ele) {}
   * })
   */
  WIS_EMAP_INPUT.extend = function (component) {
    if (!component.xtype) return console && console.error('未指定自定义表单控件的xtype！');
    if (WIS_EMAP_INPUT.core[component.xtype]) return console && console.error('不能覆写表单默认控件类型' + compponent.xtype);
    WIS_EMAP_INPUT.component[component.xtype] = component;
  };

  /**
   * @memberof module:WIS_EMAP_INPUT
   * @description 表单控件注册对象
   * @prop {Object} select - 单选下拉，基于jqxDropdownList 封装
   * @prop {Object} multi-select2 - 多选下拉， 基于jqxDropdownList封装
   * @prop {Object} multi-select - 旧版多选下拉， 基于jqxCombobox封装，不推荐使用
   * @prop {Object} selecttable - 下拉表格/模糊搜索， 基于jqxCombobox封装
   * @prop {Object} date-ym - 年月选择框,基于jqxDateTimeInput封装， 默认 yyyy-MM
   * @prop {Object} date-local - 日期选择框,基于jqxDateTimeInput封装， 默认 yyyy-MM-dd
   * @prop {Object} date-full - 日期时间选择框,基于jqxDateTimeInput封装， 默认 yyyy-MM-dd HH:mm
   * @prop {Object} date-range - 日期范围选择, 只能在高级搜索中使用，基于jqxDateTimeInput封装， 默认 yyyy-MM-dd
   * @prop {Object} radiolist - 单选按钮组
   * @prop {Object} checkboxlist - 多选按钮组
   * @prop {Object} tree - 单选下拉树
   * @prop {Object} multi-tree - 多选下拉树
   * @prop {Object} switcher - 开关， 基于jqxSwitcheButton封装
   * @prop {Object} buttonlist - 单选按钮组
   * @prop {Object} multi-buttonlist - 多选按钮组
   * @prop {Object} textarea - 计数文本域，基于bhTxtInput封装
   * @prop {Object} number - 数字文本框，基于jqxNumberInput封装
   * @prop {Object} number-range - 数字区间，基于jqxNumberInput封装
   * @prop {Object} uploadfile - 文件上传，基于emapFileUpload封装
   * @prop {Object} uploadsingleimage - 单图片上传，基于emapSingleFileUpload封装
   * @prop {Object} uploadmuiltimage - 多图片上传，基于emapFileUpload封装
   * @prop {Object} text - 文本
   * @prop {Object} div - div占位
   * @prop {Object} static - 表单静态字段
   */
  WIS_EMAP_INPUT.core = {
    // 下拉框
    "select": {
      "init": _initSelect,
      "setValue": function (ele, name, val, root) {
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空字段
          ele.jqxDropDownList('clearSelection');
          return;
        }

        if (ele.jqxDropDownList('getItemByValue', val[name])) {
          _setSelectValue(ele, val[name]);
        } else {
          if (val[name + '_DISPLAY']) {
            ele.jqxDropDownList('addItem', {
              id: val[name],
              name: val[name + '_DISPLAY']
            });
            _setSelectValue(ele, val[name]);
          } else {
            loadSelectData(ele, undefined, undefined, undefined, function () {
              _setSelectValue(ele, val[name]);
            });
            // WIS_EMAP_INPUT.getInputOptions(ele.data("url"), function (res) {
            //     ele.jqxDropDownList('clear');
            //     $(res).each(function () {
            //         ele.jqxDropDownList('addItem', this);
            //     });
            //     _setSelectValue(ele, val[name]);
            //     ele.data('loaded', true);
            // });
          }
        }
      },
      "getValue": function (ele, formData) {
        /**
         * 已知 jqxDropdownList bug
         * 通过下拉的搜索筛选后，选择的下拉项在取值时可能会与实际显示值不一致，初步检查是由于jqxDropdownList的取值是根据下拉项的index来计算的，
         * 所以此处避免使用 getSelectedItem api
         */
        var value = ele.val()
        var name = ele.data('name')
        formData[name + "_DISPLAY"] = ''
        if (value !== '' && value !== undefined) {
          var source = ele.jqxDropDownList('getItems')
          if (source.length > 0) {
            var source_item = source.filter(function (item) {return item.value === value})[0]
            if (source_item) {
              formData[name + "_DISPLAY"] = source_item.label
            }
          }
        }
        return value
      },
      "disable": function (ele) {
        ele.jqxDropDownList({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxDropDownList({
          disabled: false
        });
      }
    },

    "multi-select2": {
      "init": _initSelect,
      "setValue": function (ele, name, val, root) {
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空字段
          ele.jqxDropDownList('uncheckAll');
          return;
        }
        var select2ValueArr = val[name].split(',');
        if (val[name + '_DISPLAY'] === undefined || val[name + '_DISPLAY'] === null) {
          WIS_EMAP_INPUT.getInputOptions(ele.data("url"), function (res) {
            if (!ele.data('loaded')) {
              $(res).each(function () {
                ele.jqxDropDownList('addItem', this);
              });
              ele.data('loaded', true);
            }

            select2ValueArr.map(function (val) {
              ele.jqxDropDownList('checkItem', val);
            })
          });
          return;
        }

        var select2DisplayArr = val[name + '_DISPLAY'].split(',');

        $(select2ValueArr).each(function (i) {
          if (ele.jqxDropDownList('getItemByValue', select2ValueArr[i])) {
            ele.jqxDropDownList('checkItem', select2ValueArr[i]);
          } else {
            ele.jqxDropDownList('addItem', {
              id: select2ValueArr[i],
              name: select2DisplayArr[i]
            });
            ele.jqxDropDownList('checkItem', select2ValueArr[i]);
          }
        });
      },
      "getValue": function (ele, formData) {
        var items = ele.jqxDropDownList('getCheckedItems');
        if (items && items.length > 0) {
          formData[ele.data('name') + "_DISPLAY"] = items.map(function (val) {
            return val.label;
          }).join(',');
        }
        return ele.val() === undefined ? "" : ele.val();
      },
      "disable": function (ele) {
        ele.jqxDropDownList({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxDropDownList({
          disabled: false
        });
      }
    },

    "multi-select": {
      "init": function (ele, params) {
        var _this = ele;
        //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
        var source = {
          url: _this.data("url"),
          datatype: "json",
          root: "datas>code>rows",
          beforeLoadComplete: function (records) {
            if (!_this.data('initdata')) {
              _this.data('initdata', records);
            }
            return records;
          },
          formatData: function (data) {
            data.pageSize = 10;
            data.pageNumber = 1;
            data.queryopt = JSON.stringify({
              "name": "name",
              "value": _this.jqxComboBox('searchString'),
              "builder": "include",
              "linkOpt": "AND"
            });
            return data;
          }
        };
        if (typeof window.MOCK_CONFIG != 'undefined') {
          source = getSourceMock(source);
        }
        var dataAdapter = new $.jqx.dataAdapter(source);
        var inputOptions = $.extend({}, {
          placeHolder: $.i18n('bh-eip-pleaseChoose'),
          source: dataAdapter,
          displayMember: "name",
          multiSelect: true,
          remoteAutoComplete: true,
          // autoDropDownHeight: true,
          enableBrowserBoundsDetection: true,
          valueMember: "id",
          minLength: 1,
          width: "100%",
          height: "26px",
          disabled: _this.data('disabled') ? true : false,
          search: function (searchString) {
            dataAdapter.dataBind();
          }
        }, params);
        _this.jqxComboBox(inputOptions)
          .on('keyup open', 'input.jqx-combobox-input', function () {
            var value = $(this).val();
            var items = _this.jqxComboBox('getItems');
            if (value == "" && (!items || items.length == 0)) {
              var initData = _this.data('initdata');
              $(initData).each(function () {
                _this.jqxComboBox('addItem', this);
              });
            }
          });
        _triggerFormChange(_this, 'select');
        dataAdapter.dataBind();
      },
      "setValue": function (ele, name, val, root) {
        if (val[name] === undefined || val[name] === null) {
          // 清空字段
          ele.jqxComboBox('clearSelection');
          return;
        }

        if (val[name + '_DISPLAY'] !== undefined && val[name + '_DISPLAY'] !== null) {
          var currentArr = ele.jqxComboBox('getItems').map(function (value) {
            return value.value;
          });
          var displayVal = val[name + '_DISPLAY'].split(',');
          val[name].split(',').map(function (v, i) {
            if ($.inArray(v, currentArr) < 0) {
              ele.jqxComboBox('addItem', {
                id: v,
                name: displayVal[i]
              });
            }
            ele.jqxComboBox('selectItem', v);
          });
        } else {
          if (val[name] === undefined || val[name] === null) {
            // 清空表单的情况
            ele.jqxComboBox('clearSelection');
          } else {
            WIS_EMAP_INPUT.getInputOptions(ele.data("url"), function (res) {
              ele.data('model', res);
              var valueArr = val[name].split(',');
              var currentArr = ele.jqxComboBox('getItems').map(function (val) {
                return val.value;
              });
              $(res).each(function () {
                if ($.inArray(this.id, valueArr) > -1) {
                  if ($.inArray(this.id, currentArr) < 0) {
                    ele.jqxComboBox('addItem', this);
                  }
                  ele.jqxComboBox('selectItem', this.id);
                }
              });
            });
          }
        }
      },
      "getValue": function (ele, formData) {
        var valueArray = [],
          displayArray = [];
        $(ele.jqxComboBox('getSelectedItems')).each(function () {
          valueArray.push(this.value);
          displayArray.push(this.label);
        });
        formData[ele.data('name') + "_DISPLAY"] = displayArray.join(',');
        return valueArray.join(',');
      },
      "disable": function (ele) {
        ele.jqxComboBox({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxComboBox({
          disabled: false
        });
      }
    },

    "selecttable": {
      "init": function (ele, params) {
        var inputOptions = $.extend({}, {
          url: ele.data('url'),
          width: '100%'
        }, params);
        ele.emapDropdownTable(inputOptions);
        _triggerFormChange(ele, 'select');
      },
      "setValue": function (ele, name, val, root) {
        ele.emapDropdownTable('setValue', [val[name], val[name + '_DISPLAY']]);
      },
      "getValue": function (ele, formData) {
        formData[ele.data('name') + '_DISPLAY'] = ele.emapDropdownTable('getText');
        return ele.emapDropdownTable('getValue');
        // return ele.val();
      },
      "disable": function (ele) {
        ele.jqxComboBox({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxComboBox({
          disabled: false
        });
      }
    },

    "date-ym": {
      "init": _initDateInput,
      "setValue": _setTextValue,
      "getValue": function (ele, formData) {
        return ele.val();
      },
      "disable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: false
        });
      }
    },

    "date-local": {
      "init": _initDateInput,
      "setValue": _setTextValue,
      "disable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: true
        });
      },
      "getValue": function (ele, formData) {
        return ele.val();
      },
      "enable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: false
        });
      }
    },

    "date-full": {
      "init": _initDateInput,
      "setValue": _setTextValue,
      "getValue": function (ele, formData) {
        return ele.val();
      },
      "disable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxDateTimeInput({
          disabled: false
        });
      }
    },

    "date-range": {
      "init": function (ele, params) {
        // range: {//可选，设置时间可选的范围
        //     max: 'today',  //可选，设置时间的最大可选范围，可传入'today'表示今天，或传入时间字符串，格式如'2015/02/05'
        //     min: '2015/02/05' //可选，设置时间的最小可选范围，可传入'today'表示今天，或传入时间字符串，格式如'2015/02/05'
        // },
        // time:{//可选，初始化时显示的时间范围
        //     start: '2015/01/05', //必填，时间字符串，格式如'2015/02/05'
        //     end: '2015/06/01'//必填，时间字符串，格式如'2015/02/05'
        // },
        // selected: function(startTime, endTime){ //可选，选择时间后的回调，返回的参数startTime是选择的开始时间，endTime是选择的结束时间，返回的是时间字符串格式如'2015/02/05'
        // }
        var inputOptions = $.extend({}, {
          format: ele.data('format')
        }, params);

        ele.bhTimePicker(inputOptions);

        // TODO 需要 _formChange 事件触发
      },
      "setValue": function (ele, name, val, root) {
        if (val === '' || val === undefined || val[name] === "") {
          ele.bhTimePicker('setType', 'all');
        } else {
          var val_arr = val[name].split(',');
          if (val_arr.length == 2) {
            ele.bhTimePicker('setType', 'custom');
            ele.bhTimePicker('setValue', {
              startTime: val_arr[0],
              endTime: val_arr[1]
            });
          }
        }
      },
      "getValue": function (ele, formData) {
        var rangeValue = ele.bhTimePicker('getValue');
        var sValue = (rangeValue.startTime || '') + ',' + (rangeValue.endTime || '');
        return sValue === ',' ? '' : sValue;
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },

    "radiolist": {
      "init": function (ele, params) {
        if (ele.data('init')) {
          return;
        }

        if (ele.data('optiondata')) {
          var option_data = ele.data('optiondata');
          if (typeof option_data == 'string') {
            try {
              option_data = JSON.parse(option_data);
            } catch (e) {
              console && console.error(_this.data('name') + 'optionData 格式错误, 必须是json格式');
            }
          } else {
            option_data = WIS_EMAP_SERV.cloneObj(option_data)
          }
          _renderHtml(option_data, ele);
          return
        }

        //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
        var source = {
          url: ele.data("url"),
          datatype: "json",
          async: false,
          root: "datas>code>rows"
        };
        if (typeof window.MOCK_CONFIG != 'undefined') {
          source = getSourceMock(source);
        }
        var dataAdapter = new $.jqx.dataAdapter(source, {
          loadComplete: function (records) {
            var random = '_' + parseInt(Math.random() * 100000);
            _renderHtml(records.datas.code.rows, ele);
          }
        });
        dataAdapter.dataBind();
        _triggerFormChange(ele, 'change');

        function _renderHtml(data, ele) {
          var listHtml = '';
          $(data).each(function () {
            listHtml += '<label>' +
              '<input type="radio" name="' + ele.data('name') + '" value="' + this.id + '" data-caption="' + this.name + '" />' +
              '<i class="bh-choice-helper"></i>' + this.name +
              '</label>';
          });
          ele.html(listHtml).data('init', true).trigger('bhInputInitComplete');
        }
      },
      "setValue": function (ele, name, val, root) {
        if (val[name] !== undefined && val[name] !== null && val[name] !== "") {
          $('input[type=radio][value=' + val[name] + ']', ele).prop('checked', true);
        } else {
          $('input[type=radio]', ele).prop('checked', false);
        }
      },
      "getValue": function (ele, formData) {
        var itemText = ele.find('input[type=radio]:checked').map(function () {
          return $(this).data('caption');
        }).get().join(',');
        formData[ele.data('name') + "_DISPLAY"] = itemText;
        return ele.find('input[type=radio]:checked').map(function () {
          return $(this).val();
        }).get().join(',');
      },
      "disable": function (ele) {
        $('input[type=radio]', ele).prop('disabled', true);
      },
      "enable": function (ele) {
        $('input[type=radio]', ele).prop('disabled', false);
      }
    },

    "checkboxlist": {
      "init": function (ele, params) {
        if (ele.data('init')) {
          return;
        }

        if (ele.data('optiondata')) {
          var option_data = ele.data('optiondata');
          if (typeof option_data == 'string') {
            try {
              option_data = JSON.parse(option_data);
            } catch (e) {
              console && console.error(_this.data('name') + 'optionData 格式错误, 必须是json格式');
            }
          } else {
            option_data = WIS_EMAP_SERV.cloneObj(option_data)
          }
          _renderHtml(option_data, ele);
          return
        }

        //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
        var source = {
          url: ele.data("url"),
          datatype: "json",
          async: false,
          root: "datas>code>rows"
        };
        if (typeof window.MOCK_CONFIG != 'undefined') {
          source = getSourceMock(source);
        }
        var dataAdapter = new $.jqx.dataAdapter(source, {
          loadComplete: function (records) {
            var random = '_' + parseInt(Math.random() * 1000);
            _renderHtml(records.datas.code.rows, ele);
            // $(records.datas.code.rows).each(function () {
            //  listHtml += '<label>' +
            //          '<input type="checkbox" name="' + ele.data('name') + '" value="' + this.id + '" data-caption="' + this.name + '" />' +
            //          '<i class="bh-choice-helper"></i>' + this.name +
            //          '</label>';
            // });
            // ele.html(listHtml).data('init', true);
          }
        });

        // var dataAdapter = new $.jqx.dataAdapter({
        //     url: ele.data("url"),
        //     datatype: "json",
        //     async: false,
        //     root: "datas>code>rows"
        // }, {
        //     loadComplete: function(records) {
        //         var random = '_' + parseInt(Math.random() * 1000);
        //         _renderHtml(records.datas.code.rows, ele);
        //         // $(records.datas.code.rows).each(function () {
        //         //  listHtml += '<label>' +
        //         //          '<input type="checkbox" name="' + ele.data('name') + '" value="' + this.id + '" data-caption="' + this.name + '" />' +
        //         //          '<i class="bh-choice-helper"></i>' + this.name +
        //         //          '</label>';
        //         // });
        //         // ele.html(listHtml).data('init', true);
        //     }
        // });
        dataAdapter.dataBind();
        _triggerFormChange(ele, 'change');

        function _renderHtml(data, ele) {
          var listHtml = '';
          $(data).each(function () {
            listHtml += '<label>' +
              '<input type="checkbox" name="' + ele.data('name') + '" value="' + this.id + '" data-caption="' + this.name + '" />' +
              '<i class="bh-choice-helper"></i>' + this.name +
              '</label>';
          });
          ele.html(listHtml).data('init', true).trigger('bhInputInitComplete');
        }
      },
      "setValue": function (ele, name, val, root) {
        if (val[name] !== undefined && val[name] !== null && val[name] !== "") {
          $(val[name].toString().split(',')).each(function () {
            $('input[type=checkbox][value="' + this + '"]', ele).prop('checked', true);
          });
        } else {
          $('input[type=checkbox]', ele).prop('checked', false);
        }
        ele.emapRepeater('setValue', val[name]);
      },
      "getValue": function (ele, formData) {
        var itemText = ele.find('input[type=checkbox]:checked').map(function () {
          return $(this).data('caption');
        }).get().join(',');
        formData[ele.data('name') + "_DISPLAY"] = itemText;
        return ele.find('input[type=checkbox]:checked').map(function () {
          return $(this).val();
        }).get().join(',');
      },
      "disable": function (ele) {
        $('input[type=checkbox]', ele).prop('disabled', true);
      },
      "enable": function (ele) {
        $('input[type=checkbox]', ele).prop('disabled', false);
      }
    },

    "tree": {
      "init": _initTree,
      "setValue": function (ele, name, val, root) {
        //qiyu 2016-1-16
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空下拉树 zhuhui 5-24
          ele.emapDropdownTree("setValue", ['', $.i18n('bh-eip-pleaseChoose')]);
          return;
        }

        if (val[name + '_DISPLAY']) {
          ele.emapDropdownTree("setValue", [val[name], val[name + "_DISPLAY"]]);
        } else {
          WIS_EMAP_INPUT.getInputOptions(ele.data("url"), function (res) {
            ele.data('model', res);
            $(res).each(function () {
              if (this.id == val[name]) {
                ele.emapDropdownTree("setValue", [this.id, this.name]);
                return false;
              }
            });
          });
        }
      },
      "getValue": function (ele, formData) {
        formData[ele.data('name') + "_DISPLAY"] = ele.emapDropdownTree('getText');
        return ele.emapDropdownTree('getValue');
      },
      "disable": function (ele) {
        ele.emapDropdownTree('disable');
      },
      "enable": function (ele) {
        ele.emapDropdownTree('enable');
      }
    },

    "multi-tree": {
      "init": _initTree,
      "setValue": function (ele, name, val, root) {
        //qiyu 2016-1-16
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空下拉树 zhuhui 5-24
          ele.emapDropdownTree("setValue", ['', $.i18n('bh-eip-pleaseChoose')]);
          return;
        }
        ele.emapDropdownTree("setValue", [val[name], val[name + "_DISPLAY"]]);

      },
      "getValue": function (ele, formData) {
        formData[ele.data('name') + "_DISPLAY"] = ele.emapDropdownTree('getText');
        return ele.emapDropdownTree('getValue');
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },

    "tree2": {
      "init": _initTree2,
      "setValue": function (ele, name, val, root) {
        //qiyu 2016-1-16
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空下拉树 zhuhui 5-24
          ele.emapDropdownZTree("setValue", ['', $.i18n('bh-eip-pleaseChoose')]);
          return;
        }

        if (val[name + '_DISPLAY']) {
          ele.emapDropdownZTree("setValue", [val[name], val[name + "_DISPLAY"]]);
        } else {
          WIS_EMAP_INPUT.getInputOptions(ele.data("url"), function (res) {
            ele.data('model', res);
            $(res).each(function () {
              if (this.id == val[name]) {
                ele.emapDropdownZTree("setValue", [this.id, this.name]);
                return false;
              }
            });
          });
        }
      },
      "getValue": function (ele, formData) {
        formData[ele.data('name') + "_DISPLAY"] = ele.emapDropdownZTree('getText');
        return ele.emapDropdownZTree('getValue');
      },
      "disable": function (ele) {
        ele.emapDropdownZTree('disable');
      },
      "enable": function (ele) {
        ele.emapDropdownZTree('enable');
      }
    },
    "multi-tree2": {
      "init": _initTree2,
      "setValue": function (ele, name, val, root) {
        //qiyu 2016-1-16
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          // 清空下拉树 zhuhui 5-24
          ele.emapDropdownZTree("setValue", ['', $.i18n('bh-eip-pleaseChoose')]);
          return;
        }
        ele.emapDropdownZTree("setValue", [val[name], val[name + "_DISPLAY"]]);
      },
      "getValue": function (ele, formData) {
        formData[ele.data('name') + "_DISPLAY"] = ele.emapDropdownZTree('getText');
        return ele.emapDropdownZTree('getValue');
      },
      "disable": function (ele) {
        ele.emapDropdownZTree('disable');
      },
      "enable": function (ele) {
        ele.emapDropdownZTree('enable');
      }
    },
    "switcher": {
      "init": function (ele, params) {
        var inputOptions = $.extend({}, {
          checked: false,
          onLabel: '是',
          offLabel: '否'
        }, params);
        ele.jqxSwitchButton(inputOptions);
        _triggerFormChange(ele, 'change');
      },
      "setValue": function (ele, name, val, root) {
        ele.jqxSwitchButton({
          checked: val[name] * 1
        });
      },
      "getValue": function (ele, formData) {
        var itemVal = (ele.val() ? 1 : 0);
        formData[ele.data('name') + "_DISPLAY"] = (itemVal ? $.i18n('bh-eip-yes') : $.i18n('bh-eip-no'));
        return itemVal;
      },
      "disable": function (ele) {
        ele.jqxSwitchButton('disable');
      },
      "enable": function (ele) {
        ele.jqxSwitchButton('enable');
      }
    },

    "uploadfile": {
      "init": _initFileUpload,
      "setValue": function (ele, name, val, root) {
        var opt = $.extend({}, ele.data('defaultoptions'), {
          contextPath: root,
          token: val[name]
        });
        if (ele.data('disabled') == true || ele.data('disabled') == 'true') {
          ele.emapFileDownload('destroy');
          ele.emapFileDownload(opt);
          return;
        }
        ele.emapFileUpload('destroy');
        ele.emapFileUpload(opt);
      },
      "getValue": function (ele, formData) {
        if (ele.data('disabled') == true || ele.data('disabled') == 'true') {
          return ele.emapFileDownload('getValue');
        }
        return ele.emapFileUpload('getFileToken');
      },
      "disable": _disabledFileUpload,
      "enable": _enableFileUpload
    },

    "uploadphoto": {
      "init": _initFileUpload,
      "setValue": function (ele, name, val, root) {
        ele.emapFilePhoto('destroy');
        ele.emapFilePhoto($.extend({}, ele.data('defaultoptions'), {
          contextPath: root,
          token: val[name]
        }));
      },
      "getValue": function (ele, formData) {
        return ele.emapFilePhoto('getFileToken');
      },
      "disable": _disabledFileUpload,
      "enable": _enableFileUpload
    },
    "uploadsingleimage": {
      "init": _initFileUpload,
      "setValue": function (ele, name, val, root) {
        var opt = $.extend({}, ele.data('defaultoptions'), {
          contextPath: root,
          token: val[name]
        });
        if (ele.data('disabled') == true || ele.data('disabled') == 'true') {
          ele.emapFileDownload('destroy');
          opt.model = 'image';
          ele.emapFileDownload(opt);
          return;
        }
        ele.emapSingleImageUpload('destroy');
        ele.emapSingleImageUpload(opt);

      },
      "getValue": function (ele, formData) {
        if (ele.data('disabled') == true || ele.data('disabled') == 'true') {
          return ele.emapFileDownload('getValue');
        }
        return ele.emapSingleImageUpload('getFileToken');
      },
      "disable": _disabledFileUpload,
      "enable": _enableFileUpload
    },
    "uploadmuiltimage": {
      "init": _initFileUpload,
      "setValue": function (ele, name, val, root) {
        var opt = $.extend({}, ele.data('defaultoptions'), {
          contextPath: root,
          token: val[name]
        })
        if (ele.data('disabled') == true || ele.data('disabled') == 'true') {
          ele.emapFileDownload('destroy');
          opt.model = 'image';
          ele.emapFileDownload(opt);
          return;
        }
        ele.emapImageUpload('destroy');
        ele.emapImageUpload(opt);
      },
      "getValue": function (ele, formData) {
        return ele.emapImageUpload('getFileToken');
      },
      "disable": _disabledFileUpload,
      "enable": _enableFileUpload
    },

    "buttonlist": {
      "init": _initButtonList,
      "setValue": function (ele, name, val, root) {
        $('.bh-label-radio.bh-active', ele).removeClass('bh-active');
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          var allBtn = $('.bh-label-radio[data-id=ALL]', ele);
          if (allBtn.length > 0) {
            allBtn.addClass('bh-active');
          }
        } else {
          var selectBtn = $('.bh-label-radio[data-id="' + val[name] + '"]', ele);
          if (selectBtn.length > 0) {
            selectBtn.addClass('bh-active');
          }
        }
      },
      "getValue": function (ele, formData) {
        var selectedItems = $('.bh-label-radio.bh-active', ele);
        if (selectedItems.length) {
          formData[ele.data('name') + "_DISPLAY"] = selectedItems.map(function (i, item) {
            return $(item).data('name');
          }).get().join(',');
        }
        return ele.bhButtonGroup('getValue');
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },
    "multi-buttonlist": {
      "init": _initButtonList,
      "setValue": function () {
        // TODO
      },
      "getValue": function (ele, formData) {
        var selectedItems = $('.bh-label-radio.bh-active', ele);
        if (selectedItems.length) {
          formData[ele.data('name') + "_DISPLAY"] = selectedItems.get().map(function (item) {
            return $(item).data('name');
          }).join(',');
        }
        return ele.bhButtonGroup('getValue');
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },

    "div": {
      "init": function (ele, params, options) {},
      "setValue": function () {},
      "getValue": function (ele, formData) {
        return ele.val();
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },

    "textarea": {
      "init": function (ele, params, options) {
        var inputOptions = $.extend({}, {
          checkSize: ele.data('checksize'),
          dataSize: ele.data('size'),
          name: ele.data('name'),
          placeholder: ele.data('attr') ? ele.data('attr').placeholder : '',
          readonly: ele.data('attr') ? ele.data('attr').inputReadonly : false,
          textareaEasyCheck: options.textareaEasyCheck
        }, params);
        // 对于 h 和 v的表单， 不渲染placeholder
        if (options && (options.model === 'h' || options.model === 'v')) {
          inputOptions.placeholder = undefined
        }
        if (!options || options.textareaEasyCheck) {
          inputOptions.limit = ele.data('checksize') ? ele.data('checksize') : parseInt(ele.data('size') / 3);
        } else {
          inputOptions.limit = ele.data('checksize') ? ele.data('checksize') : ele.data('size');
        }
        ele.bhTxtInput(inputOptions);
        _triggerFormChange(ele, 'change');
      },
      "setValue": function (ele, name, val, root) {
        ele.bhTxtInput('setValue', (val[name] !== null && val[name] !== undefined) ? val[name] : "")
      },
      "getValue": function (ele, formData) {
        return ele.bhTxtInput('getValue');
      },
      "disable": function (ele) {
        ele.bhTxtInput('disabled', true);
      },
      "enable": function (ele) {
        ele.bhTxtInput('disabled', false);
      },
      "readonly": function (ele, params, options) {
        var inputOptions = $.extend({}, {
          checkSize: ele.data('checksize'),
          dataSize: ele.data('size'),
          name: ele.data('name'),
          textareaEasyCheck: options.textareaEasyCheck
        }, params);
        if (inputOptions.height !== undefined) {
          ele.css('height', inputOptions.height)
          return
        }
        if (inputOptions.autoHeight === true) {
          var $heightHook = $('<div style="z-index: -1000;word-break: break-all;padding: 2px;position: fixed;opacity: 0;"></div>').width(ele.width());
          $('body').append($heightHook);
          ele.on('input', function () {
            var value = this.value
            var minHeight = 74;
            // 动态计算高度
            $heightHook.html(handleHookValue(value));
            var hookHeight = $heightHook.height();
            if (hookHeight >= 74) {
              if (ele.height() != hookHeight) {
                ele.height(hookHeight);
              }
            } else if (ele.height() > minHeight) {
              ele.height(minHeight);
            }
          })
        }
        function handleHookValue(val) {
          return val.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n|\t/g, '<br>');
        }
      }
    },

    "static": {
      "init": function () {},
      "setValue": function (ele, name, val, root) {
        if (val[name + "_DISPLAY"] !== undefined) {
          ele.text(val[name + "_DISPLAY"])
          ele.data('valuedisplay', val[name + '_DISPLAY'])
        } else {
          ele.text(val[name])
        }
        ele.data('value', val[name]);
      },
      "getValue": function (ele, formData) {
        if (ele.data('valuedisplay') !== undefined) {
          formData[ele.data('name') + "_DISPLAY"] = ele.data('valuedisplay')
        }
        return ele.data('value');
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    },

    "number": {
      "init": function (ele, params) {
        var inputOptions = $.extend({}, {
          inputMode: 'simple',
          spinButtons: true,
          decimal: null,
          decimalDigits: 0,
          promptChar: ''
        }, params);
        ele.jqxNumberInput(inputOptions);
        _triggerFormChange(ele, 'change');
      },
      "setValue": function (ele, name, val, root) {
        var value = '';
        if ($.isPlainObject(val)) {
          value = (val[name] !== null && val[name] !== undefined) ? val[name] : "";
        } else {
          value = val;
        }
        if (value === '') {
          ele.val(null);
        } else {
          _setTextValue(ele, name, val, root);
        }
      },
      "getValue": function (ele, formData) {
        return ele.val() || ele.find('input').val();
      },
      "disable": function (ele) {
        ele.jqxNumberInput({
          disabled: true
        });
      },
      "enable": function (ele) {
        ele.jqxNumberInput({
          disabled: false
        });
      }
    },

    "number-range": {
      "init": function (ele, params) {
        ele.bhNumRange(params);
      },
      "setValue": function (ele, name, val, root) {
        if (val[name] === undefined || val[name] === null || val[name] === '') {
          ele.bhNumRange('setValue', {
            input1: null,
            input2: null
          });
        } else {
          var valArr = val[name].toString().split(',');
          if (valArr.length == 1) valArr[1] = valArr[0];
          ele.bhNumRange('setValue', {
            input1: valArr[0],
            input2: valArr[1]
          });
        }
      },
      "getValue": function (ele, formData) {
        return ele.bhNumRange('getValue');
      },
      "disable": function (ele) {
        ele.bhNumRange('disabled', true);
      },
      "enable": function (ele) {
        ele.bhNumRange('disabled', false);
      }
    },

    "text": {
      "init": function (ele, params) {
        ele.jqxInput({
          width: '100%'
        });
        _triggerFormChange(ele, 'change');
      },
      "setValue": function(ele, name, val, root) {
        ele.val((val[name] !== null && val[name] !== undefined) ? val[name] : "");
        ele.keyup();
      },
      "getValue": function (ele, formData) {
        var value = $.trim(ele.val());
        var dataType = ele.data('type');
        if (value === '') return '';
        if (dataType) {
          if ($.inArray(dataType.toLowerCase(), ['number', 'int', 'integer']) > -1) {
            value = value * 1;
            if (!isNaN(value)) {
              return value;
            }
          }
        }
        return $.trim(ele.val());
      },
      "disable": _defaultDisabled,
      "enable": _defaultEnable
    }

  };

  WIS_EMAP_INPUT.component = (function () {
    return $.extend({}, WIS_EMAP_INPUT.core, {});
  })();

  /**
   * @method getConvertCondition
   * @description 将表单取值数据转化为搜索条件
   * @param {Object} form_data - 表单数据
   * @param {Object} model - 数据模型
   * @param {Boolean} [operate_blank_value=false] - 是否处理空值（包含两部分 1.去除Value为空的数据  2.将value为@__blank__value的数据value变为""）
   * @return 高级搜索条件
   */
  WIS_EMAP_INPUT.getConvertCondition = function (form_data, model, operate_blank_value) {
    var condition = [];
    var text_fields = model.map(function (item) {
      if (!item.xtype || item.xtype == 'text') {
        return item.name;
      }
    });
    for (var k in form_data) {
      if (operate_blank_value === true && form_data[k] === '') {
        continue;
      }
      if (/_DISPLAY$/.test(k)) continue;
      var modelItem = model.filter(function (item) {
        return item.name == k
      })[0];
      if (!modelItem) continue;
      var item_filter = {
        name: k,
        caption: modelItem.caption,
        linkOpt: "AND",
        builderList: modelItem.builderList,
        builder: modelItem.defaultBuilder,
        value: form_data[k]
      };
      if (item_filter.value === undefined) {
        continue;
      }
      if (form_data[k + '_DISPLAY'] !== undefined) {
        item_filter.value_display = form_data[k + '_DISPLAY'];
      }
      if (operate_blank_value === true) {
        item_filter.value = item_filter.value === '@__blank__value' ? '' : item_filter.value;
      }
      condition.push(item_filter);
    }
    return _adaptCondition(condition, model);
    // 搜索条件数据适配
    function _adaptCondition(condition, model) {
      var resultCondition = [];
      var len = condition.length;
      for (var i = 0; i < len; i++) {
        var condition_item = condition[i];
        if (!(condition_item instanceof Array)) {
          var model_item = model.filter(function (m_item) {
            return m_item.name == condition_item.name;
          })[0];
          var attr = WIS_EMAP_SERV.getAttr(model_item);
          // 文本类型控件包含 , 时  builder转化为多值包含
          if ((!attr.xtype || attr.xtype == 'text') && condition_item.value.toString().indexOf(',') > 0) {
            condition_item.builder = 'm_value_include';
          }
          // 按钮组类型的控件，将value转为string
          else if (attr.xtype === 'buttonlist' || attr.xtype === 'multi-buttonlist') {
            if (condition_item.value !== undefined && condition_item.value !== null) {
              condition_item.value = condition_item.value + '';
            }
          }
          // number 类型，过滤value中的非数字
          else if (attr.xtype === 'number') {
            if (condition_item.value) {
              condition_item.value = condition_item.value.toString().replace(/\D/g, '')
            }
            condition_item.value = condition_item.value === null ? '' : numVal * 1;
          }
          // 下拉多选、复选框、多选按钮组类型, builder 转化为多值相等
          else if (attr.xtype == 'multi-select2' || attr.xtype == 'checkboxlist' || attr.xtype == 'multi-buttonlist' || /multi-tree/.test(attr.xtype)) {
            // 对于空值选项 不支持多值相等
            if (condition_item.value !== '@__blank__value' && /,/.test(condition_item.value)) {
              if (condition_item.builder === 'equal' || condition_item.builder === 'include') {
                condition_item.builder = 'm_value_' + condition_item.builder
              }
            } else if (condition_item.value === '@__blank__value' && (condition_item.builder === 'm_value_equal' || condition_item.builder === 'm_value_include')) {
              // 多值相等或多值包含 下 选择空值时， 转为相等或包含
              condition_item.builder = condition_item.builder.replace(/m_value_/, '');
            }
          }
          // 类型为date-range日期范围  num-range数字区间 时, 拆分成 两个条件
          else if (attr.xtype == 'date-range' || attr.xtype == 'number-range') {
            var date_value = condition_item.value.split(',');
            if (date_value[0] !== "") {
              condition_item.builder = 'moreEqual';
              condition_item.value = date_value[0];
            }
            if (date_value[1] !== "" && date_value[1] !== undefined) {
              resultCondition.push({
                name: condition_item.name,
                caption: condition_item.caption,
                builder: 'lessEqual',
                linkOpt: 'AND',
                builderList: 'cbl_Other',
                value: date_value[1]
              });
            }
          }
        }
        resultCondition.push(condition_item)
      }
      return resultCondition;
    }
  }

  /**
   * @method filterCondition
   * @description 过滤搜索条件，将空值('')去掉，将空白值(@__blank__value)设置为空值('')
   * @param {Array|String} condition - 搜索条件
   * @return {Array} - 过滤后的搜索条件
   */
  WIS_EMAP_INPUT.filterCondition = function (condition) {
    var con = condition;
    var result = [];
    if (typeof condition == 'string') {
      con = JSON.parse(con);
    }
    con.map(function (item, i) {
      if (item instanceof Array) {
        result.push(WIS_EMAP_INPUT.filterCondition(item));
      } else {
        if (item.value !== '') {
          if (item.value === '@__blank__value') {
            item.value = '';
            item.builder = 'equal'
          }
          result.push(item);
        }
      }
    })
    return result;
  }

  function _initSelect(ele, params, options) {
    var _this = $(ele);
    var xtype = _this.attr('xtype');
    var placeholder_option = {
      id: '',
      name: $.i18n('bh-eip-pleaseChoose'),
      uid: ''
    };
    var blank_option = {
      id: '@__blank__value',
      name: $.i18n('bh-eip-empty'),
      uid: ''
    };
    var source = [placeholder_option];
    var inputOptions = $.extend({}, {
      placeHolder: ele.attr('data-placeholder') || $.i18n('bh-eip-pleaseChoose'),
      source: source,
      displayMember: "name",
      valueMember: "id",
      itemHeight: 28,
      enableBrowserBoundsDetection: true,
      filterable: true,
      width: "100%",
      filterPlaceHolder: $.i18n('bh-eip-pleaseSeach'),
      searchMode: 'containsignorecase',
      disabled: _this.data('disabled') ? true : false
    }, params);

    if (WIS_EMAP_CONFIG.dropDownOneKeySelect) {
      inputOptions.oneKeySelect = WIS_EMAP_CONFIG.dropDownOneKeySelect;
    }
    try {
      delete inputOptions.formatData;
    } catch (e) {}

    var changeEvent = 'change';

    if (xtype === 'multi-select2') {
      inputOptions.source = [];
      inputOptions.checkboxes = true;
      changeEvent = 'close';
    }
    // 高级搜索匹配空值@__blank__value
    if (options && options.showBlankOption) {
      source.push(blank_option);
    }
    _triggerFormChange(_this, changeEvent);
    if (_this.data('optiondata') || (_this.data('attr') && _this.data('attr').optionData)) {
      var option_data = _this.data('optiondata') || _this.data('attr').optionData;
      if (typeof option_data == 'string') {
        try {
          option_data = JSON.parse(option_data);
        } catch (e) {
          console && console.error(_this.data('name') + 'optionData 格式错误, 必须是json格式');
        }
      } else {
        option_data = WIS_EMAP_SERV.cloneObj(option_data)
      }
      if (inputOptions.checkboxes !== true) {
        option_data.splice(0, 0, placeholder_option);
      }
      if (inputOptions.optionData !== undefined) {
        delete inputOptions.optionData
      }
      _this.jqxDropDownList(inputOptions);
      _this.jqxDropDownList({
        source: option_data
      });
      return;
    }

    _this.jqxDropDownList(inputOptions).on('open', function (e) {
      loadSelectData($(this), e, params, options);
    });

    // 下拉框收起时，将下拉框的搜索框中内容清空， 否则会对select取值造成影响
    _this.on('close', function () {
      $(this).jqxDropDownList('clearFilter');
      // 下拉框关闭时.重新定位下拉元素， 防止在纸质弹窗中 将页脚撑开
      // 延迟300 避免收起过程中的定位闪动
      setTimeout(function () {
        ele.jqxDropDownList('listBoxContainer').parent().css({top: 0})
      }, 300)
    });

    // 高级搜索中，下拉多选的空值联动， 当选中空值项时，将其他项取消勾选
    var flag = false;
    if (options && options.showBlankOption && xtype === 'multi-select2') {
      _this.on('checkChange', function (e) {
        var args = e.args;
        if (!args || flag) return;
        flag = true;
        // 勾选空值时，将其他选项取消勾选
        if (args.value === '@__blank__value' && args.checked === true) {
          _this.jqxDropDownList('uncheckAll');
          _this.jqxDropDownList('checkItem', args.item);
        } else if (args.value !== '@__blank__value') { // 勾选其他值时，将空值项取消勾选
          var checked_items = _this.jqxDropDownList('getCheckedItems');
          if (checked_items && checked_items.length > 0) {
            var blank_item = checked_items.filter(function (item) {
              return item.value === '@__blank__value';
            });
            if (blank_item.length > 0) { //空值选项在勾选时
              _this.jqxDropDownList('uncheckItem', blank_item[0]);
            }
          }
        }
        flag = false;
      })
    }
  }

  function loadSelectData(ele, e, params, options, cb) {
    var _this = ele;
    var xtype = _this.attr('xtype');
    var placeholder_option = {
      id: '',
      name: $.i18n('bh-eip-pleaseChoose'),
      uid: ''
    };
    var blank_option = {
      id: '@__blank__value',
      name: $.i18n('bh-eip-empty'),
      uid: ''
    };
    var $filterInput = _this.jqxDropDownList('listBoxContainer').jqxListBox('filter');
    $filterInput.css('position', 'relative');
    if (!$filterInput.find('[role="bh-placeholder-wrap"]').length) {
      WIS_EMAP_INPUT.placeHolder($filterInput);
    }

    if (!_this.data('loaded')) {
      _this.data('loaded', false);
      e && e.stopPropagation();
      var curVal = _this.val().split(',');
      //2016-5-6 qiyu 增加下拉后，仍然能选中值; 提出人：吴涛
      var curSelectIndex = [];

      //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
      if (!_this.data("url")) {
        return console.error(ele.data('name') + '字典url未配置')
      }
      var source = {
        url: _this.data("url"),
        datatype: "json",
        async: false,
        type: WIS_EMAP_CONFIG.getOptionType,
        root: "datas>code>rows",
        formatData: function (data) {
          if (_this.data('jsonparam')) {
            var jParam = {};
            if (typeof _this.data('jsonparam') === 'string') {
              try {
                jParam = JSON.parse(_this.data('jsonparam').replace(/\'/g, '"'))
              } catch (e) {
                console && console.warn('无效的JSONParam参数！');
              }
            } else if (typeof _this.data('jsonparam') === 'object') {
              jParam = _this.data('jsonparam');
            }

            // 处理从JSONParam中传入的formatData， 由于emap配置中JSONParam只能传字符串，所以目前此场景只会在公有云环境中使用
            // if (jParam.formatData && typeof jParam.formatData == 'function') {
            //     data = jParam.formatData(data);
            // }
          }
          // 处理从defaultOptions中传入的formatData
          if (params && params.formatData) {
            data = params.formatData(data);
          }
          return data;
        }
      };
      if (typeof window.MOCK_CONFIG != 'undefined') {
        source = getSourceMock(source);
      }
      var selectDataAdapter = new $.jqx.dataAdapter(source, {
        beforeLoadComplete: function (records) {
          if (options && options.showBlankOption) {
            records.unshift(blank_option);
          }
          if (xtype === 'select') {
            records.unshift(placeholder_option);
          }
          //2016-5-6 qiyu 增加下拉后，仍然能选中值; 提出人：吴涛
          for (var i = 0; i < records.length; i++) {
            //qiyu 2017-2-23 放置XSS攻击处理
            records[i].name = BH_UTILS.fxss(records[i].name);
            if ($.inArray(records[i].id, curVal) > -1 && records[i].id !== "") { // 避免将空值放入数组 zhuhui 0815
              curSelectIndex.push(i);
            }
          }
        },
        loadComplete: function (data) {
          var selectMethod = xtype == 'select' ? 'selectIndex' : 'checkIndex';
          //2016-5-6 qiyu 增加下拉后，仍然能选中值; 提出人：吴涛
          if (curSelectIndex.length > 0) {
            $(curSelectIndex).each(function () {
              _this.jqxDropDownList(selectMethod, this);
            });
          } else {
            _this.jqxDropDownList(selectMethod, -1);
          }
          setTimeout(function () {
            cb && cb();
            _this.data('loaded', true);
          }, 1);
        }
      });
      _this.jqxDropDownList({
        source: selectDataAdapter
      });
      //2016-3-31 qiyu，重复加载数据了
      //selectDataAdapter.dataBind();
    }
  }

  function _initDateInput(ele, params) {
    var _this = ele;
    var xtype = _this.attr('xtype');
    var inputOptions = $.extend({}, {
      width: "100%",
      disabled: _this.data('disabled'),
      value: null,
      formatString: 'yyyy-MM',
      culture: 'zh-CN',
      showFooter: true,
      clearString: $.i18n('bh-eip-clear'),
      enableBrowserBoundsDetection: true,
      todayString: $.i18n('bh-eip-today')
    }, params);
    if (xtype == 'date-local') {
      inputOptions.formatString = 'yyyy-MM-dd';
    } else if (xtype == 'date-full') {
      inputOptions.formatString = _this.data('format') ? _this.data('format') : 'yyyy-MM-dd HH:mm';
      inputOptions.showTimeButton = true;
    }
    inputOptions.formatString = _this.data('format') || inputOptions.formatString;
    _this.jqxDateTimeInput(inputOptions);
    // 不为date-full时， 点击文本框也会弹出下拉
    // 为date-full 时， 则不做处理，因为可能会出现 HH : mm 的情况
    if (xtype != 'date-full') {
      _this.on("click", function (e) {
        e.stopPropagation();
        var disabled = $(this).jqxDateTimeInput('disabled');
        if (!disabled) $(this).jqxDateTimeInput('open');

      });

      // 清除输入的 非数字
      _this.on('input', function () {
        if (isNaN(parseInt(_this.val()))) {
          _this.val('');
        }
      });
    }
    _triggerFormChange(_this, 'change');
  }

  function _initTree(ele, params, options) {
    var xtype = ele.attr('xtype');
    var inputOptions = $.extend({}, {
      url: ele.data('url'),
      checkboxes: false,
      search: params.search === undefined ? true : params.search,
      placeholder: ele.attr('data-placeholder') || $.i18n('bh-eip-pleaseChoose'),
      showBlankOption: options.showBlankOption,
      treeParams: {}
    }, params);
    if (xtype === 'multi-tree') {
      inputOptions.checkboxes = true;
    }
    if (params.hasThreeStates !== undefined) {
      // 无法与现有下拉树异步加载兼容
      // inputOptions.treeParams.hasThreeStates = params.hasThreeStates;
    }
    ele.emapDropdownTree(inputOptions);
    if (ele.data('disabled')) {
      ele.emapDropdownTree('disable');
      var formGroup = ele.closest('.bh-form-group');
      if (formGroup.length > 0) {
        formGroup.addClass('disabled');
      }
    }
    var changeEvent = 'change';
    if (xtype == 'multi-tree') {
      changeEvent = 'close';
    }
    _triggerFormChange(ele, changeEvent);
  }

  function _initTree2(ele, params, options) {
    // TODO: 添加新的下拉树
    var xtype = ele.attr('xtype');
    var inputOptions = $.extend({}, {
      url: ele.data('url'),
      checkboxes: false,
      search: true,
      placeholder: ele.attr('data-placeholder') || $.i18n('bh-eip-pleaseChoose'),
      showBlankOption: options.showBlankOption,
      treeParams: {}
    }, params);
    if (xtype === 'multi-tree2') {
      inputOptions.checkboxes = true;
    }
    if (params.hasThreeStates !== undefined) {
      // 无法与现有下拉树异步加载兼容
      // inputOptions.treeParams.hasThreeStates = params.hasThreeStates;
    }
    ele.emapDropdownZTree(inputOptions);
    if (ele.data('disabled')) {
      ele.emapDropdownZTree('disable');
      var formGroup = ele.closest('.bh-form-group');
      if (formGroup.length > 0) {
        formGroup.addClass('disabled');
      }
    }
    var changeEvent = 'change';
    if (xtype == 'multi-tree2') {
      changeEvent = 'close';
    }
    _triggerFormChange(ele, changeEvent);
  }

  function _initFileUpload(ele, params, options) {
    var _this = ele;
    var xtype = _this.attr('xtype');
    var readonly = (_this.data('disabled') == 'true' || _this.data('disabled') == true || options.readonly);
    var inputOptions = $.extend({}, {
      contextPath: options.root
    }, params);
    _this.data('defaultoptions', inputOptions);
    if (xtype == 'uploadfile') {
      if (readonly) {
        _this.emapFileDownload(inputOptions);
        return;
      }
      _this.emapFileUpload(inputOptions);
    } else if (xtype == 'uploadphoto') {
      _this.emapFilePhoto(inputOptions);
    } else if (xtype == 'uploadsingleimage') {
      _this.emapSingleImageUpload(inputOptions);
    } else if (xtype == 'uploadmuiltimage') {
      _this.emapImageUpload(inputOptions);
    }
    if (_this.data('disabled') == true) {
      $('input[type=file]', _this).attr('disabled', true);
    }
    _this.on('bh.file.upload.done', function (e, data) {
      // 页面初始化触发的事件不走校验
      if (data && data.isInit === true) return
      _this.trigger('_formChange');
    });
  }

  function _initButtonList(ele, params) {
    var xtype = ele.attr('xtype');
    var inputOptions = $.extend({}, {
      url: ele.data('url'),
      allOption: ele.data('alloption')
    }, params);
    if (xtype == 'multi-buttonlist') {
      inputOptions.multiple = true;
      inputOptions.allOption = false;
    }
    // 添加按钮组对optionData的兼容
    if (ele.data('attr') && ele.data('attr').optionData) {
      inputOptions.data = ele.data('attr').optionData
      if (typeof inputOptions.data === 'string') {
        try {
          inputOptions.data = JSON.parse(inputOptions.data)
        } catch (e) {
          console && console.error('无效的json格式')
        }
      }
    }
    ele.bhButtonGroup(inputOptions);
    _triggerFormChange(ele, 'change');
  }

  function _setSelectValue(ele, val) {
    if (typeof val == "object") {
      ele.jqxDropDownList('addItem', val[0])
      ele.jqxDropDownList('checkAll');
    } else {
      //qiyu 2016-1-2 判断为空时，清空所有选项
      if (val === "" || val === undefined) {
        ele.jqxDropDownList('clearSelection');
      } else {
        ele.val(val);
      }
    }
  }

  function _setTextValue(ele, name, val, root) {
    ele.val((val[name] !== null && val[name] !== undefined) ? val[name] : "");
  }

  function _triggerFormChange(ele, eventName) {
    ele.on(eventName, function () {
      ele.trigger('_formChange');
    });
  }

  function _disabledFileUpload(ele) {
    $('input[type=file]', ele).attr('disabled', true);
    var editBar = $('.bh-file-img-single-edit', ele);
    if (editBar.length > 0) {
      editBar.hide();
    }
    var infoP = $('.bh-file-img-info', ele);
    if (infoP.length > 0) {
      infoP.hide();
    }
  }

  function _enableFileUpload(ele) {
    $('input[type=file]', ele).attr('disabled', false);
    var editBar = $('.bh-file-img-single-edit', ele);
    if (editBar.length > 0) {
      $('.bh-file-img-single-edit', ele).show();
    }
    var infoP = $('.bh-file-img-info', ele);
    if (infoP.length > 0) {
      infoP.show();
    }
  }

  function _defaultDisabled(ele) {
    ele.attr('disabled', true);
  }

  function _defaultEnable(ele) {
    ele.attr('disabled', false);
  }

})(window.WIS_EMAP_INPUT = window.WIS_EMAP_INPUT || {});


(function(WIS_EMAP_INPUT, undefined) {
    /**
     * @memberof module:WIS_EMAP_INPUT
     * @description 校验规则库, 配合校验组件使用，emap开发时，可以将规则名称配置在模型配置的【校验类型】一项中，
     *  非emap开发时， 将规则名称配置在字段meta信息的checkType属性上
     * @prop {Object} required - 必填校验
     * @prop {Object} double - 小数
     * @prop {Object} tele/tel - 电话号码
     * @prop {Object} phone - 手机号
     * @prop {Object} email/mail - 邮箱
     * @prop {Object} integer - 整数
     * @prop {Object} integer+0 - 非负整数
     * @prop {Object} integer+ - 正整数
     * @prop {Object} money - 金额数
     * @prop {Object} score - 分数
     * @prop {Object} number - 数字
     * @prop {Object} date - 日期 YYYY-MM-DD
     * @prop {Object} ipv4 - ip地址
     * @prop {Object} url - url地址
     * @prop {Object} onlyNumberSp - 只能填写数字
     * @prop {Object} onlyLetterSp - 只能填写英文字母
     * @prop {Object} onlyLetterNumber - 只能填写数字与英文字母
     * @prop {Object} chinese - 只能填写中文汉字
     * @prop {Object} chinaId - 身份证号
     * @prop {Object} chinaIdLoose - 身份证号宽松匹配
     * @prop {Object} chinaZip - 中国邮编
     * @prop {Object} qq - qq
     * @prop {Object} maxLength - 长度校验
     * @prop {Object} before - 日期早于联动字段，联动校验配置示例 before@CSRQ，其中CSRQ为联动字段的name
     * @prop {Object} before= - 日期早于等于联动字段，联动校验配置示例 before=@CSRQ，其中CSRQ为联动字段的name
     * @prop {Object} after - 日期晚于联动字段，联动校验配置示例 after@CSRQ，其中CSRQ为联动字段的name
     * @prop {Object} after= - 日期晚于等于联动字段，联动校验配置示例 after=@CSRQ，其中CSRQ为联动字段的name
     */
    WIS_EMAP_INPUT.validateRules = {
        "required": {
            "func": function (value) {
                return value !== undefined && $.trim(value.toString()) !== '';
            },
            "alertText": $.i18n('bh-rv-noEmpty')
        },
        "double": {
            "regex": /^(\-)?\d+(\.\d+)?$/,
            "alertText": $.i18n('bh-rv-inf')
        },
        // "dateRange": {
        //  "regex": "none",
        //  "alertText": "* 无效的 ",
        //  "alertText2": " 日期范围"
        // },
        // "dateTimeRange": {
        //  "regex": "none",
        //  "alertText": "* 无效的 ",
        //  "alertText2": " 时间范围"
        // },
        "minSize": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-least'),
            "alertText2": $.i18n('bh-rv-character')
        },
        "maxSize": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-most'),
            "alertText2": $.i18n('bh-rv-character')
        },
        // "groupRequired": {
        //  "regex": "none",
        //  "alertText": "* 至少填写其中一项"
        // },
        "min": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-minimum')
        },
        "max": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-maximum')
        },
        // "past": {
        //  "regex": "none",
        //  "alertText": "* 日期需在 ",
        //  "alertText2": " 之前"
        // },
        // "future": {
        //  "regex": "none",
        //  "alertText": "* 日期需在 ",
        //  "alertText2": " 之后"
        // },
        "maxCheckbox": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-mostChoose'),
            "alertText2": $.i18n('bh-rv-items')
        },
        "minCheckbox": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-leastChoose'),
            "alertText2": $.i18n('bh-rv-items')
        },
        "equals": {
            "regex": "none",
            "alertText": $.i18n('bh-rv-passwordInconsistent')
        },
        // "creditCard": {
        //  "regex": "none",
        //  "alertText": "无效的信用卡号码"
        // },
        "tele": {
            "regex": /^([\+][0-9]{1,3}[ \.\-])?([\(]{1}[0-9]{2,6}[\)])?([0-9 \.\-\/]{3,20})((x|ext|extension)[ ]?[0-9]{1,4})?$/,
            "alertText": $.i18n('bh-rv-ifn')
        },
        "tel": {
            "regex": /^([\+][0-9]{1,3}[ \.\-])?([\(]{1}[0-9]{2,6}[\)])?([0-9 \.\-\/]{3,20})((x|ext|extension)[ ]?[0-9]{1,4})?$/,
            "alertText": $.i18n('bh-rv-ifn')
        },
        "phone": {
            // credit:jquery.h5validate.js / orefalo
            "regex": /^(0|86|17951)?(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[57])[0-9]{8}$/,
            "alertText": $.i18n('bh-rv-imfn')
        },
        "email": {
            // Shamelessly lifted from Scott Gonzalez via the Bassistance Validation plugin http://projects.scottsplayground.com/email_address_validation/
            "regex": /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,
            "alertText": $.i18n('bh-rv-iea')
        },
        "mail": {
            // Shamelessly lifted from Scott Gonzalez via the Bassistance Validation plugin http://projects.scottsplayground.com/email_address_validation/
            "regex": /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,
            "alertText": $.i18n('bh-rv-iea')
        },
        "integer": {
            "regex": /^[\-\+]?\d+$/,
            "alertText": $.i18n('bh-rv-oia')
        },
        "integer+0": {
            "regex": /^\d+$/,
            "alertText": $.i18n('bh-rv-onnia')
        },
        "integer+": {
            "regex": /^[1-9](\d+)?$/,
            "alertText": $.i18n('bh-rv-oigtza')
        },
        "money": {
            "regex": /^\d+(\.\d{1,2})?$/,
            "alertText": $.i18n('bh-rv-ia')
        },
        //qiyu 2016-9-1 XQGL-25
        "score": {
            "regex": /^\d+(\.\d{1,2})?$/,
            "alertText": $.i18n('bh-rv-is')
        },
        "number": {
            // Number, including positive, negative, and floating decimal. credit:orefalo
            "regex": /^[\-\+]?((([0-9]{1,3})([,][0-9]{3})*)|([0-9]+))?([\.]([0-9]+))?$/,
            "alertText": $.i18n('bh-rv-ona')
        },
        "date": {
            "regex": /^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])$/,
            "alertText": $.i18n('bh-rv-idfmb')
        },
        "ipv4": {
            "regex": /^((([01]?[0-9]{1,2})|(2[0-4][0-9])|(25[0-5]))[.]){3}(([0-1]?[0-9]{1,2})|(2[0-4][0-9])|(25[0-5]))$/,
            "alertText": $.i18n('bh-rv-iweb')
        },
        "url": {
            "regex": /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i,
            "alertText": $.i18n('bh-rv-iweb')
        },
        "onlyNumberSp": {
            "regex": /^[0-9\ ]+$/,
            "alertText": $.i18n('bh-rv-ona')
        },
        "onlyLetterSp": {
            "regex": /^[a-zA-Z\ \']+$/,
            "alertText": $.i18n('bh-rv-oela')
        },
        "onlyLetterNumber": {
            "regex": /^[0-9a-zA-Z]+$/,
            "alertText": $.i18n('bh-rv-onaela')
        },
        //tls warning:homegrown not fielded
        "dateFormat": {
            "regex": /^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])$|^(?:(?:(?:0?[13578]|1[02])(\/|-)31)|(?:(?:0?[1,3-9]|1[0-2])(\/|-)(?:29|30)))(\/|-)(?:[1-9]\d\d\d|\d[1-9]\d\d|\d\d[1-9]\d|\d\d\d[1-9])$|^(?:(?:0?[1-9]|1[0-2])(\/|-)(?:0?[1-9]|1\d|2[0-8]))(\/|-)(?:[1-9]\d\d\d|\d[1-9]\d\d|\d\d[1-9]\d|\d\d\d[1-9])$|^(0?2(\/|-)29)(\/|-)(?:(?:0[48]00|[13579][26]00|[2468][048]00)|(?:\d\d)?(?:0[48]|[2468][048]|[13579][26]))$/,
            "alertText": $.i18n('bh-rv-idf')
        },
        //tls warning:homegrown not fielded
        "dateTimeFormat": {
            "regex": /^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])\s+(1[012]|0?[1-9]){1}:(0?[1-5]|[0-6][0-9]){1}:(0?[0-6]|[0-6][0-9]){1}\s+(am|pm|AM|PM){1}$|^(?:(?:(?:0?[13578]|1[02])(\/|-)31)|(?:(?:0?[1,3-9]|1[0-2])(\/|-)(?:29|30)))(\/|-)(?:[1-9]\d\d\d|\d[1-9]\d\d|\d\d[1-9]\d|\d\d\d[1-9])$|^((1[012]|0?[1-9]){1}\/(0?[1-9]|[12][0-9]|3[01]){1}\/\d{2,4}\s+(1[012]|0?[1-9]){1}:(0?[1-5]|[0-6][0-9]){1}:(0?[0-6]|[0-6][0-9]){1}\s+(am|pm|AM|PM){1})$/,
            "alertText": $.i18n('bh-rv-idotf'),
            "alertText2": $.i18n('bh-rv-af'),
            "alertText3": "mm/dd/yyyy hh:mm:ss AM|PM" + $.i18n('bh-rv-or'),
            "alertText4": "yyyy-mm-dd hh:mm:ss AM|PM"
        },

        /**
         * 正则验证规则补充
         * Author: ciaoca@gmail.com
         * Date: 2013-10-12
         */
        "chinese": {
            "regex": /^[\u4E00-\u9FA5]+$/,
            "alertText": $.i18n('bh-rv-occa')
        },
        "chinaId": {
            /**
             * 2013年1月1日起第一代身份证已停用，此处仅验证 18 位的身份证号码
             * 如需兼容 15 位的身份证号码，请使用宽松的 chinaIdLoose 规则
             * /^[1-9]\d{5}[1-9]\d{3}(
             *    (
             *        (0[13578]|1[02])
             *        (0[1-9]|[12]\d|3[01])
             *    )|(
             *        (0[469]|11)
             *        (0[1-9]|[12]\d|30)
             *    )|(
             *        02
             *        (0[1-9]|[12]\d)
             *    )
             * )(\d{4}|\d{3}[xX])$/i
             */
            "regex": /(^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$)|(^[1-9]\d{5}\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}$)/,
            "alertText": $.i18n('bh-rv-iin')
        },
        "chinaIdLoose": {
            "regex": /^(\d{18}|\d{15}|\d{17}[xX])$/,
            "alertText": $.i18n('bh-rv-iin')
        },
        "chinaZip": {
            "regex": /^\d{6}$/,
            "alertText": $.i18n('bh-rv-ipc')
        },
        "qq": {
            "regex": /^[1-9]\d{4,10}$/,
            "alertText": $.i18n('bh-rv-iqq')
        },
        "maxLength": {
            func: function (field, rules, i, options) {
                var max = rules[i + 2];
                var val = field.val();
                var len = 0;
                for (var index = 0; index < val.length; index++) {
                    if (val[index].match(/[^\x00-\xff]/ig) != null) {
                        len += 3;
                    } else {
                        len++;
                    }
                }
                options.allrules.maxLength.alertText = $.i18n('bh-rv-citl') + (len - max) + $.i18n('bh-rv-character');
                return max >= len;
            }//,
            // "alertText":"* 内容过长"
        },
        "before": {
            func: function (val, field, ele) {
                if (val === '' || val === undefined) return true;
                var valStp = WIS_EMAP_SERV.toDateStp(val);
                var nStp;
                if (field == 'now') {
                    // 小于当前时间
                    nStp = parseInt(new Date().getTime()/1000);
                } else {
                    // 小于给定字段时间
                    (!ele) && (ele = $(document));
                    var tarEle = $('[data-name=' + field + ']', ele);
                    if (!tarEle || tarEle.length === 0) return true; // 对于联动字段缺失场景的兼容性护理
                    var tarVal = WIS_EMAP_INPUT.getValue(tarEle, {});
                    if (!tarVal) return true;
                    nStp = WIS_EMAP_SERV.toDateStp(tarVal);
                }
                return valStp < nStp
            },
            alertText: $.i18n('bh-rv-noLaterThan')
        },
        "before=": {
            func: function (val, field, ele) {
                if (val === '' || val === undefined) return true;
                var valStp = WIS_EMAP_SERV.toDateStp(val);
                var nStp;
                if (field == 'now') {
                    // 小于当前时间
                    nStp = parseInt(new Date().getTime()/1000);
                } else {
                    // 小于给定字段时间
                    (!ele) && (ele = $(document));
                    var tarEle = $('[data-name=' + field + ']', ele);
                    if (!tarEle || tarEle.length === 0) return true; // 对于联动字段缺失场景的兼容性护理
                    var tarVal = WIS_EMAP_INPUT.getValue(tarEle, {});
                    if (!tarVal) return true;
                    nStp = WIS_EMAP_SERV.toDateStp(tarVal);
                }
                return valStp <= nStp
            },
            alertText: $.i18n('bh-rv-noLaterThan')
        },
        "after": {
            func: function (val, field, ele) {
                if (val === '' || val === undefined) return true;
                var valStp = WIS_EMAP_SERV.toDateStp(val);
                var nStp;
                if (field == 'now') {
                    // 大于当前时间
                    nStp = parseInt(new Date().getTime()/1000);
                } else {
                    // 大于给定字段时间
                    (!ele) && (ele = $(document));
                    var tarEle = $('[data-name=' + field + ']', ele);
                    if (!tarEle || tarEle.length === 0) return true; // 对于联动字段缺失场景的兼容性护理
                    var tarVal = WIS_EMAP_INPUT.getValue(tarEle, {});
                    if (!tarVal) return true;
                    nStp = WIS_EMAP_SERV.toDateStp(tarVal);
                }
                return valStp > nStp
            },
            alertText: $.i18n('bh-rv-noEarlierThan')
        },
        "after=": {
            func: function (val, field, ele) {
                if (val === '' || val === undefined) return true;
                var valStp = WIS_EMAP_SERV.toDateStp(val);
                var nStp;
                if (field == 'now') {
                    // 大于当前时间
                    nStp = parseInt(new Date().getTime()/1000);
                } else {
                    // 大于给定字段时间
                    (!ele) && (ele = $(document));
                    var tarEle = $('[data-name=' + field + ']', ele);
                    if (!tarEle || tarEle.length === 0) return true; // 对于联动字段缺失场景的兼容性护理
                    var tarVal = WIS_EMAP_INPUT.getValue(tarEle, {});
                    if (!tarVal) return true;
                    nStp = WIS_EMAP_SERV.toDateStp(tarVal);
                }
                return valStp >= nStp
            },
            alertText: $.i18n('bh-rv-noEarlierThan')
        }
    }

})(window.WIS_EMAP_INPUT = window.WIS_EMAP_INPUT || {});

(function () {
    var Plugin,
        _init,
        _getValidateCondition,
        _getValueLength; //插件的私有方法

    Plugin = (function () {
        /**
         * @module emapValidate
         * @alias 表单校验
         * @description 校验组件1.1，基于jqxValidator封装，已集成在emapForm中
         */
        function Plugin(element, options) {
            if ($.fn.emapValidate.rules) {
                $.fn.emapValidate.allRules = $.extend({}, $.fn.emapValidate.defaultRules, $.fn.emapValidate.rules);
            } else {
                $.fn.emapValidate.allRules = $.fn.emapValidate.defaultRules;
            }
            this.options = $.extend({}, $.fn.emapValidate.defaults, options);
            this.$element = $(element);
            _init($(element), options);

        }

        /**
         * @method validate
         * @description 触发校验
         * @return {Boolean} - 是否通过校验
         */
        Plugin.prototype.validate = function () {
            return this.$element.jqxValidator('validate');
        };

        /**
         * @method destroy
         * @description 销毁校验
         */
        Plugin.prototype.destroy = function () {
            this.options = null;
            $(this.$element).data('validate', false)
                .find('.jqx-validator-error-info').remove(); // 修复jqx destroy方法 对日期控件的bug
            return this.$element.jqxValidator('destroy');
        };
        return Plugin;
    })();

    _init = function (element, options) {
        var validateRules = _getValidateCondition(element, options);
        if (options.callback) {
            options.callback(validateRules);
        }
        element.jqxValidator({
            useHintRender: true,
            rules: validateRules
        });
    };

    _getValidateCondition = function (element, options) {
        var rules = [];
        $('[xtype]', element).each(function () {
            var _this = $(this);
            var itemRules;
            // 跳过隐藏字段 跳过disable 字段 跳过表格表单的只读字段和隐藏字段
            if (_this.closest('.bh-row').attr('hidden') || _this.closest('.bh-form-group').css('display') === 'none' || _this.closest('.bh-form-group').hasClass('bh-disabled') || _this[0].nodeName == 'P' || _this.attr('xtype') == 'div') {
                return true
            }
            //2016-04-20 qiyu 表格表单
            // var row = _this.closest('.bh-row');
            var row = _this.closest('.form-validate-block');

            var name = _this.data('name');
            var label = $('label.bh-form-label', row).text();
            var xtype = _this.attr('xtype');
            var dataType = _this.data('type');

            //  必填校验
            if ($('.bh-required', row).length > 0) {

                if (xtype == 'static') {
                    return;
                }
                itemRules = {
                    input: '[data-name=' + name + ']',
                    message: label + $.i18n('bh-ev-noEmpty'),
                    action: 'change, blur, valuechanged',
                    rule: 'required'
                };
                if (xtype == 'select' || xtype == 'multi-select2' || xtype == 'date-local' || xtype == 'date-ym' || xtype == 'date-full' || xtype == 'selecttable') {
                    itemRules.rule = function () {
                        if (_this.hasClass('jqx-rc-b-expanded')) {
                            return true;
                        }
                        return _this.val() != '';
                    };
                }

                if (xtype == 'number') {
                    itemRules.rule = function () {
                        return _this.find('input').val() != '';
                    };
                }

                if (xtype == 'date-local' || xtype == 'date-ym' || xtype == 'date-full') {
                    itemRules.action = 'change, valuechanged, close';
                }

                if (xtype == 'select' || xtype == 'multi-select2') {
                    itemRules.action = 'change, select';

                }

                if (xtype == 'tree' || xtype == 'multi-tree') {
                    itemRules.rule = function () {
                        return _this.emapDropdownTree('getValue') != '';
                    }
                }
                if (xtype == 'multi-select') {
                    itemRules.rule = function () {
                        return _this.jqxComboBox('getSelectedItems').map(function (item) {
                            return item.value;
                        }).join(',') != '';
                    };
                }
                if (xtype === 'textarea') {
                    itemRules.action = 'c-blur',
                        itemRules.rule = function () {
                            return _this.bhTxtInput('getValue') != '';
                        };
                }
                if (xtype === 'number-range') {
                    itemRules.rule = function () {
                        var valArr = _this.bhNumRange('getValue').split(',');
                        return valArr[0] != '' && valArr[1] != '';
                    };
                }
                // 上传的必填校验
                if (xtype == 'uploadfile' || xtype == 'uploadsingleimage' || xtype == 'uploadmuiltimage') {
                    itemRules.action = 'blur';
                    itemRules.rule = function () {
                        if (xtype == 'uploadfile') {
                            return _this.emapFileUpload('getFileNum') != 0;
                        } else if (xtype == 'uploadsingleimage') {
                            return _this.emapSingleImageUpload('getFileNum') != 0;
                        } else if (xtype == 'uploadmuiltimage') {
                            return _this.emapImageUpload('getFileNum') != 0;
                        }
                    }
                }
                rules.push(itemRules);
            }

            // double 类型的字段 自动添加 double 校验和  长度为21的校验
            if (_this.data('type') == 'double') {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: $.i18n('bh-ev-invalidNumber'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() === '') return true;
                        //qiyu 2016-9-1 double类型小数点后位数不限，需求人：吴芳。原始需求人：张毅
                        // return /^\d+(\.\d{1,2})?$/g.test( _this.val());
                        return /^(\-)?\d+(\.\d+)?$/.test(_this.val());
                    }
                });
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: $.i18n('bh-ev-cnel'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() == '') return true;
                        //qiyu 2016-9-1 double类型小数点后位数不限，需求人：吴芳。原始需求人：张毅
                        // return /^\d+(\.\d{1,2})?$/g.test(_this.val());
                        return /^(\-)?\d+(\.\d+)?$/g.test(_this.val());
                    }
                });
            }

            // int 类型的字段 自动添加 数字校验
            if (_this.data('type') == 'int') {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: $.fn.emapValidate.allRules['integer'].alertText,
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() == "") {
                            return true;
                        } // 空值不做校验
                        var value = _this.val();
                        // 开关按钮兼容处理
                        if (_this.attr('xtype') == 'switcher') {
                            if (value === true) {
                                value = 1;
                            } else if (value === false) {
                                value = 0;
                            }
                        }
                        return new RegExp($.fn.emapValidate.allRules['integer'].regex).test(value);
                    }
                });
            }

            // 内容长度校验
            /**
             * 5-16 学工业务线要求,textareaEasyCheck只对文本域有效
             *
             */

            // var maxLength = _this.attr('maxlength');
            var maxLength = _this.data('checksize');
            if (!maxLength) {
                if (options.textareaEasyCheck) {
                    //  bi~bi~bi~ 开启简单长度校验模式,所有字符 都算三个长度
                    // if (dataType == 'String' && (!xtype || xtype == 'text' || xtype == 'textarea')) {
                    if (dataType == 'String' && (xtype == 'textarea')) {
                        maxLength = _this.data('size') ? Math.floor(_this.data('size') / 3) : 0;
                    } else {
                        maxLength = _this.data('size') ? _this.data('size') : 0;
                    }
                } else {
                    // 默认:  严格校验模式 , 只有汉字算三个长度
                    maxLength = _this.data('size') ? _this.data('size') : 0;
                }
            }



            if (maxLength) {
                itemRules = {
                    input: '[data-name=' + name + ']',
                    message: label + $.i18n('bh-ev-cnel'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        return _getValueLength(_this.val()) <= maxLength;
                    }
                };

                if (options.textareaEasyCheck && xtype == 'textarea') {
                    itemRules.message = label + $.i18n('bh-ev-mustLess') + maxLength + $.i18n('bh-ev-characters');
                    itemRules.rule = function () {
                        return _this.val().length <= maxLength;
                    }
                }

                // 文本框金额类的 小数  长度校验
                if ((xtype == 'text' || !xtype)) {
                    if (maxLength.toString().indexOf(',') > -1) {
                        var lengthArr = maxLength.split(',');
                        itemRules.rule = function () {
                            if (_this.val() == '') return true;
                            var valArr = _this.val().toString().split('.');
                            if (valArr.length > 1) {
                                if (valArr[1].length > lengthArr[1]) return false
                            }

                            return valArr[0].length <= lengthArr[0] - lengthArr[1];
                        };

                        rules.push({
                            input: '[data-name=' + name + ']',
                            message: $.i18n('bh-ev-incorrectAmount'),
                            action: 'change, blur, valuechanged',
                            rule: function () {
                                if (_this.val() == '') return true;
                                return _this.val().length < 22;
                            }
                        });
                    } else {}

                }

                if (xtype == 'multi-select') {
                    itemRules.message = $.i18n('bh-ev-ChooseAtMost') + maxLength + $.i18n('bh-ev-items');
                    itemRules.rule = function () {
                        return _this.jqxComboBox('getSelectedItems').length <= (maxLength);
                    }
                }

                if (xtype == 'multi-select2') {
                    itemRules.message = $.i18n('bh-ev-ChooseAtMost') + maxLength + $.i18n('bh-ev-items');
                    itemRules.rule = function () {
                        return _this.jqxDropDownList('getCheckedItems').length <= (maxLength);
                    }
                }
                rules.push(itemRules);
            }

            // 正则校验
            var exp = decodeURI(_this.data('checkexp'));
            if (exp && exp != "undefined") {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: label + $.i18n('bh-ev-incorrect'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() == "") {
                            return true;
                        } // 空值不做校验
                        if (typeof exp === 'object') {
                            return new RegExp(exp).test(_this.val());
                        } else if (typeof exp === 'string') {
                            return new RegExp(exp.replace(/^\/(\^)?|(\$)?\/$/g, '')).test(_this.val());
                        }
                    }
                });
            }

            // 日期控件的 内容附件校验   防止提交奇怪的字符串
            if ($.inArray(xtype, ['date-local', 'date-ym', 'date-full']) > -1) {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: $.i18n('bh-ev-dateIncorrect'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() == "") {
                            return true;
                        } // 空值不做校验
                        return !isNaN(parseInt(_this.val()));
                    }
                })
                // 对日期进行强格式校验  必须符合 format 格式
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: $.i18n('bh-ev-dateIncorrect'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        if (_this.val() == "") {
                            return true;
                        } // 空值不做校验
                        var format = _this.data('format');
                        if (!format) {
                            if (xtype == 'date-local') {
                                format = '^\\d{4}-\\d{2}-\\d{2}$';
                            }
                        } else {
                            format = format.replace(/\w/g, '\\d');
                        }
                        if (!format) return true;
                        return new RegExp(format).test(_this.val())
                    }
                });
            }
            // 类型校验
            var jsonType = decodeURI(_this.data('jsonparam'));
            var checkType = decodeURI(_this.data('checktype'));
            if (!checkType || checkType == 'undefined') checkType = jsonType;
            checkType = checkType.replace(/\[|\]|\"|\{|\}|custom/g, "");
            if (checkType && $.fn.emapValidate.allRules[checkType]) {
                itemRules = {
                    input: '[data-name=' + name + ']',
                    message: $.fn.emapValidate.allRules[checkType].alertText,
                    action: 'change, blur, valuechanged'
                };
                if ($.fn.emapValidate.allRules[checkType].regex) {
                    itemRules.rule = function () {
                        var value = _this.val();
                        if (value == "") {
                            return true;
                        } // 空值不做校验
                        if (xtype == 'number-range') {
                            value = value.split(',');
                            return value.every(function (val) {
                                return new RegExp($.fn.emapValidate.allRules[checkType].regex).test(val);
                            });
                        }
                        return new RegExp($.fn.emapValidate.allRules[checkType].regex).test(_this.val());
                    }
                } else if ($.fn.emapValidate.allRules[checkType].func) {
                    itemRules.rule = function () {
                        if (_this.val() == "") {
                            return true;
                        } // 空值不做校验
                        return $.fn.emapValidate.allRules[checkType].func(_this.val());
                    }
                }
                rules.push(itemRules);
            } else if (/^after/g.test(checkType) || /^before/g.test(checkType)) {
                itemRules = {
                    input: '[data-name=' + name + ']',
                    action: 'change, blur, valuechanged'
                };
                var formEle = _this.closest('[bh-form-role=bhForm]');
                var targetLabel; // 参照字段的label

                if (/^before/g.test(checkType)) {
                    var checkField = checkType.replace('before', '');
                    if (checkField == 'now') {
                        targetLabel = $.i18n('bh-ev-today');
                    } else {
                        targetLabel = $('[data-name=' + checkField.replace('=', '') + ']', formEle).data('caption');
                    }
                    itemRules.message = $.fn.emapValidate.allRules['before'].alertText.replace('*1', label).replace('*2', targetLabel);
                    if (/=/g.test(checkField)) {
                        checkField = checkField.replace('=', '');
                        itemRules.rule = function () {
                            if (!_this.val()) return true;
                            return $.fn.emapValidate.allRules['before='].func(_this.val(), checkField, _this.closest('[bh-form-role=bhForm]'));
                        }
                    } else {
                        itemRules.rule = function () {
                            if (!_this.val()) return true;
                            return $.fn.emapValidate.allRules.before.func(_this.val(), checkField, _this.closest('[bh-form-role=bhForm]'));
                        }
                    }

                }
                if (/^after/g.test(checkType)) {
                    var checkField = checkType.replace('after', '');
                    if (checkField == 'now') {
                        targetLabel = $.i18n('bh-ev-today');
                    } else {
                        targetLabel = $('[data-name=' + checkField.replace('=', '') + ']', formEle).data('caption');
                    }
                    itemRules.message = $.fn.emapValidate.allRules['after'].alertText.replace('*1', label).replace('*2', targetLabel);
                    if (/=/g.test(checkField)) {
                        checkField = checkField.replace('=', '');
                        itemRules.rule = function () {
                            if (!_this.val()) return true;
                            return $.fn.emapValidate.allRules['after='].func(_this.val(), checkField, _this.closest('[bh-form-role=bhForm]'));
                        }
                    } else {
                        itemRules.rule = function () {
                            if (!_this.val()) return true;
                            return $.fn.emapValidate.allRules.after.func(_this.val(), checkField, _this.closest('[bh-form-role=bhForm]'));
                        }
                    }

                }
                rules.push(itemRules);
            }

            // 对于整数和 数字的校验 添加 最大为22 的长度校验  wuying  0726
            if ($.inArray(checkType, ['number', 'integer']) > -1) {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: label + $.i18n('bh-ev-cnel'),
                    action: 'change, blur, valuechanged',
                    rule: function () {
                        return _this.val().length < 22;
                    }
                })
            }
            if ($.inArray(xtype, ['uploadfile']) > -1) {
                rules.push({
                    input: '[data-name=' + name + ']',
                    message: ' ',
                    action: 'bh-file-upload-validate',
                    rule: function () {
                        return _this.find('.bh-error').length === 0;
                    }
                });
            }
        });
        return rules;
    };


    // 获取取值长度   中文为 3个字符
    _getValueLength = function (val) {
        return val.replace(/[\u0391-\uFFE5]/g, '***').length;
    };

    $.fn.emapValidate = function (options) {
        var instance;
        instance = this.data('validate');
        if (!instance) {
            return this.each(function () {
                return $(this).data('validate', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options]();
        return this;
    };

    /**
     * @memberof module:emapValidate
     * @prop {Boolean} [textareaEasyCheck=false] - 文本域长度计算方式是中文是否为3个字符
     */
    $.fn.emapValidate.defaults = {
        easyCheck: false,
        textareaEasyCheck: false
    };


    $.fn.emapValidate.defaultRules = WIS_EMAP_INPUT.validateRules;

}).call(this);
(function() {
  var Plugin, _eventBind;
  var defaultPhoto = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBARXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAABE6ADAAQAAAABAAABSAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/8AAEQgBSAETAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMABgYGBgYGCgYGCg4KCgoOEw4ODg4TGBMTExMTGB0YGBgYGBgdHR0dHR0dHSMjIyMjIygoKCgoLS0tLS0tLS0tLf/bAEMBBwcHDAsMFAsLFC8gGiAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL//dAAQAEv/aAAwDAQACEQMRAD8A6miiivpz89CiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q6miiivpz89CiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R6miiivpz89CiiigAooooAKKKKACiiigAooooAKKw9S8Q6dpuUdvMkH8Ccn8fSuIvfGGo3BK2wEC+3J/OuOvjqVPRvU9LC5TXr6xVl3Z6kzKg3OQB6nis6XWNLh/1lzGPoc/yrxqe8urlt08rOfck1Xrz55u/sxPZpcNL/l5P7kewt4n0Rf8AluD9Af8ACo/+Eq0X/nqf++TXkNFY/wBrVeyOlcO4fu/w/wAj2JfE+iN/y3A+oP8AhV2LV9Mn/wBXcRn6nH868QpaqOb1OsURPhyi/hk/wPflZXG5SCPUUteEwXt3bNut5XQ+xNdNZeMb+AhbtRMvr0b8666WbU3pNWPOr8O1o605J/geoUVj6brun6mAsL7ZP7jcH8PWtivShUjNc0XdHh1aU6cuWaswoooqzMKKKKACiiigAooooAKKKKACiiigD//S6miiivpz89CiiigAooooAKKKKACiignHJoAZJJHDG0srBVUZJPQCvNta8VzXJa308mOLoX/ib6egqDxLrzX8ps7VsW6Hkj+Mj+npXJV4GOzBtunTenc+vynJ4xSrV1r0Xb/gikknJ5JpKKK8g+kCiiigAooooAKKKKACiiigBysykMpwR0IrudD8VvGy2upnch4EncfX2rhKK2oYidKXNBnLisHTxEeSoj39WV1DKcg8gilrzTwvr7W0i6ddtmJjhGP8J9Poa9Lr6jDYiNaPMj4LHYKeGqckvk+4UUUV0HGFFFFABRRRQAUUUUAFFFFAH//T6miiivpz89CiiigAooooAKKKKACuS8WaqbO0FnCcSz9cdl7/AJ9K60nAya8U1m+OoajLcZyudqf7o6f415+ZYj2dOy3Z7OSYNVq3NLaOv+RlUUUV8yfdBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAC16z4X1U6hZeTMczQYU+47GvJa2tAvzp+pxSk4Rzsf6H/A812YHEeyqLs9zzM2war0GlutUezUUUV9Ufn4UUUUAFFFFABRRRQAUUUUAf/9TqaKKK+nPz0KKKKACiiigAooooAyNeuvsekzyg4YrtH1bivFq9M8bTbbGGAfxyZP0A/wDr15nXzmazvV5ex9tw/S5cPz92FFFFeYe6FFFFABRRRQAUUUUAFFFFABRRRQAUUuCOtJQAUUUUAe2aLd/bdLguCcsVw31HBrUrjPBU++wlgP8AyzkyPow/xzXZ19dhanPSjI/OMwo+yrzgu4UUUV0HGFFFFABRRRQAUUUUAf/V6miiivpz89CiiigAooooAKKKKAPOvHD5nto/RWP5kf4Vwldn42P/ABMIR/0z/qa4yvlce715H6DlCthaf9dQooorjPSCiiigAooooAKKKKACipoLe4upRDbRtLI3RUBYn8BXo+h/DHV7/bNqrCziP8J+aQj6dB+P5UNgebwwzXEqwwI0jucKqjJJ9gK9i8LfDQ5S+8QjjqtuP/Zz/QV6VonhnR9Aj26fCA5GGlblz+P9BgVv1Dl2GUptOsLi3FpPBG8QGAjKCAPpXgvjzwbHoTrqOnA/ZJW2leuxuuM+h7V9D1j+INOTVtGurBhkyRnb/vDlf1ApJ2A+R6KUjBIPakrQR3PgeTFzcRf3kU/kT/jXo9eXeCzjVXX1hP8AMV6jX02WO9FHwufRtim+6QUUUV6B4wUUUUAFFFFABRRRQB//1upooor6c/PQooooAKKKKACiiigDzTxsuL6BvWPH5GuKrv8AxzH81rKP9tT+lcBXyuYK1eR+gZPK+Fh/XUKWkr6N+GMXl+GQ39+Z2/kP6VxN2PTPnZYpG+6pP0FWU07UJf8AV20rfRGP9K+w6KnnHY+S4fDPiKf/AFenXJ9zEwH5kAVtW/w88WXGM2giB7yOg/TJP6V9NUUcwWPCLP4TanIQb68hiHpGGc/rtFdhp/ww8O2uGuzLdMP77bV/JcH9a9HpBS5mBTstN0/TY/KsLeOBfRFAz9cdau0UUgCiiikAUUVVvL+y0+Ez30yQRj+J2Cj9aYHyZrUAttXvLccCOZ1/JiKzK2PENxBea5fXVq2+KWd3RumQWJB5rHrUR13gv/kLP/1xb+a16lXmfglM380n92PH5kf4V6ZX0uVr9yj4bP3fFP0QUUUV6J4oUUUUAFFFFABRRRQB/9fqaKKK+nPz0KKKKACiiigAooqe2t3uplgj6samUkldlQi5NRjuzi/GNq9xp0bRKWZJBwBk4IIrzOe2uLZ9lxG0bdcOCD+tfXtpY29mgWJRu7seprM8SaDa+INMktJ1HmAExPjlW7H6etfJ43Exq1OaKP0HLMJPD0VTm9T5Or6k8DQfZ/C1kpGCylj+LH+lfMDwyRTtbyDa6sUI9CDg19c6PB9l0m0t8Y2QoD9dozXLI9E0qKKKzAKKKKACkFLSCmAtFFFIAooooAK8p+KulifTYNVQfPA+xj/st0/I/wA69WrE8SWQ1HQb20IyWiYr/vL8w/UU0B8lU4KxGQCcU5I3kkWJBlmIUD1J4r6t0LQbLR9Ii05Y1b5R5pIB3sRyT61o3YXoeIeB4vluZvUqo/DJ/rXfVqX3h+00jfPp0YjilfcyjoGI7e3FZdfVZc4+wjys+Aznm+tTclb/AIYKKKK7TywooooAKKKKACiiigD/0Opooor6c/PQooooAKKKKACun8OwgtLOeoAUfj1rmK67w6R5Eo7hhXn5nJqhKx62RxTxUb+f5HRUUUV8mffHzXr+l58eSWCDie4Rh/20wT+pNfSgAAwOgryO8svP+KVuccLEJT/wFWx+oFeuVUgCiiipAKKKKACkFLSCmAtFFFIAooooAKCARg8g0UUAfLuh6eD40gsGHEd0eP8ArmSf6V9RV4LpEAX4oyj+7cTt+Yb/ABr3qqkBWvIhPayRHupx9e1ecnrXprEBST0ArzI9TXvZLJ2mvQ+T4liuanLrqJRRRXuHy4UUUUAFFFFABRRRQB//0epooor6c/PQooooAKKKKACt7QLgRXJhY4Eg4+o6Vg05WZGDKcEcg1jiKKqwcH1OjCYh0asaq6Hp1FYdhrUE6BLlhHIO56GtlJY5OY2DY9Dmvj62HnTdpo/RMPi6VaKlTlci+yWv2n7Z5Seft2+ZtG7b6Z64qxRRWR0BRRRSAKKKKACkFLSCmAtFFFIAooooAKKKKAKS6bpyXRvUtohOckyhBv56/NjNXaCccmqc2oWcC7nkX6A5P5VcYSk7RVyKlWMFebsRarcC2snOfmcbR+NcBWjqN+99Lu6Iv3RWdX1WX4V0adpbs+DzfHLEVrw+FaIKKKK7zygooooAKKKKACiiigD/0upooor6c/PQooooAKKKKACiiigArovDs22eSE/xrkfUVztXLCf7Pdxy9gefoetc2Lpe0pSidmX1/ZV4Tfc9Eooor40/SAooopAFFFFABSClpBTAWiiikAUUUUAFFFFAFLUZfJspX/2cD8eK88rrfEM+2KO3HVjuP0FclX0+UUuWlzPqfEcQV+fEci+ygooor1TwgooooAKKKKACiiigAooooA//0+pooor6c/PQooooAKKKKACiiigAooooA9A0u4+02SMT8yjafqK0K43QrvybgwMflk6fUV2VfIY+h7Kq10ep+h5Vivb0Iye60YUUUVxHohRRRQAUgpaQUwFooopAFFFFABRRWdqt39ktGYH5m+VfxrSnTc5KEepnWqxpQdSWyOR1W5+03rsDlV+UfQVnUtJX2tOmoRUF0PzOtVdScqkt2FFFFWZhRRRQAUUUUAFFFFABRRRQB//U6miiivpz89CiiigAooooAKKKKACiiigBysVIZTgjpXdaZqKXkQVjiVRyPX3rg6ekjxsHjJUjoRXHjMHGvGz3R6OXZhLCzutU90em0VzFlr3SO8H/AAIf1ro4pY5l3xMGB9K+Yr4WpSdpo+4wuOpYhXpv5dSSiiiuY6wpBS0gpgLRRRSAKKKyrzV7W1yqne/oK0pUpVHywVzKtXp0o81R2RpSSJEhkkIVR1JrhNTvjezlh9xeFH9ajvNQuL1syHC9lHSqNfSYDL/Y+/P4vyPjM1zf6x+7p6R/MKKKK9Q8MKKKKACiiigAooooAKKKKACiiigD/9XqaKKK+nPz0KKKKACiiigAooooAKKKKACiiigAqxb3E1u4aFyv0qvTl+8KiaTi0zSlJxmmmdlDqxHE659xWpFd28v3HH0NclRXwfMfrLpJna9aBXHrPMn3XI/Gnm7uW4Mhp8xHsmdU8kcYy7AfWs+bVIU4jG8/pXPFmbliT9aSjmKVJdQ1HULmXC7tqnsKxKu3nVapV9dliX1eLPzvPm/rc16fkFFFFegeOFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/W6miiivpz89CiiigAooooAKKKKACiiigAoopkksUK75XVF9WOB+tAJD6cv3hWBL4k0aOUQrOJHJwAnP69KmTXbIuBh+T6D/GuapiaUdJSR6OGyvFVffp0m16HZUUUV8QfqAUUUUAFFFFAFG86rVKmatqdvZypFLuJIzwKxJPEulQsouHMW7oWHH6Zr6vLcRTVGMHJXPg87y3Eyrzrxpvl01tpsb1FVbe+s7sZtpkkz/dIJ/KrVeonfY+bcWtGFFFFMQUUUUAFFFFABRRRQAUUUUAFFFFAH//X6miiivpz89CiiigAooooAKKK5zXvElpokew/vLhh8sY/mfQVM5qKvIulSlUlywV2b8s0UEZlncIi9WY4ArjtQ8c6Xa5S0DXDjuPlX8zXmOp6zqGrS+ZdyEjsg4UfQVlV5tXHN6QPoMPk0VrVd2dfe+NdZusrCywKeyDn8zzXMz3d1ctvuJXkJ7sSarUVxzqSl8TPWp4enT+CNixbS+RcRy/3WBr0ZHBCyIcg4INeY11Oi6ku0Wk5xj7hP8q4cVTbXMuh9LkWNjTm6U9n+Z73pl4t9ZpMDlsYb6jrV+vLNN1KfTZt8fKH7ynof/r16FZapZ3yjyXAbuh4b/69ecd+KwkqcrrY0aKKKRxhSEgAknAHU1FNcQ26eZO4RfUmuJ1jXzdKbazysZ+83dv/AK1BvQw8qrtEytXu1vb+SZPuj5V+grz3xBOHnSBT9wc/U10F/fx2URZuXP3Vrg5JHldpHOWY5NduFpu/Ox53io06SwsN+oiSPGcoxU+xxW7Z+KNassCO4Z1H8L/MP1rn6K9GM3HZnyM6UJq01c9QsPH8bYTUYNv+3Hz+h/xrubDVLDU032Uyyeo6EfUHmvnapoJ5raQTQOUdeQVODXXTxs18Wp5lfJ6Utaej/A+kqK858P8AjUTMtnq5CseFl6A/73p9a9GBBGR0r06dWM1eJ89iMNOjLlmgooorQwCiiigAooooAKKKKAP/0Opooor6c/PQooooAKKKKAMTxBqw0fTXuhgyH5Ywe7H/AA614RPPNdTNPOxd3OST3Ndx4+v/ADb+KwU/LAu5v95v/rfzrga8fGVeafL0R9XlWHUKSm92FFFFcZ6gUUUUAFLSUUAb1lrc0AEdwPMQd+4rpINRs58GOQA+h4Nee0tc9TDRlqtD18LnVakuWXvLzPXYtU1CIDy53wOgySKkfWdTkGDOw+nH8q8iWaVPuOR9DTjcXDcNIx/E1j9Tfc7v7dovV0dfl/kejXN6gJkupvm7lmya5671+NQUtBuP949PyrlCSetJWkMJFavU58Rn1WS5aS5USyzSTuZJWLMe5qKiiupI8OUm3dhRRRQIKKKKACvUPBGuyTE6RdNuKrmInrgdV/wry+r2m3jaffwXi/8ALJwx9x3H4itqFRwkmcuMw6rU3B79D6KopqOsiB0OQwyD7GnV7x8UFFFFABRRRQAUUUUAf//R6miiivpz89CiiigAoJAGT2orG8Q3f2LRbqcHB2FV+rfKP51MpWTZdODnJRXU8Q1W7N/qVxdk5Ejkj6dB+lZ9FFfPN3d2fdRiopRQUUUUigooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD3XwnefbNDgZjloh5bf8B4H6Yro68z+Ht3/AMfViT6SKP0P9K9Mr3cPPmppnxePpclaUf61CiiitzkCiiigAooooA//0upooor6c/PQooooAK4H4gXXl6fBaA8yybj9FH+JFd9Xj3jy687V0tweIIwPxbk/piubFytTZ6GV0+auvLU4iiiivEPrwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA6fwfdfZdegycLKDGfxHH6gV7jXzdbTtbXMVynWJ1cfgc19HxuskayIchgCD7GvVwEvdcT5vO6dpxn3HUUUV3niBRRRQAUUUUAf/9PqaKKK+nPz0KKKKACvn3Xbn7XrF1PnIMjAfReB+gr6CPSvnC7/AOPub/fb+defmD0SPcyOK5psrUUUV5Z9GFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABXvfhm5+1aFayE5ITYf+AfL/SvBK9u8F/8i/D/ALz/APoRruwD99ryPHzqK9kn5nVUUUV6x8wFFFFABRRRQB//2Q==';
  /**
   * @module emapAvatarUpload
   * @alias 头像裁剪上传
   * @description 头像裁剪<br>
   * 依赖项：<br>
   * @example
   * <script src="http://res.wisedu.com/bower_components/cropper/cropper.min.js"></script>
   * $container.emapAvatarUpload({
   *     contextPath: '/emap',
   *     size: 5120
   * })
   */
  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapAvatarUpload.defaults, options);
      this.$element = $(element);
      _init(this.$element, this.options);
    }

    /**
     * @method destroy
     * @description 销毁
     */
    Plugin.prototype.destroy = function() {
      this.options = null;
      $(this.$element).data('emapAvatarUpload', false).empty();
    };
    Plugin.prototype.getValue = function() {};

    /**
     * @method disable
     * @description 禁用
     */
    Plugin.prototype.disable = function() {
      $('.bh-emapAvartar-btn', this.$element).hide()
    };

    /**
     * @method disable
     * @description 启用
     */
    Plugin.prototype.enable = function() {
      $('.bh-emapAvartar-btn', this.$element).show()
    };

    /**
     * @method save
     * @description 保存附件
     */
    Plugin.prototype.save = function() {
      if (this.options.fileId) {
        var result = deleteFileByToken(this.options).success && saveAttachment(this.options).success;
        delete this.options.fileId;
        return result;
      }
    };
    return Plugin;
  })();


  //生成dom
  function _init(element, options) {
    // contextPath 兼容
    options.contextPath = options.contextPath || WIS_EMAP_SERV.getContextPath();
    // 默认展示头像
    if (options.defaultAvatar === undefined) {
      options.defaultAvatar = defaultPhoto
    }
    if (options.token && options.token != null) {
      // 已有图片
      options.scope = options.token.substring(0, options.token.length - 1);
      // options.displayAvatar = options.contextPath + '/sys/emapcomponent/file/getFileByToken/' + options.token + '.do?date=' + new Date().getTime();
      options.displayAvatar = options.contextPath + '/sys/emapcomponent/file/getSingleImageByToken.do?fileToken=' + options.token + '&date=' + new Date().getTime();
      options.newToken = false;
    } else {
      // 新上传
      options.scope = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
      options.token = options.scope + 1;
      options.displayAvatar = options.defaultAvatar;
      options.newToken = true;
    }

    options.$wrap = $('<div class="bh-emapAvatar-wrap"><img class="bh-emapAvatar-avatar" src="' + options.displayAvatar + '"><a class="bh-emapAvartar-btn" href="javascript:void(0)">' + $.i18n('bh-au-adjustHeadImage') + '</a></div>')
      .css({
        'height': options.width / options.ratio,
        'width': options.width
      });

    if (options.disabled) $('.bh-emapAvartar-btn', options.$wrap).hide();
    element.append(options.$wrap);

    _eventBind(element, options);

  }

  _eventBind = function(element, options) {
    var $wrap = options.$wrap;
    // 点击修改头像
    $wrap.on('click', '.bh-emapAvartar-btn', function() {
      $.emapAvatarUploadWindow(element, options);
    });

    $('.bh-emapAvatar-avatar', element).one('error', function() {
      $(this).attr('src', options.defaultAvatar);
    });
  };


  $.fn.emapAvatarUpload = function(options, params) {
    var instance;
    instance = $(this).data('emapAvatarUpload');
    if (!instance) {
      return this.each(function() {
        if (options == 'destroy') {
          return this;
        }
        return $(this).data('emapAvatarUpload', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params);
    return this;
  };


  /**
   * @memberof module:emapAvatarUpload
   * @prop {String} [contextPath] - 根路径
   * @prop {Number} [ratio=1] - 图片宽高比
   * @prop {Int} [width=100] - 图片显示宽度
   * @prop {Int} [actualWidth] - 裁剪出图片的实际宽度
   * @prop {String} [token] - 文件token,不传则组件生成随机的新token， 传token则组件自动请求token下已有的文件信息并渲染到页面上
   * @prop {String} [storeId=image] - emap文件类型
   * @prop {Array} [type=['jpg', 'png', 'jpeg']] - 上传文件的格式要求
   * @prop {Int} [size=5120] - 上传文件的大小要求，单位为KB
   * @prop {Int} [disabled=false] - 是否禁用
   * @prop {Function} [onSubmit] - 头像裁剪成功的回调 参数为token
   * @prop {Object} [saveParams] - 保存请求的附带参数
   * @prop {Boolean} [autoSave=true] - 是否自动调用保存方法
   */
  $.fn.emapAvatarUpload.defaults = {
    storeId: 'image',
    contextPath: "",
    ratio: 1,
    width: 100,
    actualWidth: null, // 需要图片的实际尺寸
    type: ['jpg', 'png', 'jpeg'],
    size: 5120,
    disabled: false,
    autoSave: true,
    saveParams: {}
  };

  $.emapAvatarUploadWindow = function(element, options) {
    // 兼容直接调用此方法导致默认参数没有传进来的问题
    options.autoSave = options.autoSave === undefined ? true : options.autoSave
    options.winContent = $('<div id="emapAvatarUploadWindow">' +
      '<ul style="display: none;">' +
      '<li>' + $.i18n('bh-au-uploadFromLocal') + '</li>' +
      '<li>' + $.i18n('bh-au-RecommondHeadImage') + '</li>' +
      '</ul>' +
      '<div>' +
      '<div class="bh-emapAvatar-local"></div>' +
      '<div class="bh-emapAcatar-error-msg bh-text-center" style="color: red;"></div>' +
      '</div>' +
      '<div>' +
      '</div>');

    var initUpload = function(input, options) {
      /***
       * emap 相关逻辑代码
       *
       */
      var fileReader = 'FileReader' in window;
      input.fileupload({
        url: options.uploadUrl,
        autoUpload: true,
        multiple: false,
        dataType: 'json',
        limitMultiFileUploads: 1,
        formData: {
          size: options.size,
          type: options.type,
          storeId: options.storeId
        },
        submit: function(e, data) {
          $('.bh-emapAcatar-error-msg', options.winContent).html('').hide();
          var file = data.files[0];
          $('.bh-emapAvatar-text-info', options.winContent).show();
          $('.bh-emapAvatar-text-error', options.winContent).hide();

          // 文件的大小 和类型校验
          if (options.type && options.type.length > 0) {
            if (!new RegExp(options.type.join('|').toUpperCase()).test(file.name.toUpperCase())) {
              $('.bh-emapAvatar-text-info', options.winContent).hide();
              $('.bh-emapAvatar-text-error', options.winContent).html($.i18n('bh-au-wrongType')).show();
              return false;
            }
          }

          if (fileReader && options.size) {
            if (file.size / 1024 > options.size) {
              $('.bh-emapAvatar-text-info', options.winContent).hide();
              $('.bh-emapAvatar-text-error', options.winContent).html($.i18n('bh-au-passTheMax')).show();
              return false;
            }
          }
          $('.bh-emapAvatar-loader', options.winContent).jqxLoader('open');

        },
        done: function(e, data) {
          var file = data.files[0];
          if (data.result.success) {
            // 上传成功
            $('.bh-avatar-img', options.winContent).attr('src', data.result.tempFileUrl).cropper('destroy');
            initCrop($('.bh-avatar-img', options.winContent), options);
            $('.bh-avatar-img-block', options.winContent).show();
            // 上传成功后删除原有的 临时文件图片
            deleteTempFile(options);

            options.fileId = data.result.id;
          } else {
            // 上传失败
            $('.bh-emapAcatar-error-msg', options.winContent).html($.i18n('bh-au-imageUploadFail')).show();
          }
          $('.bh-emapAvatar-loader', options.winContent).jqxLoader('close');
        },
        fail: function(e, data) {
          var file = data.files[0];
          $('.bh-emapAvatar-loader', options.winContent).jqxLoader('open');
          $('.bh-emapAcatar-error-msg', options.winContent).html($.i18n('bh-au-imageUploadFail')).show();
        }
      });
    };

    options.uploadUrl = options.contextPath + '/sys/emapcomponent/file/uploadTempFile/' + options.scope + '/' + options.token + '.do';


    $('.bh-emapAvatar-local', options.winContent).html('<div class="bh-emapAvatar-editArea" bh-avatar-role="editArea">' +
      '<div class="bh-emapAvatar-upload-block">' +
      '<a href="javascript:void(0)" class="bh-btn bh-btn-default bh-emapAvatar-upload">' +
      '<i class="iconfont icon-add"></i>' + $.i18n('bh-au-chooseImages') +
      '<input type="file">' +
      '</a>' +
      '<p class="bh-text-caption bh-color-caption bh-text-center bh-emapAvatar-text-info"></p>' +
      '<p class="bh-text-caption bh-color-danger bh-text-center bh-emapAvatar-text-error"></p>' +
      '</div>' +
      '<div class="bh-avatar-img-block">' +
      '<img class="bh-avatar-img" src="' + options.displayAvatar + '" style="display: none;">' +
      '<p ><a href="javascript:void(0)" class="bh-emapAvatar-reUpload">' + $.i18n('bh-au-reupload') + '</a> ' +
      //  旋转功能暂未提供
      //'| <a href="javascript:void(0)"><i class="iconfont icon-refresh"></i>90°旋转</a>' +
      '</p>' +
      '</div>' +
      '<div class="bh-emapAvatar-loader"></div>' +
      '</div>' +
      '<div class="bh-emapAvatar-display">' +
      '<div class="bh-emapAvatar-preview-100 bh-emapAvatar-preview"><div class="bh-emapAvatar-preview-div"></div></div>' +
      '<p class="bh-mb-8"></p>' +
      '<div>' +
      '<div class="bh-emapAvatar-preview-40 bh-pull-left bh-emapAvatar-preview" style="margin-right: 8px;"><div class="bh-emapAvatar-preview-div"></div></div>' +
      '<div class="bh-emapAvatar-preview-40 bh-pull-left bh-emapAvatar-preview" style="border-radius: 50%;"><div class="bh-emapAvatar-preview-div"></div></div>' +
      '<p class="bh-clearfix bh-mb-8"></p>' +
      '<div class="bh-emapAvatar-preview-28 bh-pull-left bh-emapAvatar-preview" style="margin-right: 8px;"><div class="bh-emapAvatar-preview-div"></div></div>' +
      '<div class="bh-emapAvatar-preview-28 bh-pull-left bh-emapAvatar-preview" style="border-radius: 50%;"><div class="bh-emapAvatar-preview-div"></div></div>' +
      '<p class="bh-clearfix bh-mb-8"></p>' +
      '</div>' +
      '</div>' +
      '');

    $('.bh-avatar-img', options.winContent).one('error', function() {
        $(this).attr('src', options.defaultAvatar);
      })
      .on('load', function() {
        initCrop($(this), options);
      }); // 初始化裁剪插件

    BH_UTILS.bhWindow(options.winContent, $.i18n('bh-au-uploadHeadImage'), undefined, {
      width: '560px',
      close: function() {
        $('.bh-avatar-img', options.winContent).cropper('destroy');
      }
    }, function() {
      return submitEdit(options);
    });
    // 预览窗口 尺寸和文字渲染
    $('.bh-emapAvatar-preview', options.winContent).each(function() {
      var width = $(this).width();
      var height = parseInt($(this).width() / options.ratio);
      var p = $(this).next('p');
      $(this).css({
        height: height
      });
      if (p.length > 0) {
        p.html(width + ' * ' + height + 'px');
      }
    });

    // 上传说明渲染
    var typeStr = options.type.join('、').toUpperCase();
    var sizeStr = (options.size > 1024) ? options.size / 1024 + 'M' : options.size + 'K';
    $('.bh-emapAvatar-text-info', options.winContent).html($.i18n('bh-au-onlyHave') + typeStr + '，' + $.i18n('bh-be-sizeNotPass') + sizeStr);

    // 初始化tab  添加推荐头像功能时放开注释
    //$('#emapAvatarUploadWindow').jqxTabs({ width: '100%', height: 200, position: 'top'});

    //初始化loader
    $('.bh-emapAvatar-loader', options.winContent).jqxLoader({});

    // 初始化 上传控件
    initUpload($('input[type=file]', options.winContent), options)

    // 重新上传事件绑定
    $('.bh-emapAvatar-reUpload', options.winContent).on('click', function() {
      $('input[type=file]', options.winContent).click();
    });

    function initCrop(ele, options) {
      ele.cropper({
        aspectRatio: options.ratio,
        viewMode: 1,
        movable: false,
        zoomOnWheel: false,
        preview: '.bh-emapAvatar-preview'
      });
    }

    function submitEdit(options) {
      if (options.fileId) {
        var cutResult = cutTempFile(options);
        if (cutResult.success && deleteTempFile(options).success) {
          if (options.autoSave && deleteFileByToken(options).success && saveAttachment(options).success) {
            options.onSubmit && options.onSubmit(options.token);
            $('.bh-emapAvatar-avatar', element).attr('src', options.contextPath + '/sys/emapcomponent/file/getSingleImageByToken.do?fileToken=' + options.token + '&date=' + new Date().getTime());
            options.displayAvatar = options.contextPath + '/sys/emapcomponent/file/getSingleImageByToken.do?fileToken=' + options.token + '&date=' + new Date().getTime();
            return true;
          } else {
            // 调整了onSubmit触发的位置，避免保存成功后临时文件取不到的问题
            $('.bh-emapAvatar-avatar', element).attr('src', cutResult.tempFileUrl);
            $('.bh-emapAvatar-avatar', element).one('load', function() {
              options.displayAvatar = cutResult.tempFileUrl;
              options.onSubmit && options.onSubmit(options.token);
            })
          }
        } else {
          if (!cutResult.success) {
            $('.bh-emapAcatar-error-msg', options.winContent).html(cutResult.error ? cutResult.error : $.i18n('bh-au-avatarFail')).show();
            return false;
          }
        }
      } else {
        if (options.newToken) {
          options.onSubmit && options.onSubmit();
        } else {
          options.onSubmit && options.onSubmit(options.token);
        }
      }
    }

    // 裁剪图片
    function cutTempFile(options) {
      var cutData = $('.bh-avatar-img', options.winContent).cropper('getData', true);
      if (options.actualWidth) {
        cutData.actualWidth = options.actualWidth;
        cutData.actualHeight = parseInt(options.actualWidth / options.ratio);
      }
      return doRequest(
        options.contextPath + '/sys/emapcomponent/file/cutTempFile/' + options.scope + '/' + options.token + '/' + options.fileId + '.do',
        cutData
      );
    }

    // 删除原有的临时文件
    function deleteTempFile(options) {
      if (options.fileId) {
        return doRequest(
          options.contextPath + '/sys/emapcomponent/file/deleteTempFile/' + options.scope + '/' + options.token + '/' + options.fileId + '.do', {}
        );
      }
      return {
        success: true
      };
    }
  };

  function deleteFileByToken(options) {
    return doRequest(
      options.contextPath + '/sys/emapcomponent/file/deleteFileByToken/' + options.token + '.do', {}
    );
  }

  function saveAttachment(options) {
    var saveParams = $.extend({}, {
      attachmentParam: JSON.stringify({
        storeId: options.storeId
      })
    }, options.saveParams);
    return doRequest(options.contextPath + '/sys/emapcomponent/file/saveAttachment/' + options.scope + '/' + options.token + '.do', saveParams);
  }

  function doRequest(url, param) {
    var result;
    $.ajax({
      type: 'post',
      data: param,
      url: url,
      dataType: 'json',
      async: false
    }).done(function(res) {
      result = res;
    }).fail(function(res) {
      $('.bh-emapAcatar-error-msg').html($.i18n('bh-au-requestFail')).show();
      result = res;
    });
    return result;
  }

}).call(undefined);
(function($) {
    /**
     * @module emapCard
     * @alias 卡片列表
     * @description 卡片列表
     */
    var Plugin;

    Plugin = (function() {
        function Plugin(element, options) {
            this.gVars = {
                gPageNumber: null,
                gPageSize: null,
                gTotal: 0,
                gResult: {},
                gParams: {}
            };
            //将插件的默认参数及用户定义的参数合并到一个新的obj里
            this.settings = $.extend({}, $.fn.emapCard.defaults, options);
            //将dom jquery对象赋值给插件，方便后续调用
            this.$element = $(element);
            init(this);
        }

        return Plugin;

    })();

    Plugin.prototype = {
        /**
         * @method reload
         * @description 刷新卡片数据
         * @param {Object} params - 附带参数
         * @param {Boolean} gotoFirstPage 是否跳转到第一页 默认跳转 设置为false停留在当前页
         */
        reload: function(params, gotoFirstPage) {
            this.gVars.gParams = params || this.gVars.gParams;
            //刷新回到首页
            if (gotoFirstPage !== false && (this.gVars.gParams.pageNumber === undefined || gotoFirstPage)) {
                this.gVars.gParams.pageNumber = "0";
            }
            render(this, null, null, this.gVars.gParams);
        },

        reloadFirstPage: function(params) {
            this.reload(params, true);
        },

        /**
         * @method getTotalRecords
         * @description 获取卡片记录总条数
         */
        getTotalRecords: function() {
            return this.gVars.gTotal;
        },

        /**
         * @method gResult
         * @description 获取卡片数据
         */
        getResult: function() {
            return this.gVars.gResult;
        }

    };


    function init(instance) {
        var settings = instance.settings;
        var $element = instance.$element;
        layout($element);
        settings._init = true;
        render(instance, null, null, instance.gVars.gParams);
    }

    function layout($element) {

        var _html =
            '<div>' +
            ' <div class="bh-emapCard-card-list"></div>' +
            ' <div class="bh-emapCard-card-pagination" style="clear:both;"></div>' +
            '</div>';

        $element.html(_html);
    }

    function render(instance, pageNumber, pageSize, gParams) {
        var settings = instance.settings;
        var $element = instance.$element;
        gParams = gParams || {};
        pageSize = parseInt(pageSize || instance.gVars.gPageSize || gParams.pageSize || settings.pageSize || 12);
        pageNumber = parseInt(pageNumber || gParams.pageNumber || instance.gVars.gPageNumber || settings.pageNumber || 0);
        if (!gParams.querySetting && !settings._init && !settings.params) {
            gParams.querySetting = "[]";
        }

        instance.gVars.gPageNumber = pageNumber;
        instance.gVars.gPageSize = pageSize;

        var params = $.extend({}, settings.params, gParams, {
            pageSize: pageSize,
            pageNumber: pageNumber + 1,
            querySetting: gParams.querySetting
        });

        if (!settings.pageable) {
            delete params.pageSize;
            delete params.pageNumber;
        }

        settings._init = false;
        var type = 'post';
        var url = WIS_EMAP_SERV.getAbsPath(settings.pagePath).replace('.do', '/' + settings.action + '.do');

        //mock模式
        if (settings.pagePath.indexOf('.do') == -1) {
            type = settings.url ? 'post' : 'get';
            url = getMockDataUrl(settings.pagePath, settings.action, settings);
        }

        if (settings.isOnceEmpty) {
            renderContent(instance, [], 0, pageNumber, pageSize);
        } else {
            $.ajax({
                url: settings.url || url,
                data: params,
                type: type
            }).done(function(res) {
                instance.gVars.gResult = res;
                var total = settings.url ? res.datas.totalSize : res.datas[settings.action].totalSize;
                instance.gVars.gTotal = total;
                var rows = settings.url ? res.datas.rows : res.datas[settings.action].rows;
                // 联动高级搜索的数据总条数
                if (settings.searchElement && settings.searchElement.length > 0) {
                    settings.searchElement.emapAdvancedQuery('updateTotalNum', total);
                }
                renderContent(instance, rows, total, pageNumber, pageSize);
            });
        }
    }

    function renderContent(instance, rows, total, pageNumber, pageSize) {
        var settings = instance.settings;
        var $element = instance.$element;
        var $cardContainer = $('<div class="bh-clearfix"></div>');
        var rLen = rows.length;
        if (rLen) {
            for (var i = 0; i < rLen; i++) {
                var newRow = settings.cardBeforeRender ? (settings.cardBeforeRender(rows[i]) || rows[i]) : rows[i];
                if (window.Hogan) {
                    $cardContainer.append(compile(settings.template, newRow));
                } else if (Vue) {
                    var tempDom = $(settings.template);
                    new Vue({
                        el: tempDom[0],
                        data: {
                            row: newRow
                        }
                    });
                    tempDom.find('.card-opt-button').data('row', newRow);
                    $cardContainer.append(tempDom);
                }
            }
        } else {
            var emptyHtml = '<div style="display:table;width:100%;height:100%;padding:22px 0 16px 0"><div class="bh-color-info-3" style="text-align:center;vertical-align:middle;display:table-cell;"><i class="iconfont" style="font-size:48px;">&#xe62a;</i><h3 style="color:#999;margin-top: 12px;">' + $.i18n('bh-cd-noDatas') + '</h3></div></div>';
            $cardContainer.html(settings.emptyHtml || emptyHtml);
        }

        $element.find('.bh-emapCard-card-list').html($cardContainer, true);

        if (settings.pageable) {
            $element.find('.bh-emapCard-card-pagination').empty();
            if (rLen) {
                $element.find('.bh-emapCard-card-pagination').pagination({
                    pagenum: pageNumber,
                    pagesize: pageSize,
                    totalSize: total,
                    mode: settings.pageMode,
                    pageSizeOptions: settings.pageSizeOptions
                });
                $element.find('.bh-emapCard-card-pagination').off('pagersearch').on('pagersearch', function(e, pagenum, pagesize, total) {
                    pagesize = parseInt(pagesize);
                    render(instance, pagenum + '', pagesize, instance.gVars.gParams);
                    settings.pageSizeOptionsChange && settings.pageSizeOptionsChange(pagesize, pagenum);
                });
            }
        }

        settings.cardAfterRender && settings.cardAfterRender();
        _resetPageFooter($element);
        settings.isOnceEmpty = false;
    }

    function _resetPageFooter(instance) {
        //当弹框内容的高度出现变化的时候调用以下两个方法
        if (instance.closest(".bh-paper-pile-dialog").length > 0) {
            $.bhPaperPileDialog.resetPageFooter(); //改变页面的页脚位置
            $.bhPaperPileDialog.resetDialogFooter(); //改变弹框的页脚位置
        }
    }

    function getMockDataUrl(modelPath, action, settings) {
        var model = null;
        var currentModel = null;

        $.ajax({
            url: modelPath,
            async: false
        }).done(function(res) {
            model = res;
        });

        for (var i = 0; i < model.models.length; i++) {
            if (model.models[i]['name'] == action) {
                currentModel = model.models[i];
                break;
            }
        }
        if (!currentModel || !currentModel.url) {
            console && console.warn('getMockDataUrl 数据为空');
        }

        return currentModel ? currentModel.url : '';
    }

    function compile(template, data) {

        var compileTemplate = null;

        if (typeof(template) === 'object') {
            compileTemplate = template;
        } else {
            compileTemplate = Hogan.compile(template);
        }

        return compileTemplate.render(data);
    }



    $.fn.emapCard = function(options, params, callback) {
        var instance;
        instance = this.data('emapCard');
        if (!instance) {
            return this.each(function() {
                //将实例化后的插件缓存在dom结构里（内存里）
                return $(this).data('emapCard', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') {
            return instance[options](params, callback);
        }
        return this;
    };

    /**
     * @memberof module:emapCard
     * @prop {String} template - card模版
     * @prop {String} [pagePath] - 请求数据页面地址
     * @prop {Object} params - 请求参数
     * @prop {String} action - emap动作名
     * @prop {Boolean} [pageable=true] - 是否分页
     * @prop {String} [pagerMode=advanced] - 分页形式 'advanced' 'simple'
     * @prop {Array} [pageSizeOptions=['10', '20', '50', '100']] - 分页条数选项
     * @prop {Function} [cardBeforeRender] - 卡片渲染结束前的回调函数
     * @prop {Function} [cardAfterRender] - 卡片渲染结束后的回调函数
     * @prop {Obiect} [searchElement] - 联动数据总条数的高级搜索dom
     * @prop {Boolean} [isOnceEmpty=false] - 初次渲染是否展示空页面
     */
    $.fn.emapCard.defaults = {
        template: 'no template!', //渲染卡片的模板
        pagePath: null, //页面模型
        action: null, //页面动作
        pageMode: 'advanced', //advanced simple
        pageable: true,
        pageSizeOptions: [12, 24, 48, 96],
        pageSize: 12,
        params: {},
        isOnceEmpty: false,
        searchElement: undefined
    };
})(jQuery);
'use strict';
(function() {
    var Plugin, _eventBind, _renderItem;

    /**
     * @module emapDropdownTable
     * @alias 下拉表格/模糊搜索
     * @description 下拉表格/模糊匹配， 将返回的数据已列表的形式展示在下拉中，默认将返回的数据全部展示，可以通过配置hideMember项，隐藏指定的字段
     */
    Plugin = (function() {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapDropdownTable.defaults, options);
            this.$element = $(element);
            _init(this.$element, this.options);
        }

        /**
         * @method getValue
         * @description 取值
         * @return {String} - 当前控件的值
         */
        Plugin.prototype.getValue = function() {
            var selectedItem = this.$element.jqxComboBox('getSelectedItem')
            if (selectedItem) {
                var label = selectedItem.label;
                return JSON.parse(label)[this.options.valueMember];
            } else {
                return this.$element.val();
            }
        };

        /**
         * @method getText
         * @description 获取当前值的显示值
         * @return {String} - 当前控件选择值的显示值
         */
        Plugin.prototype.getText = function() {
            var selectedItem = this.$element.jqxComboBox('getSelectedItem')
            if (selectedItem) {
                var label = selectedItem.label;
                return JSON.parse(label)[this.options.displayMember || label.name];
            } else {
                return this.$element.val();
            }
        };

        /**
         * @method setValue
         * @description 赋值
         * @param {Array} val - 数组的第一项为id，第二项为name , 如 ['0001', '张三']
         */
        Plugin.prototype.setValue = function(val) {
            var element = this.$element;
            if (val[0] == '') {
                element.val('');
            }
            if (!element.jqxComboBox('getItemByValue', val[0])) {
                var display = {};
                display[this.options.displayMember || 'name'] = val[1];
                display[this.options.valueMember] = val[0];
                element.jqxComboBox('addItem', {
                    "id": val[0],
                    "name": val[1],
                    "label": JSON.stringify(display),
                    "value": val[0],
                    "_displayData": (function() {
                        return JSON.stringify(display);
                    })()
                });
            }
            element.jqxComboBox('selectItem', val[0]);
        };

        /**
         * @method destroy
         * @description 销毁
         */
        Plugin.prototype.destroy = function() {
            this.$element.jqxComboBox('destroy');
        };
        return Plugin;
    })();


    //生成dom
    function _init(element, options) {
        options.eleWidth = element.width();
        if (!options.actionName) {
            var urlArr = options.url.split('/');
            options.actionName = urlArr[urlArr.length - 1].split('.')[0];
        }
        var actionName = options.actionName;
        var displayMember = options.displayMember;
        var valueMember = options.valueMember;
        var source = {
            datatype: "json",
            root: "datas>" + actionName + ">rows",
            url: options.url,
            type: WIS_EMAP_CONFIG.getOptionType || "POST",
            async: true
        };

        //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
        if (typeof window.MOCK_CONFIG != 'undefined') {
            source = getSourceMock(source);
        }

        var dataAdapter = new $.jqx.dataAdapter(source, {
            beforeLoadComplete: function(data) {

                $(data).each(function() {
                    this._displayData = JSON.stringify(this);
                });
                return data;
            },
            beforeSend: function(xhr, setting) {
                // 搜索关键词为空时取消请求 多个请求的数据覆盖
                if (element.jqxComboBox('searchString') === '') {
                    xhr.abort()
                }
            },
            formatData: function(data) {
                var search_value = element.jqxComboBox('searchString');
                if (search_value != undefined) {
                    if (options.enableQuerySetting === true) {
                        var querySetting = [];
                        if (options.searchMember && options.searchMember.length > 0) {
                            options.searchMember.map(function(item) {
                                querySetting.push({
                                    'name': item,
                                    'value': search_value,
                                    'linkOpt': 'OR',
                                    'builder': 'include'
                                })
                            })
                        }
                        data.querySetting = JSON.stringify(querySetting);
                    } else {
                        data.queryopt = search_value;
                    }
                    data.pageSize = 10;
                    data.pageNumber = 1;
                    if (options.formatData) {
                        data = options.formatData(data);
                    }
                    return data;
                }
            },
            downloadComplete: function(edata, textStatus, jqXHR) {
                if (edata && edata.datas && edata.datas[actionName]) {
                    var resp = edata.datas[actionName].rows;
                    if (resp && resp.length) {
                        return;
                    }
                }
                var instance = element.data();
                if (instance && instance.jqxComboBox) {
                    element.jqxComboBox('open');
                }
            }
        });
        element.addClass('bh-edt').jqxComboBox({
                remoteAutoComplete: true,
                source: dataAdapter,
                remoteAutoCompleteDelay: 500,
                enableBrowserBoundsDetection: true,
                displayMember: "_displayData",
                minLength: options.minLength,
                valueMember: options.valueMember,
                renderer: function(index, label, value, data) {
                    var rowHtml = '';
                    var rowData = JSON.parse(label);
                    if (typeof options.beforeRender === 'function') {
                        rowData = options.beforeRender(index, rowData, data);
                    }
                    // 存在列数据不一样的情况，所以每次渲染都确定一次displayColumns
                    // if (!options.displayColumns) {
                    options.displayColumns = [];
                    for (var v in rowData) {
                        if (v == 'uid' || v == 'queryopt' || v == 'querySetting') continue;
                        if (options.showMember && options.showMember.length > 0) {
                            if ($.inArray(v, options.showMember) === -1) continue;
                        } else {
                            if ($.inArray(v, options.hideMember) > -1) continue;
                        }
                        options.displayColumns.push(v);
                    }
                    // }
                    var itemMaxWidth = (options.eleWidth - 34) / options.displayColumns.length - 16;
                    if (options.displayColumns.length === 0) {
                        console && console.error('没有可以显示的字段，请检查配置或者数据！')
                    }

                    options.displayColumns.map(function(v) {
                        if (v == 'uid' || v == 'queryopt' || v == 'querySetting') return;
                        rowHtml += '<div class="bh-mh-8" style="display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;max-width: ' + itemMaxWidth + 'px;" title="' +
                            filterHtmlTag(rowData[v]) + '">' +
                            ((rowData[v] === undefined || rowData[v] === null) ? '-' : rowData[v]) +
                            '</div>';
                    })

                    return rowHtml;
                },
                renderSelectedItem: function(index, item) {
                    var args = arguments;
                    if (options.renderSelectedItem) {
                        return options.renderSelectedItem.apply(this, args);
                    }
                    var label = JSON.parse(item.label);
                    return options.displayMember ? label[options.displayMember] : label.id;
                },
                search: function(searchString) {
                    dataAdapter.dataBind();
                }
            })
            .on('open', function() {
                if (!element.data('datainit')) {
                    dataAdapter.dataBind();
                    element.data('datainit', true);
                }
            });
        _eventBind(element, options);
    }

    function filterHtmlTag(str) {
        if (str !== undefined && str !== null) {
            return str.toString().replace(/<[^>]+>/g, '')
        }
        return '';
    }

    _eventBind = function(element, options) {
        element.on('select', function(e) {
            if (!e.args) return;
            options.curValue = e.args.item.value;
        });

        // 文本框失去焦点后, 清空 已有的输入项(必须通过选择)
        if (options.autoClear) {
            $('input.jqx-combobox-input', element).on('blur', function() {
                try {
                    if (element.val() != options.curValue) {
                        element.jqxComboBox('clearSelection');
                    }
                } catch (e) {
                    console && console.log(e);
                }
            });
        }
    };

    _renderItem = function(element, options, data) {
        $(data).each(function() {
            element.jqxComboBox('addItem', this);
        });
    };

    $.fn.emapDropdownTable = function(options, params) {
        var instance;
        instance = this.data('emapdropdowntable');
        if (!instance) {
            return this.each(function() {
                return $(this).data('emapdropdowntable', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](params);
        return this;
    };

    /**
     * @memberof module:emapDropdownTable
     * @prop {String} [valueMember=id] - 取值字段
     * @prop {String} [displayMember=id] - 显示字段
     * @prop {Array} [hideMember] - 隐藏的字段
     * @prop {Array} [showMember] - 显示的字段（优先级高于hideMember）
     * @prop {Boolean} [autoClear] - 控件失去焦点时， 是否自动清空输入内容，只保留通过下拉选择的内容
     * @prop {Int} [width=300] - 宽度
     * @prop {Int} [minLength=2] - 触发搜索的最小输入字符数
     * @prop {Function} [beforeRender] - 行渲染前的回调函数，参数为index, rowData, data, 需要返回处理后的rowData
     */
    $.fn.emapDropdownTable.defaults = {
        valueMember: 'id',
        hideMember: [],
        showMember: undefined,
        autoClear: true,
        width: 300,
        minLength: 2,
        beforeRender: undefined,
        enableQuerySetting: false

    };
}).call(undefined);

(function() {
    var Plugin,
        _create, _renderTree,
        _getRecords, _getFullPath, _del_ID_PID, _treeBind, _filterLocalData, _getFatherNode, _isSelectable;

    /**
     * @module emapDropdownTree
     * @alias 下拉树
     * @description 下拉树
     * @example
     * $container.emapDropdownTree({
     *      url: 'xxxxxxxxxx',
     *      checkboxes: false,
     *      search: true,
     *      treeParams: {}
     * });
     */
    Plugin = (function() {
        function Plugin(element, options) {
            if (WIS_EMAP_CONFIG.dropDownOneKeySelect) {
                this.settings = $.extend({}, $.fn.emapDropdownTree.defaults, {
                    oneKeySelect: WIS_EMAP_CONFIG.dropDownOneKeySelect
                }, options);
            } else {
                this.settings = $.extend({}, $.fn.emapDropdownTree.defaults, options);
            }
            if (this.settings.oneKeySelect) {
                this.settings.treeParams.hasThreeStates = true;
            }
            this.$element = $(element);
            _create(this.$element, this.settings);
        }
        /**
         * @method getValue
         * @description 取值
         * @return {String} 当前下拉树选中的值，多值以逗号分隔
         */
        Plugin.prototype.getValue = function() {
            return $(this.$element.data('values')).map(function() {
                return this.value;
            }).get().join(',');
        };
        /**
         * @method getText
         * @description 获取选中文字
         * @return 当前下拉树选中的值的文字，多值以逗号分隔
         */
        Plugin.prototype.getText = function() {
            return $(this.$element.data('values')).map(function() {
                return this.label;
            }).get().join(',');
        };

        /**
         * @method setValue
         * @description 赋值
         * @param {Array} params - 0 val 1 val_display
         */
        Plugin.prototype.setValue = function(params) {
            var val = params[0];
            var display_val = params[1];
            var settings = this.settings;
            var $dom = this.$element;
            if (val === '') {
                this.$element.emapDropdownTree('clearSelect');
                return this.$element.jqxDropDownButton('setContent', settings.placeholderContent);
            }
            if (display_val === undefined) {
                console && console.error('下拉树缺少display字段');
            } else {
                this.$element.jqxDropDownButton('setContent', display_val);
                // this.settings.$tree.jqxTree('checkItem', $('#' + val, this.settings.$tree), true);
                var val_array = val.split(',');
                var display_array = display_val.split(',');
                var value_data = [];
                val_array.map(function(item, i) {
                    value_data.push({
                        value: item,
                        label: display_array[i]
                    })
                });
                this.$element.data('values', value_data);
                this.$element.trigger('change');
            }
            // else {
            //     if (display_val === undefined) {
            //         console && console.log('下拉树缺少display字段');
            //     } else {
            //         this.$element.jqxDropDownButton('setContent', display_val);
            //         // this.settings.$tree.jqxTree('checkItem', $('#' + val, this.settings.$tree), true);
            //         this.$element.data('values', [{
            //             value: val,
            //             label: display_val
            //         }]);
            //         this.$element.trigger('change');
            //     }
            // }
        };

        /**
         * @method disable
         * @description 禁用
         */
        Plugin.prototype.disable = function() {
            this.$element.jqxDropDownButton({
                disabled: true
            });
        };
        /**
         * @method enable
         * @description 启用
         */
        Plugin.prototype.enable = function() {
            this.$element.jqxDropDownButton({
                disabled: false
            });
        };

        /**
         * @method clearSelect
         * @description 清空选中
         */
        Plugin.prototype.clearSelect = function() {
            if (this.settings.checkboxes === true) {
                // 多选清空
                this.settings.$tree.jqxTree('uncheckAll');
            } else {
                // 单选清空
            }
            this.$element.jqxDropDownButton('setContent', '');
            this.$element.data('values', []);
        };

        /**
         * @method getSource
         * @description 获取当前下拉树的数据
         * @return {Array} - 下拉树的数据
         */
        Plugin.prototype.getSource = function() {
            var items = this.settings.$tree.jqxTree('getItems');
            var records = [];
            if (!items) return [];
            items.map(function(n) {
                if (n.label !== $.i18n('bh-eddt-loading')) {
                    records.push(n)
                }
            })
            return records;
        };

        Plugin.prototype.renderTree = function(source) {
            this.settings.$tree.jqxTree("clear");
            _renderTree(this.$element, $.extend({}, this.settings, {
                url: '',
                datas: source
            }))
        }

        // Plugin.prototype.setSource = function (source) {
        //     this.settings.$tree.jqxTree({
        //         source: _getRecords(source)
        //     })
        // };

        return Plugin;

    })();

    _create = function($dom, setting) {
        setting.treeParams.hasThreeStates = setting.treeParams.hasThreeStates === undefined ? WIS_EMAP_CONFIG.dropdownTreeHasThreeStates : setting.treeParams.hasThreeStates;
        var Num = "";
        // http://jira.product.wisedu.com/browse/XG-3752
        setting.placeholderContent = '<span>' + setting.placeholder + '<span>';
        for (var i = 0; i < 6; i++)
            Num += Math.floor(Math.random() * 10);

        setting.$tree = $('<div style="border: none;height:220px" class="dropdown-tree"></div>');
        setting.$tree.attr("id", "tree_" + Num);
        $dom.attr("id", "content_" + Num);
        $dom.append(setting.$tree);

        // 若有datas参数，将datas缓存， 后面前端搜索会使用
        if (!setting.url && setting.datas) {
            setting.$tree.data('localdata', setting.datas);
        }

        if (setting.checkboxes) {
            setting.$tree.on('checkChange', function(event) {

                var $tree = $(this);
                var Num = $tree.attr("id").substr("tree_".length);
                var $dom = $("#content_" + Num);
                var args = event.args;
                var item = $tree.jqxTree('getCheckedItems', args.element);
                var values = [];

                if (setting.selectableFlag) {
                    return setting.selectableFlag = false;
                }
                if (!_isSelectable(args, setting, event)) {
                    return false;
                }

                //多选下拉树选中时获取全路径
                var dropDownContent = item.map(function(cv) {
                    if (cv.label != $.i18n('bh-eddt-loading')) {
                        values.push({
                            "label": cv.label,
                            "value": cv.value
                        });
                        return _getFullPath(cv, setting.$tree).reverse().join("/");
                    }

                }).join(",");
                dropDownContent = dropDownContent.replace(/,+/g, ',').replace(/,$/, '') || setting.placeholderContent;

                $dom.jqxDropDownButton('setContent', dropDownContent);
                $dom.data({
                    "values": values
                });
                $dom.trigger('change');
            });
        } else {
            setting.$tree.on('select', function(event) {
                var args = event.args;

                if (!_isSelectable(args, setting, event)) return;

                var $tree = $(this);
                var Num = $tree.attr("id").substr("tree_".length);
                var $dom = $("#content_" + Num);
                var item = $tree.jqxTree('getItem', args.element);
                var values = [];
                // var dropDownContent = item.label;
                var dropDownContent = _getFullPath(item, setting.$tree).reverse().join("/");
                var dropDownValue = item.value;
                values.push({
                    "label": dropDownContent,
                    "value": dropDownValue
                });
                //qiyu 2016-6-6 外部可以干涉节点选中事件，需求人：吴涛
                var flag = $dom.triggerHandler("select", [values, $tree, args]);
                if (flag === undefined || flag == true) {
                    $dom.jqxDropDownButton('setContent', dropDownContent);
                    $dom.data({
                        "values": values
                    });
                    $dom.jqxDropDownButton('close');
                }
                $dom.trigger('change');
            });
        }

        // 在搜索的场景中，选择空值选项的联动
        if (setting.showBlankOption === true && setting.checkboxes) {
            var flag = false;
            setting.$tree.on('checkChange', function(e) {
                var args = e.args;
                if (!args || flag) return;
                flag = true;
                // 勾选空值时，将其他选项取消勾选
                var event_item = setting.$tree.jqxTree('getItem', args.element);
                if (event_item.value === '@__blank__value' && args.checked === true) {
                    setting.$tree.jqxTree('uncheckAll');
                    setting.$tree.jqxTree('checkItem', event_item);
                } else if (event_item.value !== '@__blank__value') { // 勾选其他值时，将空值项取消勾选
                    var checked_items = setting.$tree.jqxTree('getCheckedItems');
                    if (checked_items && checked_items.length > 0) {
                        var blank_item = checked_items.filter(function(item) {
                            return item.value === '@__blank__value';
                        });
                        if (blank_item.length > 0) { //空值选项在勾选时
                            setting.$tree.jqxTree('uncheckItem', blank_item[0]);
                        }
                    }
                }
                flag = false;
            });
        }

        $dom.jqxDropDownButton({
            enableBrowserBoundsDetection: true,
            width: setting.width ? setting.width : "100%",
            dropDownHeight: '243px'
        });

        $dom.on('close', function() {
            $(this).trigger('change');
        }).on('open', function() {
            if ($dom.data('loaded') === true) {
                setting.treeInit = true
            }
            if (!setting.treeInit) {
                _treeBind($dom, setting);
                setting.treeInit = true;
                setTimeout(function() { // 解决有时下拉树初始化 高度为0  不显示的问题 zhuhui 0726
                    setting.$tree.jqxTree({
                        height: '220px'
                    });
                }, 0);
            }
            //TODO 打开下拉树时 重新勾选
        });

        // 下拉树设置 placeholder zhuhi  0519
        $dom.jqxDropDownButton('setContent', setting.placeholderContent);

    };

    _renderTree = function($dom, setting) {
        if (setting.url) {
            var data = $.extend({
                'pId': ''
            }, setting.params);
            if (setting.params && setting.params.searchValue) {
                data = setting.params;
            }
            var source = {
                datatype: "json",
                root: "datas>code>rows",
                datafields: [{
                    name: 'id'
                }, {
                    name: 'pId'
                }, {
                    name: 'name'
                }, {
                    name: 'isParent'
                }],
                id: 'id',
                url: setting.url,
                data: data,
                //qiyu 2016-5-9 强制使用post方法，解决搜索中文没有结果。反馈人：吴涛
                type: "POST"
            };

            //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
            if (typeof window.MOCK_CONFIG != 'undefined') {
                source = getSourceMock(source);
            }

            var dataAdapter = new $.jqx.dataAdapter(source, {
                beforeLoadComplete: function(loaded_data, original_data) {
                    var new_data = [];
                    if (setting.checkboxes == false) {
                        new_data.push({
                            name: $.i18n('bh-eddt-pleaseChoose'),
                            pId: "...",
                            value: ""
                        });
                    }
                    for (var i = 0; i < loaded_data.length; i++) {
                        var item = loaded_data[i];
                        new_data.push({
                            id: item.id,
                            name: item.name,
                            pId: item.pId ? item.pId : "...",
                            value: item.id
                        });
                        if (item.isParent === 1 && !(setting.params && setting.params.checkParent)) {
                            var sub_item = {
                                id: item.id + '_load',
                                name: $.i18n('bh-eddt-loading'),
                                pId: item.id,
                                value: item.id
                            };
                            new_data.push(sub_item);
                        }
                    }
                    return new_data;
                },
                loadComplete: function() {
                    // dataAdapter.records
                    var records = dataAdapter.getRecordsHierarchy('id', 'pId', 'items', [{
                        name: 'name',
                        map: 'label'
                    }]);
                    if (typeof setting.downloadComplete === 'function') {
                        var result = setting.downloadComplete(records, data);
                        if (result) {
                            records = result;
                        }
                    }
                    // 防止多次添加空值选项
                    if (setting.showBlankOption === true) {
                        if (setting.checkboxes) {
                            records.splice(0, 0, {
                                value: '@__blank__value',
                                id: '@__blank__value',
                                name: $.i18n('bh-eddt-empty'),
                                label: $.i18n('bh-eddt-empty'),
                                pId: '...'
                            })
                        } else {
                            records.splice(1, 0, {
                                value: '@__blank__value',
                                id: '@__blank__value',
                                name: $.i18n('bh-eddt-empty'),
                                label: $.i18n('bh-eddt-empty'),
                                pId: '...'
                            })
                        }

                    }
                    _del_ID_PID(records);
                    var height = 220;
                    if (setting.checkboxes && setting.oneKeySelect) {
                        height = height - 20;
                    }
                    var treeParams = $.extend({
                        width: setting.width ? setting.width : "100%",
                        height: height,
                        hasThreeStates: false,
                        allowDrag: false,
                        source: records,
                        checkSize: 16
                    }, setting.treeParams);
                    treeParams.checkboxes = setting.checkboxes;

                    if (!setting.params || !setting.params.checkParent) {
                        setting.$tree.on('expand', function(event) {
                            var $tree = $(this);
                            var $element = $(event.args.element);
                            var isCheck = false;
                            var jqxCheckbox = $element.children('.jqx-checkbox');
                            if (jqxCheckbox && jqxCheckbox.val() == true) {
                                isCheck = true;
                            }
                            getChildNode($element, $tree, setting, isCheck);
                        });
                    } else {
                        // 搜索结果的回调中, unblind
                        unblindItem(treeParams.source, setting.unblind);
                    }
                    setting.$tree.prev('.loading').remove();

                    setting.$tree.jqxTree(treeParams);
                    // 解决有时下拉树初始化 高度为0  不显示的问题 zhuhui 0726
                    setTimeout(function() {
                        var height = 220;
                        if (setting.checkboxes && setting.oneKeySelect) {
                            height = height - 20;
                        }
                        setting.$tree.jqxTree({
                            height: height + 'px'
                        });
                    }, 0);

                    if (setting.params && setting.params.checkParent) {
                        setting.$tree.off('expand');
                        setting.$tree.jqxTree('expandAll');
                    }

                    var val = $dom.data('values');
                    if (val && val.length > 0) {
                        var treeItems = setting.$tree.jqxTree('getItems');
                        if (setting.checkboxes) { // 多选
                            val.map(function(item) {
                                treeItems.map(function(m) {
                                    if (m.value == item.value) {
                                        setting.$tree.jqxTree('checkItem', m.element);
                                    }
                                });
                            })
                        } else { // 单选

                        }
                    }

                    function unblindItem(source, unblind) {
                        if (source.length) {
                            source.map(function(sourceItem) {
                                sourceItem.label = sourceItem.name.substring(sourceItem.name.lastIndexOf(unblind) + 1, sourceItem.name.length);
                                if (sourceItem.items && sourceItem.items.length) {
                                    unblindItem(sourceItem.items, unblind);
                                }
                            })
                        }
                    }
                }
            });
            dataAdapter.dataBind();
        } else {
            var records = _getRecords(setting.datas);
            var height = 220;
            if (setting.checkboxes && setting.oneKeySelect) {
                height = height - 20;
            }

            if (typeof setting.downloadComplete === 'function') {
                var result = setting.downloadComplete(records);
                if (result) {
                    records = result;
                }
            }

            var treeParams = $.extend({
                width: setting.width ? setting.width : "100%",
                height: height,
                hasThreeStates: false,
                allowDrag: false,
                source: records,
                checkSize: 16
            }, setting.treeParams);
            treeParams.checkboxes = setting.checkboxes;
            setting.$tree.jqxTree(treeParams);
        }
    };

    function getChildNode($element, $tree, setting, isCheck) {
        var loader = false;
        var loaderItem = null;
        var children = $element.find('ul:first').children();
        $.each(children, function() {
            var item = $tree.jqxTree('getItem', this);
            if (item && item.label == $.i18n('bh-eddt-loading')) {
                loaderItem = item;
                loader = true;
                return false
            }
        });
        if (loader) {
            // unblind 取消节点label显示的层级关系
            var unblind = setting.unblind;
            var ajaxData = $.extend({}, setting.params, {
                pId: loaderItem.value.replace(".fake", "")
            })
            return $.ajax({
                url: setting.url,
                // 在请求子节点的时候， 统一为post请求， 为公有云添加  zhuhui 2017-04-10
                type: 'POST',
                data: ajaxData,
                success: function(data, status, xhr) {
                    var items = data;
                    if (typeof setting.bindComplete === 'function') {
                        setting.bindComplete(items)
                    }
                    if (items.datas && ((items.datas.code && items.datas.code.rows) || (items.datas.rows))) {
                        var nodes
                        if (items.datas.code && items.datas.code.rows) {
                            nodes = items.datas.code.rows;
                        } else if (items.datas.rows) { // 添加对公有云数据格式的支持 zhuhui 2017-05-10
                            nodes = items.datas.rows
                        }
                        var treenodes = [];
                        for (var i = 0; i < nodes.length; i++) {
                            var itemLabel = nodes[i].name;
                            if (unblind)
                                itemLabel = itemLabel.substring(itemLabel.lastIndexOf(setting.unblind) + 1, itemLabel.length);
                            var treenode = {
                                label: itemLabel,
                                value: nodes[i].id
                            };

                            if (nodes[i].isParent === 1) {
                                treenode.items = [{
                                    "value": nodes[i].id,
                                    label: $.i18n('bh-eddt-loading')
                                }];
                            }
                            treenodes.push(treenode);
                        }

                        if (typeof setting.downloadComplete === 'function') {
                            var result = setting.downloadComplete(treenodes, ajaxData);
                            if (result) {
                                treenodes = result;
                            }
                        }

                        $tree.jqxTree('addTo', treenodes, $element[0]);
                        $tree.jqxTree('removeItem', loaderItem.element);
                        $tree.jqxTree('refresh');
                        // 若父节点选中，则将新添加的子节点勾选
                        if (isCheck == true && setting.treeParams.hasThreeStates) {
                            var ul = $element.children('ul:first');
                            if (ul.children('li').length) {
                                ul.children('li').each(function() {
                                    $tree.jqxTree('checkItem', this, true);
                                })
                            }
                        }
                    }
                }
            });
        }
    }

    _treeBind = function($dom, setting) {
        // setting.$tree.jqxTree({ width: "100%" });//.jqxTree('addTo', { label: '请选择', value: "" });
        setting.$tree.niceScroll();
        if (setting.checkboxes && setting.oneKeySelect) {
            var $select = $('<div class="bh-form-group" style="padding-left:2px">' +
                '<div class="bh-checkbox" style="padding-top:0">' +
                '<label style="margin-bottom:0">' +
                '<input type="checkbox" value="">' +
                '<i class="bh-choice-helper"></i>' + $.i18n('bh-eddt-selectAll') +
                '</label>' +
                '</div>' +
                '</div>');
            setting.$tree.before($select);
            $select.on('change', function(e) {
                if ($(e.target).prop('checked')) {
                    setting.$tree.jqxTree('checkAll');
                } else {
                    setting.$tree.jqxTree('uncheckAll');
                }
            });
            setting.$tree.on('checkChange', WIS_EMAP_SERV.debounce(function(e) {
                if (!e.args.checked) {
                    $select.find('input').prop('checked', false);
                } else {
                    if ($(e.target).jqxTree('getItems').length === $(e.target).jqxTree('getCheckedItems').length) {
                        $select.find('input').prop('checked', true);
                    }
                }
            }, 100));
        }
        if (setting.search) {
            var $searchInput = $('<input style="height: 21px; top: 3px; left: 3px;  width: calc(100% - 4px); margin: 2px 0 2px 2px; border-radius: 2px;" class="treeSearchInput jqx-widget jqx-listbox-filter-input jqx-input jqx-rc-all" type="text" placeHolder="' + $.i18n('bh-eddt-search') + '"/>');
            setting.$tree.parent().prepend($searchInput);
            WIS_EMAP_INPUT.placeHolder($searchInput);
            $searchInput.keyup(function() {
                window.clearTimeout($searchInput.data('timerId'));
                $searchInput.data('timerId', window.setTimeout(
                    function() {
                        var value = $searchInput.val();
                        if (value) {
                            if (setting.url) { // 有url参数时， 为远程搜索
                                var source = {
                                    '*tree': "1",
                                    searchValue: value,
                                    checkParent: true
                                };
                                setting.$tree.jqxTree("clear");
                                setting.params = $.extend({}, setting.params, source);
                                _renderTree($dom, setting);
                            } else { // 没有url时， 为本地搜索
                                if (!setting.datas) {
                                    console && console.error('tree need datas options');
                                }
                                setting.$tree.jqxTree("clear");
                                setting.datas = _filterLocalData(setting.$tree.data('localdata'), value, setting);
                                _renderTree($dom, setting);
                            }
                        } else {
                            setting.$tree.jqxTree("clear");
                            if (setting.url) {
                                setting.params = $searchInput.data('originalParam');
                            } else {
                                setting.datas = setting.$tree.data('localdata');
                            }
                            _renderTree($dom, setting);
                        }
                    }, 500));
            });
        }
        setting.$tree.before('<div style="display: inline-block;margin-left:20px" class="loading">' + $.i18n('bh-eddt-loading') + '</div>');
        _renderTree($dom, setting);
    };

    _getRecords = function(datas) {
        var source = {
            datatype: "json",
            // root:"datas>code>rows",
            datafields: [{
                name: 'id'
            }, {
                name: 'pId'
            }, {
                name: 'name'
            }],
            id: 'id',
            localdata: datas
        };
        var dataAdapter = new $.jqx.dataAdapter(source);
        dataAdapter.dataBind();
        var records = dataAdapter.getRecordsHierarchy('id', 'pId', 'items', [{
            name: 'name',
            map: 'label'
        }, {
            name: 'id',
            map: 'value'
        }]);
        return records;
    };

    _getFullPath = function(treeNode, domTree) {
        var path = [];
        path.push(treeNode.label);
        if (domTree.jqxTree('getItem', treeNode.parentElement) != null) {
            path = path.concat(_getFullPath(domTree.jqxTree('getItem', treeNode.parentElement), domTree));
        }
        return path;
    };

    _del_ID_PID = function(arr_data) {
        for (var i = 0; i < arr_data.length; i++) {
            delete arr_data[i].id;
            delete arr_data[i].pId;
            if (arr_data[i].items)
                _del_ID_PID(arr_data[i].items);
        }
    }

    // 前端搜索
    _filterLocalData = function(data, val, setting) {
        var result_data = [];
        if (data.length) {
            data.map(function(item) {
                if (item.name.indexOf(val) > -1) {
                    result_data.push(item);
                }
            });
            // 向上遍历父节点加入搜索结果
            var len = result_data.length;
            for (var i = 0; i < len; i++) {
                result_data = result_data.concat(_getFatherNode(data, result_data[i]));
            }
        }

        if (typeof setting.downloadComplete === 'function') {
            var result = setting.downloadComplete(result_data, val);
            if (result) {
                result_data = result;
            }
        }

        return result_data;
    }

    _getFatherNode = function(data, childNode) {
        if (childNode.pId !== undefined && childNode.pId !== null && childNode.pId !== '') {
            var node_list = [];
            var father_node = data.filter(function(item) {
                return item.id === childNode.pId
            })[0];
            if (father_node) {
                node_list.push(father_node);
                if (father_node.pId !== undefined && father_node.pId !== null && father_node.pId !== '') {
                    node_list = node_list.concat(_getFatherNode(data, father_node));
                }
            }
            return node_list;
        } else { // 没有pid的情况，则认为已经是顶级节点
            return [];
        }
    }

    _isSelectable = function(args, setting, event) {
        var item = setting.$tree.jqxTree('getItem', args.element);
        if (typeof setting.unselectableLevel == 'number') {
            setting.unselectableLevel = setting.unselectableLevel.toString();
        }
        var unselectableLevelArray = setting.unselectableLevel ? setting.unselectableLevel.split(',') : [];
        if (setting.checkboxes) {
            if (!setting.parentNodeSelectable && item.hasItems) {
                // 标记位指示checkChange事件是否由下方的checkItem方法触发，
                // 如果是，则在事件监听里不作处理， 避免由此引起的死循环内存溢出  -- zhuhui 2016-11-15
                setting.selectableFlag = true;
                setting.$tree.jqxTree('checkItem', args.element, false);
                return false;
            }
            if (unselectableLevelArray.length && $.inArray((item.level + 1) + '', unselectableLevelArray) > -1) {
                setting.selectableFlag = true;
                setting.$tree.jqxTree('checkItem', args.element, false);
                return false;
            }
        } else {
            if (!setting.parentNodeSelectable) {
                if (item.hasItems) return false;
            }
            if (unselectableLevelArray.length && $.inArray((item.level + 1) + '', unselectableLevelArray) > -1) {
                return false;
            }
        }

        return true;
    }

    $.fn.emapDropdownTree = function(options, params) {
        var instance;
        instance = this.data('emapDropdownTree');
        if (!instance) {
            return this.each(function() {
                return $(this).data('emapDropdownTree', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](params);
        return this;
    };

    /**
     * @memberof module:emapDropdownTree
     * @prop {Array} datas - 下拉树数据，emap格式，与url二选一必须
     * @prop {String} url - 下拉树数据请求地址， 与datas二选一必须
     * @prop {Boolean} [checkboxes=false] - 是否多选
     * @prop {Boolean} [search=true] - 是否允许搜索
     * @prop {String} [unblind] - 节点层次关系分隔符
     * @prop {String} [placeholder=请选择] - 占位符提示文字
     * @prop {Boolean} [parentNodeSelectable=true] - 父级节点是否允许选中
     * @prop {String} [unselectableLevel] - 指定层级无法选中如 '1,2', 多层级用 , 分隔
     * @prop {Function} [downloadComplete] - 数据请求完毕后的回调函数
     * @prop {Object} [treeParams] - 树组件参数，如配置下拉属于父子节点联动：
     * $('.tree_multi_linkage').emapDropdownTree({
                url: url,
                checkboxes: true,
                treeParams: {
                    hasThreeStates: true
                }
            })

     * @prop {Boolean} [showBlankOption=false] - 是否显示空值选项
     */
    $.fn.emapDropdownTree.defaults = {
        placeholder: $.i18n('bh-eddt-pleaseChoose'),
        width: "100%",
        checkboxes: false,
        showBlankOption: false,
        search: true,
        parentNodeSelectable: true,
        unselectableLevel: "",
        treeParams: {},
        downloadComplete: null
    };
}).call(this);

;
(function($) {
    /**
     * @module emapEditableDataTable
     * @alias 编辑表格
     * @description 表格编辑，修改，新增，删除，校验
     * @example
     * $('#emapEditableDataTable').emapEditableDataTable({
     *     newDataEmptyNum:1,
     *     emapdatatable:{
     *         pagePath:'',
     *         action:'action',
     *         customColumns:[{
     *             colIndex:0,
     *             type:'checkbox'
     *         },{
     *             colIndex:'last',
     *             type:'tpl',
     *             column:{
     *                 text:'操作',
     *                 cellsRenderer:function(){
     *                     return '';
     *                 }
     *             }
     *         },{
     *             colIndex: 40,//如果已经有自定义列colIndex为last，请在此设置为数字，否则会出现问题，40表示展示在最后一列
     *             type:'edit_tpl', /表示编辑时的操作列
     *             column:{
     *                 text:'操作',
     *                 //colModel为当前列的模型，settings为组件配置参数，其中的editMode表示是否进入编辑模式，rowData的isToDelete表示行是否待删除
     *                 cellsRenderer:function(row, column, value, rowData, colModel, settings){
     *                     return '';
     *                 }
     *             }
     *         }]
     *     }
     * });
     */
    var toDeleteKey = 'isToDelete';
    var Plugin = function(element, options) {
        this.options = $.extend(true, {}, $.fn.emapEditableDataTable.defaults, options);
        this.isEditMode = !!this.options.emapdatatable.isEditMode; //是否处于编辑模式
        this.options.emapdatatable.canEdit = true;
        this.isNewDataHolderTableInited = false;
        this.$element = $(element);
        var tip = '<p class="bh-color-warning bh-mv-4 emap-data-tip" role="emapDataTip" style="display:none">' + $.i18n('bh-edt-originDatas') + '：</p>';
        var emapDataTable = '<div table-role="emapDataTable"></div>';
        var newDataHolderTable = '<p role="newDataTip" class="bh-color-warning bh-mv-4 new-data-tip" style="display:none">' + $.i18n('bh-edt-newRow') + '（1）：</p><div table-role="newDataHolderTable"></div>';
        this.$element.html(newDataHolderTable + tip + emapDataTable);
        this.$emapDataTable = this.$element.find('[table-role="emapDataTable"]');
        this.$newDataHolderTable = this.$element.find('[table-role="newDataHolderTable"]');

        //是否显示自定义列按钮
        var customColumnAttr = 'data-no-custom-field';
        var value = this.$element.attr('data-no-custom-field');
        if (value) {
            this.$emapDataTable.attr(customColumnAttr, value);
            this.$newDataHolderTable.attr(customColumnAttr, value);
        } else {
            this.$emapDataTable.attr(customColumnAttr, '0');
            this.$newDataHolderTable.attr(customColumnAttr, '0');
        }

        _initComponent(this);
    };

    /**
     * @method enterEditMode
     * @description 进入编辑模式，先判断是否已经进入编辑模式
     */
    Plugin.prototype.enterEditMode = function() {
        if (!this.isEditMode) {
            this.isEditMode = true;
            this.$emapDataTable.emapdatatable('enterEditMode');
        }
    };

    /**
     * @method leaveEditMode
     * @description 退出编辑模式
     */
    Plugin.prototype.leaveEditMode = function() {
        if (this.isEditMode) {
            _hideTip(this);
            this.$emapDataTable.emapdatatable('leaveEditMode');
            if (this.isNewDataHolderTableInited) {
                this.$newDataHolderTable.jqxDataTable('clear');
                this.$newDataHolderTable.data('changedRowsData', []);
                this.$newDataHolderTable.hide();
            }
        }
    };

    /**
     * @method addRow
     * @description 新增数据
     * @param {Object} opt 入参
     * @param {Number} opt.newDataEmptyNum 增加几条新数据
     */
    Plugin.prototype.addRow = function(opt) {
        if (this.isEditMode) {
            if (this.isNewDataHolderTableInited) {
                _showTip(this);
                this.$newDataHolderTable.show();
                _addNewData(this, opt || {});
            } else {
                _renderNewDataHolderTable(this, opt || {});
            }
            //关闭jqx下拉框
            $('body').trigger('mousedown');
        }
    };

    /**
     * @method getChangedRows
     * @description emapDataTable changerRows 不包括将要被删除的行
     * @return {Array}
     */
    Plugin.prototype.getChangedRows = function() {
        var emapData = this.$emapDataTable.emapdatatable('getChangedRows');
        return emapData;
    };

    /**
     * @method getToDeleteRows
     * @description emapDataTable 将要被删除的行
     * @return {Array}
     */
    Plugin.prototype.getToDeleteRows = function() {
        var emapData = this.$emapDataTable.emapdatatable('getToDeleteRows');
        return emapData;
    };

    /**
     * @method getNewChangedRows
     * @description 不包括将要被删除的行
     * @return {Array}
     */
    Plugin.prototype.getNewChangedRows = function() {
        if (this.$newDataHolderTable.emapdatatable(true)) {
            return this.$newDataHolderTable.emapdatatable('getChangedRows');
        }
        return [];
    };

    /**
     * @method deleteNewRow
     * @description 删除新添加的行
     * @param  {Object} opt 入参
     * @param {Number} opt.rowIndex
     */
    Plugin.prototype.deleteNewRow = function(opt) {
        if (this.isNewDataHolderTableInited) {
            this.$newDataHolderTable.emapdatatable('deleteRowInEditMode', opt);
            _refreshTip(this);
        }
    };

    /**
     * @method cancelDeleteNewRow
     * @description 取消删除新添加的行
     * @param  {Object} opt 入参
     * @param {Number} opt.rowIndex 行索引
     */
    Plugin.prototype.cancelDeleteNewRow = function(opt) {
        if (this.isNewDataHolderTableInited) {
            this.$newDataHolderTable.emapdatatable('cancelDeleteRowInEditMode', opt);
            _refreshTip(this);
        }
    };

    /**
     * @method deleteEmapRow
     * @description 删除表格原始数据
     * @param  {Object} opt 入参
     * @param {Number} opt.rowIndex 行索引
     */
    Plugin.prototype.deleteEmapRow = function(opt) {
        this.$emapDataTable.emapdatatable('deleteRowInEditMode', opt);
    };

    /**
     * @method cancelDeleteEmapRow
     * @description 取消删除表格原始数据
     * @param  {Object} opt 入参
     * @param {Number} opt.rowIndex 行索引
     */
    Plugin.prototype.cancelDeleteEmapRow = function(opt) {
        this.$emapDataTable.emapdatatable('cancelDeleteRowInEditMode', opt);
    };

    /**
     * @method getEmapDataTable
     * @description 获取emapDataTable元素，可以调用emapdatatable的API
     * @example
     * $el.emapEditableDataTable('getEmapDataTable').emapdatatable('reload')
     * @return {DOM}
     */
    Plugin.prototype.getEmapDataTable = function() {
        return this.$emapDataTable;
    };

    /**
     * @method getNewDataHolderTable
     * @description 获取getNewDataHolderTable元素，可以调用emapdatatable的API
     * @return {DOM}
     */
    Plugin.prototype.getNewDataHolderTable = function() {
        return this.$newDataHolderTable;
    };

    /**
     * @method validateTable
     * @description 校验表格输入是否合法
     * @return {Boolean}
     */
    Plugin.prototype.validateTable = function() {
        if (this.isNewDataHolderTableInited) {
            var emap = this.$emapDataTable.emapdatatable('validateTable');
            var newData = this.$newDataHolderTable.emapdatatable('validateTable');
            return emap && newData;
        } else {
            return this.$emapDataTable.emapdatatable('validateTable');
        }
    };

    /**
     * @method isInEditMode
     * @description 判断表格是否处于编辑模式
     * @return {Boolean}
     */
    Plugin.prototype.isInEditMode = function() {
        return this.isEditMode;
    };

    /**
     * @method checkedRowsIndex
     * @description 获取勾选的行索引，emap表示原始表单，new表示新增表格
     * @return {Object}
     */
    Plugin.prototype.checkedRowsIndex = function() {
        var emapRow = this.$emapDataTable.emapdatatable('checkedRowsIndex');
        if (this.isNewDataHolderTableInited) {
            var newRow = this.$newDataHolderTable.emapdatatable('checkedRowsIndex');
            return {
                emap: emapRow,
                news: newRow
            };
        }
        return {
            emap: emapRow
        };
    };

    function _initComponent(instance) {
        _bindCheckTableDataIsEmpty(instance);
        instance.$emapDataTable.emapdatatable(instance.options.emapdatatable);
    }

    function _bindCheckTableDataIsEmpty(instance) {
        var newDataEmptyNum = instance.options.newDataEmptyNum;
        instance.$emapDataTable.on('emapdatatable.created', function(e, table) {
            setTimeout(function() {
                var edit = table.$element.parent().emapEditableDataTable(true);
                if (table.getTotalRecords() == 0 || table.getTotalRecords() == undefined) {
                    edit.$element.trigger('emapdata.empty');
                    if (edit.options.isAutoAdd) {
                        edit.enterEditMode();
                        table.$element.hide();
                        _renderNewDataHolderTable(edit, {
                            newDataEmptyNum: newDataEmptyNum
                        }, true);
                    }
                } else {
                    edit.$element.trigger('emapdata.unempty');
                }
            });
        });
    }

    function _showTip(instance) {
        instance.$element.find('[role="newDataTip"]').show();
        instance.$element.find('[role="emapDataTip"]').show();
    }

    function _hideTip(instance) {
        instance.isEditMode = false;
        instance.$element.find('[role="newDataTip"]').hide();
        instance.$element.find('[role="emapDataTip"]').hide();
    }

    function _renderNewDataHolderTable(instance, rowOpt, isEmapDataEmpty) {
        instance.isNewDataHolderTableInited = true;
        var opt = _getNewDataHolderTableOpt(instance);
        instance.$newDataHolderTable.show();
        instance.$newDataHolderTable.on('emapdatatable.created', function(e, table) {
            if (rowOpt) {
                table.settings.isNewDataHolder = true;
                table.enterEditMode();
                var edit = table.$element.parent().emapEditableDataTable(true);
                _showTip(edit);
                if ((rowOpt.newDataEmptyNum || 1) - 1) {
                    _addNewData(edit, rowOpt);
                }
                if (isEmapDataEmpty) {
                    edit.$element.find('[role="emapDataTip"]').hide();
                }
            }
        });
        instance.$newDataHolderTable.emapdatatable(opt);
    }

    function _addNewData(instance, opt) {
        var num = opt.newDataEmptyNum || 1;
        for (var i = 0; i < num; i++) {
            instance.$newDataHolderTable.jqxDataTable('addRow', null, {});
        }
        _refreshTip(instance);
    }

    function _refreshTip(instance) {
        var rows = instance.$newDataHolderTable.jqxDataTable('getRows');
        var num = rows.filter(function(row) {
            return !row[toDeleteKey];
        }).length;
        instance.$element.find('[role="newDataTip"]').text($.i18n('bh-edt-newRow') + '（' + num + '）：');
    }

    function _getNewDataHolderTableOpt(instance) {
        var opt = $.extend(true, {}, instance.options.emapdatatable);
        opt.datamodel = instance.$emapDataTable.data('tableDataModel');
        opt.height = 'auto';
        opt.pageable = false;
        opt.columnsResize = false;
        opt.source = {
            localData: [{}],
            dataType: 'array',
            datafields: []
        };
        opt.schemaList = instance.$emapDataTable.data('schemaList');
        return opt;
    }

    /**
     * 这里是关键
     * 定义一个插件 plugin
     */
    $.fn.emapEditableDataTable = function(options, params) {
        var instance;
        instance = this.data('emapEditableDataTable');
        /**
         * 判断插件是否已经实例化过，如果已经实例化了则直接返回该实例化对象
         */
        if (!instance) {
            return this.each(function() {
                //将实例化后的插件缓存在dom结构里（内存里）
                return $(this).data('emapEditableDataTable', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        /**
         * 优雅处： 如果插件的参数是一个字符串，则 调用 插件的 字符串方法。
         * 如 $('#id').plugin('doSomething') 则实际调用的是 $('#id).plugin.doSomething();
         * doSomething是刚才定义的接口。
         * 这种方法 在 juqery ui 的插件里 很常见。
         */
        if ($.type(options) === 'string') {
            return instance[options](params);
        }
        return this;
    };

    /**
     * @memberof module:emapEditableDataTable
     * @description [description]
     * @property {Boolean} [isAutoAdd=false] 原始表单数据为空，是否进入编辑模式
     * @property {Number} [newDataEmptyNum=1] 原始表单数据为空，今日编辑模式，默认新增几行数据
     * @property {Object} emapdatatable 参数同组件emapdatable入参
     */
    $.fn.emapEditableDataTable.defaults = {
        isAutoAdd: false,
        newDataEmptyNum: 1,
        emapdatatable: {}
    };

})(jQuery);
/***
 * 废弃组件
 */
(function($) {
    var Plugin;
    Plugin = (function() {
        function Plugin(element, options) {
            this.settings = $.extend({}, $.fn.emapEditableTable.defaults, options);
            this.$element = $(element);
            init.call(this, this.settings, this.$element);
        }

        return Plugin;

    })();

    Plugin.prototype = {

    };

    function init(settings, $element) {

        this.models = getModels.call(this);
        this.dataPath = getDataPath.call(this);
        this.dataFields = getDataFields.call(this, this.models);
        this.source = getSource.call(this);
        this.columns = getColumns.call(this);

        render.call(this);
    }

    function render() {
        var params = $.extend({}, this.settings);
        params.source = this.source;
        params.columns = this.columns;

        delete params.pagePath;
        delete params.action;
        delete params.checkbox;
        delete params.editableFields;
        delete params.filter;

        this.$element.jqxDataTable(params);
    }

    function getColumns() {

        var columns = [];
        var checkboxColumn = null;
        var models = this.models;
        var self = this;

        if (this.settings.checkbox) {
            checkboxColumn = getCheckboxColumn.call(this);
            columns.push(checkboxColumn);
        }

        for (var i = 0; i < this.models.length; i++) {
            (function() {
                var model = self.models[i];
                var editable = self.settings.editable && _.contains(self.settings.editableFields, model.name);
                var column = generateColumnByModel.call(self, model, editable);
                columns.push(column);
            })();
        }

        return columns;
    }

    function createCombo(model, editor, width, height) {
        var source = {
            datatype: "json",
            datafields: [{
                name: 'id'
            }, {
                name: 'name'
            }],
            url: model.url
        };
        var dataAdapter = new $.jqx.dataAdapter(source, {
            async: false,
            downloadComplete: function(data, status, xhr) {
                try {
                    var d = [{
                        id: '',
                        name: "请选择..."
                    }];
                    data.data = d.concat(data.datas.code.rows);
                    delete data.datas;
                    delete data.code;
                    return data;
                } catch (e) {
                    source.totalRecords = data.recordsTotal;

                }
            }
        });
        editor.jqxDropDownList({
            placeHolder: '请选择...',
            source: dataAdapter,
            displayMember: "name",
            valueMember: "id",
            width: width - 10,
            height: 25
        });
    }

    function generateColumnByModel(model, editable) {

        var columnWidth = getColumnWidth(model);
        var self = this;

        var column = {
            text: model.caption,
            dataField: model.name,
            hidden: model.hidden,
            width: columnWidth,
            cellsRenderer: function(row, column, value, rowData) {
                if (model.url) {
                    value = rowData[column + "_DISPLAY"]
                }

                return '<span title="' + value + '">' + value + '</span>';
            }
        };

        if (editable) {
            column['createEditor'] = function(row, cellvalue, editor, cellText, width, height) {
                var newEditor = editor;
                if (model.url) {
                    var newEditor = $("<div class='dropDownList'></div>");
                    editor.after(newEditor);
                    editor.hide();
                }
                createField.call(self, model, newEditor, width, height);
            };

            column['initEditor'] = function(row, cellvalue, editor, celltext, width, height) {
                var _this = this;
                if (model.url) {
                    editor = editor.parent().find('.dropDownList');
                    editor.jqxDropDownList({
                        width: width - 10,
                        height: height
                    }).off("select").on("select", function(event) {
                        var args = event.args;
                        if (args) {
                            var item = args.item;
                            var label = item.label;
                            _this.displayValue = {
                                row: row,
                                display: label
                            };
                            var rowData = self.$element.jqxDataTable('getRows')[row];
                            rowData[model.name] = args.item.value;
                            rowData[model.name + '_DISPLAY'] = args.item.label;
                            editor.jqxDropDownList('selectItem', item);
                        }
                    });
                    var items = editor.jqxDropDownList('getItems');
                    editor.jqxDropDownList('clearSelection');
                    var selectedIndex = null;
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].value == cellvalue) {
                            selectedIndex = items[i].index;
                            //editor.jqxDropDownList('selectItem', items[i]);
                            break;
                        }
                    }
                    editor.jqxDropDownList('selectIndex', selectedIndex);

                } else {
                    var inputField = editor.find('input');
                    inputField.val(cellvalue);
                }
            };
            column['getEditorValue'] = function(row, cellvalue, editor) {
                if (model.url) {
                    editor = editor.parent().find('.dropDownList');
                }
                return getEditorValue(model, editor);
            };
        } else {
            column['editable'] = false;
        }

        return column;
    }

    function createField(model, editor, width, height) {
        if (model.url) {
            createCombo(model, editor, width, height);
        } else if (model.dataType == "int") {
            this.createNumber(model, editor, width, height);
        } else {
            var inputElement = $("<input style='padding-left: 4px; border: none;'/>").appendTo(editor);
            inputElement.jqxInput({
                source: getEditorDataAdapter.call(this, model.name),
                displayMember: model.name,
                width: width,
                height: height
            });
        }
    }

    function getEditorDataAdapter(datafield) {
        var dataFields = this.dataFields;
        var source = {
            localData: this.source.records,
            dataType: "array",
            dataFields: dataFields
        };
        var dataAdapter = new $.jqx.dataAdapter(source, {
            uniqueDataFields: [datafield]
        });
        return dataAdapter;
    }

    function getEditorValue(model, editor) {
        if (model.url) {
            var selectItem = editor.jqxDropDownList("getSelectedItem");
            if (selectItem) {
                return selectItem.value;
            } else {
                return "";
            }
        } else {
            return editor.find('input').val();
        }
    }

    function getColumnWidth(model) {
        var url = model.url;
        var width = model["grid.width"];
        if (width) {
            return width;
        }
        var size = 1;
        if (url) { //说明有字典表
            size = 10;
        }
        return null;
        width = (model.dataSize * size);
        if (width < 100) {
            width = 100;
        } else if (width < 200) {
            width = 200;
        } else {
            width = 300;
        }
        return width;
    }

    function getCheckboxColumn() {
        var self = this;
        var checkboxColumn = {
            text: 'checkbox',
            width: '32px',
            cellsAlign: 'center',
            align: 'center',
            editable: false,
            renderer: function(text, align, height) {
                var checkBox = '<div class="selectAllCheckboxFlag bh-checkbox bh-mh-8"><label><input type="checkbox" value=""><i class="bh-choice-helper"></i></label></div>';
                return checkBox;
            },
            cellsRenderer: function(row, column, value, rowData) {
                var checkBox = '<div data-sss="" class="bh-checkbox bh-mh-4" style="margin-left:0 !important;"><label><input type="checkbox" value=""><i class="bh-choice-helper"></i></label></div>';
                return checkBox;
            },
            rendered: function(element, align, height) {
                element.on("click", "input", function(e) {
                    var $table = self.$element;
                    var $tableContent = $table.find("table");
                    var $checkboxList = $tableContent.find("div.bh-checkbox");
                    var $input = $(this);
                    if ($input.hasClass("selectFlag")) {
                        $input.prop("checked", false).removeClass("selectFlag");
                        $checkboxList.each(function() {
                            $(this).find("input").prop("checked", false);
                        });
                    } else {
                        $input.prop("checked", true).addClass("selectFlag");
                        $checkboxList.each(function() {
                            $(this).find("input").prop("checked", true);
                        });
                    }
                    $(this).trigger('checkall');
                    e.stopPropagation();
                });
                return true;
            }
        };
        return checkboxColumn;
    }

    /***
     * *
     * [获取数据源]
     */
    function getSource() {
        var self = this;
        var source = {
            datatype: "json",
            datafields: this.dataFields,
            id: 'WID',
            url: this.dataPath
        };
        var dataAdapter = new $.jqx.dataAdapter(source, {
            formatData: function(data) {
                var pageSize = data.pagesize;
                var pageNumber = data.pagenum + 1;
                var querySetting = [];
                if (data.querySetting) {
                    if (data.querySetting.length > 0) {
                        var q = JSON.parse(data.querySetting);
                        if (q.length > 0) {
                            querySetting = querySetting.concat(q);
                        }
                    }
                }
                if (querySetting) {
                    querySetting.push(JSON.parse(self.settings.filter.querySetting));
                }
                data.querySetting = JSON.stringify(querySetting);
                data.pageSize = pageSize;
                data.pageNumber = pageNumber;
                delete data.pagesize;
                delete data.pagenum;
                delete data.filterslength;
                return data;
            },
            downloadComplete: function(data, status, xhr) {
                var action = self.settings.action;
                try {
                    source.totalRecords = data.datas[action].totalSize;
                    data.recordsTotal = data.datas[action].totalSize;
                    data.data = data.datas[action].rows;
                    delete data.datas;
                    delete data.code;
                    return data;
                } catch (e) {
                    source.totalRecords = data.recordsTotal;
                }
            }
        });

        return dataAdapter;
    }

    function getModels() {

        var models = WIS_EMAP_SERV.getModel(this.settings.pagePath, this.settings.action, "grid");

        return models;
    }

    function getDataPath() {
        var pagePath = this.settings.pagePath;
        var action = this.settings.action;

        var dataPath = pagePath.replace(".do", "/" + action + ".do");
        var dataPath = 'http://res.wisedu.com/fe_components/mock/table.json'

        return WIS_EMAP_SERV.getAbsPath(dataPath);
    }

    function getDataFields(models) {
        var datafields = [];
        for (var i = 0; i < models.length; i++) {
            if (models[i].url) {
                datafields.push({
                    name: models[i].name + '_DISPLAY',
                    type: 'string'
                });
            }
            datafields.push({
                name: models[i].name,
                type: 'string'
            });
        }
        return datafields;
    }

    $.fn.emapEditableTable = function(options, params) {
        var instance;
        instance = this.data('emapEditableTable');
        if (!instance) {
            return this.each(function() {
                //将实例化后的插件缓存在dom结构里（内存里）
                return $(this).data('emapEditableTable', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') instance[options](params);
        return this;
    };

    $.fn.emapEditableTable.defaults = {

        /***
         * [pagePath 页面模型]
         * @type {String}
         */
        pagePath: '',

        /***
         * [action 动作]
         * @type {String}
         */
        action: '',

        /***
         * [editableFields 可编辑的列，未配置在此则表示不可编辑]
         * @type {Array}
         */
        editableFields: [],

        /***
         * [checkbox 是否显示复选框]
         * @type {Boolean}
         * @default  true
         */
        checkbox: true,

        /***
         * [pageable 是否可分页]
         * @type {Boolean}
         */
        pageable: true,

        /**
         * [filter 查询条件]
         * @type {String}
         */
        filter: '',

        editable: true,

        width: '100%'
    };
})(jQuery);
(function() {
    var Plugin,
        _init;
    /**
     * @module emapEditor
     * @description 富文本编辑器, 基于三方查件 <a href="http://summernote.org/">summernote</a>封装 <br>
     * 依赖项 <br>
     *
     * @example
     * <link rel="stylesheet" href="http://res.wisedu.com/bower_components/summernote-0.8.1/dist/summernote-bs3.min.css">
<link rel="stylesheet" href="http://res.wisedu.com/bower_components/summernote-0.8.1/dist/summernote.css">

<script src="http://res.wisedu.com/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="http://res.wisedu.com/bower_components/summernote-0.8.1/dist/summernote.js"></script>
     *
        $('#container').emapEditor({
            contextPath: "/emap"
        })
     */
    Plugin = (function() {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapEditor.defaults, options);
            this.$element = $(element);
            _init(this.$element, this.options);

        }

        /**
         * 判断是否为空
         * @method isEmpty
         * @returns {Boolean}
         * @example
            $("#container").emapEditor('isEmpty');
         */
        Plugin.prototype.isEmpty = function() {
            return this.$element.summernote('isEmpty');
        };

        /**
         * 清空内容
         * @method clear
         * @example
            $("#container").emapEditor('clear');
         */
        Plugin.prototype.clear = function() {
            return this.$element.summernote('reset');
        };

        /**
         * 禁用
         * @method disable
         * @example
         $("#container").emapEditor('disable');
         */
        Plugin.prototype.disable = function() {
            return this.$element.summernote('disable');
        };

        /**
         * 启用
         * @method enable
         * @example
         $("#container").emapEditor('enable');
         */
        Plugin.prototype.enable = function() {
            return this.$element.summernote('enable');
        };

        /**
         * 获取富文本编辑器的内容
         * @method getValue
         * @return {String} 富文本编辑器内容
         * @example
         $("#container").emapEditor('getValue');
         */
        Plugin.prototype.getValue = function() {
            var value = this.$element.summernote('code');
            return value === '<p><br></p>' ? '' : value;
        };

        /**
         * 富文本编辑器赋值
         * @method setValue
         * @param {String} value - 要赋值的内容
         * @example
         $("#container").emapEditor('setValue', 'content');
         */
        Plugin.prototype.setValue = function(content) {
            return this.$element.summernote('code', content);
        };

        /**
         * 销毁
         * @method destroy
         * @example
         $("#container").emapEditor('destroy');
         */
        Plugin.prototype.destroy = function() {
            this.$element.summernote('reset');
            return this.$element.summernote('destroy');
        };
        return Plugin;
    })();

    _init = function(element, options) {
        if (!options.contextPath && WIS_EMAP_SERV) {
            options.contextPath = WIS_EMAP_SERV.getContextPath();
        }
        options.$element = $(element);
        // 判断时是否已加载summernote  若没有  则加载js
        if (!$.fn.summernote) {
            console && console.warn('依赖插件summernote未引入!');
            return;
        }

        // 自定义 按钮
        var uploadFile = function(context) {
            var ui = $.summernote.ui;

            // create button
            var button = ui.button({
                contents: '<i class="iconfont icon-attachfile" style="line-height: 12px;font-size: 14px;" />',
                tooltip: 'uploadFile',
                click: function() {
                    var $self = context.options.$element;
                    var uploadDiv = context.options.uploadDiv;
                    context.options.uploadFlag = 'file';

                    $('input[type=file]', uploadDiv).fileupload('option', {
                        submit: function() {},
                        done: function(e, data) {
                            if (data.result.success) {
                                var token = uploadDiv.emapUploadCore('saveTempFile');
                                if (token) {
                                    var imgNode;
                                    imgNode = $('<a href="' + (options.fullFilePath ? gethost() : '') + options.contextPath + '/sys/emapcomponent/file/getFileByToken/' + token + '.do" >' + data.result.name + '</a>')[0]

                                    $self.summernote('insertNode', imgNode);
                                    //  插入成功后 重载上传 刷新token
                                    uploadDiv.emapUploadCore('reload')
                                }
                            }
                        }
                    });
                    $('input[type=file]', context.options.uploadDiv).trigger('click');

                }
            });

            return button.render(); // return button as jquery object
        };

        // 自定义图片上传
        var uploadImage = function(context) {
            var ui = $.summernote.ui;

            // create button
            var button = ui.button({
                contents: '<i class="iconfont icon-image" style="line-height: 12px;font-size: 14px;" />',
                tooltip: 'uploadImage',
                click: function() {
                    var $self = context.options.$element;
                    var uploadDiv = context.options.uploadDiv;
                    context.options.uploadFlag = 'file';

                    $('input[type=file]', uploadDiv).fileupload('option', {
                        submit: function(e, data) {
                            var file = data.files[0];
                            var imgType = ['jpg', 'jpeg', 'png'];
                            // 文件的大小 和类型校验
                            if (!new RegExp((imgType.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                                $.bhTip && $.bhTip({
                                    content: $.i18n('bh-et-uploadRightType'),
                                    state: 'danger',
                                    iconClass: 'icon-close'
                                });
                                return false;
                            }
                        },
                        done: function(e, data) {
                            if (data.result.success) {
                                var token = uploadDiv.emapUploadCore('saveTempFile');
                                if (token) {
                                    var imgNode = new Image()
                                    imgNode.src = (options.fullFilePath ? gethost() : '') + options.contextPath + '/sys/emapcomponent/file/getFileByToken/' + token + '.do'
                                    imgNode.onload = function() {
                                        var containerWidth = $self.parent().width()
                                        if (this.width > containerWidth) {
                                            this.style.width = containerWidth - 20 + 'px'
                                        }
                                        $self.summernote('insertNode', imgNode);
                                    }


                                    // var imgNode;
                                    // imgNode = $('<img src="' + (options.fullFilePath ? gethost() : '') + options.contextPath + '/sys/emapcomponent/file/getFileByToken/' + token + '.do" />')[0]

                                    // $self.summernote('insertNode', imgNode);
                                    //  插入成功后 重载上传 刷新token
                                    uploadDiv.emapUploadCore('reload')
                                }
                            }
                        }
                    });
                    $('input[type=file]', context.options.uploadDiv).trigger('click');

                }
            });

            return button.render(); // return button as jquery object
        }

        function gethost() {
            return location.origin || location.host;
        }

        // 上传功能的html
        $(element).after('<div role="emap-editor-upload" style="display: none;"></div>')
        options.uploadDiv = $(element).next('[role="emap-editor-upload"]');
        options.uploadDiv.emapUploadCore({
            contextPath: options.contextPath
        });

        // 隐藏计数文本域下的计数条 (可能存在在计数文本域上实例化富文本编辑器的情况)
        var numFooter = $('.bh-txt-input__foot', $(element).parent());
        if (numFooter.length) {
            numFooter.hide();
        }
        var txtContainer = $(element).closest('.bh-txt-input');
        if (txtContainer.length) {
            txtContainer.css('border', 'none');
        }

        $(element).summernote($.extend({
            lang: 'zh-CN',
            buttons: {
                uploadFile: uploadFile,
                uploadImage: uploadImage
            }
        }, options));
        // 默认字体微软雅黑
        $(element).summernote('fontName', 'Microsoft YaHei');


    };

    $.fn.emapEditor = function(options, param) {
        var instance;
        instance = this.data('emapeditor');
        if (!instance) {
            return this.each(function() {
                return $(this).data('emapeditor', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](param);
        return this;
    };

    /**
     * @memberof module:emapEditor
     * @prop {String}  contextPath - emap根路径
     *
     * @description 详细配置参数见 <a href="http://summernote.org/">summernote</a>
     */

    $.fn.emapEditor.defaults = {
        height: 200,
        disableDragAndDrop: true,
        onCreateLink: function(link) {
            var defaultScheme = 'http://';
            var linkPattern = /^(https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|mailto:[A-Z0-9._%+-]+@)?(www\.)?(.+)$/i;
            var match = link.match(linkPattern);
            if (match && (match[1] || match[2])) {
                return match[1] ? link : defaultScheme + link;
            }
            return defaultScheme + link;
        },
        fullFilePath: false, // 保存文件和 图片的 绝对路径
        popover: {
            air: [
                ['color', ['color']],
                ['font', ['bold', 'underline', 'clear']]
            ]
        },
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'italic', 'clear']],
            ['fontname', ['fontname']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'uploadImage', 'uploadFile', 'hr']],
            ['view', ['codeview']]
        ],
        fontNames: ['SimHei', 'SimSun', 'KaiTi', 'Microsoft YaHei', 'Arial', 'Arial Black', 'Helvetica', 'Comic Sans MS', 'Courier New']
    };
}).call(this);
(function() {
  var Plugin, _renderFormWrap,
    _renderReadonlyFormStructure, _renderEditFormStructure, _sortModel, _getAttr, _emapFormDo, _renderTableFormStructure,
    _renderReadonlyInputPlace, _renderEditInputPlace, _eventBind, _calcLineHeight; //插件的私有方法
  var _defaultValues = {};

  Plugin = (function() {
    /**
     * @module emapForm
     * @alias 表单
     * @description 表单
     */
    function Plugin(element, options) {
      // 旧版 option 参数的兼容处理
      if (options.mode) {
        options.model = options.mode;
      }
      if (options.model == 'L' || options.model == 'horizontal') {
        options.model = 'h';
      }
      if (options.model == 'S' || options.model == 'vertical') {
        options.model = 'v';
      }
      if (options.rows) {
        options.cols = options.rows;
      }

      //将插件的默认参数及用户定义的参数合并到一个新的obj里
      this.options = $.extend({}, $.fn.emapForm.defaults, options);
      if (!this.options || this.options == null || this.options == "") {
        this.options = WIS_EMAP_SERV.getContextPath();
      }
      //将dom jquery对象赋值给插件，方便后续调用
      this.$element = $(element);

      this.$element.attr("emap-role", "form");

      this.$element.attr("emap", JSON.stringify({
        "emap-url": WIS_EMAP_SERV.url,
        "emap-name": WIS_EMAP_SERV.name,
        "emap-app-name": WIS_EMAP_SERV.appName,
        "emap-model-name": WIS_EMAP_SERV.modelName
      }));
      delete WIS_EMAP_SERV.url;
      delete WIS_EMAP_SERV.name;
      delete WIS_EMAP_SERV.appName;
      delete WIS_EMAP_SERV.modelName;

      this.options.useNewDropdownTree = this.options.useNewDropdownTree !== undefined ? !!this.options.useNewDropdownTree : WIS_EMAP_CONFIG.useNewDropdownTreeForm;

      // 读取全局配置参数 将下拉树替换为新版Ztree的下拉树
      if (this.options.useNewDropdownTree === true) {
        this.options.data.map(function(item) {
          if (item['form.xtype']) {
            if ($.inArray(item['form.xtype'], ['tree', 'multi-tree']) > -1) {
              item['form.xtype'] = item['form.xtype'].replace(/tree$/, 'tree2')
            }
          } else {
            if ($.inArray(item['xtype'], ['tree', 'multi-tree']) > -1) {
              item['xtype'] = item['xtype'].replace(/tree$/, 'tree2')
            }
          }
        });
      }
      _renderFormWrap(this.$element, this.options);
      //初始化控件
      if (this.options.data) {
        this.$element.emapFormInputInit(this.options);
        // t表单需要在渲染完成后 兼容ie9的placeholder
        if (this.options.model === 't') {
          WIS_EMAP_INPUT.placeHolder(this.$element);
        }
        if (!this.options.readonly) {
          if (!$.isEmptyObject(_defaultValues)) WIS_EMAP_INPUT.formSetValue(this.$element, _defaultValues, this.options);
          if (this.options.validate) {
            // 初始化表单校验
            this.$element.emapValidate(options);
          }
        }
      }
      if (!this.options.readonly && this.options.data) {
        // 初始化 下拉框联动
        var linkModal = getLinkageModel(this.options.data, this.options);
        if (linkModal.length > 0) {
          this.$element.emapLinkage({
            data: linkModal
          });
        }
      }
      var self = this;

      _eventBind(this.$element, this.options);

      // 表格表单 计算label行高, 文字过多时两行布局
      if (!options.flexLayout) {
        _calcLineHeight(self.$element, self.options);
      }

      // 自动补齐
      if (self.options.readonly || self.options.model == 't') {
        refreshColumns(this.$element, this.options)
      }

      // ie9 添加placeholder
      WIS_EMAP_INPUT.placeHolder();

      setTimeout(function() {
        // 针对某些特殊情况连续调用destroy后实例化 options可能为null时，做安全处理
        if (!self.options) {
          return;
        }

      }, 0);
    }
    /**
     * @method disableItem
     * @description 禁用表单项
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.disableItem = function(ids) {
      var self = this.$element;
      WIS_EMAP_INPUT.formDisable(this.$element, ids);
      if (this.options.model == 't' && this.options.showDisableLockedIcon == true) {
        var element = this.$elemet;
        _emapFormDo(ids, function(id) {
          $('[data-name=' + id + ']', element).closest('[emap-role="input-wrap"]').append('<i class="iconfont icon-lock bh-table-form-icon" style="background: #fff;"></i>')
        })
      }
      // 针对1.1， 1.2不同校验组件做兼容
      if (!self.data('bhvalidate')) {
        this.$element.emapForm('reloadValidate');
      } else {
        // 字段disable后， 尝试清除改字段上的校验出错信息
        self.bhValidate('hideValidate', ids);
      }
    };

    /**
     * @method enableItem
     * @description 启用表单项
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.enableItem = function(ids) {
      var self = this.$element;
      WIS_EMAP_INPUT.formEnable(this.$element, ids);
      if (this.options.model == 't' && this.options.showDisableLockedIcon == true) {
        var element = this.$elemet;
        _emapFormDo(ids, function(id) {
          var lockIcon = $('[data-name=' + id + ']', element).closest('[emap-role="input-wrap"]').find('<i class="iconfont icon-lock bh-table-form-icon" style="background: #fff;"></i>');
          if (lockIcon.length) lockIcon.remove();
        })
      }
      // 针对1.1， 1.2不同校验组件做兼容
      if (!self.data('bhvalidate')) {
        this.$element.emapForm('reloadValidate');
      }
    };

    /**
     * @method saveUpload
     * @description 保存表单中的上传组件 (请使用saveUploadSync代替)
     * @param {Object} [param] - 保存请求的附带参数
     */
    Plugin.prototype.saveUpload = function(param) {
      var items = $('[xtype=uploadphoto], [xtype=uploadfile], [xtype=uploadsingleimage], [xtype=uploadmuiltimage], [xtype="cache-upload"]', this.$element);
      if (items.length === 0) {
        // 表单中无上传组件的情况下调用保存上传方法
        console && console.error("There's no upload component in form, don't call the 'saveUploadSync' method !");
      } else {
        items.each(function() {
          switch ($(this).attr('xtype')) {
            case 'uploadphoto':
              $(this).emapFilePhoto('saveTempFile', param);
              break;
            case 'uploadfile':
              $(this).emapFileUpload('saveTempFile', param);
              break;
            case 'uploadsingleimage':
              $(this).emapSingleImageUpload('saveTempFile', param);
              break;
            case 'uploadmuiltimage':
              $(this).emapImageUpload('saveTempFile', param);
              break;
            case 'cache-upload':
              $(this).emapUpload('saveUpload', param);
              break;
          }
        });
      }
    };

    /**
     * @method saveUploadSync
     * @description  异步的保存表单中上传组件的方法， 返回promise对象
     * @param {Object} params - 保存请求附带参数
     * @return {Object} 异步方法的Defer对象
     */
    Plugin.prototype.saveUploadSync = function(param) {
      var items = $('[xtype=uploadphoto], [xtype=uploadfile], [xtype=uploadsingleimage], [xtype=uploadmuiltimage], [xtype="cache-upload"]', this.$element);
      var items_length = items.length;
      var result_array = [];
      var result_defer = $.Deferred();
      result_defer.fail(function() { // 对于表单保存操作 中 上传文件保存操作失败的处理
        $.bhTip && $.bhTip({
          content: $.i18n('bh-fm-saveUploadFilesFail'),
          state: 'danger',
          iconClass: 'icon-close'
        });
      });
      if (items_length === 0) {
        // 表单中无上传组件的情况下调用保存上传方法
        console && console.error("There's no upload component in form, don't call the 'saveUploadSync' method !");
        setTimeout(function() {
          result_defer.resolve([]);
        }, 10);
      } else {
        items.each(function() {
          var defer;
          // 过滤只读状态的上传组件
          if ($(this).attr('data-disabled') == true || $(this).attr('data-disabled') == 'true') {
            items_length--;
            return true;
          }
          switch ($(this).attr('xtype')) {
            case 'uploadfile':
              defer = $(this).emapFileUpload('saveUpload', param);
              break;
            case 'uploadsingleimage':
              defer = $(this).emapSingleImageUpload('saveUpload', param);
              break;
            case 'uploadmuiltimage':
              defer = $(this).emapImageUpload('saveUpload', param);
              break;
            case 'cache-upload':
              defer = $(this).emapUpload('saveUpload', param);
              break;
          }
          defer && defer.done(function(res) {
            if (res.success) {
              result_array.push(res);
              if (result_array.length == items_length) {
                result_defer.resolve(result_array);
              }
            } else {
              result_defer.reject();
            }
          }).fail(function(error) {
            result_defer.reject();
          });
        });
        // 针对表单内只有一个上传组件且该组件设定为只读时，items_length为0 的情况直接做异步返回
        if (items_length === 0) {
          setTimeout(function() {
            result_defer.resolve([]);
          }, 10);
        }
      }

      return result_defer;
    };

    /**
     * @method showItem
     * @description 显示表单项
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.showItem = function(ids) {
      var self = this.$element;
      var options = this.options;
      _emapFormDo(ids, _show);
      // 针对1.1， 1.2不同校验组件做兼容
      if (!self.data('bhvalidate')) {
        this.$element.emapForm('reloadValidate');
      }
      if (options.model == 't' || options.readonly == true) {
        self.emapForm('refreshColumns')
      }

      function _show(id) {
        if (options.model == 't' || options.readonly === true) {
          var item = $('[data-name=' + id + ']', self).closest('.bh-form-group');
          item.show();
          if (options.model == 't') {
            item.parent().show();
          }
        } else {
          $('[data-name=' + id + ']', self).closest('.bh-row').show().attr('hidden', false);
        }
      }
    };

    /**
     * @method hideItem
     * @description 隐藏表单项
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.hideItem = function(ids) {
      var self = this.$element;
      var options = this.options;
      _emapFormDo(ids, _hide);
      // 针对1.1， 1.2不同校验组件做兼容
      if (!self.data('bhvalidate')) {
        this.$element.emapForm('reloadValidate');
      }
      if (options.model == 't' || options.readonly == true) {
        self.emapForm('refreshColumns')
      }

      function _hide(id) {
        if (options.model == 't' || options.readonly === true) {
          var item = $('[data-name=' + id + ']', self).closest('.bh-form-group');
          item.hide();
          if (options.model == 't') {
            item.parent().hide();
          }
        } else {
          $('[data-name=' + id + ']', self).closest('.bh-row').hide().attr('hidden', true);
        }
      }
    };

    /**
     * @method getValue
     * @description 表单取值
     * @return {Object} 包含表单每个字段的值的json对象， key为表单字段的name， value为表单字段的值
     */
    Plugin.prototype.getValue = function() {
      return WIS_EMAP_INPUT.formGetValue(this.$element, this.options);
    };

    /**
     * @method clear
     * @description 表单清空
     * @param {String|Array} - 如果不传参数，则清空表单中所有值;如果传入参数是个数组，则清空该数组中为字段名称的控件值
     */
    Plugin.prototype.clear = function(val) {
      WIS_EMAP_INPUT.formClear(this.$element, val, this.options);
    };

    /**
     * @method setValue
     * @description 表单赋值
     * @param {Object} - 表单数据json对象， key为表单字段的name， value为表单字段的值
     */
    Plugin.prototype.setValue = function(val) {
      WIS_EMAP_INPUT.formSetValue(this.$element, val, this.options);
      // 表单塞值后清除出现的 校验信息
      var ids = [];
      if (val) {
        for (var v in val) {
          ids.push(v);
        }
      }
      this.$element.emapForm('clearValidateInfo', ids);
    };


    /**
     * @method destroy
     * @description 销毁表单
     */
    Plugin.prototype.destroy = function() {
      // 遍历销毁单个控件 确保控件在body底部插入的dom元素被销毁
      $('[xtype]', this.$element).each(function() {
        var _this = $(this);
        var xtype = _this.attr('xtype');
        switch (xtype) {
          case 'select':
            _this.jqxDropDownList('destroy');
            break;
          case 'multi-select':
            _this.jqxComboBox('destroy');
            break;
          case 'date-local':
          case 'date-ym':
          case 'date-full':
            _this.jqxDateTimeInput('destroy');
            break;
          case 'tree':
            _this.jqxDropDownButton('destroy');
            break;
        }
      });
      if (!this.options.readonly) this.$element.emapValidate('destroy');
      this.options = null;
      $(this.$element).removeAttr("emap-role");
      $(this.$element).data('emapform', false).empty();
    };

    /**
     * @method reloadValidate
     * @description 校验重载
     */
    Plugin.prototype.reloadValidate = function() {
      if (!this.options.validate) return;
      this.$element.emapValidate('destroy');
      this.$element.emapValidate(this.options);
    };

    /**
     * @method requireItem
     * @description 添加字段的必填校验
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.requireItem = function(ids) {
      var self = this.$element;
      _emapFormDo(ids, _required);

      function _required(id) {
        var $formGroup = $('[data-name=' + id + ']', self).closest('.bh-form-group');
        if (!$formGroup.hasClass('bh-required')) {
          $formGroup.addClass('bh-required');
          // 针对1.1， 1.2不同校验组件做兼容
          if (self.data('bhvalidate')) {
            // 1.2
            self.bhValidate('requireItem', id);
          } else {
            // 1.1
            self.emapForm('reloadValidate');
          }
        }
      }
    };

    /**
     * @method unRequireItem
     * @description 取消字段的必填校验
     * @param {String|Array} ids - 表单字段的name
     */
    Plugin.prototype.unRequireItem = function(ids) {
      var self = this.$element;
      _emapFormDo(ids, _required);

      function _required(id) {
        var $formGroup = $('[data-name=' + id + ']', self).closest('.bh-form-group');
        if ($formGroup.hasClass('bh-required')) {
          $formGroup.removeClass('bh-required');
          // 针对1.1， 1.2不同校验组件做兼容
          if (self.data('bhvalidate')) {
            // 1.2
            self.bhValidate('unRequireItem', id);
          } else {
            // 1.1
            self.emapForm('reloadValidate');
          }
        }
      }
    };

    /**
     * @method getModel
     * @description 获取表单模型
     * @param {Boolean} [sort=false] - 是否对表单模型按分组序列化
     * @return {Object} 表单模型
     */
    Plugin.prototype.getModel = function(sort) { // sort 是否自动分组
      if (this.options.hasGroup && sort) {
        return _sortModel(this.options.data);
      } else {
        return this.options.data;
      }
    };

    /**
     * @method refreshColumns
     * @description 刷新只读表单和表格表单的列布局  自动补齐
     */
    Plugin.prototype.refreshColumns = function() {
      refreshColumns(this.$element, this.options);
    };

    /**
     * @method changeLabelColor
     * @description 不爱换表单字段label的背景色
     * @param {Object} [params] - json对象, key 为 颜色 可选值: 'primary', 'info', 'success', 'warning', 'danger' , 'normal',
     *  value 为要变换的 字段的name 可以为数组
     * @example
     *  $Form.emapForm('changeLabelColor', {
     *      primary: ['WID', 'XH'],
     *      success: ['XM']
     *  })
     */
    Plugin.prototype.changeLabelColor = function(params) {
      var instance = this;
      for (var k in params) {
        if (k != 'primary' && k != 'info' && k != 'success' && k != 'warning' && k != 'danger' && k != 'normal') {
          console && console.error(k + '不是有效的label color 属性!');
        }
        if (params[k] instanceof Array) {
          params[k].map(function(item) {
            _handleColor(item, k, instance);
          })
        } else {
          _handleColor(params[k], k, instance);
        }
      }


      function _handleColor(name, color, instance) {
        var element = instance.$element;
        var type = instance.options.model;
        var form_group = $();
        if (type == 't' || instance.options.readonly == true) {
          form_group = $('[data-name=' + name + ']', element).closest('.bh-form-group');
        } else if (type == 'h' || type == 'v') {
          form_group = $('[data-name=' + name + ']', element).closest('.form-validate-block');
        }
        form_group.length && form_group.removeClass('bh-primary bh-info bh-success bh-warning bh-danger bh-normal').addClass('bh-' + color);
      }
    };

    /**
     * @method clearValidateInfo
     * @description 清除字段上的校验出错信息
     * @param {Array|String} [id] 字段id
     * @example
     * $form.emapForm('clearValidateInfo', 'WID');
     */
    Plugin.prototype.clearValidateInfo = function(id) {
      var element = this.$element;
      if (element.data('bhvalidate')) {
        element.bhValidate('hideValidate', id);
      } else {
        if (id === undefined) { // 清除表单中所有校验信息
          element.jqxValidator('hide')
        } else if (id instanceof Array) { // 清除多个字段的校验信息
          if (id.length) {
            id.map(function(item) {
              element.jqxValidator('hideHint', '[data-name=' + item + ']');
            });
          }
        } else if (typeof id == 'string') { // 清除单个字段的校验信息
          element.jqxValidator('hideHint', '[data-name=' + id + ']');
        }
      }

    }
    return Plugin;
  })();

  // 渲染表单外框
  _renderFormWrap = function(element, options) {
    if (!options.data) return; // 为兼容孟斌的特殊样式表单 此处实现表单的假实例化功能
    var readOnly = options.readonly ? options.readonly : false;
    var $form = $('<div class="bh-form-horizontal" bh-form-role="bhForm" ></div>');

    if (readOnly || options.model == "t") {
      $form.addClass('bh-form-readonly');
      if (options.model == "t") {
        $form.addClass('bh-table-form');
      }
      // 如果开启 flexLayout , 则采用flex布局
      if (options.flexLayout && document.documentMode != 9 && document.documentMode != 10) {
        $form.addClass('bh-flex-form');
      }
    } else {
      if (options.model == "v") {
        $form.addClass('bh-form-S');
      }
    }

    options.hasGroup = options.data.filter(function(val) {
      return !!val.groupName && val.groupName != "";
    }).length > 0;

    if (options.hasGroup && options.renderByGroup) {
      // 分组表单
      var sortedModel = _sortModel(options.data);
      for (var i = 0; i < sortedModel.length; i++) {

        // ui 要求 标题下边距高位24  表单区域下边距改为36
        var groupContainer = $('<div bh-form-role=groupContainer>' +
          '<div class="bh-col-md-12 bh-form-groupname sc-title-borderLeft bh-mb-24"  title="' + sortedModel[i].groupName + '" >' +
          '</div>' +
          '<div class="bh-form-block bh-mb-36" bh-role-form-outline="container" style="margin-left: 12px;margin-bottom: 36px;"></div>' +
          '</div>');

        if (options.showCollapseBtn) {
          $('.bh-form-groupname', groupContainer).append(
            '<span bh-role-form-outline="title">' + sortedModel[i].groupName + '</span>' +
            '<a bh-form-role="collapseBtn" data-collapse=false class="bh-text-caption bh-mh-8" style="font-weight: normal;" href="javascript:void(0)">' + $.i18n('bh-fm-gather') + '</a>'
          );
        } else {
          $('.bh-form-groupname', groupContainer).attr('bh-role-form-outline', 'title').append(sortedModel[i].groupName);
        }
        var formBlock = $('[bh-role-form-outline=container]', groupContainer);
        var visibleItem = sortedModel[i].items.filter(function(val) {
          return !val.get('hidden');
        });
        if (!sortedModel[i].groupName || visibleItem.length == 0) {
          // 隐藏未分组的字段
          groupContainer.css('display', 'none');
          $('.bh-form-groupname', groupContainer).removeAttr('bh-role-form-outline');
          $('.bh-form-block', groupContainer).attr('bh-role-form-outline', 'hidden');
        }
        if (options.model == 't') {
          // 表格表单
          _renderTableFormStructure(formBlock, sortedModel[i].items, options);
        } else if (readOnly) {
          _renderReadonlyFormStructure(formBlock, sortedModel[i].items, options);
        } else {
          _renderEditFormStructure(formBlock, sortedModel[i].items, options);
        }
        $form.append(groupContainer);
      }
    } else {
      // 不分组表单
      if (options.model == 't') {
        // 表格表单
        _renderTableFormStructure($form, options.data, options);
      } else if (readOnly) {
        _renderReadonlyFormStructure($form, options.data, options);
      } else {
        _renderEditFormStructure($form, options.data, options);
      }
    }
    element.append($form);
  };

  // model 分组排序
  _sortModel = function(model) {
    var result = [];
    for (var i = 0; i < model.length; i++) {
      var groupItem = result.filter(function(val) {
        return val.groupName == model[i].groupName;
      });
      if (groupItem.length == 0) {
        result.push({
          "groupName": model[i].groupName,
          "items": [model[i]]
        });
      } else {
        groupItem[0].items.push(model[i]);
      }
    }
    return result;
  };

  // 渲染只读表单结构
  _renderReadonlyFormStructure = function(form, data, options) {
    options.cols = options.cols ? options.cols : 3;
    options.colWidth = 12 / options.cols;
    var formFragment = document.createDocumentFragment();
    var columnCounter = 0;
    // 计算出最后一个显示的字段的序号
    $(data).each(function(i) {
      var attr = _getAttr(this);
      if (!attr.hidden) {
        columnCounter += attr.col;
      }
      if (attr.xtype == 'textarea') {
        attr.col = 12 / options.colWidth;
      }
      var item = document.createElement('div');
      item.className = 'bh-form-group  bh-col-md-' + attr.col * options.colWidth;
      if (attr.hidden) item.style.display = 'none';
      item.setAttribute('data-col', attr.col);
      // 此处去掉了bh-str-cut class 保证在文字过多时进行两行展示 zhuhui 2017-04-05
      item.innerHTML += '<label class="bh-form-label bh-form-readonly-label " title="' + attr.caption + '">' + attr.caption + '</label>';
      var form_input = document.createElement('div');
      form_input.className = 'bh-form-readonly-input';
      $(form_input).append(_renderReadonlyInputPlace(this, options));
      item.appendChild(form_input);
      formFragment.appendChild(item);

      // formFragment.appendChild('<div class="bh-form-group  bh-col-md-' + attr.col * options.colWidth + '" ' + (attr.hidden ? 'style="display: none;"' : '') + ' data-col="' + attr.col + '" >' +
      //     '<label class="bh-form-label bh-form-readonly-label bh-str-cut" title="' + attr.caption + '">' + attr.caption + '</label>' +
      //     '<div class="bh-form-readonly-input">' +
      //     _renderReadonlyInputPlace(this, options) +
      //     '</div></div>');


      // itemHtml += '<div class="bh-form-group  bh-col-md-' + attr.col * options.colWidth + '" ' + (attr.hidden ? 'style="display: none;"' : '') + ' data-col="' + attr.col + '" >' +
      //                 '<label class="bh-form-label bh-form-readonly-label bh-str-cut" title="' + attr.caption + '">' + attr.caption + '</label>' +
      //                 '<div class="bh-form-readonly-input">';
      // itemHtml += _renderReadonlyInputPlace(this, options);
      //     itemHtml += '</div>' +
      //             '</div>';

    });
    form.append(formFragment).addClass('bh-form-block');
  };
  // 渲染表格表单结构
  _renderTableFormStructure = function(form, data, options) {
    var itemArray = [];
    options.cols = options.cols ? options.cols : 3;
    options.colWidth = 12 / options.cols;

    $(data).each(function() {
      var itemHtml = '';
      var attr = _getAttr(this);
      if (attr.xtype == "textarea") attr.col = options.cols;
      itemHtml += '<div class="form-validate-block bh-col-md-' + attr.col * options.colWidth + '" data-col="' + attr.col + '" >' +
        '<div class="bh-form-group ' + attr.required + '" ' + (attr.hidden ? 'style="display: none;"' : '') + ' >' +
        '<label class="bh-form-label bh-form-readonly-label " title="' + attr.caption + '">' + attr.caption + '</label>' +
        '<div class="bh-ph-8 bh-form-readonly-input" emap-role="input-wrap">';
      itemHtml += '<div class="bh-form-placeholder bh-form-flow">' + attr.placeholder + '</div>';
      itemHtml += '</div></div></div>';
      itemHtml = $(itemHtml);
      // 添加字段布局的最大高度为33px,防止在hover和校验出错时出现的边框导致高度增加而影响布局  仅在不占满一行的字段上生效 zhuhui 2016-07-16
      if (attr.col != options.cols && !options.flexLayout && $.inArray(attr.xtype, ['uploadfile', 'uploadsingleimage', 'uploadmuiltimage', 'cache-upload', 'direct-upload']) == -1) {
        itemHtml.css({
          'max-height': '33px'
        });
      }
      if (options.flexLayout && attr.hidden) {
        itemHtml.css({
          'display': 'none'
        })
      }
      var input_wrap = $('[emap-role="input-wrap"]', itemHtml);
      if (attr.inputReadonly) {
        // 只读字段
        input_wrap.append(_renderReadonlyInputPlace(this, options));
      } else {
        // 可编辑字段
        input_wrap.append(_renderEditInputPlace(this, true));
        if (attr.xtype == undefined || attr.xtype == 'text') {
          // 为 文本框 添加右边的编辑图标
          input_wrap.append('<i class="iconfont icon-edit bh-table-form-icon"></i>');
        }
      }
      itemArray.push(itemHtml);
    });
    form.append(itemArray).addClass('bh-form-block');
    $(".form-validate-block", form).hover(function() {
      $(this).addClass("bh-actived");
    }, function() {
      $(this).removeClass("bh-actived");
    });
  };

  // 渲染编辑表单结构
  _renderEditFormStructure = function(form, data, options) {
    $(data).each(function() {
      var attr = _getAttr(this);
      var rowHtml = "";
      var controlHtml = _renderEditInputPlace(this);
      var placeholderWidth = 12 - parseInt(options.inputWidth);

      if (options.model == 'h') {
        rowHtml = '<div class="bh-row form-validate-block" {{hidden}} data-field=' + attr.name + ' >' +
          '<div class="bh-form-group bh-col-md-' + options.inputWidth + ' ' + attr.required + ' {{inputReadonly}}">' +
          '<label class="bh-form-label bh-form-h-label bh-pull-left" title="' + attr.caption + '">' + attr.caption + '</label>' +
          '<div class="bh-ph-8" style="margin-left: 115px;" emap-role="input-wrap">' +
          // controlHtml +
          '</div>' +
          '</div>' +
          '<div class="bh-form-group bh-col-md-' + placeholderWidth + ' bh-color-caption bh-form-placeholder">' + attr.placeholder + '</div>' +
          '</div>';
      } else if (options.model == 'v') {
        rowHtml = '<div class="bh-row form-validate-block" {{hidden}} data-field=' + attr.name + '>' +
          '<div class="bh-form-group bh-col-md-12 ' + attr.required + ' {{inputReadonly}}" style="padding: 0 4px 0 12px;">' +
          '<label class="bh-form-label  ">' + attr.caption + '</label>' +
          '<div class="bh-form-vertical-input-wrap" emap-role="input-wrap">' +
          // controlHtml +
          '</div>' +
          '</div>' +
          '<div class="bh-form-group bh-col-md-12 bh-color-caption bh-form-placeholder">' + attr.placeholder + '</div>' +
          '</div>';
      }
      rowHtml = rowHtml.replace(/\{\{hidden\}\}/g, (attr.hidden ? 'style="display: none;" hidden=true' : ''))
      rowHtml = $(rowHtml);
      $('[emap-role="input-wrap"]', rowHtml).append(controlHtml);

      form.append(rowHtml);

      // 垂直可编辑表单的 开关 控件改为 左右布局
      if (options.model == 'v' && attr.xtype == 'switcher') {
        $('.bh-form-group', rowHtml).addClass('bh-form-vertical-switcher');
      }

      if (form.attr('bh-role-form-outline') != "hidden") {
        form.attr('bh-role-form-outline', 'container');
      }
    });
  };


  _renderReadonlyInputPlace = function(ele, options) {
    var itemHtml = '';
    var attr = _getAttr(ele);
    attr.xtype = attr.xtype || 'static';
    if (attr.xtype == "textarea") attr.col = options.cols;

    switch (attr.xtype) {
      case "uploadfile":
      case "uploadphoto":
      case "uploadsingleimage":
      case "uploadmuiltimage":
      case "cache-upload":
        itemHtml += '<div xtype="' + attr.xtype + '" class="bh-p-8" style="clear:none;min-height: 28px;" data-name="' + attr.name + '" data-disabled=true data-JSONParam="' + encodeURI(JSON.stringify(attr.JSONParam)) + '"></div>';
        break;
      case "textarea":
        itemHtml += '<textarea xtype="textarea" data-name="' + attr.name + '" class="bh-form-control" rows="3" maxlength="' + attr.dataSize + '" unselectable="on" readOnly  style="background: #fff;resize: none;border: none!important;box-shadow: none!important;overflow: auto;" ></textarea>';
        break;
      default:
        itemHtml += '<p data-name="' + attr.name + '" data-url="' + attr.url + '" xtype="' + attr.xtype + '" class="bh-form-static bh-ph-8"></p>';
    }

    return $(itemHtml).data('attr', attr);
  };

  _renderEditInputPlace = function(ele, showPlaceholder) {
    return WIS_EMAP_INPUT.renderPlaceHolder(ele, 'form', {
      showPlaceholder: showPlaceholder
    });
  };

  _getAttr = function(item) {
    var attr = WIS_EMAP_SERV.getAttr(item);
    if (attr.defaultValue !== undefined) {
      _defaultValues[item.get("name")] = attr.defaultValue;
    }
    return attr;
  };

  _emapFormDo = function(ids, cb) {
    if ($.isArray(ids)) {
      ids.map(function(item) {
        cb(item);
      })
    } else {
      cb(ids);
    }
  };

  // 自动计算行高
  _calcLineHeight = function(element, options) {
    // if (BH_UTILS.getCurrentLang() !== 'zh') return
    if (options.model == 't' || options.readonly == true) {
      $('.bh-form-readonly-label', element).each(function() {
        var h = $(this).height();
        var H = '30px';
        if (h > 30) {
          $(this).css({
            "line-height": "13px",
            "max-height": H,
            "margin-top": '-1px'
          });
          if (h > 35) { // 超出两行显示 ...
            $.bhCutStr({
              dom: {
                selector: $(this),
                line: 2
              }
            })
          }
        }
      });
    }
  };

  _eventBind = function(element, options) {
    var formWrap = $('[bh-form-role="bhForm"]', element);
    // 分组项 的展开收起
    formWrap.on('click', '[bh-form-role="collapseBtn"]', function() {
      var self = $(this);
      var formBlock = $(this).closest('[bh-form-role="groupContainer"]').find('.bh-form-block');
      if (self.data('collapse')) {
        formBlock.slideDown(200, function() {
          WIS_EMAP_SERV._resetPageFooter();
        });
        self.data('collapse', false).text($.i18n('bh-fm-gather'));
      } else {
        formBlock.slideUp(200, function() {
          WIS_EMAP_SERV._resetPageFooter();
        });
        self.data('collapse', true).text($.i18n('bh-fm-expand'));
      }
    });
  };

  // 表单高级联动配置转换
  function getLinkageModel(model, options) {
    return WIS_EMAP_SERV.cloneObj(model).filter(function(item) {
      var linkage = [];
      if (item.linkage && typeof item.linkage === 'string') {
        try {
          item.linkage = JSON.parse(item.linkage.replace(/\'/g, '"'))
        } catch (e) {
          console && console.error('无效的linkage参数格式，必须是对象数组或序列化的字符串')
        }
      }
      if (item.linkageBy || item['form.linkageBy']) {
        linkage.push({
          type: 'data',
          linkageBy: item['form.linkageBy'] || item.linkageBy,
          linkageName: item['form.linkageName'] || item.linkageName
        })
      }
      if (options.linkage && options.linkage[item.name]) {
        linkage = linkage.concat(options.linkage[item.name])
      }
      if (linkage.length) {
        item.linkage = linkage;
      }
      return !!item.linkage
    })
  }

  function refreshColumns(element, options) {
    if (options.readonly || options.model == 't') {
      $('.bh-form-block', element).each(function() {
        if (options.model == 't') {
          var groups = $('.bh-form-group:visible', $(this)).parent();
        } else {
          var groups = $('.bh-form-group:visible', $(this));
        }

        // 补齐重置
        groups.each(function(i) {
          groups[i].className = groups[i].className.replace(/bh\-col\-md\-\d+/g, 'bh-col-md-' + $(groups[i]).data('col') * options.colWidth);
        });


        var colCounter = 0;
        groups.each(function(i) {
          var col = $(this).data('col') * 1;
          var cols = options.cols * 1;
          // 兼容模型设置列数大于表单列数的情况，需求人： 朱忠宇  zhuhui 2017-04-28
          if (col > cols) col = cols;
          colCounter += col;
          //是否会换行
          if (colCounter >= cols) {
            //加上当前标签是否能占满整行，超出则调整上个标签宽度，使其占满一行的其余空间
            if (colCounter % cols || col >= cols) {
              //加上当前标签不能占满整行
              if (colCounter % cols) {
                var lastCol = groups.eq(i - 1).data('col') * 1;
                //上一个标签宽度小于整行时，处理上一标签宽度
                if (lastCol < cols) {
                  var newCol = cols - (colCounter - col - lastCol);
                  groups[i - 1].className = groups[i - 1].className.replace(/bh\-col\-md\-\d+/g, 'bh-col-md-' + newCol * options.colWidth);
                  colCounter = col;
                }
              }
              //当前标签是否超出一行，超出则占满整行
              if (col >= cols) {
                groups[i].className = groups[i].className.replace(/bh\-col\-md\-\d+/g, 'bh-col-md-' + cols * options.colWidth);
                colCounter = 0;
              }
            } else {
              colCounter = 0;
            }
          }
          if (i === groups.length - 1) {
            // 最后一项自动补齐
            if (colCounter % cols) {
              var newCol = cols - (colCounter - col);
              // groups.eq(i).data('col', newCol);
              groups[i].className = groups[i].className.replace(/bh\-col\-md\-\d+/g, 'bh-col-md-' + newCol * options.colWidth);
              colCounter = 0;
            }
          }
        });
      });
    }
  }

  $.fn.emapForm = function(options, params) {
    var instance;
    instance = this.data('emapform');
    if (!instance) {
      return this.each(function() {
        if (options == 'destroy') {
          return this;
        }
        return $(this).data('emapform', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params);
    return this;
  };

  /**
   * @memberof module:emapForm
   * @prop {Object} data - 表单数据模型
   * @prop {String}  [root] - emap根路径
   * @prop {Boolean} [readonly=false] - 是否只读，<b>注意readonly为true时，不能和 model=t参数同时使用</b>
   * @prop {Sring} [model=h] - 表单布局方式 可选值 'h' 水平布局  'v'' 垂直布局  't' 表格布局 ; 只在非只读表单中生效
   * @prop {Int} [cols=3] - 表单布局列数，只在只读表单和表格表单中生效，可选值  1 2 3
   * @prop {Boolean} [validate=true] - 是否开启表单校验
   * @prop {Boolean} [renderByGroup=true] - 在模型中有分组的情况下，是否按照分组进行渲染
   * @prop {Boolean} [autoColumn=true] - 只读表单和表格表单列宽是否自动补齐
   * @prop {Int} [inputWidth=6] - 水平布局表单，表单控件所占宽度 可选1-12
   * @prop {Object} [defaultOptions] - 控件默认配置参数， 是针对表单中的相同类型控件批量设置的参数，如给所有的单选下拉框统一设置开启搜索功能
    $('#form').emapForm({
       data: data,
       defaultOptions: {
         select: {
             search: true
         }
       }
    })
    若需要给单独字段设置额外配置参数，请在模型的JSONParam中实现
   * @prop {Object} [itemOptions] - 控制指定字段的参数
   * @prop {Boolean} [showCollapseBtn=false] - 分组表单是否显示 展开收起按钮
   * @prop {Boolean} [showDisableLockedIcon=false] - 表格表单 disable 项 控件右侧是否展示 小锁icon
   * @prop {Boolean} [flexLayout=false] - 只读表单和表格表单是否启用flex布局，**此选项ie9 ie10不兼容**
   * @prop {Boolean} [useNewDropdownTree=false] - 是否使用新的Ztree下拉树来替换现有的下拉树
   */
  $.fn.emapForm.defaults = {
    readonly: false, // 是否只读
    model: 'h', // 编辑表单样式  h  v
    cols: '3', // 只读表单 列数
    root: "", // emap根路径
    validate: true, // 是否开启校验
    renderByGroup: true, // 按照分组渲染表单
    autoColumn: true, // 只读表单列宽自动补齐
    inputWidth: '6', // 水平表单 表单控件所占列数  默认6  最高12
    showCollapseBtn: false, // 分组表单是否显示 展开收起按钮
    showDisableLockedIcon: false, // 表格表单 disable 项 控件右侧是否展示 小锁icon
    flexLayout: false
  };
}).call(this);
(function($) {
  var Plugin;
  var currentView = 'table';
  var gParams = {};
  var gPageNumber = null;
  var gPageSize = null;

  /**
   * @module emapgrid
   * @alias grid列表
   * @description grid列表, jiyu emapCard和emapdatatable 封装，提供了可以自由切换列表和卡片展示形式的功能
   */
  Plugin = (function() {

    function Plugin(element, options) {
      resetGlobalVar();
      //将插件的默认参数及用户定义的参数合并到一个新的obj里
      this.settings = $.extend({}, $.fn.emapGrid.defaults, options);
      //将dom jquery对象赋值给插件，方便后续调用
      this.$element = $(element);
      init(this.settings, this.$element);
    }

    return Plugin;

  })();

  Plugin.prototype = {
    /**
     * @method reload
     * @description 刷新grid数据
     * @param {Object} params - 附带参数
     * @param {Boolean} gotoFirstPage 设置为true跳转第一页
     */
    reload: function(params, callback) {
      gParams = params || gParams;
      if (callback === true) {
        gPageNumber = 0;
      }
      switchGrid(currentView, this.settings, this.$element, params);
    },

    /**
     * @method getTable
     * @description 获取grid中的table dom元素
     * 获取到table的dom后可以调用emapdatatable的方法
     */
    getTable: function() {
      return this.$element.find('.bh-grid-table');
    },

    /**
     * @method getTable
     * @description 获取grid中的card dom元素
     * 获取到card的dom后可以调用emapcard的方法
     */
    getCard: function() {
      return this.$element.find('.bh-grid-card');
    },

    /**
     * @method getType
     * @description 获取当前的类型 list or card
     */
    getType: function() {
      return currentView;
    },

    renderTable: function(behind) {
      renderTable(this.settings, this.$element, behind);
    },

    renderCard: function() {
      renderCard(this.settings, this.$element);
    }
  };

  function resetGlobalVar() {
    currentView = 'table';
    gParams = {};
    gPageNumber = null;
    gPageSize = null;
  }

  function init(settings, $element) {
    layout($element);
    if (settings.showCustomColumnSetting === false || settings.schema === false) {
      $element.find('.bh-switch-setting').remove();
    } else {
      settings.schema = true;
      settings.contextPath = settings.contextPath || window.contextPath;
    }
    switchGrid(settings.type, settings, $element);
    bindEvent(settings, $element);
  }

  function setSwitchButtonStyle(type, $element) {
    $('.bh-switch-item').removeClass('bh-active');
    if (type == 'list' || type == 'table') {
      $element.find('.bh-switch-list').addClass('bh-active');
    } else if (type == 'card') {
      $element.find('.bh-switch-card').addClass('bh-active');
    }
    if (type == 'card') {
      $element.find('.bh-switch-setting').hide();
    } else if (type == 'list') {
      $element.find('.bh-switch-setting').show();
    }
  }

  function bindEvent(settings, $element) {
    $element.find('.bh-switch-item').click(function(event) {
      var type = $(event.currentTarget).attr('data-x-type');
      if (type == 'setting') {
        $element.find('.bh-grid-table').emapdatatable('selectToShowColumns', {
          dialogOpt: settings.customColumnDialogOpt,
          columnsReorder: settings.columnsReorder
        });
        return;
      }


      switchGrid(type, settings, $element);
      settings.gridAfterSwitch && settings.gridAfterSwitch(type);
    });
    $element.find('.bh-grid-table').on('pageSizeChanged', function(event) {
      var args = event.args;
      gPageNumber = args.pagenum;
      gPageSize = args.pageSize;
    });

    $element.find('.bh-grid-table').on('pageChanged', function(event) {
      var args = event.args;
      gPageNumber = args.pagenum;
      gPageSize = args.pageSize;
    });
  }

  function switchGrid(type, settings, $element, callback) {
    currentView = type;
    setSwitchButtonStyle(type, $element);
    if (type == 'list' || type == 'table') {
      if ($element.find('.bh-grid-table').prop('rendered')) {
        $element.find('.bh-grid-table').jqxDataTable({
          pageSize: gPageSize || settings.pageSize || 12
        });
        $element.find('.bh-grid-table').emapdatatable(true).source.data = $.extend({}, settings.params, gParams);

        if (!$element.find('.bh-grid-table').jqxDataTable('goToPage', gPageNumber || 0)) {
          $element.find('.bh-grid-table').jqxDataTable('updateBoundData');
        }
        //$element.find('.bh-grid-table').emapdatatable('reload', gParams);

      } else {
        renderTable(settings, $element);
      }
      $element.find('.bh-grid-table').show();
      $element.find('.bh-grid-card').hide();
      settings.afterCardRender && settings.afterCardRender();
    } else if (type == 'card') {
      gParams.pageSize = gPageSize;
      gParams.pageNumber = gPageNumber === 0 ? gPageNumber + '' : gPageNumber;
      if ($element.find('.bh-grid-card').prop('rendered')) {
        //qiyu 2016-8-26 卡片页面搜索时页面不跳转 RS-1316，孙仁秀
        if (gParams.pageNumber == 0) {
          $element.find('.bh-grid-card').emapCard('reloadFirstPage', gParams);
        } else {
          $element.find('.bh-grid-card').emapCard('reload', gParams);
        }
        //$element.find('.bh-grid-card').emapCard('reload', gParams);
      } else {
        renderCard(settings, $element);
      }
      $element.find('.bh-grid-table').hide();
      $element.find('.bh-grid-card').show();
    }
  }

  function layout($element) {

    var _html =
      '<div class="bh-grid-container">' +
      ' <div class="bh-switch-card-view">' +
      '   <span class="bh-switch-item bh-switch-setting" data-x-type="setting" style="margin-right: 8px;"><i class="iconfont icon-zidingyixianshilie"></i><span>' + $.i18n('bh-gd-customColumns') + '</span></span>' +
      '     <span class="bh-switch-item bh-switch-list bh-active" data-x-type="list"><i class="iconfont icon-viewlist"></i><span>' + $.i18n('bh-gd-table') + '</span></span>' +
      '     <span class="bh-switch-item bh-switch-card" data-x-type="card"><i class="iconfont icon-viewmodule"></i><span>' + $.i18n('bh-gd-card') + '</span></span>' +
      ' </div>' +
      ' <div class="bh-grid-table"></div>' +
      ' <div class="bh-grid-card"></div>' +
      '</div>';

    $element.html(_html);
  }

  function renderTable(settings, $element, behind) {
    var tableOptions = $.extend({}, settings);
    tableOptions.params = $.extend({}, tableOptions.params, gParams);
    delete tableOptions.template;
    delete tableOptions.cardAfterRender;
    delete tableOptions.gridAfterSwitch;
    delete tableOptions.cardBeforeRender;
    delete tableOptions.showCustomColumnSetting;
    delete tableOptions.customColumnDialogOpt;
    delete tableOptions.type;

    tableOptions.pageSize = settings.pageSize || gPageSize || 12;
    tableOptions.pageSizeOptions = settings.pageSizeOptions || [12, 24, 48, 96];
    $element.find('.bh-grid-table').prop('rendered', true);
    $element.find('.bh-grid-table').emapdatatable(tableOptions);
    if (!behind) {
      setSwitchButtonStyle('list', $element)
    }
  }

  function renderCard(settings, $element, behind) {
    var cardSettings = $.extend({}, settings);
    cardSettings.params = $.extend({}, cardSettings.params, gParams);
    cardSettings.pageSize = gPageSize;
    cardSettings.pageNumber = gPageNumber;
    cardSettings.pageSizeOptionsChange = function(pageSize, pageNumber) {
      gPageSize = pageSize;
      gPageNumber = pageNumber;
    }
    $element.find('.bh-grid-card').prop('rendered', true);
    $element.find('.bh-grid-card').emapCard(cardSettings);
    if (!behind) {
      setSwitchButtonStyle('card', $element)
    }
  }

  $.fn.emapGrid = function(options, params, callback) {
    var instance;
    instance = this.data('emapGrid');
    if (!instance) {
      return this.each(function() {
        return $(this).data('emapGrid', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') {
      return instance[options](params, callback);
    }
    return this;
  };

  /**
   * @memberof module:emapgrid
   * @description 其他参数参考emapdatatable
   * @prop {String} contextPath - 根路径
   * @prop {String} [type=list] - card or list
   * @prop {Int} [pageSize=12] - 每页数据条数
   * @prop {Array} [pageSizeOptions=[12, 24, 48, 96]] - 煤业数据条数下拉选项
   * @prop {Boolean} [showCustomColumnSetting=true] - 是否显示自定义列设置
   * @prop {Boolean} [schema=true] - 是否开启自定义列保存方案
   * @prop {Object} [customColumnDialogOpt] - 自定义列弹框控制参数，同BH_UTILS.bhWindow
   * @prop {Function} [cardBeforeRender] - 卡片渲染结束前的回调函数(此事件中可以在渲染前对数据做处理，入参为row)
   * @prop {Function} [cardAfterRender] - 卡片渲染结束后的回调函数
   * @prop {Function} [gridAfterSwitch] - card list 切换后执行的回调函数
   * @prop {Object} [其他参数] - 其他参数同emapdatatable
   */
  $.fn.emapGrid.defaults = {
    type: 'list',
    contextPath: null,
    pageSize: undefined,
    pageSizeOptions: [12, 24, 48, 96],
    cardBeforeRender: null,
    cardAfterRender: null,
    gridAfterSwitch: null,
    showCustomColumnSetting: true,
    customColumnDialogOpt: {},
  };
})(jQuery);
(function() {
  var Plugin, _linkSelect;

  /**
   * @module emapLinkage
   * @alias 表单联动
   * @description 联动，已集成在emapForm中使用，通过配置实现下拉之间的联动 <br>
   * 配置说明: <br>
   * 联动 应该配置在被联动的字段模型中，<br>
   * 联动字段（linkageBy）： 模型中联动字段的name
   * 条件字段（linkageName）： 数据表中联动字段的name
   * @example
   * this.$element.emapLinkage({
   *      data: linkModal
   *  });
   */
  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapLinkage.defaults, options);
      this.$element = $(element);
      _init(this.$element, this.options);
    }

    // Plugin.prototype.destroy = function () {
    //     this.options = null;
    //     $(this.$element).data('emapLinkage', false).empty();
    // };
    // Plugin.prototype.getValue = function () {
    // };
    return Plugin;
  })();


  //生成dom
  function _init(element, options) {
    $(options.data).each(function() {
      // var linkageBy = this.linkageBy || this['form.linkageBy'];
      // var linkageName = this.linkageName || this['form.linkageName'];
      // var name = this.name;
      // var orgDom = $('[data-name=' + linkageBy + ']', element);
      // orgDom.data({
      //     linkage:
      // });
      bindLinkEvent(this, element);

    });

  }

  _linkSelect = function(dom, val) {
    var source = WIS_EMAP_SERV.getCode(dom.data('url'), undefined, undefined, undefined, val);
    var type = dom.attr('xtype');
    if (type === "select" || type === "multi-select2") {
      var oldVal = WIS_EMAP_INPUT.getValue(dom, {});
      dom.jqxDropDownList('clear');
      // 添加请选择项
      if (source && type === "select") {
        source.splice(0, 0, {
          id: '',
          name: $.i18n('bh-la-pleaseChoose'),
          uid: ''
        });
      }
      dom.data('loaded', true);

      dom.jqxDropDownList({
        source: source
      });
      if (oldVal !== '') {
        if (dom.jqxDropDownList('getItemByValue', oldVal)) {
          dom.val(oldVal);
        }
      } else {
        if (source.length === 1) {
          // 若返回联动结果只有一项， 则默认选中该项
          if(type === "select"){
            dom.jqxDropDownList('selectIndex', 0);
          }else{
            dom.jqxDropDownList('checkIndex', 0);
          }
          dom.trigger('select')
        }
      }
    } else if (dom.attr('xtype') == 'selecttable') {
      dom.jqxDropDownList({
        source: source
      });
    }
  }

  // 联动事件绑定
  function bindLinkEvent(item_data, element) {
    var orgDom = $('[data-name=' + (item_data['form.linkageBy'] || item_data.linkageBy) + ']', element);
    var linkDom = $('[data-name=' + item_data.name + ']', element);
    if (orgDom.length === 0) {
      console && console.warn('联动项字段' + item_data.linkageBy + '未找到！')
    }
    linkEventHandle(orgDom, linkDom, item_data, element);
  }

  //  联动事件处理
  function linkEventHandle(orgDom, linkDom, item_data, element) {
    var hanlde = {
      // 数据联动
      'data': function(orgDom, linkDom, linkage_item, item_data, element) {
        var linkageBy = item_data['form.linkageBy'] || item_data.linkageBy;
        var linkageName = item_data['form.linkageName'] || item_data.linkageName;
        var name = item_data.name;
        orgDom.data({
          'emaplinkagename': linkageName,
          'emaplinkageitem': name
        });
        if (orgDom.attr('xtype') == 'select') {
          orgDom.on('select', function() {
            if ($(this).data('loaded') !== false) {
              var val = [{
                "name": $(this).data('emaplinkagename'),
                "value": $(this).val(),
                "builder": "equal",
                "linkOpt": "AND"
              }];
              _linkSelect(linkDom, JSON.stringify(val));
            }
          });
        } else if ($.inArray(orgDom.attr('xtype'), ['tree', 'multi-tree']) > -1) {
          orgDom.off('change.linkage').on('change.linkage', WIS_EMAP_SERV.debounce(function() {
            var val = [{
              "name": $(this).data('emaplinkagename'),
              "value": $(this).emapDropdownTree('getValue'),
              "builder": "equal",
              "linkOpt": "AND"
            }];
            // var val = $(this).val();
            _linkSelect(linkDom, JSON.stringify(val));
          }, 300));
        } else if ($.inArray(orgDom.attr('xtype'), ['tree2', 'multi-tree2']) > -1) {
          orgDom.on('change', function() {
            var val = [{
              "name": $(this).data('emaplinkagename'),
              "value": WIS_EMAP_INPUT.getValue($(this), {}),
              "builder": "equal",
              "linkOpt": "AND"
            }];
            // var val = $(this).val();
            _linkSelect(linkDom, JSON.stringify(val));
          });
        }
      },
      // 类型联动
      'type': function(orgDom, linkDom, linkage_item, item_data, element) {
        var link = linkage_item.link;
        if (!link.length) {
          return;
        }
        var orgDomVal = WIS_EMAP_INPUT.getValue(orgDom, {});
        linkDom = $('[data-name="' + item_data.name + '"]', element);
        for (var i = 0; i < link.length; i++) {
          if (!new RegExp('(\\w+)?@\\S+$', 'g').test(link[i])) {
            return console && console.error('联动配置' + link[i] + '有误！');
          }
          var arr = link[i].split('@');
          if (orgDomVal == arr[0]) {
            item_data.xtype = arr[1];
            var new_field = WIS_EMAP_INPUT.renderPlaceHolder(item_data);
            linkDom.parent()[0].appendChild(new_field[0])
            linkDom.parent()[0].removeChild(linkDom[0]);
            WIS_EMAP_INPUT.init(new_field);
          }
        }
      }
    }
    item_data.linkage.map(function(linkage_item) {
      // 传参 orgDom-联动项dom  linkDom-被联动项dom linkage_item-当前联动项 item_data-当前模型项 element-实例容器
      hanlde[linkage_item.type](orgDom, linkDom, linkage_item, WIS_EMAP_SERV.cloneObj(item_data), element);
    });
  }

  $.fn.emapLinkage = function(options, params) {
    var instance;
    instance = $(this).data('emapLinkage');
    if (!instance) {
      return this.each(function() {
        if (options == 'destroy') {
          return this;
        }
        return $(this).data('emapLinkage', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params);
    return this;
  };

  /**
   * @memberof module:emapLinkage
   * @param {Object} data - 数据模型
   */
  $.fn.emapLinkage.defaults = {
    data: undefined
  };

}).call(undefined);
(function ($) {
    /**
     * @module emapPDFViewer
     * @alias PDF文件预览
     * @description pdf文件预览,只能在emap环境下使用
     * @prop {Object} options - 配置参数
     * @prop {String} [options.contextPath] - 根路径
     * @prop {String} [options.url] - pdf文件路径
     * @example
     * $.emapPDFViewer({
     *  url: 'xxxxxxxxx'
     * })
     */
    $.emapPDFViewer = function (options) {
        if (!options.contextPath) {
            options.contextPath =  WIS_EMAP_SERV.getContextPath();
        }
        window.open( options.contextPath + '/sys/emapcomponent/pdf/index.do?file=' + options.url);
    };
})(jQuery);
/***
 * 废弃
 */
(function () {
    var Plugin,
        _render;  //插件的私有方法
    Plugin = (function () {
        function Plugin(element, options) {
            //将插件的默认参数及用户定义的参数合并到一个新的obj里
            this.settings = $.extend({}, $.fn.emapRepeater.defaults, options);
            //将dom jquery对象赋值给插件，方便后续调用
            this.$element = $(element);
            _render(this.$element, this.settings);
        }
        Plugin.prototype.getValue = function () {
            var returnValue = [];
            $(this.$element).find(".repeateritem").each(function(){
                var v = $(this).data("value");
                if(v !== undefined)
                  returnValue.push($(this).data("value"));
            });
            this.$element.val(returnValue);
        };

        Plugin.prototype.setValue = function (valueArray) {
            //this.$element.val(valueArray);
            $(this.$element).find(".repeateritem").each(function(){
                //var v = $(this).data("value");
                $(this).trigger("setValue", [valueArray]);
            });

        };

        return Plugin;

    })();

    _render = function (element, options) {
        var $element = element;
        var source =
        {
            datatype: "json",
            root:"datas>code>rows",
            datafields: [
                { name: 'id' },
                { name: 'name' }
            ],
            id: 'id',
            url: options.url,
            data: options.params
        };
        var dataAdapter = new $.jqx.dataAdapter(source, {
            loadComplete: function () {
                var records = dataAdapter.records;
                for (var i = 0; i < records.length; i++) {
                    var item = records[i];
                    var itemDOM = $("<div class='repeateritem'></div>");
                    if(options.align == "horizontal")itemDOM.css({"float":"left"});
                    options.render(itemDOM, item);
                    $element.append(itemDOM);
                }
            }
        });
        dataAdapter.dataBind();
    };

    $.fn.emapRepeater = function (options, params) {
        var instance;
        instance = this.data('emapRepeater');
        if (!instance) {
            return this.each(function () {
                return $(this).data('emapRepeater', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') instance[options](params);
        return this;
    };

    $.fn.emapRepeater.defaults = {
        align: "vertical",
        itemWidth: '50%'
    };
}).call(this);

(function() {
  var Plugin;
  var _defaultValues = [];
  /**
   * @module emapRulesConstructor
   * @alias 条件构造器
   * @description 条件构造器
   * @example
   *   $container.emapAdvancedQuery({
          data: searchData
      });
  $container.on('search', function(e, data, opts){
    // data 为序列化的搜索条件
    console.log(data);
  });
   */
  $.fn.emapRulesConstructor = function(options, params) {
    var instance;
    instance = this.data('plugin');
    if (!instance) {
      return this.each(function() {
        return $(this).data('plugin', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params);
    return this;
  };
  $.fn.emapRulesConstructor.eventBind = function(options, element) {
    var $advanced = options.$advanced;
    // var $advancedModal = options.$advancedModal;

    // 展开高级搜索
    $advanced.on("click", "[bh-advanced-query-role=advancedOpen]", function() {
      $($advanced).addClass('bh-active');
      options.searchModel = 'advanced';
    });

    // 关闭高级搜索
    $advanced.on("click", "[bh-advanced-query-role=advancedClose]", function() {
      $($advanced).removeClass('bh-active');
      options.searchModel = 'easy';
    });

    // easy搜索 监听 按键输入
    $advanced.on('keyup', '.bh-advancedQuery-quick-search-wrap input[type=text]', function(e) {
      var easySelectH = $advanced.data('easyarray').length * 28 + 1; // 下拉框高度
      var easySelectW = $(this).outerWidth(); // 下拉框宽度
      var searchValue = $(this).val();
      var pos = $(this).offset();
      var selectDiv = $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']');
      pos.top += 28;

      // 回车快速搜索
      if (e.keyCode == 13) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
        element.trigger('search', [options.core.getSearchCondition(options), options]);
        return;
      }

      if (searchValue == '') {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
      } else {
        $('.bh-advancedQuery-easy-query', selectDiv).html(searchValue);
        selectDiv.css({
          'height': easySelectH + 'px',
          'width': easySelectW + 'px',
          'border-width': '1px',
          'top': pos.top,
          'left': pos.left
        });
      }
    });

    //  点击下拉框选项
    $('[bh-advanced-query-role=advancedEasySelect][data-guid=' + options.guid + ']').on('click', 'p', function() {
      var selectDiv = $(this).closest('[bh-advanced-query-role=advancedEasySelect]');
      if (selectDiv.height() > 0) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
      }
      element.trigger('search', [options.core.getSearchCondition(options, $(this).data('name')), options]);
    });

    // 点击搜索按钮  easy search
    $advanced.on('click', '[bh-advanced-query-role=easySearchBtn]', function() {
      element.trigger('search', [options.core.getSearchCondition(options), options]);
    });

    // 点击筛选条件  quick search
    $advanced.on('click', '[bh-advanced-query-role=quickSearchForm] .bh-label-radio', function() {
      // radio 的事件冒泡问题
      setTimeout(function() {
        element.trigger('search', [options.core.getSearchCondition(options), options]);
      }, 200);
    });

    // 执行高级搜索
    $advanced.on('click', '[bh-advanced-query-role=advancedSearchBtn]', function() {
      element.trigger('search', [options.core.getSearchCondition(options), options]);
    });

    // 监听 控件初始化事件  bhInputInitComplete, 根据计数器options._initCounter 判断出发高级搜索组件的 初始化回调
    element.on('bhInputInitComplete', function() {
      options._initCounter++;
      if (options._initCounter == options._initCount) {
        element.trigger('init', [options]);
        options.initComplete && options.initComplete();
      }
    });

    // easySearch 下拉框的关闭
    $(document).on('click', function(e) {
      var target = e.target;
      if ($(target).closest('[bh-advanced-query-role=advancedEasySelect]').length == 0) {
        var selectDiv = $('.bh-advancedQuery-quick-select');
        // if (selectDiv.height() > 0) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
        // }
      }
    });

    // 点击 新增且条件 按钮
    $advanced.on('click', '[rules-role=addAndBtn]', function() {
      var row = $(this).closest('.bh-rules-row');
      options.core.popOver(options, $.i18n('bh-rc-addAndConditions'), $(this), function(e, ele) {
        var editorData = options.core.getConditionFromEditor(ele, options);
        if (editorData) {
          options.core.addAndFilter(options, editorData, row);
        } else {
          return false;
        }

      });
    });

    // 点击新增或条件按钮
    $advanced.on('click', '[rules-role=addOrBtn]', function() {
      options.core.popOver(options, $.i18n('bh-rc-addOrConditions'), $(this), function(e, ele) {
        var editorData = options.core.getConditionFromEditor(ele, options);
        if (editorData) {
          options.core.addOrFilter(options, editorData);
        } else {
          return false;
        }
      });
    });

    // 页面初始editor 的确定按钮
    $advanced.on('click', '.bh-rules-body > .bh-rules-editor [rules-role=editorAddBtn]', function() {
      var editorData = options.core.getConditionFromEditor($(this).closest('.bh-rules-editor'), options);
      if (editorData) {
        options.core.addOrFilter(options, editorData);
        $('.bh-rules-block', $advanced).show();
        $('.bh-rules-body > .bh-rules-editor', $advanced).hide();
      }
    });
    // 页面初始editor 的关闭按钮  点击后清空editor
    $advanced.on('click', '.bh-rules-body > .bh-rules-editor [rules-role=editorCloseBtn]', function() {
      var editor = $(this).closest('.bh-rules-editor');
      $('[rules-role^=editorInput]', editor).each(function(i) {
        if (i == 2) {
          WIS_EMAP_INPUT.setValue($(this), $(this).attr('data-name'), $(this).attr('xtype'), "", '');
          // switch ($(this).attr('xtype')) {
          //     case 'select':
          //         $(this).jqxDropDownList("clearSelection");
          //         break;
          //     case 'multi-select2':
          //         $(this).jqxDropDownList('uncheckAll');
          //         break;
          //     default:
          //         $(this).val("");
          // }
        } else {
          $(this).jqxDropDownList("clearSelection");
        }
      });
      var input3 = $('.bh-rules-input-wrap3 [xtype]', editor);
      WIS_EMAP_INPUT.setValue(input3, input3.attr('data-name'), input3.attr('xtype'), "", '');
    });

    // tag点击删除
    $advanced.on('click', '[rules-role=closeTag]', function() {
      var tag = $(this).parent();
      var andSPan = tag.prev('.bh-rules-and-text');
      if (andSPan.length > 0) {
        //删除tag
        andSPan.remove();
        tag.remove();
      } else {
        var row = tag.closest('.bh-rules-row');
        if ($('.bh-tag', row).length > 1) {
          tag.next('.bh-rules-and-text').remove();
          tag.remove();
        } else {
          // 该行只剩一个tag  所以删除整行
          row.remove();
          options.core.resetRowIndent(options);
        }
      }
      $.bhPaperPileDialog.resetPageFooter();
      $.bhPaperPileDialog.resetDialogFooter();
    });

    //编辑 tag
    $advanced.on('click', '[rules-role=tagTxt]', function(e) {
      var $trigger = $(e.currentTarget);
      var $tag = $trigger.closest('.bh-tag');

      var data = $tag.data('data');

      _defaultValues = [data.name, data.builder, data.value, data.value_display];
      //回写CALLBACK
      var callback = function(e, editor) {
        var data = options.core.getConditionFromEditor(editor, options);
        if (!data) {
          return false;
        }
        $tag.data('data', data);
        var content = '"' + data.caption + '" ' + data.builder_display + ' "' + (data.value_display ? data.value_display : data.value) + '"';
        var text = content.substring(0, 175);
        if (content.length > 175) {
          text += '...';
        }
        $('span', $tag).text(text);
        return true;
      };
      //弹出气泡弹窗
      options.core.popOver(options, '<p style="white-space: nowrap;text-overflow: ellipsis;max-width: 100%;overflow: hidden;">' + $.i18n('bh-rc-edit') + ': ' + $trigger.text() + '</p>', $tag, callback);
    });

    // 保存为方案
    $advanced.on('click', '[bh-advanced-query-role="saveSchema"]', function() {
      $(this).closest('.bh-schema-btn-wrap').addClass('active');
    });

    // 点击取消保存方案
    $advanced.on('click', '[bh-advanced-query-role=saveSchemaCancel]', function() {
      options.core.closeSchema(options);
    });

    // 点击确认保存搜索方案
    $advanced.on('click', '[bh-advanced-query-role=saveSchemaConfirm]', function() {
      var name = $('.bh-schema-name-input', $advanced).val();
      var conditionData = options.core.getSearchCondition(options, undefined, false);
      var fixed = $('[bh-schema-role=fixCheckbox]', $advanced).prop('checked') ? 1 : 0;
      var programContainer = $('.bh-rules-program', $advanced);
      element.emapSchema('saveSchema', [name, conditionData, fixed]).done(function() {
        options.core.closeSchema(options);
        var schInfo = options.schemaList.filter(function(val) {
          return val.SCHEMA_NAME == name;
        });
        // 判断是否有重名的方案  如果有  直接覆盖
        if (schInfo.length) {
          // 重名方案
          options.schemaList.filter(function(val) {
            if (val.SCHEMA_NAME == name) {
              val.CONTENT = conditionData;
              val.FIXED = fixed;
            }
          });
        } else {
          schInfo = {
            "CONTENT": conditionData,
            "SCHEMA_NAME": name,
            "FIXED": fixed
          };
          options.schemaList.push(schInfo);
        }

        if (fixed == 1) {
          var sch = $('<a  data-name="' + name + '" href="javascript:void(0)">' + name + '</a>');
          sch.data('info', schInfo);
          $('.bh-rules-program [bh-schema-role=more]', element).before(sch);
        } else {
          var sch = $('.bh-rules-program', element).find('a[data-name=' + name + ']');
          if (sch.length) {
            sch.remove();
          }
        }
        programContainer.show();

      }).fail(function(res) {
        console && console.log(res)
      });
    });

    // 点击快速方案
    $advanced.on('click', '.bh-rules-program a:not([bh-schema-role=more])', function() {
      var condition = $(this).data('info');
      element.emapRulesConstructor('setValue', condition.CONTENT);
      element.trigger('search', [JSON.stringify(WIS_EMAP_INPUT.filterCondition(condition.CONTENT)), options]);
    });

    // 点击方案的 更多按钮 呼出方案列表侧边弹窗
    $advanced.on('click', '[bh-schema-role=more]', function() {
      if (!$('main > article aside').length) {
        $('main > article').append('<aside></aside>');
      }
      $.bhPropertyDialog.show({
        "content": '<h3>' + $.i18n('bh-rc-setConditionSchema') + '</h3>' +
          '<section>' +
          '<div id="schemaDialog" style="display: none;">' +
          '<p class="bh-color-caption">' + $.i18n('bh-rc-setSchemaTop') + '</p>' +
          '<ul class="bh-schema-list" bh-schema-role="fixedUl">' +
          // '<li>' +
          // '<a class="bh-pull-right">删除</a>' +
          // '<a class="bh-pull-right">取消置顶</a>' +
          // '固定的条件构造方案' +
          // '</li>' +
          // '<li>' +
          // '<a class="bh-pull-right">删除</a>' +
          // '<a class="bh-pull-right">取消置顶</a>' +
          // '固定的条件构造方案' +
          // '</li>' +
          '</ul>' +
          '<p class="bh-color-caption">' + $.i18n('bh-rc-otherSchema') + '(<span>4</span>)</p>' +
          '<ul class="bh-schema-list" bh-schema-role="unFixedUl"></ul>' +
          '</div>' +
          '</section>', //侧边栏的内容html
        "footer": '', //侧边栏的页脚按钮
        ready: function() { //初始化完成后的处理
          var fixedUl = $('[bh-schema-role=fixedUl]');
          var unFixedUl = $('[bh-schema-role=unFixedUl]');
          $(options.schemaList).each(function() {
            var liHtml;
            liHtml = $('<li data-name="' + this.SCHEMA_NAME + '">' +
              '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="delete">' + $.i18n('bh-rc-delete') + '</a>' +
              '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="unfixed">' + $.i18n('bh-rc-cancelTop') + '</a>' +
              '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="fixed">' + $.i18n('bh-rc-setTop') + '</a>' +
              this.SCHEMA_NAME +
              '</li>').data('info', this);
            if (this.FIXED == 1) {
              fixedUl.append(liHtml);
            } else {
              unFixedUl.append(liHtml);
            }
            options.core.refreshUnfixNum(unFixedUl);
          });
          if (!options.schemaList.length) {
            $('#schemaDialog').length && $('#schemaDialog').hide();
          } else {
            $('#schemaDialog').length && $('#schemaDialog').show();
          }
          options.core.schemaDialogEventBind(element, options);
        }
      });
    });
  };
  // 更新未置顶的方案个数
  $.fn.emapRulesConstructor.refreshUnfixNum = function(ul) {
    var count = $('li', ul).length;
    ul.prev('p').find('span').html(count);
    if (count == 0) {
      ul.hide().prev('p').hide();
    } else {
      ul.show().prev('p').show();
    }

    var fixedUl = $(ul).siblings('[bh-schema-role=fixedUl]');
    if ($('li', fixedUl).length == 0) {
      fixedUl.hide().prev('p').hide();
    } else {
      fixedUl.show().prev('p').show();
    }
  };
  // 初始化方案
  $.fn.emapRulesConstructor.initSchema = function(element, options) {
    options = $.extend(options, {
      schemaType: "aq"
    });
    $.fn.emapSchema && $(element).emapSchema(options);
    options.core.renderFixedSchema(element, options);
  };
  // 关闭构造方案
  $.fn.emapRulesConstructor.closeSchema = function(options) {
    var wrap = $('.bh-schema-btn-wrap', options.$advanced);
    wrap.removeClass('active');
    $('.bh-schema-name-input', wrap).val('');
    $('[bh-schema-role=fixCheckbox]', wrap).prop('checked', false);
  };
  // 方案侧边弹窗事件绑定
  $.fn.emapRulesConstructor.schemaDialogEventBind = function(element, options) {
    var dialog = $('#schemaDialog');
    // 删除
    dialog.on('click', '[bh-schema-role=delete]', function(e) {
      e.stopPropagation();
      var li = $(this).parent();
      var name = li.data('info').SCHEMA_NAME;
      if (element.emapSchema('deleteSchema', name)) {
        li.remove();
        $('.bh-rules-program', element).find('[data-name="' + name + '"]').remove();
        $(options.schemaList).each(function(i) {
          if (this.SCHEMA_NAME == name) {
            options.schemaList.splice(i, 1);
          }
        });
        options.core.refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));
      }
    });

    // 点击选择方案
    dialog.on('click', 'li', function(event) {
      var condition = $(this).data('info');
      element.emapAdvancedQuery('setValue', condition.CONTENT);
      element.trigger('search', [JSON.stringify(WIS_EMAP_INPUT.filterCondition(condition.CONTENT)), options, event]);
      $.bhPropertyDialog.hide();
    });

    // 置顶
    dialog.on('click', '[bh-schema-role=fixed]', function(e) {
      e.stopPropagation();
      var li = $(this).closest('li');
      var info = li.data('info');
      var name = info.SCHEMA_NAME;
      var conditionData = info.CONTENT;
      element.emapSchema('saveSchema', [name, conditionData, 1]).done(function() {
        options.core.closeSchema(options);
        var infoData = {
          "CONTENT": conditionData,
          "SCHEMA_NAME": name,
          "FIXED": 1
        }
        options.schemaList.filter(function(val) {
          return val.SCHEMA_NAME == name;
        })[0].FIXED = 1;
        $('[bh-schema-role=fixedUl]', dialog).append(li);
        var sch = $('<a  data-name="' + name + '" href="javascript:void(0)">' + name + '</a>');
        sch.data('info', infoData);
        $('.bh-rules-program [bh-schema-role=more]', element).before(sch);
        options.core.refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));
      }).fail(function(res) {
        console && console.log(res);
      });
    });
    // 取消置顶
    dialog.on('click', '[bh-schema-role=unfixed]', function(e) {
      e.stopPropagation();
      var li = $(this).closest('li');
      var info = li.data('info');
      var name = info.SCHEMA_NAME;
      var conditionData = info.CONTENT;
      element.emapSchema('saveSchema', [name, conditionData, 0]).done(function() {
        options.core.closeSchema(options);
        options.schemaList.filter(function(val) {
          return val.SCHEMA_NAME == name;
        })[0].FIXED = 0;
        $('[bh-schema-role=unFixedUl]', dialog).append(li);
        $('.bh-rules-program', element).find('[data-name="' + name + '"]').remove();
        options.core.refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));

      }).fail(function(res) {
        console && console.log(res);
      });
    });
  };
  // 渲染固定的搜索方案
  $.fn.emapRulesConstructor.renderFixedSchema = function(element, options) {
    options.schemaList = element.emapSchema('getSchemaList');
    options.schemaList = options.schemaList ? options.schemaList : [];
    var $advanced = options.$advanced;
    var programContainer = $('.bh-rules-program', $advanced);


    if (options.schemaList.length > 0) {
      var fixedSchema = options.schemaList.filter(function(val) {
        return val.FIXED == 1;
      });
      if (!fixedSchema.length) {
        programContainer.html('<label>' + $.i18n('bh-rc-makeSchema') + ': </label><a bh-schema-role="more" href="javascript:void(0)">' + $.i18n('bh-rc-more') + ' ></a>');
      } else {
        $(fixedSchema).each(function() {
          var sch = $('<a  data-name="' + this.SCHEMA_NAME + '" href="javascript:void(0)">' + this.SCHEMA_NAME + '</a>');
          sch.data('info', this);
          $('[bh-schema-role=more]', programContainer).before(sch);
        });
        programContainer.show();
      }
    } else {
      programContainer.hide();
    }
  };
  $.fn.emapRulesConstructor.renderEasySearch = function(easyArray, options) {
    var easySearch = '';
    var easySearchPlaceholder = ''; // easySearch 文本框placeholder

    if (easyArray.length && easyArray.length > 0) {
      easySearchPlaceholder += $.i18n('bh-rc-pleaseInput');
      $(easyArray).each(function() {
        easySearchPlaceholder += this.caption + '/';
        easySearch += '<p data-name="' + this.name + '">' + $.i18n('bh-rc-search') + ' <span class="bh-advancedQuery-easy-caption">' + this.caption + '</span> : <span class="bh-advancedQuery-easy-query"></span></p>';
      });
      $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']').html(easySearch);
      easySearchPlaceholder = easySearchPlaceholder.substring(0, easySearchPlaceholder.length - 1);
      $('.bh-advancedQuery-quick-search-wrap input[type=text]', options.$advanced).attr('placeholder', easySearchPlaceholder);
    } else {
      $('.bh-advancedQuery-quick-search-wrap', options.$advanced).hide();
      $('[bh-advanced-query-role=easySearchBtn]', options.$advanced).hide();
    }
  };
  $.fn.emapRulesConstructor.renderQuickSearch = function(quickArray) {
    var quickSearchHtml = $('<div></div>');
    $(quickArray).each(function(i) {
      /**
       * 代码不做 数量显示
       * 由设计规范控制
       */
      //if (i >= 3) {
      //    return false;
      //}
      if (this.xtype == 'select' || this.xtype == 'radiolist' || this.xtype == 'checkboxlist') {
        this.xtype = 'buttonlist';
      }
      quickSearchHtml.append($.fn.emapRulesConstructor.renderInputPlace(this));
    });
    return quickSearchHtml;
  };
  $.fn.emapRulesConstructor.renderInputPlace = function(item, showClose) {
    //showClose  是否显示 关闭按钮
    /*
    var _this = item;
    _this.get = function (attr) {
        return _this[attr];
    };
    var xtype = _this.get("xtype");
    var caption = _this.get("caption");
    var builder = _this.get("defaultBuilder");
    var url = _this.get("url");
    var name = _this.get("name");
    var hidden = _this.get("hidden") ? "hidden" : "";
    var placeholder = _this.get("placeholder") ? _this.get("placeholder") : "";
    var checkType = _this.get("checkType");
    var checkSize = _this.get("checkSize");
    var dataSize = _this.get("dataSize");
    var checkExp = _this.get("checkExp");
    //var allOption = _this.get("allOption") !== undefined ? _this.get("allOption") : true; // 是否显示 "全部"  按钮,  仅在 buttonlist使用
    var format = _this.get("format") ? _this.get("format") : 'yyyy-MM-dd';
    var controlHtml = $(' <div class="bh-advancedQuery-form-row bh-advancedQuery-h-28">' +
        '<div class="bh-advancedQuery-groupName">' + caption + '：</div>' +
        '<div class="bh-advancedQuery-groupList bh-label-radio-group">' +
        '</div>' +
        '</div>');

    if (showClose) {
        controlHtml.append('<a class="bh-bh-advancedQuery-group-dismiss" href="javascript:void(0)" bh-advanced-query-role="conditionDismiss"> ' +
            '<i class="icon-close iconfont"></i>' +
            '</a>');
    }
    var inputHtml = '';
    switch (xtype) {

        case "tree":
        case "multi-tree":
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" data-url="{{url}}" {{hidden}} style="max-width: 300px;"></div>';
            break;
        case "date-local":
        case "date-range":
            inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="{{format}}" {{hidden}} style="max-width: 300px;"></div>';
            break;
        case "date-ym":
            inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="yyyy-MM" {{hidden}}></div>';
            break;
        case "date-full":
            inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="yyyy-MM-dd HH:mm" {{hidden}}></div>';
            break;
        case "switcher":
            inputHtml += '<div xtype="{{xtype}}"  data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" {{hidden}}></div>';
            break;
        case "radiolist":
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-radio" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
            break;
        case "checkboxlist":
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-checkbox" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
            break;
        case "buttonlist":
        case "multi-buttonlist":
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} ></div>';
            break;
        case "select":
        case "multi-select":
        case "multi-select2":
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
            break;
        case 'number':
        case 'number-range':
            inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
            break;
        default:
            inputHtml += '<input class="bh-form-control" data-name="{{name}}" name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" xtype="text" type="text" {{hidden}} />';
            break;
    }
    inputHtml = inputHtml.replace(/\{\{xtype\}\}/g, xtype)
        .replace(/\{\{name\}\}/g, name)
        .replace(/\{\{builder\}\}/g, builder)
        .replace(/\{\{caption\}\}/g, caption)
        .replace(/\{\{url\}\}/g, url)
        .replace(/\{\{hidden\}\}/g, (hidden ? 'style="display:none;"' : ''))
        .replace(/\{\{allOption\}\}/g, options.allowAllOption)
    */
    var controlHtml = $(' <div class="bh-advancedQuery-form-row bh-advancedQuery-h-28">' +
      '<div class="bh-advancedQuery-groupName">' + item.caption + '：</div>' +
      '<div class="bh-advancedQuery-groupList bh-label-radio-group">' +
      '</div>' +
      '</div>');

    if (showClose) {
      controlHtml.append('<a class="bh-bh-advancedQuery-group-dismiss" href="javascript:void(0)" bh-advanced-query-role="conditionDismiss"> ' +
        '<i class="icon-close iconfont"></i>' +
        '</a>');
    }
    var inputHtml = WIS_EMAP_INPUT.renderPlaceHolder(item, 'search');

    $('.bh-advancedQuery-groupList', controlHtml).html(inputHtml);
    return controlHtml;
  };
  // 生成搜索条件
  $.fn.emapRulesConstructor.getSearchCondition = function(options, name, filter) {
    var conditionResult = [];
    var easyArray = options.$advanced.data('easyarray');
    var modalarray = options.$advanced.data('modalarray');
    var orCondition = [];
    var isFilter = filter === false ? false : true;
    if (options.searchModel == 'easy') {
      var searchKey = $('.bh-advancedQuery-quick-search-wrap input', options.$advanced).val();
      // 简单搜索
      if ($.trim(searchKey) != "") {
        if (name) {
          //简单搜索的下拉框搜索
          var searchItem = options.core.findModel(name, easyArray);
          conditionResult.push({
            "caption": searchItem.caption,
            "name": searchItem.name,
            "value": searchKey,
            "builder": searchItem.defaultBuilder || "include",
            "linkOpt": "AND"
          });
        } else {
          for (var i = 0; i < easyArray.length; i++) {
            orCondition.push({
              "caption": easyArray[i].caption,
              "name": easyArray[i].name,
              "value": searchKey,
              "builder": easyArray[i].defaultBuilder || "include",
              "linkOpt": "OR"
            });
          }
          conditionResult.push(orCondition);
        }
      }
      conditionResult = conditionResult.concat(options.core.getConditionFromForm($('[bh-advanced-query-role=quickSearchForm]', options.$advanced), options));
    } else if (options.searchModel == 'advanced') {
      var block = $('.bh-rules-block', options.$advanced);
      $('.bh-rules-row', block).each(function() {
        var rowData = [];
        var tags = $('.bh-tag', $(this));
        if (tags.length) {
          tags.each(function() {
            var tagData = $(this).data('data');
            tagData.linkOpt = 'and';
            rowData.push(tagData);
          });
          rowData[0].linkOpt = 'or';
          conditionResult.push(rowData);
        }
      });
    }
    if (isFilter) {
      conditionResult = WIS_EMAP_INPUT.filterCondition(conditionResult);
    }
    return JSON.stringify(conditionResult);
  };
  $.fn.emapRulesConstructor.getConditionFromForm = function(form, options) {
    var model = options.$advanced.data('modalarray');
    var conditionArray = [];
    var formElement = $('[xtype]', form);
    for (var i = 0; i < formElement.length; i++) {
      var conditionItem = {};
      conditionItem.value = WIS_EMAP_INPUT.getValue($(formElement[i]), {});
      /*
      switch ($(formElement[i]).attr('xtype')) {
          case 'radiolist':
              conditionItem.value = $('input[type=radio]:checked', formElement[i]).map(function () {
                  return $(this).val();
              }).get().join(',');
              break;
          case 'checkboxlist':
              conditionItem.value = $('input[type=checkbox]:checked', formElement[i]).map(function () {
                  return $(this).val();
              }).get().join(',');
              break;
          case 'tree':
              conditionItem.value = $(formElement[i]).emapDropdownTree('getValue');
              break;
          case 'buttonlist':
              conditionItem.value = $('.bh-label-radio.bh-active', formElement[i]).data('id');
              break;
          default:
              conditionItem.value = $(formElement[i]).val();
              break;
      }
      */
      if (conditionItem.value == 'ALL' || $.trim(conditionItem.value) == '') {
        continue;
      }
      conditionItem.name = $(formElement[i]).data('name');
      conditionItem.caption = $(formElement[i]).data('caption');
      conditionItem.builder = $(formElement[i]).data('builder');
      conditionItem.linkOpt = 'AND';
      conditionArray.push(conditionItem);
    }
    return conditionArray;
  };
  $.fn.emapRulesConstructor.findModel = function(name, modelArray) {
    for (var i = 0; i < modelArray.length; i++) {
      if (modelArray[i].name == name) {
        return modelArray[i];
      }
    }
  };
  $.fn.emapRulesConstructor.initSelect1 = function(ele, modalOptions) {
      ele.jqxDropDownList({
        placeHolder: $.i18n('bh-rc-chooseFindingTasks'),
        width: 200,
        source: modalOptions,
        displayMember: "caption",
        filterable: true,
        searchMode: "containsignorecase",
        filterPlaceHolder: $.i18n('bh-rc-pleaseFind'),
        valueMember: "name"
      }).on('open', function(e) {
        var _this = $(this);
        var $filterInput = _this.jqxDropDownList('listBoxContainer').jqxListBox('filter');
        $filterInput.css('position', 'relative');
        if (!$filterInput.find('[role="bh-placeholder-wrap"]').length) {
          WIS_EMAP_INPUT.placeHolder($filterInput);
        }
      });
      ele.data('instance', ele);
      ele._value = function(val) {
        if (val !== undefined) {
          ele.val(val);
        } else {
          var result = ele.jqxDropDownList('getSelectedItem');
          return result || {};
        }
      }
    }
    // 初始化构造器编辑框
  $.fn.emapRulesConstructor.initConstructorEditor = function(options, ele) {
    // 字段名称下拉
    var modalOptions = options.$advanced.data('modalarray');
    // builder下拉
    var builderOptions = options.data.builderLists.cbl_String;

    var select1 = $('[rules-role=editorInput1]', ele)
    options.core.initSelect1(select1, modalOptions);

    var select2 = $('[rules-role=editorInput2]', ele)
      .jqxDropDownList({
        placeHolder: $.i18n('bh-rc-chooseConditions'),
        width: 100,
        source: builderOptions,
        filterable: true,
        searchMode: "containsignorecase",
        displayMember: "caption",
        filterPlaceHolder: $.i18n('bh-rc-pleaseFind'),
        valueMember: "name"
      }).on('open', function() {
        var _this = $(this);
        var $filterInput = _this.jqxDropDownList('listBoxContainer').jqxListBox('filter');
        $filterInput.css('position', 'relative');
        if (!$filterInput.find('[role="bh-placeholder-wrap"]').length) {
          WIS_EMAP_INPUT.placeHolder($filterInput);
        }
      })
    var select3 = undefined;

    if (_defaultValues[0]) { //select1 有 值，则
      select1.data('instance')._value(_defaultValues[0]);

      var input3Wrap = $('.bh-rules-input-wrap3', ele);
      var modalItem = options.data.controls.filter(function(item) {
        return item.name == _defaultValues[0];
      })[0];

      // 条件选择下拉框的联动
      select2.jqxDropDownList({
        source: options.data.builderLists[modalItem.builderList]
      })
      select2.val(_defaultValues[1])

      // 搜索value 的控件联动
      var html3 = options.core.renderInput3Place(modalItem);
      input3Wrap.html(html3);
      if (_defaultValues.length && $.inArray(_defaultValues[1], ['m_value_include', 'm_value_equal', 'm_value_not_include', 'm_value_not_equal']) > -1) {
        if (html3.attr('xtype') === 'tree') {
          html3.attr('xtype', 'multi-tree');
        }
        if (html3.attr('xtype') === 'tree2') {
          html3.attr('xtype', 'multi-tree2');
        }
        if (html3.attr('xtype') === 'select') {
          html3.attr('xtype', 'multi-select2');
        }
      }
      var defaultOptions = $.extend({}, {
        "date-range": {
          defaultType: 'all'
        },
        tree: {
          unblind: "/"
        },
        tree2: {
          unblind: "/"
        },
        "multi-tree": {
          unblind: "/",
          search: true
        },
        "multi-tree2": {
          unblind: "/",
          search: true
        }
      }, options.defaultOptions);
      input3Wrap.emapFormInputInit({
        defaultOptions: defaultOptions,
        showBlankOption: options.showBlankOption
      });
      select3 = $('[xtype]', input3Wrap)
      select3.attr('rules-role', 'editorInput3');
      var fieldVal = {}
      var name = select3.data('name')
      fieldVal[name + '_DISPLAY'] = _defaultValues[3]
      fieldVal[name] = _defaultValues[2]
      WIS_EMAP_INPUT.setValue(select3, name, select3.attr('xtype'), fieldVal)
    }

    options.core.bindEditorEvent(options, ele);
    // 兼容ie9 placeholder
    WIS_EMAP_INPUT.placeHolder(ele);
    _defaultValues = [] //reset
  };
  // 弹出气泡弹窗
  $.fn.emapRulesConstructor.popOver = function(options, title, ele, cb) {
    $.bhPopOver({
        width: 728,
        isModal: true,
        title: '<p class="emap-rules-popover-title bh-str-cut">' + title + '</p>',
        content: options.editorHtml,
        selector: ele,
        ready: function(win) {
          // 实例化editor
          options.core.initConstructorEditor(options, $('#bhPopover'));
          setTimeout(function() { // 自动打开
            var popWindow = win;
            popWindow.on('close', function() { // 气泡弹窗关闭时 自动销毁
                // 取消 对下拉框事件冒泡的阻止
                $(document).off('click.bhRules.stop')
                  // 销毁editor内的下拉框
                $('div[rules-role=editorInput1],div[rules-role=editorInput2],div[rules-role=editorInput3]', popWindow).jqxDropDownList('destroy');
                // 销毁popover
                $(this).jqxPopover('destroy');
              })
              .on('click', '[rules-role=editorCloseBtn]', function() {
                // 关闭气泡弹窗事件
                popWindow.jqxPopover('close')
              })
              .on('click', '[rules-role=editorAddBtn]', function(e) {
                if (cb(e, popWindow) !== false) {
                  popWindow.jqxPopover('close');
                }
              });

            // 阻止下拉框的事件冒泡  防止点击下拉后 poppver 自动关闭
            $(document).on('click.bhRules.stop', '.jqx-listbox, .jqx-calendar, .jqx-dropdownbutton-popup', function(e) {
              e.stopPropagation();
            })

          }, 0)
        }
      })
      /*
      var pop = $('<div style="display: none" id="bhPopover">' + options.editorHtml + '</div>');
      $('body').append(pop);

      // 计算popover 水平位置
      var docWidth = document.documentElement.clientWidth;
      var selectLeft = $(ele).offset().left;
      var popWidth = 728; // popover的宽度为 728 ,我量出来的
      var offsetLeft = 0;
      if (selectLeft - popWidth / 2 < 24) {
          offsetLeft = Math.abs(selectLeft - popWidth / 2 - 24)
      }
      if (selectLeft + popWidth / 2 > docWidth - 24) {
          offsetLeft = docWidth - 100 - selectLeft - popWidth / 2;
      }

      // 计算垂直位置
      var eleTop = $(ele).offset().top;
      var position = 'bottom';
      if (window.scrollY + document.documentElement.clientHeight - eleTop < 200) {
          position = 'top';
      }

      pop.jqxPopover({
          offset: {
              left: offsetLeft,
              top: 0
          },
          arrowOffsetValue: -offsetLeft,
          showArrow: false,
          autoClose: true,
          isModal: true,
          title: title,
          selector: ele,
          position: position
      });
      */

  };
  $.fn.emapRulesConstructor.getConditionFromEditor = function(editor, options) {
    if (options.core.validateEditor(editor)) {
      var select1Val = $('[rules-role=editorInput1]', editor).data('instance')._value();
      var select2Val = $('[rules-role=editorInput2]', editor).jqxDropDownList('getSelectedItem');
      var select3 = $('.bh-rules-input-wrap3 [xtype]', editor);
      var conData = {
        caption: select1Val.label,
        name: select1Val.value,
        builder: select2Val.value,
        builder_display: select2Val.label
      };
      var select3_value_obj = {};
      conData.value = WIS_EMAP_INPUT.getValue(select3, select3_value_obj);
      conData.value_display = select3_value_obj[select3.attr('data-name') + '_DISPLAY'];
      // 选择空值时，构造器仅支持 等于 不等于 包含 三个
      if (conData.value === '@__blank__value') {
        if ($.inArray(conData.builder, ['include', 'equal', 'notEqual']) < 0) {
          $.bhTip({
            content: $.i18n('bh-rc-onlyHave'),
            state: 'warning'
          });
          return false;
        }
      }
      return conData;
    }
    return false;
  };
  $.fn.emapRulesConstructor.validateEditor = function(editor) {
    var select1 = $('[rules-role=editorInput1]', editor);
    var select2 = $('[rules-role=editorInput2]', editor);
    var input3Wrap = $('.bh-rules-input-wrap3', editor);

    if (!select1.data('instance')._value().value) {
      select1.addClass('bh-error');
      return false
    }
    if (!select2.val()) {
      select2.addClass('bh-error');
      return false
    }
    var select3 = $('[xtype]', input3Wrap);
    if (select3.hasClass('bh-error')) {
      return false
    }
    var select3_val = WIS_EMAP_INPUT.getValue(select3, {})
    if (WIS_I18N.i18n.locale === 'zh') {
      if (select3_val === '' || select3_val === undefined || select3_val === '请选择...') {
        select3.addClass('bh-error');
        return false;
      }
    } else {
      if (select3_val === '' || select3_val === undefined || select3_val === 'Please choose...') {
        select3.addClass('bh-error');
        return false;
      }
    }
    return true;
  };
  // editor内下拉框联动事件绑定
  $.fn.emapRulesConstructor.bindEditorEvent = function(options, editor) {
    var select1 = $('[rules-role=editorInput1]', editor);
    var select2 = $('[rules-role=editorInput2]', editor);
    var select3 = undefined;
    var input3Wrap = $('.bh-rules-input-wrap3', editor);
    var select3 = $('[xtype]', input3Wrap);
    select1.on('select', function(e, detail) {
      var name;
      if (e.args) {
        name = e.args.item.value;
      } else if (detail) {
        name = detail;
      }
      var modalItem = options.data.controls.filter(function(item) {
        return item.name == name;
      })[0];

      if (select1.data('instance')._value().value) {
        select1.removeClass('bh-error');
      }

      // 条件选择下拉框的联动
      select2.jqxDropDownList({
        source: options.data.builderLists[modalItem.builderList]
      })
      if ($.inArray(modalItem.xtype, ['multi-select2', 'select', 'multi-tree', 'tree', 'multi-tree2', 'tree2']) > -1) {
        // select2.jqxDropDownList('getItemByValue', 'm_value_equal');
        select2.val('m_value_equal');
        setTimeout(function() {
          select2.trigger('select');
        }, 10)
      } else if ($.inArray(modalItem.xtype, ['text', undefined]) > -1) {
        select2.val('include');
        setTimeout(function() {
          select2.trigger('select');
        }, 10)
      } else {
        select2.jqxDropDownList('selectIndex', 0);
      }
      // 搜索value 的控件联动
      var defaultOptions = $.extend({}, {
        "date-range": {
          defaultType: 'all'
        },
        tree: {
          unblind: "/",
          search: true
        },
        tree2: {
          unblind: "/",
          search: true
        },
        "multi-tree": {
          unblind: "/",
          search: true
        },
        "multi-tree2": {
          unblind: "/",
          search: true
        }
      }, options.defaultOptions);
      input3Wrap.html(options.core.renderInput3Place(modalItem)).emapFormInputInit({
        defaultOptions: defaultOptions,
        showBlankOption: options.showBlankOption
      });
      $('[xtype]', input3Wrap).attr('rules-role', 'editorInput3');

    });
    select2.on('select', WIS_EMAP_SERV.debounce(function() {
      /***
       * 联动规则：
       * 1. 单选组、多选组、按钮组变成下拉类型
       * 2. 当构造器为多值时， 下拉变为多选下拉， 下拉树变为多选下拉树
       * 3. 当构造器不为多值时， 多选下拉变为下拉，多选下拉树变为下拉树
       */
      select3 = $('[xtype]', input3Wrap);
      if (select2.val()) {
        select2.removeClass('bh-error');
      }
      var itemModel = options.data.controls.filter(function(val) {
        return val.name == select1.data('instance')._value().value;
      })[0];
      itemModel = JSON.parse(JSON.stringify(itemModel));
      itemModel.get = function(field) {
        if (this["search." + field] !== undefined)
          return this["search." + field];
        else
          return this[field];
      };
      var xtype = itemModel['search.xtype'] || itemModel['xtype']
      var defaultOptions = $.extend({}, {
        "date-range": {
          defaultType: 'all'
        },
        tree: {
          unblind: "/",
          search: true
        },
        tree2: {
          unblind: "/",
          search: true
        },
        "multi-tree": {
          unblind: "/",
          search: true
        },
        "multi-tree2": {
          unblind: "/",
          search: true
        }
      }, options.defaultOptions)

      if ($.inArray($(this).val(), ['m_value_include', 'm_value_equal', 'm_value_not_include', 'm_value_not_equal']) > -1) {
        // 构造器为多值时
        if (xtype === 'select') itemModel['search.xtype'] = 'multi-select2'
        if (xtype === 'tree') itemModel['search.xtype'] = 'multi-tree'
        if (xtype === 'tree2') itemModel['search.xtype'] = 'multi-tree2'
      } else {
        // 构造器不为多值时
        if (xtype === 'multi-select2') itemModel['search.xtype'] = 'select'
        if (xtype === 'multi-tree') itemModel['search.xtype'] = 'tree'
        if (xtype === 'multi-tree2') itemModel['search.xtype'] = 'tree2'
      }
      input3Wrap.empty();
      input3Wrap.html(options.core.renderInput3Place(itemModel)).emapFormInputInit({
        defaultOptions: defaultOptions,
        showBlankOption: options.showBlankOption
      });
    }, 200));
    input3Wrap.on('select, input, change', '[xtype]', WIS_EMAP_SERV.debounce(function() {
      var xtype = this.getAttribute('xtype')
      var value = WIS_EMAP_INPUT.getValue($(this), {})
      if (value !== '') {
        $(this).removeClass('bh-error');
        // 多选树添加最多选择1000项的显示
        if (/multi-tree/.test(xtype) && value.split(',').length > 1000) {
          $(this).addClass('bh-error')
          $.bhTip({
            content: $.i18n('bh-rc-dropdownTreeTip'),
            state: 'warning'
          });
        }
      }
    }, 200));
  };
  $.fn.emapRulesConstructor.renderInput3Place = function(modalItem) {
    return WIS_EMAP_INPUT.renderPlaceHolder(modalItem, 'search');
    /*
    var attr = WIS_EMAP_SERV.getAttr(modalItem);
    var controlHtml = "";
    attr.xtype = attr.xtype ? attr.xtype : 'text';
    if (attr.xtype == 'checkboxlist' || attr.xtype == 'radiolist') {
        attr.xtype = 'select';
    }


    switch (attr.xtype) {
        case undefined:
        case "text":
            attr.xtype = "text";
            controlHtml = '<input class="bh-form-control" data-type="{{dataType}}" data-name="{{name}}" name="{{name}}" xtype="{{xtype}}" type="{{xtype}}" {{checkType}}  {{dataSize}} {{checkSize}} {{checkExp}} ' + (attr.inputReadonly ? 'readOnly' : '') + '  />';
            break;
        case "textarea":
            controlHtml = '<textarea xtype="{{xtype}}" data-type="{{dataType}}" class="bh-form-control" rows="3" data-name="{{name}}" {{checkType}} {{dataSize}} {{checkSize}} {{checkExp}} ' + (attr.inputReadonly ? 'readOnly' : '') + ' ></textarea>';
            break;
        case "selecttable":
        case "select":
        case "tree":
        case "multi-tree":
        case "date-local":
        case "date-ym":
        case "date-full":
        case "switcher":
        case "uploadfile":
        case "uploadphoto":
        case "uploadsingleimage":
        case "uploadmuiltimage":
        case "buttonlist":
        case "multi-select":
        case "multi-select2":
        case "div":
            controlHtml = '<div xtype="{{xtype}}" data-type="{{dataType}}" data-name="{{name}}" {{url}} {{format}} {{checkType}} {{JSONParam}} {{checkSize}} data-disabled={{inputReadonly}}></div>';
            break;
        case "radiolist":
            controlHtml = '<div xtype="{{xtype}}" data-type="{{dataType}}" class="bh-radio jqx-radio-group" data-name="{{name}}" {{url}} {{checkSize}} data-disabled={{inputReadonly}}></div>';
            break;
        case "checkboxlist":
            controlHtml = '<div xtype="{{xtype}}" data-type="{{dataType}}" class="bh-checkbox" data-name="{{name}}" {{checkType}} {{url}} {{checkSize}} data-disabled={{inputReadonly}}></div>';
            break;
    }
    controlHtml = controlHtml.replace(/\{\{xtype\}\}/g, attr.xtype)
        .replace(/\{\{name\}\}/g, attr.name)
        .replace(/\{\{dataType\}\}/g, attr.dataType)
        .replace(/\{\{inputReadonly\}\}/g, attr.inputReadonly);
    controlHtml = controlHtml.replace(/\{\{url\}\}/g, attr.url ? ('data-url="' + attr.url + '"') : '');
    controlHtml = controlHtml.replace(/\{\{format\}\}/g, attr.format ? ('data-format="' + attr.format + '"') : '');
    controlHtml = controlHtml.replace(/\{\{JSONParam\}\}/g, attr.JSONParam ? ('data-jsonparam="' + encodeURI(JSON.stringify(attr.JSONParam)) + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkType\}\}/g, attr.checkType ? ('data-checktype="' + encodeURI(JSON.stringify(attr.checkType)) + '"') : '');
    controlHtml = controlHtml.replace(/\{\{dataSize\}\}/g, attr.dataSize ? ('data-size="' + attr.dataSize + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkSize\}\}/g, attr.checkSize ? ('data-checksize="' + attr.checkSize + '"') : '');
    controlHtml = controlHtml.replace(/\{\{checkExp\}\}/g, attr.checkExp ? ('data-checkexp=' + encodeURI(attr.checkExp)) : '');
    controlHtml = $(controlHtml);
    if (attr.JSONParam) {
        controlHtml.data('jsonparam', attr.JSONParam);
    }
    return controlHtml;
    */
  };
  // 渲染一个tag
  $.fn.emapRulesConstructor.renderOneTag = function(data) {
    var tag = $('<label class="bh-tag"><span class="bh-tag__txt" rules-role="tagTxt"></span><a rules-role="closeTag" href="javascript:void(0)"><i class="iconfont icon-close"></i></a></label>');
    tag.data('data', data);
    var content = '"' + data.caption + '" ' + data.builder_display + ' "' + (data.value_display ? data.value_display : data.value) + '"';
    var text = content.substring(0, 175);
    if (content.length > 175) {
      text += '...';
    }
    $('span', tag).text(text);
    tag.attr('title', content);
    return tag;
  };
  // 添加 且 条件
  $.fn.emapRulesConstructor.addAndFilter = function(options, data, row) {
    var andBtn = $('[rules-role=addAndBtn]', row);
    andBtn.before(options.andSpan).before(options.core.renderOneTag(data));
    $.bhPaperPileDialog.resetPageFooter();
    $.bhPaperPileDialog.resetDialogFooter();
  };
  // 添加或条件
  $.fn.emapRulesConstructor.addOrFilter = function(options, data) {
    var row = $('<div class="bh-rules-row">' +
      '<div class="bh-rules-row-indent">' + $.i18n('bh-rc-or') + '</div>' +
      '<a rules-role="addAndBtn" href="javascript:void(0)">' + $.i18n('bh-rc-addAndConditions') + '</a>' +
      '</div>');
    $('[rules-role=addAndBtn]', row).before(options.core.renderOneTag(data));
    $('[rules-role=addOrRow]', options.$advanced).before(row);
    options.core.resetRowIndent(options);
  };
  // 重置 row indent
  $.fn.emapRulesConstructor.resetRowIndent = function(options) {
    var $advanced = options.$advanced;
    var rows = $('.bh-rules-row', $advanced);
    rows.each(function(i) {
      if (i > 0) {
        $(this).css('margin-left', (i - 1) * 20)
      }
    })
    $.bhPaperPileDialog.resetPageFooter();
    $.bhPaperPileDialog.resetDialogFooter();
  };
  $.fn.emapRulesConstructor.init = function(element, options) {
    if (options.showBlankOption === undefined) {
      options.showBlankOption = WIS_EMAP_CONFIG.showBlankOptionInSearch;
    }
    if ($.fn.emapDropdownZTree) {
      if (options.useNewDropdownTree === undefined) {
        options.useNewDropdownTree = WIS_EMAP_CONFIG.useNewDropdownTree;
      }
    }

    if (options.useNewDropdownTree === true) {
      options.data.controls.map(function(item) {
        if (item['search.xtype']) {
          if ($.inArray(item['search.xtype'], ['tree', 'multi-tree']) > -1) {
            item['search.xtype'] = item['search.xtype'].replace(/tree$/, 'tree2')
          }
        } else {
          if ($.inArray(item['xtype'], ['tree', 'multi-tree']) > -1) {
            item['xtype'] = item['xtype'].replace(/tree$/, 'tree2')
          }
        }
      });
    }
    element.attr("emap", JSON.stringify({
      "emap-url": WIS_EMAP_SERV.url,
      "emap-name": WIS_EMAP_SERV.name,
      "emap-app-name": WIS_EMAP_SERV.appName,
      "emap-model-name": WIS_EMAP_SERV.modelName
    }));
    delete WIS_EMAP_SERV.url;
    delete WIS_EMAP_SERV.name;
    delete WIS_EMAP_SERV.appName;
    delete WIS_EMAP_SERV.modelName;

    var modalData = options.data.controls;
    var easyArray = [];
    var quickArray = [];
    var guid = BH_UTILS.NewGuid();



    options.editorHtml = '<div class="bh-rules-editor bh-clearfix bh-mb-16">' +
      '<div class="bh-rules-input-wrap"><div rules-role="editorInput1"></div></div>' +
      '<div class="bh-rules-input-wrap"><div rules-role="editorInput2"></div></div>' +
      '<div class="bh-rules-input-wrap bh-rules-input-wrap3"><input rules-role="editorInput3" class="bh-form-control" type="text" placeholder="' + $.i18n('bh-rc-multiValueSpilt') + '"></div>' +
      '<div class="bh-rules-input-wrap bh-rules-input-wrap4">' +
      '<a class="bh-btn bh-btn-small bh-btn-primary" rules-role="editorAddBtn"><i class="iconfont icon-check" style="margin-right: 0;"></i></a>' +
      '<a class="bh-btn bh-btn-small bh-btn-default" rules-role="editorCloseBtn"><i class="iconfont icon-close" style="margin-right: 0;"></i></a>' +
      '</div>' +
      '</div>';

    options.andSpan = '<span class="bh-rules-and-text">' + $.i18n('bh-rc-and') + '</span>';
    options.orSpan = '<span class="bh-rules-or-text">' + $.i18n('bh-rc-or') + '</span>';
    options.tag = '<label class="bh-tag"><span class="bh-tag__txt" rules-role="tagTxt"></span><a rules-role="closeTag" href="javascript:void(0)"><i class="iconfont icon-close"></i></a></label>';

    element.css({
      "position": "relative",
      "z-index": 358
    }).html('<div class="bh-advancedQuery bh-mb-16" bh-advanced-query-role="advancedQuery">' +
      '<div class="bh-advancedQuery-dropDown ">' +
      '<div class="" style="display: table-cell">' +
      '<div class="bh-advancedQuery-form" bh-advanced-query-role="advanceSearchForm" >' +

      '<div class="bh-rules-container">' +
      '<div class="bh-rules-header bh-clearfix">' +
      '<h4>' +
      '<i class="iconfont icon-search"></i>' + $.i18n('bh-rc-conditionDesigner') +
      '</h4>' +
      '<p class="bh-rules-program">' +
      '<label>' + $.i18n('bh-rc-makeSchema') + ': </label>' +
      '<a bh-schema-role="more" href="javascript:void(0)">' + $.i18n('bh-rc-more') + ' ></a>' +
      '</p>' +
      '</div>' +


      '<div class="bh-rules-body">' +
      options.editorHtml +

      '<div class="bh-rules-block">' +


      '<div class="bh-rules-row" rules-role="addOrRow">' +
      '<div class="bh-rules-row-indent"></div>' +
      '<a rules-role="addOrBtn" href="javascript:void(0)">' + $.i18n('bh-rc-addOrConditions') + '</a>' +

      '</div>' +

      '</div>' +
      '</div>' +

      '</div>' +


      '<div class="bh-advancedQuery-form-row bh-advancedQuery-form-btn-row bh-advancedQuery-h-28" bh-advanced-query-role="dropDownBtnWrap"> ' +
      '<div class="bh-advancedQuery-groupList">' +
      '<a class="bh-btn bh-btn-primary bh-btn-small" bh-advanced-query-role="advancedSearchBtn">' + $.i18n('bh-rc-takeConditionsSearch') + '</a>' +
      '<div class="bh-schema-btn-wrap">' +
      '<div class="bh-schema-edit-div">' +
      '<input type="text" placeholder="' + $.i18n('bh-rc-inputPlanName') + '" maxlength="20" class="bh-form-control bh-schema-name-input" />' +
      '<a  class="bh-btn bh-btn-success bh-btn-small"  bh-advanced-query-role="saveSchemaConfirm">' + $.i18n('bh-rc-save') + '</a>' +
      '<a class="bh-btn bh-btn-default bh-btn-small" bh-advanced-query-role="saveSchemaCancel">' + $.i18n('bh-rc-cancel') + '</a>' +
      '<span class="bh-checkbox" style="display:inline-block;vertical-align:middle;margin-left:8px;"><label>' +
      '<input type="checkbox" bh-schema-role="fixCheckbox"><i class="bh-choice-helper"></i> ' + $.i18n('bh-rc-fixToSearchInput') +
      '</label></span>' +
      '</div>' +
      '<a class="bh-btn bh-btn-default bh-btn-small " bh-advanced-query-role="saveSchema" href="javascript:void(0)">' + $.i18n('bh-rc-saveAsPlan') + '</a>' +
      '</div>' +
      '<a class="bh-mh-4" bh-advanced-query-role="advancedClose" href="javascript:void(0)">[' + $.i18n('bh-rc-closeConditionDesigner') + ']</a>' +
      '</div>' +
      '</div>' +
      '</div>' +

      '</div>' +
      '</div>' +
      '<div class="bh-advancedQuery-quick">' +
      '<div class="bh-advancedQuery-inputGroup bh-clearfix">' +
      '<div class="bh-advancedQuery-quick-search-wrap" >' +
      '<input type="text" class="bh-form-control"/>' +
      '<i class="iconfont icon-search" style="position: absolute;left: 6px;top: 6px;"></i>' +
      '</div>' +
      '<a class="bh-btn bh-btn bh-btn-primary bh-btn-small" bh-advanced-query-role="easySearchBtn">' + $.i18n('bh-rc-search') + '</a>' +
      '<a href="javascript:void(0);" class="bh-mh-8" bh-advanced-query-role="advancedOpen">[' + $.i18n('bh-rc-conditionDesigner') + ']</a>' +
      '</div>' +
      '<div class="bh-advancedQuery-form bh-mt-8" bh-advanced-query-role="quickSearchForm">' +
      '</div>' +
      '</div>' +
      '</div>');

    options.$advanced = $('div[bh-advanced-query-role=advancedQuery]', element).css({
      'overflow': 'hidden'
    });
    options.guid = guid;
    if (options.searchModel == 'advanced') {
      options.$advanced.addClass('bh-active');
    }

    $('body').append('<div class="bh-advancedQuery-quick-select" bh-advanced-query-role="advancedEasySelect" data-guid="' + guid + '" ></div>');
    if (options.formType) {
      element.addClass('bu-rules-form-type');
    }


    var advanceInputPlaceHolder = '';
    options.core.eventBind(options, element);
    $(modalData).each(function(i) {
      //移除 hidden 项
      var index = modalData.indexOf(this);
      if (this.get('hidden')) {
        modalData.splice(index, 1);
        return true;
      }

      if (!this.xtype || this.xtype == 'text') {
        advanceInputPlaceHolder += this.caption + '/'; // 高级搜索关键词输入框placeholder
      } else {
        options._initCount++;
      }

      if (this.quickSearch) {
        if (!this.xtype || this.xtype == 'text') {
          easyArray.push(this);
        } else {
          quickArray.push(this);
        }
      }
    });
    // 高级搜索关键词字段添加placeholder
    $('[bh-advanced-query-role=advancedInput]', element).attr('placeholder', advanceInputPlaceHolder.substr(0, advanceInputPlaceHolder.length - 1));

    options.$advanced.data('modalarray', modalData);
    options.$advanced.data('easyarray', easyArray);
    options.$advanced.data('quickarray', quickArray);

    if (options.searchModel == 'easy') {
      options._initCount = quickArray.length;
    }
    if (easyArray.length == 0 && quickArray.length == 0) {
      // console.warn("没有配置快速搜索字段,所以高级搜索控件无法展示!");
    }

    // 简单搜索 条件渲染
    options.core.renderEasySearch(easyArray, options);

    // 快速搜索条件渲染
    quickArray = JSON.parse(JSON.stringify(quickArray));
    var defaultOptions = $.extend({}, {
      "date-range": {
        defaultType: 'all'
      },
      tree: {
        unblind: "/",
        search: true
      },
      "multi-tree": {
        unblind: "/",
        search: true
      },
      tree2: {
        unblind: "/",
        search: true
      },
      "multi-tree2": {
        unblind: "/",
        search: true
      }
    }, options.defaultOptions);
    $('[bh-advanced-query-role=quickSearchForm]', options.$advanced).html(options.core.renderQuickSearch(quickArray, options))
      .emapFormInputInit({
        root: '',
        defaultOptions: defaultOptions,
        showBlankOption: options.showBlankOption
      });

    // 初始化构造器默认的 editor
    options.core.initConstructorEditor(options, $('.bh-rules-editor', element));

    // 初始化 方案 模块
    if (options.schema) {
      $.fn.emapSchema && options.core.initSchema(element, options);
    } else {
      $('.bh-rules-program, .bh-schema-btn-wrap', options.$advanced).hide();

    }
  }



  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapRulesConstructor.defaults, options);
      this.$element = $(element);
      this.$element.attr("emap-role", "advancedQuery").attr("emap-pagePath", "").attr("emap-action", this.options.data.name);
      this.options._initCount = 0; // 需要初始化的控件的总数
      this.options._initCounter = 0; // 控件初始化计数器
      this.options.core.init(this.$element, this.options);
    }

    /**
     * @method getValue
     * @description 获取组件当前的搜索条件
     * @return {String} - 序列化的emap搜索条件
     * @example
     * var condition = $dom.emapRulesConstructor('getValue');
     * console.log(condition);
     */
    Plugin.prototype.getValue = function() {
      return this.options.core.getSearchCondition(this.options);
    };

    /**
     * @method setValue
     * @description 赋值
     * @param {Object|String} val - 需要赋值的搜索条件
     * @example
     * $dom.emapRulesConstructor('setValue', [{name: 'xxx', value: 'xxx', builder: 'equal', linkOpt: 'AND'}])
     */
    Plugin.prototype.setValue = function(val) {
      this.$element.emapRulesConstructor('clear');
      var value = (typeof val == "string") ? JSON.parse(val) : val;
      var $advanced = this.options.$advanced;
      var block = $('.bh-rules-block', $advanced);
      $($advanced).addClass('bh-active');
      this.options.searchModel = 'advanced';
      $('.bh-rules-block', $advanced).show();
      $('.bh-rules-body > .bh-rules-editor', $advanced).hide();
      for (var i = 0; i < value.length; i++) {
        if ($.isArray(value[i])) {
          for (var j = 0; j < value[i].length; j++) {
            if (j == 0) {
              // 添加行
              this.options.core.addOrFilter(this.options, value[i][j]);
            } else {
              // 添加tag
              this.options.core.addAndFilter(this.options, value[i][j], $('.bh-rules-row:eq(' + i + ')', block))
            }
          }
        }
      }
    };

    /**
     * @method clear
     * @description 清空搜索
     */
    Plugin.prototype.clear = function() {
      var $advanced = this.options.$advanced;
      $('.bh-rules-row:not([rules-role=addOrRow])', $advanced).remove();
      this.options.core.resetRowIndent(this.options);
    };

    return Plugin;
  })();

  /**
   * @memberof module:emapRulesConstructor
   * @event search
   * @description 搜索触发的事件
   * @param {Object} event - 事件对象
   * @param {Stirng} conditions - 搜索条件字符串
   * @param {Object} options - 搜索组件options对象
   * @example
   * $search.on('search'. function (event, conditions) {
   *  console.log(event);
   *  console.log(conditions);
   *  $table.emapdatatable('reload', {querySetting: conditions});
   * })
   */

  /**
   * @memberof module:emapRulesConstructor
   * @prop {Obiect} data - 高级搜索模型
   * @prop {String} [searchModel=easy] - 默认展示形式 可选值： easy - 简单搜索    advanced - 条件构造器
   * @prop {Boolean} [allowAllOption=true] - 快速搜索中的单选按钮组是否显示 【全部】 选项
   * @prop {Boolean} [formType=false] - 表单中使用的模式, 开启后,隐藏简单搜索的文本框与搜索按钮,隐藏高级模式的按钮
   * @prop {Boolean} [showBlankOption=true] - 下拉和下拉树是否添加空值选项
   * @prop {Boolean} [schema=false] - 是否开启保存方案功能
   */
  $.fn.emapRulesConstructor.defaults = {
    allowAllOption: true, // 是否显示[全部]选项
    searchModel: 'easy',
    formType: false,
    schema: false,
    core: $.fn.emapRulesConstructor,
    defaultOptions: undefined
  };
}).call(this);
/***
 * 废弃
 */
'use strict';
(function () {
    var tpl = '<div class="bh-ers-j-condition"></div>' +
        '<div class="bh-ers-add bh-ph-8 bh-ers-j-add-btn">' +
        '<i class="iconfont icon-addcircle"></i>' +
        '<span>添加条件</span>' +
        '</div>';

    var Plugin;

    Plugin = (function () {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapRuleSetting.defaults, options);
            this.$element = $(element);
            _create(this.$element, this.options);
        }

        Plugin.prototype.getValue = function () {
            return getCondition(this.$element, this.options);
        };

        Plugin.prototype.setValue = function (val) {
            var value;
            var _this = this;
            $('.bh-ers-j-condition', _this.$element).empty();
            if (!val) {return}
            if (typeof val == 'string') {
                value = JSON.parse(val);
            } else {
                value = val;
            }
            if (value.length && value.length > 0) {
                $(value).each(function () {
                    addCondition(_this.$element, _this.options, this);
                });
            }
        };
        return Plugin;
    })();


    //生成dom
    function _create(element, options) {
        element.html(tpl);
        _eventListener(element, options);
    }

    //事件注册
    function _eventListener(element, options) {
        //  添加条件
        $('.bh-ers-j-add-btn', element).on('click', function () {
            addCondition(element, options);
        });

        // 删除
        element.on('click', '.bh-ers-close', function () {
            var $this = $(this);
            BH_UTILS.bhDialogWarning({
                title: '确定要删除该条件吗？',
                buttons: [{
                    text: '确定', className: 'bh-btn-warning',
                    callback: function callback() {
                        $this.parent().remove();
                    }
                }, {text: '取消', className: 'bh-btn-default'}]
            });
        });

        // select change
        element.on('change', '.bh-ers-select .bh-ers-nice-select', function () {
            var row = $(this).closest('.bh-ers-row');
            var model = options.data.controls;
            var value = $(this).val();
            var selectedModel = model.filter(function (item) {
                return item.name == value;
            })[0];
            renderRow(options, selectedModel, row);
        });
    }

    // 添加一个搜索条件
    function addCondition(element, options, value) {
        var row = $('<div class="bh-clearfix bh-ers-row" ></div>');
        var selectModel = options.data.controls;
        row.append('<div class="' + (options.showBuilder ? 'bh-ers-col-3' : 'bh-ers-col-2') + '"><div class="bh-ers-select"></div></div>');
        if (options.showBuilder) {
            row.append('<div class="bh-ers-col-3"><div class="bh-ers-builder"></div></div>');
        }
        row.append('<div class="' + (options.showBuilder ? 'bh-ers-col-3' : 'bh-ers-col-2') + '"><div class="bh-ers-option"></div></div>');
        row.append('<i class="iconfont icon-close bh-ers-close"></i>');

        renderSelect({
            dom: $('.bh-ers-select', row),
            source: selectModel
        });
        $('.bh-ers-j-condition', element).append(row);
        if (value) {
            var valueModel = selectModel.filter(function (val) {
                return val.name == value.name;
            })[0];
            $('.bh-ers-select select', row).val(value.name);
            renderRow(options, valueModel, row);
        } else {
            renderRow(options, selectModel[0], row);
        }
        if (value) {
            $('.bh-ers-builder select', row).val(value.builder);
            $('.bh-ers-option select, .bh-ers-option input', row).val(value.value);
        }
    }

    // 渲染 字段下拉框
    function renderSelect(opt) {
        var select = $('<select class="bh-ers-nice-select"></select>');
        $(opt.source).each(function () {
            select.append('<option value="' + this.name + '">' + this.caption + '</option>');
        });
        opt.dom.html(select);
        opt.dom.append('<i class="iconfont icon-arrowdropdown bh-ers-nice-select-arrow"></i>');
    }

    // 渲染赋值下拉框
    function renderOptionSelect(opt) {
        var select = $('<select class="bh-ers-nice-select"></select>');
        $(opt.source).each(function () {
            select.append('<option value="' + this.id + '">' + this.name + '</option>');
        });
        opt.dom.html(select);
        opt.dom.append('<i class="iconfont icon-arrowdropdown bh-ers-nice-select-arrow"></i>');
    }

    function renderRow(options, model, dom) {
        var builderList = model.builderList;

        renderSelect({
            dom: $('.bh-ers-builder', dom),
            source: options.data.builderLists[builderList]
        });


        switch (model.xtype) {
            case 'select' :
            case 'radiolist' :
            case 'checkboxlist' :
                _getItemModel(model.url, function (data) {
                    renderOptionSelect({
                        dom: $('.bh-ers-option', dom),
                        source: data
                    });
                });
                break;
            case 'date-local':
            case 'date-ym':
            case 'date-full':
                $('.bh-ers-option', dom).empty().append('<div class="bh-ers-control"></div>');
                $('.bh-ers-option div', dom).jqxDateTimeInput({
                    width: "100%",
                    value: null,
                    formatString: 'yyyy-MM-dd',
                    culture: 'zh-CN'
                });
                break;
            default :
                $('.bh-ers-option', dom).html('<input class="bh-form-control bh-ers-control" type="text">')
        }
    }

    function _getItemModel(url, callback) {
        //qiyu 2016-11-19 将获取mock的url提取函数，在mock文件中重新定义
        var source = {
            url: url,
            datatype: "json",
            async: false,
            root: "datas>code>rows"
        };
        if (typeof window.MOCK_CONFIG != 'undefined') {
            source = getSourceMock(source);
        }
        var dataAdapter = new $.jqx.dataAdapter(source, {
            loadComplete: function (records) {
                callback(records.datas.code.rows);
            }
        });
        dataAdapter.dataBind();
    };

    function getCondition(element, options) {
        var result = [];
        $('.bh-ers-row', element).each(function () {
            var _this = $(this);
            var optionValue;
            if ($('.bh-ers-option .bh-ers-control', _this).length == 0) {
                optionValue = $('.bh-ers-option .bh-ers-nice-select', _this).val();
            } else {
                optionValue = $('.bh-ers-option .bh-ers-control', _this).val();
            }
            if (!optionValue || $.trim(optionValue) == "") {
                return true;
            }
            var resultItem = {
                "name": $('.bh-ers-select .bh-ers-nice-select', _this).val(),
                "value": optionValue,
                "linkOpt": "AND"
            };
            if ($('.bh-ers-builder .bh-ers-nice-select', _this).length > 0) {
                resultItem.builder = $('.bh-ers-builder .bh-ers-nice-select', _this).val();
            } else {
                resultItem.builder = $('bh-.ers-control', _this).val();
            }

            result.push(resultItem);
        });
        return JSON.stringify(result);
    }


    $.fn.emapRuleSetting = function (options, params) {
        var instance;
        instance = this.data('emapRuleSetting');
        if (!instance) {
            return this.each(function () {
                return $(this).data('emapRuleSetting', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](params);
        return this;
    };

    $.fn.emapRuleSetting.defaults = {
        showBuilder: true,
        builderData: [{
            name: "等于",
            id: "equal"
        }]
    };
}).call(undefined);
(function() {
    var Plugin, _eventBind, _closeEdit, _getPageFlag;
    /**
     * @module emapSchema
     * @alias 方案模块
     * @description 方案保存模块，对接了emap的保存方案功能，已集成在各搜索组件和表格组件中，也可单独使用<br>
     *
     */
    Plugin = (function() {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.emapSchema.defaults, options);
            this.$element = $(element);
            _init(this.$element, this.options);
        }

        /**
         * @method destroy
         * @description 销毁
         */
        Plugin.prototype.destroy = function() {
            this.options = null;
            $(this.$element).data('emapSchema', false).empty();
        };

        /**
         * @method saveSchema
         * @description 保存方案
         * @param {Array} param - 数组项分别为 0 - 方案名称   1 - 方案内容(String)  2 - 是否固定(可选)
         * @example
         * $dom.emapSchema('saveSchema', ['name', [{name: 'xxx', value: 'xxx', builder: 'equal', linkOpt: 'AND'}], 1])
         */
        Plugin.prototype.saveSchema = function() {
            var result = $.Deferred();
            var name = arguments[0][0];
            var conditionData = arguments[0][1];
            var fixed = arguments[0][2] ? 1 : 0;
            var options = this.options;
            var element = this.$element;
            if (!name) {
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-sm-inputSchemaName'),
                    state: 'warning',
                    iconClass: 'icon-erroroutline'
                });
                result.reject($.i18n('bh-sm-schemaNameIsNull'));
                return result.promise();
            }
            doRequest(options.contextPath + '/sys/emapcomponent/schema/save.do', {
                condition: conditionData,
                schemaName: name,
                schemaType: options.schemaType,
                pageFlag: options.pageFlag,
                fixed: fixed
            }).done(function(res) {
                if (res.success) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-sm-successSave'),
                        state: 'success',
                        iconClass: 'icon-check'
                    });


                }
                result.resolve(res);
            }).fail(function(res) {
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-sm-failSave'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
                result.reject(res);
            });
            return result.promise();
        };

        /**
         * @method getSchemaList
         * @description  获取方案列表
         * @returns {*}
         */
        Plugin.prototype.getSchemaList = function() {
            var options = this.options;
            var pageFlag = this.options.pageFlag;
            var schemaType = this.options.schemaType;
            var result;
            $.ajax({
                type: 'post',
                url: options.contextPath + '/sys/emapcomponent/schema/getList.do',
                async: false,
                data: {
                    schemaType: schemaType,
                    pageFlag: pageFlag
                }
            }).done(function(res) {
                if (res.success) {
                    result = res.data;
                }
            });
            return result;
        };


        /**
         * @method deleteSchema
         * @description 删除方案
         * @param {String} name - 方案名
         * @example
         * $dom.emapSchema('deleteSchema', 'name');
         */
        Plugin.prototype.deleteSchema = function(name) {
            var options = this.options;
            var result = false;
            $.ajax({
                type: 'post',
                url: options.contextPath + '/sys/emapcomponent/schema/deleteSingle.do',
                async: false,
                data: {
                    schemaName: name,
                    schemaType: options.schemaType,
                    pageFlag: options.pageFlag
                }
            }).done(function(res) {
                if (res.success) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-sm-successDelete'),
                        state: 'success',
                        iconClass: 'icon-check'
                    });
                    result = true;
                }
            });
            return result;
        };
        return Plugin;
    })();


    //生成dom
    function _init(element, options) {
        // if (options.pageFlag && options.pageFlag != null) {
        //     // 已有方案
        //     options.newFlag = false;
        // } else {
        //     // 新上传
        //     options.pageFlag = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
        //     options.newToken = true;
        // }
        options.contextPath = options.contextPath || WIS_EMAP_SERV.getContextPath();
        _getPageFlag(options);
        _eventBind(element, options);

    }

    _getPageFlag = function(options) {
        var pageName = location.hash.replace(/\/|#/g, '');
        var modelName = options.data.modelName || options.customModelName;
        options.pageFlag = pageName + ',' + modelName;
    };

    _eventBind = function(element, options) {};

    _closeEdit = function(element, options) {
        var wrap = $('.bh-schema-btn-wrap', element);
        $('.bh-schema-name-input', wrap).val();
        wrap.removeClass('active');
    };


    $.fn.emapSchema = function(options, params) {
        var instance;
        instance = $(this).data('emapSchema');
        if (!instance) {
            return this.each(function() {
                if (options == 'destroy') {
                    return this;
                }
                return $(this).data('emapSchema', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](params);
        return this;
    };

    $.fn.emapSchema.defaults = {

    };

    function doRequest(url, param) {
        var result = $.Deferred();
        $.ajax({
                type: 'post',
                data: param,
                url: url,
                dataType: 'json'
            })
            .done(function(res) {
                result.resolve(res)
            }).fail(function(res) {
                result.reject(res);
            });
        return result.promise();
    }

}).call(undefined);
/**
 * @fileOverview EMAP条件筛选组件
 * @example
 $('#container').emapFilterQuery({
            contextPath: "/emap"
        })
 */
(function () {
  var Plugin;
  /**
   * @module emapFilterQuery
   * @alias 条件搜索
   * @fires search - 搜索事件
   * @example
   $('#container').emapFilterQuery({
          contextPath: "/emap"
      })
   */
  Plugin = (function () {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapFilterQuery.defaults, options);
      this.$element = $(element);
      _init(this.$element, this.options);

    }

    /**
     * @method setValue
     * @description 赋值
     * @param {String|Array} val - 搜索条件
     */
    Plugin.prototype.setValue = function (val) {
      var filter_block = this.options.filter_block;
      if (typeof val == 'string') {
        try {
          val = JSON.parse(val);
        } catch (e) {
          console && console.error('filterQuery setValue 传入参数有误');
        }

      }
      if (val.length) {
        var form_date = {};
        val.map(function (item) {
          if (item instanceof Array) {
            // common filter 关键字字段
            form_date['_commonFilter'] = item[0].value;
          } else {
            form_date[item.name] = item.value;
          }
        });
        WIS_EMAP_INPUT.formSetValue(filter_block, form_date, {});
      } else {
        console && console.error('filterQuery setValue 传入参数不能为空');
      }
    };

    /**
     * 取值
     * @method getValue
     * @returns {String} 格式化的搜索条件
     * @example
     $("#container").emapFilterQuery('getValue');
     */
    Plugin.prototype.getValue = function () {
      return JSON.stringify(_getSearchConditions(this.options));
    };

    /**
     * 清空
     * @method clear
     */
    Plugin.prototype.clear = function () {
      _clear(this.$element, this.options);
    };

    /**
     * @method destroy
     * @description 销毁
     * @returns {*}
     */
    Plugin.prototype.destroy = function () {
      return this.$element.removeClass('emap-FQ-container').empty().data('emapfilterquery', undefined);
    };

    return Plugin;
  })();

  function _init(element, options) {
    if (options.showBlankOption === undefined) {
      options.showBlankOption = WIS_EMAP_CONFIG.showBlankOptionInSearch;
    }
    options.model = options.data.controls.map(function (item) {
      if (item['search.hidden'] === true || item['search.hidden'] === false) {
        item['hidden'] = item['search.hidden'];
      }
      return item;
    });

    if (options.beforeRender) {
      options.model = options.beforeRender(options.model);
    }

    element.addClass('emap-FQ-container').append(
      '<div class="emap-FQ-filters bh-clearfix" emap-role="FQ-filters" style="display: none;"></div>' +
      '<div class="emap-FQ-footer" emap-role="FQ-footer">' +
      '<div class="bh-clearfix emap-FQ-footer-top">' +
      '<h4 class="bh-pull-left emap-FQ-title bh-ph-16" >'+ $.i18n('bh_fq_conditionFilter') +'</h4>' +
      '<a href="javascript:void(0)" class="bh-pull-right bh-ph-16" emap-role="FQ-switch-btn__expand">'+ $.i18n('bh_fq_expend') +'  ></a>' +
      '<p class="emap-FQ-text-wrap" emap-role="FQ-text-wrap">' +
      '<span class="emap-FQ-text" emap-role="FQ-text"></span>' +
      '<a href="javascript:void(0)" emap-role="FQ-clear-btn" class="emap-FQ-clear-btn">'+ $.i18n('bh_fq_clearCondition') +'</a>' +
      '</p>' +
      '</div>' +
      '<div class="emap-FQ-footer-bottom bh-text-center">' +
      '<a class="bh-btn bh-btn-primary" emap-role="FQ-search-btn">'+ $.i18n('bh_fq_search') +'</a>' +
      '<p class="emap-FQ-footer-btn-wrap bh-ph-16">' +
      '<a href="javascript:void(0)" emap-role="FQ-clear-btn" style="width: 120px;">'+ $.i18n('bh_fq_clearCondition') +'</a> | ' +
      '<a emap-role="FQ-more" href="javascript:void(0)" class="bh-mr-16">'+ $.i18n('bh_fq_moreCondition') +'</a>' +
      '<a href="javascript:void(0)" emap-role="FQ-switch-btn__collapse">'+ $.i18n('bh_fq_collapse') +'  ></a>' +
      '</p>' +
      '</div>' +
      '</div>'
    );

    options.filter_block = $('[emap-role="FQ-filters"]', element);

    // 初始化时 ,只显示quickSearch 的字段
    // 现关键字字段 匹配 所有快速搜索的文本字段，若文本字段 配置了快速搜索且隐藏，则不再初始化的表单中展示
    var quick_array = [];
    options.model.map(function (item) {
      var attr = WIS_EMAP_SERV.getAttr(item, 'search');
      quick_array.push({
        name: item.name,
        hidden: !(item.quickSearch && !attr.hidden)
      });
    });

    if (options.expanded) {
      element.addClass('emap-expand');
      options.filter_block.show();
    }
    _renderFilterForm(quick_array, options);

    _eventBind(element, options);
  }

  // 渲染filter 表单
  function _renderFilterForm(nameArray, options) {
    var form_array = [];
    var cur_names = options.filter_block.data('names');
    var is_new_form = cur_names ? true : false;
    if (!is_new_form) {
      cur_names = options.model.map(function (item) {
        item.hidden = true;
        return item;
      });
      var quick_text_field = options.model.filter(function (item) {
        var attr = WIS_EMAP_SERV.getAttr(item);
        return attr.xtype == 'text' && attr.quickSearch == true;
      });
      options.quick_text_field = quick_text_field;
      if (quick_text_field.length > 0) {
        form_array.push(_renderFilterFormItem({
          name: '_commonFilter',
          caption: '关键字',
          get: function (field) {
            if (this["search." + field] !== undefined)
              return this["search." + field];
            else
              return this[field];
          }
        }));
      } else {
        console && console.warn('条件搜索组件数据模型中未配置快速搜素的文本字段，所以关键词字段未显示！');
      }
    }

    nameArray.map(function (nameItem, i) {
      var name_hidden = nameItem['hidden'];
      var model_item = cur_names.filter(function (item) {
        return item.name == nameItem.name;
      })[0];
      if (name_hidden !== model_item['hidden']) {
        if (name_hidden) {
          // 需要移除的字段
          $('[data-field=' + nameItem.name + ']', options.filter_block).remove();
        } else {
          // 需要添加的字段
          form_array.push(_renderFilterFormItem(options.model[i]));
        }
      }
    });

    options.filter_block.data('names', nameArray).append(form_array);
    var defaultOptions = $.extend({}, {
      "date-range": {
        defaultType: 'all'
      },
      "tree2": {
        unblind: '/',
        search: true
      },
      "multi-tree2": {
        unblind: '/',
        search: true
      },
      "number-range": {
        width: 154
      }
    }, options.defaultOptions);
    form_array.map(function (item) {
      WIS_EMAP_INPUT.init(item, {
        defaultOptions: defaultOptions,
        showBlankOption: options.showBlankOption
      });
    });
    // 添加 关键词字段的placeholder
    if (!is_new_form) {
      var common_filters = $('input[data-name="_commonFilter"]', options.filter_block);
      if (common_filters.length) {
        var pText = quick_text_field.map(function (item) {
          return item.caption;
        }).join('/')
        common_filters.attr('placeholder', pText).attr('title', pText);
        WIS_EMAP_INPUT.placeHolder(common_filters);
      }
    }

    // 添加字段后重置页脚
    WIS_EMAP_SERV._resetPageFooter();
  }

  // 构造表单项的html
  function _renderFilterFormItem(item) {
    var model_item = _adaptModelItem(_cloneObj(item));
    var item_html = '';
    var attr = WIS_EMAP_SERV.getAttr(model_item);
    item_html += '<div class="emap-FQ-filter-group bh-mb-8 ' + (isDoubleWidth(attr.xtype) ? 'double' : '') + '" data-field="' + attr.name + '">' +
      '<div class="emap-FQ-label" title="' + attr.caption + '">' + attr.caption + '</div>' +
      '<div class="emap-FQ-input-warp"   emap-role="input-wrap">' +
      '</div>' +
      '</div>';
    item_html = $(item_html);
    $('[emap-role="input-wrap"]', item_html).append(WIS_EMAP_INPUT.renderPlaceHolder(model_item));
    return item_html;
  }

  function isDoubleWidth(xtype) {
    return $.inArray(xtype, ['date-range']) > -1;
  }

  function _cloneObj(obj) {
    var clone = {};
    for (var k in obj) {
      if (typeof obj[k] == 'Object') {
        clone[k] = _cloneObj(obj[k]);
      } else {
        clone[k] = obj[k];
      }
    }
    return clone;
  }

  /**
   * 控件类型的强制转换
   * buttonlist => select
   * multi-buttonlist => multi-select2
   * radiolist => select
   * checkboxlist => multi-select2
   */
  function _adaptModelItem(item) {
    switch (item.xtype) {
    case 'buttonlist':
    case 'radiolist':
      item.xtype = 'select';
      break;
    case 'multi-buttonlist':
    case 'checkboxlist':
      item.xtype = 'multi-select2';
      break;
    default:
    }
    return item;
  }

  function _getSearchConditions(options) {
    var filter_block = options.filter_block;
    var filter_value = WIS_EMAP_INPUT.formGetValue(filter_block, options);
    return _convertConditions(filter_value, options.model);
  }

  // 将表单取值转换 为 搜索条件数据结构
  function _convertConditions(value_obj, model) {
    var condition = [];
    var quick_field = model.map(function (item) {
      var attr = WIS_EMAP_SERV.getAttr(item);
      if ((!attr.xtype || attr.xtype == 'text') && attr.quickSearch) {
        return attr.name;
      }
    });
    condition = WIS_EMAP_INPUT.getConvertCondition(value_obj, model);
    for (var k in value_obj) {
      if (value_obj[k] == "") continue;
      if (k == '_commonFilter') {
        // 关键字字段  匹配模型中所有的快速搜索文本字段
        var common_filters = [];
        quick_field.map(function (field, i) {
          if (field) {
            var field_data = {
              name: field,
              caption: model.filter(function (item) {
                return item.name == field
              })[0].caption,
              builder: "include",
              linkOpt: 'OR',
              value: value_obj[k]
            };
            common_filters.push(field_data);
          }
        });
        common_filters[0].linkOpt = 'AND';
        condition.push(common_filters);
      }
    }
    return _filterConditions(condition);

    /*
    for (var k in value_obj) {
        if (value_obj[k] == "") continue;
        if (k == '_commonFilter') {
            // 关键字字段  匹配模型中所有的快速搜索文本字段
            var common_filters = [];
            quick_field.map(function (field, i) {
                if (field) {
                    var field_data = {
                        name: field,
                        caption: model.filter(function (item) {
                            return item.name == field
                        })[0].caption,
                        builder: "include",
                        linkOpt: 'OR',
                        value: value_obj[k]
                    };
                    if (i == 0) field_data.linkOpt = 'AND';
                    common_filters.push(field_data);
                }
            });
            condition.push(common_filters);
        } else {
            if (/_DISPLAY$/.test(k)) continue;
            var modelItem = model.filter(function (item) {
                return item.name == k
            })[0];
            var item_filter = {
                name: k,
                caption: modelItem.caption,
                linkOpt: "AND",
                builderList: modelItem.builderList,
                builder: modelItem.defaultBuilder,
                value: value_obj[k],
                value_display: value_obj[k + '_DISPLAY'] || ""
            };
            condition.push(item_filter);
        }
    }
    return _adaptCondition(condition, model);
    */
  }

  // 搜索条件数据适配
  /*
  function _adaptCondition(condition, model) {
    var resultCondition = [];
    for (var i = 0; i < condition.length; i++) {
        resultCondition.push(condition[i]);
        var condition_item = resultCondition[i];
        if (!(condition_item instanceof Array)) {
            var model_item = model.filter(function (m_item) {
                return m_item.name == condition_item.name;
            })[0];
            var attr = WIS_EMAP_SERV.getAttr(model_item);
            // 文本类型控件包含 , 时  builder转化为多值包含
            if ((!attr.xtype || attr.xtype == 'text') && condition_item.value.indexOf(',') > 0) {
                condition_item.builder = 'm_value_include';
            }
            // 下拉多选、复选框、多选按钮组类型, builder 转化为多值相等
            else if (attr.xtype == 'multi-select2' || attr.xtype == 'checkboxlist' || attr.xtype == 'multi-buttonlist') {
                condition_item.builder = 'm_value_equal';
            }
            // 类型为date-range日期范围  num-range数字区间 时, 拆分成 两个条件
            else if (attr.xtype == 'date-range' || attr.xtype == 'number-range') {
                var date_value = condition_item.value.split(',');
                if (date_value[0] !== "") {
                    resultCondition.splice(i + 1, undefined, {
                        name: condition_item.name,
                        caption: condition_item.caption,
                        builder: 'moreEqual',
                        linkOpt: 'AND',
                        builderList: 'cbl_Other',
                        value: date_value[0]
                    });
                }
                if (date_value[1] !== "") {
                    resultCondition.splice(i, 1, {
                        name: condition_item.name,
                        caption: condition_item.caption,
                        builder: 'lessEqual',
                        linkOpt: 'AND',
                        builderList: 'cbl_Other',
                        value: date_value[1]
                    });
                }
            }
        }
    }
    return resultCondition;
  }
  */

  function _filterConditions(condition) {
    return WIS_EMAP_INPUT.filterCondition(condition);
  }

  // 根据搜索条件 渲染 搜索条件文字
  function _renderFilterText(element, conditions, builderLists) {
    var filter_text = '';
    conditions.map(function (con_item) {
      if (con_item instanceof Array) {
        // 研究生线会修改关键词label，此处不再对匹配字段进行遍历拼接，而是直接获取关键词label
        filter_text += '"' + $('[data-field="_commonFilter"] .emap-FQ-label', element).attr('title') + '"';
        filter_text += ' 包含 ';
        filter_text += '"' + con_item[0].value + '"; ';

      } else {
        filter_text += '"' + con_item.caption + '"';
        if (builderLists[con_item['builderList']]) {
          var builder_item = builderLists[con_item['builderList']].filter(function (list_item) {
            return list_item.name == con_item['builder'];
          })[0];
          if (builder_item) {
            filter_text += builderLists[con_item['builderList']].filter(function (list_item) {
              return list_item.name == con_item['builder'];
            })[0].caption;
          } else {
            var builder_map = {
              'moreEqual': '大于等于',
              'lessEqual': '小于等于'
            };
            filter_text += builder_map[con_item['builderList']];
          }
        } else {
          filter_text += '等于'
        }
        filter_text += '"' + (con_item['value_display'] || con_item['value']) + '"; ';
      }
    });
    $('[emap-role="FQ-text"]', element).text(filter_text).attr('title', filter_text);
  }

  function _clear(element, options) {
    WIS_EMAP_INPUT.formClear(options.filter_block);
    $('[emap-role="FQ-text"]', element).text('').attr('title', '');
    $('[emap-role="FQ-text-wrap"]', element).hide();
    options.onSearch && options.onSearch('[]');
    element.trigger('search', ['[]']);
  }

  // 执行搜索
  function _doSearch(element, options) {
    var conditions = _getSearchConditions(options);
    var conditions_string = JSON.stringify(conditions);
    _renderFilterText(element, conditions, options.data.builderLists);

    options.onSearch && options.onSearch(conditions_string);
    element.trigger('search', [conditions_string]);
    if (conditions && conditions.length > 0) {
      $('[emap-role="FQ-text-wrap"]', element).show();
    } else {
      $('[emap-role="FQ-text-wrap"]', element).hide();
    }
  }
  // 事件绑定
  function _eventBind(element, options) {
    // 点击展开
    element.on('click', '[emap-role="FQ-switch-btn__expand"]', function () {
        element.addClass('emap-expand');
        options.filter_block.show();
      })
      // 点击收起
      .on('click', '[emap-role="FQ-switch-btn__collapse"]', function () {
        element.removeClass('emap-expand');
        options.filter_block.hide();
      })
      // 更多条件
      .on('click', '[emap-role=FQ-more]', function () {
        var modelArray = options.model;
        var columns = options.filter_block.data('names');
        $.bhCustomizeColumn({
          model: modelArray,
          columns: columns,
          title: '添加搜索字段',
          callback: function (cols) {
            _renderFilterForm(cols, options);
          }
        });
      })
      // 搜索
      .on('click', '[emap-role="FQ-search-btn"]', function () {
        _doSearch(element, options);
      })
      // 文本框回车事件搜索
      .on('keyup', 'input[xtype=text]', function (e) {
        if (e.keyCode == 13) {
          _doSearch(element, options);
        }
      })
      // 清空搜索
      .on('click', '[emap-role="FQ-clear-btn"]', function () {
        _clear(element, options);
      })
  }


  $.fn.emapFilterQuery = function (options, param) {
    var instance;
    instance = this.data('emapfilterquery');
    if (!instance) {
      return this.each(function () {
        return $(this).data('emapfilterquery', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](param);
    return this;
  };

  /**
   * @memberof module:emapFilterQuery
   * @prop {Object} data - 搜索数据模型
   * @prop {String}  contextPath - emap根路径
   * @prop {Boolean} [expanded=false] - 是否自动展开
   * @prop {Object} [defaultOptions] - 字段的额外参数
   * @prop {Boolean} [showBlankOption=true] - 下拉和下拉树是否添加空值选项
   * @prop {Function} onSearch - 搜索回调
   * @prop {Function} beforeRender - 渲染前的回调,需要返回数据模型
   */

  $.fn.emapFilterQuery.defaults = {
    data: undefined,
    expanded: true,
    onSearch: undefined,
    beforeRender: undefined,
    defaultOptions: undefined
  };
}).call(this);

$.fn.emapFormInputInit = function (opt) {
    WIS_EMAP_INPUT.init($(this), opt);
};

/**
 * @fileOverview emapInput 功能模块
 */
(function(WIS_EMAP_INPUT, undefined) {
    /**
     * @module WIS_EMAP_INPUT
     * @alias 表单控件公共方法
     * @example
     WIS_EMAP_INPUT.init($form, {root: '/emap'})
     */
    /**
     * @memberof module:WIS_EMAP_INPUT
     * @description 表单控件注册对象,基于1.1版本进行修改和扩展
     * @prop {Object} date-ym - 年月选择框,基于bhDateTimePicker封装， 默认 yyyy-MM
     * @prop {Object} date-local - 日期选择框,基于bhDateTimePicker封装， 默认 yyyy-MM-dd
     * @prop {Object} date-full - 日期时间选择框,基于bhDateTimePicker封装， 默认 yyyy-MM-dd HH:mm
     * @prop {Object} date-range - 日期范围选择, 只能在高级搜索中使用，基于bhDateTimePicker封装， 默认 yyyy-MM-dd
     * @prop {Object} date-area - 日期范围选择, 在表单中使用，基于bhDateTimePicker封装， 默认 yyyy-MM-dd
     * @prop {Object} cache-upload - 缓存上传， 基于cacheUpload封装
     * @prop {Object} direct-upload - 直接上传， 基于directUpload封装
     */
    WIS_EMAP_INPUT.core = $.extend(WIS_EMAP_INPUT.core, {
        "date-ym": {
            "init": _initDateInput,
            "setValue": _dateSetValue,
            "getValue": _dateGetValue,
            "enable": _enableDateInput,
            "disable": _disableDateInput
        },

        "date-local": {
            "init": _initDateInput,
            "setValue": _dateSetValue,
            "getValue": _dateGetValue,
            "enable": _enableDateInput,
            "disable": _disableDateInput
        },

        "date-full": {
            "init": _initDateInput,
            "setValue": _dateSetValue,
            "getValue": _dateGetValue,
            "enable": _enableDateInput,
            "disable": _disableDateInput
        },
        "date-range": {
            "init": function(ele, params) {
                // range: {//可选，设置时间可选的范围
                //     max: 'today',  //可选，设置时间的最大可选范围，可传入'today'表示今天，或传入时间字符串，格式如'2015/02/05'
                //     min: '2015/02/05' //可选，设置时间的最小可选范围，可传入'today'表示今天，或传入时间字符串，格式如'2015/02/05'
                // },
                // time:{//可选，初始化时显示的时间范围
                //     start: '2015/01/05', //必填，时间字符串，格式如'2015/02/05'
                //     end: '2015/06/01'//必填，时间字符串，格式如'2015/02/05'
                // },
                // selected: function(startTime, endTime){ //可选，选择时间后的回调，返回的参数startTime是选择的开始时间，endTime是选择的结束时间，返回的是时间字符串格式如'2015/02/05'
                // }
                var inputOptions = $.extend({}, {
                    format: ele.data('format') ? ele.data('format').replace(/yyyy/, 'YYYY').replace(/-dd/, '-DD') : 'YYYY-MM-DD'
                }, params);
                ele.bhTimePicker(inputOptions);
            },
            "setValue": function(ele, name, val, root) {
                if (val === '' || val === undefined || val[name] === "") {
                    // 清空
                    ele.bhTimePicker('setType', 'all');
                } else {
                    var val_arr = val[name].split(',');
                    if (val_arr.length == 2) {
                        ele.bhTimePicker('setType', 'custom');
                        ele.bhTimePicker('setValue', {
                            startTime: val_arr[0],
                            endTime: val_arr[1]
                        });
                    }
                }
            },
            "getValue": function(ele, formData) {
                var rangeValue = ele.bhTimePicker('getValue');
                var sValue = (rangeValue.startTime || '') + ',' + (rangeValue.endTime || '');
                return sValue === ',' ? '' : sValue;
            },
            "disable": function(ele) {
                ele.attr('disabled', true);
            },
            "enable": function(ele) {
                ele.attr('disabled', false);
            }
        },
        "date-area": {
            "init": function(ele, params) {
                /**
                 * start: {},
                 * end: {}
                 * 其他公共参数
                 */
                params.format = ele.attr('data-format') || ''
                params.format = params.format.replace(/yyyy/, 'YYYY').replace(/-dd/, '-DD')
                ele.bhDateAreaPicker(params);
            },
            "setValue": function(ele, name, val, root) {
                if (val === '' || val === undefined || val[name] === '') {
                    // 清空
                    ele.bhDateAreaPicker('clear');
                }
                var value = val[name];
                if ($.type(value) === 'string') {
                    value = value.split(',');
                }

                if ($.isArray(value)) {
                    var date = {
                        startDate: value[0],
                        endDate: value[1] === undefined ? '' : value[1]
                    };
                    ele.bhDateAreaPicker('val', date);
                }

                if ($.isPlainObject(value)) {
                    ele.bhDateAreaPicker('val', value);
                }
            },
            "getValue": function(ele, formData) {
                var rangeValue = ele.bhDateAreaPicker('getValue');
                var value = [rangeValue.startDate, rangeValue.endDate].join(',');
                return value === ',' ? '' : value;
            },
            "disable": function(ele) {
                ele.bhDateAreaPicker('disabled', true);
            },
            "enable": function(ele) {
                ele.bhDateAreaPicker('disabled', false);
            }
        },
        "cache-upload": {
            "init": function(ele, params, options) {
                var readonly = (ele.data('disabled') == 'true' || ele.data('disabled') == true || options.readonly);
                var inputOptions = $.extend({}, {
                    readonly: readonly,
                    tooltipText: ele.attr('data-placeholder')
                }, params);
                ele.data('defaultoptions', inputOptions);
                ele.cacheUpload(inputOptions);
                ele.on('bh.file.upload.delete bh.file.upload.done', function() {
                    ele.trigger('_formChange');
                });
            },
            "setValue": function(ele, name, val, root) {
                ele.cacheUpload('destroy');
                ele.cacheUpload($.extend({}, ele.data('defaultoptions'), {
                    contextPath: root,
                    token: val[name]
                }));
            },
            "getValue": function(ele, formData) {
                return ele.cacheUpload('getFileToken');
            },
            "disable": function(ele) {
                return ele.cacheUpload('disable');
            },
            "enable": function(ele) {
                return ele.cacheUpload('enable');
            },
            "readonly": function(ele, params, options) {
                var readonly = (ele.data('disabled') == 'true' || ele.data('disabled') == true || options.readonly);
                var inputOptions = $.extend({}, {
                    readonly: readonly,
                    tooltipText: ele.attr('data-placeholder')
                }, params);
                ele.data('defaultoptions', inputOptions);
                ele.cacheUpload(inputOptions);
                ele.on('bh.file.upload.delete bh.file.upload.done', function() {
                    ele.trigger('_formChange');
                });
            }
        },
        "direct-upload": {
            "init": function(ele, params) {
                var inputOptions = $.extend({}, params);
                ele.data('defaultoptions', inputOptions);
                ele.directUpload(inputOptions);
            },
            "setValue": function(ele, name, val, root) {
                ele.directUpload('destroy');
                ele.directUpload($.extend({}, ele.data('defaultoptions'), {
                    contextPath: root,
                    token: val[name]
                }));
            },
            "getValue": function(ele, formData) {

            },
            "disable": function(ele) {

            },
            "enable": function(ele) {

            }
        }
    });

    WIS_EMAP_INPUT.component = (function() {
        return $.extend({}, WIS_EMAP_INPUT.core, {});
    })();


    WIS_EMAP_INPUT.allValidateRules = (function() {
        return $.extend({}, WIS_EMAP_INPUT.validateRules, {});
    })();

    /**
     * @method extendValidateRule
     * @description 扩展校验规则
     * @param {Object} rule - 添加的校验规则
     * @param {String} rule.name - 校验规则名称，使用时将其配置在字段模型的checkType属性上
     * @param {RegExp} rule.regex - 校验规则的正则表达式，与func 二选一必填
     * @param {Function} rule.func - 校验规则的处理函数，与func 二选一必填，带参数 value - 字段的值，函数返回Boolean，表示检验通过或者不通过；<br>
     * 若是联动校验， 则带参数为 value - 字段的值， filed - 联动字段name， element - 表单DOM
     * @param {String} rule.alertText - 校验提示文字，其中使用 '* '字符串来代替字段的caption，<br>
     * 若是联动校验， 使用'*1'代表当前字段caption，使用'*2'代表联动字段的caption
     * @example
     * WIS_EMAP_INPUT.extendValidateRule({
     *  name: 'test',
     *  alertText: '* 不正确',
     *  regex: /\d+/
     * })
     */
    WIS_EMAP_INPUT.extendValidateRule = function(rule) {
        if (WIS_EMAP_INPUT.allValidateRules[rule.name]) {
            return console && console.error(rule.name + $.i18n('bh-fi-checkRuleExist'));
        }
        WIS_EMAP_INPUT.allValidateRules[rule.name] = rule;
    };


    function _initDateInput(ele, params) {
        var xtype = ele.attr('xtype');

        var inputOptions = $.extend({}, {
            format: 'YYYY-MM',
            showClear: true,
            useCurrent: false
                // useCurrent:
        }, params);
        if (xtype == 'date-local') {
            inputOptions.format = 'YYYY-MM-DD';
        } else if (xtype == 'date-full') {
            inputOptions.format = ele.data('format') ? ele.data('format') : 'YYYY-MM-DD HH:mm:ss';
            // inputOptions.showTimeButton = true;
        } else if (xtype == 'date-ym') {
            inputOptions.format = 'YYYY-MM';
            inputOptions.viewMode = 'months';
        }
        inputOptions.format = ele.data('format') || inputOptions.format;
        inputOptions.format = inputOptions.format.replace(/yyyy/g, 'YYYY').replace(/\-dd/, '-DD');
        if (inputOptions.width !== undefined) {
            delete inputOptions.width;
        }
        ele.bhDateTimePicker(inputOptions);

        if (ele.data('disabled')) {
            ele.bhDateTimePicker('disabled', true);
        }

        ele.on('dp.change', function() {
            ele.trigger('_formChange')
        })
    }

    function _dateSetValue(ele, name, val, root) {
        ele.bhDateTimePicker('setValue', val[name] !== undefined ? val[name] : "");
    }

    function _dateGetValue(ele, formData) {
        return ele.bhDateTimePicker('getValue');
    }

    function _enableDateInput(ele) {
        ele.bhDateTimePicker('disabled', false);
    }

    function _disableDateInput(ele) {
        ele.bhDateTimePicker('disabled', true);
    }


})(window.WIS_EMAP_INPUT = window.WIS_EMAP_INPUT || {});
(function() {
    $.fn.emapValidate = function(args) {
        // 新旧版本校验组间传参不同的兼容处理
        var data = $(this).data('bhvalidate');

        if (!data) {
            if (args.data) {
                args.fieldModel = args.data;
            }
        }

        if (typeof args === 'string') {
            if (args === 'reloadValidate') {
                return $(this);
            }
        }
        return $(this).bhValidate(args);
    };

    $.fn.emapValidate.defaults = {
        easyCheck: false,
        textareaEasyCheck: false
    };

    var jqxV = $.fn.jqxValidator;
    $.fn.jqxValidator = function (options, params) {
        // console && console.warn('jqxValidator将在未来版本废弃， 请使用替代的 bhValidate！！！！');
        if ($(this).data('bhvalidate')) {
            return $.fn.bhValidate.call(this, options, params);
        } else {
            return jqxV.call(this, options, params);
        }
    }
}).call(this);
(function() {
  var Plugin;
  /**
   * @module bhValidate
   * @alias 表单校验
   * @description 校验组件，已在emapForm中集成
   *
   * 配置说明：
   * <br>必填校验 - 在模型中配置字段的require
   * <br>长度校验 - 优先取模型配置的checkSize作为校验长度，如果没有checkSize，则取dataSize作为校验长度，其中 日期控件（date-*）和开关控件（switcher）不做长度校验
   * <br>类型校验 - 对应模型中配置的checkType, 指定校验规则库中的校验规则，如 money
   * <br>正则校验 - 对应模型中的checkExp
   * <br>联动校验 - 在模型中的checkType中配置，规则为 【规则名称】@【联动字段name】,如： before@CSRQ, 同时兼容之前的custom[xxx]写法，但不建议继续使用
   * @example
   * $container.bhValidate({
   *     fieldModel: dataModel
   * })
   */
  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.bhValidate.defaults, options);
      this.$element = $(element);
      this.options.focusFlag = false;
      _init(this.$element, this.options);
    }

    /**
     * @method destroy
     * @description 销毁
     */
    Plugin.prototype.destroy = function() {
      this.options = null;
      $(this.$element).data('bhvalidate', false);
    };

    /**
     * @method validate
     * @description 校验
     * @param {String|Array} [name] - 指定字段名称， 不传则全部校验
     * @return {Boolean} 校验结果
     * @example
     * $container.bhValidate('validate');
     */
    Plugin.prototype.validate = function(name) {
      if (!name) {
        return validateAction(this.$element, this.options, undefined, true);
      } else if (typeof name === 'string') {
        return validateItem($('[data-name=' + name + ']', this.$element), this.options, true);
      } else if (name instanceof Array) {
        var result = true;
        var element = this.$element;
        name.map(function(item) {
          if (!validateItem($('[data-name=' + item + ']', element), this.options, true)) {
            result = false;
          }
        });
        return result;
      }
    };

    /**
     * @method addValidateMsg
     * @description 添加一个字段的校验出错信息，此方法不会对字段进行校验
     * @param {String} name - 字段名
     * @param {String} msg - 校验信息
     * @example
     * $container.bhValidate('addValidateMsg', name, msg);
     */
    Plugin.prototype.addValidateMsg = function(name, msg) {
      this.options.validateView.showValidate($('[data-name=' + name + ']', this.$element), msg);
    };
    /**
     * @method hideValidate
     * @description 移除字段的校验出错信息
     * @param {String|Array} [name] - 指定的字段名称，不传则全部隐藏
     */
    Plugin.prototype.hideValidate = function(name) {
      var element = this.$element;
      var options = this.options;
      if (!name) {
        $('[xtype]', element).each(function() {
          options.validateView.hideValidate($(this));
        })
      } else if (name instanceof Array) {
        name.map(function(item) {
          options.validateView.hideValidate($('[data-name=' + item + ']', element));
        });
      } else if (typeof name === 'string') {
        options.validateView.hideValidate($('[data-name=' + name + ']', element));
      }
    };

    /**
     * @method editValidateCondition
     * @description 编辑校验条件
     * @param {Function} cb -  处理校验条件的回调，参数为validateConditions， element， options, 函数必须返回 validateConditions
     */
    Plugin.prototype.editValidateCondition = function(cb) {
      if (typeof cb === 'function') {
        this.options.validateConditions = cb(this.options.validateConditions, this.$element, this.options);
      } else {
        console && console.error('editValidateCondition 方法传参必须为 function');
      }
    };

    /**
     * @method requireItem
     * @description 设置指定字段的必填校验
     * @param {String|Array} name - 字段的name，可以为数组
     */
    Plugin.prototype.requireItem = function(name) {
      var conditions = this.options.validateConditions;
      var rules = WIS_EMAP_INPUT.allValidateRules;
      var model = this.options.fieldModel;
      if (conditions.length) {
        if (name instanceof Array) {
          name.map(function(item) {
            required(item, conditions, model);
          })
        } else {
          required(name, conditions, model);
        }
      }

      function required(name, conditions, model) {
        if (conditions.filter(function(item) {
            return item.type === 'required' && item.name === name;
          }).length === 0) {
          var caption = model.filter(function(item) {
            return item.name === name
          })[0].caption;
          conditions.push({
            name: name,
            type: "required",
            captions: caption,
            rule: rules['required'].func,
            alertText: rules['required'].alertText.replace('* ', caption)
          })
        }
      }
    }

    /**
     * @method unRequireItem
     * @description 设置指定字段的必填校验
     * @param {String|Array} name - 字段的name，可以为数组
     */
    Plugin.prototype.unRequireItem = function(name) {
      var conditions = this.options.validateConditions;
      var rules = WIS_EMAP_INPUT.allValidateRules;
      var model = this.options.fieldModel;
      if (conditions.length) {
        if (name instanceof Array) {
          name.map(function(item) {
            unRequired(item, conditions, model);
          })
        } else {
          unRequired(name, conditions, model);
        }
      }

      function unRequired(name, conditions, model) {
        var index;
        var conditionItem = conditions.filter(function(item, i) {
          if (item.type === 'required' && item.name === name) {
            index = i;
            return true;
          }
        });
        if (conditionItem.length) {
          conditions.splice(index, 1);
        }
      }
    }

    /**
     *
     */
    Plugin.prototype.hide = function() {
      return this.$element.bhValidate('hideValidate');
    }
    Plugin.prototype.hideHint = function(selector) {
      var name = selector.match(/\[data-name=[\"|\']?(\w+)[\"|\']?\]/);
      return this.$element.bhValidate('hideValidate', name);
    }

    return Plugin;
  })();


  //生成dom
  function _init(element, options) {
    if (!options.fieldModel) {
      return console && console.warn('校验组件fieldModel不能为空！');
    }
    // 为所有的文本框项添加失焦校验
    options.fieldModel.map(function(item) {
      if (!item.xtype || item.xtype === 'text') {
        item.validateAction = 'blur';
      }
    });
    //qiyu 2016-12-14 调用时缺失最后的options参数
    options.validateConditions = initValidateCondition(options.fieldModel, element, options);
    // 对于模型中含有validateAction的字段，为自定义的事件触发校验
    options.fieldModel.map(function(item) {
      var itemElement = $('[data-name="' + item.name + '"]', element);
      if (item.validateAction) {
        item.validateAction.split(',').map(function(actionItem) {
          itemElement.on(actionItem, function() {
            $(this).trigger('_formChange');
          })
        })
      }
    })

    element.on('_formChange', function(event) {
      var target = event.target;
      var name = $(target).data('name');
      validateAction(element, options, name);
    });
  }

  // 生成校验条件
  function initValidateCondition(fieldModel, element, options) {
    var rules = WIS_EMAP_INPUT.allValidateRules;
    var condition = [];
    if (fieldModel.length) {
      fieldModel.map(function(item) {
        condition = condition.concat(initItemValidateCondition(item, rules, element, options));
      });
    }
    return condition;
  }

  // 获取单个字段的校验条件
  function initItemValidateCondition(fieldItem, rules, element, options) {
    var itemConditions = [];
    // 必填校验
    var attr = WIS_EMAP_SERV.getAttr(fieldItem);
    if (attr.required) {
      itemConditions.push({
        name: fieldItem.name,
        type: "required",
        captions: fieldItem.caption,
        rule: rules['required'].func,
        alertText: rules['required'].alertText.replace('* ', fieldItem.caption)
      });
    }

    // double 类型的字段 自动添加 double 校验和  长度为21的校验
    if (fieldItem.dataType == 'double') {
      itemConditions.push({
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: "double",
        rule: function(value) {
          if (value == undefined || value === '') return true;
          return new RegExp(rules['double'].regex).test(value);
        },
        alertText: rules['double'].alertText.replace('* ', fieldItem.caption)
      });
    }

    // int 类型的字段 自动添加 数字校验
    if (fieldItem.dataType == 'int') {
      itemConditions.push({
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: 'integer',
        rule: function(value) {
          if (value === undefined || value === '') return true;
          return rules['integer'].regex.test(value);
        },
        alertText: rules['integer'].alertText.replace('* ', fieldItem.caption)
      });
    }

    // 正则校验
    var exp = fieldItem.checkExp;
    if (exp && exp != "undefined") {
      itemConditions.push({
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: 'regexp',
        alertText: fieldItem.caption + $.i18n('bh-fi-notRight'),
        rule: function(value) {
          if (value === "") {
            return true;
          } // 空值不做校验
          if (typeof exp === 'object') {
            return new RegExp(exp).test(value);
          } else if (typeof exp === 'string') {
            return new RegExp(exp.trim().replace(/^\/|\/$/g, '')).test(value);
          }
        }
      });
    }
    // 生成长度校验
    var maxSize = 0;
    if (fieldItem.checkSize) {
      // 设置了校验长度 则使用校验长度
      maxSize = fieldItem.checkSize;
    } else {
      // 开启简单长度校验模式,所有字符 都算三个长度
      if (fieldItem.dataType == 'String' &&
        (
          (fieldItem.xtype == 'textarea' && options.textareaEasyCheck) ||
          options.easyCheck === true
        )
      ) {
        maxSize = fieldItem.dataSize ? Math.floor(fieldItem.dataSize / 3) : 0;
      } else {
        maxSize = fieldItem.dataSize ? fieldItem.dataSize : 0;
      }
    }

    if (maxSize > 0 && ($.inArray(fieldItem.xtype, ['date-local', 'date-full', 'date-ym', 'switcher']) === -1)) {
      var itemRules = {
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: 'size',
        rule: function(value) {
          if (value === undefined || value === '') return true;
          if (options.easyCheck === true) {
            return value.toString().length <= maxSize;
          } else {
            return _getValueLength(value) <= maxSize;
          }
        },
        alertText: fieldItem.caption + $.i18n('bh-fi-lengthExit')
      };
      if (fieldItem.xtype == 'textarea') {
        itemRules.alertText = fieldItem.caption + $.i18n('bh-fi-lengthNotPass') + maxSize + $.i18n('bh-fi-letters');
        itemRules.rule = function(value) {
          if (value === '' || value === undefined) return true
          if (options.textareaEasyCheck === true) {
            return value.toString().length <= maxSize;
          } else {
            return _getValueLength(value) <= maxSize;
          }
        };
      }
      // // 文本框金额类的 小数  长度校验
      // if ((fieldItem.xtype == 'text' || !fieldItem.xtype)) {
      //     if (maxSize.toString().indexOf(',') > -1) {
      //         var lengthArr = maxSize.split(',');
      //         itemRules.rule = function (value) {
      //             if (value == '') return true;
      //             new RegExp('^\\d{1-' + valArr[0] + '}')
      //             var valArr = _this.val().toString().split('.');
      //             if (valArr.length > 1) {
      //                 if (valArr[1].length > lengthArr[1]) return false
      //             }

      //             return valArr[0].length <= lengthArr[0] - lengthArr[1];
      //         };

      //         rules.push({
      //             input: '[data-name=' + name + ']',
      //             message: '金额类型不正确',
      //             action: 'change, blur, valuechanged',
      //             rule: function () {
      //                 if (_this.val() == '') return true;
      //                 return _this.val().length < 22;
      //             }
      //         });
      //     } else {}

      // }
      itemConditions.push(itemRules);
    }


    // 类型校验
    var jsonType = fieldItem.JSONParam || '{}';
    var checkType = fieldItem.checkType;
    if (!checkType || checkType == 'undefined') checkType = jsonType;
    if (typeof checkType === 'string') {
      checkType = checkType.replace(/\[|\]|\"|\{|\}|custom/g, ""); // 对原版校验组件custom[mail] 写法的兼容
    }
    if (checkType && typeof checkType === 'string') {
      checkType.split(',').map(function(item) {
        getTypeValidate(item, fieldItem, itemConditions, rules, element);
      });
    }

    if ($.inArray(fieldItem.xtype, ['uploadfile']) > -1) {
      itemConditions.push({
        name: fieldItem.name,
        captions: fieldItem.caption,
        action: 'bh-file-upload-validate',
        alertText: ' ',
        rule: function(value, fieldElement) {
          return fieldElement.find('.bh-error').length === 0;
        }
      });
    }

    // 上传1.2  如有出错的文件则不通过校验
    if ($.inArray(attr.xtype, ['cache-upload']) > -1) {
      itemConditions.push({
        name: attr.name,
        captions: attr.caption,
        action: 'bh.file.upload.done',
        alertText: $.i18n('bh-fi-wrongInUploadFiles'),
        rule: function(value, fieldElement) {
          return fieldElement.find('.emap-upload-block-wrap.error').length === 0;
        }
      });
      $('[data-name=' + attr.name + ']', element).on('bh.file.upload.done bh.file.upload.delete', function() {
        $(this).trigger('_formChange');
      });
    }

    return itemConditions;
  }

  function getTypeValidate(checkType, fieldItem, itemConditions, rules, element) {
    var itemRules = {};
    if (rules[checkType]) {
      itemRules = {
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: checkType,
        alertText: rules[checkType].alertText.replace('* ', fieldItem.caption),
      };
      if (rules[checkType].regex) {
        itemRules.rule = function(value) {
          if (value === "") {
            return true;
          } // 空值不做校验
          return new RegExp(rules[checkType].regex).test(value);
        };
      } else if (rules[checkType].func) {
        itemRules.rule = function(value) {
          if (value === "") {
            return true;
          } // 空值不做校验
          return rules[checkType].func(value);
        };
      }
      itemConditions.push(itemRules);
    } else if (checkType && checkType.indexOf('@') > -1) { // 字段联动校验  after@CSRQ
      var linkArray = checkType.split('@');
      var linkType = linkArray[0];
      var linkElement = $('[data-name=' + linkArray[1] + ']', element);
      itemRules = {
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: checkType
      };
      itemRules.alertText = rules[linkType].alertText.replace('*1', fieldItem.caption).replace('*2', linkElement.data('caption'));
      itemRules.rule = function(value) {
        return rules[linkType].func(value, linkArray[1], element);
      };
      itemConditions.push(itemRules);
    } else if (checkType.indexOf('after') > -1 || checkType.indexOf('before') > -1) { // 兼容现有应用中after 和before 类型的联动
      var linkType = '';
      var linkElement;
      var checkField = '';
      if (/^before=/g.test(checkType)) {
        linkType = 'before=';
      } else if (/^before/g.test(checkType)) {
        linkType = 'before';
      } else if (/^after=/g.test(checkType)) {
        linkType = 'after=';
      } else if (/^after/g.test(checkType)) {
        linkType = 'after';
      } else if (/^validate\:\s?(\"|\')?after\w+(\"|\')?/g.test(checkType)) {
        linkType = 'after';
        checkType = checkType.replace(/(validate|\'|\:|\s)/g, '');
      } else if (/^validate\:\s?(\"|\')?before\w+(\"|\')?/g.test(checkType)) {
        linkType = 'before';
        checkType = checkType.replace(/(validate|\'|\:|\s)/g, '');
      } else if (/^validate\:\s?(\"|\')?after=\w+(\"|\')?/g.test(checkType)) {
        linkType = 'after=';
        checkType = checkType.replace(/(validate|\'|\:|\s)/g, '');
      } else if (/^validate\:\s?(\"|\')?before=\w+(\"|\')?/g.test(checkType)) {
        linkType = 'before=';
        checkType = checkType.replace(/(validate|\'|\:|\s)/g, '');
      }
      checkField = checkType.replace(linkType, '');
      linkElement = $('[data-name=' + checkField + ']', element);

      itemRules = {
        name: fieldItem.name,
        captions: fieldItem.caption,
        type: checkType
      };
      itemRules.alertText = rules[linkType].alertText.replace('*1', fieldItem.caption).replace('*2', checkField === 'now' ? $.i18n('bh-fi-now') : linkElement.data('caption'));
      itemRules.rule = function(value) {
        return rules[linkType].func(value, checkType.replace(linkType, ''), element);
      };
      itemConditions.push(itemRules);
    }
  }

  // 获取取值长度   中文为 3个字符
  function _getValueLength(val) {
    if (typeof val === 'number') {
      val = val + '';
    }
    return val.replace(/[\u0391-\uFFE5]/g, '***').length;
  }

  // 校验方法，那么为指定的字段名，如未指定name，则对表单内所有字段进行校验
  function validateAction(element, options, name, autoFocus) {
    autoFocus = autoFocus === undefined ? false : autoFocus;
    var result = true;
    if (name) {
      var fieldItem = $('[data-name="' + name + '"]', element);
      result = validateItem(fieldItem, options, autoFocus);
    } else {
      $('[data-name][xtype]', element).each(function() {
        var item_result = validateItem($(this), options, autoFocus);
        if (result === true) {
          result = item_result;
        }
      })
    }
    options.focusFlag = false;
    return result;
  }

  // 校验单个字段
  function validateItem(fieldElement, options, autoFocus) {
    autoFocus = autoFocus === undefined ? false : autoFocus;
    var result = true;
    var name = fieldElement.data('name');
    var index = 0;
    // 跳过隐藏字段 跳过disable 字段 跳过表格表单的只读字段和隐藏字段
    if (fieldElement.closest('.bh-row').attr('hidden') ||
      fieldElement.closest('.bh-form-group').css('display') === 'none' ||
      fieldElement.closest('.bh-form-group').hasClass('bh-disabled') ||
      (fieldElement.data('attr') && fieldElement.data('attr').inputReadonly === true) ||
      fieldElement[0].nodeName == 'P' ||
      fieldElement.attr('xtype') == 'static' ||
      fieldElement.attr('xtype') == 'div') {
      return result;
    }
    var value = WIS_EMAP_INPUT.getValue(fieldElement, {});
    var itemConditions = options.validateConditions.filter(function(item) {
      return item.name == name;
    });
    if (itemConditions.length) {
      for (var i = 0; i < itemConditions.length; i++) {
        result = itemConditions[i].rule(value, fieldElement);
        if (result === false) {
          console && console.warn('校验未通过 - ' + name + ' : ' + value);
          console && console.warn(itemConditions[i]);
          index = i;
          break;
        }
      }
    }
    // change view
    if (result) {
      options.validateView.hideValidate(fieldElement);
    } else {
      options.validateView.showValidate(fieldElement, itemConditions[index].alertText);
      if (autoFocus && options.focusFlag !== true) {
        var xtype = fieldElement.attr('xtype');
        // 解决日期控件focus无法触发页面定位的问题
        if ($.inArray(xtype, ['date-local', 'date-full', 'date-ym', 'date-area', 'date-range']) > -1) {
          $('input', fieldElement).focus().blur()
        } else {
          fieldElement.focus();
        }
        options.focusFlag = true;
      }
    }
    return result;
  }

  $.fn.bhValidate = function(options, params, params2) {
    var instance;
    instance = $(this).data('bhvalidate');
    if (!instance) {
      return this.each(function() {
        if (options == 'destroy') {
          return this;
        }
        return $(this).data('bhvalidate', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params, params2);
    return this;
  };


  $.fn.bhValidate.view = {
    // 显示字段的校验信息
    showValidate: function(fieldElement, message) {
      var field_row = fieldElement.closest('.form-validate-block');
      var error_info = field_row.find('.jqx-validator-error-info');
      // 默认校验文字信息占6列
      var validateCol = 6
      if (field_row.find('.bh-form-placeholder').length > 0) {
        var match = field_row.find('.bh-form-placeholder')[0].className.match(/bh-col-md-(\d{1,2})/)
        if (match !== null && match.length > 1) {
          validateCol = match[1]
        }
      }
      var hasPaddingLeft = false //指示校验信息是否要paddingleft（在换行的情况下需要）
        // 如果过小，则切换到下一行展示
      if (validateCol < 2) {
        validateCol = 6
        hasPaddingLeft = true
      }
      if (
        field_row.hasClass('jqx-validator-error-container') &&
        error_info.length && error_info.data('message') == message
      ) return;
      fieldElement.addClass('jqx-validator-error-control');
      if (error_info.length > 0) {
        error_info.remove();
      }
      field_row.addClass('jqx-validator-error-container')
        .append('<div class="bh-form-group jqx-validator-error-info bh-pv-4 bh-col-md-' + validateCol + '" style="display: block;' + (hasPaddingLeft ? 'padding-left: 135px;' : '') + '" data-message="' + message + '">' + message + '</div>');
    },
    // 隐藏字段的校验信息, 若未传name，则隐藏所有的字段校验信息
    hideValidate: function(fieldElement) {
      fieldElement.removeClass('jqx-validator-error-control');
      var field_row = fieldElement.closest('.form-validate-block');
      field_row.removeClass('jqx-validator-error-container')
        .find('.jqx-validator-error-info').remove();
    }
  }

  /**
   * @memberof module:bhValidate
   * @prop {Array} fieldModel - 数据模型对象数组
   * @prop {Boolean} [textareaEasyCheck=false] - 计数文本域长度，默认为一个汉字算三个字符，为true时汉字和英文都算1个字符
   * @prop {Object} [validateView] - 自定义校验提示信息的处理方法，包含showValidate(显示提示信息)和hideValidate(隐藏提示信息)两个方法，
   * 格式为{showValidate: function (fieldElement, message) {}，hideValidate: function (fieldElement) {}}
   */
  $.fn.bhValidate.defaults = {
    fieldModel: null,
    easyCheck: false,
    textareaEasyCheck: false,
    validateView: $.fn.bhValidate.view
  };

}).call(undefined);
(function($) {
    /***
     * @param  {} opt
     * {
     *  app
     *  module
     *  page
     *  action
     *  preCallback
     *  importCallback
     *  closeCallback
     *  closeConfirmCallback
     *  autoClose
     *  tplUrl
     *  downloadTplName //重命名下载导入模板
     *  params:{
     *      read
     *      readTemplate
     *      readImport
     *  },
     *  adaptor // 指定合适的后端处理实例，支持'EMAP_IMPORT_CACHE'(默认)/'EMAP_IMPORT_DIRECT'或其他自定义类型
     *
     * }
     */

    /**
     * @module emapImport
     * @alias 导入
     */
    /**
     * 导入组件
     * @method emapImport
     * @param  {object} opt 初始化组件参数
     * @param {String} app - 应用名
     * @param {String} module - 模型名称
     * @param {String} page - 页面名称
     * @param {String} action - 动作名称
     * @param {String} [tplUrl] - 模板下载地址
     * @prop  {Number} [queryTimes] - 轮询导入进度间隔, 单位ms，默认1000
     * @param {String} [downloadTplName] - 重命名下载导入模板的名称
     * @param {Boolean} [autoClose=false] - 导入完成后是否自动关闭弹窗
     * @param {Function} [preCallback] - 弹窗弹出后的回调
     * @param {Function} [importCallback] - 导入请求成功后的回调
     * @param {Function} [closeCallback] - 导入弹窗关闭的回调
     * @param {Function} [closeConfirmCallback] - 点击【关闭弹窗】按钮的回调
     * @param {Object} [params] - 额外参数
     * @param {Object} [params.readTemplate] - 下载模板请求的read参数
     * @param {Object} [params.readImport] - 导入请求的read参数
     * @param {Object} [adaptor] - 指定合适的后端处理实例，支持'EMAP_IMPORT_CACHE'(默认)/'EMAP_IMPORT_DIRECT'或其他自定义类型
     * @example
    $.emapImport({
        contextPath: contextPath,
        app: "student_app",
        downloadTplName:'下载的导入模板',
        module: "modules",
        page: "xsxxdbwh",
        action: "T_PXXX_XSJBXX_ADD",
        adaptor // 指定合适的后端处理实例，支持'EMAP_IMPORT_CACHE'(默认)/'EMAP_IMPORT_DIRECT'或其他自定义类型
        preCallback: function() {

        },
        closeCallback: function() {
            $('#emapdatatable').emapdatatable('reload');
        },
    });
     */

    var defaultQueryTimes = 1000;

    $.emapImport = function(opt) {
        opt = convertOpt(opt);
        var option = {
            title: $.i18n('bh-ip-importDatas'),
            btns: {},
            params: {
                height: 450,
                close: function($dom, e) {
                    if (view) {
                        clearTimeout(view.importProgressTimer);
                    }
                    if ($.isFunction(opt.closeCallback)) {
                        opt.closeCallback($dom, e);
                    }
                }
            }
        };
        var view = new WIS_IMPORT_VIEW(option, opt.queryTimes || defaultQueryTimes);
        view.show();
        if (opt.preCallback) {
            opt.preCallback();
        }

        emapImportData.call(view.getUploadBtn(), opt, view);
    };

    function getAdaptor(opt) {
        // opt.adaptor = window[opt.adaptor || window['EMAP_IMPORT_CACHE'];
        return window[opt.adaptor || 'EMAP_IMPORT_CACHE'];
    }

    /***
     * 导入组件行为控制方法
     * @param  {object} opt    控制参数
     * @param  {object} view  导入窗口实例
     */
    function emapImportData(opt, view) {
        // 检查传入的后端 adaptor 是否存在
        var adaptor = getAdaptor(opt);
        if (!adaptor) {
            console.error('The import adaptor is invalid :' + opt.adaptor);
            return;
        }

        // 下载导入模板参数
        var downTplData = {
            app: opt.app, // *
            module: opt.module, // *
            page: opt.page, // *
            action: opt.action, // *
            storeId: opt.storeId ? opt.storeId : 'imexport'
        };

        if (opt.params) {
            $.extend(downTplData, opt.params);
        }

        // 用于 adaptor init
        var options = $.extend({}, opt, {
            config: {},
            autoUpload: false,
            multiple: false,
            storeId: (opt.storeId ? opt.storeId : 'file'),
            fileInput: view.getUploadBtn(),
            onUploading: function(result, data) {
                view.renderImportTempFileResult(result);

                view.getImportConfirmBtn().off('click').on('click', function() {
                    if ($(this).attr('disabled')) {
                        return;
                    }
                    view.renderImportingFileProgress();
                    data.submit();
                });
            },
            onRownumImported: function(resp) {
                view.renderImportRownumResult(resp);
            },
            onFileImported: function(json) {
                if (json.status == 1) {
                    if (json.key) {
                        var queryTimes = opt.queryTimes || defaultQueryTimes;
                        var load = function() {
                            clearTimeout(view.importProgressTimer);
                            adaptor.getImportProgress(opt, { key: json.key }).done(function(pro) {
                                view.changeProgressBar(pro);
                                if (pro.WCZT === '1') {
                                    var result = {
                                        status: 1,
                                        success: pro.CGTS,
                                        total: pro.ZS,
                                        attachment: pro.ATTACHMENT
                                    };
                                    if (adaptor.getDownloadResultUrl) {
                                        result.downLoadUrl = adaptor.getDownloadResultUrl(opt, result);
                                    }
                                    return view.renderImportCompleteResult(result, opt);
                                }
                                if (pro.WCZT === '0') {
                                    view.importProgressTimer = setTimeout(load, queryTimes);
                                }
                            }).fail(function() {
                                view.renderImportCompleteResult({ msg: '网络错误' });
                            });
                        };
                        load();
                    } else {
                        if (adaptor.getDownloadResultUrl) {
                            json.downLoadUrl = adaptor.getDownloadResultUrl(opt, json);
                        }
                        view.renderImportCompleteResult(json, opt);
                    }
                } else {
                    view.renderImportCompleteResult(json);
                }
            },
            onImportError: function() {
                view.renderImportCompleteResult({
                    attachment: true
                });
            }
        });

        adaptor.init(view.$window, options, downTplData);
        bindBtnAction(view, opt, downTplData);
    }

    /***
     * 绑定事件
     */
    function bindBtnAction(view, opt, downTplData) {
        // 点击重新上传
        view.getReImportBtn().on('click', function() {
            if (document.documentMode == 9) {
                view.renderReUploadBehaviour();
            } else {
                view.getUploadBtn().trigger('click');
            }
        });

        //下载导入模板
        view.getDownloadImportTplBtn().click(function() {
            if (opt.tplUrl) {
                location.href = opt.tplUrl;
            } else {
                downTplData = differentiateDownloadOrImport(downTplData);
                var data = $.extend({}, downTplData);
                data.filename = downTplData.filename || opt.downloadTplName || '';
                var adaptor = getAdaptor(opt);
                adaptor.downloadImportTpl && adaptor.downloadImportTpl(opt, data);
            }
        });

        //关闭弹窗
        view.getCloseBtn().on('click', function() {
            if ($.isFunction(opt.closeConfirmCallback)) {
                opt.closeConfirmCallback();
            }
            view.hide();
        });
    }

    // 区分 下载模板和导入数据的read
    function convertOpt(opt) {
        if (opt.params && opt.params.read) {
            opt.params.readTemplate = opt.params.readImport = opt.params.read;
            delete opt.params.read;
        } else if (opt.params && opt.params.readTemplate && opt.params.readImport) {
            if (opt.params.readTemplate === opt.params.readImport) {
                console && console.error('readTemplate 与 readImport不能相同!');
            }
        }
        return opt;
    }

    // 区分 下载模板和导入数据的read
    function differentiateDownloadOrImport(downTplData) {
        downTplData.read && delete downTplData.read;
        if (downTplData.readTemplate) {
            downTplData.read = downTplData.readTemplate;
        }
        downTplData.actionTemplate && (downTplData.action = downTplData.actionTemplate);
        return downTplData;
    }
})(jQuery);
(function($) {
    /**
     * @module WIS_IMPORT_VIEW
     * @alias 导入view模块
     * @description 导入组件view层
     * @param  {object} option
     * @example
    var option = {
        title: '导入数据',
        btns: {},
        params: {
            height: 450,
            close: function() {
                if ($.isFunction(opt.closeCallback)) {
                    opt.closeCallback();
                }
            }
        },
        callback: function(){}
    };
    var view = new WIS_IMPORT_VIEW(option);
    view.show();
     */
    var importView = function(option, queryTimes) {
        this.option = option;
        this.option.queryTimes = queryTimes;
    };

    var proto = importView.prototype;

    /**
     * @method show
     * @description 显示导入窗口
     */
    proto.show = function() {
        var title = this.option.title;
        var btns = this.option.btns || {};
        var params = $.extend({
            height: 450
        }, this.option.params);
        var callback = this.option.callback;
        this.$window = BH_UTILS.bhWindow(content, title, btns, params, callback);
    };

    /**
     * @method hide
     * @description 隐藏导入窗口
     */
    proto.hide = function() {
        this.$window.jqxWindow('close');
    };

    /**
     * @method getUploadBtn
     * @description 获取上传按钮
     */
    proto.getUploadBtn = function() {
        return this.$window.find('[role=fileInput]');
    };

    /**
     * @method getDownloadImportTplBtn
     * @description 获取下载导入模板按钮
     */
    proto.getDownloadImportTplBtn = function() {
        return this.$window.find('[role="downTplBtn"]');
    };

    /**
     * @method getImportConfirmBtn
     * @description 获取导入确认按钮
     */
    proto.getImportConfirmBtn = function() {
        return this.$window.find('[role=importConfirmBtn]');
    };

    /**
     * @method getReImportBtn
     * @description 获取重新导入按钮
     */
    proto.getReImportBtn = function() {
        return this.$window.find('[role=reImportBtn]');
    };

    /**
     * @method getDownloadResultBtn
     * @description 获取下载导入结果按钮
     */
    proto.getDownloadResultBtn = function() {
        return this.$window.find('a.emap-import-export');
    };

    /**
     * @method getCloseBtn
     * @description 获取关闭导入窗口按钮
     */
    proto.getCloseBtn = function() {
        return this.$window.find('[role=closeConfirmBtn]');
    };

    /**
     * @method renderImportTempFileResult
     * @description 渲染导入临时文件结果
     * @param {object} result - 导入结果
     */
    proto.renderImportTempFileResult = function(result) {
        var step1Contents = this.$window.find(".emap-import-step-content");
        // if (e.target.files) {
        step1Contents.eq(0).hide();
        step1Contents.eq(1).show();
        if (result.isSuccess) {
            step1Contents.eq(1).find('span.emap-import-file-name').text(result.file[0].name).attr('title', result.file[0].name);
            if (result.fileReader) {
                step1Contents.eq(1).find('span.emap-import-file-size').text('(' + parseInt(result.file[0].size / 1024) + 'k)');
            } else {
                step1Contents.eq(1).find('span.emap-import-file-size').hide();
            }
            this.getImportConfirmBtn().attr('disabled', false);
        } else {
            step1Contents.eq(1).find('span.emap-import-file-name').html('<span class="bh-color-danger">' + $.i18n('bh-ip-uploadRightExcel') + '</span>').attr("title", result.file[0].name);
            this.getImportConfirmBtn().attr('disabled', true);
        }
    };

    /**
     * @method renderImportingFileProgress
     * @description 渲染导入文件进度条
     */
    proto.renderImportingFileProgress = function() {
        var stepContent = this.$window.find('.emap-import-step1-content');
        stepContent.children('a').hide();
        stepContent.prepend('<div class="emap-import-step1-loading-block bh-pull-right"><div class="emap-sk-spinner emap-sk-spinner-fading-circle bh-pull-right" style="height: 28px; width: 28px;">' +
            '<div class="emap-sk-circle1 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle2 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle3 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle4 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle5 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle6 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle7 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle8 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle9 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle10 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle11 emap-sk-circle"></div>' +
            '<div class="emap-sk-circle12 emap-sk-circle"></div>' +
            '</div>' +
            '<p class="bh-pull-right" style="margin-right: 12px;line-height:28px;">' + $.i18n('bh-ip-uploading') + '……</p></div>');
    };

    /**
     * @method renderProgress
     * @description 根据后台数据渲染导入文件进度条
     */
    proto.changeProgressBar = function(resp) {
        var width = resp.YWCS / resp.ZS * 100 + '%';
        $('.emap-import-loading-bar div', this.$window).stop().animate({
            width: width
        }, this.option.queryTimes + 10);
    };

    /**
     * @method renderUploadTempFileResult
     * @description 渲染导入文件进度条
     */
    proto.renderUploadTempFileResult = function() {

    };

    /**
     * @method renderSaveAttachmentResult
     * @description 渲染保存临时文件结果
     */
    proto.renderSaveAttachmentResult = function() {

    };

    /**
     * @method renderImportRownumResult
     * @description 渲染导入数据条数结果
     */
    proto.renderImportRownumResult = function(result) {
        if (result.code == '500') {
            $('div.emap-import-step-content:eq(2)', this.$window).html('<p></p>');
            $('.emap-import-step1-content', this.$window).find('div.emap-import-step1-loading-block').remove();
            $('div.emap-import-step:eq(2)', this.$window).addClass('active').find('.emap-import-result-detail').html('<span style="color: red">' + (result.msg || result.message || $.i18n('bh-ip-importFailed')) + '</span>');
            return;
        }

        $('.emap-import-step2-count', this.$window).html($.i18n('bh-ip-numOfImportDatas') + result.rowNumber + $.i18n('bh-ip-piece'));
        $('.emap-import-step1-content', this.$window).find('div.emap-import-step1-loading-block').remove();
        $('div.emap-import-step:eq(1)', this.$window).addClass('active');
        if (!result.useNewImport) {
            $('.emap-import-loading-bar div', this.$window).animate({
                width: '87%'
            }, 3000);
        }
    };

    /**
     * @method renderImportCompleteResult
     * @description 渲染导入完成后的结果视图
     */
    proto.renderImportCompleteResult = function(result, opt) {
        var self = this;
        if (result.status == 1) {
            $('.emap-import-loading-bar div', self.$window).stop().animate({
                'width': '100%'
            }, 500, function() {
                var callback = function() {};
                if ($.isFunction(opt.importCallback)) {
                    callback = opt.importCallback(result.total, result.success);
                }
                $("div.emap-import-step-content:eq(2)", self.$window).html('<p class="bh-color-success">' + $.i18n('bh-ip-successInImport') + '</p>');
                $("div.emap-import-step:eq(2)", self.$window).addClass("active").find(".emap-import-result-detail").html($.i18n('bh-ip-importFinished') + "， " + $.i18n('bh-ip-numOfSuccess') + result.success + $.i18n('bh-ip-piece') + "，" + $.i18n('bh-ip-numOfFail') + (result.total - result.success) + $.i18n('bh-ip-piece'));
                if (callback) {
                    callback($("div.emap-import-step:eq(2)", self.$window).find(".emap-import-export"));
                }
                if (result.downLoadUrl) {
                    self.getDownloadResultBtn().attr('href', result.downLoadUrl).parent().show();
                } else {
                    self.getDownloadResultBtn().parent().show();
                }
                if (opt.autoClose) {
                    self.hide();
                }
            });
        } else {
            $('div.emap-import-step-content:eq(2)', self.$window).html('<p></p>');
            $('div.emap-import-step:eq(2)', self.$window).addClass('active').find('.emap-import-result-detail').html('<span style="color: red">' + $.i18n('bh-ip-numOfFail') + (': ' + result.msg || ': ' + result.message || '') + '</span>');
            if (!result.attachment) {
                $('div.emap-import-step:eq(2)', self.$window).find('.emap-import-export').parent().hide();
            }
        }
    };

    /**
     * @method renderReUploadBehaviour
     * @description 渲染重新上传按钮
     */
    proto.renderReUploadBehaviour = function() {
        var contents = this.$window.find('.emap-import-step1-content');
        contents.eq(0).show();
        contents.eq(1).hide();
    };

    window.WIS_IMPORT_VIEW = importView;

    var content = '<div class="emap-import-content">' +
        '<div class="emap-import-step active">' +
        '<h5 class="emap-import-step-title">' +

        '<span>1</span>' +
        $.i18n('bh-ip-uploadFile') +
        '<div class="bh-color-caption emap-import-p emap-import-step1-intro bh-mb-8" style="line-height:20px;white-space:initial">' + $.i18n('bh-ip-firstTimeTips') + '<a role="downTplBtn" href="javascript:void(0)">' + $.i18n('bh-ip-downloadModules') + '</a>' + $.i18n('bh-ip-viewing') + '</div>' +
        '</h5>' +

        '<div class="emap-import-step-content emap-import-step1-content">' +
        '<a href="javascript:void(0)" class="bh-btn bh-btn-primary bh-btn-small emap-import-input-a">' +
        $.i18n('bh-ip-startUploading') +
        '<input type="file" role="fileInput"/>' +
        '</a>' +

        '</p>' +
        '</div>' +
        '<div class="emap-import-step-content emap-import-step1-content" style="display: none;">' +
        '<p class="bh-color-caption emap-import-p  emap-import-step1-file">' +
        '<span class="emap-import-file-name"></span>' +
        '<span class="emap-import-file-size"></span>' +
        '</p>' +
        '<a href="javascript:void(0)" class="emap-import-reload-a bh-mh-8" role="reImportBtn">' + $.i18n('bh-ip-reupload') + '</a>' +
        '<a href="javascript:void(0)" role="importConfirmBtn" class="bh-btn bh-btn-primary bh-btn-small">' +
        $.i18n('bh-ip-sureUpload') +
        '</a>' +


        '</div>' +
        '</div>' +
        '<div class="emap-import-step ">' +
        '<h5 class="emap-import-step-title">' +
        '<span>2</span>' +
        $.i18n('bh-ip-importDatas') +
        '</h5>' +

        '<div class="emap-import-step-content">' +
        '<p class="emap-import-step2-intro">' + $.i18n('bh-ip-waitUploadedAutoImporting') + '</p>' +

        '<div class="emap-import-step2-content">' +
        '<div class="emap-import-loading-bar">' +
        '<div></div>' +
        '</div>' +
        '<p class="emap-import-step2-count"></p>' +
        '</div>' +
        '</div>' +
        '</div>' +

        '<div class="emap-import-step ">' +
        '<h5 class="emap-import-step-title">' +
        '<span>3</span>' +
        $.i18n('bh-ip-finish') +
        '</h5>' +

        '<div class="emap-import-step-content emap-import-step3-content">' +

        '<p class="emap-import-result-detail">' + $.i18n('bh-ip-importDetails') + '</p>' +
        '<p>' + $.i18n('bh-ip-viewDetails') + '<a class="emap-import-export" href="javascript:void(0)">' + $.i18n('bh-ip-downloadResult') + '</a>' + $.i18n('bh-ip-viewing') + '</p>' +
        '<button role="closeConfirmBtn" class="bh-btn bh-btn-default bh-btn-small bh-pull-right bh-mh-8 bh-mv-8">' + $.i18n('bh-ip-sureClose') + '</button>' +
        '</div>' +
        '</div>' +
        '</div>';
})(jQuery);

;
(function($) {
    /**
     * 导入2.0
     * @method $.import2
     * @param {Object} options 初始化参数
     * @param {String} options.app - 应用名
     * @param {String} options.module - 模型名称
     * @param {String} options.page - 页面名称
     * @param {String} options.action - 动作名称
     * @param {String} options.tplUrl - 模板下载地址
     * @param {String} options.downloadTplName - 重命名下载导入模板的名称
     * @param {Function} options.preCallback - 弹窗弹出后的回调
     * @param {Function} options.importCallback - 导入请求成功后的回调
     * @param {Function} options.closeCallback - 导入弹窗关闭的回调
     * @param {Function} options.closeConfirmCallback - 点击【关闭弹窗】按钮的回调
     * @return {} [description]
     */
    $.emapImport2 = function(options) {
        var option = {
            title: $.i18n('bh-ip2-importDatas'),
            btns: [],
            params: {
                height: 450,
                close: function($dom, e) {
                    if ($.isFunction(options.closeCallback)) {
                        options.closeCallback($dom, e);
                    }
                }
            }
        };
        var view = new WIS_IMPORT2_VIEW(option);
        if (options.preCallback) {
            options.preCallback();
        }

        emapImportData.call(view, options, view);
        return view;
    };

    function getAdaptor(opt) {
        // opt.adaptor = window[opt.adaptor || window['EMAP_IMPORT_CACHE'];
        return window[opt.adaptor];
    }

    //导入处理函数
    function emapImportData(opt, view) {
        // 检查传入的后端 adaptor 是否存在
        var adaptor = getAdaptor(opt);

        // 下载导入模板参数
        var downTplData = {
            app: opt.app, // *
            module: opt.module, // *
            page: opt.page, // *
            action: opt.action, // *
            storeId: opt.storeId ? opt.storeId : 'imexport'
        };

        if (opt.params) {
            $.extend(downTplData, opt.params);
        }

        // 用于 adaptor init
        var options = $.extend({}, opt, {
            config: {},
            autoUpload: false,
            multiple: false,
            storeId: (opt.storeId ? opt.storeId : 'file'),
            fileInput: view.getChooseFileBtn(),
            onUploading: function(result, data) {
                view.renderUploading(result);
                data.submit();
            },
            onUploaded: function(resp) {
                if (!resp.isSuccess) {
                    view.renderUploadNetError();
                }
            },
            onChecking: function() {
                view.renderCheckDefault();
            },
            onChecked: function(resp) {
                if (resp.isSuccess && resp.success === resp.total) {
                    view.renderCheckSuccess(resp.success);
                } else {
                    view.renderCheckFail(resp.success, resp.total - resp.success);
                }
            },
            onFileImporting: function() {
                view.renderImportDefault();
            },
            onFileImported: function(json) {
                view.renderImportSuccess(json.count);
            }
        });
        if (adaptor) {
            adaptor.init(view.$window, options, downTplData);
            bindBtnAction(view, opt, downTplData, options);
        }
    }

    function bindBtnAction(view, opt, downTplData, options) {
        var adaptor = getAdaptor(opt);
        /**********上传步骤**********/

        //下载导入模板按钮
        view.getDownloadTplBtn().click(function(e) {
            adaptor.downImportTpl(e, opt, downTplData, options);
        });

        //上传步骤，重新选择文件
        view.getUPloadReChooseBtn().click(function() {
            view.getChooseFileBtn().click();
        });
        /***************************/

        /**********校验步骤***********/
        //下载错误数据文件
        view.getDownloadErrorDataBtn().click(function(e) {
            adaptor.downErrorData(e, opt, downTplData, options);
        });

        //只导入正确数据
        view.getImportRightDataBtn().click(function(e) {
            adaptor.importRightData(e, opt, downTplData, options);
        });

        //重新选择文件
        view.getCheckReChooseBtn().click(function() {
            view.getChooseFileBtn().click();
        });
        //导入数据
        view.getImportDataBtn().click(function(e) {
            adaptor.importData(e, opt, downTplData, options);
        });
        /****************************/

        /***********导入步骤**********/
        view.getCompleteCloseBtn(function() {
            view.close();
        });
    }
})(jQuery);
;
(function($) {
    var importView = function(option) {
        var title = option.title;
        var btns = option.btns || [];
        var params = $.extend({
            height: 500
        }, option.params);
        var callback = option.callback;
        this.$window = BH_UTILS.bhWindow(content, title, btns, params, callback);
        this.bindCloseButtonAction();
    };

    importView.prototype.bindCloseButtonAction = function() {
        this.$window.find('.jqx-window-close-button-background').replaceWith(this.$window.find('.jqx-window-close-button-background').prop('outerHTML'));
        var self = this;
        this.$window.find('.jqx-window-close-button-background').click(function(e) {
            var $popOver = $('<div>' +
                '<div class="bh-text-center emap-import2-popOver">' +
                '   <a class="bh-btn bh-btn-small bh-btn-primary" role="close"><i class="iconfont icon-check" style="margin-right: 0;"></i></a><a class="bh-btn bh-btn-small bh-btn-default" role="cancel"><i class="iconfont icon-close" style="margin-right: 0;"></i></a>' +
                '</div></div>');
            if (self.$window.find('.step-1-content:not(.default)').length) {
                $('body').append($popOver);
                $popOver.jqxPopover({
                    width: 286,
                    height: 130,
                    title: $.i18n('bh-ip2-sureBack'),
                    selector: $(e.target)
                });
                setTimeout(function() {
                    var $over = $('body>.jqx-popover:last');
                    $over.jqxPopover('open');
                    $over.on('close', function() {
                        $over.jqxPopover('destroy');
                    });
                    $over.on('click', '[role="close"]', function(event) {
                        $(event.delegateTarget).jqxPopover('close');
                        self.$window.jqxWindow('close');
                    });
                    $over.on('click', '[role="cancel"]', function(event) {
                        $(event.delegateTarget).jqxPopover('close');
                    });
                });
                return;
            }
            if (self.$window.find('.step-2-content>div:visible').length) {
                $('body').append($popOver);
                $popOver.jqxPopover({
                    width: 286,
                    height: 130,
                    title: $.i18n('bh-ip2-sureBack'),
                    selector: $(e.target)
                });
                setTimeout(function() {
                    var $over = $('body>.jqx-popover:last');
                    $over.jqxPopover('open');
                    $over.on('close', function() {
                        $over.jqxPopover('destroy');
                    });
                    $over.on('click', '[role="close"]', function(event) {
                        $(event.delegateTarget).jqxPopover('close');
                        self.$window.jqxWindow('close');
                    });
                    $over.on('click', '[role="cancel"]', function(event) {
                        $(event.delegateTarget).jqxPopover('close');
                    });
                });
                return;
            }
            if (self.$window.find('.step-3-content>div:visible').length) {
                $popOver = $('<div>' +
                    '<div class="bh-text-center emap-import2-popOver">' +
                    '   <a class="bh-btn bh-btn-small bh-btn-primary" role="close"><i class="iconfont icon-check" style="margin-right: 0;"></i></a>' +
                    '</div></div>');
                $('body').append($popOver);
                $popOver.jqxPopover({
                    width: 245,
                    height: 120,
                    title: $.i18n('bh-ip2-notleave'),
                    selector: $(e.target)
                });
                setTimeout(function() {
                    var $over = $('body>.jqx-popover:last');
                    $over.jqxPopover('open');
                    $over.on('close', function() {
                        $over.jqxPopover('destroy');
                    });
                    $over.on('click', '[role="close"]', function(event) {
                        $(event.delegateTarget).jqxPopover('close');
                    });
                });
                return;
            }
            self.$window.jqxWindow('close');
        });
    };

    //获取选择文件按钮
    importView.prototype.getChooseFileBtn = function() {
        return this.$window.find('.step-1-content input');
    };
    //获取下载导入模板按钮
    importView.prototype.getDownloadTplBtn = function() {
        return this.$window.find('.step-1-content a[role="download-tpl"]');
    };

    //获取上传步骤重新选择文件按钮
    importView.prototype.getUPloadReChooseBtn = function() {
        return this.$window.find('.step-1-content button[role="re-choose"]');
    };

    //获取下载错误数据文件按钮
    importView.prototype.getDownloadErrorDataBtn = function() {
        return this.$window.find('.step-2-content a[role="download-error-data"]');
    };

    //获取只导入正确数据按钮
    importView.prototype.getImportRightDataBtn = function() {
        return this.$window.find('.step-2-content button[role="import-right-data"]');
    };

    //获取校验步骤重新选择文件按钮
    importView.prototype.getCheckReChooseBtn = function() {
        return this.$window.find('.step-2-content button[role="re-choose-file"]');
    };

    //获取校验成功的导入数据确认按钮
    importView.prototype.getImportDataBtn = function() {
        return this.$window.find('.step-2-content button[role="import-data"]');
    };

    //获取导入完成后，确认关闭按钮
    importView.prototype.getCompleteCloseBtn = function() {
        return this.$window.find('.step-3-content button[role="complete-close"]');
    };

    importView.prototype.close = function() {
        this.$window.jqxWindow('close');
    };

    importView.prototype.renderUploadDefault = function() {
        this.resetView();
        this.$window.find('.emap-import2-flow-state .step-1').addClass('activing');
        this.$window.find('.step-1-content').addClass('default');
    };

    importView.prototype.renderUploading = function(file) {
        this.resetView();
        this.$window.find('.emap-import2-flow-state .step-1').addClass('activing');
        this.$window.find('.step-1-content').addClass('success');
        this.$window.find('.emap-import2-content .filename').text(file.name);
        if (file.size) {
            this.$window.find('.emap-upload-time').text($.i18n('bh-ip2-uploading') + _getPredictionTimeStr(file.size));
        } else {
            this.$window.find('.emap-upload-time').text($.i18n('bh-ip2-uploading') + $.i18n('bh-ip2-bePatient'));
        }
        this.startUploadConsumingTimer();
    };

    importView.prototype.renderUploadFormatError = function() {
        this.resetView();
        this.$window.find('.emap-import2-flow-state .step-1').addClass('fail');
        this.$window.find('.step-1-content').addClass('format-error').find('.error-info').text($.i18n('bh-ip2-uploadExcel'));
    };

    importView.prototype.renderUploadNetError = function() {
        this.resetView();
        this.$window.find('.emap-import2-flow-state .step-1').addClass('fail');
        this.$window.find('.step-1-content').addClass('net-error').find('.error-info').text($.i18n('bh-ip2-badNetwork'));
    };

    importView.prototype.renderUploadFileOverflow = function() {
        this.resetView();
        this.$window.find('.emap-import2-flow-state .step-1').addClass('fail');
        this.$window.find('.step-1-content').addClass('file-overflow').find('.error-info').text($.i18n('bh-ip2-bigFile'));
    };

    importView.prototype.renderCheckDefault = function() {
        this.resetView();
        this.$window.find('.step-2-content').addClass('default');
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('activing');
    };

    importView.prototype.renderCheckSuccess = function(total) {
        this.resetView();
        this.$window.find('.step-2-content').addClass('success').find('.step-2-success-total').text(total);
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('activing');
    };

    importView.prototype.renderCheckFail = function(total, failCount) {
        this.resetView();
        this.$window.find('.step-2-content').addClass('part-error').find('.step-2-fail-total').text(total);
        this.$window.find('.step-2-content .step-2-fail-count').text(failCount);
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('fail');
    };
    //病毒
    importView.prototype.renderCheckViruses = function() {
        this.resetView();
        this.$window.find('.step-2-content').addClass('viruses').find('.error-info').text($.i18n('bh-ip2-virusFile'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('fail');
    };

    //
    importView.prototype.renderCheckNetError = function() {
        this.resetView();
        this.$window.find('.step-2-content').addClass('net-error').find('.error-info').text($.i18n('bh-ip2-badNetwork'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('fail');
    };

    importView.prototype.renderCheckNoData = function() {
        this.resetView();
        this.$window.find('.step-2-content').addClass('no-data').find('.error-info').text($.i18n('bh-ip2-emptyFile'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('fail');
    };

    importView.prototype.renderCheckFormatError = function() {
        this.resetView();
        this.$window.find('.step-2-content').addClass('format-error').find('.error-info').text($.i18n('bh-ip2-typeFile'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('fail');
    };

    importView.prototype.renderImportDefault = function(size) {
        this.resetView();
        if (size) {
            this.$window.find('.step-3-content').addClass('default').find('').text($.i18n('bh-ip2-importing') + '，' + _getPredictionTimeStr(size));
        } else {
            this.$window.find('.step-3-content').addClass('default').find('').text($.i18n('bh-ip2-importing'));
        }
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-3').addClass('activing');
        this.startImportTimer();
    };

    importView.prototype.renderImportSuccess = function(count) {
        this.resetView();
        this.$window.find('.step-3-content').addClass('success').find('[role="import-success-count"]').text(count);
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-3').addClass('activing');
    };

    importView.prototype.renderImportNetError = function() {
        this.resetView();
        this.$window.find('.step-3-content').addClass('net-error').find('.error-info').text($.i18n('bh-ip2-freshNetwork'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-3').addClass('fail');
    };

    importView.prototype.renderImportDBError = function() {
        this.resetView();
        this.$window.find('.step-3-content').addClass('db-error').find('.error-info').text($.i18n('bh-ip2-databaseError'));
        this.$window.find('.emap-import2-flow-state .step-1').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-2').addClass('actived');
        this.$window.find('.emap-import2-flow-state .step-3').addClass('fail');
    };

    importView.prototype.startUploadConsumingTimer = function() {
        var time = 0;
        this.uploadConsumingTimer = null;
        var self = this;
        var $dom = this.$window;
        var consuming = function() {
            $dom.find('.step-1-content .emap-import2-upload-consuming').text(_getmmssTime(time));
            time++;
            clearTimeout(self.uploadConsumingTimer);
            self.uploadConsumingTimer = setTimeout(consuming, 1000);
        };
        consuming();
    };

    importView.prototype.stopUploadConsumingTimer = function() {
        clearTimeout(this.uploadConsumingTimer);
    };

    importView.prototype.startImportTimer = function() {
        var time = 0;
        this.importTimer = null;
        var self = this;
        var $dom = this.$window;
        var consuming = function() {
            $dom.find('.step-3-content .import-consuming').text(_getmmssTime(time));
            time++;
            clearTimeout(self.importTimer);
            self.importTimer = setTimeout(consuming, 1000);
        };
        consuming();
    };

    importView.prototype.stopImportTimer = function() {
        clearTimeout(this.importTimer);
    };

    importView.prototype.resetView = function() {
        this.$window.find('.emap-import2-flow-state>div').removeClass('activing actived fail');
        this.$window.find('.emap-import2-content>div').removeClass('default success fail net-error format-error part-error db-error file-overflow no-data viruses');
        this.stopUploadConsumingTimer();
        this.stopImportTimer();
    };

    function _getmmssTime(time) {
        var mm = Math.floor(time / 60);
        var ss = time - mm * 60;
        var fixZero = function(val) {
            var str = val.toString();
            if (str.length < 2) {
                return '0' + str;
            }
            return str;
        };
        return fixZero(mm) + ':' + fixZero(ss);
    }

    function _getPredictionTimeStr(size) {
        if (size < 0.5 * 1024) {
            return $.i18n('bh-ip2-30second');
        } else if (size < 1 * 1024) {
            return $.i18n('bh-ip2-1minute');
        } else if (size < 3 * 1024) {
            return $.i18n('bh-ip2-2minute');
        } else if (size < 7 * 1024) {
            return $.i18n('bh-ip2-4minute');
        } else if (size < 10 * 1024) {
            return $.i18n('bh-ip2-6minute');
        } else {
            return $.i18n('bh-ip2-longMinute');
        }
    }

    var content = '<div class="emap-import2-flow-state">' +
        '   <div class="emap-import2-step-line"></div>' +
        '   <div class="emap-import2-step step-1 activing">' +
        '       <div class="emap-import2-icon"></div>' +
        '       <div class="emap-import2-step-name">' + $.i18n('bh-ip2-uploadFile') + '</div>' +
        '   </div>' +
        '   <div class="emap-import2-step step-2">' +
        '       <div class="emap-import2-icon"></div>' +
        '       <div class="emap-import2-step-name">' + $.i18n('bh-ip2-checkDatas') + '</div>' +
        '   </div>' +
        '   <div class="emap-import2-step step-3">' +
        '       <div class="emap-import2-icon"></div>' +
        '       <div class="emap-import2-step-name">' + $.i18n('bh-ip2-importDatas') + '</div>' +
        '   </div>' +
        '</div>' +
        '<div class="emap-import2-content">' +
        '   <div class="step-1-content default">' +
        '       <div class="step-default">' +
        '           <div class="step-1-default-img"></div>' +
        '           <button class="bh-btn bh-btn-primary bh-btn-large bh-mt-24" role="choose-file" style="margin-left:0">' + $.i18n('bh-ip2-chooseFiles') + '<input type="file" /></button>' +
        '           <div class="bh-mt-16">' + $.i18n('bh-ip2-firstTime') + '<a href="javascript:void 0" role="download-tpl">' + $.i18n('bh-ip2-downloadImportModel') + '</a>' + $.i18n('bh-ip2-uploadAfterInput') + '</div>' +
        '       </div>' +
        '       <div class="step-success">' +
        '           <div class="step-1-loading-img"></div>' +
        '           <div class="step-1-loading-tip">' +
        '               <p class="filename bh-pull-left"></p><p class="bh-pull-right">' + $.i18n('bh-ip2-server') + '</p>' +
        '           </div>' +
        '           <div class="emap-upload-time emap-import2-fontsize-16 bh-mt-16">' + $.i18n('bh-ip2-uploadingFilesNow') + '</div>' +
        '           <div class="bh-mt-16 emap-import2-fontsize-16">' + $.i18n('bh-ip2-takeTime') + '：' +
        '               <span class="emap-import2-upload-consuming bh-color-info"></span>' +
        '           </div>' +
        '       </div>' +
        '       <div class="step-fail">' +
        '           <div class="step-1-fail-img"></div>' +
        '           <div class="bh-color-warning bh-mt-16"><i class="iconfont icon-erroroutline" style="position:relative;top:1px"></i><span class="error-info">' + $.i18n('bh-ip2-uploadExcel') + '</span></div>' +
        '           <button class="bh-btn bh-btn-primary bh-btn-large bh-mt-16" role="re-choose" style="margin-left:0">' + $.i18n('bh-ip2-rechoose') + '</button>' +
        '           <div class="bh-mt-16">' + $.i18n('bh-ip2-firstTime') + '<a href="javascript:void 0" role="download-tpl">' + $.i18n('bh-ip2-downloadImportModel') + '</a>' + $.i18n('bh-ip2-uploadAfterInput') + '</div>' +
        '       </div>' +
        '   </div>' +
        '   <div class="step-2-content">' +
        '       <div class="step-default">' +
        '           <div class="step-2-default-img"></div>' +
        '           <div class="emap-import2-fontsize-16">' + $.i18n('bh-ip2-checkDatasAndWait') + '</div>' +
        '       </div>' +
        '       <div class="step-success">' +
        '           <div class="step-2-success-img"></div>' +
        '           <p class="filename"></p>' +
        '           <div class="bh-mb-24 emap-import2-fontsize-16"><i class="bh-color-success iconfont icon-check"></i>' + $.i18n('bh-ip2-checkedResult') + '<b class="step-2-success-total"></b>' + $.i18n('bh-ip2-piece') + '</div>' +
        '           <button class="bh-btn bh-btn-primary bh-btn-large" role="import-data">' + $.i18n('bh-ip2-importDatas') + '</button>' +
        '       </div>' +
        '       <div class="step-fail">' +
        '           <div class="step-2-fail-img"></div>' +
        '           <p class="filename"></p>' +
        '           <div class="all-error">' +
        '               <div class="bh-color-warning bh-mv-16"><i class="iconfont icon-erroroutline" style="position:relative;top:1px"></i><span class="error-info">' + $.i18n('bh-ip2-uploadExcel') + '</span></div>' +
        '               <button class="bh-btn bh-btn-primary bh-btn-large"role="re-choose" style="margin-left:0">' + $.i18n('bh-ip2-rechoose') + '</button>' +
        '           </div>' +
        '           <div class="check-error">' +
        '               <div class="bh-mb-24 emap-import2-fontsize-16">' +
        '                   <i class="bh-color-warning iconfont icon-error_outline" style="position:relative;top:1px"></i>' + $.i18n('bh-ip2-rightDatas') + '<b class="step-2-fail-total"></b>' + $.i18n('bh-ip2-wrongDatas') + '<b class="bh-color-warning step-2-fail-count"></b>' + $.i18n('bh-ip2-piece') + ' <a href="javascript:void 0" role="download-error-data">' + $.i18n('bh-ip2-downloadWrongFiles') + '</a>' +
        '               </div>' +
        '               <button class="bh-btn bh-btn-primary bh-btn-large" role="import-right-data">' + $.i18n('bh-ip2-onlyImportRightDatas') + '</button><button class="bh-btn bh-btn-default bh-btn-large" role="re-choose">' + $.i18n('bh-ip2-rechoose') + '</button>' +
        '           </div>' +
        '       </div>' +
        '   </div>' +
        '   <div class="step-3-content">' +
        '       <div class="step-default">' +
        '           <div class="step-3-default-img"></div>' +
        '           <div class="import-time emap-import2-fontsize-16 bh-mb-16">' + $.i18n('bh-ip2-uploadingFilesNow') + '</div>' +
        '           <div class="emap-import2-fontsize-16">' + $.i18n('bh-ip2-takeTime') + '：<span class="import-consuming bh-color-primary"></span></div>' +
        '       </div>' +
        '       <div class="step-success">' +
        '           <div class="step-3-success-img"></div>' +
        '           <div class="bh-mb-24 emap-import2-fontsize-16">' + $.i18n('bh-ip2-successImport') + '<span role="import-success-count"></span>' + $.i18n('bh-ip2-piece') + '</div>' +
        '           <button class="bh-btn bh-btn-primary bh-btn-large" role="complete-close">' + $.i18n('bh-ip2-sureClose') + '</button>' +
        '       </div>' +
        '       <div class="step-fail">' +
        '           <div class="step-3-fail-img"></div>' +
        '           <div class="bh-color-warning bh-mt-16 bh-mb-24"><i class="iconfont icon-erroroutline" style="position:relative;top:1px"></i><span class="error-info"></span></div>' +
        '           <button class="bh-btn bh-btn-primary bh-btn-large" role="complete-close">' + $.i18n('bh-ip2-sureClose') + '</button>' +
        '       </div>' +
        '   </div>' +
        '</div>';
    window.WIS_IMPORT2_VIEW = importView;
})(jQuery);
/**
 * @fileOverview EMAP条件筛选组件
 * @example
 $('#container').emapQuery({
            contextPath: "/emap"
        })
 */
(function() {
  var Plugin;
  /**
   * @module emapQuery
   * @alias 高级搜索2.0
   * @example
   $('#container').emapQuery({
          contextPath: "/emap"
      })
   */
  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapQuery.defaults, options);
      this.$element = $(element);
      _init(this);

    }

    /**
     * @method setValue
     * @description 赋值
     * @param {String|Array} val - 搜索条件
     */
    Plugin.prototype.setValue = function(val) {
      var self = this;
      var condition = val;
      if (typeof condition == 'string') {
        condition = JSON.parse(condition);
      }

      $('[emap-role="query-condition-container"]', this.$element).html('');

      condition = _reAdaptCondition(condition);
      condition.map(function(item) {
        _addTag(undefined, self, item);
      });
      var condition_container = $('[emap-role="query-condition-container"]', this.$element)
      if ($('.emap-query-tag', condition_container).length == 0) {
        $(condition_container).closest('.emap-query-condition-wrap').hide();
      } else {
        $(condition_container).closest('.emap-query-condition-wrap').show();
      }
    };

    /**
     * @method getValue
     * @description 赋值
     */
    Plugin.prototype.getValue = function() {
      return _getSearchCondition(this);
    };
    return Plugin;
  })();

  function _init(instance) {
    var options = instance.options;
    if (options.showBlankOption === undefined) {
      options.showBlankOption = WIS_EMAP_CONFIG.showBlankOptionInSearch;
    }
    if (options.useNewDropdownTree === undefined) {
      options.useNewDropdownTree = WIS_EMAP_CONFIG.useNewDropdownTree;
    }

    if (options.useNewDropdownTree === true) {
      options.data.controls.map(function(item) {
        if (item['search.xtype']) {
          if ($.inArray(item['search.xtype'], ['tree', 'multi-tree']) > -1) {
            item['search.xtype'] = item['search.xtype'].replace(/tree$/, 'tree2')
          }
        } else {
          if ($.inArray(item['xtype'], ['tree', 'multi-tree']) > -1) {
            item['xtype'] = item['xtype'].replace(/tree$/, 'tree2')
          }
        }
      });
    }
    _renderMain(instance);
    _initSearchForms(instance);

    _initSchema(instance);
    _eventBind(instance);
  }

  // 渲染主体html
  function _renderMain(instance) {
    var element = instance.$element;
    var options = instance.options;
    var main_tpl = '<div class="bh-clearfix">' + // 搜索框部分
      '<div class="bh-pull-left emap-query-input-wrap">' +
      '<input emap-role="query-input" class="bh-form-control emap-query-input" type="text">' +
      '<i class="iconfont icon-search emap-query-input-icon"></i>' +
      '<span class="emap-query-input-decorator" emap-role="query-input-decorator"></span>' +
      '</div>' +
      '<button type="button" class="bh-btn bh-btn-default bh-mh-8 bh-btn-small" emap-role="query-setting-btn"><i class="iconfont icon-add"></i>' + $.i18n('bh-q-setConditions') + '</button>' +
      '<button type="button" class="bh-btn bh-btn-default bh-btn-small" emap-role="query-schema-btn" style="margin-left: 0;"><i class="iconfont icon-edit"></i>' + $.i18n('bh-q-searchPlan') + '</button>' +
      '</div>' +

      '<div class="emap-query-form-group emap-query-schema-wrap">' + // 搜索方案部分
      '<label class="emap-query-form-label">' + $.i18n('bh-q-searchPlan') + '</label>' +
      '<div emap-role="query-schema-container"></div>' +
      '</div>' +

      '<div emap-role="query-quick-form" class="emap-query-quick-form">' + // button list 表单部分
      '</div>' +

      '<div emap-role="query-advanced-form" class="bh-clearfix emap-query-advanced-form">' + // 展开收起 表单部分
      '</div>' +

      '<p class="emap-query-expand">' + // 展开收起按钮
      '<a class="emap-query-expand-btn"><i class="iconfont icon-arrowdropdown"></i>' + $.i18n('bh-q-viewMoreConditions') + '</a>' +
      '<a class="emap-query-collapse-btn"><i class="iconfont icon-arrowdropup"></i>' + $.i18n('bh-q-gather') + '</a>' +
      '</p>' +

      '<div class="emap-query-condition-wrap" style="display: none;">' + // 当前搜索条件
      '<p class="bh-pull-right">' +
      '<a class="bh-mh-8" emap-role="query-clear-btn">' + $.i18n('bh-q-clear') + '</a>' +
      '<a emap-role="query-save-schema-btn">' + $.i18n('bh-q-saveAsSearchPlan') + '</a>' +
      '</p>' +
      '<div class="emap-query-form-group">' +
      '<label class="emap-query-form-label">' + $.i18n('bh-q-nowSearchCondition') + '</label>' +
      '<div emap-role="query-condition-container"></div>' +
      '</div>' +
      '</div>' +
      '';

    var model = options.data.controls;

    var quickModel = []; // 快速搜索的 字段
    var quickTextField = []; // 搜索框模糊匹配的文本字段
    var buttonListForm = []; // 快速查询的buttonlist 字段
    var advancedForm = [];
    var columns = [];

    options.schemaTpl = '<div class="emap-query-schema-dialog">' +
      '<p class="bh-color-caption bh-text-center emap-schema-none">' + $.i18n('bh-q-noPlan') + '</p>' +
      '<div class="emap-query-schema-add">' +
      '<h4 class="bh-mb-8">' + $.i18n('bh-q-newPlan') + '</h4>' +
      '<div>' +
      '<input type="text" emap-role="query-schema-name-input" placeholder="' + $.i18n('bh-q-inputPlanName') + '" class="bh-form-control emap-query-schema-name-input">' +
      '<button type="button" emap-role="query-schema-save-btn" class="bh-btn bh-btn-primary bh-btn-small">' + $.i18n('bh-q-save') + '</button>' +
      '<button type="button" emap-role="query-schema-cancel-btn" class="bh-btn bh-btn-default bh-btn-small">' + $.i18n('bh-q-cancel') + '</button>' +
      '</div>' +
      '</div>' +
      '<ul class="emap-query-schema-list"></ul>' +
      '</div>';

    options.guid = BH_UTILS.NewGuid();

    model.map(function(item) {
      var attr = WIS_EMAP_SERV.getAttr(item);
      if (item.quickSearch) {
        quickModel.push(item);
      }

      if ((!attr.xtype || attr.xtype == 'text') && item.quickSearch) { // 搜索框模糊匹配的文本字段
        quickTextField.push(item);
      }

      if (attr.xtype == 'buttonlist' || attr.xtype == 'multi-buttonlist') { // 快速查询的buttonlist 字段
        buttonListForm.push(item);
      } else { // 其他字段放入展开收起表单中
        advancedForm.push(item);
      }
    });

    element.html(main_tpl);
    $('[emap-role="query-input"]', element).data('quicktextfield', quickTextField);
    $('[emap-role="query-quick-form"]', element).data('buttonlistform', buttonListForm);
    $('[emap-role="query-advanced-form"]', element).data('advancedform', advancedForm);
    options.quickModel = quickModel;
    options.advancedModel = advancedForm;
    options.searchInput = $('[emap-role="query-input"]', element);

    advancedForm.map(function(item) {
      var hidden = _getSearchAttr(item, 'hidden');
      if (hidden === undefined) hidden = false;
      columns.push({
        name: item.name,
        hidden: hidden
      })
    });
    options.columns = columns;
    _getTextWidth(instance);
  }

  function _initSearchForms(instance) {
    _initSearchInput(instance);
    _initButtonListForm(instance);

  }

  //  初始化 搜索框部分
  function _initSearchInput(instance) {
    var input = $('[emap-role="query-input"]', instance.$element);
    var quickTextField = input.data('quicktextfield');
    var placeHolder = [];

    $('body').append('<div class="emap-query-quick-select" data-guid="' + instance.options.guid + '"></div>');
    if (quickTextField && quickTextField.length > 0) {
      var itemHtml = '<p data-name="_emap_all" emap-role="query-easy-list-item">' + $.i18n('bh-q-search') + ' <span class="emap-query-easy-caption">' + $.i18n('bh-q-all') + '</span> : <span class="emap-query-easy-query"></span></p>';
      quickTextField.map(function(item) {
        placeHolder.push(item.caption);
        itemHtml += '<p data-name="' + item.name + '" emap-role="query-easy-list-item">' + $.i18n('bh-q-search') + ' <span class="emap-query-easy-caption">' + item.caption + '</span> : <span class="emap-query-easy-query"></span></p>';
      });
      input.attr('placeholder', placeHolder.join('/'));
      $('.emap-query-quick-select[data-guid="' + instance.options.guid + '"]').html(itemHtml);
    } else {
      console && console.error('未配置快速搜索文本字段!');
    }
  }

  // 初始化 快速查询表单
  function _initButtonListForm(instance) {
    var button_list_form = $('[emap-role="query-quick-form"]', instance.element);
    var button_list_form_model = button_list_form.data('buttonlistform');
    var form_content = [];
    button_list_form_model.map(function(item) {
      var itemHtml = $('<div class="emap-query-form-group"></div>');
      itemHtml.append('<label class="emap-query-form-label">' + item.caption + '</label>');
      $('<div class="emap-query-form-input-container"></div>').append(WIS_EMAP_INPUT.renderPlaceHolder(item)).appendTo(itemHtml);
      form_content.push(itemHtml);
    });
    button_list_form.html(form_content);
    WIS_EMAP_INPUT.init(button_list_form, {
      showBlankOption: instance.options.showBlankOption
    });

  }

  // 初始化 高级表单
  function _initAdvancedForm(instance) {
    var form = $('[emap-role="query-advanced-form"]', instance.element);
    var form_model = form.data('advancedform');
    var form_content = [];
    form_model.map(function(item) {
      if (_getSearchAttr(item, 'hidden')) return;

      form_content.push(_renderAdvancedFormItem(item));
    });
    form.html(form_content);
    WIS_EMAP_INPUT.init(form, {
      showBlankOption: instance.options.showBlankOption
    });
  }

  function _renderAdvancedFormItem(item) {
    var itemHtml = $('<div class="emap-query-form-group emap-advanced bh-pull-left" data-field="' + item.name + '"></div>');
    itemHtml.append('<label class="emap-query-form-label">' + item.caption + '</label>');
    if ($.inArray(item.xtype, _getDoubleWidthField()) > -1) {
      itemHtml.addClass('emap-double-width');
    }
    $('<div class="emap-query-form-input-container"></div>').append(WIS_EMAP_INPUT.renderPlaceHolder(item)).appendTo(itemHtml);
    if (!item.xtype || $.inArray(item.xtype, _getButtonField()) > -1) {
      itemHtml.css({
        "padding-right": "80px"
      }).append('<button class="bh-btn bh-btn-default bh-btn-small emap-query-form-btn" emap-role="query-advanced-confirm">' + $.i18n('bh-q-sure') + '</button>');
    }
    return itemHtml;
  }

  function _renderAdvancedForm(cols, instance) {
    var options = instance.options;
    var form_array = [];
    var cur_names = options.columns;

    cols.map(function(nameItem, i) {
      var name_hidden = nameItem['hidden'];
      var model_item = cur_names.filter(function(item) {
        return item.name == nameItem.name;
      })[0];
      if (name_hidden !== model_item['hidden']) {
        if (name_hidden) {
          // 需要移除的字段
          $('[data-field=' + nameItem.name + ']', options.filter_block).remove();
        } else {
          // 需要添加的字段
          form_array.push(_renderAdvancedFormItem(options.advancedModel[i]));
        }
      }
    });
    options.columns = cols;
    $('[emap-role="query-advanced-form"]', instance.$element).append(form_array);
    form_array.map(function(item) {
      $(item).emapFormInputInit({});
    });
  }

  // 带有确认按钮的表单字段
  function _getButtonField() {
    return ['text', 'number-range', 'date-range'];
  }

  // 只能单选的字段
  function _getSingleValueField() {
    return ['text', 'select', 'tree', 'date-local', 'date-ym', 'date-full'];
  }

  // 允许多选的字段
  function _getMultiValueField() {
    return ['multi-select', 'multi-tree'];
  }

  function _getDoubleWidthField() {
    return ['date-range'];
  }

  function _getSearchAttr(item, attr) {
    if (item['search.' + attr] !== undefined) {
      return item['search.' + attr];
    } else {
      return item[attr];
    }
  }

  function _handleFormChangeData(target, instance) {
    var xtype = $(target).attr('xtype');
    _addTag(target, instance);

    if ($.inArray(xtype, _getButtonField()) > -1) {
      // clear input value
      WIS_EMAP_INPUT.formClear($(target).closest('.emap-query-form-group'));
    }
  }

  // 生成tag标签的搜索条件
  function _buildTagCondition(target, instance) {
    var model = instance.options.data.controls;
    var name = $(target).data('name');
    var element = instance.$element;
    var value = {};
    var condition;
    var xtype = 'text';

    if (name == '_emap_all') { // 搜索全部
      value[name] = $('.emap-query-easy-query', $(target)).text();
      condition = [];
      $('[emap-role="query-input"]', element).data('quicktextfield').map(function(item) {
        condition.push({
          name: item.name,
          caption: item.caption,
          builder: item.defaultBuilder,
          value: value[name],
          linkOpt: 'OR'
        })
      });
      return condition;
    }
    var itemModel = model.filter(function(item) {
      return item.name == name;
    })[0];

    if ($(target)[0].nodeName == 'P') { // 点击快速下拉进行的搜索
      value[name] = $('.emap-query-easy-query', $(target)).text();
    } else {
      value = WIS_EMAP_INPUT.formGetValue($(target).closest('.emap-query-form-group'));
      condition = WIS_EMAP_INPUT.getConvertCondition(value, model)[0];


      // xtype = itemModel['search.xtype'] || itemModel.xtype;

    }
    // condition = {
    //     name: name,
    //     caption: itemModel.caption,
    //     builder: itemModel.defaultBuilder,
    //     value: value[name],
    //     xtype: xtype,
    //     linkOpt: 'AND'
    // };
    // if (value[name + '_DISPLAY'] !== undefined) {
    //     condition.value_display = value[name + '_DISPLAY'];
    // }

    return condition;
  }

  // 添加一个搜索条件tag
  function _addTag(target, instance, conditionData) {
    var name;
    var condition;
    if (conditionData) {
      if (conditionData instanceof Array) {
        name = '_emap_all';
      } else {
        name = conditionData.name;
      }
      condition = conditionData;
    } else {
      name = $(target).data('name');
      condition = _buildTagCondition(target, instance);
    }
    if (condition.value === "" || condition.length === 0) return;


    var tag_container = $('[emap-role="query-condition-container"]', instance.$element);
    var tag = $('.emap-query-tag[data-name=' + name + ']');
    if (tag.length > 0) {
      if (name == '_emap_all') {
        tag.html($.i18n('bh-q-all') + ': ' + (condition[0]['value_display'] || condition[0]['value']) +
            '<i class="iconfont icon-close" emap-role="query-tag-dismiss"></i>')
          .data({
            'condition': condition
          });
      } else {
        tag.html(condition.caption + ': ' + (condition['value_display'] || condition['value']) +
            '<i class="iconfont icon-close" emap-role="query-tag-dismiss"></i>')
          .data({
            'condition': condition
          });
      }
    } else {
      if (name == '_emap_all') {
        $('<span class="bh-tag emap-query-tag" data-name="' + name + '">' + $.i18n('bh-q-all') + ': ' + (condition[0]['value_display'] || condition[0]['value']) +
            '<i class="iconfont icon-close" emap-role="query-tag-dismiss"></i>' +
            '</span>')
          .data({
            'condition': condition
          }).appendTo(tag_container);
      } else {
        $('<span class="bh-tag emap-query-tag" data-name="' + name + '">' + condition.caption + ': ' + (condition['value_display'] || condition['value']) +
            '<i class="iconfont icon-close" emap-role="query-tag-dismiss"></i>' +
            '</span>')
          .data({
            'condition': condition
          }).appendTo(tag_container);
      }
    }
    tag_container.closest('.emap-query-condition-wrap').show();
  }

  // 获取字符串基准宽度
  function _getTextWidth(instance) {
    /*生成随机字符串*/
    var guid = BH_UTILS.NewGuid();
    var $obj = instance.$element;
    var options = instance.options;
    //在该dom下添加一个零时dom来获取这个块的font-size
    $obj.append(
      '<div id="' + guid + '">' +
      '<div id="chinese-' + guid + '" style="display: none;position: absolute;">' + $.i18n('bh-q-is') + '</div>' +
      '<div id="lower-english-' + guid + '" style="display: none;position: absolute;">w</div>' +
      '</div>');
    var tempObj = $obj.find('#' + guid);
    //中文字符和大写的英文的大小
    options.chineseFontSize = tempObj.find('#chinese-' + guid).width();
    //小写的英文和数字的大小
    options.lowerEnFontSize = tempObj.find('#lower-english-' + guid).width();
    tempObj.remove();
  }

  // 或者字符串实际宽度
  function _getStrWidth(text, instance) {
    var options = instance.options;
    //匹配中文
    var chinese = text.match(/[^\x00-\xff]/g);
    var chineseLen = chinese ? chinese.length : 0;
    //大写字母和@
    var capitalEn = text.match(/[A-Z@]/g);
    var capitalEnLen = capitalEn ? capitalEn.length : 0;
    var lowerEnLen = text.length - chineseLen - capitalEnLen;
    //大写字母按中文字符的宽度算
    var width = (chineseLen + capitalEnLen) * options.chineseFontSize + lowerEnLen * options.lowerEnFontSize;
    return width;
  }

  // 渲染文本框搜索修饰文字
  function _showSearchDecorator(name, text, instance) {
    var element = instance.$element;
    var options = instance.options;
    var decorator = $('[emap-role=query-input-decorator]', element);
    var left = _getStrWidth(text, instance) + 38;
    if (left > 300) left = 300;
    if ($.trim(text) == '') {
      return decorator.hide().text('');
    }
    decorator.text('(' + name + ')').css('left', left).show();
  }

  // 初始化方案
  function _initSchema(instance) {
    var element = instance.$element;
    var options = instance.options;

    options = $.extend(options, {
      schemaType: "aq"
    });
    $.fn.emapSchema && $(element).emapSchema(options);
    _renderFixedSchema(element, options);
  }

  // 渲染固定的搜索方案
  function _renderFixedSchema(element, options) {
    options.schemaList = element.emapSchema('getSchemaList');
    options.schemaList = options.schemaList ? options.schemaList : [];
    var programContainer = $('.emap-query-schema-wrap', element);
    $('[emap-role="query-schema-container"]', programContainer).empty();
    if (options.schemaList.length > 0) {
      var fixedSchema = options.schemaList.filter(function(val) {
        return val.FIXED == 1;
      });
      if (fixedSchema.length == 0) {
        programContainer.hide();
      } else {
        $(fixedSchema).each(function() {
          var sch = $('<a  data-name="' + this.SCHEMA_NAME + '" href="javascript:void(0)">' + this.SCHEMA_NAME + '</a>');
          sch.data('schema', this);
          $('[emap-role="query-schema-container"]', programContainer).append(sch);
        });
        programContainer.show();
      }
    } else {
      programContainer.hide();
    }
  }

  // 生成搜索条件
  function _getSearchCondition(instance) {
    var conditionContainer = $('[emap-role="query-condition-container"]', instance.$element);
    var condition = [];
    var itemCondition;
    var tags = $('.emap-query-tag', conditionContainer)
    if (tags.length == 0) return '[]';
    tags.each(function() {
      itemCondition = WIS_EMAP_SERV.cloneObj($(this).data('condition'));
      if ($(this).data('name') == '_emap_all') {
        itemCondition[0].linkOpt = 'AND';
        condition.push(itemCondition);
      } else {
        if (itemCondition instanceof Array) {
          condition = condition.concat(itemCondition);
        } else {
          condition.push(itemCondition);
        }
      }
    });
    return JSON.stringify(WIS_EMAP_INPUT.filterCondition(condition));
  }

  function _adaptCondition(condition) {
    if (condition.value.indexOf(',') > -1) { // 多值
      var resultCondition = [];
      condition.value.split(',').map(function(item) {
        var _this = WIS_EMAP_SERV.cloneObj(condition);
        _this.value = item;
        resultCondition.push(_this);
      });

      // 对数字区间字段的特殊处理
      if (condition.xtype == 'number-range' || condition.xtype == 'date-range') {
        resultCondition[0].builder = 'moreEqual';
        resultCondition[1].builder = 'lessEqual';
      }

      return resultCondition;
    } else {
      return condition;
    }
  }

  // 搜索条件反向转换
  function _reAdaptCondition(conditions) {
    var resultArray = [];
    conditions.map(function(item) {
      if (item instanceof Array) {
        resultArray.push(item)
      } else {
        var nameCons = conditions.filter(function(con) {
          return con.name == item.name;
        });
        if (nameCons.length == 1) {
          resultArray.push(nameCons[0]);
        } else {
          item.value = resultArray.map(function(result) {
            return result.value;
          }).join(',');
          if (item['value_display']) {
            item['value_display'] = resultArray.map(function(result) {
              return result['value_display'];
            }).join(',');
          }
          resultArray.push(item);
        }

      }
    });
    return resultArray;
  }

  function _renderSchemaList(container, options) {
    if (options.schemaList.length == 0) {
      $(container).addClass('emap-none');
    } else {
      var schemaUl = $('ul.emap-query-schema-list', container).html("");
      options.schemaList.map(function(item) {
        var itemHtml = $('<li class="emap-query-schema-li" data-name="' + item.SCHEMA_NAME + '">' +
          '<a href="javascript:void(0)" class="bh-pull-right" emap-role="query-schema-delete">' + $.i18n('bh-q-delete') + '</a>' +
          '<a href="javascript:void(0)" class="bh-pull-right bh-mh-8" emap-role="query-schema-unfixed">' + $.i18n('bh-q-cancelSetTop') + '</a>' +
          '<a href="javascript:void(0)" class="bh-pull-right bh-mh-8" emap-role="query-schema-fixed">' + $.i18n('bh-q-setTop') + '</a>' +
          '<i class="iconfont icon-publish"></i>' +
          '<i class="iconfont icon-turnedinnot"></i>' +
          item.SCHEMA_NAME +
          '</li>').data('schema', item);
        if (item.FIXED == "1") {
          itemHtml.addClass('emap-fixed');
        }
        schemaUl.append(itemHtml);
        schemaUl.prepend($('.emap-fixed', schemaUl));

      });
      $('.emap-query-schema-dialog', container).removeClass('emap-none');
    }
  }

  // 方案弹窗事件绑定
  function _schemaDialogEventBind(container, instance) {
    // 确定保存为方案
    container.on('click', '[emap-role="query-schema-save-btn"]', function() {
      var name = $('[emap-role="query-schema-name-input"]', container).val();
      if ($.trim(name) === "") return;
      var condition = _getSearchCondition(instance);
      instance.$element.emapSchema('saveSchema', [name, condition]).done(function(res) {
        if (res.success == true) {
          $('.emap-query-schema-add', container).hide();
          instance.options.schemaList.push({
            SCHEMA_NAME: name,
            CONTENT: condition
          });
          _renderSchemaList(container, instance.options);
        }
      });
    });

    // 取消保存为方案
    container.on('click', '[emap-role="query-schema-cancel-btn"]', function() {
      $.bhPropertyDialog.hide();
    });

    // 置顶
    container.on('click', '[emap-role="query-schema-fixed"]', function(e) {
      e.stopPropagation();
      var li = $(this).closest('li');
      var name = li.data('schema').SCHEMA_NAME;
      var conditionData = li.data('schema').CONTENT;
      instance.$element.emapSchema('saveSchema', [name, conditionData, 1]).done(function(res) {
        li.addClass('emap-fixed');
        li.parent().prepend(li);
        _renderFixedSchema(instance.$element, instance.options);
      });
    });

    // 取消置顶
    container.on('click', '[emap-role="query-schema-unfixed"]', function(e) {
      e.stopPropagation();
      var li = $(this).closest('li');
      var name = li.data('schema').SCHEMA_NAME;
      var conditionData = li.data('schema').CONTENT;
      instance.$element.emapSchema('saveSchema', [name, conditionData, 0]).done(function(res) {
        li.removeClass('emap-fixed');
        li.parent().append(li);
        _renderFixedSchema(instance.$element, instance.options);
      });
    });

    // 删除方案
    container.on('click', '[emap-role="query-schema-delete"]', function(e) {
      e.stopPropagation();
      var li = $(this).closest('li');
      var name = li.data('schema').SCHEMA_NAME;
      var dialog = $(this).closest('.emap-query-schema-dialog');
      if (instance.$element.emapSchema('deleteSchema', name)) {
        li.remove();
        $('.bh-rules-program', instance.$element).find('[data-name=' + name + ']').remove();
        $(instance.options.schemaList).each(function(i) {
          if (this.SCHEMA_NAME == name) {
            instance.options.schemaList.splice(i, 1);
          }
        });
        if (instance.options.schemaList.length == 0) {
          dialog.addClass('emap-none');
        }
        _renderFixedSchema(instance.$element, instance.options);
      }
    });

    // 点击搜索方案
    container.on('click', 'li.emap-query-schema-li', function() {
      var condition = $(this).data('schema').CONTENT;
      instance.$element.emapQuery('setValue', condition);
      instance.options.searchInput.trigger('search', condition);
    });
  }

  // 事件绑定
  function _eventBind(instance) {
    var element = instance.$element;
    var options = instance.options;
    // 搜索框输入事件
    element.on('keyup', '[emap-role="query-input"]', function(e) {
      var easySelectH = ($(this).data('quicktextfield').length + 1) * 28 + 1; // 下拉框高度
      var easySelectW = $(this).outerWidth(); // 下拉框宽度
      var searchValue = $(this).val();
      var pos = $(this).offset();
      var selectDiv = $('.emap-query-quick-select[data-guid=' + options.guid + ']');
      pos.top += 28;

      // 回车快速搜索
      if (e.keyCode == 13) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
        element.trigger('search', [_getSearchCondition(options), options, e]);
        return;
      }

      if (searchValue == '') {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
      } else {
        $('.emap-query-easy-query', selectDiv).html(searchValue);
        selectDiv.css({
          'height': easySelectH + 'px',
          'width': easySelectW + 'px',
          'border-width': '1px',
          'top': pos.top,
          'left': pos.left
        });
      }
    });

    // 点击空白区 收起下拉
    $(document).off('click.emapQuery').on('click.emapQuery', function(e) {
      if ($(e.target).closest('.emap-query-quick-select').length == 0) {
        $('.emap-query-quick-select[data-guid=' + options.guid + ']').css({
          'height': 0,
          'border-width': '0'
        });
      }
    });

    // 点击展开收起
    element.on('click', '.emap-query-expand a', function() {
      var parent = $(this).parent();
      if (parent.hasClass('emap-expand')) {
        parent.removeClass('emap-expand');
        $('[emap-role="query-advanced-form"]', element).hide();
      } else {
        parent.addClass('emap-expand');
        $('[emap-role="query-advanced-form"]', element).show();
      }
    });

    // 首次点击展开 实例化高级表单
    element.one('click', '.emap-query-expand a.emap-query-expand-btn', function() {
      _initAdvancedForm(instance);
    });

    // 搜索条件的添加
    element.on('_formChange', function(e, targetInput) {
      var target = e.target;
      var xtype = $(target).attr('xtype');
      if ($.inArray(xtype, _getButtonField()) > -1) {
        if (!targetInput) return;
        _handleFormChangeData(targetInput, instance);
      } else {
        _handleFormChangeData(target, instance);
      }

      options.searchInput.trigger('search', _getSearchCondition(instance));
    });

    // 点击叉叉移除搜索条件
    element.on('click', 'i[emap-role="query-tag-dismiss"]', function() {
      $(this).closest('.emap-query-tag').remove();
      var container = $(this).closest('[emap-role="query-condition-container"]');
      if ($('.emap-query-tag', container).length == 0) {
        container.closest('.emap-query-condition-wrap').hide();
      }
      instance.options.searchInput.trigger('search', _getSearchCondition(instance));
    });

    // 点击表单控件的确认按钮, 触发 _formChange 事件
    element.on('click', '[emap-role="query-advanced-confirm"]', function() {
      var input = $(this).closest('.emap-query-form-group').find('[xtype]');
      input.trigger('_formChange', [input]);
    });

    // 点击顶部搜索框的下拉 执行相应的搜索
    $('.emap-query-quick-select[data-guid=' + options.guid + ']').on('click', '[emap-role="query-easy-list-item"]', function() {
      _addTag($(this), instance);
      $(this).closest('.emap-query-quick-select').css({
        'height': 0,
        'border-width': '0'
      });
      _showSearchDecorator($('.emap-query-easy-caption', $(this)).text(), $('.emap-query-easy-query', $(this)).text(), instance);
      options.searchInput.trigger('search', _getSearchCondition(instance));
    });

    // decorator 点击自动focus 搜索框
    $('[emap-role="query-input-decorator"]', element).on('click', function() {
      $(this).hide();
      $('[emap-role="query-input"]', element).focus();
    });

    // 文本框 获取焦点 隐藏decorator
    $('[emap-role="query-input"]', element).focus(function() {
      $('[emap-role="query-input-decorator"]', element).hide();
    }).blur(function() {
      if ($.trim($(this).val()) != '') {
        $('[emap-role="query-input-decorator"]', element).show();
      }
    }).on('input', function() {
      $('[emap-role="query-input-decorator"]', element).text('');
    });

    // 点击设置条件
    element.on('click', '[emap-role="query-setting-btn"]', function() {
      var modelArray = options.advancedModel;
      var columns = options.columns;
      $('.emap-query-expand a.emap-query-expand-btn', element).trigger('click');
      $.bhCustomizeColumn({
        model: modelArray,
        columns: columns,
        title: $.i18n('bh-q-addSearchKeys'),
        callback: function(cols) {
          _renderAdvancedForm(cols, instance);
        }
      });
    });

    // 点击清空搜索条件
    element.on('click', '[emap-role="query-clear-btn"]', function() {
      var wrap = $(this).closest('.emap-query-condition-wrap')
      wrap.find('[emap-role="query-condition-container"]').html('');
      wrap.hide();
    });

    // 点击保存为搜索方案
    element.on('click', '[emap-role="query-save-schema-btn"]', function() {
      $.bhPropertyDialog.show({
        "title": $.i18n('bh-q-searchPlan'),
        "content": options.schemaTpl,
        "ready": function($header, $section, $footer) {
          _renderSchemaList($section, options);
          $section.removeClass('emap-none');
          $('.emap-query-schema-add', $section).show();
          _schemaDialogEventBind($section, instance);
        }
      });
    });

    // 点击搜索方案
    element.on('click', '[emap-role="query-schema-btn"]', function() {
      $.bhPropertyDialog.show({
        "title": $.i18n('bh-q-searchPlan'),
        "content": options.schemaTpl,
        "ready": function($header, $section, $footer) {
          _renderSchemaList($section, options);
          _schemaDialogEventBind($section, instance);
        }
      });
    });

    // 点击搜索栏下方的方案名称
    element.on('click', '[emap-role="query-schema-container"] a', function() {
      var condition = $(this).data('schema').CONTENT;
      instance.$element.emapQuery('setValue', condition);
      instance.options.searchInput.trigger('search', condition);
    });
  }

  $.fn.emapQuery = function(options, param) {
    var instance;
    instance = this.data('emapquery');
    if (!instance) {
      return this.each(function() {
        return $(this).data('emapquery', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](param);
    return this;
  };

  /**
   * @memberof module:emapQuery
   * @prop {Object} data - 搜索数据模型
   * @prop {String}  contextPath - emap根路径
   * @prop {Boolean} [expanded=false] - 是否自动展开
   * @prop {Boolean} [showBlankOption=true] - 下拉和下拉树是否添加空值选项
   * @prop {Function} onSearch - 搜索回调
   * @prop {Function} beforeRender - 渲染前的回调,需要返回数据模型
   */

  $.fn.emapQuery.defaults = {
    expanded: false,
    onSearch: undefined,
    beforeRender: undefined
  };
}).call(this);
(function () {
    var Plugin;
    var fileReader = 'FileReader' in window;
    var upload_block;

    /**
     * @module cacheUpload
     * @alias 缓存上传
     * @description 缓存上传
     * @example
        $('#upload').cacheUpload({
            contextPath: '/emap',
            buttonType: 'button'
        })
     */
    Plugin = (function () {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.cacheUpload.defaults, options);
            this.options.isSingle = this.options.limit == 1 ? '1' : '0';
            this.$element = $(element);
            _init(this);
        }

        /**
         * @method saveUpload
         * @param {Object} [params] - 保存时附带的参数
         * @description 保存上传
         * @return {Object} - 带有保存结果的promise对象
         */
        Plugin.prototype.saveUpload = function (params) {

            // 删除 已经删除的正式文件
            var options = this.options;
            var element = this.$element;
            var param_data = params || {};
            var result = $.Deferred();

            if (options.view.isSorting(options)) {
                $.bhTip({
                    content: $.i18n('bh-cu-sorting'),
                    state: 'warning'
                });
                result.reject();
                return result;
            }

            param_data.attachmentParam = JSON.stringify($.extend({}, this.options.attachmentParam, {
                orderMap: _getSortData(this.options),
                storeId: options.storeId
            }));

            // 先判断没有没正在上传的文件, 如果有弹出提示框
            if (options.view.hasLoadingFile(options) && options.uploadingWarn) {
                BH_UTILS.bhDialogWarning({
                    title: $.i18n('bh-fu-warning'),
                    content: $.i18n('bh-cu-uploading'),
                    buttons: [{
                        text: $.i18n('bh-fu-conFirmUpload'),
                        className: 'bh-btn-warning',
                        callback: function () {
                            saveAction(element, options, param_data, result);
                        }
                    }, {
                        text: $.i18n('bh-fu-cancelUpload'),
                        className: 'bh-btn-default',
                        callback: function () {
                            result.reject();
                        }
                    }]
                })
            } else {
                saveAction(element, options, param_data, result);
            }
            return result;

            function saveAction(element, options, param, result) {
                WIS_EMAP_UPLOAD.cacheCore.save(element, options, param).done(function (res) {
                    options.arrToDelete = [];
                    // token下没有文件时, 返回的token为空
                    if (element.cacheUpload('getFileNum') > 0) {
                        res.token = options.token;
                    } else {
                        res.token = "";
                    }
                    options.view.saveBlock(undefined, options);
                    result.resolve(res);
                }).fail(function (e) {
                    result.reject(e);
                });
            }
        };

        Plugin.prototype.saveTempFile = function (params) {

        };

        /**
         * @method getFileToken
         * @description 获取token, 若token下文件数量为0,则返回""
         * @returns {string} token
         */
        Plugin.prototype.getFileToken = function () {
            if (this.$element.cacheUpload('getFileNum') == 0) {
                return "";
            }
            return this.options.token;
        };

        /**
         * @method getFileNum
         * @description 获取token下文件数量 包括正式文件和临时文件, 不包含 出错的文件和 正在上传的文件
         * @returns {*|jQuery}
         */
        Plugin.prototype.getFileNum = function () {
            return this.options.view.getFileNum(this.options);
        };

        /**
         * @method getFileInfo
         * @description 获取当前组件下所有的文件信息
         * @param {Boolean} [async=true] - 是否为异步请求
         * @return {Object} 若为异步则返回promis对象，若为同步，则返回请求结果数组
         */
        Plugin.prototype.getFileInfo = function (async) {
            var options = this.options;
            var fileArr;
            var defer = $.Deferred();
            $.ajax({
                type: "post",
                url: options.contextPath + '/sys/emapcomponent/file/getUploadedAttachment/' + options.token + '.do',
                dataType: "json",
                async: async === false ? false : true,
                success: function (res) {
                    if (res.success) {
                        defer.resolve(res.items);
                        fileArr = res.items;
                    } else {
                        defer.reject(res);
                    }
                },
                error: function (error) {
                    defer.reject(error);
                }
            });

            if (async === false) {
                return fileArr;
            } else {
                return defer;
            }
        };

        /**
         * @method disable
         * @description 禁用
         */
        Plugin.prototype.disable = function () {
            var $upload = this.$element.find('input[emap-role="upload-input"]');
      $upload.prop('disabled', true).closest('.emap-upload-btn-button').addClass('bh-disabled');
      this.$element.find('input[name="reUpload"]').prop('disabled', true)
      this.options.disabled = true
            return this.$element;
        };

        /**
         * @method disable
         * @description 禁用
         */
        Plugin.prototype.enable = function () {
            var $upload = this.$element.find('input[emap-role="upload-input"]');
      $upload.prop('disabled', false).closest('.emap-upload-btn-button').removeClass('bh-disabled');
      this.$element.find('input[name="reUpload"]').prop('disabled', false)
      this.options.disabled = false
            return this.$element;
        };

        /**
         * @method destroy
         * @description 销毁上传实例
         */
        Plugin.prototype.destroy = function () {
            this.options = null;
            $(this.$element).data('cacheupload', false)
                .off('_uploadDelete').off('_uploadSuccess')
                .empty();
        };

        /**
         * @method reload
         * @description 重载token下的数据
         */
        Plugin.prototype.reload = function () {
            var options = this.options;
            this.options.view.clearFileContainer(options);
            var dfd = new $.Deferred();
            WIS_EMAP_UPLOAD.cacheCore.getTokenData(this.$element, this.options).done(function (fileItems) {
                if (fileItems && fileItems.length) {
                    options.view.renderItemsBlock(fileItems, options);
                }
                dfd.resolve();
            });
            return dfd;
        };

        return Plugin;
    })();

    function _init(instance) {
        var element = instance.$element;
        var options = instance.options;
        options.config = options.config || {};
        options.filesToDelete = [];

        _initActions(options);

        options.view = new WIS_UPLOAD_VIEW(instance);

        _eventBind(instance);
        _uploadCoreInit(instance);

    }


    function _initActions(options) {
        options.actions = {
            // 删除临时文件
            deleteTempFile: function (id) {
                return WIS_EMAP_UPLOAD.cacheCore.deleteTempFile(options, id);
            },
            // 删除正式文件
            deleteFormalFile: function (id) {
                return WIS_EMAP_UPLOAD.cacheCore.deleteFormalFile(options, id);
            }
        }
    }

    // 初始化上传核心模块
    function _uploadCoreInit(instance) {
        var element = instance.$element;
        var options = instance.options;
        var isNewToken = options.token === undefined ? true : false;
        WIS_EMAP_UPLOAD.cacheCore.init(element, options, {
            init: function (items) {
                if (items && items.length) {
                    options.view.renderItemsBlock(items, options);
                } else {
                    if (options.readonly === true) {
                        options.list.text($.i18n('bh-cu-none'));
                    }
                }
                // 初始化时，编辑状态下 先删除 原有token下的所有临时文件
                if (options.readonly === false) {
                    if (!isNewToken) {
                        WIS_EMAP_UPLOAD.cacheCore.deleteTempFile(options);
                        setTimeout(function () {
                            element.trigger('bh.file.upload.done', items);
                        }, 0);
                    }
                } else {
                    setTimeout(function () {
                        element.trigger('bh.file.download.done', items);
                    }, 0);
                }

                options.initComplete && options.initComplete(items);
                // 初始化完成后自动调用一次页脚重置
                WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
            },
            add: function (e, data) {
                var files = data.files;
                var tmp = new Date().getTime();
                $(files).each(function (i) {
                    data.files[i].bhId = tmp + i;
                    if (options.limit == 1 && options.view.getFileNum(options, true) > 0) {
                        // 单文件上传模式下的重新上传
                        options.view.reloadBlock(this, options);
                    } else {
                        this.state = 'loading';
                        options.view.renderItemsBlock(this, options)
                        // upload_block.addBlock(this, options);
                    }
                });

                if (options.add) {
                    if (options.add(e, data) === false) { // 若add回调 返回false则终止上传
                        return false;
                    }
                }
            },
            submit: function (e, data) {
                var file = data.files[0];
                // 文件数量限制的校验
                if (options.limit) {
                    var currentCount = options.view.getFileNum(options, true);
                    if (currentCount > options.limit) {
                        data.result = {
                            "error": $.i18n('bh-cu-exceedNumber')
                        };
                        options.view.errorBlock(data, options);
                        WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }

                // 文件的大小 和类型校验
                if (options.type && options.type.length > 0) {
                    if (!new RegExp((options.type.join('|') + '$').toUpperCase().replace(/\s/g, '')).test(file.name.toUpperCase())) {
                        data.result = {
                            "error": $.i18n('bh-cu-typeError')
                        };
                        options.view.errorBlock(data, options);
                        WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }

                if (fileReader && options.size) {
                    if (file.size / 1024 > options.size) {
                        data.result = {
                            "error": $.i18n('bh-cu-exceedSize')
                        };
                        options.view.errorBlock(data, options);
                        WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }
                $('[data-bhid=' + file.bhId + ']', options.list).data('xhr', data);
                if (options.submit) {
                    if (options.submit(e, data) === false) {
                        return false;
                    }
                }
            },
            done: function (e, data) {
                // 上传成功
                if (options.autoSave) {
                    options.view.saveBlock(data, options);
                } else {
                    options.view.successBlock(data, options);
                }
                if (options.done) {
                    options.done(e, data);
                }
                element.trigger('bh.file.upload.done', data);
                WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
            },
            fail: function (e, data) {
                options.view.errorBlock(data, options);
            }
        })
    }

    // 删除文件 参数： 文件id  文件状态  options
    function _deleteFile(fileId, state, isReload, options) {
        var dtd = $.Deferred();
        //  删除临时文件
        if (state == 'success' || state == 'normal') {
            var promise = options.actions.deleteTempFile(fileId);
            var then = 'done';
            if (!promise.done) then = 'then';
            promise[then](function (res) {
                //删除后再显示出原来上传按钮
                !isReload && options.view.removeBlock(fileId, options);
                dtd.resolve();
            })
        } else if (state == 'saved') {
            if (options.autoSave) {
                //自动保存模式下的正式文件删除， 实时发请求
                fileId = fileId.replace(/(_1|_2)$/, '');
                options.actions.deleteFormalFile(fileId + '_1');
                options.actions.deleteFormalFile(fileId + '_2');
                options.actions.deleteFormalFile(fileId).done(function (res) {
                    //删除后再显示出原来上传按钮
                    !isReload && options.view.removeBlock(fileId, options);
                    dtd.resolve();
                })
            } else {
                options.filesToDelete.push(fileId);
                //删除后再显示出原来上传按钮
                !isReload && options.view.removeBlock(fileId, options);
                setTimeout(function () {
                    dtd.resolve();
                }, 0)
            }
        } else if (state == 'error') {
            //删除后再显示出原来上传按钮
            !isReload && options.view.removeBlock(fileId, options);
            setTimeout(function () {
                dtd.resolve();
            }, 0)
        }

        return dtd.promise();
    }


    // 获取排序信息
    function _getSortData(options) {
        var blocks = $('.emap-upload-block-wrap:not(.emap-upload-btn-wrap)', options.list);
        var order_flag = 1;
        var order_map = {};
        blocks.each(function () {
            var self = $(this);
            var file_data = self.data('filedata');
            if (self.hasClass('loading error') || !file_data) {
                return; // 出错和正在上传的文件 不计入排序
            }
            /*
             对于上传的临时文件, 如果带有排序, 则说明是已有正式文件重新上传得到的
             如果没有排序, 则说明是新上传的临时文件

             对于上传的正式文件, 若没有排序, 则添加排序
             */

            if (self.hasClass('success')) {
                order_map[file_data.id] = order_flag;
                order_flag++;
            } else if (self.hasClass('saved')) {
                order_map[file_data.id] = order_flag;
                order_flag++;
            }
        });
        return order_map;
    }

    function _eventBind(instance) {
        var element = instance.$element;
        var options = instance.options;
        // 删除事件绑定
        /*
            e       事件对象
            fileId  文件id
            state   文件状态
            isReload  是否为重新上传
        */
        element.on('_uploadDelete', function (e, fileId, state, isReload) {
            _deleteFile(fileId, state, isReload, options).done(function () {
                element.trigger('bh.file.upload.delete');
            });
        });
        // 重新上传事件
        element.on('_uploadSuccess', function (e, data) {
            var input = e.target;
            var oldData = data;
            WIS_EMAP_UPLOAD.cacheCore.uploadInputInit(input, options, {
                add: function (e, data) {
                    var files = data.files;
                    var input = e.target;
                    var tmp = new Date().getTime();
                    data.files[0].bhId = tmp + 'R';
                    options.view.loadingBlock(files[0], options, input);
                    if (options.add) {
                        if (options.add(e, data) === false) { // 若add回调 返回false则终止上传
                            return false;
                        }
                    }
                },
                submit: function (e, data) {
                    var file = data.files[0];
                    // 文件数量限制的校验
                    if (options.limit) {
                        var currentCount = options.view.getFileNum(options);
                        if (currentCount > options.limit) {
                            data.result = {
                                "error": $.i18n('bh-cu-exceedNumber')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }

                    // 文件的大小 和类型校验 upload
                    if (options.type && options.type.length > 0) {
                        if (!new RegExp((options.type.join('|') + '$').toUpperCase().replace(/\s/g,'')).test(file.name.toUpperCase())) {
                            data.result = {
                                "error": $.i18n('bh-cu-typeError')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }

                    if (fileReader && options.size) {
                        if (file.size / 1024 > options.size) {
                            data.result = {
                                "error": $.i18n('bh-cu-exceedSize')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }
                    $('[data-bhid=' + file.bhId + ']', options.list).data('xhr', data);
                    if (options.submit) {
                        if (options.submit(e, data) === false) {
                            return false;
                        }
                    }
                },
                done: function (e, data) {
                    var input = e.target;
                    var oldFileData = $(input).data('oldfiledata');
                    if (oldFileData) {
                        _deleteFile(oldFileData.fileId, oldFileData.state, true, options).done(function () {
                            element.trigger('bh.file.upload.delete');
                        });
                    }
                    // 上传成功
                    if (options.autoSave) {
                        options.view.saveBlock(data, options);
                    } else {
                        options.view.successBlock(data, options);
                    }
                    if (options.done) {
                        options.done(e, data);
                    }
                    element.trigger('bh.file.upload.done', data);
                    WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                },
                fail: function (e, data) {
                    options.view.errorBlock(data, options);
                }
            })
        })

        // 监听排序完成事件
        element.on('_sort-complete', function (e) {
            e.stopPropagation()
            element.trigger('sort-complete', _getSortData(options))
        })
    }

    $.fn.cacheUpload = function (options, param) {
        var instance;
        instance = this.data('cacheupload');
        if (!instance) {
            return this.each(function () {
                if (options == 'destroy') {
                    return this;
                }
                return $(this).data('cacheupload', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](param);
        return this;
    };

    /**
     * @memberof module:cacheUpload
     * @prop {String} contextPath - emap根路径
     * @prop {String} storeId - 定义的文件类型
     * @prop {String} [buttonType=button] - 上传按钮样式 button 或者block
     * @prop {String} [displayType=image] - 上传文件展示类型 image 或者 file
     * @prop {Int} [width=168] - image 模式下文件展示的宽度
     * @prop {Int} [height=108] - image 模式下文件展示的高度
     * @prop {Int} [limit] - 文件上传个数限制
     * @prop {Array} [type] -  文件格式限制
     * @prop {Int} [size] - 文件大小限制,单位KB
     * @prop {String|Function} [placeholder] - 提示文字，若为function则带参为默认的提示文字，需要拼接后返回
     * @prop {String} [token] - 文件token, 编辑页面传入已有token,则不会生成新的token, 组件会自动拉取该token下已有的文件信息
     * @prop {Boolean} [canPreviewPDF=true] - 是否可以预览pdf文件
     * @prop {Boolean} [readonly=false] - 是否只读
     * @prop {Boolean} [sortable=false] - 是否开启排序
     * @prop {Boolean} [showFileTitle=true] - image模式下，是否显示文件的名称
     * @prop {String|Function} [title] - 自定义上传的显示文件名，只在单个文件上传的情况下生效
     * @prop {function} [initComplete] - 初始化完成的回调
     * @prop {Object} [uploadParam] - 上传请求附带的参数
     * @prop {Boolean} [autoSave=false] - 是否自动保存， 如果为true，则上传完成后自动保存为正式文件，不需要额外调用保存方法，同时保存请求需要传的参数，请配置在uploadParam中
     * @prop {Boolean} [uploadingWarn=true] - 保存方法前是否会判断是否有正在上传的文件并弹出提示框
     * @prop {Boolean} [multiple=true] - 是否允许批量选取文件
     * @prop {String} [tooltipText] - 自定义上传按钮tooltip的内容
     * @prop {Object} [downloadParam] - 下载文件请求附带的参数
     * @prop {Function} [initComplete] - 初始化完成的回调
     * @prop {Array} [editButtons] - 配置操作按钮的显示 默认值 ['preview', 'download', 'reupload', 'delete']
     */

    $.fn.cacheUpload.defaults = {
        // contextPath: "",
        storeId: "file",
        buttonType: "button",
        displayType: "image",
        paramName: 'files[]',
        width: 168,
        height: 108,
        limit: null,
        type: [],
        size: 0,
        token: undefined,
        canPreviewPDF: true,
        readonly: false,
        sortable: false,
        showFileTitle: true,
        title: '',
        initComplete: undefined,
        autoSave: false,
        uploadParam: {},
        uploadingWarn: true,
        multiple: true,
        tooltipText: undefined,
        downloadParam: undefined,
        editButtons: ['preview', 'download', 'reupload', 'delete']
    };
}).call(this);
(function(UPLOAD) {
    UPLOAD.cacheAdaptor = {
        /**
         * @prop uploadUrl
         * @description  文件上传地址
         */
        uploadUrl: WIS_EMAP_SERV.getContextPath() + '/sys/emapcomponent/file/uploadTempFile.do',

        /**
         *
         */
        autoSaveUploadUrl: WIS_EMAP_SERV.getContextPath() + '/sys/emapcomponent/file/uploadTempFileAsAttachment.do',

        /**
         * @prop uploadData
         * @description 上传文件附加的参数
         */
        uploadFormatData: function(data) {
            return data;
        },

        /**
         * @prop uploadCallback
         * @description 上传请求的回调，用于对请求返回的数据做处理， 将数据修改成组件要求的格式
         * @example 要求返回数据格式
           {
                deleteUrl: "/1470800493693911/1c8cd9aca4e948e99ddb75ab95dd21a8.do",
                fileUrl: "/emap/sys/emapcomponent/file/getAttachmentFile/1c8cd9aca4e948e99ddb75ab95dd21a8.do", // 必须
                hasException: false,
                id: "1c8cd9aca4e948e99ddb75ab95dd21a8", // 必须
                isImage: false,
                name: "前端静态资源1.6.2_TR3测试版本发布说明书.doc", // 必须
                size: 56832，
                success: true, // 必须
                tempFileUrl: "/emap/sys/emapcomponent/file/getTempFile/147080049369391/1470800493693911/1c8cd9aca4e948e99ddb75ab95dd21a8.do"
                ts: "2016-11-11 10:27:21"
           }
         */
        uploadCallback: function(res) {
            return res;
        },

        /**
         * @prop deleteTempFileAction
         * @description 删除临时文件的动作
         * @example 要求返回数据格式
         * {
         *  success: true
         * }
         */
        deleteTempFileAction: function(options, id) {
            var defer = $.Deferred();
            // var options = this.options;
            var url = WIS_EMAP_SERV.getContextPath() +
                '/sys/emapcomponent/file/deleteTempFile.do';
            var requestData = {
                scope: options.scope,
                fileToken: options.token
            };
            if (id) {
                requestData.fileWid = id;
                requestData.attachmentParam = JSON.stringify({
                    storeId: options.storeId,
                    items: [{
                        id: id,
                        status: 'Delete'
                    }]
                });
            }

            $.ajax({
                type: "post",
                url: url,
                dataType: "json",
                async: false,
                data: requestData
            }).done(function(res) {
                if (res.success) {
                    defer.resolve(res);
                } else {
                    console.error(res);
                    defer.reject(res);
                }
            }).fail(function(error) {
                $.bhTip && $.bhTip({
                    content: error.msg || $.i18n('bh-cua-deleteTemFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
                defer.reject(error);
            })
            return defer;
        },

        deleteFormalFileAction: function(options, id) {
            var defer = $.Deferred();
            var ajaxOpt = {
                type: "post",
                url: WIS_EMAP_SERV.getContextPath() + '/sys/emapcomponent/file/deleteFileByWid/' + id + '.do',
                dataType: "json",
            };
            $.ajax(ajaxOpt).done(function(res) {
                if (res.success && res.count) {
                    defer.resolve(res);
                } else {
                    if (options.autoSave) return;
                    $.bhTip && $.bhTip({
                        content: res.msg || $.i18n('bh-cua-deleteFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    defer.reject(res);
                }
            }).fail(function(error) {
                $.bhTip && $.bhTip({
                    content: res.msg || $.i18n('bh-cua-deleteFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
                defer.reject(error);
            })
            return defer;

        },

        /**
         * @prop getTokenDataAction
         * @description 获取token下已有文件数据的动作，返回一个priomise对象
         * @example  要求返回数据格式
            {
                "success":true, // 必须
                "items":[  // 必须
                    {
                        "id":"1eb9f6c3d41c4ebdb2e9d43424e19b13",  // 必须
                        "name":"前端框架-组件需求.xlsx",  // 必须
                        "fileUrl":"/emap/sys/emapcomponent/file/getAttachmentFile/1eb9f6c3d41c4ebdb2e9d43424e19b13.do",  // 必须
                        "ts":"2016-11-11 16:21:20",
                        "size":"37862",
                        "orderNum":1,
                        "isImage":false
                    }
                ]
            }
         */
        getTokenDataAction: function(element, options, token) {
            return $.ajax({
                type: "post",
                url: (options.contextPath || WIS_EMAP_SERV.getContextPath()) + '/sys/emapcomponent/file/getUploadedAttachment.do',
                data: {
                    fileToken: token || options.token
                },
                dataType: "json"
            }).fail(function(error) {
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-cua-tokenFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
            });
        },

        /**
         * @prop saveAction
         * @description 保存动作，中间包含删除删除 待删除的正式文件的操作
         * @example 保存动作返回的数据格式
           {
               "success": true, // 必须
               "content": "保存成功！",
               "hasException":false
           }
         */
        saveAction: function(element, options, params) {
            var param_data = params || {};
            var result = $.Deferred();
            var saveOpt = {
                type: "post",
                url: (options.contextPath || WIS_EMAP_SERV.getContextPath()) +
                    "/sys/emapcomponent/file/saveAttachment/{scope}/{fileToken}.do".replace('{scope}', options.scope).replace('{fileToken}', options.token),
                data: param_data,
                dataType: "json",
                success: function(data) {
                    if (data.success) {
                        result.resolve(data);
                    } else {
                        result.reject(data);
                        $.bhTip && $.bhTip({
                            content: data.msg || $.i18n('bh-cua-saveFail'),
                            state: 'danger',
                            iconClass: 'icon-close'
                        });
                    }
                },
                error: function(error) {
                    result.reject(error);
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-cua-saveFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                }
            };
            param_data.fileToken = options.token;
            param_data.scope = options.scope;

            if (options.filesToDelete.length) {
                // 删除 已经删除的正式文件
                var widArray = [];
                options.filesToDelete.map(function(item) {
                    item = item + '';
                    var wid = item.replace(/_[1|2]$/g, "");
                    widArray.push(wid);
                    widArray.push(wid + '_1');
                    widArray.push(wid + '_2');
                });
                saveOpt.data.widsOfAttsToDelete = widArray.join(',');
            }

            $.ajax(saveOpt);
            return result;
        },

        importRownum: function(opt, data) {
            var dfd = $.Deferred();
            $.ajax({
                type: 'post',
                dataType: 'json',
                url: opt.contextPath + '/sys/emapcomponent/imexport/importRownum.do',
                data: data,
                success: function(resp) {
                    dfd.resolve(resp);
                },
                error: function(resp) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-cua-rowFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    dfd.reject(resp);
                }
            });
            return dfd;
        },

        downloadImportTpl: function(opt, data) {
            $.ajax({
                type: 'post',
                url: opt.contextPath + '/sys/emapcomponent/imexport/importTemplate.do',
                data: data,
                dataType: 'json',
                success: function(json) {
                    location.href = (opt.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + json.attachment + '.do');
                },
                error: function(e) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-cua-downloadUrlFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    console && console.log(e);
                }
            });
        },

        importFile: function(opt, data) {
            var dfd = $.Deferred();
            $.ajax({
                type: 'post',
                dataType: 'json',
                url: opt.contextPath + '/sys/emapcomponent/imexport/import.do',
                data: data,
                success: function(resp) {
                    dfd.resolve(resp);
                },
                error: function(resp) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-cua-rowFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    dfd.reject(resp);
                }
            });
            return dfd;
        },

        getImportProgress: function(opt, data) {
            var dfd = $.Deferred();
            $.ajax({
                type: 'post',
                dataType: 'json',
                url: opt.contextPath + '/sys/emapcomponent/imexport/importProgress.do',
                data: data,
                success: function(resp) {
                    dfd.resolve(resp);
                },
                error: function(resp) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-cua-progreeeFail'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    dfd.reject(resp);
                }
            });
            return dfd;
        },

        getDownloadResultUrl: function(opt, result) {
            return opt.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + result.attachment + '.do';
        }

    };
})(WIS_EMAP_UPLOAD = window.WIS_EMAP_UPLOAD || {});

(function (UPLOAD) {
    /**
     * @module WIS_EMAP_UPLOAD.cacheCore
     * @alias 缓存上传核心模块
     * @description 这是封装了emap上传逻辑的功能模块，与WIS_UPLOAD_VIEW模块组合在一起构成cacheUpload组件
     */
    UPLOAD.cacheCore = $.extend({}, {
        /**
         * @method init
         * @description 初始化
         * @param {Object} element - dom对象
         * @param {Object} options - 配置
         * @param {Object} cbObj - 包含回调函数的对象 init add submit done
         */
        init: function (element, options, cbObj) {
            // 初始化adaptor
            options.adaptor = options.adaptor || UPLOAD.cacheAdaptor;

            options.filesToDelete = [];
            cbObj = cbObj || {};
            if (options.autoSave) {
                options.uploadUrl = options.adaptor.autoSaveUploadUrl;
            } else {
                options.uploadUrl = options.adaptor.uploadUrl;
            }
            // 获取已有token下的所有文件
            if (options.token !== undefined && options.token !== '') {
                WIS_EMAP_UPLOAD.cacheCore.getTokenData(element, options).done(function (fileItems) {
                    cbObj.init && cbObj.init(fileItems);
                });
            } else {
                options.scope = new Date().getTime() + "" + parseInt(Math.random() * 100).toString();
                options.token = options.scope + 1;
                cbObj.init && cbObj.init();
            }

            this.uploadInputInit(element, options, cbObj);
        },

        uploadInputInit: function (element, options, cbObj) {
            var formData = {
                scope: options.scope,
                fileToken: options.token,
                size: options.size,
                type: options.type,
                storeId: options.storeId,
                isSingle: options.isSingle == "1" ? "1" : "0",
                fileName: options.fileName ? options.fileName : ""
            };
            $.extend(formData, options.uploadParam);
            if (options.adaptor.uploadFormatData) {
                formData = options.adaptor.uploadFormatData(formData, options);
            }
            var fileInput;
            if ($(element)[0].nodeName === 'INPUT' && $(element).attr('type') === 'file') {
                fileInput = $(element);
            } else {
                options.fileInput = fileInput = options.fileInput || $('input[type=file]', element);
            }

            fileInput.fileupload({
                url: options.uploadUrl,
                autoUpload: (options.autoUpload === false ? false : true),
                multiple: (options.multiple === false ? false : true),
                dataType: 'json',
                paramName: options.paramName,
                limitMultiFileUploads: 10,
                formData: formData,
                add: function (e, data) {
                    var isSubmit;
                    if (cbObj.add) {
                        isSubmit = cbObj.add(e, data);
                    }
                    if (isSubmit === undefined) {
                        data.submit();
                    }
                },
                submit: function (e, data) {
                    if (cbObj.submit) {
                        if (cbObj.submit(e, data) === false) {
                            return false;
                        }
                    }
                },
                done: function (e, data) {
                    if (options.adaptor.uploadCallback) {
                        data.result = options.adaptor.uploadCallback(data.result, options);
                    }
                    if (data.result.success) {
                        // 上传成功
                        if (cbObj.done) {
                            cbObj.done(e, data);
                        }

                    } else {
                        $.bhTip && $.bhTip({
                            content: data.result.msg || $.i18n('bh-cuc-uploadFail'),
                            state: 'danger',
                            iconClass: 'icon-close'
                        });
                        if (cbObj.fail) {
                            cbObj.fail(e, data);
                        }
                    }
                    WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                },
                fail: function (e, data) {
                    if (data.textStatus != 'abort') {
                        $.bhTip && $.bhTip({
                            content: $.i18n('bh-cuc-uploadFail'),
                            state: 'danger',
                            iconClass: 'icon-close'
                        });
                    }
                    cbObj.fail(e, data);
                }
            });
        },

        getTokenData: function (element, options) {
            var defer = $.Deferred();
            if (options.readonly && (options.token instanceof Array || options.token.indexOf(',') > -1)) {
                // 兼容只读模式下多token的情况
                var token = options.token;
                if (typeof token === 'string') {
                    token = token.split(',');
                }
                var length = token.length;
                var i = 0;
                var filesArray = [];
                token.map(function (tokenItem) {
                    if (!tokenItem) return console && console.warn('token为空！');
                    options.adaptor.getTokenDataAction(element, options, tokenItem).done(function (res) {
                        i++;
                        if (res.success) {
                            if (res.items) {
                                filesArray = filesArray.concat(res.items);
                            }
                        } else {
                            $.bhTip && $.bhTip({
                                content: res.msg || $.i18n('bh-cua-tokenFail'),
                                state: 'danger',
                                iconClass: 'icon-close'
                            });
                        }

                        if (i === length) {
                            defer.resolve(filesArray);
                            // cbObj.init && cbObj.init(filesArray);
                        }
                    });
                })
            } else {
                if (typeof options.token !== 'string') {
                    console && console.error('token必须为字符串！多token批量下载请将readonly设置为true')
                }
                if (!options.token) return console && console.warn('token为空！');
                options.adaptor.getTokenDataAction && options.adaptor.getTokenDataAction(element, options).done(function (res) {
                    if (res.success) {
                        // if (res.items) {
                            defer.resolve(res.items || []);
                            // cbObj.init && cbObj.init(res.items);
                        // }
                    } else {
                        $.bhTip && $.bhTip({
                            content: res.msg || $.i18n('bh-cua-tokenFail'),
                            state: 'danger',
                            iconClass: 'icon-close'
                        });
                    }
                });
                options.scope = options.token.substring(0, options.token.length - 1);
            }
            return defer;
        },

        /**
         * @method save
         * @description 缓存上传的保存操作
         * @param {Object} element - dom对象
         * @param {Object} options - 配置对象
         * @param {Object} [param] - 请求附带的参数
         */
        save: function (element, options, params) {
            return options.adaptor.saveAction(element, options, params);
        },

        /**
         * @method deleteTempFile
         * @description 删除临时文件
         */
        deleteTempFile: function (options, id) {
            return options.adaptor.deleteTempFileAction(options, id);
        },

        /**
         * @method deleteFormalFile
         * @description 删除正式文件
         */
        deleteFormalFile: function (options, id) {
            return options.adaptor.deleteFormalFileAction(options, id);
        },

        importRownum: function (options, data) {
            return options.adaptor.importRownum(options, data);
        },

        downloadImportTpl: function (options, data) {
            return options.adaptor.downloadImportTpl(options, data);
        },

        importFile: function (options, data) {
            return options.adaptor.importFile(options, data);
        },

        getImportProgress:function(options, data){
            return options.adaptor.getImportProgress(options, data);
        },

        getDownloadResultUrl: function (options, result) {
            return options.adaptor.getDownloadResultUrl(options, data);
        }

    }, UPLOAD.cacheCore || {});

})(WIS_EMAP_UPLOAD = window.WIS_EMAP_UPLOAD || {});
/*
    直接上传组件： 不存在token和临时文件的概念等、不需要保存操作
    需要指定：
        上传地址 uploadUrl
        上传参数 uploadParam
        上传成功的回调 （用于处理请求参数）  options.done
            返回参数格式必须处理为
                {
                    fileUrl: "",//上传成功后的图片地址
                    id: "465084e9ed85449fa717d661ae82722d",
                    success: true/false,
                    name: "file.png"
                }

        删除文件请求地址 deleteUrl   (删除谓词POST)
        删除文件请求参数 deleteParam (json类型)
        删除请求之前的回调（用于处理请求参数） --
        删除请求成功的回调（用于处理请求参数） --
            要求返回格式
                {
                    success: true
                }

        已有文件的数据（要求格式， 包含文件id和文件url）
            要求格式
                [
                    {
                        id: "zzxczxczxc",
                        fileUrl: "asdasdasdsad"
                    },
                    {
                        id: "zzxczxczxc",
                        fileUrl: "asdasdasdsad"
                    }
                ]

*/

/**
 * @module directUpload
 * @alias 直接上传
 * @description 直接上传组件，公有云使用，emap环境不能使用
 */
(function () {
    var Plugin;
    var fileReader = 'FileReader' in window;
    var upload_block;

    Plugin = (function () {
        function Plugin(element, options) {
            this.options = $.extend({}, $.fn.directUpload.defaults, options);
            this.$element = $(element);
            _init(this);
        }


        /**
         * @method destroy
         * @description 销毁上传实例
         */
        Plugin.prototype.destroy = function () {
            this.options = null;
            $(this.$element).data('directupload', false)
                .off('_uploadDelete').off('_uploadSuccess')
                .empty();
        };

        return Plugin;
    })();

    function _init(instance) {
        var element = instance.$element;
        var options = instance.options;
        options.config = options.config || {};
        //检查uploadUrl，如果没有，则报错
        //options.uploadUrl = WIS_EMAP_SERV.getContextPath() + '/sys/emapcomponent/file/uploadTempFile.do';
        if(!options.uploadUrl || typeof options.uploadUrl !== 'string'){
            console && console.error('directupload error: uploadUrl must be given!');
            return;
        }
        if(!options.deleteUrl || typeof options.deleteUrl !== 'string'){
            console && console.error('directupload error: deleteUrl must be given!');
            return;
        }

        _initActions(options);

        options.view = new WIS_UPLOAD_VIEW(instance);

        _uploadCoreInit(instance);
        _eventBind(instance);
    }


    function _initActions(options) {
        options.actions = {
            // 删除文件
            deleteFile: function (id) {
                var defer = $.Deferred();
                var params = $.extend({}, options.deleteParam, {id: id}, true);
                $.ajax({
                    type: "post",
                    url: options.deleteUrl,
                    dataType: "json",
                    //async: false,
                    data: params
                }).done(function (res) {
                    if(res.success === undefined && res.datas) {
                        res = res.datas;
                    }
                    if (res.success) {
                        defer.resolve(res);
                    } else {
                        defer.reject(res);
                    }
                }).fail(function (error) {
                    defer.reject(error);
                });
                return defer;
            }
        }
    }

    // 初始化上传核心模块
    function _uploadCoreInit(instance) {
        var element = instance.$element;
        var options = instance.options;

        WIS_EMAP_UPLOAD.directCore.init(element, options, {
            init: function () { //
                //渲染原有图片
                if(options.imagesUrl instanceof Array && options.imagesUrl.length > 0) {
                    var _items = [];
                    // if(!options.imagesUrl instanceof Array) {
                    //  options.imagesUrl = [options.imagesUrl];
                    // }

                    $(options.imagesUrl).each(function (i, v) {
                        if(v && typeof(v) == 'object'){
                            //新方法，原有图片传入id
                            var _data = {};
                            _data.bhId = v.id;
                            _data.name = v.fileUrl.replace(/(.*\/)*(.*)([\?\!#]+.*)/ig, "$2");
                            _data.fileUrl = v;
                            _data.state = 'saved';
                            _items.push(_data);
                        } else if(v && typeof(v) == 'string') {
                            //兼容原方法
                            var _data = {};
                            _data.bhId = new Date().getTime() + i;
                            _data.name = v.replace(/(.*\/)*(.*)([\?\!#]+.*)/ig, "$2");
                            _data.fileUrl = v;
                            _data.state = 'saved';
                            _items.push(_data);
                        }
                    });

                    options.view.renderItemsBlock(_items, options);
                }
                //绑定删除方法
                options.deleteFileCallback = _deleteFile;
            },
            add: function (e, data) {
                var files = data.files;
                var tmp = new Date().getTime();
                $(files).each(function (i) {
                    data.files[i].bhId = tmp + i;
                    if (options.limit == 1 && options.view.getFileNum(options, true) > 0) {// 单文件上传模式下的重新上传
                        options.view.reloadBlock(this, options);
                    } else if (options.reloadBlock) { // 多文件模式下的重新上传
                        options.view.loadingBlock(this, options);
                    } else {
                        this.state = 'loading';
                        options.view.renderItemsBlock(this, options)
                    }
                });

                if (options.add) {
                    if (options.add(e, data) === false) { // 若add回调 返回false则终止上传
                        return false;
                    }
                }
            },
            submit: function (e, data) {
                var file = data.files[0];
                // 文件数量限制的校验
                if (options.limit) {
                    var currentCount = options.view.getFileNum(options);
                    if (currentCount > options.limit) {
                        data.result = {
                            "error": $.i18n('bh-cu-exceedNumber')
                        };
                        options.view.errorBlock(data, options);
                        // WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }

                // 文件的大小 和类型校验
                if (options.type && options.type.length > 0) {
                    if (!new RegExp((options.type.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                        data.result = {
                            "error": $.i18n('bh-cu-typeError')
                        };
                        options.view.errorBlock(data, options);
                        // WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }

                if (fileReader && options.size) {
                    if (file.size / 1024 > options.size) {
                        data.result = {
                            "error": $.i18n('bh-cu-exceedSize')
                        };
                        options.view.errorBlock(data, options);
                        // WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                        return false;
                    }
                }

                $('[data-bhid=' + file.bhId + ']', options.list).data('xhr', data);
                if (options.submit) {
                    if (options.submit(e, data) === false) {
                        return false;
                    }
                }
            },
            done: function (e, data) {
                //兼容swagger返回格式
                if(data.result.success == undefined) {
                    data.result = data.result.datas;
                }

                if (data.result.success) {

                    // 上传成功
                    if (!data.result.tempFileUrl) {  // 由于直接上传不存在临时文件的概念，所以此处将tempFileUrl设置为文件的fileUrl
                        data.result.tempFileUrl = data.result.fileUrl;
                    }

                    options.view.successBlock(data, options);
                    if (options.done) {
                        options.done(e, data);
                    }

                } else {
                    console && console.error('文件上传失败');
                    options.view.errorBlock(data, options);
                    if (options.fail) {
                        options.fail(e, data)
                    }
                }

                // WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
            },
            fail: function (e, data) {
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-atom-uploadFail'),
                    state: 'danger',
                    iconClass: 'icon-close'
                });
            }
        });

    }

    // 删除文件 参数： 文件id  文件状态  options
    function _deleteFile(fileId, state, isReload, options) {
        var dtd = $.Deferred();
        //  删除临时文件
        if (state == 'success' || state == 'saved' || state == 'normal') {
            options.actions.deleteFile(fileId).done(function (res) {
                //删除后再显示出原来上传按钮
                !isReload && options.view.removeBlock(fileId, options);
                dtd.resolve();
            }).fail(function (e, data) {
                dtd.reject();
            })
        } else if (state == 'error') {
            //删除后再显示出原来上传按钮
            !isReload && options.view.removeBlock(fileId, options);
            dtd.resolve();
        }

        return dtd.promise();
    }


    function _eventBind(instance) {
        var element = instance.$element;
        var options = instance.options;
        // 删除事件绑定
        /*
            e       事件对象
            fileId  文件id
            state   文件状态
            isReload  是否为重新上传
        */
        element.on('_uploadDelete', function (e, fileId, state, isReload) {
            _deleteFile(fileId, state, isReload, options);
        });

        // 重新上传事件
        element.on('_uploadSuccess', function (e, data) {
            var input = e.target;
            var oldData = data;
            WIS_EMAP_UPLOAD.directCore.inputInit(input, options, {
                add: function (e, data) {
                    var files = data.files;
                    var input = e.target;
                    var tmp = new Date().getTime();
                    data.files[0].bhId = tmp + 'R';
                    options.view.loadingBlock(files[0], options, input);
                    if (options.add) {
                        if (options.add(e, data) === false) { // 若add回调 返回false则终止上传
                            return false;
                        }
                    }
                },
                submit: function (e, data) {
                    var file = data.files[0];
                    // 文件数量限制的校验
                    if (options.limit) {
                        var currentCount = options.view.getFileNum(options);
                        if (currentCount > options.limit) {
                            data.result = {
                                "error": $.i18n('bh-cu-exceedNumber')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }

                    // 文件的大小 和类型校验 upload
                    if (options.type && options.type.length > 0) {
                        if (!new RegExp((options.type.join('|') + '$').toUpperCase()).test(file.name.toUpperCase())) {
                            data.result = {
                                "error": $.i18n('bh-cu-typeError')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }

                    if (fileReader && options.size) {
                        if (file.size / 1024 > options.size) {
                            data.result = {
                                "error": $.i18n('bh-cu-exceedSize')
                            };
                            options.view.errorBlock(data, options);
                            return false;
                        }
                    }
                    $('[data-bhid=' + file.bhId + ']', options.list).data('xhr', data);
                    if (options.submit) {
                        if (options.submit(e, data) === false) {
                            return false;
                        }
                    }
                },
                done: function (e, data) {
                    var input = e.target;
                    var oldFileData = $(input).data('oldfiledata');
                    if (oldFileData) {
                        _deleteFile(oldFileData.fileId, oldFileData.state, true, options).done(function () {
                            element.trigger('bh.file.upload.delete');
                        });
                    }
                    // 上传成功
                    //兼容swagger返回格式
                    if(data.result.success == undefined) {
                        data.result = data.result.datas;
                    }
                    //直接上传，使用tmpUrl代替fileUrl
                    data.result.tempFileUrl = data.result.fileUrl

                    if (options.autoSave) {
                        options.view.saveBlock(data, options);
                    } else {
                        options.view.successBlock(data, options);
                    }
                    if (options.done) {
                        options.done(e, data);
                    }
                    element.trigger('bh.file.upload.done', data);
                    WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
                },
                fail: function (e, data) {
                    options.view.errorBlock(data, options);
                }
            })
        })
    }

    $.fn.directUpload = function (options, param) {
        var instance;
        instance = this.data('directupload');
        if (!instance) {
            return this.each(function () {
                return $(this).data('directupload', new Plugin(this, options));
            });
        }
        if (options === true) return instance;
        if ($.type(options) === 'string') return instance[options](param);
        return this;
    };

    /**
     * @memberof module:directUpload
     * @prop {String} storeId - 定义的文件类型
     * @prop {String} [buttonType=button] - 上传按钮样式 button 或者block
     * @prop {String} [displayType=image] - 上传文件展示类型 image 或者 file
     * @prop {Int} [width=168] - image 模式下文件展示的宽度
     * @prop {Int} [height=108] - image 模式下文件展示的高度
     * @prop {Int} [limit=] - 文件上传个数限制
     * @prop {Array} [type=] -  文件格式限制
     * @prop {Int} [size=] - 文件大小限制,单位KB
     * @prop {Boolean} [canPreviewPDF=true] - 是否可以预览pdf文件
     * @property {String} uploadUrl - 上传url
     * @property {Object} uploadParam - 上传附件参数
     * @property {String} deleteUrl - 上传url
     * @property {Object} deleteParam - 上传附件参数
     */

    $.fn.directUpload.defaults = {
        storeId: "file",
        buttonType: "button",
        displayType: "image",
        width: 168,
        height: 108,
        limit: null,
        type: [],
        size: 0,
        token: undefined,
        canPreviewPDF: true
    };
}).call(this);
(function (UPLOAD) {
    /**
     * @module WIS_EMAP_UPLOAD.directCore
     * @alias 直接上传核心模块
     * @description 这是封装了直接上传逻辑的功能模块，与WIS_UPLOAD_VIEW模块组合在一起构成directUpload组件，现在公有云中使用
     */
    UPLOAD.directCore = $.extend({}, {
        /**
         * @method init
         * @description 初始化
         * @param {Object} element - dom对象
         * @param {Object} options - 配置
         * @param {Object} cbObj - 包含回调函数的对象 init add submit done
         */
        init: function (element, options, cbObj) {
            cbObj = cbObj || {};

            cbObj.init && cbObj.init();

            this.inputInit(element, options, cbObj);
        },

        // 初始化上传核心模块
        inputInit: function (element, options, cbObj) {
            var formData = $.extend({}, {
                size: options.size,
                type: options.type,
                storeId: options.storeId
            }, options.uploadParam || {});

            var fileInput;
            if ($(element)[0].nodeName === 'INPUT' && $(element).attr('type') === 'file') {
                fileInput = $(element);
            } else {
                options.fileInput = fileInput = options.fileInput || $('input[type=file]', element);
            }

            fileInput.fileupload({
                url: options.uploadUrl,
                autoUpload: true,
                multiple: true,
                dataType: 'json',
                limitMultiFileUploads: 10,
                formData: formData,
                add: function (e, data) {
                    if (cbObj.add) {
                        cbObj.add(e, data);
                    }
                    data.submit(e, data);
                },
                submit: function (e, data) {
                    if (cbObj.submit) {
                        if (cbObj.submit(e, data) === false) {
                            return false;
                        }
                    }
                },
                done: function (e, data) {
                    if (cbObj.done) {
                        cbObj.done(e, data);
                    }
                },
                fail: function (e, data) {
                    if (cbObj.fail) {
                        cbObj.fail(e, data);
                    }
                },
                progressall: function (e, data) {
                    if(cbObj.progress){
                        cbObj.progress(e, data);
                    }
                }
            });
        }

    }, UPLOAD.directCore || {});

})(WIS_EMAP_UPLOAD = window.WIS_EMAP_UPLOAD || {});
(function () {
    /**
     * @module emapUpload
     * @alias emap缓存上传
     * @description emap缓存上传，配置参数和api方法请参阅 {@link ./module-cacheUpload.html|aaa}
     * @example
        $('#upload').emapUpload({
            contextPath: '/emap',
            buttonType: 'button'
        })
     */
    $.fn.emapUpload = function () {
        // return $(this).cacheUpload(arguments);
        return $.fn.cacheUpload.apply($(this), arguments);
    }
})();
(function ($) {
    /**
     * @module WIS_UPLOAD_VIEW
     * @alias 上传视图模块
     * @description 上传 视图模块， 封装了上传组件view部分的相关api
     */
    WIS_UPLOAD_VIEW = (function () {
        function WIS_UPLOAD_VIEW(instance) {
            var element = instance.$element;
            var options = instance.options;
            options.wrap = $('<div class="bh-clearfix" style="clear: none;" emap-role="upload-container"></div>');
            options.list = $('<div class="bh-clearfix emap-upload-list-container" emap-role="upload-list"></div>');
            options.wrap.append(options.list);
            if (options.readonly) {
                options.list.addClass('emap-readonly');
            }
            element.append(options.wrap);
            upload_block.renderUploadButton(options);
            options.fileInput = $('input[type=file]', options.wrap);
            eventBind(options);
        }

        // api
        WIS_UPLOAD_VIEW.prototype = {
            /**
             * @method renderItemsBlock
             * @description 根据文件信息将文件列表渲染到组件上
             * @param {Object|Array} items - 文件信息json数据,多个文件时为数组
             * @param {Object} options - 上传组件options对象
             */
            renderItemsBlock: function (items, options) {
                if (items instanceof Array) {
                    $(items).each(function () {
                        addItem(this, options);
                    });
                } else {
                    addItem(items, options);
                }

                function addItem(item, options) {
                    var state = item.state || 'saved';
                    upload_block.addBlock(item, state, options);
                    if (_isSingleBlock(options)) {
                        options.list.parent().find('.emap-upload-btn-wrap').addClass('bh-hide');
                    }
                }
            },

            /**
             * @method getFileNum
             * @description 获取组件视图中文件数量
             * @param {Object} options - 上传组件options对象
             * @param {Boolean} [flag=false] - 是否包含错误文件与上传中文件 默认 不包含
             * @return {Int} - 文件数量
             */
            getFileNum: function (options, flag) {
                var selector = '.emap-upload-block-wrap:not(.emap-upload-btn-wrap)';
                if (flag !== true) {
                    selector += ':not(.error):not(.loading)';
                }
                return $(selector, options.wrap).length;
            },

            /**
             * @method reloadBlock
             * @description 重新上传一个block
             * @param {Object} data -  文件信息
             *  {
             *      name: xxx,
             *      bhId: xxx,
             *      fileUrl: xxx,
             *      size: xxx
             *  }
             * @param {Object} options - 上传组件options对象
             */
            reloadBlock: function (data, options) {
                upload_block.reloadBlock(data, options);
            },

            /**
             * @method loadingBlock
             * @description 将一个block 的状态变为loading
             * @param {Object} data - fileUpload 返回的文件信息
             * @param {Object} options - 上传组件options对象
             * @param {Object} input - 上传file dom
             */
            loadingBlock: function (data, options, input) {
                upload_block.loadingBlock(data, options, input);
            },

            /**
             * @method successBlock
             * @description 将一个block 的状态变为success
             * @param {Object} data - fileUpload 返回的文件信息
             * @param {Object} options - 上传组件options对象
             */
            successBlock: function (data, options) {
                upload_block.successBlock(data, options);
            },

            /**
             * @method saveBlock
             * @description 将一个block saved
             * @param {Object} data - fileUpload 返回的文件信息
             * @param {Object} options - 上传组件options对象
             */
            saveBlock: function (data, options) {
                if (data) {
                    upload_block.successBlock(data, options, 'saved');
                } else {
                    // 保存动作后将所有success的block 变为saved
                    $('.emap-upload-block-wrap', options.list).each(function () {
                        if ($(this).hasClass('success') || $(this).hasClass('normal')) {
                            // 将success文件转换为saved文件
                            $(this).removeClass('success').removeClass('normal').addClass('saved');
                        }
                    });
                }
            },

            /**
             * @method errorBlock
             * @description 将一个block error
             * @param {Object} data - fileUpload 返回的文件信息
             * @param {Object} options - 上传组件options对象
             */
            errorBlock: function (data, options) {
                upload_block.errorBlock(data, options);
            },

            /**
             * @method removeBlock
             * @description 将一个block 移除
             * @param {String} fileId - 文件的wid
             * @param {Object} options - 上传组件options对象
             */
            removeBlock: function (fileId, options) {
                var block = $('[data-fileid=' + fileId + ']', options.wrap);
                if (block.length == 0) {
                    block = $('[data-bhid=' + fileId + ']', options.wrap);
                }
                if (_isSingleBlock(options)) {
                    block.parent().find('.emap-upload-btn-wrap').removeClass('bh-hide');
                }
                block.remove();
            },

            /**
             * @method hasLoadingFile
             * @description 判断当前组件中是否有正在上传的文件
             * @param {Object} options - 上传组件options对象
             * @return {Boolean} - 是否有正在上传的文件
             */
            hasLoadingFile: function (options) {
                return $('.emap-upload-block-wrap.loading', options.list).length > 0;
            },

            /**
             * @method isSorting
             * @description 判断当前组件是否正在排序
             * @param {Object} options - 上传组件options对象
             * @return {Boolean} - 是否有正在排序
             */
            isSorting: function (options) {
                return options.list.parent().hasClass('emap-upload-sorting');
            },

            /**
             * @method clearFileContainer
             * @description  清空当前文件列表容器内所有的文件dom
             * @param {Object} options - 上传组件options对象
             */
            clearFileContainer: function (options) {
                options.list.empty();
            }
        }
        return WIS_UPLOAD_VIEW;
    })();
    var upload_block = {
        // 渲染上传按钮
        renderUploadButton: function (options) {
            var buttonHtml;
            if (options.buttonType == 'block') {
                buttonHtml = $('<div class="emap-upload-block-wrap emap-upload-btn-wrap"><div class="emap-upload-block emap-upload-btn" ' + upload_block.getBlockStyle(options) + ' ><div class="emap-upload-cell" style="height:' + (options.height - 8) + 'px;">' +
                    '<i class="iconfont icon-addcircle emap-upload-icon-add"></i>' +
                    '<span class="iconfont icon-info emap-upload-shuoming ">'+ $.i18n('bh_up_annotation') +' </span>' +
                    '<input type="file" emap-role="upload-input" class="emap-upload-input" ' + ((options.limit != 1 && options.multiple === true) ? 'multiple' : '') + '>' +
                    '</div>' +
                    '</div>' +
                    (options.showFileTitle && options.title ? '<p class="emap-upload-name" title="' + getFileTitle(options) + '">' + getFileTitle(options) + '</p>' : '') +
                    '</div>');
                if (options.readonly) {
                    buttonHtml.css({
                        'display': 'none'
                    });
                }
                options.list.append(buttonHtml);
            } else if (options.buttonType == 'button') {
                buttonHtml = $('<p class="bh-mb-16"><a class="bh-btn bh-btn-default emap-upload-btn-button" href="javascript:void(0)">' +
                    '<i class="iconfont icon-fileupload"></i>' +
                    ((options.limit != 1 && options.multiple === true) ? $.i18n('bh_up_batchUpload'): '<span>'+ $.i18n('bh_up_uploadFile') +'</span>') +
                    '<input type="file" emap-role="upload-input" ' + ((options.limit != 1 && options.multiple === true) ? 'multiple' : '') + ' >' +
                    '</a>' +
                    '<span class="bh-color-caption">' + _getInfoText(options) + '</span>' +
                    '</p>');
                if (options.readonly) {
                    buttonHtml.css({
                        'display': 'none'
                    });
                }
                if (options.sortable) {
                    var sortButtons = $('<div class="bh-l-inline bh-mr-8"><button class="bh-btn bh-btn-default emap-upload-start-sort" emap-role="sort-file" style="margin-left: 0"><i class="iconfont icon-importexport"></i>'+ $.i18n('bh_up_sortFile') +'</button>' +
                        '<div class="emap-upload-sort-btns"><button class="bh-btn bh-btn-primary" emap-role="save-sort" style="margin-left: 0">'+ $.i18n('bh_up_completeSorting') +'</button><span class="bh-text-caption bh-color-caption bh-ph-8">'+ $.i18n('bh_up_dragToSort') +'</span></div>' +
                        '</div>');
                    buttonHtml.find('.emap-upload-btn-button').after(sortButtons);
                }

                options.list.before(buttonHtml);
            }
        },

        // 拼接block宽高样式
        getBlockStyle: function (options) {
            return 'style="width: ' + options.width + 'px; height: ' + options.height + 'px;"'
        },

        /***
         * @method addBlock
         * @description 添加一个上传项
         * @param {Object} data - 文件信息json数据
         * @param {String} state - 文件状态 success saved loading
         * @param {Object} options - 组件options对象
         */
        addBlock: function (data, state, options) {
            var blockItem;
            if (options.buttonType == 'block') {
                blockItem = upload_block.renderBlockItem(data, state, options);
                var $btn = $('.emap-upload-btn', options.list);
                if ($btn.length === 0) {
                    upload_block.renderUploadButton(options);
                    $btn = $('.emap-upload-btn', options.list);
                }
                $btn.parent().before(blockItem);
                // 显示文件名称
                if (options.showFileTitle && !options.title) {
                    $('.emap-upload-name', blockItem).text(data.name).attr('title', data.name);
                }
                if (_isSingleBlock(options)) {
                    $btn.parent().addClass('bh-hide');
                }


            } else if (options.buttonType == 'button') {
                if (options.limit == 1) {
                    $('.emap-upload-btn-button span', options.wrap).attr('disabled', true).html($.i18n('bh_up_uploadAgain'));
                    $('input[type=file]', options.wrap).addClass('emap-upload-single');
                }
                blockItem = upload_block.renderBlockItem(data, state, options);
                options.list.append(blockItem);
                if (options.displayType == 'file') {
                    _resizeFilenameLength(blockItem);
                }
            }

            if (options.displayType == 'image') {
                // 对于展示缩略图的情况。宽度不够的时候自动铺满
                var imgs = $('.emap-upload-img', options.list);
                if (imgs.length) {
                    imgs.on('load', function () {
                        var height = $(this).height();
                        var width = $(this).width();
                        var optWidth = options.width - 8;
                        var optHeight = options.height - 8;
                        if (height < optHeight && width < optWidth) {
                            if ((width / height) < (optWidth / optHeight)) {
                                $(this).height(optHeight);
                            } else {
                                $(this).width(optWidth);
                            }
                        }
                    })
                }
            }
            if (state === 'saved') {
                setTimeout(function() {
                    $('input[type=file]', blockItem).trigger('_uploadSuccess', data);
                })
            }
        },

        // 文件的重新上传 (单文件的重新上传)
        reloadBlock: function (data, options) {
            var block = $('[data-bhid]', options.list);

            if (!options.deleteFileCallback) {
                options.list.trigger('_uploadDelete', [block.attr('data-fileid') || block.data('bhid'), _getFileState(block), true])
            }
            /*
             重新上传时给block 添加标记位
             */
            block.data('bhid', data.bhId).attr('data-bhid', data.bhId);
            block.data('file_data', data);
            if (data.name) {
                if (options.displayType == 'image') {
                    $('.emap-upload-name', block).text(data.name);
                } else {
                    $('.filename', block).text(data.name);
                }
            }

            // _deleteFile(block, options).done(function () {
            //  upload_block.addBlock(data, 'loading', options);
            // });
            // block.addClass('loading');

        },

        // 渲染单个文件
        renderBlockItem: function (data, state, options) {
            var itemHtml = '';
            var readonly = options.readonly;
            data.bhId = data.bhId || data.id; // 渲染正式文件时， 若没有bhId  则将文件id（fileId）作为bhId，此情况一般出现在渲染上传组件原有文件时
            if (options.displayType == 'image') {
                itemHtml += '<div class="emap-upload-block-wrap {{state}}" data-bhid="{{bhId}}" style="width:' + (options.width + 2) + 'px">' +
                    '<div class="emap-upload-block "   {{style}}>' +
                    // loading
                    '<div class="emap-upload-cell emap-upload-loading-cell" style="height: ' + (options.height - 8) + 'px;width: ' + (options.width - 8) + 'px;">' +
                    '<p class="emap-upload-loading-cell-size">{{size}}</p>' +
                    '<img src="{{loadingIcon}}">' +
                    '<p><a href="javascript:void(0)" emap-role="upload-cancel">'+ $.i18n('bh_up_cancelTheUpload') +'</a></p>' +
                    '</div>' +
                    // file
                    '<div class="emap-upload-cell emap-upload-file-cell" style="height: ' + (options.height - 8) + 'px;width: ' + (options.width - 8) + 'px;">' +
                    upload_block.renderFileDetail(data.name, data.middleSizeImageUrl || data.fileUrl, options) + // 列表中展示小图片
                    '</div>' +

                    // edit
                    '<div class="emap-upload-cell emap-upload-mask emap-upload-cell-edit ' + _getblockClass(data.name, options) + '" >' +
                    '<a href="javascript:void(0)" emap-role="upload-reupload">' +
                    '<i class="iconfont icon-fileupload"></i>'+$.i18n('bh_up_uploadAgain') +
                    '<input type="file" name="reUpload">' +
                    '</a>' +
                    '<a href="javascript:void(0)"  emap-role="upload-preview"><i class="iconfont icon-findinpage"></i>' + $.i18n('bh-uv-preview') + '</a>' +
                    '<a href="javascript:void(0)" emap-role="upload-down"><i class="iconfont icon-filedownload"></i>' + $.i18n('bh-fd-download') + '</a>' +
                    '<a href="javascript:void(0)" emap-role="upload-delete"><i class="iconfont icon-delete"></i>' + $.i18n('bh-uv-delete') + '</a>' +
                    '</div>' +

                    // error
                    '<div class="emap-upload-cell emap-upload-error-cell" style="height:' + (options.height - 8) + 'px">' +
                    '<p class="emap-upload-error-icon"><i class="iconfont icon-close"></i></p>' +
                    '<p class="emap-upload-error-text">' + $.i18n('bh-uv-uploadFail') + '</p>' +
                    '<p>' +
                    // '<a href="javascript:void(0)" class="bh-mh-4" emap-role="upload-reupload">重新上传</a>' +
                    '<a href="javascript:void(0)" class="bh-mh-4" emap-role="upload-delete">' + $.i18n('bh-uv-delete') + '</a>' +
                    '</p>' +
                    '</div>' +
                    '<div class="emap-upload-cell emap-upload-mask emap-upload-sort-icon"><i class="iconfont icon-dehaze" style="line-height: ' + options.height + 'px"></i></div>' +
                    '</div>' +
                    '<p class="emap-upload-name" title="{{fileName}}" style="width: ' + options.width + 'px;">{{fileName}}</p>' +
                    '</div>';
                if ('FileReader' in window) {
                    itemHtml = itemHtml.replace('{{size}}', _getFileSize(data.size / 1024));
                } else {
                    itemHtml = itemHtml.replace('{{size}}', '');
                }

                itemHtml = itemHtml.replace('{{state}}', state)
                    .replace('{{style}}', upload_block.getBlockStyle(options))
                    .replace('{{bhId}}', data.bhId)
                    .replace('{{loadingIcon}}', _getLoadingGIF());
                if (_isSingleBlock(options)) {
                    itemHtml = itemHtml.replace(/\{\{fileName\}\}/g, options.title ? getFileTitle(options, data) : '');
                } else {
                    itemHtml = itemHtml.replace(/\{\{fileName\}\}/g, data.name);
                }


                itemHtml = $(itemHtml);
                if (options.displayType == 'image' && options.showFileTitle === false) {
                    $('.emap-upload-name', itemHtml).hide();
                }
                if (state == 'saved') {
                    itemHtml.data('filedata', data);
                } else {
                    itemHtml.data('file', data);
                }
                return itemHtml;
            } else if (options.displayType == 'file') {

                //added by zsl on 2016.8.11
                itemHtml += '<div class=" emap-upload-block-wrap emap-upload-file-wrap {{state}} {{support-rate}} ' + _getblockClass(data.name, options) + '" data-bhid="{{bhId}}">' +
                    '<span class="bh-icon-file-type {{filetype}}">{{filetype}}</span>' +
                    '<span class="filename" title="{{filename}}">{{filename}}</span>' +
                    '<span class="state-icon"></span>' +
                    '<span class="result-fail">' + $.i18n('bh-uv-uploadFail') + '！</span>' +
                    '<span class="result-success">' + $.i18n('bh-uv-uploadSuccess') + '！</span>' +
                    '<a class="cancel" emap-role="upload-cancel" href="javascript:void(0)">' + $.i18n('bh-uv-cancelUpload') + '</a>' +
                    '<a class="error-reupload" emap-role="upload-reupload" href="javascript:void(0)">' +
                    $.i18n('bh-uv-reupload') +
                    '<input type="file" name="reUpload">' +
                    '</a>' +
                    '<a class="fail-reupload" emap-role="upload-reupload" href="javascript:void(0)">' +
                    $.i18n('bh-uv-retry') +
                    '<input type="file" name="reUpload">' +
                    '</a>' +
                    (_canPreview(data.name, options) ? '<a class="view" emap-role="upload-preview" href="javascript:void(0)">' + $.i18n('bh-uv-preview') + '</a>' : '') +
                    '<a class="download" emap-role="upload-down" href="javascript:void(0)">' + $.i18n('bh-fd-download') + '</a>' +
                    '<a class="del" emap-role="upload-delete" href="javascript:void(0)">' + $.i18n('bh-uv-delete') + '</a>' +
                    '<span class=" rate">{{uploadrate}}</span>' +
                    '<div class="progress">' +
                    '   <div class="bar" style="width: {{uploadpercent}}%;"></div>' +
                    '</div>' +
                    '</div>';

                if ('FileReader' in window) {
                    itemHtml = itemHtml.replace('{{size}}', '<p >' + _getFileSize(data.size) + '</p>');
                }
                //替换是否支持速度、bhid、filetype、filename、uploadrate、uploadpercent
                itemHtml = itemHtml.replace('{{state}}', (state === 'saved' ? 'saved' : 'loading'))
                    .replace(/\{\{support-rate\}\}/g, _isSupportRate() ? 'state-support-rate' : '')
                    .replace(/\{\{filetype\}\}/g, function () {
                        var sfx = data.name.match(/\.[^\.]+$/);
                        if (sfx) {
                            return sfx[0].substr(1).toUpperCase();
                        } else {
                            return '';
                        }
                    })
                    .replace(/\{\{filename\}\}/g, data.name)
                    .replace('{{bhId}}', data.bhId);
                if (_isSupportRate()) {
                    itemHtml = itemHtml.replace(/\{\{uploadrate\}\}/g, '0KB/s')
                        .replace(/\{\{uploadpercent\}\}/g, '0');
                }

                itemHtml = $(itemHtml);
                if (state == 'saved') {
                    itemHtml.data('filedata', data);
                } else {
                    itemHtml.data('file', data);
                }
                return itemHtml;
            }
        },

        renderFileDetail: function (name, url, options) {
            var fileHtml = "";
            if (_isImage(name)) {
                // 图片
                fileHtml += '<img class="emap-upload-img"  ' + (url ? ' src="' + url + '"' : '') + '" style="max-height: ' + (options.height - 8) + 'px;max-width: ' + (options.width - 8) + 'px;" />';
            } else {
                fileHtml += '<div class="emap-upload-img-file ' + _getIconByFileName(name) + '"></div>';
            }
            return fileHtml;
        },

        loadingBlock: function (data, options, input) {
            var block = $(input).closest('.emap-upload-block-wrap');
            $(input).data('oldfiledata', {
                state: block[0].className.match(/(success|saved|error|normal)/)[0],
                fileId: block.data('filedata').id
            })
            block.removeClass('success saved error normal').addClass('loading').data('bhid', data.bhId).attr('data-bhid', data.bhId);
            if (options.displayType == 'image') {
                var file_name = '';
                if (options.showFileTitle) {
                    if (_isSingleBlock(options) && options.title) {
                        file_name = getFileTitle(options, data);
                    } else {
                        file_name = data.name;
                    }
                }
                $('.emap-upload-name', block).text(file_name).attr('title', file_name);
                if ('FileReader' in window) {
                    $('.emap-upload-loading-cell-size', block).text(_getFileSize(data.size / 1024));
                }
            } else if (options.displayType == 'file') {
                $('span.filename', block).text(data.name).attr('title', data);
                var suffix = data.name.match(/\.(\w+$)/)[1].toUpperCase();
                $('.bh-icon-file-type', block).html(suffix).attr('class', 'bh-icon-file-type ' + suffix);
            }
        },

        // 将上传block的状态从loading 改变为success
        successBlock: function (data, options, state) {
            var bhId = data.files[0].bhId;
            var result = data.result;
            var block = $('[data-bhid=' + bhId + ']', options.list);
            var state = state || 'success';
            var url = state === 'saved' ? result.fileUrl : result.tempFileUrl;

            block.attr('data-fileid', data.result.id);
            if (options.displayType == 'image') {
                block.removeClass('loading error').addClass(state).data('filedata', result);
                if (_isImage(result.name)) {
                    $('.emap-upload-file-cell img', block).attr('src', url)
                        .css({
                            "height": options.height - 8,
                            "width": options.width - 8
                        });
                }
                if (options.limit == 1) {
                    $('.emap-upload-btn-button', options.wrap).attr('disabled', false);
                }

                $('.emap-upload-file-cell', block).html(upload_block.renderFileDetail(result.name, url, options));
                // 显示上传成功图标
                var successCell = $('<div class="emap-upload-cell emap-upload-mask emap-upload-cell-success" style="display: block;">' +
                    '<p class="emap-upload-success-icon"><i class="iconfont icon-check"></i></p>' +
                    '<p>' + $.i18n('bh-uv-uploadSuccess') + '</p>' +
                    '</div>');
                $('.emap-upload-block', block).append(successCell);
                successCell.css('opacity', 1);
                var editCell = $('.emap-upload-cell-edit', block);
                // 添加操作图标
                editCell.removeClass('emap-upload-cell-edit_3 emap-upload-cell-edit_4 emap-upload__preview emap-upload__delete emap-upload__download emap-upload__reupload');
                editCell.addClass(_getblockClass(result.name, options))
                // if (_canPreview(result.name, options)) {
                //  editCell.addClass('emap-upload-cell-edit_4');
                // } else {
                //  editCell.addClass('emap-upload-cell-edit_3');
                // }
                setTimeout(function () {
                    successCell.css({
                        top: '-101%'
                    });
                    setTimeout(function () {
                        successCell.remove();
                    }, 250);
                }, 2000);
            } else if (options.displayType == 'file') {
                if (state === 'saved') {
                    block.removeClass('normal');
                }
                block.removeClass('loading').addClass(state).data('filedata', result);
                _resizeFilenameLength(block);
                setTimeout(function () {
                    block.addClass('normal').removeClass('success');
                    //状态改变后重新计算filename长度
                    _resizeFilenameLength(block);
                }, 2000);
            }

            options.wrap.trigger('bh.file.upload.done', data);
            // 触发事件
            $('input[type=file][name=reUpload]', block).trigger('_uploadSuccess', data);
        },
        // 上传出错将block 变为error状态
        errorBlock: function (res, options) {
            var bhId = res.files[0].bhId;
            var result = res.result || {
                "error": $.i18n('bh-uv-canceled')
            }; // 点击取消上传时, res 没有result, 此时错误提示应为 已取消
            var block = $('[data-bhid=' + bhId + ']', options.list);
            if (options.displayType == 'image') {

                result.error = result.error || $.i18n('bh-uv-uploadFail');
                block.removeClass('success loading').addClass('error');
                $('.emap-upload-error-text', block).text(result.error);
                if (options.limit == 1) {
                    $('.emap-upload-btn-button', options.wrap).attr('disabled', false);
                }

            } else if (options.displayType == 'file') {

                if (options.limit == 1) {
                    $('.emap-upload-btn-button', options.wrap).attr('disabled', false);
                }
                //错误、失败两种状态
                if (result && result.error) {
                    block.removeClass('success loading').addClass('error');
                    $('.result-fail', block).text(result.error);
                } else {
                    block.removeClass('success loading').addClass('fail');
                    $('.result-fail', block).text($.i18n('bh-uv-uploadFail') + '！');
                }
                //状态改变时重新计算文件名长度
                _resizeFilenameLength(block);
            }
        },

        editBlock: function () {

        }
    };

    // 判断是否为block模式下的单文件上传
    function _isSingleBlock(options) {
        if (options.displayType && options.buttonType && options.limit) {
            return options.displayType === 'image' && options.buttonType === 'block' && options.limit === 1;
        } else {
            return false;
        }
    }

    // 文件列表模式下重新计算文件名长度
    function _resizeFilenameLength(block) {
        //重置长度
        $('.filename', block).css('max-width', '');

        block = $(block);
        //总长
        var totalWidth = block.get(0).clientWidth;
        //偏移
        var offset = 80;
        if (block.hasClass('normal') || block.hasClass('saved')) {
            offset = 180;
        }

        //其它元素宽度
        var otherWidth = 0;
        $('.filename', block).siblings().each(function () {
            otherWidth += this.offsetWidth;
        });
        //剩余长度
        var remainWidth = totalWidth - otherWidth - offset;
        //文件名原长度
        var oWidth = $('.filename', block).get(0).offsetWidth;

        if (oWidth > remainWidth) {
            $('.filename', block).css('max-width', remainWidth + 'px');
        }
    }

    // loading icon gif base64
    function _getLoadingGIF() {
        return 'data:image/gif;base64,R0lGODlhIAAgAPYAAP///4qEhPz8/PHw8Ono6Orp6fb29v39/fr6+t7c3Lu3t6mkpK2pqcjFxevq6vn5+eTj46yoqIuFhZeSkvDv7/T09NLPz9XT0/j4+MnGxpWQkKKdnd7d3e/u7u3s7MG+vqWgoJyXl56ZmdbU1L+8vJCKipmUlNfV1bGtrfX19cfExJiTk4+JidjW1paRkeXk5JSOjo6IiJuWlsbDw+Lh4aahoZKMjL67u8zKysvJyZSPj8nHx93b25+bm9/e3s3Ly6ijo+zr69TS0uHg4Obl5efl5bOvr5qVlcrIyMPAwL66usTBwY2Hh+Df39nX18K/v87MzLm1tbq2ttza2u7t7bWystvZ2drY2MC9vejm5sXCwrKurqCcnOPi4vLx8fv7+/f39/Py8p2YmLazs7SxsfPz8725uQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4yNjQeGCCkCjoYpBDQFKYMCHDMElYQeKgw1DA1BkAg5QAmhghUfKxK0Jh8VBwcOPBWFFR0PiQIJILTGGwmQALmEKUtGTgiIDxYhxrUW0ocEGyUKBogIFyLXEiEnlIcVz9GIBwQMLNcMRMrqHsGJBiMLGjYuC4RgeFXoAAYPLVSQ2OEDHMFBCCBkIJGBwwAD6Rwx45QggoYSAF+8cmDBAoVBAxSUu5GvUYUnE0zscEhgQbkFvRxRMEJLQc4CDMoxyNkIA5QaC0YMBGCgwQRjLnBkbGSACBGHyxwo2GBiA4mTDwtS4HAigQOMYQ89eGEhBy97iZg2uoOAQsYEED82xSVigcZSdSRgGAMyJC6HGi42ZEPUAUUMYyFGKEOAQRtTEiVoRaGCqIKCzLRA+AAgoAiSJCdyYlABg0kJKUQLdtSgo8eMAbqMwCjRwwK4d0ZqGJkytdCDBDM+WOhwQJwMY0Y8CDrgoUkBy4gEVKiQD4GQI7RKRCcENxQB3bwt/E1LmsYMJSbZFxJggLujQAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEgwcVVFQpB4WNjo4PEEkoKEsvD4+ZjQI0RhoSEhpGEAKapgAVSxOgoBNJFaeFBg4EFQJBRkysoEZBsYIHDg0oDFhNREa7EiW9vwADJKsSOihOSdKgLq+CFRWMjwI8G7sTGTwoMKA2W0OlqUkDmQhCIcokFUVaDAwzBAjcUaI4yCTAyjhWK3JgQpAiBYJvAG4FKZWJgpJPEmAwgOBM3osnDCIoSIChYyMMBYYQCUKg1j+ThDA4MbIAhQVbMAsdGBKhBKgNJyDGQgDBAgGKD35gK0ECk7MORkIogAXgAY6lTTt6iCKDRDwAB5r0lMBiQwuhpxB0MUoRgAEnVZxq3syJFgDKIQQM5NQk4IAADA/q7nXLAQkUf6ceOOR7ZcGKI1GyCB6UwgKJESUfVVCQTsIRKE4dHbDSo0SNJhWjsJqAJHPEtmBHmJDAZUomDDhEMIGxIEGpAwWECCnQtoOSCEu+asYRRcoVvQA8SDGxIgoVQhVqmTqAgQJOsDx6gOrBY7LJISBAgRhivmOFHCFzUB2MvUiR+fQHBwIAIfkECQoAAAAsAAAAACAAIAAAB/+AAIKDhIUAB4aJiokHFUVdQQ+Lk4YHDksLNUYjFZSeABRPKxISJUAtkgcPGAieDwMFAwgCPkBMpBI6HwMYRBY4Jw4CixhOClsKPBUtXLilUQQnWyImGwovX4m0CyUlOgwJTRHOLk8XESW4LgpUiQYNOrgmOUEqR6QsEU4ZJs4SCxwQFUqRBAYuDRkMVLBghMGHLhWWxHO2ocWwQghOcIkhgQkIJ4gOKMQA4AGUe7hYAPFxsVAFFQt6RMgxQFEXFDbkfeigCEGFJi2GVBBoCMMVIz1CbLhBpJUhBBhCEu1ZwIkQHhSmCsJAQIiQAi09IZilrcmWEDKMQPhUSFW2QQa1VGggpUGLU7YAPEBxYmBQBRLpSim4y5YGil2DEFjg0m2DhbCfKnBoSqgCDiNGLNTEO+lACg8OOnEeTdoTBgNaSw86QADJEh+SKKUg4CU1oQ5RNMAACLnQgxw1lFCYBGEDKRNQYitKoQBGhCKTgmyBUeLj3QcUhg4ScEUKFNGKHjiJknkzAAwjoiQhQNQnSUoIKATpO8jBuCM53qsmVIBBiSM46LefIAZcoB57AxaCQXaEJUhaIAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhQcCB4WKi4yCBgRTTRSJjZWFDxdbG0BLBJSWlQdEDCUSEmIZFaCKCGAIgggtYqYSJVEOAhVFEEEPlgMtGRdBAghOIrS2BQQqDAtRLSmNFSobGj1JHQceYzC1GxYvWEemJRFTr4tFC7Q1CQAITQoLDBYePDW0EhpJqosvNZiY2mBF0IEKHSg8ENCihz5bHhhVUGCihIkoBBg1WVDKlIkZ/hQdeKHCyJImvhYN0NIjhgQYKDikW3TQQYWZigQ4yGGEgQIhQVLgXLUIQ5AuV3AsyXBlwCcwHQYMtXQAgoIeLkwAQeJvAI4tRloYIAqgAgkX+jZcACBgCoiXDLUyEiWQTx8MBfAshBjogywBhw/JADhAA8WEIwqCkA0SgYU+HUkEpeDRAAeRqY0e5GhpCgaDIYMQpDDwiaiHHQt6bIhyZSxZRge7OJlCAMNrUAdKK6pQIIxuRohAdViyQIEnS0GQJMA86MAVLqcspGyUYIEK17B9RNAB5MpMASlsEwJGRIClFC1ICAkp4EUDCyEFBQeFoMKDTwZUHInQ5fftQQ9YUANG/1VCAQcviFcgcP4tWGAgACH5BAkKAAAALAAAAAAgACAAAAf/gACCg4SFhoeIiQAYQURBD4qRhQ88UREKPBiSkgcFRjASMFFFB4OlmwgPpwc+GxKvQDwCAAgdRUGaiQcOFxZEkAcvESUSJQxdAgYJCgxRIxWJHVg9MlEQpRU/QGILFhUIQ1s6oQtWkIdDNa89FucVHBZN0Bg/Mq8SKzPQhgdEwxIbTpwTdAqAgRxH7rl4MgBRCgsoIjToULAQAh4LSjApAUJILn4ViNAYUNFQBQsMNkTYQVHRgZKHBFR4YYUHgQEYYG4CmWDHEgsEEBR6uXMQghYoTGgQoYDAqQdELFjZt7ODEWKvTGRIAWCXAjEgLgyUBKHHvWJGOnSFsECCCxVcyHcScXWvRBQqgjwkqcFgitCdA6KMeyUGSS4BHXy8MFCUVoIqXEKASFKg4AEBOhEdMBAEQgsoP1oEmdWYEAICOaKgUGDBQc7ShYJgEfEKxgIhcQ8d6PDCS2YEFjYwuSeKAGlDHT4sQEK1kAEtg++BsHK8EIEtExSoPZRiSfRXNaZUJ1Thwo1MhAS8Bs7lrA4jpBI9+Jb+BVBBQZ70sFFCQwTcpT0AkROlCFAADlEYocAJze0kgH0OmFKBAwVQ8FFpAqgC24YcdhgIACH5BAkKAAAALAAAAAAgACAAAAf/gACCg4SFhoeIiYIHD1+Kj4cYL0JTFAKQmAddRj1AOQOYkA9QJhIlW0QHgweqkAeXgw8WMqZGBKoHFC9EFa2IBl1XQbACRWYgDBYVAAcESgsRM0G+hQIJWyBJHoMIDlMQvQApSLQSG0IYiBgNExILPtSFFAolEhIrWsuHCC0RPQq3ElVoUIoFF2UCr1jo8kARAghSNtTAQgDWoQMIMFhM9IDAFR4OGobKxOrBg40jESEIcuXECwOEDmCogCAlAAEQonDpkQwmswpCZjQRGWrAk3amUEAQhGAIChkfQI0kgKKevR4nBhFQEAGKvlBBolhlAoIHtwJdpI5MIQSIDhgiyT50KBTP1QMPFqJE2VGkps1BAgb4GNGiCwECFVCmPBAkw4IeIG4wfFS3UAoLG+xJCJFkrkAeBPwCAFNg14AvBaLA0CwhwpDKN4cwyFCGGYUfDLiAUJCgSVXWC5rAZoxkCoYDFTBrnmDkwo0VmmFEIaDoQIqGOH9rlpGhRZUjOiZEuJAilAAeNVhLgIHFwZAdCpJM+QpJQJMITFjrmEGzQocK6aQUhBIuaBYDCC0Q9RcADzRhhAklwACCCp4tGMsLGUShxAUdKFZIIAAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4wCFR0pB4yTggUZChYVlIwIFhsaKBCSm4mdIiULNKMAGBQUD4wYYbCDBElGUJqCFRZSCk4pigZXWjwYgwgUBRUCggddDDAuRkTNiARGRwpBig8jIRISNTwIiQMqEUgDis8MLiZRRauGAg4cQdaJBk4kT8aLBwTMS/SAwgBapBIq7DaAgoGBACBOqiAkSpQfHlY9cABB16YHToDAkLABioFBA3ZEaSIxUYUMLsKViEJlUIoTOwi0RGTgBzgJLpR4ZFWhHKkDL6L0EIGixTFDAXcaegDhRw4eQwUJoOBjxBUCJxcJEIAgRQWEg+qpWMBlQ5QrYdEPpSiSoGPLCkh6lAinwQiNfIQqjDBSg0GODhAP0EARrnGIHBUOgPFSFAACDhFGlthgIVghBFNqxGgsQQMWBzRUGMEUpAKUnxJ0KOkAdQgD0hJWLJlixESJElxUELHQo/GED7QNeXhigonMBRYyyCC9oAUHIy5KwAAyIi4hBEOicJkQIgKUISR0kBZhYcAUKSiMWKCQCMPwGTmmuJqxgvSGFghgQEAXBETGDgYVpFDOAzwssFduUhAwSEALpWDBFhvUoMAQaC0kiH1XcNCBUYoEAgAh+QQJCgAAACwAAAAAIAAgAAAH/4AAgoOEhYaHiImKi4wAB18HjZIADwQ+HZGTi0FPKFAVmotEKCEfA4QPBg+Nj5mCFRZPPBiDFS0NLaCKAh0+A64CKRS0ggJDDCYMCQiKBhZbLcSICE5cEhsXq4kPTTtEzIkHBQoRJASuiBgV2ooIlgTshQcCCAIH6Lv26Q4+Vl0UAkIdejAESwQgKHZ4wLfoAAYMAQEIIBJlhQQJJUTk0NXInYUcPkClsNDjoskIRBgiCoJFxJEtHBAM+ODC5EUuHFQaOjBkwUUxPwxUaGDCpgQQTSI2JGBERwkQQh48uBKhhEkYChaySjEiCooMDu51QFJjAgwZDKZIa1SBSJcO4OB4nVCBRYUFHwUqKGV0z9CDCgVOfNgSBQeBvYUEVOigNxGCF1GOlIDBRUuHaUR2KMjwDVEKHEdsApkCjtABB1gkH1FQQGWFJzpsirBQIUUQAlRWCfDh8+ICHqUJVchQ9CKTDSOCXJCC4kMTDAiGVMW4wEfwQQg4MNDBRMLqJiMWwJBgIsqLBx1UbDCxYYnWQ7aiRGBAggMBmia5WDCAoICFJRYQcJ1pFRDAQRMO2KZEbBf1AIUBACBQAQWNLSLAhZHA0kN3JUTAQzwCRVjAEkBwwYAFFIRoCC9XXBCSToQEAgA7AAAAAAAAAAAA';
    }

    // 拼接上传 提示文字
    function _getInfoText(options) {
        var infoHtml = [];
        if (options.type && options.type.length > 0) {
            infoHtml.push($.i18n('bh-uv-onlySupport') + options.type.join("，").toLowerCase() + $.i18n('bh-uv-typeFile'));
        }
        if (options.size) {
            infoHtml.push($.i18n('bh-uv-fileSize') + _getFileSize(options.size) + $.i18n('bh-uv-within'));
        }

        if (options.tooltipText) {
            if (typeof options.tooltipText === 'function') {
                return options.tooltipText(infoHtml.join('; '));
            } else {
                return options.tooltipText;
            }
        }
        return infoHtml.join('; ');
    }

    // 获取文件大小文字 自动转换单位
    function _getFileSize(size) {
        size = parseInt(size * 10) / 10;
        return size < 1024 ? size + ' KB' : parseInt(size / 1024 * 10) / 10 + 'MB';
    }

    // 获取文件block的状态
    function _getFileState(ele) {
        var stateArray = ['success', 'saved', 'normal', 'loading', 'error'];
        var stateArrayLen = stateArray.length;
        for (var i = 0; i < stateArrayLen; i++) {
            if (ele.hasClass(stateArray[i])) {
                return stateArray[i];
            }
        }
        return '';
    }

    function _isImage(fileName) {
        return /\.(jpg$|jpeg$|png$|gif$)/.test(fileName.toLowerCase());
    }

    function _canPreview(fileName, options) {
        options = options || {};
        var previewArray = ['gif', 'jpg', 'jpeg', 'png'];
        if (options.canPreviewPDF) {
            previewArray.push('pdf');
        }
        return previewArray.filter(function (item) {
            return new RegExp('.' + item + '$').test(fileName.toLowerCase())
        }).length > 0;
    }

    // 根据文件和配置信息状态 获取不同的class，控制block中可选的操作项
    function _getblockClass(fileName, options) {
        var readonly = options.readonly;
        var count = 0;
        var classList = [];
        if (options.editButtons) {
            if ($.inArray('download', options.editButtons) > -1) {
                count++;
                classList.push('download');
            }
            if ($.inArray('preview', options.editButtons) > -1 && _canPreview(fileName, options)) {
                count++;
                classList.push('preview');
            }
            if ($.inArray('delete', options.editButtons) > -1 && !readonly) {
                count++;
                classList.push('delete');
            }
            if ($.inArray('reupload', options.editButtons) > -1 && !readonly) {
                count++;
                classList.push('reupload');
            }
        }
        return 'emap-upload-cell-edit_' + count + ' ' + classList.map(function (item) {return 'emap-upload__' + item}).join(' ');
    }

    // 根据文件后缀名获取展示的icon图片地址
    function _getIconByFileName(fileName) {
        var urlMap = {
            "(doc|docx)": "doc",
            "(xls|xlsx)": "xls",
            "(ppt|pptx)": "ppt",
            "psd": "psd",
            "cpt": "cpt",
            "zip": "zip",
            "other": "other"
        };

        for (var k in urlMap) {
            if (new RegExp('.' + k + '$').test(fileName)) {
                return urlMap[k];
            }
        }
        return urlMap['other'];
    }

    function _isSupportRate() {
        return false;
    }

    function _isPDF(fileName) {
        return /\.pdf$/.test(fileName.toLowerCase());
    }

    // 获取文件的标题， 用来处理title参数可能为字符串或者函数（只在单个文件上传且设置了title参数的情况下会生效）
    function getFileTitle (options, fileData) {
        var title = options.title
        if (typeof title === 'string') {
            return title
        } else if (typeof title === 'function') {
            return title(options, fileData)
        }
    }

    function eventBind(options) {
        if (options.buttonType == 'block') {
            // 上传按钮为block 形式下, hover上去显示 上传说明的气泡弹窗
            options.list.on('mouseover', '.emap-upload-btn-wrap', function () {
                if ($.bhPopOver) {
                    $.bhPopOver({
                        selector: $(this),
                        title: null,
                        showCloseButton: false,
                        width: 200,
                        content: '<p style="word-wrap:break-word">' + _getInfoText(options) + '</p>'
                    });
                }
            }).on('mouseout', '.emap-upload-btn-wrap', function () {
                $.bhPopOver.close();
            });
        }

        // 点击删除
        options.list.on('click', '[emap-role="upload-delete"]', function (e) {
      if (options.disabled === true) return
      var block = $(this).closest('.emap-upload-block-wrap');
            //有回调删除，调用回调删除；没有时采用事件机制
            if (options.deleteFileCallback) {
                options.deleteFileCallback(block.data('fileid') || block.data('bhid'), _getFileState(block), false, options).fail(function () {
                    //删除失败，请稍后重试
                    if ($.bhPopOver) {
                        $.bhPopOver({
                            selector: $(block),
                            width: 220,
                            title: null,
                            content: '<p class="bh-mb-16"><i class="iconfont icon-info bh-color-danger"></i>' + $.i18n('bh-uv-deleteFileFail') + '</p>' +
                                '<div class="emap-upload-loading-popover bh-text-center">' +
                                '<a class="bh-btn bh-btn-primary bh-mh-8" emap-role="upload-pop-confirm" href="javascript:void(0)">' + $.i18n('bh-uv-confirm') + '</a>' +
                                '</div>',
                            ready: function (popover) {
                                // 确定
                                popover.on('click', '[emap-role="upload-pop-confirm"]', function () {
                                    $.bhPopOver.close();
                                });
                            }

                        });
                    } else {
                        console && console.info('文件删除失败，重新上传取消');
                    }

                });
            } else {
                options.list.trigger('_uploadDelete', [block.attr('data-fileid') || block.data('bhid'), _getFileState(block)]);
            }
        });

        //  点击下载
        options.list.on('click', '[emap-role="upload-down"]', function () {
            var block = $(this).closest('.emap-upload-block-wrap');
            if (block.hasClass('success') || block.hasClass('normal')) {
                // 临时文件
                window.open(block.data('filedata').tempFileUrl);
            } else if (block.hasClass('saved')) {
                // 正式文件
                var paramArray = [];
                var paramStr = ''
                if (options.downloadParam) {
                    for (var v in options.downloadParam) {
                        paramArray.push(v + '=' + options.downloadParam[v]);
                    }
                    if (paramArray.length) {
                        paramStr = '?' + paramArray.join('&');
                    }
                }
                WIS_EMAP_SERV.downloadFile(block.data('filedata').fileUrl + paramStr, true);
                // window.open(block.data('filedata').fileUrl + paramStr);
            }
        });

        // 点击取消上传
        options.list.on('click', '[emap-role="upload-cancel"]', function () {
            var target = $(this);
            if ($.bhPopOver) {
                $.bhPopOver({
                    selector: $(this),
                    width: 220,
                    title: null,
                    content: '<p class="bh-mb-16"><i class="iconfont icon-info bh-color-danger"></i>' + $.i18n('bh-uv-uploading') + '</p>' +
                        '<div class="emap-upload-loading-popover bh-text-center">' +
                        '<a class="bh-btn bh-btn-primary bh-mh-8" emap-role="upload-pop-confirm" href="javascript:void(0)"><i class="iconfont icon-check"></i></a>' +
                        '<a class="bh-btn bh-btn-default bh-mh-8" emap-role="upload-pop-cancel" href="javascript:void(0)"><i class="iconfont icon-close"></i></a>' +
                        '</div>',
                    ready: function (popover) {
                        // 取消
                        popover.on('click', '[emap-role="upload-pop-cancel"]', function () {
                            $.bhPopOver.close();
                        });
                        // 确认
                        popover.on('click', '[emap-role="upload-pop-confirm"]', function () {
                            var xhr = $(target).closest('.emap-upload-block-wrap').data('xhr');
                            xhr.abort();
                            $.bhPopOver.close();
                            $(target).closest('.emap-upload-block-wrap').parent().find('.emap-upload-btn-wrap').removeClass('bh-hide');

                            //block.parent().find('.emap-upload-btn-wrap').removeClass('bh-hide');

                            if (_isSingleBlock(options)) {
                                $('.emap-upload-btn', options.list).parent().addClass('bh-hide');
                            } else {
                                $(target).closest('.emap-upload-block-wrap').remove();
                            }
                        });
                    }

                });
            }
        });

        // 点击预览
        options.list.on('click', '[emap-role="upload-preview"]', function () {
            if (!$.bhGallery) {
                console && console.warn('图片轮播插件Gallery未引入');
                return;
            }
            var block = $(this).closest('.emap-upload-block-wrap');
            var imgSource = [];
            var imgUrlArr = [];
            var show = 0;
            var file_url;
            if (block.hasClass('saved')) {
                file_url = block.data("filedata")['fileUrl'];
            } else if (block.hasClass('success') || block.hasClass('normal')) {
                file_url = block.data("filedata")['tempFileUrl'];
            }

            // 预览pdf
            if (_isPDF(block.data("filedata")['name'])) {
                $.emapPDFViewer({
                    url: file_url
                });
                return;
            }

            // 预览图片
            $('.emap-upload-block-wrap:not(.emap-upload-btn-wrap)', options.list).each(function () {
                var file_data = $(this).data("filedata");

                if (_canPreview(file_data.name, options)) {
                    if (_isPDF(file_data.name)) return true;

                    if ($(this).hasClass('saved')) {
                        imgUrlArr.push(file_data['fileUrl']);
                    } else if ($(this).hasClass('success') || $(this).hasClass('normal')) {
                        imgUrlArr.push(file_data['tempFileUrl']);
                    }
                }
            });

            $(imgUrlArr).each(function (i) {
                if (file_url == this) {
                    show = i;
                }
                imgSource.push({
                    image: this
                })
            });
            $.bhGallery({
                dataSource: imgSource,
                show: show
            });


        });

        //文件排序
        options.list.parent().on('click', '[emap-role="sort-file"]', function (e) {
            var $delegate = $(e.delegateTarget);
            var $fileWrap = $delegate.find('.emap-upload-block-wrap:not(.emap-upload-btn-wrap)');
            if ($fileWrap.length) {
                if ($fileWrap.length === 1) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-uv-noSort'),
                        state: 'warning'
                    });
                    return;
                }
                var loading = $fileWrap.filter('div.error').length;
                var fail = $fileWrap.filter('div.loading').length;
                var num = loading + fail;
                if (num) {
                    var button = [{
                        text: $.i18n('bh-uv-toDeal'),
                        className: 'bh-btn-primary',
                        callback: $.noop
                    }];
                    BH_UTILS.bhWindow($.i18n('bh-uv-has') + num + $.i18n('bh-uv-uploadsort'), $.i18n('bh-uv-prompt'), button, {
                        width: 368,
                        height: 240
                    });
                    return;
                }
                $delegate.addClass('emap-upload-sorting');
                var $list = $delegate.find('[emap-role="upload-list"]');
                var sorter = Sortable.create($list[0], {
                    filter: '.emap-upload-btn-wrap',
                    dataIdAttr: 'data-bhid'
                });
                $delegate.data('sorter', sorter);
                $delegate.data('sorterOrder', sorter.toArray());
            } else {
                $.bhTip && $.bhTip({
                    content: $.i18n('bh-uv-noFileSort'),
                    state: 'warning'
                });
            }
        });

        //完成排序
        options.list.parent().on('click', '[emap-role="save-sort"]', function (e) {
            var $delegate = $(e.delegateTarget);
            var sorter = $delegate.data('sorter');
            sorter.destroy();
            $delegate.removeData('sorter');
            $delegate.removeData('sorterOrder');
            $delegate.removeClass('emap-upload-sorting');
            $delegate.trigger('_sort-complete')
        });

        //取消排序
        options.list.parent().on('click', '[emap-role="cancel-sort"]', function (e) {
            var $delegate = $(e.delegateTarget);
            var sorter = $delegate.data('sorter');
            var order = $delegate.data('sorterOrder');
            sorter.sort(order);
            sorter.destroy();
            $delegate.removeClass('emap-upload-sorting');
        });
    }
})(jQuery);
/***
 * 使用缓存的后端上传机制。
 * 注册名称为 'EMAP_IMPORT_CACHE',
 *
 * 必须包含的接口：
 *     - init(view, options) // 初始化
 *     - downloadImportTpl(opt, data) // 下载模板
 *
 * 可选支持的回调事件：
 *     - onUploading(result) // 正在上传
 *     - onRownumImported(resp) // rownum计算成功
 *     - onFileImported(json, opt) // 文件上传成功
 *     - onImportError() // 上传失败
 */
(function(win, undefined) {
    var importAdaptor = {
        init: function(view, options, downTplData) {
            var fileReader = 'FileReader' in window;

            var callbacks = {
                add: function(e, data) {
                    var file = data.files;
                    var fileType = file[0].name.split('.');
                    var result = {
                        file: file,
                        fileReader: fileReader,
                        isSuccess: /^(xlsx|xlsm|xltx|xltm|xlsb|xlam|xls)$/i.test(fileType.slice(-1)[0])
                    };
                    options.onUploading && options.onUploading(result, data);
                    return false;
                },
                done: function(e, data) { //设置文件上传完毕事件的回调函数
                    var mid = data.result.id;
                    downTplData.attachment = data.result.id;
                    var params = {
                        attachmentParam: JSON.stringify({
                            scope: options.scope,
                            fileToken: options.token,
                            attachmentParam: {
                                storeId: downTplData.storeId
                            }
                        })
                    };
                    WIS_EMAP_UPLOAD.cacheCore.save(view, options, params).done(function() {
                        var data = $.extend(downTplData, {
                            app: downTplData.app,
                            attachment: mid
                        });
                        WIS_EMAP_UPLOAD.cacheCore.importRownum(options, data).done(function(resp) {
                            options.onRownumImported && options.onRownumImported(resp);

                            downTplData.read && delete downTplData.read;
                            if (downTplData.readImport) {
                                downTplData.read = downTplData.readImport;
                            }
                            downTplData.actionTemplate && (downTplData.action = downTplData.actionTemplate);

                            WIS_EMAP_UPLOAD.cacheCore.importFile(options, downTplData).done(function(json) {
                                options.onFileImported && options.onFileImported(json);
                            });
                        }).fail(function() {
                            options.onImportError && options.onImportError();
                        });
                    });
                }
            };
            WIS_EMAP_UPLOAD.cacheCore.init(view, options, callbacks);
        },
        downloadImportTpl: function(opt, data) {
            $.ajax({
                type: 'post',
                url: opt.contextPath + '/sys/emapcomponent/imexport/importTemplate.do',
                data: data,
                dataType: 'json',
                success: function(json) {
                    location.href = (opt.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + json.attachment + '.do');
                },
                error: function(e) {
                    $.bhTip && $.bhTip({
                        content: $.i18n('bh-ip-failToGetDownloadAddress'),
                        state: 'danger',
                        iconClass: 'icon-close'
                    });
                    console && console.log(e);
                }
            });
        },
        getDownloadResultUrl: function(opt, result) {
            return opt.contextPath + '/sys/emapcomponent/file/getAttachmentFile/' + result.attachment + '.do';
        },
        getImportProgress: function(opt, data) {
            return WIS_EMAP_UPLOAD.cacheAdaptor.getImportProgress(opt, data);
        }
    };

    win['EMAP_IMPORT_CACHE'] = importAdaptor;
})(window);

(function () {
  var Plugin, _init;
  var _animateTime, _eventBind, _addTime, _cancelAddTime, _renderEasySearch, _renderQuickSearch,
    _renderInputPlace, _renderConditionList, _getSelectedConditionFromForm, _renderAdvanceSearchForm, _getSelectedConditionFromModal,
    _getSearchCondition, _findModel, _getConditionFromForm, _initSchema, _closeSchema, _renderFixedSchema, _schemaDialogEventBind,
    _refreshUnfixNum;
  /**
   * @module emapAdvancedQuery
   * @alias 高级搜索
   * @description 高级搜索, 通过监听search事件，进行搜索操作
   * @example
   $('#advancedQueryPlaceholder').emapAdvancedQuery({
    data: searchData
  });
  $('#advancedQueryPlaceholder').on('search', function(e, data, opts){
    // data 为序列化的搜索条件
    console.log(data);
    //调用表格reload方法
    $("#retirementInfoTable").emapdatatable('reload', {querySetting: data});
  });
   */
  Plugin = (function () {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapAdvancedQuery.defaults, options);
      this.$element = $(element);
      this.$element.attr("emap-role", "advancedQuery").attr("emap-pagePath", "").attr("emap-action", this.options.data.name);
      this.options._initCount = 0; // 需要初始化的控件的总数
      this.options._initCounter = 0; // 控件初始化计数器
      _init(this.$element, this.options);
    }

    /**
     * @method getValue
     * @description 获取高级搜索当前的搜索条件
     * @return {Stirng} 搜索条件Json字符串
     */
    Plugin.prototype.getValue = function () {
      return _getSearchCondition(this.options);
    };
    /**
     * @method setValue
     * @description 高级搜索赋值
     * @param {Object|String} 搜索条件
     */
    Plugin.prototype.setValue = function (condition) {
      var element = this.$element;
      this.$element.emapAdvancedQuery('clear');
      var value = (typeof condition == "string") ? JSON.parse(condition) : condition;
      if (value.length > 0) {
        var formValue = {};
        $(value).each(function () {
          if ($.isArray(this)) {
            // 数组
            $('[bh-advanced-query-role=advancedInput]', element).val(this[0].value);
          } else {
            if (formValue.hasOwnProperty(this.name)) {
              if (this.builder === 'moreEqual') {
                formValue[this.name] = this.value + ',' + formValue[this.name];
                if (this.value_display) {
                  formValue[this.name + '_DISPLAY'] = this.value_displayformValue + ',' + [this.name + '_DISPLAY'];
                }
              }
              if (this.builder === 'lessEqual') {
                formValue[this.name] = formValue[this.name] + ',' + this.value;
                if (this.value_display) {
                  formValue[this.name + '_DISPLAY'] = formValue[this.name + '_DISPLAY'] + ',' + this.value_display;
                }
              }
            } else {
              formValue[this.name] = this.value;
              if (this.value_display) {
                formValue[this.name + '_DISPLAY'] = this.value_display;
              }
            }
          }
        });
        _renderAdvanceSearchForm(this.options, formValue);
        WIS_EMAP_INPUT.formSetValue(element, formValue, this.options);
      }
    };

    /**
     * @method clear
     * @description 清空高级搜索条件
     */
    Plugin.prototype.clear = function () {
      var element = this.$element;
      var options = this.options;
      // 清空高级搜索
      $('[bh-advanced-query-role=advancedInput]', element).val('');
      $('[bh-advanced-query-role=advanceSearchForm] [xtype]', element).each(function () {
        var _this = $(this);
        var name = _this.data('name');
        var xtype = _this.attr('xtype');
        WIS_EMAP_INPUT.setValue(_this, name, xtype, "", options.contextPath);
      });
      // 清空简单搜索
      $('.bh-advancedQuery-quick-search-wrap input[type=text]', element).val('');
      $('[bh-advanced-query-role="quickSearchForm"] [xtype]', element).each(function () {
        var _this = $(this);
        var name = _this.data('name');
        var xtype = _this.attr('xtype');
        WIS_EMAP_INPUT.setValue(_this, name, xtype, "", options.contextPath);
      });
    };

    /**
     * @method updateTotalNum
     * @description 刷新全部数据条数
     */
    Plugin.prototype.updateTotalNum = function (num) {
      if (!this.options.showTotalNum) return;
      var numWrap = $('.bh-advancedQuery-totalNum-wrap', this.$element);
      if (numWrap.css('display') == 'none') {
        numWrap.show();
      }
      $('.bh-advancedQuery-totalNum span', numWrap).text(num);
    };

    /**
     * @method destroy
     * @description 销毁组件实例
     */
    Plugin.prototype.destroy = function () {
      this.options = null;
      $(this.$element).data('plugin', false).empty();
    };
    return Plugin;
  })();

  _init = function (element, options) {
    if (options.showBlankOption === undefined) {
      options.showBlankOption = WIS_EMAP_CONFIG.showBlankOptionInSearch;
    }
     // 是否使用新的ztree下拉树替换原有下拉树
    if (options.useNewDropdownTree === undefined) {
      options.useNewDropdownTree = WIS_EMAP_CONFIG.useNewDropdownTree;
    }
    element.attr("emap", JSON.stringify({
      "emap-url": WIS_EMAP_SERV.url,
      "emap-name": WIS_EMAP_SERV.name,
      "emap-app-name": WIS_EMAP_SERV.appName,
      "emap-model-name": WIS_EMAP_SERV.modelName
    }));
    delete WIS_EMAP_SERV.url;
    delete WIS_EMAP_SERV.name;
    delete WIS_EMAP_SERV.appName;
    delete WIS_EMAP_SERV.modelName;
    // contextPath 兼容
    options.contextPath = options.contextPath || WIS_EMAP_SERV.getContextPath();

    // 读取全局配置参数 将下拉树替换为新版Ztree的下拉树
    if (options.useNewDropdownTree === true) {
      options.data.controls.map(function (item) {
        if (item['search.xtype']) {
          if ($.inArray(item['search.xtype'], ['tree', 'multi-tree']) > -1) {
            item['search.xtype'] = item['search.xtype'].replace(/tree$/, 'tree2')
          }
        } else {
          if ($.inArray(item['xtype'], ['tree', 'multi-tree']) > -1) {
            item['xtype'] = item['xtype'].replace(/tree$/, 'tree2')
          }
        }

        if (item['search.quickSearchXtype'] == 'tree' || item['search.quickSearchXtype'] == 'multi-tree') {
          item['search.quickSearchXtype'] = item['search.quickSearchXtype'].replace(/tree/, 'tree2');
        }
      });
    }

    var modalData = options.data.controls;
    var easyArray = [];
    var quickArray = [];
    var guid = BH_UTILS.NewGuid();

    _animateTime = function () {
      return 450;
    };

    _eventBind = function (options, element) {
      var $advanced = options.$advanced;
      var $advancedModal = options.$advancedModal;
      $advanced.on("click", "[bh-advanced-query-role=addTime]", function () {
        _addTime($(this));
      });

      $advanced.on("click", "[bh-advanced-query-role=cancelAddTime]", function () {
        _cancelAddTime($(this));
      });

      // 展开高级搜索
      $advanced.on("click", "[bh-advanced-query-role=advancedOpen]", function () {
        $($advanced).addClass('bh-active');
        options.searchModel = 'advanced';
        if (document.documentMode == 9 && $.fn.placeholder) {
          setTimeout(function () {
            WIS_EMAP_INPUT.placeHolder();
          }, 300);
        }
        WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
      });

      // 关闭高级搜索
      $advanced.on("click", "[bh-advanced-query-role=advancedClose]", function (event) {
        $($advanced).removeClass('bh-active');
        options.searchModel = 'easy';
        // 关闭高级搜索时, 清空高级搜索  6-1 zhuhui
        element.emapAdvancedQuery('clear');
        // 关闭高级搜索时, 触发一次简单搜索 5-13 zhuhui
        triggerSearch(element, options, _getSearchCondition(options, $(this).data('name')), event);
        // element.trigger('search', [_getSearchCondition(options, $(this).data('name')), options, event]);
        WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
      });

      // 删除搜索条件
      $advanced.on("click", "[bh-advanced-query-role=conditionDismiss]", function () {
        // 针对日期范围选择组件，删除时连同 范围选择的弹出框一同清除
        var inputRow = $(this).closest('.bh-advancedQuery-form-row');
        var inputItem = $('[xtype]', inputRow);
        if (inputItem.length && inputItem.attr('xtype') == 'date-range') {
          inputItem.bhTimePicker('remove');
        }
        inputRow.remove();
      });

      // 弹出  添加搜索条件 弹框
      $advanced.on("click", "[bh-advanced-query-role=addCondition]", function () {
        _renderConditionList(options);
        $advanced.trigger('window-open')
      });

      // easy搜索 监听 按键输入
      //elvis 2017-8-15 现场使用扫码枪输入，keyup监听到的keycode都是231，无法知道正确的编码
      // $advanced.on('keyup', '.bh-advancedQuery-quick-search-wrap input[type=text]', function (e) {
      $advanced.on('keydown', '.bh-advancedQuery-quick-search-wrap input[type=text]', function (e) {
        var easySelectH = $advanced.data('easyarray').length * 28 + 1; // 下拉框高度
        var easySelectW = $(this).outerWidth(); // 下拉框宽度
        var searchValue = $(this).val();
        var pos = $(this).offset();
        var selectDiv = $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']');
        pos.top += 28;
        // 回车快速搜索
        if (e.keyCode == 13) {
          selectDiv.css({
            'height': 0,
            'border-width': '0'
          });
          triggerSearch(element, options, _getSearchCondition(options), e);
          // element.trigger('search', [_getSearchCondition(options), options, e]);
          e.stopPropagation();
          return;
        }
        if (searchValue == '') {
          selectDiv.css({
            'height': 0,
            'border-width': '0'
          });
        } else {
          $('.bh-advancedQuery-easy-query', selectDiv).text(searchValue);
          selectDiv.css({
            'height': easySelectH + 'px',
            'width': easySelectW + 'px',
            'border-width': '1px',
            'top': pos.top,
            'left': pos.left
          });
        }
        e.stopPropagation();
      });

      // 点击下拉快速搜索
      $('[bh-advanced-query-role=advancedEasySelect][data-guid=' + options.guid + ']').on('click', 'p', function (event) {
        var selectDiv = $(this).closest('[bh-advanced-query-role=advancedEasySelect]');
        if (selectDiv.height() > 0) {
          selectDiv.css({
            'height': 0,
            'border-width': '0'
          });
        }
        triggerSearch(element, options, _getSearchCondition(options, $(this).data('name')), event);
        // element.trigger('search', [_getSearchCondition(options, $(this).data('name')), options, event]);
      });

      // 点击搜索按钮  easy search
      $advanced.on('click', '[bh-advanced-query-role=easySearchBtn]', function (event) {
        triggerSearch(element, options, _getSearchCondition(options), event);
        // element.trigger('search', [_getSearchCondition(options), options, event]);
      });

      // 点击筛选条件  quick search
      $advanced.on('click', '[bh-advanced-query-role=quickSearchForm] .bh-label-radio', function (event) {
        // radio 的事件冒泡问题
        setTimeout(function () {
          triggerSearch(element, options, _getSearchCondition(options), event);
          // element.trigger('search', [_getSearchCondition(options), options, event]);
        }, 200);
      });

      //监听普通搜索里时间选择框selected事件
      $advanced.on('selectedTime', '.bh-advancedQuery-quick div[xtype="date-range"]', function (event) {
        var searchCondition = _getSearchCondition(options);
        triggerSearch(element, options, searchCondition, event);
        // element.trigger('search', [searchCondition, options, event]);
      });

      // 执行高级搜索
      $advanced.on('click', '[bh-advanced-query-role=advancedSearchBtn]', function (event) {
        triggerSearch(element, options, _getSearchCondition(options), event);
        // element.trigger('search', [_getSearchCondition(options), options, event]);
      });

      // 监听 控件初始化事件  bhInputInitComplete, 根据计数器options._initCounter 判断出发高级搜索组件的 初始化回调
      element.on('_init', function (e) {
        var role = $(e.target).attr('bh-advanced-query-role')
        if (role === 'quickSearchForm') {
          element.trigger('init', [options]);
          options.initComplete && options.initComplete();
        }
      });

      // easySearch 下拉框的关闭
      $(document).on('click', function (e) {
        var target = e.target;
        if ($(target).closest('[bh-advanced-query-role=advancedEasySelect]').length == 0) {
          var selectDiv = $('.bh-advancedQuery-quick-select');
          selectDiv.css({
            'height': 0,
            'border-width': '0'
          });
        }
      });

      // 点击保存为搜索方案
      $advanced.on('click', '[bh-advanced-query-role=saveSchema]', function () {
        $(this).closest('.bh-schema-btn-wrap').addClass('active');
      });

      // 点击取消保存搜索方案
      $advanced.on('click', '[bh-advanced-query-role=saveSchemaCancel]', function () {
        _closeSchema(options);
      });

      // 点击确认保存搜索方案
      $advanced.on('click', '[bh-advanced-query-role=saveSchemaConfirm]', function () {
        var name = $('.bh-schema-name-input', $advanced).val();
        var conditionData = _getSearchCondition(options, undefined, true);
        var fixed = $('[bh-schema-role=fixCheckbox]', $advanced).prop('checked') ? 1 : 0;
        var programContainer = $('.bh-rules-program', $advanced);
        element.emapSchema('saveSchema', [name, conditionData, fixed]).done(function () {
          _closeSchema(options);
          var schInfo = options.schemaList.filter(function (val) {
            return val.SCHEMA_NAME == name;
          })
          var sameSch = false;
          if (schInfo.length > 0) {
            sameSch = true;
          }
          // 判断是否有重名的方案  如果有  直接覆盖
          if (sameSch) {
            // 重名方案
            options.schemaList.filter(function (val) {
              if (val.SCHEMA_NAME == name) {
                val.CONTENT = conditionData;
                val.FIXED = fixed;
              }
            })
          } else {
            schInfo = {
              "CONTENT": conditionData,
              "SCHEMA_NAME": name,
              "FIXED": fixed
            };
            options.schemaList.push(schInfo);
          }
          if (fixed == 1) {
            if (sameSch) {
              // 固定方案中的重名方案
              $('.bh-rules-program a[data-name="' + name + '"]', element).data('info', {
                "CONTENT": conditionData,
                "SCHEMA_NAME": name,
                "FIXED": fixed
              });
            } else {
              var sch = $('<a  data-name="' + name + '" href="javascript:void(0)">' + name + '</a>');
              sch.data('info', schInfo);
              $('.bh-rules-program [bh-schema-role=more]', element).before(sch);

            }
          } else {
            var sch = $('.bh-rules-program', element).find('a[data-name="' + name + '"]');
            if (sch.length > 0) {
              sch.remove()
            }
          }
          programContainer.show();
        }).fail(function (res) {
          console && console.log(res)
        });
      });

      // 点击方案的 更多按钮 呼出方案列表侧边弹窗
      $advanced.on('click', '[bh-schema-role=more]', function () {
        if ($('main > article aside').length == 0) {
          $('main > article').append('<aside></aside>');
        }
        $.bhPropertyDialog.show({
          // "title": "高级搜索方案", //侧边栏的标题
          "content": '<h3>'+ $.i18n('bh_aq_advancedSearchSheme') +'</h3>' +
            '<section>' +
            '<div id="schemaDialog" style="display: none;">' +
            '<p class="bh-color-caption">'+$.i18n('bh_aq_topScheme') +'</p>'+
            '<ul class="bh-schema-list" bh-schema-role="fixedUl">' +
            '</ul>' +
            '<p class="bh-color-caption">'+$.i18n('bh_aq_otherScheme')+'(<span>4</span>)</p>' +
            '<ul class="bh-schema-list" bh-schema-role="unFixedUl"></ul>' +
            '</div>' +
            '</section>', //侧边栏的内容html
          "footer": '', //侧边栏的页脚按钮
          ready: function () { //初始化完成后的处理
            var fixedUl = $('[bh-schema-role=fixedUl]');
            var unFixedUl = $('[bh-schema-role=unFixedUl]');
            $(options.schemaList).each(function () {
                var liHtml;
                liHtml = $('<li data-name="' + this.SCHEMA_NAME + '">' +
                  '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="delete">'+$.i18n('bh_aq_delete')+'</a>' +
                  '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="unfixed">'+$.i18n('bh_aq_cancelTheTop')+'</a>' +
                  '<a href="javascript:void(0)" class="bh-pull-right" bh-schema-role="fixed">'+$.i18n('bh_aq_top')+'</a>' +
                  this.SCHEMA_NAME +
                  '</li>').data('info', this);
                if (this.FIXED == 1) {
                  fixedUl.append(liHtml);
                } else {
                  unFixedUl.append(liHtml);
                }
                _refreshUnfixNum(unFixedUl);
              })

              // 处理保存方案的排序
            var fixedSchema = $('.bh-rules-program a:not([bh-schema-role="more"])', options.$advanced);
            if (fixedSchema.length > 0) {
              fixedSchema.each(function () {
                var condition
                var schemaName = $(this).data('info').SCHEMA_NAME;
                fixedUl.append($('li[data-name="' + schemaName + '"]'));
              });
            }
            if (options.schemaList.length == 0) {
              $('#schemaDialog').length > 0 && $('#schemaDialog').hide()
            } else {
              $('#schemaDialog').length > 0 && $('#schemaDialog').show()
            }
            _schemaDialogEventBind(element, options);
          }
        });
      })

      // 点击快速方案
      $advanced.on('click', '.bh-rules-program a:not([bh-schema-role=more])', function (event) {
        var condition = $(this).data('info');
        element.emapAdvancedQuery('setValue', condition.CONTENT);
        triggerSearch(element, options, JSON.stringify(filterCondition(condition.CONTENT)), event);
        // element.trigger('search', [JSON.stringify(filterCondition(condition.CONTENT)), options, event]);
        $.bhTip && $.bhTip({
          content: condition.SCHEMA_NAME + ' 方案执行成功',
          state: 'success',
          iconClass: 'icon-checkcircle'
        });
      });

      // 点击清空按钮
      $advanced.on('click', '[bh-advanced-query-role=clearBtn]', function (event) {
        $(element).emapAdvancedQuery('clear');
        triggerSearch(element, options, _getSearchCondition(options), event)
          // element.trigger('search', [_getSearchCondition(options), options, event]);
      });
    };

    function triggerSearch(element, options, conditions, event) {
      if (options.beforeSearch) {
        if (options.beforeSearch(conditions, options) === false) return;
      }
      element.trigger('search', [conditions, options, event]);
    }

    // 更新未置顶的方案个数
    _refreshUnfixNum = function (ul) {
      var count = $('li', ul).length;
      ul.prev('p').find('span').html(count);
      if (count == 0) {
        ul.hide().prev('p').hide()
      } else {
        ul.show().prev('p').show()
      }
      var fixedUl = $(ul).siblings('[bh-schema-role=fixedUl]');
      if ($('li', fixedUl).length == 0) {
        fixedUl.hide().prev('p').hide();
      } else {
        fixedUl.show().prev('p').show();
      }
    };

    _addTime = function ($item) {
      var $groupParent = $item.closest(".bh-advancedQuery-addBlock");
      $groupParent.addClass("bh-active");
      var $addTime = $groupParent.children("div[bh-advanced-query-role=addTime]");
      $groupParent.children("div[bh-advanced-query-role=addTimeGroup]").show();
      $addTime.hide();
    };

    _cancelAddTime = function ($item) {
      var $groupParent = $item.closest(".bh-advancedQuery-addBlock");
      $groupParent.removeClass("bh-active");
      var $addTimeGroup = $groupParent.children("div[bh-advanced-query-role=addTimeGroup]");
      $addTimeGroup.removeClass("bh-entryLeft").addClass("bh-outLeft");
      $groupParent.children("div[bh-advanced-query-role=addTime]").addClass("bh-entryRight").show();
      setTimeout(function () {
        $addTimeGroup.removeClass("bh-outLeft").addClass("bh-entryLeft").hide();
      }, _animateTime());
    };

    _renderEasySearch = function (easyArray, options) {
      var easySearch = '';
      var easySearchPlaceholder = ''; // easySearch 文本框placeholder
      if (easyArray.length && easyArray.length > 0) {
        easySearchPlaceholder += $.i18n('bh_aq_enter');
        $(easyArray).each(function () {
          easySearchPlaceholder += this.caption + '/';
          easySearch += '<p data-name="' + this.name + '">' + $.i18n('bh_aq_search') + ' <span class="bh-advancedQuery-easy-caption">' + this.caption + '</span> : <span class="bh-advancedQuery-easy-query"></span></p>';
        });
        $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']').html(easySearch);
        easySearchPlaceholder = easySearchPlaceholder.substring(0, easySearchPlaceholder.length - 1);
        $('.bh-advancedQuery-quick-search-wrap input[type=text]', options.$advanced).attr('placeholder', easySearchPlaceholder);
      } else {
        $('.bh-advancedQuery-inputGroup', options.$advanced).hide();
      }
    };

    _renderQuickSearch = function (quickArray) {
      var quickSearchHtml = $('<div></div>');
      $(quickArray).each(function (i) {
        // 应业务线需求将快速搜索中的多选下拉放出  不做类型转换  zhuhui 0722
        if (this.xtype == 'select' || this.xtype == 'radiolist' || this.xtype == 'checkboxlist' || this.xtype == 'multi-select2') {
          this['search.xtype'] = 'buttonlist';
        }
        // 添加 quickSearchXtype属性, 表示字段在 快速搜索中展示的类型 zhuhui 0725
        if (this['search.quickSearchXtype']) {
          this['search.xtype'] = this['search.quickSearchXtype'];
        }
        quickSearchHtml.append(_renderInputPlace(this));
      });
      return quickSearchHtml;
    };

    _renderInputPlace = function (item, showClose) {
      //showClose  是否显示 关闭按钮
      var _this = item;
      _this.get = function (attr) {
        if (_this['search.' + attr] !== undefined) {
          return _this['search.' + attr];
        } else {
          return _this[attr];
        }
      };
      var attr = WIS_EMAP_SERV.getAttr(_this)
      var xtype = _this.get("xtype");
      var caption = _this.get("caption");
      var builder = _this.get("defaultBuilder");
      var url = _this.get("url");
      var name = _this.get("name");
      var hidden = _this.get("hidden") ? "hidden" : "";
      var placeholder = _this.get("placeholder") ? _this.get("placeholder") : "";
      var checkType = _this.get("checkType");
      var checkSize = _this.get("checkSize");
      var dataSize = _this.get("dataSize");
      var checkExp = _this.get("checkExp");
      var JSONParam = _this.get("JSONParam");
      var format = _this.get("format") ? _this.get("format") : 'yyyy-MM-dd';
      var controlHtml = $(' <div class="bh-advancedQuery-form-row bh-advancedQuery-h-28">' +
        '<div class="bh-advancedQuery-groupName">' + caption + '：</div>' +
        '<div class="bh-advancedQuery-groupList bh-label-radio-group">' +
        '</div>' +
        '</div>');

      if (showClose) {
        controlHtml.append('<a class="bh-bh-advancedQuery-group-dismiss" bh-advanced-query-role="conditionDismiss"> ' +
          '<i class="icon-close iconfont"></i>' +
          '</a>');
      }
      var inputHtml = '';
      switch (xtype) {

      case "tree":
      case "multi-tree":
      case "tree2":
      case "multi-tree2":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" data-url="{{url}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case "date-local":
      case "date-range":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="{{format}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case "date-ym":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="{{format}}" {{hidden}}></div>';
        break;
      case "date-full":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="{{format}}" {{hidden}}></div>';
        break;
      case "switcher":
        inputHtml += '<div xtype="{{xtype}}"  data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" {{hidden}}></div>';
        break;
      case "radiolist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-radio" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
        break;
      case "checkboxlist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-checkbox" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
        break;
      case "buttonlist":
      case "multi-buttonlist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} ></div>';
        break;
      case "select":
      case "multi-select":
      case "multi-select2":
      case "selecttable":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case 'number':
      case 'number-range':
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      default:
        inputHtml += '<input class="bh-form-control" data-name="{{name}}" name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" xtype="text" type="text" {{hidden}} />';
        break;
      }
      inputHtml = inputHtml.replace(/\{\{xtype\}\}/g, xtype)
        .replace(/\{\{name\}\}/g, name)
        .replace(/\{\{builder\}\}/g, builder)
        .replace(/\{\{caption\}\}/g, caption)
        .replace(/\{\{url\}\}/g, url)
        .replace(/\{\{hidden\}\}/g, (hidden ? 'style="display:none;"' : ''))
        .replace(/\{\{allOption\}\}/g, options.allowAllOption)
        .replace(/\{\{format\}\}/g, format);
      inputHtml = $(inputHtml);
      if (JSONParam) {
        inputHtml.data('jsonparam', JSONParam);
      }
      inputHtml.data('attr', attr)
      $('.bh-advancedQuery-groupList', controlHtml).html(inputHtml);
      return controlHtml;
    };

    _getSelectedConditionFromForm = function (options) {
      var selectedForm = $('[bh-advanced-query-role=advanceSearchForm]', options.$advanced);
      var selectedArr = [];
      $('[xtype][data-name]', selectedForm).each(function () {
        selectedArr.push($(this).data('name'));
      });
      return selectedArr;
    };

    _renderConditionList = function (options) {
      var modalArray = options.$advanced.data('modalarray');
      // 获取已选condition 数据
      var selectedArr = _getSelectedConditionFromForm(options);

      var columns = [];

      $(modalArray).each(function () {
        var colItem = {};
        colItem.hidden = $.inArray(this.name, selectedArr) == -1;
        colItem.text = this.caption;
        colItem.datafield = this.name;
        columns.push(colItem);
      });

      $.bhCustomizeColumn({
        model: modalArray,
        modelType: 'search',
        columns: columns,
        useGroup: options.useGroup,
        title: $.i18n('bh_aq_addTheSearchField'),
        params: { height: 500 },
        callback: function (col) {
          var colData = {};
          col.map(function (item) {
            if (!item.hidden) {
              colData[item.name] = "";
            }
          });
          _renderAdvanceSearchForm(options, colData);
          setTimeout(function () {
            // 若表单字段有变动则 弹出tip 弹窗
            if (options._changeCounter > 0) {
              $.bhTip && $.bhTip({
                content: $.i18n('bh_aq_success'),
                state: 'success',
                iconClass: 'icon-checkcircle'
              });
            }
          }, 0);
        }
      });
    };

    // 渲染高级搜索表单
    _renderAdvanceSearchForm = function (options, selectedObj) {
      var advanceForm = $('[bh-advanced-query-role=advanceSearchForm]', options.$advanced);
      var btnWrap = $('[bh-advanced-query-role=dropDownBtnWrap]', advanceForm);
      options._changeCounter = 0; // 记录改变的字段的数量，如果有改动，则在渲染完成后弹出 成功的 tip
      $(options.$advanced.data('modalarray')).each(function () {
        var _this = this;
        var formItem = $('[data-name="' + this.name + '"]', advanceForm);
        if (selectedObj[this.name] !== undefined && selectedObj[this.name] != null) {
          if (formItem.length > 0) {
            // 表单已有字段
            return true;
          } else {
            // 表单添加字段
            options._changeCounter++;
            btnWrap.before(_renderInputPlace(this, true));
          }
        } else {
          if (formItem.length > 0) {
            // 表单删除字段
            options._changeCounter++;
            formItem.closest('.bh-advancedQuery-form-row').remove();
          }
        }
      });
      var formOpt = {
        defaultOptions: {
          tree: {
            unblind: '/',
            search: true
          },
          "multi-tree": {
            unblind: '/',
            search: true
          },
          tree2: {
            unblind: '/',
            search: true
          },
          "multi-tree2": {
            unblind: '/',
            search: true
          },
          switcher: {
            checked: true
          },
          "multi-select2": {
            width: 300
          },
          "date-range": {
            defaultType: 'all'
          }
        },
        showBlankOption: options.showBlankOption
      };
      formOpt.defaultOptions = $.extend({}, formOpt.defaultOptions, options.defaultOptions);
      advanceForm.emapFormInputInit(formOpt);

      // 表单塞值
      for (var v in selectedObj) {
        if (selectedObj[v] === undefined || selectedObj[v] === null) return true;
        var ele = $('[data-name="' + v + '"]', advanceForm);
        var xtype = ele.attr('xtype');
        if (xtype == 'switcher') {
          if (selectedObj[v] === "") selectedObj[v] = "1";
        } // 高级搜索的开关 默认选中
        if (xtype == 'date-range' && selectedObj[v] === "") selectedObj[v] = "all"; // 高级搜索的开关 默认选中
        if (selectedObj[v] !== "") {
          WIS_EMAP_INPUT.setValue(ele, v, xtype, selectedObj, "");
        }
      }
      WIS_EMAP_SERV && WIS_EMAP_SERV._resetPageFooter();
    };

    // 生成搜索条件
    //  blank_condition 是否允许搜索条件中存在空值
    _getSearchCondition = function (options, name, blank_condition) {
      var conditionResult = [];
      var easyArray = options.$advanced.data('easyarray');
      var modalarray = options.$advanced.data('modalarray')
      var orCondition = [];
      if (options.searchModel == 'easy') {
        var searchKey = $.trim($('.bh-advancedQuery-quick-search-wrap input', options.$advanced).val());
        // 简单搜索
        if (searchKey != "") {
          if (name) {
            //简单搜索的下拉框搜索
            var searchItem = _findModel(name, easyArray);
            var conditionData = {
              "caption": searchItem.caption,
              "name": searchItem.name,
              "value": searchKey,
              "builder": (searchItem.defaultBuilder == "equal" ? "include" : searchItem.defaultBuilder), // equal时强制转换为include
              "linkOpt": "AND"
            };
            conditionResult.push(conditionData);
          } else {
            for (var i = 0; i < easyArray.length; i++) {
              var conditionData = {
                "caption": easyArray[i].caption,
                "name": easyArray[i].name,
                "value": searchKey,
                "builder": (easyArray[i].defaultBuilder == "equal" ? "include" : easyArray[i].defaultBuilder), // equal时强制转换为include
                "linkOpt": "OR"
              };
              orCondition.push(conditionData);
            }
            conditionResult.push(orCondition);
          }
        }
        conditionResult = conditionResult.concat(_getConditionFromForm($('[bh-advanced-query-role=quickSearchForm]', options.$advanced), options));
      } else if (options.searchModel == 'advanced') {
        var advancedKeyWord = $.trim($('[bh-advanced-query-role=advancedInput]', options.$advanced).val());
        // 高级搜索
        if (advancedKeyWord != '') {
          for (var i = 0; i < easyArray.length; i++) {
            if (!easyArray[i].xtype || easyArray[i].xtype == 'text') {
              orCondition.push({
                "caption": easyArray[i].caption,
                "name": easyArray[i].name,
                "value": advancedKeyWord,
                "builder": (easyArray[i].defaultBuilder == "equal" ? "include" : easyArray[i].defaultBuilder), // equal时强制转换为include,
                "linkOpt": "OR"
              });
            }
          }
          conditionResult.push(orCondition);
        }
        conditionResult = conditionResult.concat(_getConditionFromForm($('[bh-advanced-query-role=advanceSearchForm]', options.$advanced), options));
      }
      if (blank_condition !== true) {
        conditionResult = filterCondition(conditionResult);
      }

      var trimInclueValue = function (conditionArray) {
        conditionArray.forEach(function (condition) {
          if ($.isArray(condition)) {
            trimInclueValue(condition);
          } else {
            var value = condition.value;
            if (value) {
              value = value.toString();
              if (value.indexOf(',') > -1) {
                condition.value = value.split(',').map(function (val) {
                  return $.trim(val);
                }).join(',');
                // condition.builder = 'm_value_include';
              }
            }
          }
        });
      };
      trimInclueValue(conditionResult);
      return JSON.stringify(conditionResult);
    };

    _getConditionFromForm = function (form, options) {
      var model = options.$advanced.data('modalarray');
      var conditionArray = [];
      var formElement = $('[xtype]', form);

      var formValue = WIS_EMAP_INPUT.formGetValue(form, options);
      return WIS_EMAP_INPUT.getConvertCondition(formValue, model);
    };

    _findModel = function (name, modelArray) {
      for (var i = 0; i < modelArray.length; i++) {
        if (modelArray[i].name == name) {
          return modelArray[i];
        }
      }
    };

    // 初始化方案
    _initSchema = function (element, options) {
      options = $.extend(options, {
        schemaType: "aq"
      });
      $.fn.emapSchema && $(element).emapSchema(options);
      _renderFixedSchema(element, options);
    };

    // 关闭搜索方案
    _closeSchema = function (options) {
      var wrap = $('.bh-schema-btn-wrap', options.$advanced);
      wrap.removeClass('active');
      $('.bh-schema-name-input', wrap).val('');
      $('[bh-schema-role=fixCheckbox]', wrap).prop('checked', false);
    };

    // 渲染固定的搜索方案
    _renderFixedSchema = function (element, options) {
      options.schemaList = element.emapSchema('getSchemaList');
      options.schemaList = options.schemaList ? options.schemaList : [];
      var $advanced = options.$advanced;
      var programContainer = $('.bh-rules-program', $advanced);
      if (options.schemaList.length > 0) {
        var fixedSchema = options.schemaList.filter(function (val) {
          return val.FIXED == 1;
        })
        if (fixedSchema.length == 0) {
          programContainer.html('<label>'+$.i18n('bh_aq_commonScheme') +': </label><a bh-schema-role="more" href="javascript:void(0)">'+$.i18n('bh_aq_more') +' ></a>')
        } else {
          $(fixedSchema).each(function () {
            var sch = $('<a  data-name="' + this.SCHEMA_NAME + '" href="javascript:void(0)">' + this.SCHEMA_NAME + '</a>');
            sch.data('info', this);
            $('[bh-schema-role=more]', programContainer).before(sch);
          });
          programContainer.show()
        }
      } else {
        programContainer.hide();
      }
    };

    // 方案侧边弹窗事件绑定
    _schemaDialogEventBind = function (element, options) {
      var dialog = $('#schemaDialog');
      // 删除
      dialog.on('click', '[bh-schema-role=delete]', function (e) {
        e.stopPropagation();
        var li = $(this).parent();
        var name = li.data('info').SCHEMA_NAME;
        if (element.emapSchema('deleteSchema', name)) {
          li.remove();
          $('.bh-rules-program', element).find('[data-name="' + name + '"]').remove();
          $(options.schemaList).each(function (i) {
            if (this.SCHEMA_NAME == name) {
              options.schemaList.splice(i, 1);
            }
          })
          _refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));
        }
      });

      // 点击选择方案
      dialog.on('click', 'li', function (event) {
        var condition = $(this).data('info');
        element.emapAdvancedQuery('setValue', condition.CONTENT);
        //qiyu 2016-12-14 点击方案的查询与直接查询的条件不一致，应过滤掉为空的条件 RS-2973
        // element.trigger('search', [condition.CONTENT, options, event]);

        triggerSearch(element, options, JSON.stringify(filterCondition(condition.CONTENT)), event);
        // element.trigger('search', [JSON.stringify(filterCondition(condition.CONTENT)), options, event]);
        $.bhPropertyDialog.hide();
        $.bhTip && $.bhTip({
          content: condition.SCHEMA_NAME + ' 方案执行成功',
          state: 'success',
          iconClass: 'icon-checkcircle'
        });
      });

      // 置顶
      dialog.on('click', '[bh-schema-role=fixed]', function (e) {
        e.stopPropagation();
        var li = $(this).closest('li');
        var info = li.data('info');
        var name = info.SCHEMA_NAME;
        var conditionData = info.CONTENT;
        element.emapSchema('saveSchema', [name, conditionData, 1]).done(function () {
          _closeSchema(options);
          var infoData = {
            "CONTENT": conditionData,
            "SCHEMA_NAME": name,
            "FIXED": 1
          }
          options.schemaList.filter(function (val) {
            return val.SCHEMA_NAME == name;
          })[0].FIXED = 1;
          $('[bh-schema-role=fixedUl]', dialog).append(li);
          var sch = $('<a  data-name="' + name + '" href="javascript:void(0)">' + name + '</a>');
          sch.data('info', infoData);
          $('.bh-rules-program [bh-schema-role=more]', element).before(sch);
          _refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));
        }).fail(function (res) {
          console && console.log(res)
        });
      });
      // 取消置顶
      dialog.on('click', '[bh-schema-role=unfixed]', function (e) {
        e.stopPropagation();
        var li = $(this).closest('li');
        var info = li.data('info');
        var name = info.SCHEMA_NAME;
        var conditionData = info.CONTENT;
        element.emapSchema('saveSchema', [name, conditionData, 0]).done(function () {
          _closeSchema(options);
          options.schemaList.filter(function (val) {
            return val.SCHEMA_NAME == name;
          })[0].FIXED = 0;
          $('[bh-schema-role=unFixedUl]', dialog).append(li);
          $('.bh-rules-program', element).find('[data-name="' + name + '"]').remove()
          _refreshUnfixNum($('[bh-schema-role=unFixedUl]', dialog));
        }).fail(function (res) {
          console && console.log(res)
        });
      })
    };

    function filterCondition(condition) {
      return WIS_EMAP_INPUT.filterCondition(condition);
    }

    element.css({
      "position": "relative",
      "z-index": 358
    }).html('<div class="bh-advancedQuery bh-mb-16" bh-advanced-query-role="advancedQuery">' +
      '<div class="bh-advancedQuery-dropDown ">' +
      '<div class="" style="display: table-cell">' +
      '<div class="bh-rules-header bh-clearfix">' +
      '<h4><i class="iconfont icon-search"></i>'+ $.i18n('bh_aq_advancedSearch') +'</h4>' +
      '<p class="bh-rules-program">' +
      '<label>'+$.i18n('bh_aq_commonScheme')+': </label>' +
      '<a bh-schema-role="more" href="javascript:void(0)">'+ $.i18n('bh_aq_more') +' ></a>' +
      '</p>' +
      '</div>' +
      '<div class="bh-advancedQuery-form" bh-advanced-query-role="advanceSearchForm" >' +
      '<div class="bh-advancedQuery-form-row bh-advancedQuery-h-28">' +
      '<div class="bh-advancedQuery-groupName">' + $.i18n('bh_aq_keyWord') + '：</div>' +
      '<div class="bh-advancedQuery-groupList">' +
      '<input type="text" bh-advanced-query-role="advancedInput" class="bh-form-control">' +
      '</div>' +
      '</div>' +
      '<div class="bh-advancedQuery-form-row bh-advancedQuery-form-btn-row bh-advancedQuery-h-28" bh-advanced-query-role="dropDownBtnWrap"> ' +
      '<div class="bh-advancedQuery-groupName"></div>' +
      '<div class="bh-advancedQuery-groupList">' +
      '<a class="bh-btn bh-btn-primary bh-btn-small" bh-advanced-query-role="advancedSearchBtn" >' + $.i18n('bh_aq_doAdvancedSearch') + '</a>' +
      '<a class="bh-btn bh-btn-default bh-btn-small" bh-advanced-query-role="addCondition" >' + $.i18n('bh-eaq-addTheSearchField') + '</a>' +
      '<div class="bh-schema-btn-wrap">' +
      '<div class="bh-schema-edit-div">' +
      '<input type="text" placeholder="' + $.i18n('bh-eaq-enterSchemaName') + '" maxlength="20" class="bh-form-control bh-schema-name-input" />' +
      '<a  class="bh-btn bh-btn-success bh-btn-small"  bh-advanced-query-role="saveSchemaConfirm">' + $.i18n('bh_aq_save') + '</a>' +
      '<a class="bh-btn bh-btn-default bh-btn-small" bh-advanced-query-role="saveSchemaCancel">' + $.i18n('bh_aq_cancel') + '</a>' +
      '<span class="bh-checkbox" style="display:inline-block;vertical-align:middle;margin-left:8px;padding-top: 0;"><label>' +
      '<input type="checkbox" bh-schema-role="fixCheckbox"><i class="bh-choice-helper"></i>'+$.i18n('bh_aq_fixedToSearchBar') +
      '</label></span>' +
      '</div>' +
      '<a class="bh-btn bh-btn-default bh-btn-small " bh-advanced-query-role="saveSchema" href="javascript:void(0)">'+$.i18n('bh_aq_saveAsScheme')+'</a>' +
      '</div>' +
      '<a class="bh-mh-4" bh-advanced-query-role="advancedClose" href="javascript:void(0)">' + $.i18n('bh_aq_closeAdvancedSearch') + '</a>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '<div class="bh-advancedQuery-quick">' +
      '<div class="bh-advancedQuery-inputGroup bh-clearfix" style="padding-bottom: 8px;background: #fff;">' +
      '<div class="bh-advancedQuery-quick-search-wrap" >' +
      '<input type="text" class="bh-form-control"/>' +
      '<i class="iconfont icon-search" style="position: absolute;left: 6px;top: 6px;"></i>' +
      //'<div class="bh-advancedQuery-quick-select" bh-advanced-query-role="advancedEasySelect">' +
      //'</div>' +
      '</div>' +
      '<a class="bh-btn bh-btn bh-btn-primary bh-btn-small" bh-advanced-query-role="easySearchBtn" >' + $.i18n('bh_aq_search') + '</a>' +
      '<a href="javascript:void(0);" class="bh-mh-8" bh-advanced-query-role="advancedOpen">[' + $.i18n('bh_aq_advancedSearch') + ']</a>' +
      '</div>' +
      '<div class="bh-advancedQuery-form" bh-advanced-query-role="quickSearchForm">' +
      '</div>' +
      '</div>' +
      '<div class="bh-clearfix bh-advancedQuery-totalNum-wrap">' +
      '<p class="bh-advancedQuery-totalNum bh-pull-left"><span></span>' + $.i18n('bh_aq_recorders') + ' <a href="javascript:void(0)" bh-advanced-query-role="clearBtn">[' + $.i18n('bh_aq_clearSearch') + ']</a></p>' +
      '<div class="bh-advancedQuery-totalNum-line"></div>' +
      '</div>' +
      '</div>');
    options.$advanced = $('div[bh-advanced-query-role=advancedQuery]', element).css({
      'overflow': 'hidden'
    });
    options.guid = guid;
    $('body').append('<div class="bh-advancedQuery-quick-select" bh-advanced-query-role="advancedEasySelect" data-guid="' + guid + '" ></div>');
    _eventBind(options, element);

    var easySearchPlaceholder = '';
    $(modalData).each(function (i) {
      //移除 hidden 项
      var index = modalData.indexOf(this);
      if (this.get('hidden')) {
        modalData.splice(index, 1);
        return true;
      }
      if (!this.xtype || this.xtype == 'text') {
        // easySearchPlaceholder += this.caption + '/'; // 高级搜索关键词输入框placeholder
      } else if ($.inArray(this.xtype, ["radiolist", "checkboxlist", "buttonlist", "multi-buttonlist"]) > -1) {
        options._initCount++;
      }
      if (this.quickSearch) {
        if (!this.xtype || this.xtype == 'text') {
          easySearchPlaceholder += this.caption + '/';
          easyArray.push(this);
        } else {
          quickArray.push(this);
        }
      }
    });
    // 高级搜索关键词字段添加placeholder
    $('[bh-advanced-query-role=advancedInput]', element).attr('placeholder', easySearchPlaceholder.substr(0, easySearchPlaceholder.length - 1));
    options.$advanced.data('modalarray', modalData);
    options.$advanced.data('easyarray', easyArray);
    options.$advanced.data('quickarray', quickArray);
    if (options.searchModel !== 'easy') {
      options._initCount = quickArray.length;
    }
    if (easyArray.length == 0 && quickArray.length == 0) {
      console && console.warn("没有配置快速搜索字段,所以高级搜索控件无法展示!");
    }

    // 简单搜索 条件渲染
    _renderEasySearch(easyArray, options);

    // 快速搜索条件渲染
    quickArray = JSON.parse(JSON.stringify(quickArray));
    options.quickArray = quickArray;
    var formOpt = {
      root: '',
      defaultOptions: {
        tree: {
          // checkboxes: true,
          width: 300,
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        "multi-tree": {
          width: "300px",
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        tree2: {
          // checkboxes: true,
          width: 300,
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        "multi-tree2": {
          width: "300px",
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        switcher: {
          checked: true
        },
        "date-range": {
          defaultType: 'all'
        },
        "select": {
          width: "300px"
        },
        "multi-select": {
          width: "300px"
        },
        "multi-select2": {
          width: "300px"
        },
        "date-local": {
          width: "300px"
        },
        "date-ym": {
          width: "300px"
        },
        "date-full": {
          width: "300px"
        }
      },
      showBlankOption: options.showBlankOption
    };
    formOpt.defaultOptions = $.extend({}, formOpt.defaultOptions, options.defaultOptions);
    $('[bh-advanced-query-role=quickSearchForm]', options.$advanced).html(_renderQuickSearch(quickArray))
      .emapFormInputInit(formOpt);

    _renderAdvanceSearchForm(options, options.defaultItem);
    // 初始化 方案 模块
    if (options.schema) {
      $.fn.emapSchema && _initSchema(element, options);
    } else {
      $('.bh-rules-program, .bh-schema-btn-wrap', options.$advanced).hide();

    }
    if (document.documentMode == 9 && JPlaceHolder) {
      // WIS_EMAP_INPUT.placeHolder();
      JPlaceHolder.fix(element);
    }
  };


  $.fn.emapAdvancedQuery = function (options, params) {
    var instance;
    instance = this.data('plugin');
    if (!instance) {
      return this.each(function () {
        return $(this).data('plugin', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') return instance[options](params);
    return this;
  };

  /**
   * @memberof module:emapAdvancedQuery
   * @event search
   * @description 搜索触发的事件
   * @param {Object} event - 事件对象
   * @param {Stirng} conditions - 搜索条件字符串
   * @param {Object} options - 搜索组件options对象
   * @example
   * $search.on('search'. function (event, conditions) {
   *  console.log(event);
   *  console.log(conditions);
   *  $table.emapdatatable('reload', {querySetting: conditions});
   * })
   */

   /**
   * @memberof module:emapAdvancedQuery
   * @event window-open
   * @description 弹出选择字段弹窗的事件
   * @param {Object} event - 事件对象
   */

  /**
   * @memberof module:emapAdvancedQuery
   * @prop {Object} data - 搜索数据模型
   * @prop {Boolean} [allowAllOption=true] - 快速搜索的按钮组是否显示[全部]选项
   * @prop {Boolean} [contextPath] - 快速搜索的按钮组是否显示[全部]选项
   * @prop {Object} [defaultItem=[]] - 高级搜索模式默认展示的字段 [{name: "xxx"}]
   * @prop {String} [searchModel=easy] - 默认搜索模式 可选值： 'easy' 简单模式  'advanced' 高级模式
   * @prop {Boolean} [schema=true] - 是否开启保存搜索方案功能
   * @prop {Boolean} [showTotalNum=false] - 是否展示表格数据联动显示
   * @prop {Function} [initComplete] - 初始化成功的回调函数
   * @prop {Boolean} [useGroup=false] - 在添加搜索字段中，是否将字段按照分组进行排序
   * @prop {Boolean} [showBlankOption=true] - 下拉和下拉树是否添加空值选项
   * @prop {Function} [beforeSearch] - 搜索触发前的回调函数， 如果返回false则不触发搜索
   * @prop {Boolean} [useNewDropdownTree] - 是否使用ztee的下拉树替换原有的下拉树
   *
   */
  $.fn.emapAdvancedQuery.defaults = {
    allowAllOption: true,
    defaultItem: [],
    searchModel: 'easy',
    schema: true,
    useGroup: false,
    showTotalNum: false,
    defaultOptions: {},
    beforeSearch: undefined
  };

}).call(this);

;
(function() {
    /**
     * @module emapBatchEdit
     * @alias 批量编辑
     */
    $.emapBatchEdit = function(options) {
        options = $.extend({}, $.emapBatchEdit.default, options);
        if ((!options.tableData || !options.tableData.length) && !options.number) {
            $.bhTip({
                content: $.i18n('bh_be_unchooseTip'),
                state: 'danger'
            });
        } else if (!options.model || !options.model.length || !options.callback || !options.callback instanceof Function) {
            console.log("入参缺少模型或者回调函数");
            return;
        } else {
            initWindow(options);
        }
    };

    /**
     * @memberof module:emapBatchEdit
     * @prop {String} width - window的默认宽度
     * @prop {String} height - window的默认高度
     * @prop {Array}  model -   表单模型所有字段
     * @prop {Array}  tableData - 勾选的需要批量编辑的数据
     * @prop {Int} [number] - 数据条数，若传了number参数，则会覆盖tableData
     * @prop {Array}  hideMember - 设置的主键,不可被编辑
     * @prop {Function} callback - 返回表单数据的回调
     */
    $.emapBatchEdit.default = {
        width: 800,
        height: 500,
        model: [],
        tableData: [],
        number: undefined,
        hideMember: [],
        callback: undefined
    };

    function initWindow(options) {
        var dataLen;
        if (options.number) {
            if (options.number instanceof String) {
                options.number = parseInt(options.number, 10);
                if (options.number instanceof Number) {} else {
                    console.log("必须是数字");
                    return;
                }
            }
            dataLen = options.number;
        } else {
            dataLen = options.tableData.length;
        }

        var hasLink = false;

        var dailog = $('<div class="bh-batch-edit-head">' + $.i18n('bh-be-choosed') + '<span>' + dataLen + '</span>' + $.i18n('bh-be-piecesOfDatas') + '</div><div class="bh-batch-edit"><nav><h4>' + $.i18n('bh-be-keysList') + '</h4><div class="bh-batch-edit-input"><i class="iconfont">&#xe895;</i><input type="text" class="bh-form-control" placeholder="' + $.i18n('bh-be-search') + '"></div><div class="bh-batch-edit-list"><ul></ul</div></nav><section><div class="bh-batch-edit-form-top"></div><div id="bhBatchEditForm"></div></section></div>');
        BH_UTILS.bhWindow(dailog, $.i18n('bh-be-bulkEdit'), [{
            text: $.i18n('bh-be-sureEdit'),
            className: 'bh-btn-primary',
            callback: function() {
                if (!hasLink) {
                    var isValide = true;
                    $('#bhBatchEditForm>div[emap-role="form"]').each(function() {
                        if (!$(this).bhValidate('validate')) {
                            isValide = false;
                        }
                    });
                    if (!isValide) {
                        return false;
                    }
                }
                if (!$('#bhBatchEditForm').bhValidate('validate')) return false
                $.bhPopOver({
                    content: '<h4>' + $.i18n('bh-be-willBulkEdit') + '</h4>' +
                        '<div class="bh-btn-grouped"><button type="button" class="bh-btn bh-btn-circle bh-btn-primary" id="bhBatchEditConfirm"><i class="iconfont icon-check"></i></button><button type="button" class="bh-btn bh-btn-circle bh-btn-default" id="bhBatchEditClose"><i class="iconfont icon-close"></i></button></div>',
                    selector: $(".jqx-window-content #buttons .bh-btn-primary"),
                    showCloseButton: false,
                    width: 220
                });
                $("#bhBatchEditConfirm").on('click', function() {
                    var formData = $("#bhBatchEditForm > div").find(".form-validate-block");
                    var newData = [];
                    var newJson = {};
                    formData.each(function() {
                        var item = $(this);
                        var dataField = '';
                        var inputValue = '';
                        if (item.css("display") === "block") {
                            dataField = item.attr("data-field");
                            var value = WIS_EMAP_INPUT.formGetValue(item);
                            newJson[dataField] = value[dataField];
                        }
                    });
                    if (options.number === undefined) {
                        options.tableData.map(function(item) {
                            $.extend(item, newJson)
                        })
                        newData = options.tableData
                    } else {
                        newData.push(newJson);
                    }
                    $.bhPopOver.close();
                    if (options.callback(newData) === false) {
                        return;
                    }
                    BH_UTILS.bhWindow.close();
                });
                $("#bhBatchEditClose").on('click', function() {
                    $.bhPopOver.close();
                });
                return false;
            }
        }, {
            text: $.i18n('bh-be-back'),
            className: 'bh-btn-default',
            callback: function() {

            }
        }], {
            close: function() {
                //确认和取消的时候，都会进入这里
                dailog.remove(); //需要手动销毁
            },
            width: options.width,
            height: options.height
        });

        var html = '';
        var formModel = options.model;
        formModel.forEach(function(item) {
            var modelName = item.caption;
            var name = item.name;
            if (item['form.linkageBy'] || item.linkageBy) {
                hasLink = true;
            }
            html += '<li><div class="bh-checkbox"><input type="checkbox" name=' + name + '><i class="bh-choice-helper"></i></div><span value=' + name + '>' + modelName + '</span></li>';
        });
        $(".bh-batch-edit-list ul").append(html);
        if (!options.hideMember || options.hideMember.length === 0) {
            console.log("hideMember字段必须有值");
        } else {
            for (var i = 0; i < options.hideMember.length; i++) {
                $(".bh-batch-edit-list ul li").find('span[value=' + options.hideMember[i] + ']').parent().remove();
            }
        }
        $(".bh-batch-edit-input > input").keyup(function() {
            var $item = $(this);
            var model = $item.closest(".bh-batch-edit-input").siblings(".bh-batch-edit-list");
            var ul = model.find("ul");
            ul.find("li > span").each(function(i) {
                var $it = $(this);
                var input = $it.closest(".bh-batch-edit-list").siblings(".bh-batch-edit-input").find("input");
                var value = input.val().trim();
                var reg = new RegExp(value, "i");
                var text = $it.text();
                if (text.match(reg) === null) {
                    $it.parent("li").hide();
                } else {
                    $it.parent("li").show();
                }
            });
        });

        if (hasLink) {
            $('#bhBatchEditForm').emapForm({
                data: formModel,
                model: 'h',
                inputWidth: 9,
                renderByGroup: false
            });
            var fieldNames = formModel.map(function(item) {
                return item.name;
            });
            $('#bhBatchEditForm').emapForm("hideItem", fieldNames);
            $(".bh-batch-edit-list ul").on('click', 'input[type=checkbox]', function() {
                var $item = $(this);
                var data = $item.attr("name");
                var ul = $item.closest("ul");
                var form = $("#bhBatchEditForm");
                var count = ul.find("li input[type=checkbox]:checked").length;
                $(".bh-batch-edit section").find(".bh-batch-edit-form-top").html('<h4>' + $.i18n('bh-be-choosed') + count + $.i18n('bh-be-piecesOfKeys') + '</h4>');
                if ($item.prop("checked")) {
                    form.find('.form-validate-block[data-field=' + data + ']').show();
                    form.emapForm("showItem", data);
                } else {
                    form.emapForm("hideItem", data);
                    form.emapForm("clear", [data]);
                }
            });
        } else {
            var rows = formModel.map(function(item) {
                return '<div data-row="' + item.name + '"></div>';
            }).join('');
            $('#bhBatchEditForm').html(rows);

            $(".bh-batch-edit-list ul").on('click', 'input[type=checkbox]', function() {
                var $item = $(this);
                var data = $item.attr("name");
                var ul = $item.closest("ul");
                var form = $('#bhBatchEditForm div[data-row="' + data + '"]');
                var model;
                $(formModel).each(function() {
                    if (this.name === data) {
                        model = this;
                        return false;
                    }
                });
                var count = ul.find("li input[type=checkbox]:checked").length;
                $(".bh-batch-edit section").find(".bh-batch-edit-form-top").html('<h4>' + $.i18n('bh-be-choosed') + count + $.i18n('bh-be-piecesOfKeys') + '</h4>');
                if ($item.prop("checked")) {
                    if (!form.html()) {
                        form.emapForm({
                            data: [model],
                            model: 'h',
                            inputWidth: 9,
                            renderByGroup: false
                        });
                        form.find('.bh-form-horizontal').css('margin-bottom', 0);
                    }
                    form.find('.form-validate-block[data-field=' + data + ']').show();
                    form.emapForm("showItem", data);
                } else {
                    form.emapForm("hideItem", data);
                    form.emapForm("clear", [data]);
                }
            });
        }
    }
})();

(function() {
  var Plugin, _init;
  /**
   * @module emapConditionConstructor
   * @alias 新的条件构造器
   * @description 新的条件构造器
   * @example
   $('#aaa').emapConditionConstructor({
    searchModel:"easy"
    data: Data
  });
   */
  Plugin = (function() {
    function Plugin(element, options) {
      this.options = $.extend({}, $.fn.emapConditionConstructor.defaults, options);
      this.$element = $(element);
      _init(this.$element, this.options);
    }
    //插件的公共方法，相当于接口函数，用于给外部调用
    /**
     * @method setValue
     * @description 根据model数据页面生成条件
     */
    Plugin.prototype.setValue = function(condition) {
      htmlTransfrom(condition, this.options);
    };
    /**
     * @method getValue
     * @description 将插入的条件转换成model数据
     * @return {String}
     */
    Plugin.prototype.getValue = function() {
      return getData(this.options);
    };
    /**
     * @method clear
     * @description 清空条件
     */
    Plugin.prototype.clear = function() {
      var element = this.$element;
      element.find(".bh-condition-content").remove();
    };
    /**
     * @method validate
     * @description 校验搜索条件
     * @param {Boolean} [showErrorWindow=false] - 校验出错是否弹出提示弹窗
     * @return {Boolean} - 校验结果
     */
    Plugin.prototype.validate = function(showErrorWindow) {
        var result = validate(this.$element.find('.bh-condition-content'))
        if (showErrorWindow === true && result === false) {
          showValidateErrorWin()
        }
        return result
      }
      /**
       * @method destory
       * @description 销毁组件实例
       */
    Plugin.prototype.destory = function() {
      var element = this.$element;
      element.remove();
    };
    return Plugin;
  })();
  //插件的私有方法
  _init = function(element, options) {
    _initHtml(element, options);
    _renderEasySearch(element, options)
    _initDropdown(element, options);
    _eventListen(element, options);
  };

  $.fn.emapConditionConstructor = function(options, params) {
    var instance;
    instance = this.data('plugin');
    if (!instance) {
      return this.each(function() {
        return $(this).data('plugin', new Plugin(this, options));
      });
    }
    if (options === true) return instance;
    if ($.type(options) === 'string') {
      return instance[options](params)
    };
    return this;
  };
  /**
   * @memberof module:emapConditionConstructor
   * @prop {String} [searchModel=easy] - 默认搜索模式 可选值： 'easy' 简单模式  'advanced' 高级模式
   * @prop {Boolean} [schema=false] - 是否开启保存方案
   */
  $.fn.emapConditionConstructor.defaults = {
    searchModel: 'easy',
    data: {},
    schema: false
  };
  //条件构造器的初始化html代码
  function _initHtml(element, options) {
    var html = '';
    var wrap = '<div class="bh-condition-constructor-cover" bh-type="normal">@content</div>';
    var search = '<div class="bh-advancedQuery-inputGroup bh-clearfix" style="padding-bottom: 8px;background: #fff;">' +
      '<div class="bh-advancedQuery-quick-search-wrap">' +
      '<input type="text" class="bh-form-control" >' +
      '<i class="iconfont icon-search" style="position: absolute;left: 6px;top: 6px;"></i>' +
      '</div>' +
      '<a class="bh-btn bh-btn bh-btn-primary bh-btn-small" bh-advanced-query-role="easySearchBtn">' + $.i18n('bh-cc-search') + '</a>' +
      '<a href="javascript:void(0);" class="bh-mh-8" bh-advanced-query-role="advancedOpen">[' + $.i18n('bh-cc-condcons') + ']</a>' +
      '</div>' +
      '<div class="bh-advancedQuery-form" bh-advanced-query-role="quickSearchForm">' +
      '</div>'
    var condition = '<div class="bh-condition-constructor">' +
      '<div class="bh-condition-constructor-wrap">' +
      '<div class="bh-condition-constructor-head">' +
      '<ul class="bh-pull-clearfix">' +
      '<li class="bh-pull-left"><span>' + $.i18n('bh-cc-condcons') + '</span></li>' +
      // '<li class="bh-color-grey-3 bh-pull-left">构造方案:</li>' +
      // '<li class="bh-color-primary bh-pull-left">方案1</li>' +
      // '<li class="bh-color-primary bh-pull-left">方案2</li>' +
      // '<li class="bh-color-primary bh-pull-left">更多>></li>' +
      '</ul>' +
      '</div>' +
      '<div class="bh-condition-constructor-condition" class="bh-pull-clear">' +
      '<div class="bh-condition-left bh-pull-left">' +
      '<label class="bh-tag bh-bg-info-4 bh-color-grey">' + $.i18n('bh-cc-and') + '</label>' +
      '<label class="bh-tag bh-bg-info-4 bh-color-grey">' + $.i18n('bh-cc-or') + '</label>' +
      '<label class="bh-tag bh-bg-info-4 bh-color-grey" flag="bh-condition-constructor-bracket">(</label>' +
      '<label class="bh-tag bh-bg-info-4 bh-color-grey" flag="bh-condition-constructor-bracket">)</label>' +
      '</div>' +
      '<div class="bh-condition-middle bh-pull-left">' +
      '<div class="bh-condition-constructor-dropdownlist-wrap bh-pull-left bh-condition-constructor-list-first">' +
      '<div class="bh-condition-constructor-dropDownList1" ></div>' +
      '</div>' +
      '<div class="bh-condition-constructor-dropdownlist-wrap1 bh-pull-left bh-condition-constructor-list-second">' +
      '<div class="bh-condition-constructor-dropDownList2"></div>' +
      '</div>' +
      '<div class="bh-condition-constructor-dropdownlist-wrap bh-pull-left bh-condition-constructor-list-third">' +
      '<div class="bh-condition-constructor-dropDownList3"></div>' +
      '</div>' +
      '</div>' +
      '<div class="bh-condition-right bh-pull-left">' +
      '<button type="button" class="bh-btn bh-btn-primary bh-btn-small bh-condition-constructor-insert" bh-advanced-query-role="' + $.i18n('bh-cc-append') + '">' + $.i18n('bh-cc-append') + '</button>' +
      '<div class="bh-clearfix bh-hide bh-condition-constructor-modify"><button type="button" class="bh-btn bh-btn-primary bh-btn-small bh-pull-left bh-condition-constructor-save"  bh-advanced-query-role="' + $.i18n('bh-cc-save') + '">' + $.i18n('bh-cc-save') + '</button><button type="button" class="bh-btn bh-btn-default bh-btn-small bh-condition-constructor-delete" bh-advanced-query-role="' + $.i18n('bh-cc-delete') + '">' + $.i18n('bh-cc-delete') + '</button></div>' +
      '</div>' +
      '</div>' +
      '<div class="bh-condition-constructor-content">' +
      '<div class="bh-condition-content">' +
      '</div>' +
      '<span class="bh-color-primary"><i class="iconfont">&#xe6a7;</i><a bh-advanced-query-role="' + $.i18n('bh-cc-clear') + '" class="bh-condition-constructor-clear">' + $.i18n('bh-cc-clear') + '</a></span>' +
      '<div class="bh-condition-constructor-footer">' +
      '<div class="bh-btn-grouped">' +
      '<button type="button" class="bh-btn bh-btn-primary bh-btn-small bh-condition-constructor-search" bh-advanced-query-role="' + $.i18n('bh-cc-takeConditionSearch') + '">' + $.i18n('bh-cc-takeConditionSearch') + '</button>' +
      '<button type="button" class="bh-btn bh-btn-default bh-btn-small bh-condition-constructor-case" bh-advanced-query-role="' + $.i18n('bh-cc-saveAsScheme') + '">' + $.i18n('bh-cc-saveAsScheme') + '</button>' +
      '<span class="bh-color-primary" bh-advanced-query-role="' + $.i18n('bh-cc-back') + '"><a class="bh-condition-constructor-exit"><i class="iconfont">&#xe85a;</i>' + $.i18n('bh-cc-back') + '</a></span>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '</div>';
    if (options.searchModel === "easy") {
      html = wrap.replace('@content', search + condition);
    } else {
      html = wrap.replace('@content', condition);
    }
    element.html(html);
    if (options.searchModel === 'advanced') {
      element.find('.bh-condition-constructor').show()
      element.find('.bh-condition-constructor-exit').hide()
      element.find('[bh-advanced-query-role="' + $.i18n('bh-cc-saveAsScheme') + '"]').hide()
    }
    if (options.schema === false) {

    }
    options.container = element.find('.bh-condition-constructor-cover')
  };

  function _renderEasySearch(element, options) {
    var modalData = options.data.controls;
    var guid = BH_UTILS.NewGuid()
    var quickArray = []
    var easyArray = []
    var easySearchPlaceholder = ''
    options.guid = guid;
    $('body').append('<div class="bh-advancedQuery-quick-select" bh-advanced-query-role="advancedEasySelect" data-guid="' + guid + '" ></div>')
    $(modalData).each(function(i) {
      //移除 hidden 项
      var index = modalData.indexOf(this);
      if (this.get('hidden')) {
        modalData.splice(index, 1);
        return true;
      }
      if (!this.xtype || this.xtype == 'text') {} else if ($.inArray(this.xtype, ["radiolist", "checkboxlist", "buttonlist", "multi-buttonlist"]) > -1) {
        options._initCount++;
      }
      if (this.quickSearch) {
        if (!this.xtype || this.xtype == 'text') {
          easyArray.push(this);
        } else {
          quickArray.push(this);
        }
      }
    })

    var easySearch = '';
    var easySearchPlaceholder = ''; // easySearch 文本框placeholder
    if (easyArray.length && easyArray.length > 0) {
      easySearchPlaceholder += $.i18n('bh-cc-pleaseInput');
      $(easyArray).each(function() {
        easySearchPlaceholder += this.caption + '/';
        easySearch += '<p data-name="' + this.name + '">' + $.i18n('bh-cc-search') + '<span class="bh-advancedQuery-easy-caption">' + this.caption + '</span> : <span class="bh-advancedQuery-easy-query"></span></p>';
      });
      $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']').html(easySearch);
      easySearchPlaceholder = easySearchPlaceholder.substring(0, easySearchPlaceholder.length - 1);
      $('.bh-advancedQuery-quick-search-wrap input[type=text]', element).attr('placeholder', easySearchPlaceholder);
    } else {
      $('.bh-advancedQuery-inputGroup, .bh-advancedQuery-form', element).hide();
    }
    // 快速搜索条件渲染
    quickArray = JSON.parse(JSON.stringify(quickArray));
    options.quickArray = quickArray;
    var formOpt = {
      root: '',
      defaultOptions: {
        tree: {
          // checkboxes: true,
          width: 300,
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        "multi-tree": {
          width: "300px",
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        tree2: {
          // checkboxes: true,
          width: 300,
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        "multi-tree2": {
          width: "300px",
          unblind: '/',
          search: true // 高级搜索下拉树默认开启 搜索
        },
        switcher: {
          checked: true
        },
        "date-range": {
          defaultType: 'all'
        },
        "select": {
          width: "300px"
        },
        "multi-select": {
          width: "300px"
        },
        "multi-select2": {
          width: "300px"
        },
        "date-local": {
          width: "300px"
        },
        "date-ym": {
          width: "300px"
        },
        "date-full": {
          width: "300px"
        }
      },
      showBlankOption: options.showBlankOption
    };
    formOpt.defaultOptions = $.extend({}, formOpt.defaultOptions, options.defaultOptions);
    var quickSearchHtml = $('<div></div>');
    $(quickArray).each(function(i) {
      // 应业务线需求将快速搜索中的多选下拉放出  不做类型转换  zhuhui 0722
      if (this.xtype == 'select' || this.xtype == 'radiolist' || this.xtype == 'checkboxlist' || this.xtype == 'multi-select2') {
        this['search.xtype'] = 'buttonlist';
      }
      // 添加 quickSearchXtype属性, 表示字段在 快速搜索中展示的类型 zhuhui 0725
      if (this['search.quickSearchXtype']) {
        this['search.xtype'] = this['search.quickSearchXtype'];
      }
      quickSearchHtml.append(_renderInputPlace(this, undefined, options));
    });
    $('[bh-advanced-query-role=quickSearchForm]', element).html(quickSearchHtml)
      .emapFormInputInit(formOpt);

    element.data('modalarray', modalData);
    element.data('easyarray', easyArray);
    element.data('quickarray', quickArray);
  }

  function _renderInputPlace(item, showClose, options) {
    //showClose  是否显示 关闭按钮
    var _this = item;
    _this.get = function(attr) {
      if (_this['search.' + attr] !== undefined) {
        return _this['search.' + attr];
      } else {
        return _this[attr];
      }
    };
    var attr = WIS_EMAP_SERV.getAttr(_this)
    var xtype = _this.get("xtype");
    var caption = _this.get("caption");
    var builder = _this.get("defaultBuilder");
    var url = _this.get("url");
    var name = _this.get("name");
    var hidden = _this.get("hidden") ? "hidden" : "";
    var placeholder = _this.get("placeholder") ? _this.get("placeholder") : "";
    var checkType = _this.get("checkType");
    var checkSize = _this.get("checkSize");
    var dataSize = _this.get("dataSize");
    var checkExp = _this.get("checkExp");
    var JSONParam = _this.get("JSONParam");
    var format = _this.get("format") ? _this.get("format") : 'yyyy-MM-dd';
    var controlHtml = $(' <div class="bh-advancedQuery-form-row bh-advancedQuery-h-28">' +
      '<div class="bh-advancedQuery-groupName">' + caption + '：</div>' +
      '<div class="bh-advancedQuery-groupList bh-label-radio-group">' +
      '</div>' +
      '</div>');

    if (showClose) {
      controlHtml.append('<a class="bh-bh-advancedQuery-group-dismiss" bh-advanced-query-role="conditionDismiss"> ' +
        '<i class="icon-close iconfont"></i>' +
        '</a>');
    }
    var inputHtml = '';
    switch (xtype) {

      case "tree":
      case "multi-tree":
      case "tree2":
      case "multi-tree2":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" data-url="{{url}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case "date-local":
      case "date-range":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="{{format}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case "date-ym":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="YYYY-MM" {{hidden}}></div>';
        break;
      case "date-full":
        inputHtml += '<div xtype="{{xtype}}" data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" data-format="yyyy-MM-dd HH:mm" {{hidden}}></div>';
        break;
      case "switcher":
        inputHtml += '<div xtype="{{xtype}}"  data-builder="{{builder}}" data-caption="{{caption}}" data-name="{{name}}" {{hidden}}></div>';
        break;
      case "radiolist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-radio" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
        break;
      case "checkboxlist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" class="bh-checkbox" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}}></div>';
        break;
      case "buttonlist":
      case "multi-buttonlist":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} ></div>';
        break;
      case "select":
      case "multi-select":
      case "multi-select2":
      case "selecttable":
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-alloption={{allOption}} data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      case 'number':
      case 'number-range':
        inputHtml += '<div xtype="{{xtype}}" data-name="{{name}}" data-url="{{url}}" data-builder="{{builder}}" data-caption="{{caption}}" {{hidden}} style="max-width: 300px;"></div>';
        break;
      default:
        inputHtml += '<input class="bh-form-control" data-name="{{name}}" name="{{name}}" data-builder="{{builder}}" data-caption="{{caption}}" xtype="text" type="text" {{hidden}} />';
        break;
    }
    inputHtml = inputHtml.replace(/\{\{xtype\}\}/g, xtype)
      .replace(/\{\{name\}\}/g, name)
      .replace(/\{\{builder\}\}/g, builder)
      .replace(/\{\{caption\}\}/g, caption)
      .replace(/\{\{url\}\}/g, url)
      .replace(/\{\{hidden\}\}/g, (hidden ? 'style="display:none;"' : ''))
      .replace(/\{\{allOption\}\}/g, options.allowAllOption)
      .replace(/\{\{format\}\}/g, format);
    inputHtml = $(inputHtml);
    if (JSONParam) {
      inputHtml.data('jsonparam', JSONParam);
    }
    inputHtml.data('attr', attr)
    $('.bh-advancedQuery-groupList', controlHtml).html(inputHtml);
    return controlHtml;
  }



  //下拉表单的初始化
  function _initDropdown(element, options) {
    var firstData = options.data.controls;
    var source = {
      localdata: firstData,
      datatype: "array"
    };
    var dataAdapter = new $.jqx.dataAdapter(source);

    var $dropDownList1 = element.find('.bh-condition-constructor-dropDownList1');
    var $listFirst = element.find('.bh-condition-constructor-list-first');
    $dropDownList1.jqxDropDownList({
      selectedIndex: 0,
      source: dataAdapter,
      displayMember: "caption",
      valueMember: "name",
      height: 28,
      width: "100%",
      filterable: true,
      filterPlaceHolder: $.i18n('bh-cc-pleaseFind'),
      searchMode: 'containsignorecase',
      renderer: function(index, label, value) {
        var builderList = source.localdata[index].builderList;
        var caption = source.localdata[index].caption;
        var xtype = source.localdata[index].xtype;
        var name = source.localdata[index].name;
        var builderList = builderList;
        var html = '<div builderList="' + builderList + '" caption="' + caption + '" xtype="' + xtype + '" name="' + name + '">' + caption + '</div>'
        return html;
      }
    });
    var initFirstItem = $dropDownList1.jqxDropDownList('getSelectedItem');
    var initFirstItemData = initFirstItem.originalItem;
    _relation(initFirstItemData.builderList, initFirstItemData.caption, initFirstItemData.xtype, options);
    $listFirst.on('change', function(event) {
      var args = event.args;
      if (args && args.item) {
        var name = args.item.value
        var modelItem = options.data.controls.filter(function(item) {
          return item.name === name
        })[0]

        var listElement = args.item.element;
        var builderList = modelItem.builderList
        var caption = modelItem.caption
        var xtype = modelItem['search.xtype'] || modelItem['xtype']
        _relation(builderList, caption, xtype, options);
      }
    })

    element.on('change', '.bh-condition-constructor-dropDownList2', function(e) {
      var name = element.find('.bh-condition-constructor-dropDownList1').val()
      var thirdInput = element.find('.bh-condition-constructor-list-third [xtype]')
      var value = element.find('.bh-condition-constructor-dropDownList2').val()
      var modelItem = WIS_EMAP_SERV.cloneObj(options.data.controls.filter(function(item) {
        return item.name === name
      })[0])
      if (thirdInput.length > 0) {
        var inputXtype = thirdInput.attr('xtype')
          // 构造器为多值包含或多值相等时，将下拉、下拉树转变为多选
        if (value === 'm_value_equal' || value === 'm_value_include') {
          if ($.inArray(inputXtype, ['tree', 'tree2', 'select']) > -1) {
            modelItem['search.xtype'] = 'multi-' + inputXtype
            if (inputXtype === 'select') {
              modelItem['search.xtype'] += '2'
            }
            WIS_EMAP_INPUT.init(element.find('.bh-condition-constructor-list-third').empty()
              .append(WIS_EMAP_INPUT.renderPlaceHolder(modelItem)))
          }
        } else {
          // 构造器为不为多值时，将多选下拉、多选下拉树转变为单选
          if ($.inArray(inputXtype, ['multi-tree', 'multi-tree2', 'multi-select', 'multi-select2']) > -1) {
            modelItem['search.xtype'] = inputXtype.replace('multi-', '')
            if (inputXtype === 'multi-select2') {
              modelItem['search.xtype'] = modelItem['search.xtype'].replace('2', '')
            }
            WIS_EMAP_INPUT.init(element.find('.bh-condition-constructor-list-third').empty()
              .append(WIS_EMAP_INPUT.renderPlaceHolder(modelItem)))
          }
        }
      }
    })

  }

  function isMultiInput(xtype) {
    return /multi/.test(xtype)
  }

  function triggerSearch(element, options, conditions, event) {
    if (options.beforeSearch) {
      if (options.beforeSearch(conditions, options) === false) return;
    }
    element.trigger('search', [conditions, options, event]);
  }
  //所有的事件监听
  function _eventListen(element, options) {
    // easySearch 下拉框的关闭
    $(document).on('click', function(e) {
        var target = e.target;
        if ($(target).closest('[bh-advanced-query-role=advancedEasySelect]').length == 0) {
          var selectDiv = $('.bh-advancedQuery-quick-select');
          selectDiv.css({
            'height': 0,
            'border-width': '0'
          });
        }
      })
      // easy搜索 监听 按键输入
    element.on('keyup', '.bh-advancedQuery-quick-search-wrap input[type=text]', function(e) {
      var easySelectH = element.data('easyarray').length * 28 + 1; // 下拉框高度
      var easySelectW = $(this).outerWidth(); // 下拉框宽度
      var searchValue = $(this).val();
      var pos = $(this).offset();
      var selectDiv = $('.bh-advancedQuery-quick-select[data-guid=' + options.guid + ']');
      pos.top += 28;
      // 回车快速搜索
      if (e.keyCode == 13) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
        triggerSearch(element, options, _getSearchCondition(element, options), e);
        return;
      }
      if (searchValue == '') {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
      } else {
        $('.bh-advancedQuery-easy-query', selectDiv).text(searchValue);
        selectDiv.css({
          'height': easySelectH + 'px',
          'width': easySelectW + 'px',
          'border-width': '1px',
          'top': pos.top,
          'left': pos.left
        });
      }
    });

    // 点击下拉快速搜索
    $('[bh-advanced-query-role=advancedEasySelect][data-guid=' + options.guid + ']').on('click', 'p', function(event) {
      var selectDiv = $(this).closest('[bh-advanced-query-role=advancedEasySelect]');
      if (selectDiv.height() > 0) {
        selectDiv.css({
          'height': 0,
          'border-width': '0'
        });
      }
      triggerSearch(element, options, _getSearchCondition(element, options, $(this).data('name')), event);
    });

    // 点击搜索按钮  easy search
    element.on('click', '[bh-advanced-query-role=easySearchBtn]', function(event) {
      triggerSearch(element, options, _getSearchCondition(element, options), event);
    });

    // 点击筛选条件  quick search
    element.on('click', '[bh-advanced-query-role=quickSearchForm] .bh-label-radio', function(event) {
      // radio 的事件冒泡问题
      setTimeout(function() {
        triggerSearch(element, options, _getSearchCondition(element, options), event);
      }, 200);
    });

    element.on('click', '[bh-advanced-query-role=advancedOpen]', function(e) {
      extend('open', options)
    });
    var exitButton = element.find(".bh-condition-constructor-exit");
    exitButton.on('click', function(e) {
      $.bhPopOver({
        content: '<h4>' + $.i18n('bh-cc-backTip') + '</h4>' +
          '<div class="bh-btn-grouped"><button type="button" class="bh-btn bh-btn-circle bh-btn-primary" id="bhConditionConstructorExit"><i class="iconfont icon-check"></i></button><button type="button" class="bh-btn bh-btn-circle bh-btn-default" id="bhConditionConstructorClose"><i class="iconfont icon-close"></i></button></div>',
        selector: exitButton,
        showCloseButton: false,
        width: 236
      });
      $("#bhConditionConstructorClose").on('click', function() {
        $.bhPopOver.close();
      });
      var $insert = element.find(".bh-condition-constructor-insert");
      var $modify = element.find(".bh-condition-constructor-modify");
      $("#bhConditionConstructorExit").on('click', function() {
        var content = element.find(".bh-condition-content");
        content.children().remove();
        $insert.removeClass("bh-hide");
        $modify.addClass("bh-hide");
        $.bhPopOver.close();
        extend('close', options);
        triggerSearch(element, options, _getSearchCondition(element, options), event);
      });
    });
    var left = element.find(".bh-condition-constructor-condition").find(".bh-condition-left");

    // 点击左侧按钮
    left.on('click', 'label', function() {
      var $clickItem = $(this);
      var $highlight = left.find('.bh-condition-active');
      if ($highlight.length > 0) {
        $highlight.removeClass("bh-tag-primary")
          .removeClass("bh-color-white")
          .removeClass("bh-condition-active")
          .addClass("bh-bg-info-4")
          .addClass("bh-color-grey");
      }
      $clickItem.removeClass('bh-bg-info-4').removeClass("bh-color-grey")
        .addClass("bh-tag-primary").addClass("bh-color-white").addClass("bh-condition-active");
      var val = $clickItem.text();
      var flag = $clickItem.attr('flag');
      var className = '';
      if (!flag) {
        flag = '';
      }
      if ($.i18n().locale === 'zh') {
        if (val === "且" || val === "或") {
          className = 'bh-condition-constructor-logic';
        }
      } else {
        if (val === "AND" || val === "OR") {
          className = 'bh-condition-constructor-logic';
        }
      }
      var contentwrap = $clickItem.closest(".bh-condition-constructor-condition").siblings(".bh-condition-constructor-content").find(".bh-condition-content");
      contentwrap.append('<span class="' + className + ' bh-color-grey-3 ' + flag + '">' + val + '<input type="text" class="bh-condition-constructor-input"></span>');
    });
    var constructor = element.find(".bh-condition-constructor");
    // 点击编辑区tag
    constructor.on('click', 'span', function() {
      var $clickItem = $(this);
      $clickItem.find("input").focus();
      var $highlight = constructor.find('.bhFocusFlag');
      if ($highlight.length > 0) {
        $highlight.removeClass("bhFocusFlag");
      }
      $clickItem.addClass("bhFocusFlag");
    });
    constructor.on('keyup', 'input', function(event) {
      var $insert = element.find(".bh-condition-constructor-insert");
      var $modify = element.find(".bh-condition-constructor-modify");
      var item = $(this);
      if (event.keyCode === 37) {
        var prev = item.parent().prev();
        item.removeClass("bhFocusFlag");
        prev.addClass("bhFocusFlag");
        prev.find("input").focus();
      }
      if (event.keyCode === 39) {
        var next = item.parent().next();
        item.removeClass("bhFocusFlag");
        next.addClass("bhFocusFlag");
        next.find("input").focus();
      }
      if (event.keyCode === 46) {
        item.parent().next("span").remove();
      }
      if (event.keyCode === 8) {
        item.parent().remove();
        $insert.removeClass("bh-hide");
        $modify.addClass("bh-hide");
      }
    });
    constructor.on('click', '.bh-constructor-content', function(event) {
      var $insert = element.find('.bh-condition-constructor-insert');
      var $modify = element.find('.bh-condition-constructor-modify');
      var $dropDownList1 = element.find(".bh-condition-constructor-dropDownList1");
      var $dropDownList2 = element.find(".bh-condition-constructor-dropDownList2");
      var $clickItem = $(this);
      var $highlight = constructor.find('.bhChosenFlag');
      if ($highlight.length > 0) {
        $highlight.removeClass("bh-bg-primary-3")
          .removeClass("bhChosenFlag")
          .addClass("bh-bg-primary-4")
      }
      $clickItem.removeClass("bh-bg-primary-4")
        .addClass("bh-bg-primary-3").addClass("bhChosenFlag");
      var caption = $clickItem.attr("caption");
      var builder = $clickItem.attr("builder");
      var value = $clickItem.attr("value");
      var name = $clickItem.attr("name");
      var modelItem = options.data.controls.filter(function(item) {
        return item.name === name
      })[0]
      var xtype = modelItem['search.xtype'] || modelItem['xtype']
      var obj = {};
      obj[name] = value;
      $insert.addClass('bh-hide');
      var $modify = element.find(".bh-condition-constructor-modify");
      $modify.removeClass('bh-hide');

      var item1 = $dropDownList1.jqxDropDownList('getItemByValue', name);
      $dropDownList1.jqxDropDownList('selectItem', item1);

      setTimeout(function() {
        var item2 = $dropDownList2.jqxDropDownList('getItemByValue', builder);
        $dropDownList2.jqxDropDownList('selectItem', item2);
        var children = element.find(".bh-condition-constructor-list-third").children();
        WIS_EMAP_INPUT.setValue(children, name, xtype, obj, '');
      }, 100);
    });
    var condition = element.find('.bh-condition-constructor-search');
    condition.on('click', function(e) {
      doConditionSearch(element, options);
    });
    // var save = element.find('[bh-advanced-query-role="保存为方案"]');
    // save.on('click', function(e) {
    //     htmlTransfrom(element);
    // });
    var insert = element.find('.bh-condition-constructor-insert');
    insert.on('click', function(e) {
      insertValidate(e, options);
    });
    var emptyClear = element.find('.bh-condition-constructor-clear');
    emptyClear.on('click', function(e) {
      clearAll(e, element);
    });
    var deletebutton = element.find(".bh-condition-constructor-delete");
    deletebutton.on('click', function() {
      var chosen = element.find(".bhChosenFlag");
      var $insert = element.find('.bh-condition-constructor-insert');
      var $modify = element.find('.bh-condition-constructor-modify');
      chosen.remove();
      $insert.removeClass("bh-hide");
      $modify.addClass("bh-hide");
    });
    var save = element.find(".bh-condition-constructor-save");
    save.on('click', function(e) {
      var $insert = element.find('.bh-condition-constructor-insert');
      var $modify = element.find('.bh-condition-constructor-modify');
      var chosen = element.find(".bhChosenFlag");
      var html = getValidateHtml(e, options);
      chosen.before(html);
      chosen.remove();
      $insert.removeClass("bh-hide");
      $modify.addClass("bh-hide");
    });
  };
  //表单的联动
  function _relation(builderList, caption, xtype, options) {
    var res = options.data
    var firstData = res.controls
    var reg = /multi/;
    var selectedIndex = 0;
    if (reg.test(xtype)) {
      var builderListData = res.builderLists[builderList];
      for (var i = 0; i < builderListData.length; i++) {
        if ($.i18n().locale === 'zh') {
          if (builderListData[i].caption === "多值相等") {
            selectedIndex = i;
            break;
          }
        } else {
          if (builderListData[i].caption === "m_value_equal") {
            selectedIndex = i;
            break;
          }
        }
      }
    }
    var secondData = res.builderLists[builderList];
    var source = {
      localdata: secondData,
      datatype: "array"
    };
    var dataAdapter = new $.jqx.dataAdapter(source);
    $(".bh-condition-constructor-list-second", options.container).empty();
    $(".bh-condition-constructor-list-second", options.container).html('<div class="bh-condition-constructor-dropDownList2" ></div>');
    $('.bh-condition-constructor-dropDownList2', options.container).jqxDropDownList({
      selectedIndex: selectedIndex,
      source: dataAdapter,
      displayMember: "caption",
      valueMember: "name",
      height: 28,
      width: "100%"
    });
    var dom;
    for (var i = 0; i < firstData.length; i++) {
      if (caption === firstData[i].caption) {
        var obj = firstData[i];
        dom = WIS_EMAP_INPUT.renderPlaceHolder(obj);
        break;
      }
    }
    $(".bh-condition-constructor-list-third", options.container).empty();
    $(".bh-condition-constructor-list-third", options.container).html(dom);
    WIS_EMAP_INPUT.init(dom, {});
  }

  function _findModel(name, modelArray) {
    for (var i = 0; i < modelArray.length; i++) {
      if (modelArray[i].name == name) {
        return modelArray[i];
      }
    }
  }

  function _getSearchCondition(element, options, name, blank_condition) {
    var conditionResult = [];
    var easyArray = element.data('easyarray');
    var modalarray = element.data('modalarray')
    var orCondition = [];
    if (options.searchModel == 'easy') {
      var searchKey = $.trim($('.bh-advancedQuery-quick-search-wrap input', element).val());
      // 简单搜索
      if (searchKey != "") {
        if (name) {
          //简单搜索的下拉框搜索
          var searchItem = _findModel(name, easyArray);
          var conditionData = {
            "caption": searchItem.caption,
            "name": searchItem.name,
            "value": searchKey,
            "builder": (searchItem.defaultBuilder == "equal" ? "include" : searchItem.defaultBuilder), // equal时强制转换为include
            "linkOpt": "AND"
          };
          conditionResult.push(conditionData);
        } else {
          for (var i = 0; i < easyArray.length; i++) {
            var conditionData = {
              "caption": easyArray[i].caption,
              "name": easyArray[i].name,
              "value": searchKey,
              "builder": (easyArray[i].defaultBuilder == "equal" ? "include" : easyArray[i].defaultBuilder), // equal时强制转换为include
              "linkOpt": "OR"
            };
            orCondition.push(conditionData);
          }
          conditionResult.push(orCondition);
        }
      }
      conditionResult = conditionResult.concat(_getConditionFromForm($('[bh-advanced-query-role=quickSearchForm]', options.$advanced), options));
    }
    return JSON.stringify(conditionResult)
  }

  function _getConditionFromForm(form, options) {
    var model = form.closest('.bh-condition-constructor-cover').parent().data('modalarray');
    var conditionArray = [];
    var formElement = $('[xtype]', form);
    var formValue = WIS_EMAP_INPUT.formGetValue(form, options);
    return WIS_EMAP_INPUT.getConvertCondition(formValue, model, true);
  }

  //条件构造器展开动画
  // action  open close
  function extend(action, options) {
    var $condition = options.container
    var type = $condition.attr('bh-type');
    if (action === 'open') {
      $condition.attr('bh-type', 'extend').css('height', '0');
      setTimeout(function() {
        $condition.find('.bh-advancedQuery-inputGroup, .bh-advancedQuery-form').hide();
        $condition.find('.bh-condition-constructor').show();
        $condition.css('height', '272px');
      }, 360);
      options.searchModel = 'advanced'
    } else {
      $condition.attr('bh-type', 'normal').css('height', '0');
      setTimeout(function() {
        $condition.find('.bh-condition-constructor').hide();
        $condition.find('.bh-advancedQuery-inputGroup, .bh-advancedQuery-form').show();
        $condition.css('height', 'auto');
      }, 360);
      options.searchModel = 'easy'
    }
  };
  //插入条件操作
  function insertValidate(e, options) {
    var $target = $(e.target);
    var html = getValidateHtml(e, options);
    if (html) {
      var right = $target.closest(".bh-condition-right");
      var content = right.closest(".bh-condition-constructor-condition").siblings(".bh-condition-constructor-content").find(".bh-condition-content");
      var span = content.find(".bhFocusFlag");
      if (span.length) {
        span.after(html);
      } else {
        content.append(html);
      }
    } else {
      console.log('没有选中值');
    }
  };
  //获取输入条件html代码
  function getValidateHtml(e, options) {
    if ($.i18n().locale === 'zh') {
      var character = {
        "等于": '=',
        "包含": '包含',
        "不包含": '不包含',
        "不等于": '不等于',
        "大于": '>',
        "小于": '<',
        "大于等于": '>=',
        "小于等于": "<=",
        "以..开始": '以..开始',
        "以..结束": '以..结束',
        "多值相等": '='
      };
    } else {
      var character = {
        'equal': '=',
        'more': '>',
        'less': '<',
        'm_value_equal': '=',
        "include": 'include',
        "not_include": 'not_include',
        "not_equal": 'not_equal',
        "more_equal": '>=',
        "less_equal": "<=",
        "start_with": 'start_with',
        "end_with": 'end_with'
      };
    }
    var $target = $(e.target);
    var right = $target.closest(".bh-condition-right");
    var middle = right.siblings(".bh-condition-middle");
    var left = middle.siblings(".bh-condition-left");
    var first = middle.find(".bh-condition-constructor-list-first");
    var second = middle.find(".bh-condition-constructor-list-second");
    var third = middle.find(".bh-condition-constructor-list-third");
    var item1 = first.find(".bh-condition-constructor-dropDownList1").jqxDropDownList('getSelectedItem');
    var name1 = item1.value
    var originalItem1 = options.data.controls.filter(function(item) {
      return item.name === name1
    })[0]

    var value1 = item1.label;
    // var originalItem1 = item1.originalItem;
    var xtype = originalItem1.xtype || 'text';
    // var name1 = originalItem1.name;
    var caption1 = originalItem1.caption;
    var builderList1 = originalItem1.builderList;
    var item2 = second.find(".bh-condition-constructor-dropDownList2").jqxDropDownList('getSelectedItem');
    var key = item2.label;
    var originalItem2 = item2.originalItem;
    var builder = originalItem2.name;
    var value2 = character[key];
    var value_dis = {};
    var value = WIS_EMAP_INPUT.getValue(third.children(), value_dis);
    var value_display = value_dis[name1 + '_DISPLAY'];
    if (!value_display) {
      value_display = value;
    }
    var content = right.closest(".bh-condition-constructor-condition").siblings(".bh-condition-constructor-content").find(".bh-condition-content");
    var html = '';
    if (value1 && value2 && value) {
      html = '<span class="bh-constructor-content bh-bg-primary-4" name=' + name1 + ' caption=' + caption1 + ' builderList=' + builderList1 + ' builder=' + builder + ' value=' + value + ' value_display=' + value_display + ' xtype=' + xtype + '>' + value1 + '<span class=" bh-color-primary-2"> ' + value2 + '</span>' + value_display + '<input type="text" class="bh-condition-constructor-input"></span>';
    }
    return html;
  };
  //清空条件
  function clearAll(e, element) {
    var $target = $(e.target);
    $.bhPopOver({
      content: '<h4>' + $.i18n('bh-cc-willClearConditions') + '</h4>' +
        '<div class="bh-btn-grouped"><button type="button" class="bh-btn bh-btn-circle bh-btn-primary" id="bhConditionConstructorClear"><i class="iconfont icon-check"></i></button><button type="button" class="bh-btn bh-btn-circle bh-btn-default" id="bhConditionConstructorClose1"><i class="iconfont icon-close"></i></button></div>',
      selector: $($target),
      showCloseButton: false,
      width: 236
    });
    $("#bhConditionConstructorClear").on('click', function() {
      var content = element.find(".bh-condition-content");
      content.children().remove();
      var $insert = element.find(".bh-condition-constructor-insert");
      $insert.removeClass('bh-hide');
      var $modify = element.find(".bh-condition-constructor-modify");
      $modify.addClass('bh-hide');
      element.trigger('search', ['[]']);
      $.bhPopOver.close();
    });
    $("#bhConditionConstructorClose1").on('click', function() {
      $.bhPopOver.close();
    });
  };

  function renderConditionItem(itemData, modelItem, options) {
    var dom = $('<span class="bh-constructor-content bhFocusFlag bh-bg-primary-3 bhChosenFlag"></span>')
    dom.attr({
      name: itemData.name,
      caption: itemData.caption || modelItem.caption,
      builderlist: modelItem.builderList,
      builder: itemData.builder,
      value_display: itemData.value_display,
      value: itemData.value
    })
    dom.append(itemData.caption || modelItem.caption)
    dom.append('<span class="concat bh-color-primary-2">' + getBuilderText(itemData.builder, options, itemData.builderlist) + '</span>')
    dom.append(itemData.value_display)
    dom.append('<input type="text" class="bh-condition-constructor-input">')
    return dom
  }

  function getBuilderText(builder, options, builderlist) {
    var builderMap = {
      'equal': '=',
      'more': '>',
      'less': '<',
      'm_value_equal': '='
    }
    if (builderMap[builder]) {
      return builderMap[builder]
    } else {
      return options.data.builderLists[builderlist].filter(function(item) {
        return item.name === builder
      })[0]['caption']
    }
  }

  function getLinkOpt(item) {
    var linkOpt
    if (item instanceof Array) {
      for (var i = 1; i < item.length; i++) { // 跳过数组第一项
        if (!(item[i] instanceof Array)) {
          linkOpt = item[i].linkOpt
          break
        }
      }
      if (linkOpt === undefined && item.length > 1) {
        linkOpt = getOuterLinkOpt(item[2])
      }
    } else {
      linkOpt = item.linkOpt
    }
    return linkOpt
  }
  // 获取外层linkOpt
  function getOuterLinkOpt(item) {
    if (item instanceof Array) {
      return getLinkOpt(item[0])
    } else {
      return item.linkOpt
    }
  }

  function renderConditionArray(itemArray, model, options) {
    if (itemArray.length === 0) return ''
    var dom = $('<div><span class=" bh-color-grey-3 bh-condition-constructor-bracket">(<input type="text" class="bh-condition-constructor-input"></span></div>')
    var linkOpt = getLinkOpt(itemArray)
    var linkText
    if (linkOpt === 'OR') {
      if ($.i18n().locale === 'zh') {
        linkText = '或'
      } else {
        linkText = 'OR'
      }
    } else if (linkOpt === 'AND') {
      if ($.i18n().locale === 'zh') {
        linkText = '且'
      } else {
        linkText = 'AND'
      }
    } else {
      linkText = linkOpt
    }
    itemArray.map(function(item, index) {
      if (item instanceof Array) {
        dom.append(renderConditionArray(item, model, options))
      } else {
        var modelItem = model.filter(function(mItem) {
          return mItem.name === item.name
        })[0]
        dom.append(renderConditionItem(item, modelItem, options))
      }
      if (index + 1 < itemArray.length) {
        dom.append('<span class="bh-condition-constructor-logic bh-color-grey-3 ">' + linkText + '<input type="text" class="bh-condition-constructor-input"></span>')
      }
    })
    dom.append('<span class=" bh-color-grey-3 bh-condition-constructor-bracket">)<input type="text" class="bh-condition-constructor-input"></span>')
    return dom.html()
  }

  //将model数据转换为搜索条件的html代码
  function htmlTransfrom(condition, options) {
    var con
    var content = options.container.find(".bh-condition-content")
    var model = options.data.controls
    if (typeof condition === 'string') {
      try {
        con = JSON.parse(condition)
      } catch (e) {
        console && console.error('无效的json格式')
      }
    } else {
      con = condition
    }
    var contentHtml = $(renderConditionArray(con, model, options))
      // 去掉开始和结束位置的两个括号
    content.html(contentHtml)
    content.find('.bh-condition-constructor-bracket:first').remove()
    content.find('.bh-condition-constructor-bracket:last').remove()
      /*
      var data = [{
          builder: "equal",
          builderlist: "cbl_List",
          caption: "性别",
          linkOpt: "或",
          name: "XBDM",
          value: "1",
          value_display: "男"
        },
        {
          builder: "equal",
          builderlist: "cbl_List",
          caption: "性别",
          linkOpt: "或",
          name: "XBDM",
          value: "2",
          value_display: "女"
        }
      ];
      var aa = JSON.stringify(data);
      var html = '';
      var templString = '';
      var nowBracketFlag = false;
      var htmlData = [];
      var json = {
        "equal": "=",
        "multiEqual": "="
      };
      for (var i = 0; i < aa.length; i++) {
        var char = aa[i];
        switch (char) {
          case '[':
            html += '<span class=" bh-color-grey-3 bh-condition-constructor-bracket">(<input type="text" class="bh-condition-constructor-input"></span>';
            break;
          case ']':
            html += '<span class=" bh-color-grey-3 bh-condition-constructor-bracket">)<input type="text" class="bh-condition-constructor-input"></span>';
            break;
          case '{':
            nowBracketFlag = true;
            templString += char;
            break;
          case '}':
            nowBracketFlag = false;
            templString += char;
            var templObj = JSON.parse(templString);
            html = html.replace(',', '<span class="bh-condition-constructor-logic bh-color-grey-3 ">' + templObj.linkOpt + '<input type="text" class="bh-condition-constructor-input"></span>');
            html += '<span class="bh-constructor-content bh-bg-primary-4" name="' + templObj.name + '" caption="' + templObj.caption + '" builderlist="' + templObj.builderlist + '" builder="' + json[templObj.builder] + '" value="' + templObj.value + '" value_display="' + templObj.value_display + '" xtype="' + templObj.xtype + '">' + templObj.caption + '<span class="concat bh-color-primary-2">' + json[templObj.builder] + '</span>' + templObj.value_display + '<input type="text" class="bh-condition-constructor-input"></span>';
            templString = '';
            break;
          case ',':
            if (nowBracketFlag) {
              templString += char;
            } else {
              html += ',';
            }
            break;
          default:
            if (nowBracketFlag) {
              templString += char;
            }
            break;

        }
      }
      var content = element.find(".bh-condition-content");
      content.html(html);
      */
  };
  //执行条件搜索
  function doConditionSearch(element, options) {
    var $content = element.find(".bh-condition-content");
    $content.children('span').each(function() {
      var item = $(this);
      item.removeAttr("start").removeAttr("end").removeAttr("level").removeClass("bh-color-danger").addClass("bh-color-grey-3");
    });
    var result = dentifyRelationship();

    if (result) {
      var data = getData(options);
      element.trigger('search', [data]);
    } else {
      showValidateErrorWin()
    }
  };

  function showValidateErrorWin() {
    var dailog = $('<p>' + $.i18n('bh-cc-checkError') + '</p><ul class="bh-mt-24"><li>' + $.i18n('bh-cc-checkBrackets') + '</li><li>' + $.i18n('bh-cc-conditionsWithoutAndOr') + '</li><li>' + $.i18n('bh-cc-andOrWithoutConditions') + '</li></ul>');
    BH_UTILS.bhWindow(dailog, $.i18n('bh-cc-error'), [{
      text: $.i18n('bh-cc-ok'),
      className: 'bh-btn-primary',
      callback: function() {
        BH_UTILS.bhWindow.close()
      }
    }], {
      height: 238,
      width: 512
    });
  }

  //确定括号层级关系
  function dentifyRelationship() {
    var initialization = {
      start: 0,
      level: 0
    };
    var $content = $(".bh-condition-content");
    var $span = $content.children("span");
    //设置括号起始结束位置和条件等的层级
    setBracket(initialization, $span);

    //校验括号,内容,且或关系
    var flag = validate($content);
    if (!flag) {
      return false;
    } else {
      // return getData($content);
      return true;
    }

  };

  /***
   * 设置括号的起始结束位置和层级
   * 条件和且或的层级
   * @param initialization
   * @param $span
   */
  function setBracket(initialization, $span) {
    $span.each(function() {
      var $item = $(this);
      //对括号进行设置
      if ($item.hasClass("bh-condition-constructor-bracket")) {
        if ($item.text() === "(") {
          setLeftBracket(initialization, $item);
        } else {
          setRightBracket(initialization, $item);
        }
      } else {
        setCondition(initialization, $item);
      }
    });
  };

  /***
   * 设置左括号的起始值和层级
   * 当前左括号的相邻的左侧元素是左括号的时候,当前左括号的层级加1
   * 否则与前一个元素的层级相同
   * @param initialization
   * @param $item
   */
  function setLeftBracket(initialization, $item) {
    var start = initialization.start;
    var level = initialization.level;
    $item.attr("start", start);
    initialization.start++;
    var prev = $item.prev();
    if (prev.length > 0) {
      if (prev.text() === "(") {
        level = parseInt(prev.attr('level'), 10) + 1;
      } else {
        level = prev.attr("level");
      }
    }
    $item.attr("level", level);
  };

  /***
   * 设置右括号的起始值和层级
   * 向该右括号的左侧依次寻找到与之匹配的左括号,同时给左括号和当前右括号添加完结标识
   * @param initialization
   * @param $item
   */
  function setRightBracket(initialization, $item) {
    var prev = $item.prevAll();
    prev.each(function() {
      var it = $(this);
      if (it.hasClass("bh-condition-constructor-bracket") && !it.attr("over")) {
        var start = it.attr("start");
        var level = it.attr("level");
        $item.attr("end", start).attr("level", level).attr("over", "true");
        it.attr("over", "true");
        return false;
      }
    });
  };

  /***
   * 给条件和且或添加层级
   * 给且或添加start标识,用于校验处理
   * @param initialization
   * @param $item
   */
  function setCondition(initialization, $item) {
    var prev = $item.prev();
    var level = initialization.level;
    if (prev.length > 0) {
      if (prev.text() === "(") {
        level = parseInt(prev.attr('level'), 10) + 1;
      } else {
        level = prev.attr("level");
      }
    }
    initialization.start++;
    $item.attr("level", level).attr('start', initialization.start);
  };

  /***
   * 校验条件,并给不符合的条件添加高亮
   * @param $content
   * @returns {boolean}
   */
  function validate($content) {
    var flag = true;
    //校验括号
    flag = validateBracket($content);
    if (!flag) {
      return flag;
    }

    //校验条件内容
    flag = validateContent($content);
    if (!flag) {
      return flag;
    }

    //校验且或关系
    flag = validateLogic($content);
    return flag;
  };

  /***
   * 校验括号
   * 1、括号是否闭合
   * 2、左右括号是否相邻
   * @param $content
   * @returns {boolean}
   */
  function validateBracket($content) {
    var flag = true;
    $content.children('.bh-condition-constructor-bracket').each(function() {
      var $bracket = $(this);
      var checkFlag;
      if ($bracket.text() === '(') {
        checkFlag = validateBracketLeft($bracket, $content);
      } else {
        checkFlag = validateBracketRight($bracket, $content);
      }
      if (!checkFlag) {
        flag = false;
      }
    });
    return flag;
  }

  /***
   * 校验左括号
   * 取到当前左括号的start,寻找end值与之匹配的右括号
   * 若与当前左括号相邻的右侧元素是右括号,校验不通过
   * 若与之相邻的右侧元素是且或关系符,校验不通过
   * @param $bracket
   * @param $content
   * @returns {boolean}
   */
  function validateBracketLeft($bracket, $content) {
    var flag = true;
    var start = $bracket.attr('start');
    var $rightBracket = $content.children('[end="' + start + '"]');
    if ($rightBracket.length === 0) {
      $bracket.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      flag = false;
    }

    // 若与当前左括号相邻的右侧元素是右括号,校验不通过
    //若与之相邻的右侧元素是且或关系符,校验不通过
    var $next = $bracket.next();
    if (($next.hasClass('bh-condition-constructor-bracket') && $next.text() === ')') || $next.hasClass('bh-condition-constructor-logic')) {
      $bracket.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      $next.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      flag = false;
    }
    return flag;
  }

  /***
   * 校验右括号
   * 1、没有与之匹配的左括号,校验不通过
   * 2、相邻的右侧元素是左括号,校验不通过
   * @param $bracket
   * @param $content
   * @returns {boolean}
   */
  function validateBracketRight($bracket, $content) {
    var flag = true;
    var end = $bracket.attr('end');
    var $next = $bracket.next();
    var $rightBracket = $content.children('[start="' + end + '"]');
    if (!end || $rightBracket.length === 0) {
      $bracket.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      flag = false;
    }
    if ($next.length > 0 && (($next.hasClass('bh-condition-constructor-bracket') && $next.text() === '(') || $next.hasClass('bh-constructor-content'))) {
      $bracket.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      $next.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      flag = false;
    }
    var $prev = $bracket.prev();
    if ($prev.hasClass('bh-condition-constructor-logic')) {
      $bracket.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      $prev.addClass('bh-color-danger').removeClass('bh-color-grey-3');
      flag = false;
    }

    return flag;
  }
  /***
   * 校验条件
   * 与之相邻的右侧元素依然是条件时,校验不通过
   * @param $content
   * @returns {boolean}
   */
  function validateContent($content) {
    var flag = true;
    $content.children('.bh-constructor-content').each(function() {
      var $condition = $(this);
      var $next = $condition.next();
      if ($next.hasClass('bh-constructor-content')) {
        $condition.addClass('bh-color-danger').removeClass('bh-color-grey-3');
        $next.addClass('bh-color-danger').removeClass('bh-color-grey-3');
        flag = false;
      }
    });
    return flag;
  }
  /***
   * 校验且或
   * 先克隆内容
   * 先将条件清空
   * 寻找到括号范围内的且或符,只有同为且或者同为或的才能校验通过
   * @param $content
   * @returns {boolean}
   */
  function validateLogic($content) {
    var flag = true;

    $content.children('.bh-condition-constructor-logic').each(function() {
        var $logic = $(this);
        var $prev = $logic.prev();
        var $next = $logic.next();
        if ($prev.length === 0 || $next.length === 0) {
          flag = false;
          $logic.addClass('bh-color-danger').removeClass('bh-color-grey-3');
        }
      })
      //先克隆内容
    var $clone = $content.clone();
    //移除条件
    $clone.children('.bh-constructor-content').remove();
    //找到所有的且或
    $clone.children('.bh-condition-constructor-logic').each(function() {
      //临时存放同级且或符
      var tempLogic = [];
      var $item = $(this);
      //排除括号,排除已验证过的且或符(通过checked标识)
      if (!$item.attr('checked')) {
        //取到且或符右侧的所有元素
        var $nextAll = $item.nextAll();
        //将当前元素放入临时数组
        tempLogic.push($item);
        //循环所有的右侧元素并放入临时数组,直到遇到括号,结束当前遍历
        $nextAll.each(function() {
          var $next = $(this);
          //没遇到括号,将元素并放入临时数组
          if ($next.hasClass('bh-condition-constructor-bracket')) {
            //结束当前遍历
            return false;
          } else {
            tempLogic.push($next);
          }
        });
        //判断临时变量中的且或关系是否符合逻辑,若校验不通过设置对应的且或符高亮
        var checkLogicFlag = checkLogicIsSame(tempLogic, $content);
        if (!checkLogicFlag) {
          flag = false;
        }
      }
    });
    return flag;
  }
  /***
   * 判断临时变量中的且或关系是否符合逻辑,若校验不通过设置对应的且或符高亮
   * @param $logicList
   * @param $content
   * @returns {boolean}
   */
  function checkLogicIsSame($logicList, $content) {
    var flag = true;
    var len = $logicList.length;
    if (len > 1) {
      //临时存放且或符,第一次进入循环时存入且或符,然后与之依次进行判断
      var temp = '';
      for (var i = 0; i < len; i++) {
        if (temp) {
          if (temp !== $logicList[i].text()) {
            flag = false;
            break;
          }
        } else if (!temp) {
          temp = $logicList[i].text();
        }
      }
      //校验不通过,设置且或符高亮
      if (!flag) {
        setLogicHeight($logicList, $content);
      }
    }
    return flag;
  }
  /***
   * 设置且或符高亮
   * @param $logicList
   * @param $content
   */
  function setLogicHeight($logicList, $content) {
    var len = $logicList.length;
    for (var i = 0; i < len; i++) {
      var start = $($logicList[i]).attr('start');
      $content.children('[start="' + start + '"]').addClass('bh-color-danger').removeClass('bh-color-grey-3');
    }
  }
  /***
   * 获取数据
   * 先将只包含了条件(没有且或符)的括号去掉
   * 递归依次按层级取出逻辑条件
   * @param $content
   */
  function getData(options) {
    var $content = options.container.find('.bh-condition-content')
    var $spans = $content.children('span');
    var data = cycle($spans);
    // if (data.length === 1 && data[0].constructor === Array) {
    //     data = data[0];
    // }
    return JSON.stringify(data);

  }

  function getConditionItem($span, linkopt) {
    return {
      name: $span.attr('name'),
      caption: $span.attr('caption'),
      builderlist: $span.attr('builderlist'),
      builder: $span.attr('builder'),
      value: $span.attr('value'),
      value_display: $span.attr('value_display') || '',
      xtype: $span.attr('xtype'),
      linkOpt: linkopt
    }
  }

  function getConditionArray($spans, index, outerLinkOpt) {
    var arrayData = []
    var linkopt = getCurLinkOpt($spans, index)
    var counter = 0
    for (var i = index, len = $spans.length; i < len; i++) {
      var $span = $($spans[i])
      if ($span.hasClass('bh-condition-constructor-bracket')) { // 括号span
        if ($span.text().indexOf(')') > -1) { // 遇到右括号代表循环结束
          if (counter === 0) {
            break
          } else {
            counter--
          }
        } else if ($span.text().indexOf('(') > -1) {
          if (counter === 0) {
            arrayData.push(getConditionArray($spans, i + 1, outerLinkOpt))
          }
          counter++
        }
      } else if ($span.hasClass('bh-constructor-content')) { // 条件项span
        if (i === index) {
          arrayData.push(getConditionItem($spans.eq(i), outerLinkOpt))
        } else if (counter === 0) {
          arrayData.push(getConditionItem($spans.eq(i), linkopt))
        }
      }
    }
    return arrayData
  }

  // 获取当前数组的linkOpt
  function getCurLinkOpt($spans, index) {
    var counter = 0
    for (var i = index; i < $spans.length; i++) {
      if ($spans.eq(i).hasClass('bh-condition-constructor-bracket')) { // 括号span
        if ($spans.eq(i).text().indexOf('(') > -1) {
          counter++
        } else if ($spans.eq(i).text().indexOf(')') > -1) {
          counter--
        }
      } else if ($spans.eq(i).hasClass('bh-condition-constructor-logic') && counter === 0) { // 只有在counter==0的时候，该逻辑连接符才能作为当前数组的逻辑连接符
        if ($.i18n().locale === 'zh') {
          return $spans.eq(i).text().indexOf('或') > -1 ? 'OR' : 'AND'
        } else {
          return $spans.eq(i).text().indexOf('OR') > -1 ? 'OR' : 'AND'
        }
      }
    }
  }

  /***
   * 递归依次按层级取出逻辑条件
   * @param $spans
   * @param level
   * @returns {Array}
   */
  function cycle($spans) {
    var data = [];
    var templData = [];
    var nowBracketFlag = false;
    var start = 0;
    var linkOpt = getCurLinkOpt($spans, 0)
    return getConditionArray($spans, 0, linkOpt)
      /*
      for (var i = 0, len = $spans.length; i < len; i++) {
        var $span = $($spans[i])
        if ($span.hasClass('bh-condition-constructor-bracket')) {
          data.push([])
        }
      }



      for (var i = 0, len = $spans.length; i < len; i++) {
        var $span = $($spans[i]);
        if ($span.hasClass('bh-condition-constructor-bracket') && $span.attr('level') == level) {
          if ($span.text() === '(') {
            nowBracketFlag = true;
            start = $span.attr('start');
          } else {
            nowBracketFlag = false;
            data.push(cycle(templData, level + 1, $content));
            templData = [];
          }
        } else {
          if (nowBracketFlag) {
            templData.push($span);
          } else {
            if ($span.hasClass('bh-constructor-content')) {
              var conditionData = getConditionData($span, $content);
              data.push(conditionData);
            }
          }
        }
      }
      return data;
      */
  }
  //获取条件的数据
  function getConditionData($span, $content) {
    var name = $span.attr('name');
    var caption = $span.attr('caption');
    var builderlist = $span.attr('builderlist');
    var builder = $span.attr('builder');
    var value = $span.attr('value');
    var linkOpt = getLogicData($span, $content);
    var value_display = $span.attr('value_display');
    return {
      name: name,
      caption: caption,
      builderlist: builderlist,
      builder: builder,
      value: value,
      linkOpt: linkOpt,
      value_display: value_display
    }
  }
  //获取数据的linkOpt字段值
  function getLogicData($span, $content) {
    var logicText = '';
    var $prev = $span.prev();
    var $next = $span.next();
    if ($prev.hasClass('bh-condition-constructor-logic')) {
      logicText = $prev.text();
    } else {
      if ($prev.hasClass("bh-condition-constructor-bracket") && $prev.text() === "(") {
        if ($prev.prev()) {
          logicText = $prev.prev().text();
        }
      }
      var start = $prev.attr('start');
      var nextText = $content.children('[end="' + start + '"]').next().text();
      if (nextText) {
        logicText = nextText;
      } else {
        if ($next.hasClass('bh-condition-constructor-logic')) {
          logicText = $next.text();
        } else {
          if ($prev.hasClass("bh-condition-constructor-bracket") && $prev.text() === ")") {
            if ($next.next()) {
              logicText = $next.next().text();
            }
          }
        }
      }
    }
    if ($.i18n().locale === 'zh') {
      if (logicText === '或') {
        return 'OR'
      } else if (logicText === '且') {
        return 'AND'
      }
    } else {
      if (logicText === 'OR') {
        return 'OR'
      } else if (logicText === 'AND') {
        return 'AND'
      }
    }
    return logicText;
  }
}).call(this);
(function() {
    var Plugin;
    var editedBg = 'cell-edited';
    var toDeleteKey = 'isToDelete';
    var toDeleteLine = 'to-delete-line';
    var showToDeleteLine = 'show-to-delete';

    /**
     * @module emapdatatable
     * @alias 表格
     * @description 数据表格
     */
    Plugin = (function() {
        function Plugin(element, options) {
            //将插件的默认参数及用户定义的参数合并到一个新的obj里
            this.settings = $.extend({}, $.fn.emapdatatable.defaults, options);
            //将dom jquery对象赋值给插件，方便后续调用
            this.$element = $(element);
            this.$element.attr("emap-role", "datatable").attr("emap-pagePath", this.settings.pagePath).attr("emap-action", this.settings.action);

            //拼接请求地址
            var url = this.settings.url || WIS_EMAP_SERV.getAbsPath(this.settings.pagePath).replace('.do', '/' + this.settings.action + '.do');

            //前端模拟数据开发时type使用get方式
            var ajaxMethod = this.settings.method || 'POST';
            if (typeof window.MOCK_CONFIG != 'undefined') {
                //qiyu 2016-7-21 将emapdatatable中的获取mock的url提取函数，在mock文件中重新定义
                ajaxMethod = this.settings.method || getMethodMock();
                if (typeof this.settings.url == 'undefined') {
                    url = getURLMock(url, this.settings);
                }
            }
            var params = null;
            if (this.settings.params || this.settings.onceParams) {
                params = $.extend({}, this.settings.params, this.settings.onceParams);
            } else {
                params = $.extend({}, this.settings.defaultParams);
                params = _getQuerySetting(params);
            }
            //数据源
            if (this.settings.source) {
                this.source = this.settings.source;
            } else {
                this.source = {
                    root: 'datas>' + this.settings.action + '>rows',
                    id: this.settings.pk || 'WID', // id: "WID", 主键字段可配置  //qiyu 2016-1-16
                    datatype: 'json',
                    url: url,
                    data: params || {},
                    type: WIS_EMAP_CONFIG.tableDataType || ajaxMethod,
                    datafields: []
                };
            }

            //qiyu 2016-7-21 将emapdatatable中的获取mock的url提取函数，在mock文件中重新定义
            if (typeof window.MOCK_CONFIG != 'undefined') {
                this.source = getSourceMock(this.source);
            }

            _create(this);
        }

        /**
         * @method reload
         * @description 刷新表格数据
         * @param {Object} params - 附带参数
         * @param {Object} params._gotoFirstPage -
         * callback 可以是function 或者是 true，true的话意味着强制跳回第一页
         * _gotoFirstPage 如果callback为回调函数，此时需要调回第一页 则可以设置params._gotoFirstPage为true
         *
         */
        Plugin.prototype.reload = function(params, callback) {
            /**
             * 方法内容
             */
            if (!$.isEmptyObject(this.settings.defaultParams)) {
                this.source.data = _getQuerySetting(this.settings.defaultParams);
            }

            var gotoFirstPage = params._gotoFirstPage;
            gotoFirstPage && delete params._gotoFirstPage;
            if (!$.isEmptyObject(params)) {
                if (!$.isEmptyObject(this.settings.defaultParams)) {
                    try {
                        var query = JSON.parse(params.querySetting);
                        query.push.apply(query, JSON.parse(this.source.data.querySetting));
                        this.source.data.querySetting = JSON.stringify(query);
                    } catch (e) {
                        this.source.data = params;
                    }
                } else {
                    this.source.data = params;
                }
            }
            if (callback === true || gotoFirstPage === true) {
                if (!this.$element.jqxDataTable('goToPage', 0)) {
                    this.$element.jqxDataTable('updateBoundData');
                }
            } else {
                this.$element.jqxDataTable('updateBoundData');
            }

            var that = this;
            if (typeof callback == 'function') {
                var intervalId = setInterval(function() {
                    if (that.$element.jqxDataTable('isBindingCompleted')) {
                        clearInterval(intervalId);
                        // 将callback放在 refresh后面， 避免callback中的dom操作被refresh刷新掉 zhuhui 2016-10-21
                        that.$element.jqxDataTable('refresh');
                        callback();
                    }
                }, 10);
            }
        };

        /**
         * @method getCurrentQueryParams
         * @description 获取当钱表格传到后台的查询条件，包含排序
         * @return {Object}
         */
        Plugin.prototype.getCurrentQueryParams = function() {
            return this.$element.data('currentQueryParams');
        };

        /**
         * @method reloadFirstPage
         * @description 默认刷新表格回到首页
         * @param {Object} params - 附带参数
         * @param {Function} callback - 回调函数
         */
        Plugin.prototype.reloadFirstPage = function(params, callback) {
            this.reload($.extend({}, params, {
                _gotoFirstPage: true
            }), callback);
        };

        /**
         * @method checkedRecords
         * @description 获取选中的数据
         */
        Plugin.prototype.checkedRecords = function() {
            var selectedArr = [];
            var rowsData = this.$element.jqxDataTable('getRows');
            var $checkedSelector = this.$element.find('table:not([id^="pinnedtable"]) tr');
            if (this.$element.find('table[id^="pinnedtable"]').length > 0) {
                $checkedSelector = this.$element.find('table[id^="pinnedtable"] tr');
            }
            var self = this;
            $checkedSelector.each(function(index) {
                var row = rowsData[index];
                if (self.settings.editMode && $(this).find('.' + editedBg).length) {
                    var value = WIS_EMAP_INPUT.formGetValue($(this), {});
                    row = $.extend({}, row, value);
                }
                if ($(this).find('input[type="checkbox"]').length > 0) {
                    var ischecked = $(this).find('input[type="checkbox"]').prop('checked');
                    if (ischecked) {
                        selectedArr.push(row);
                    }
                } else if ($(this).find('input[type="radio"]').length > 0) {
                    var ischecked = $(this).find('input[type="radio"]').prop('checked');
                    if (ischecked) {
                        selectedArr.push(row);
                    }
                }

            });
            return selectedArr;
        };

        /**
         * @method checkedRowsIndex
         * @description 获取被勾选行的索引
         * @return {Array} 行索引数组
         */
        Plugin.prototype.checkedRowsIndex = function() {
            var selectedArr = [];
            var $checkedSelector = this.$element.find('table:not([id^="pinnedtable"]) tr');
            if (this.$element.find('table[id^="pinnedtable"]').length > 0) {
                $checkedSelector = this.$element.find('table[id^="pinnedtable"] tr');
            }
            $checkedSelector.each(function(index) {
                var ischecked = $(this).find('input[type="checkbox"]').prop('checked');
                if (ischecked) {
                    selectedArr.push(index);
                }
            });
            return selectedArr;
        };

        /**
         * @method getTotalRecords
         * @description 获取数据总条数
         */
        Plugin.prototype.getTotalRecords = function() {
            return this.source.totalRecords;
        };

        /**
         * @method getResult
         * @description 获取当前表格内数据
         */
        Plugin.prototype.getResult = function() {
            return this.$element.data('tableResult');
        };

        /**
         * @method getRowsData
         * @description 获取接口返回的行数据
         */
        Plugin.prototype.getRowsData = function() {
            return this.$element.data('tableRows');
        };

        /**
         * @method getSort
         * @description 获取表格排序
         */
        Plugin.prototype.getSort = function() {
            var args = this.$element.data("sortfield");

            if (args === undefined)
                return;

            var sortObj = {
                direction: args.sortdirection,
                field: args.sortcolumn,
                exp: ""
            };
            var exp = "";
            if (args.sortdirection.ascending == true) {
                sortObj.exp = "+" + args.sortcolumn;
            } else if (args.sortdirection.descending == true) {
                sortObj.exp = "-" + args.sortcolumn;
            }

            return sortObj;
        };

        /**
         * @method getModel
         * @description 获取表格数据
         */
        Plugin.prototype.getModel = function() {
            return this.$element.data('tableDataModel');
        };

        /**
          * @method selectColumnsExport
          * @description 导出 表格数据， 列为选择列
          *
          * @param  {object} params
          *
          *  【url】：
             /[root]/sys/emapcomponent/imexport/export.do

            【参数 params】：
             root:
             app：调用导出的应用名称，必填
             module：调用导出的模块名，必填
             page：调用导出的页面，必填
             action：调用导出的动作，必填
             colnames：导出时自定义的字段，多个用逗号分隔，选填  toUpperCase
             analyse：自定义的导出过程分析服务，实现IImportAnalyse，选填
             write：自定义的导出写文件服务，实现IExportWrite，选填
             filename：自定义的导出文件名，选填
          *
          */
        Plugin.prototype.selectColumnsExport = function(params) {
            this.selectToShowColumns({
                type: 'export',
                params: params
            });
        };

        /**
         * @method selectToShowColumns
         * @description 展开选择列窗口
         * @param  {object} action 动作
         *    {
         *        type: //action type, 内置动作有 toggle(默认),export
         *        handler: //action handler
         *        param:  //action hander 的参数
         *        dialogOpt:{} //同同BH_UTILS.bhWindow
         *        columnsReorder:Boolean 是否需要排序字段
         *    }
         *    'toggle'  显示选择的列，隐藏未选择的列,默认值
         *    'export'  导出表单， 支持选择列
         * @param {object} params  action 动作 所需的参数
         */
        Plugin.prototype.selectToShowColumns = function(action) {
            var self = this;
            action.type = action.type || 'toggle';

            // 表格传参时,为了方便高级搜索会将其他参数合并进来,  其中有可能含有type 所以 此处默认走 隐藏显示列
            // zhuhui 6-8
            if (action.type === 'export') {
                action.columnsReorder = false;
                action['name'] = $.i18n('bh-dd-exportChoosedKeys');
                action['handler'] = function(columns) {
                    var config, selectedCols;
                    selectedCols = [];
                    columns.forEach(function(col) {
                        if (col.hidden === false && col.hasOwnProperty('datafield')) {
                            selectedCols.push(col.datafield);
                        }
                    });

                    config = $.extend({}, action.params, {
                        colnames: selectedCols.join(',').replace(/_DISPLAY/g, '').toUpperCase()
                    });
                    self.export(config);
                };
            } else {
                action['name'] = $.i18n('bh-dd-showOrHideKeys');
                action['handler'] = function(columns) {
                    self.$element.data('columns', columns); // 将新的显示列的数据放回data-columns, 保证后续操作数据同步
                    if (self.settings.fastRender) {
                        columns = columns.filter(function(item) {
                            return !item.hidden;
                        });
                    }
                    self.$element.jqxDataTable({
                        columns: columns
                    });
                    if ((self.settings.schema || self.settings.columnsReorder) && self.settings.contextPath) { // if rememberCustomColumn , save columns
                        _saveSchema(self, columns);
                    }

                };
            }

            // 导出时，会对列显示数据进行修改， 所以此出将列数据复制，避免导出功能影响自定义列显示 zhuhui 2017-02-09
            var columns = WIS_EMAP_SERV.cloneObj(this.$element.data('columns'));
            var newmodel = this.$element.data('newmodel');
            _initSelectColumnsWindow(this, newmodel, columns, action);
        };

        /**
         * @method export
         * @description 导出表格数据
         * @param {Object} config - 配置参数，导出请求参数
         * @param {String} config.root - 根路径
         */
        Plugin.prototype.export = function(config) {
            var root = config.root;
            delete config.root;
            $.ajax({
                    url: root + '/sys/emapcomponent/imexport/export.do',
                    data: config,
                    dataType: 'json',
                    type: 'POST'
                })
                .done(function(res) {
                    if (res.status == 1) {
                        window.location.href = location.protocol + '//' + location.host + root + '/sys/emapcomponent/file/getAttachmentFile/' + res.attachment + '.do';
                    } else {
                        $.bhTip({
                            content: $.i18n('bh-dd-exportRequestFailed'),
                            state: 'danger'
                        });
                    }
                });
        };

        /**
         * @method  getVisibleColumns
         * @description 获取当前表格内所有显示的列
         * @return {Array} 可视的列
         */
        Plugin.prototype.getVisibleColumns = function() {
            var columns = this.$element.data('columns');
            if (columns && columns.length) {
                return columns.filter(function(item) {
                    return !item.hidden;
                });
            }
            return [];
        };

        /**
         * @method enterEditMode
         * @description 进入表格编辑模式
         */
        Plugin.prototype.enterEditMode = function() {
            if (this.settings.canEdit) {
                var newmodel = this.$element.data('newmodel');
                var columns = $.extend(true, [], this.$element.data('columns'));
                this.settings.editMode = true;
                _convertEditModeCols(columns, newmodel);
                this.$element.data('changedRowsData', []);
                this.$element.jqxDataTable({
                    pageable: !!this.settings.editPageable,
                    columns: columns
                });
            }
        };

        /**
         * @method leaveEditMode
         * @description 退出表格编辑模式
         */
        Plugin.prototype.leaveEditMode = function() {
            if (this.settings.canEdit) {
                var $load = this.$element.jqxDataTable('dataloadelement');
                $load.css({
                    visibility: 'visible',
                    display: 'block',
                    width: this.$element.jqxDataTable('host').width()
                });
                $('[xtype]', this.$element).each(function() {
                    var _this = $(this);
                    var xtype = _this.attr('xtype');
                    switch (xtype) {
                        case 'select':
                            _this.jqxDropDownList('destroy');
                            break;
                        case 'multi-select':
                            _this.jqxComboBox('destroy');
                            break;
                        case 'date-local':
                        case 'date-ym':
                        case 'date-full':
                            _this.jqxDateTimeInput('destroy');
                            break;
                        case 'tree':
                            _this.jqxDropDownButton('destroy');
                            break;
                    }
                });
                var columns = this.$element.data('columns');
                var rows = this.$element.jqxDataTable('getRows');
                rows.forEach(function(row) {
                    delete row[toDeleteKey];
                });
                this.settings.editMode = false;
                this.$element.data('changedRowsData', []);
                this.$element.jqxDataTable({
                    pageable: this.settings.pageable,
                    height: this.settings.height,
                    columns: columns
                });
                if (!this.settings.pageable) {
                    bindingComplete(this);
                }
                $load.css({
                    visibility: 'hidden',
                    display: 'none',
                    width: '100%'
                });
            }
        };

        /**
         * @method getChangedRows
         * @description 获取已改变的数据，不包含待删除的数据
         * @return {Array} 所有已改变的行的数据
         */
        Plugin.prototype.getChangedRows = function() {
            if (this.settings.editMode) {
                var rows = this.$element.jqxDataTable('getRows');
                var $content = this.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
                var changedRow = [];
                $content.find('tbody>tr').each(function(i) {
                    if ($(this).find('.' + editedBg).length && !rows[i][toDeleteKey]) {
                        var value = WIS_EMAP_INPUT.formGetValue($(this), {});
                        changedRow.push($.extend({}, rows[i], value));
                    }
                });
                return changedRow;
            }
        };

        /**
         * @method getToDeleteRows
         * @description 获取将要被删除的行索引
         * @return {Array} 索引数组
         */
        Plugin.prototype.getToDeleteRows = function() {
            if (this.settings.editMode) {
                var rows = this.$element.jqxDataTable('getRows');
                var $content = this.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
                var $trs = $content.find('tbody>tr');
                var toDeleteData = [];
                rows.forEach(function(row, i) {
                    if (row[toDeleteKey]) {
                        toDeleteData.push(WIS_EMAP_INPUT.formGetValue($trs.eq(i), {}));
                    }
                });
                return toDeleteData;
            }
        };

        /**
         * @method deleteRowInEditMode
         * @param  {Object} opt 入参，因组件对字符做特殊处理，用于查询，所以此处规定入参为Object
         * @param {Number} opt.rowIndex 行索引
         */
        Plugin.prototype.deleteRowInEditMode = function(opt) {
            if ($.isNumeric(opt.rowIndex) && this.settings.editMode) {
                var rows = this.$element.jqxDataTable('getRows');
                var index = opt.rowIndex;
                if (rows[index]) {
                    rows[index][toDeleteKey] = true;
                    var $content = this.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
                    var $tr = $content.find('tbody>tr').eq(index);
                    WIS_EMAP_INPUT.formDisable($tr);
                    $tr.find('>td').each(function(i) {
                        $(this).find('[data-sss] input').prop('disabled', true);
                        $(this).addClass(showToDeleteLine);
                    });
                }
            }
        };

        /**
         * @method cancelDeleteRowInEditMode
         * @param  {Object} opt 入参，因组件对字符做特殊处理，用于查询，所以此处规定入参为Object
         * @param [Number] opt.rowIndex 行索引
         */
        Plugin.prototype.cancelDeleteRowInEditMode = function(opt) {
            if ($.isNumeric(opt.rowIndex) && this.settings.editMode) {
                var rows = this.$element.jqxDataTable('getRows');
                var index = opt.rowIndex;
                if (rows[index]) {
                    delete rows[index][toDeleteKey];
                    var $content = this.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
                    var $tr = $content.find('tbody>tr').eq(index);
                    WIS_EMAP_INPUT.formEnable($tr);
                    $tr.find('>td').each(function(i) {
                        $(this).find('[data-sss] input').prop('disabled', false);
                        $(this).removeClass(showToDeleteLine);
                    });
                }
            }
        };

        /**
         * @method isInEditMode
         * @description 判断表格是否处于编辑模式
         * @return {Boolean}
         */
        Plugin.prototype.isInEditMode = function() {
            return this.settings.editMode;
        };

        /**
         * @method validateTable
         * @description 校验表格输入是否合法
         * @return {Bollean}
         */
        Plugin.prototype.validateTable = function() {
            var $content = this.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
            var isValidate = true;
            $content.find('tbody>tr').filter(function() {
                return $(this).find('.' + showToDeleteLine).length === 0;
            }).each(function() {
                if (!$(this).emapValidate('validate')) {
                    isValidate = false;
                }
            });
            return isValidate;
        };

        /**
         * @method addRow
         * @description 添加行，支持编辑模式
         * @param {Object} [obj]
         * @param {Number} [obj.rowIndex] 第几行(貌似没有作用)
         * @param {Object} [obj.rowData] 添加的数据
         * @param {String | Number} [obj.rowPosition = 'first'] 在添加到第几行后面,添加到第一行传'first'，最后一行传'last'
         */
        Plugin.prototype.addRow = function(obj) {
            var index = obj.rowIndex;
            var rowIndex = obj.rowIndex;
            var rowData = obj.rowData;
            var rowPosition = '';
            if (obj.hasOwnProperty('rowPosition')) {
                rowPosition = obj.rowPosition;
                if (rowPosition === 'first') {
                    index = 0;
                }
            }
            if (rowPosition !== 'last' && this.settings.editMode) {
                var changedData = this.$element.data('changedRowsData');
                changedData.splice(index, 0, rowData || {});
            }
            return this.$element.jqxDataTable('addRow', rowIndex, rowData || {}, rowPosition);
        };

        /**
         * @method deleteRow
         * @description 删除行，支持编辑模式
         * @param  {Object} [obj]
         * @param {Number | String}  obj.rowIndex 删除第几行
         */
        Plugin.prototype.deleteRow = function(obj) {
            var index = obj.rowIndex * 1 || 0;
            if (this.settings.editMode) {
                var changedData = this.$element.data('changedRowsData');
                changedData.splice(index, 1);
            }
            return this.$element.jqxDataTable('deleteRow', index);
        };

        return Plugin;

    })();

    //根据JSON拼装query条件
    function _getQuerySetting(params) {
        if (!$.isEmptyObject(params) && !params.querySetting) {
            var query = [];
            for (var key in params) {
                query.push({
                    name: key,
                    value: params[key],
                    linkOpt: 'AND',
                    builder: 'equal'
                });
            }
            return {
                querySetting: JSON.stringify(query)
            };
        } else {
            return $.extend({}, params);
        }
    }

    function indexOf(arr, cb) {
        var alength = arr.length;
        for (var i = 0; i < alength; i++) {
            var o = cb(arr[i], i);
            if (o === true) {
                return i;
            }
        }
        return -1;
    }

    function compact(arr) {
        for (var i = 0; i < arr.length; i++) {
            if (!arr[i]) {
                arr.splice(i, 1);
                i--;
            }
        }
        return arr;
    }

    /**
     * 插件的私有方法
     */
    //生成表格
    function _create(instance) {
        if (!instance.settings.contextPath) {
            instance.settings.contextPath = WIS_EMAP_SERV.getContextPath();
        }

        var jqxOptions = $.extend({}, instance.settings);
        try {
            delete jqxOptions.pk; //qiyu 2016-1-16
            delete jqxOptions.url;
            delete jqxOptions.pagePath;
            delete jqxOptions.params;
            delete jqxOptions.datamodel;
            delete jqxOptions.method;
            delete jqxOptions.action;
            delete jqxOptions.customColumns;
            delete jqxOptions.colHasMinWidth;
            delete jqxOptions.beforeSend;
            delete jqxOptions.downloadComplete;
            delete jqxOptions.schema;
            delete jqxOptions.contextPath;
            delete jqxOptions.searchElement;
            delete jqxOptions.minLineNum;
            delete jqxOptions.onceParams;
            delete jqxOptions.alwaysHide;
            delete jqxOptions.customModelName;
            delete jqxOptions.formatData;
            delete jqxOptions.fastRender;
            delete jqxOptions.canEdit;
            delete jqxOptions.schemaList;
            delete jqxOptions.isCellEditable;
            delete jqxOptions.isOnceEmpty;
            delete jqxOptions.isEditMode;
            delete jqxOptions.defaultParams;
            delete jqxOptions.mustSelect;
            delete jqxOptions.editPageable;
        } catch (e) {

        }
        if (instance.settings.isEditMode) {
            instance.settings.editMode = true;
        }

        var dataAdapter = new $.jqx.dataAdapter(instance.source, {
            formatData: function(data) {
                if (jqxOptions.pageable) {
                    data.pageSize = data.pagesize;
                    data.pageNumber = data.pagenum + 1;
                }

                if (instance.settings.isOnceEmpty) {
                    data.pageSize = 1;
                    data.pageNumber = 1;
                    data.querySetting = '[{"name":"' + instance.source.datafields[0].name + '","builder":"include","linkOpt":"AND","value":"NULL"}]';
                    delete instance.settings.isOnceEmpty;
                }

                var sortorder = '+';
                if (jqxOptions.sortable && data.sortdatafield && data.sortorder) {
                    if (data.sortorder == 'asc') {
                        sortorder = '+';
                    } else if (data.sortorder == 'desc') {
                        sortorder = '-';
                    }
                    data['*order'] = sortorder + data.sortdatafield.split('_DISPLAY')[0];
                }

                if (instance.settings.formatData && typeof instance.settings.formatData == 'function') {
                    data = instance.settings.formatData(data);
                }
                try {
                    delete data.pagesize;
                    delete data.pagenum;
                    delete data.filterslength;
                    delete data.sortdatafield;
                    delete data.sortorder;
                } catch (e) {}
                instance.$element.data('currentQueryParams', data);
                instance.$element.data('changedRowsData', []);
                return data;
            },
            beforeSend: function(xhr) {
                if (typeof instance.settings.beforeSend === 'function') {
                    instance.settings.beforeSend.call(this, arguments);
                }
            },
            downloadComplete: function(data, status, xhr) {
                // 添加downloadComplete 回调  zhuhui 0726
                if (typeof instance.settings.downloadComplete === 'function') {
                    if (instance.settings.downloadComplete(data, status, xhr) === false) {
                        return;
                    }
                }

                // 添加全局ajax的complete回调  liujun 2017-02-28
                if (typeof WIS_EMAP_CONFIG.dataTableAjaxCompleteCallback === 'function') {
                    WIS_EMAP_CONFIG.dataTableAjaxCompleteCallback(data, status, xhr);
                }

                //如果未登录则跳转至登录地址
                if (typeof data.loginURL != 'undefined' && data.loginURL != '') {
                    window.location.href = data.loginURL;
                    return;
                }

                //qiyu 2016-7-21 将emapdatatable中的获取mock的url提取函数，在mock文件中重新定义
                if (typeof window.MOCK_CONFIG != 'undefined') {
                    instance.source.totalRecords = getTotalRecordsMock(data, instance.settings.action);
                } else {
                    if (data.code === '0' || data.code === 0 || data.code === undefined) {
                        instance.source.totalRecords = data.datas[instance.settings.action].totalSize || data.datas[instance.settings.action].total_size;
                        instance.$element.data('tableRows', data.datas[instance.settings.action].rows);
                    } else {
                        console && console.log(data);
                        if (data.code) {
                            // 应李忻均要求，若返回的信息里带有logId，则用logId代替code作为展示 zhuhui 2017-4-19
                            $.bhTip({
                                content: (data.msg ? data.msg + ',' : ($.i18n('bh-edt-systemError') + ',')) + $.i18n('bh-edt-error') + (data.logId || data.code),
                                state: 'danger'
                            });
                        }
                    }
                }

                //qiyu 2016-6-8 解决翻页总数刷新问题
                //instance.source.totalrecords = instance.source.totalRecords;

                instance.$element.data('tableResult', data);

                // 联动高级搜索的
                if (instance.settings.searchElement && instance.settings.searchElement.length > 0) {
                    instance.settings.searchElement.emapAdvancedQuery('updateTotalNum', (instance.source.totalRecords ? instance.source.totalRecords : 0));
                }
            }
        });

        //保存调用组件时传进来的ready和rendered函数。因为后面checkbox会复写此函数
        var custom_ready = jqxOptions.ready;
        var custom_rendered_tmp = jqxOptions.rendered;

        var custom_rendered = jqxOptions.rendered = function() {
            //处理无排序时表格列背景色及排序按钮背景色问题
            _handleSortStyle(instance);
            if (typeof custom_rendered_tmp === 'function') {
                custom_rendered_tmp();
            }
        };

        jqxOptions.columns = _genColums(instance, jqxOptions, custom_ready, custom_rendered);
        if (jqxOptions.sortable !== true) {
            $(jqxOptions.columns).each(function() {
                if (this.sortable === true) {
                    jqxOptions.sortable = true;
                } else {
                    this.sortable = false;
                }
            });
        }

        jqxOptions.source = dataAdapter;
        _decorateRendered(jqxOptions, instance);
        instance.$element.jqxDataTable(jqxOptions);

        instance.$element.on('sort', function(event) {
            var args = event.args;
            // column's data field.
            //var sortcolumn = args.sortcolumn;
            instance.$element.data("sortfield", args);
        });

        instance.$element.on('bindingComplete', function(event) {
            bindingComplete(instance, event);
        });

        //qiyu 2016-6-7 增加创建时事件，用于提供给产品线，创建后的行为。需求人：孟斌。如：表格默认增加右侧自定义显示列
        instance.$element.trigger("emapdatatable.created", [instance]);

        if (instance.settings.columnsReorder && instance.settings.contextPath) {
            instance.$element.on('columnReordered', WIS_EMAP_SERV.debounce(function() {
                var columns = $(this).data('columns');
                if (instance.settings.fastRender) {
                    var tinners = $(this).jqxDataTable('columns').records;
                    var filters = [];
                    tinners.forEach(function(item) {
                        $(columns).each(function() {
                            if (this.datafield === item.datafield) {
                                filters.push(this);
                                return false;
                            }
                        });
                    });
                    var clen = columns.length;
                    var col = {};
                    var num = 0;
                    for (var i = 0; i < clen; i++) {
                        col = columns[i];
                        var index = indexOf(filters, function(item) {
                            return item.datafield === col.datafield;
                        });
                        if (index > -1) {
                            columns[i] = filters[num];
                            num++;
                        }
                    }
                }
                _saveSchema(instance, columns);
            }, 500));
        }
    }

    function bindingComplete(instance, event) {
        var editModeTimer = instance.$element.data('editModeTimer');
        clearTimeout(editModeTimer);
        if (instance.settings.editMode) {
            showLoading(instance);
            editModeTimer = setTimeout(function() {
                _setEditModeData(instance);
            }, 10);
            instance.$element.data('editModeTimer', editModeTimer);
        } else {
            _handleSortStyle(instance);
            _handleMinHeight(instance);
            _handleHorizontalScrollBar(instance);
            _handleVerticalScrollBar(instance);
            _resetPageFooter(instance);
        }
    }

    //在纸质弹窗中的页面，改变分页大小，需要重置页脚
    function _resetPageFooter(instance) {
        //当弹框内容的高度出现变化的时候调用以下两个方法
        if (instance.$element.closest(".bh-paper-pile-dialog").length > 0) {
            $.bhPaperPileDialog.resetPageFooter(); //改变页面的页脚位置
            $.bhPaperPileDialog.resetDialogFooter(); //改变弹框的页脚位置
        }
    }

    /**
     * 处理出现横向滚动条后导致的纵向滚动条
     */
    function _handleHorizontalScrollBar(instance) {
        var id = instance.$element.attr('id');
        //qiyu 2016-9-21 希望永远不显示纵向滚动条，判断依此调整，处理出现横向滚动条后导致的纵向滚动条
        // var $selector = $('#horizontalScrollBar' + id);
        var $selector = $('#verticalScrollBar' + id);
        if ($selector.css('visibility') != 'hidden') {
            var height = instance.$element.jqxDataTable('height');
            if (height != null) {
                //qiyu 2016-9-14 解决刷新会不断增高的问题，之前的临时方案是设置表格的height=null
                //instance.$element.jqxDataTable('height', height + 17);
                //qiyu 2016-9-21 调整行高为10px
                instance.$element.jqxDataTable('height', height + 10);
            }
        }
    }

    /**
     * 处理表格行高因自定义内容被撑大后，出现纵向滚动条问题
     */
    function _handleVerticalScrollBar(instance) {
        var id = instance.$element.attr('id');
        var $selector = $('#verticalScrollBar' + id);
        var rowsData = instance.$element.jqxDataTable('getRows');
        var minLineNum = instance.settings.minLineNum;
        if (minLineNum == null || isNaN(minLineNum)) {
            return;
        }
        if ($selector.css('visibility') != 'hidden' && rowsData.length <= minLineNum) {
            instance.$element.jqxDataTable('height', null);
        }
    }
    /**
     * 处理表格最小高度
     */
    function _handleMinHeight(instance) {
        var rowsData = instance.$element.jqxDataTable('getRows');
        var minLineNum = instance.settings.minLineNum;

        if (minLineNum == null || isNaN(minLineNum)) {
            return;
        }

        if (rowsData.length < minLineNum) {
            instance.$element.jqxDataTable('height', BH_UTILS.getTableHeight(parseInt(minLineNum)));
        } else {
            instance.$element.jqxDataTable('height', null);
        }

    }

    /**
     * 初始化 schema, 如果启用schema， 则返回 schema 的数据
     * @param  {object} instance
     * @param  {string} modelName
     */
    function _initSchema(instance, modelName, contextPath) {
        var $elem = instance.$element;
        var res;
        if (!instance.settings.contextPath) {
            return [];
        }
        if (!instance.settings.schema && !instance.settings.columnsReorder) {
            return [];
        }

        //TODO: enable schema
        $elem.emapSchema({
            schemaType: 'col',
            contextPath: contextPath,
            data: {
                modelName: modelName
            }
        });

        res = $elem.emapSchema('getSchemaList');
        if (res && res[0] && res[0].CONTENT) {
            return res[0].CONTENT.split(',');
        }
        return [];
    }

    function _handleSortStyle(instance) {
        //处理无排序时表格列背景色问题
        var sortObj = instance.$element.data("sortfield");
        if (typeof sortObj == 'undefined' || (sortObj.sortdirection.ascending == false && sortObj.sortdirection.descending == false)) {
            instance.$element.find('td.jqx-grid-cell-sort').removeClass('jqx-grid-cell-sort');
        }

        //处理表格排序按钮背景色问题
        instance.$element.find('div.sortasc, div.sortdesc').css('background', 'none');
    }

    function _convertEditModeCols(columns, newmodel) {
        columns.forEach(function(col, i) {
            var model = newmodel[i];
            var isCustom = model.custom && model.custom.hasOwnProperty('colIndex');
            if (isCustom) {
                col.hidden = true;
            }
            var edit = col.datafield === 'field_checkbox' || (model.custom && model.custom.type === 'edit_tpl');
            if (edit) {
                col.hidden = false;
            }
        });
    }

    /**
     * 生成表格列
     * @param  {any} instance
     * @param  {any} jqxOptions
     * @param  {any} custom_ready
     * @param  {any} custom_rendered
     */
    function _genColums(instance, jqxOptions, custom_ready, custom_rendered) {
        var columns = [],
            schemaList;

        var datamodel = instance.settings.datamodel ||
            WIS_EMAP_SERV.getModel(instance.settings.pagePath, instance.settings.action, "grid", instance.settings.params);
        //保存datamodel
        instance.$element.data('tableDataModel', $.extend([], datamodel));

        instance.$element.attr("emap", JSON.stringify({
            "emap-pagePath": instance.settings.pagePath,
            "emap-action": instance.settings.action,
            "emap-url": WIS_EMAP_SERV.url,
            "emap-name": WIS_EMAP_SERV.name,
            "emap-app-name": WIS_EMAP_SERV.appName,
            "emap-model-name": WIS_EMAP_SERV.modelName
        }));
        schemaList = instance.settings.schemaList || _initSchema(instance, WIS_EMAP_SERV.modelName || instance.settings.customModelName, instance.settings.contextPath);
        //保存datamodel
        instance.$element.data('schemaList', schemaList);
        delete WIS_EMAP_SERV.url;
        delete WIS_EMAP_SERV.name;
        delete WIS_EMAP_SERV.appName;
        delete WIS_EMAP_SERV.modelName;

        var cusColLen = 0;
        var customColumns = instance.settings.customColumns;
        if (typeof customColumns != 'undefined' && customColumns != null) {
            cusColLen = customColumns.length;
        }

        //重新组织datamodel
        //type为link时只能为某列快速设置为链接类型，该列必须是模型中已经存在的数据列（此设定为兼容上一版本）
        var newmodel = [];
        var lastcolumns = [];
        var linkCol = [];
        var lastCol = null;
        if (cusColLen > 0) {
            for (var i = 0; i < cusColLen; i++) {
                var colIndex, colField, type;
                if (customColumns && customColumns[i]) {
                    colIndex = customColumns[i].colIndex;
                    colField = customColumns[i].colField;
                    type = customColumns[i].type;
                    if (colIndex > 40) {
                        colIndex = 'last';
                    }
                    if (colIndex === 'last') {
                        lastCol = customColumns[i];
                    }
                    if (colIndex < 0) {
                        lastcolumns.push({
                            index: colIndex * 1,
                            col: customColumns[i]
                        });
                    } else if (typeof colField != 'undefined' && colField != '') {
                        for (var j = 0; j < datamodel.length; j++) {
                            if (datamodel[j].name == colField) {
                                datamodel[j].custom = customColumns[i];
                            }
                        }
                    } else if (colIndex != 'undefined') {
                        colIndex = colIndex < 0 ? 0 : colIndex;

                        //兼容上一版本设定
                        if (type != 'link') {
                            newmodel[colIndex] = {
                                custom: customColumns[i]
                            }
                        } else {
                            linkCol.push({
                                colIndex: colIndex,
                                column: customColumns[i]
                            });
                        }
                    }
                }
            }
        }

        //datamodel保存至source的datafields数组中
        for (var m = 0; m < datamodel.length; m++) {
            if (typeof datamodel[m].get == 'function') {
                instance.source.datafields.push({
                    name: datamodel[m].name,
                    type: 'string'
                });
                if (typeof datamodel[m].url != 'undefined') {
                    instance.source.datafields.push({
                        name: datamodel[m].name + '_DISPLAY',
                        type: 'string'
                    });
                }
            }
        }
        for (var k = 0; k < newmodel.length; k++) {
            if (newmodel[k] == undefined) {
                if (datamodel.length > 0) {
                    newmodel[k] = datamodel.shift();
                } else {
                    newmodel.splice(k, 1);
                    k--;
                }
            }
        }

        if (datamodel.length > 0) {
            newmodel = newmodel.concat(datamodel);
        }

        if (lastcolumns.length) {
            lastcolumns.sort(function(a, b) {
                if (a && b) {
                    return b.index - a.index;
                }
                return 0;
            });
            lastcolumns.forEach(function(item) {
                var i = item.index + 1;
                if (i === 0) {
                    newmodel.push({
                        custom: item.col
                    });
                } else {
                    newmodel.splice(i, 0, {
                        custom: item.col
                    });
                }
            });
        }

        if (lastCol) {
            newmodel.push({
                custom: lastCol
            });
        }

        var datafield;
        var _col;
        var thiner_columns = [];
        var isFastRender = instance.settings.fastRender;

        //根据schema排序列
        if (instance.settings.columnsReorder && schemaList.length) {
            var orderedModels = [];
            var indexs = [];
            newmodel.forEach(function(item, i) {
                if (item.name) {
                    var index = indexOf(schemaList, function(col) {
                        if (item.name) {
                            return col.replace('_DISPLAY', '') === item.name;
                        }
                    });
                    if (index > -1) {
                        orderedModels[index] = item;
                        return;
                    }
                }
                indexs.push(i);
            });
            indexs.forEach(function(i) {
                orderedModels.splice(i, 0, newmodel[i]);
            });
            newmodel = compact(orderedModels);
        }
        for (var n = 0; n < newmodel.length; n++) {
            //设置自定义列类型为link，且指定了colIndex的项
            for (var t = 0; t < linkCol.length; t++) {
                if (n == linkCol[t].colIndex) {
                    newmodel[n].custom = linkCol[t].column;
                }
            }
            //设置数据类型全部是string
            if (typeof newmodel[n].name != 'undefined') {
                instance.source.datafields.push({
                    name: newmodel[n].name,
                    type: 'string'
                });
            }
            if (typeof newmodel[n].url != 'undefined') {
                datafield = newmodel[n].name + '_DISPLAY';
                instance.source.datafields.push({
                    name: datafield,
                    type: 'string'
                });
            } else {
                datafield = newmodel[n].name
            }

            var width = null;
            var minWidth = null;
            var widthObj = {};
            var attr = WIS_EMAP_SERV.getAttr(newmodel[n], 'grid');
            var isHidden = attr.hidden;

            //schema: schema 权重高于 hidden属性， 如果不在schemaList中，则隐藏该列
            if (instance.settings.schema && schemaList && schemaList.length && newmodel[n].name && newmodel[n]['grid.fixed'] !== true) {
                _col = newmodel[n].name

                var arrNoDisplay = schemaList.map(function(val) {
                    return val.replace('_DISPLAY', '');
                })
                isHidden = $.inArray(_col, arrNoDisplay) === -1
            }

            //固定列属性pinned 默认值
            var pinned = false;
            //从后台模型中读取固定列属性pinned
            pinned = newmodel[n].pinned;
            if (pinned !== true) {
                pinned = false;
            }
            // 默认列宽为100px
            if (newmodel[n].custom == undefined) {
                width = attr.width;
                minWidth = attr.minWidth;
                widthObj = _genWidthObj(width, minWidth, instance.settings.colHasMinWidth);
                var dCol = $.extend({}, {
                    text: newmodel[n].caption,
                    datafield: datafield,
                    hidden: isHidden,
                    pinned: pinned,
                    cellsRenderer: _defaultCellsRenderer
                }, widthObj);
                columns.push(dCol);
                dCol = _proxyColOpt(dCol, instance.settings, newmodel[n]);
                if (isFastRender && _canColFastRender(dCol)) {
                    thiner_columns.push(dCol);
                }
            } else {
                var type = newmodel[n].custom.type;
                var showCheckAll = newmodel[n].custom.showCheckAll;
                width = newmodel[n].custom.width;
                minWidth = newmodel[n].custom.minWidth;
                if (width == undefined) {
                    width = attr.width;
                }
                if (minWidth == undefined) {
                    minWidth = newmodel[n]['grid.minWidth'] == undefined ? null : newmodel[n]['grid.minWidth'];
                }
                widthObj = _genWidthObj(width, minWidth, instance.settings.colHasMinWidth);
                var col = _genCustomColumns(type, instance, jqxOptions, showCheckAll, widthObj, newmodel[n], datafield, custom_ready, custom_rendered);
                var cCol = $.extend({
                    hidden: isHidden,
                    pinned: pinned,
                    cellsRenderer: _defaultCellsRenderer
                }, col);
                cCol = _proxyColOpt(cCol, instance.settings, newmodel[n]);
                columns.push(cCol);
                if (isFastRender) {
                    thiner_columns.push(cCol);
                }
            }
        }

        if (instance.settings.editMode) {
            _convertEditModeCols(columns, newmodel);
        }

        if (isFastRender) {
            instance.$element.data('newmodel', newmodel);
            instance.$element.data('columns', columns);
            return thiner_columns;
        } else {
            instance.$element.data('newmodel', newmodel);
            instance.$element.data('columns', columns);
            return columns;
        }
    }

    //默认单元格渲染函数
    function _defaultCellsRenderer(row, column, value, rowData) {
        //qiyu 2017-2-23 放置XSS攻击处理
        // var v = BH_UTILS.fxss(value);
        // return '<span title="' + v + '">' + v + '</span>';
        return '<span title="' + $("<div>" + value + "</div>").text() + '">' + value + '</span>';
    }

    function _canColFastRender(col) {
        if (col['grid.hidden'] === true) {
            return false;
        } else if (col['grid.hidden'] === undefined && col['hidden'] === true) {
            return false;
        }
        return true;
    }

    function _genWidthObj(width, minWidth, colHasMinWidth) {
        var widthStr = width == null ? '' : width.toString();
        widthStr = widthStr.replace('px', '').replace('PX', '').replace('%', '');
        widthStr = $.trim(widthStr);
        if (!colHasMinWidth) {
            if (width && widthStr != '' && !isNaN(widthStr)) {
                return {
                    width: width,
                    minWidth: minWidth
                };
            }
            return {};
        } else {
            if (width != null && widthStr != '' && !isNaN(widthStr)) {
                width = width.toString();
                width.replace('px', '').replace('PX', '');
                // qiyu 2017-1-18 解除宽度设定小于100的值仍然按照100来设置的限制。需求人：力磊
                // if (width.indexOf("%") == -1 && parseInt(width) < 100) {
                //     width = 100;
                // }

                // return {
                //     width: width,
                //     minWidth: 100
                // };
                return {
                    width: width,
                    minWidth: minWidth
                }
            }
            return {
                minWidth: minWidth || 100
            };
        }
    }

    function _saveSchema(instance, columns) {
        var $elem = instance.$element;
        //1. 获取 含有 name的 显示列
        var data = [];
        columns.forEach(function(column) {
            if (column.hasOwnProperty('datafield') && !column.hidden) {
                data.push(column.datafield)
            }
        });
        //2. 保存 显示列 到 schema
        $elem.emapSchema('saveSchema', [
            'emap.table',
            data.join(',')
        ]);
    }
    /*
     *   列表字段的显示隐藏策略
     *   fixed > 保存方案 > 模型配置
     *   保存方案的优先级高于模型中的显示隐藏配置
     *   模型中配置了固定的字段的显示隐藏以模型中的配置为准，优先级高于保存方案
     *
     */
    function _initSelectColumnsWindow(instance, newmodel, columns, action) {
        var callback = function(cols) {
            var colMap = {};
            cols.forEach(function(item) {
                colMap[item.name] = {
                    hidden: item.hidden
                };
            });

            var clength = columns.length;
            if (action.type === 'export') {
                var exportCols = [];
                for (var i = 0; i < clength; i++) {
                    if (columns[i].datafield) {
                        var key = columns[i].datafield.replace('_DISPLAY', '');
                        if (colMap[key]) {
                            exportCols.push({
                                datafield: key,
                                hidden: !!colMap[key].hidden
                            });
                        }
                    }
                }
                action.handler(exportCols);
            } else {
                if (action.columnsReorder) {
                    if (columns.length === 1 && cols.length) {
                        columns[0].hidden = cols[0].hidden;
                    }
                    var orderedCols = [];
                    var indexs = [];
                    columns.forEach(function(item, i) {
                        if (item.datafield) {
                            var index = indexOf(cols, function(col) {
                                return col.name === item.datafield.replace('_DISPLAY', '');
                            });
                            if (index > -1) {
                                item.hidden = cols[index].hidden;
                                orderedCols[index] = item;
                                return;
                            }
                        }
                        indexs.push(i);
                    });
                    indexs.forEach(function(i) {
                        orderedCols.splice(i, 0, columns[i]);
                    });
                    columns = compact(orderedCols);
                } else {
                    for (var j = 0; j < clength; j++) {
                        if (columns[j].datafield) {
                            var key = columns[j].datafield.replace('_DISPLAY', '');
                            if (colMap[key]) {
                                columns[j].hidden = colMap[key].hidden;
                            }
                        }
                    }
                }

                instance.$element.trigger('custom.grid', [cols]);
                action.handler(columns);
            }
        };
        var opt = {
            model: newmodel,
            alwaysHide: instance.settings.alwaysHide,
            callback: callback,
            columns: columns,
            title: action.name,
            params: {},
            type: action.type,
            mustSelect: instance.settings.mustSelect,
            columnsReorder: action.columnsReorder
        };
        $.extend(opt.params, action.dialogOpt);
        $.bhCustomizeColumn(opt);
    }

    /**
     * 生成自定义列
     * @param  {String} type 自定义列类型
     * @return {Object}       自定义列column
     */
    function _genCustomColumns(type, instance, jqxOptions, showCheckAll, widthObj, model, datafield, custom_ready, custom_rendered) {
        var column = null;
        // checkbox列不可排序
        switch (type) {
            case 'checkbox':
                var pinned = model.custom.pinned;
                if (pinned !== true) {
                    pinned = false;
                }
                column = {
                    text: 'checkbox',
                    datafield: 'field_checkbox',
                    // //qiyu 2016-11-30 checkbox列增加标示，解决改变宽度后checkbox状态丢失的问题
                    cellClassName: 'datatable-checkbox-column',
                    width: 32,
                    minWidth: 32,
                    maxWidth: 32,
                    cellsAlign: 'center',
                    align: 'center',
                    sortable: false,
                    draggable: false,
                    pinned: pinned,
                    renderer: function(text, align, height) {
                        var checkBox = '<div class="selectAllCheckboxFlag bh-checkbox bh-mh-8"><label><input type="checkbox" value=""><i class="bh-choice-helper"></i></label></div>';
                        if (showCheckAll === false) {
                            return ' ';
                        }
                        return checkBox;
                    },
                    rendered: function(element, align, height) {
                        //头部的checkbox点击事件的绑定
                        element.on("click", "input", function(e) {
                            var $table = instance.$element;
                            var $tableContent = $table.find('table:not([id^="pinnedtable"])');
                            if ($table.find('table[id^="pinnedtable"]').length > 0) {
                                $tableContent = $table.find('table[id^="pinnedtable"]');
                            }
                            var $checkboxList = $tableContent.find("div.bh-checkbox");

                            var $input = $(this);
                            if ($input.hasClass("selectFlag")) {
                                $input.prop("checked", false).removeClass("selectFlag");
                                $checkboxList.each(function() {
                                    $(this).find("input").not(':disabled').prop("checked", false);
                                });
                            } else {
                                $input.prop("checked", true).addClass("selectFlag");
                                $checkboxList.each(function() {
                                    $(this).find("input").not(':disabled').prop("checked", true);
                                });
                            }

                            //触发自定义全选按钮事件
                            $(this).trigger('checkall');
                            e.stopPropagation();
                        });
                        return true;
                    },
                    cellsRenderer: function(row, column, value, rowData) {
                        //qiyu 2016-11-30 checkbox列增加标示，解决改变宽度后checkbox状态丢失的问题
                        var checked = false;
                        if (!rowData.rowguid) {
                            rowData.rowguid = BH_UTILS.NewGuid();
                        }
                        var guid = rowData.rowguid;
                        var cbitem = '<input type="checkbox" value="' + rowData.uid + '" data-guid="' + guid + '">';
                        var jqcb = $('.datatable-checkbox-column input[type=checkbox][data-guid="' + guid + '"]', this.owner.host);
                        //qiyu 2017-1-7 解决render表格时checkbox未正确选中的问题。发生在首次打开页面，点击出现bhWindow时，会改表格变宽度。报告者：梅晓龙
                        // if (jqcb.length > 0 && jqcb[row]) {
                        // checked = jqcb[row].checked;
                        if (jqcb.length > 0) {
                            checked = jqcb[0].checked;
                            if (checked) {
                                cbitem = '<input type="checkbox" value="' + rowData.uid + '" data-guid="' + guid + '" checked>';
                            }
                        }

                        var checkBox = '<div data-sss="" class="bh-checkbox bh-mh-4" style="margin-left:0 !important;"><label>' + cbitem + '<i class="bh-choice-helper"></i></label></div>';
                        // var checkBox = '<div data-sss="" class="bh-checkbox bh-mh-4" style="margin-left:0 !important;"><label><input type="checkbox" value=""><i class="bh-choice-helper"></i></label></div>';

                        return checkBox;
                    }
                };

                //增加处理函数
                jqxOptions.rendered = function() {
                    //数据加载完成，读取各列的checkbox，判断头部的checkbox是否要勾选
                    var $table = instance.$element;
                    var $tableContent = $table.find('table:not([id^="pinnedtable"])');
                    if ($table.find('table[id^="pinnedtable"]').length > 0) {
                        $tableContent = $table.find('table[id^="pinnedtable"]');
                    }
                    var $checkboxList = $tableContent.find(".datatable-checkbox-column div.bh-checkbox");
                    var isSelectAllFlag = true;
                    if ($checkboxList.length == 0) {
                        isSelectAllFlag = false;
                    }
                    $checkboxList.each(function() {
                        var $itemCheckbox = $(this);
                        if ($itemCheckbox.find("input[checked]").length === 0) {
                            isSelectAllFlag = false;
                            return false;
                        }
                    });
                    var $selectAllCheckbox = $table.find("div.selectAllCheckboxFlag").find("input");
                    if (isSelectAllFlag) {
                        $selectAllCheckbox.prop("checked", true).addClass("selectFlag");
                    } else {
                        $selectAllCheckbox.prop("checked", false).removeClass("selectFlag");
                    }

                    //调用外部定义的rendered函数
                    if (typeof custom_rendered === 'function') {
                        custom_rendered();
                    }
                };

                jqxOptions.ready = function() {
                    //初始化完成后，绑定checkbox的点击事件
                    instance.$element.on("click", "div.bh-checkbox", function() {
                        _scenesTableContentCheckboxClick($(this).find("input"), instance);
                        //触发自定义事件
                        $(this).trigger('checkone');
                    });

                    //调用外部定义的rendered函数
                    if (typeof custom_ready === 'function') {
                        custom_ready();
                    }
                };
                break;

            case 'radio':
                var guid = BH_UTILS.NewGuid();
                var pinned = model.custom.pinned;
                if (pinned !== true) {
                    pinned = false;
                }
                column = {
                    text: 'radio',
                    datafield: 'field_radio',
                    width: 40,
                    minWidth: 40,
                    maxWidth: 40,
                    cellsAlign: 'center',
                    align: 'center',
                    sortable: false,
                    draggable: false,
                    pinned: pinned,
                    renderer: function(text, align, height) {
                        var radio = $.i18n('bh-dd-choose');
                        return radio;
                    },
                    cellsRenderer: function(row, column, value, rowData) {
                        var radio = '<div data-sss="" class="bh-radio bh-mh-4" style="margin-left:0 !important;"><label style="padding-left: 0;"><input name="' + guid + '" type="radio" value=""><i class="bh-choice-helper"></i></label></div>';
                        return radio;
                    }
                };

                jqxOptions.ready = function() {
                    //初始化完成后，绑定checkbox的点击事件
                    instance.$element.on("click", "div.bh-radio", function() {
                        //触发自定义事件
                        $(this).trigger('checkone');
                    });

                    //调用外部定义的rendered函数
                    if (typeof custom_ready === 'function') {
                        custom_ready();
                    }
                };
                break;
            case 'link':
                var pinned = model.custom.pinned;
                if (pinned !== true) {
                    pinned = false;
                }
                var default_column = {
                    text: model.caption,
                    datafield: datafield,
                    draggable: !!model.custom.colField,
                    pinned: pinned
                }
                var cus_column = {
                    cellsRenderer: function(row, column, value, rowData) {
                        if (!isNaN(value)) {
                            value = value.toString();
                        }
                        //qiyu 2016-8-31 解决ie9，placeholder插件点击后不再显示的问题
                        // return '<a href="javascript:void(0);" class="j_link_' + column + '">' + value + '</a>';
                        return '<a class="sc-cursor-point j_link_' + column + '">' + value + '</a>';
                    }
                }
                column = $.extend(default_column, cus_column, widthObj);
                break;
            case 'tpl':
                var default_column = {
                    text: model.caption,
                    datafield: datafield,
                    draggable: !!model.custom.colField,
                    sortable: (model.custom.column && model.custom.column.sortable) || false
                }
                column = $.extend(default_column, model.custom.column, widthObj);
                break;
            case 'edit_tpl':
                var default_column = {
                    text: model.caption,
                    datafield: datafield,
                    hidden: true,
                    draggable: !!model.custom.colField,
                    sortable: false //自定义显示列默认不能排序
                }
                column = $.extend(default_column, model.custom.column, widthObj);
                break;
        }
        return column;
    }

    /***
     * [_proxyColOpt description]
     * @param  {[type]} col      [description]
     * @param  {[type]} settings [description]
     * @param  {[type]} colModel [description]
     * @return {[type]}          [description]
     */
    function _proxyColOpt(col, settings, colModel) {
        var oldCellsRenderer = col.cellsRenderer;
        var oldCellClassName = col.cellClassName;

        function cellsRenderer(row, column, value, rowData) {
            var args = $(arguments).toArray();
            if (settings.editMode && colModel.name) {
                var model = $.extend(true, {}, colModel);
                var cell = '';
                if (!__isCellEditable.apply(this, args.concat([colModel, settings]))) {
                    //判断用户是否自定义了单元格渲染函数
                    if (oldCellsRenderer === _defaultCellsRenderer) {
                        model.xtype = 'static';
                        cell = WIS_EMAP_INPUT.renderPlaceHolder(model).addClass('bh-str-cut bh-form-static');
                        cell = $('<div>' + cell.prop('outerHTML') + '</div>');
                        WIS_EMAP_INPUT.formSetValue(cell, rowData, {});
                        cell = cell.html();
                    } else {
                        cell = oldCellsRenderer.apply(this, args.concat([colModel, settings]));
                    }
                } else {
                    var minHeight = 28;
                    if (model.xtype === 'textarea') {
                        minHeight = 102;
                    }
                    cell = '<div class="form-validate-block" style="min-height:' + minHeight + 'px">' +
                        '<div class="bh-form-group ' + (model.required ? 'bh-required' : '') + '" style="margin-bottom:0;background:none">' +
                        '   <label class="bh-form-label" style="display:none">' + col.text + '</label>' +
                        '        <div>' +
                        '             <div class="bh-form-placeholder bh-form-flow"></div>' +
                        WIS_EMAP_INPUT.renderPlaceHolder(model).attr('data-jsonparam', model.JSONParam).prop('outerHTML') +
                        '        </div>' +
                        '    </div>' +
                        '</div>';
                    if (model.xtype === 'radiolist') {
                        cell = '<form>' + cell + '</form>';
                    }
                }
                cell += '<div class="' + toDeleteLine + '"></div>';
                return cell;
            } else {
                if (oldCellsRenderer) {
                    if (column === 'field_checkbox') {
                        return oldCellsRenderer.apply(this, args.concat([colModel, settings])) + '<div class="' + toDeleteLine + '"></div>';
                    }
                    return oldCellsRenderer.apply(this, args.concat([colModel, settings]));
                }
            }
            return value === undefined ? '' : (value + '');
        }

        function cellClassName(row, column, value, rowData) {
            var args = $(arguments).toArray().concat([colModel, settings]);
            var className = oldCellClassName;
            if ($.isFunction(oldCellClassName)) {
                className = oldCellClassName.apply(this, args);
            }
            className = className || '';
            if (settings.editMode) {
                var isEditable = __isCellEditable.apply(this, args);
                if (!isEditable) {
                    className = className + ' bh-form-static';
                }
                if (rowData[toDeleteKey]) {
                    className += ' ' + showToDeleteLine;
                }
                if (isEditable && (column !== 'field_checkbox') && (column !== 'field_radio')) {
                    className += ' p-1';
                }
            }
            return className;
        }
        col.cellsRenderer = cellsRenderer;
        col.cellClassName = cellClassName;
        return col;
    }

    function __isCellEditable(row, column, value, rowData, colModel, settings) {
        var args = arguments;
        if (settings.isCellEditable) {
            return settings.isCellEditable.apply(this, args);
        }
        if (colModel.hasOwnProperty('readonly')) {
            return colModel.readonly !== true;
        }
        if (colModel.hasOwnProperty('grid.readonly')) {
            return colModel['grid.readonly'] !== true;
        }
        if (colModel.hasOwnProperty('xtype')) {
            return colModel.xtype !== 'static';
        }
        return true;
    }

    function _decorateRendered(jqxOptions, instance) {
        var oldRendered = jqxOptions.rendered;
        var rendered = function() {
            var editModeTimer = instance.$element.data('editModeTimer');
            clearTimeout(editModeTimer);
            if ($.isFunction(oldRendered)) {
                oldRendered.apply(this, arguments);
            }

            if (instance.settings.editMode) {
                showLoading(instance);
                editModeTimer = setTimeout(function() {
                    _setEditModeData(instance);
                }, 10);
                instance.$element.data('editModeTimer', editModeTimer);
            }
        };
        jqxOptions.rendered = rendered;
    }

    function _setEditModeData(instance) {
        var $content = instance.$element.jqxDataTable('content').find('table:not([id^="pinnedtable"])');
        var $trs = $content.find('tbody>tr');
        if ($trs.first().data('formInit')) {
            hideLoading(instance);
            return;
        }

        instance.$element.trigger('editabletatable.renderingcomponent');

        instance.$element.jqxDataTable('content').find('table tbody>tr').addClass('bh-table-form');
        $content.off('change');

        $trs.first().data('formInit', true);

        var rows = instance.$element.jqxDataTable('getRows');
        $trs.find('.form-validate-block').hover(function() {
            var offset = $(this).offset();
            $(this).find('.jqx-validator-error-info').css({
                position: 'fixed',
                top: offset.top - 27 - $('body').scrollTop() + 'px',
                left: offset.left + 8 - $('body').scrollLeft() + 'px',
                width: 'auto',
                right: 'auto'
            });
            $(this).addClass('bh-actived');
        }, function() {
            $(this).removeClass('bh-actived');
        });

        var model = instance.getModel();
        var selectModels = model.filter(function(mod) {
            return mod.xtype === 'radiolist' || mod.xtype === 'checkboxlist';
        });

        var dfds = selectModels.map(function(mod) {
            return $.ajax({
                url: mod.url,
                datatype: "json",
                success: function(resp) {
                    if (resp && resp.datas && resp.datas.code) {
                        $trs.find('[data-name="' + mod.name + '"][xtype="' + mod.xtype + '"]').data('optiondata', resp.datas.code.rows);
                    }
                }
            });
        });

        $.when.apply($, dfds).always(function() {
            $trs.emapFormInputInit({});

            $trs.each(function(i) {
                WIS_EMAP_INPUT.formSetValue($(this), rows[i], {});
                if (rows[i] && rows[i][toDeleteKey]) {
                    $(this).find('>td [data-sss] input').prop('disabled', true);
                }
                $(this).emapValidate({
                    fieldModel: model
                });
            });

            //隐藏下拉框列表项
            $('body').trigger('mousedown');
            $trs.on('mousedown', function() {
                $('body').trigger('mousedown');
            });

            var changedRowsData = instance.$element.data('changedRowsData');
            if (!changedRowsData) {
                changedRowsData = [];
                instance.$element.data('changedRowsData', changedRowsData);
            }
            $trs.on('change', function(e) {
                var $target = $(e.target);
                var $block = $target.closest('.form-validate-block');
                if ($block.length) {
                    var comp = WIS_EMAP_INPUT.core[$block.find('[xtype]').attr('xtype')];
                    if (comp) {
                        $block.closest('td').addClass(editedBg);
                    }
                }
            });

            if (changedRowsData.length) {
                $trs.each(function(i) {
                    if (changedRowsData[i]) {
                        WIS_EMAP_INPUT.formSetValue($(this), changedRowsData[i], {});
                    }
                });
            }

            //不要怀疑，上面的change是为渲染时给改变后的添加标志，下面off后再on一个debounce是解决下拉框打开时触发的change导致误加标志
            $trs.off('change').on('change', WIS_EMAP_SERV.debounce(function(e) {
                var $target = $(e.target);
                var $block = $target.closest('.form-validate-block');
                if ($block.length) {
                    var index = $block.closest('tr').index();
                    var values = WIS_EMAP_INPUT.formGetValue($block, {});
                    var key = $block.find('[data-name]').data('name');
                    if (changedRowsData[index]) {
                        //防止添加行后下拉框初次打开时，导致的change
                        if (changedRowsData[index][key] == values[key]) {
                            return;
                        }
                    } else {
                        //防止下拉框初次打开时，导致的change
                        var value = rows[index][key];
                        if (rows[index][key] === null || rows[index][key] === undefined) {
                            value = '';
                        }
                        if (value == values[key]) {
                            return;
                        }
                    }
                    $block.closest('td').addClass(editedBg);
                    if (!changedRowsData[index]) {
                        changedRowsData[index] = {};
                    }
                    changedRowsData[index][key] = values[key];
                    if (values.hasOwnProperty(key + '_DISPLAY')) {
                        changedRowsData[index][key + '_DISPLAY'] = values[key + '_DISPLAY'];
                    }
                    $target.trigger('editabletatable.cell.change', [$block.closest('tr'), values, key]);
                }
            }, 10));

            //标志已删除的行，需要放在赋值语句后面
            $trs.each(function(i) {
                if (rows[i] && rows[i][toDeleteKey]) {
                    instance.deleteRowInEditMode({
                        rowIndex: i
                    });
                }
            });

            hideLoading(instance);

            instance.$element.trigger('editabletatable.complete');
        });
    }

    function showLoading(instance) {
        var $load = instance.$element.jqxDataTable('dataloadelement');
        $load.css({
            visibility: 'visible',
            display: 'block',
            width: instance.$element.jqxDataTable('host').width()
        });
    }

    function hideLoading(instance) {
        instance.$element.jqxDataTable('dataloadelement').css({
            visibility: 'hidden',
            display: 'none',
            width: '100%'
        });
    }

    /**
     * 点击tbody上的checkbox，处理头部的checkbox是否要勾选
     * @param $input
     */
    function _scenesTableContentCheckboxClick($input, instance) {
        if (!$input.hasClass("selectAllCheckboxFlag")) {
            var $table = instance.$element;
            var $selectAllCheckbox = $table.find("div.selectAllCheckboxFlag").find("input");
            var $tableContent = $input.closest('table');
            var $checkboxList = $tableContent.find("div.bh-checkbox");
            if ($input.prop("checked")) {
                var isSelectAllFlag = true;
                $checkboxList.find("input").not(':disabled').each(function() {
                    if (!$(this).prop("checked")) {
                        isSelectAllFlag = false;
                    }
                });

                if (isSelectAllFlag) {
                    $selectAllCheckbox.prop("checked", true).addClass("selectFlag");
                } else {
                    $selectAllCheckbox.prop("checked", false).removeClass("selectFlag");
                }
            } else {
                $selectAllCheckbox.prop("checked", false).removeClass("selectFlag");
            }
        }
    }

    /**
     * 这里是关键
     * 定义一个插件 plugin
     */
    $.fn.emapdatatable = function(options, params, callback, flag) {
        var instance, initParams;
        instance = this.data('emapdatatable');
        initParams = this.data('initParams') || {};
        if (options === true) return instance;
        /**
         * 判断插件是否已经实例化过，如果已经实例化了则直接返回该实例化对象
         */
        if (!instance) {
            //params为表格渲染的初始化参数，后续表格的reload始终会携带该参数
            $(this).data('initParams', options.params);
            return this.each(function() {
                //将实例化后的插件缓存在dom结构里（内存里）
                return $(this).data('emapdatatable', new Plugin(this, options));
            });
        }
        /**
         * 优雅处： 如果插件的参数是一个字符串，则 调用 插件的 字符串方法。
         * 如 $('#id').plugin('doSomething') 则实际调用的是 $('#id).plugin.doSomething();
         * doSomething是刚才定义的接口。
         * 这种方法 在 juqery ui 的插件里 很常见。
         */
        if ($.type(options) === 'string') {
            var paramsObj = $.extend({}, initParams, params);
            var querySetting = [];
            //默认如果请求参数中有高级搜索的参数 会把其他参数合并进高级搜索参数querySetting
            //如果flag为false则不合并。
            if (typeof paramsObj.querySetting == 'undefined') {

            }
            if (typeof paramsObj.querySetting != 'undefined' && flag !== false) {
                // add by liujun 2016-12-8 originQuerySettingType  queryStting处理前后保持相同的类型，如果之前的字符串则处理完后也序列号成字符串
                var originQuerySettingType = ''
                if (typeof paramsObj.querySetting === 'string') {
                    querySetting = JSON.parse(paramsObj.querySetting);
                    originQuerySettingType = 'string'
                } else {
                    querySetting = paramsObj.querySetting
                    originQuerySettingType = 'object'
                }
                $.each(paramsObj, function(k, v) {
                    if (k != 'querySetting' && ($.type(v) == 'number' || $.type(v) == 'string' || $.type(v) == 'boolean')) {
                        querySetting.push({
                            name: k,
                            value: v,
                            linkOpt: 'and',
                            builder: 'equal'
                        });
                    }
                });

                if (originQuerySettingType === 'string') {
                    paramsObj.querySetting = JSON.stringify(querySetting);
                }
            }
            return instance[options](paramsObj, callback);
        }
        return this;
    };

    /**
     * 插件的默认值
     */
    var height = null;
    if (typeof BH_UTILS != 'undefined') {
        height = BH_UTILS.getTableHeight(10);
    }

    var localization = null;
    if (typeof Globalize != 'undefined') {
        localization = Globalize.culture("zh-CN");
        if (typeof BH_UTILS != 'undefined') {
            if (BH_UTILS.lang() === 'en') {
                localization = {};
            }
        }
    }

    /**
     * @memberOf module:emapdatatable
     * @event 'emapdatatable.created'
     * @description 表格初次渲染完成后触发的事件
     * @example
     * $el.on('emapdatatable.created',function(e,instance){
     *     console.log(instance.getResult());
     * })
     */

    /**
     * @memberOf module:emapdatatable
     * @event 'editabletatable.renderingcomponent'
     * @description 可编辑表格开始渲染组件的事件
     * @example
     * $el.on('editabletatable.renderingcomponent',function(e){
     *     console.log(e);
     * })
     */

    /**
     * @memberOf module:emapdatatable
     * @event 'editabletatable.complete'
     * @description 可编辑表格渲染完成的事件
     * @example
     * $el.on('editabletatable.complete',function(e){
     *     console.log(instance.getResult());
     * })
     */

    /**
     * @memberOf module:emapdatatable
     * @event 'editabletatable.cell.change'
     * @description 可编辑表格单元格值改变事件
     * @param {DOM} $tr 发生改变的行元素
     * @param {Object} value 改变后整行的值
     * @param {String} key 发生改变的字段
     * @example
     * $el.on('editabletatable.cell.change',function(e,$tr,value,key){
     *     console.log(value);
     * })
     */

    /**
     * @memberof module:emapdatatable
     * @description 其他参数参考jqxDatatable{@link http://www.jqwidgets.com/jquery-widgets-documentation/documentation/jqxdatatable/jquery-datatable-api.htm?search=}
     * @prop {String} [pk=WID] - 数据主键字段
     * @prop {String} [url] - 请求表格数据的后台接口, url和pagePath二选一必填
     * @prop {String} [pagePath] - 请求表格数据页面地址, url和pagePath二选一必填
     * @prop {Object} params - 请求参数
     * @prop {Array} datamodel - 一般为emap返回的数据模型
     * @prop {String} action - emap动作名
     * @prop {Array} customColumns - 自定义表格列,colIndex:该自定义位于表格第几列，从0开始，最后一列可以设置‘last’； colField: 自定义列作用的列模型字段； type: 自定义列类型，支持checkbox，link，tpl。chekcbox不可定义colField参数，如果定义了colIndex，则customColumns数组必须按照colIndex值由小到大排序
     * @prop {Int|Stirng} [height] - 高度
     * @prop {Boolean} [pageable=true] - 是否分页
     * @prop {String} [pagerMode=advanced] - 分页形式 'advanced' 'simple'
     * @prop {Boolean} [serverProcessing=true] - 是否开启服务端分页
     * @prop {Array} [pageSizeOptions=['10', '20', '50', '100']] - 分页条数选项
     * @prop {String} [localization='zh-CN'] - 语言选择
     * @prop {Boolean} [sortable=false] - 排序
     * @prop {String} [selectionMode='custom'] - Sets or gets the selection mode. Possible values: "multipleRows", "singleRow" and "custom". In the "custom" mode, rows could be selected/unselected only through the API.
     * @prop {Boolean} [enableBrowserSelection=true] - Enables or disables the default text selection of the web browser.
     * @prop {Boolean} [columnsResize=true] - Sets or gets the jqxDataTable's columnsResize.
     * @prop {Boolean} [colHasMinWidth=true] - 列宽是否有默认最小值100px
     * @prop {Boolean} [schema=true] - 启用schema，必须定义 contextPath   &&  未定义contextPath时   schema 不生效
     * @prop {String} [contextPath] - 根路径
     * @prop {Int} [minLineNum] - 最小高度行数
     * @prop {Boolean} [fastRender=false] - 快速渲染， 用于提高表格渲染速度
     * @prop {Function} [beforeSend] - 请求发送前的回调函数
     * @prop {Function} [downloadComplete] - 表格数据请求完成的回调
     * @prop {Boolean} [isOnceEmpty=false] - 表格默认是否为空，不加载数据
     * @prop {Boolean} [mustSelect=true] - 自定义显示列弹窗是否开启必须勾选字段校验
     * @prop {Boolean} [columnsReorder=false] - 是否开启列拖拽排序
     * @example
        $el.emapdatatable({
            pagePath: bs.api.pageModel,
            action: 'T_PXXX_XSJBXX_QUERY',
            customColumns: [{
                colIndex: '0',
                type: 'checkbox'
            }]
        });
     */
    $.fn.emapdatatable.defaults = {
        width: '100%',
        height: height,
        pageable: true,
        pagerMode: 'advanced',
        serverProcessing: true,
        pageSizeOptions: ['10', '20', '50', '100'],
        localization: localization,
        sortable: false,
        columnsReorder: false,
        selectionMode: "custom",
        enableBrowserSelection: true,
        incrementalSearch: false,
        columnsResize: true,
        defaultParams: false,
        onceParams: false,
        colHasMinWidth: true, // 列宽是否有默认最小值100px
        beforeSend: null,
        contextPath: '', //
        schema: true, // 启用schema，必须定义 contextPath   &&  未定义contextPath时   schema 不生效
        minLineNum: null,
        alwaysHide: ['WID', 'TBRQ', 'TBLX', 'CZRQ', 'CZZ', 'CZZXM'], // 自定义显示列的隐藏字段
        fastRender: false,
        canEdit: true,
        isCellEditable: null,
        isEditMode: false,
        editPageable: false,
        isOnceEmpty: false,
        mustSelect: true
    };

}).call(this);
;
(function($) {
    /**
     * @module emapDropdownZTree
     * @alias 下拉树
     * @description 内部依赖ztree
     */
    var Plugin = (function() {
        function Plugin(element, options) {
            if (WIS_EMAP_CONFIG.dropDownOneKeySelect) {
                this.settings = $.extend({}, $.fn.emapDropdownZTree.defaults, {
                    oneKeySelect: WIS_EMAP_CONFIG.dropDownOneKeySelect
                }, options);
            } else {
                this.settings = $.extend({}, $.fn.emapDropdownZTree.defaults, options);
            }
            this.$element = $(element);
            _create(this);
        }
        /**
         * @method getValue
         * @description 取值
         * @return {String} 当前下拉树选中的值，多值以逗号分隔
         */
        Plugin.prototype.getValue = function() {
            return $(this.$element.data('values')).map(function() {
                return this.value;
            }).get().join(',');
        };
        /**
         * @method getText
         * @description 获取选中文字
         * @return 当前下拉树选中的值的文字，多值以逗号分隔
         */
        Plugin.prototype.getText = function() {
            return $(this.$element.data('values')).map(function() {
                return this.label;
            }).get().join(',');
        };

        /**
         * @method setValue
         * @description 赋值
         * @param {Array} params - 0 val 1 val_display
         */
        Plugin.prototype.setValue = function(params) {
            var val = params[0];
            var display_val = params[1];
            var settings = this.settings;
            if (val === '') {
                this.$element.emapDropdownZTree('clearSelect');
                return this.$element.jqxDropDownButton('setContent', settings.placeholderContent);
            }
            if (display_val === undefined && console) {
                console.error('下拉树缺少display字段');
            } else {
                this.$element.jqxDropDownButton('setContent', display_val);
                var val_array = val.split(',');
                var display_array = display_val.split(',');
                var value_data = [];
                val_array.map(function(item, i) {
                    value_data.push({
                        value: item,
                        label: display_array[i]
                    });
                });
                this.$element.data('values', value_data);
                this.settings.$tree.data('values', value_data);
                this.$element.trigger('change');
            }
        };

        /**
         * @method disable
         * @description 禁用
         */
        Plugin.prototype.disable = function() {
            this.$element.jqxDropDownButton({
                disabled: true
            });
        };
        /**
         * @method enable
         * @description 启用
         */
        Plugin.prototype.enable = function() {
            this.$element.jqxDropDownButton({
                disabled: false
            });
        };

        /**
         * @method clearSelect
         * @description 清空选中
         */
        Plugin.prototype.clearSelect = function() {
            if (this.settings.checkboxes === true) {
                // 多选清空
                this.settings.$tree.bhTree('checkAllNodes', false);
            } else {
                // 单选清空
                this.settings.$tree.bhTree('cancelSelectedNode');
            }
            this.$element.jqxDropDownButton('setContent', '');
            this.$element.data('values', []);
        };

        /**
         * @method getSource
         * @description 获取当前下拉树的数据
         * @return {Array} - 下拉树的数据
         */
        Plugin.prototype.getSource = function() {
            var items = [];
            if (this.settings.checkboxes) {
                items = this.settings.$tree.bhTree('getCheckedNodes');
            } else {
                items = this.settings.$tree.bhTree('getSelectedNodes');
            }
            var records = [];
            if (items.length === 0) {
                return [];
            }
            items.forEach(function(n) {
                if (WIS_I18N.i18n.locale === 'zh') {
                    if (n.name !== '加载中...') {
                        n.value = n.id;
                        records.push(n);
                    }
                } else {
                    if (n.name !== 'Loading...') {
                        n.value = n.id;
                        records.push(n);
                    }
                }

            });
            return records;
        };

        return Plugin;

    })();

    function _create(instance) {
        var $dom = instance.$element;
        var setting = instance.settings;
        if ($.isNumeric(setting.unselectableLevel)) {
            setting.unselectableLevel = setting.unselectableLevel.toString();
        }
        setting.unselectableLevel = (setting.unselectableLevel && setting.unselectableLevel.split(',')) || [];
        setting.placeholderContent = '<span style="color: #ddd;">' + setting.placeholder + '<span>';
        var num = '';
        for (var i = 0; i < 6; i++) {
            num += Math.floor(Math.random() * 10);
        }
        var treeHeight = 245;
        if (setting.search) {
            treeHeight = treeHeight - 25;
        }
        if (setting.oneKeySelect && setting.checkboxes) {
            treeHeight = treeHeight - 20;
        }
        setting.$treeContainer = $('<div class="ztree-container" style="height:' + treeHeight + 'px;width:100%"><div style="border: none;" class="dropdown-tree" id="' + num + '"></div></div>');
        $dom.append('<div class="drop" style="overflow:hidden"></div>').find('div.drop').append(setting.$treeContainer);


        setting.$tree = setting.$treeContainer.find('.dropdown-tree');
        $dom.jqxDropDownButton({
            enableBrowserBoundsDetection: true,
            width: setting.width ? setting.width : "100%",
            dropDownHeight: '245px',
            dropDownWidth: setting.width ? setting.width : "100%",
        });
        $dom.jqxDropDownButton('setContent', setting.placeholderContent);

        $dom.on('close', function() {
            $(this).trigger('change');
        }).on('open', function() {
            //勾选赋值的节点
            var values = setting.$tree.data('values');
            if (values && values.length && !setting.checkboxes) {
                var nodes = setting.$tree.bhTree('getNodesByFilter', function(node) {
                    var isMatch = false;
                    var name = node.name;
                    if (setting.unblind) {
                        name = name.split(setting.unblind).slice(-1)[0];
                    }
                    $(values).each(function() {
                        if (this.value === node.id) {
                            isMatch = true;
                            return false;
                        }
                    });
                    return isMatch;
                });
                nodes.forEach(function(node) {
                    setting.$tree.bhTree('selectNode', node);
                });
                setting.$tree.removeData('values');
            }
        });
        _renderTree($dom, setting);
        setting.$treeContainer.niceScroll();
    }

    function _renderOneKeySelect($dom, setting) {
        if (setting.oneKeySelect && setting.checkboxes) {
            setting.$select = $('<div class="bh-form-group" style="padding-left:2px;margin-bottom:0">' +
                '<div class="bh-checkbox" style="padding-top:0">' +
                '<label style="margin-bottom:0">' +
                '<input type="checkbox" value="">' +
                '<i class="bh-choice-helper"></i>' + $.i18n('bh-ddt-allChoose') +
                '</label>' +
                '</div>' +
                '</div>');
            setting.$treeContainer.before(setting.$select);
            var $tree = setting.$tree;
            setting.$select.on('change', 'input', function() {
                $tree.bhTree('checkAllNodes', $(this).prop('checked'));
                var blank = $tree.bhTree('getNodeByParam', 'id', '@__blank__value');
                if (blank) {
                    $tree.bhTree('checkNode', blank, false);
                }
                __setData($dom, setting);
            });
        }
    }

    function _renderTree($dom, setting) {
        _renderFilter($dom, setting);
        _renderOneKeySelect($dom, setting);
        var zSetting = _getZtreeOption($dom, setting);
        setting.$tree.bhTree(zSetting);
    }

    function _renderFilter($dom, setting) {
        if (setting.search) {
            var $searchInput = $('<input style="height: 21px; top: 3px; left: 3px;  width: calc(100% - 4px); margin: 2px 0 2px 2px; border-radius: 2px;" class="treeSearchInput jqx-widget jqx-listbox-filter-input jqx-input jqx-rc-all" type="text" placeHolder="' + $.i18n("bh-ddt-search") + '..."/>');
            setting.$treeContainer.parent().prepend($searchInput);
            WIS_EMAP_INPUT.placeHolder($searchInput);
            $searchInput.keyup(WIS_EMAP_SERV.debounce(function() {
                var value = $searchInput.val();
                _refreshTree(setting, value, $dom);
            }, 500));
        }
    }

    function _getZtreeOption($dom, setting) {
        var zNodes = null;

        // 若有datas参数，将datas缓存， 后面前端搜索会使用
        if (!setting.url && setting.datas) {
            zNodes = setting.datas;
            setting.$tree.data('localdata', zNodes);
        }

        var zSetting = {
            callback: {},
            view: {
                isHoverLine: false,
                showIcon: false,
                showLine: false,
                selectedMulti: false
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey: 'id',
                    pIdKey: 'pId'
                }
            }
        };

        if (setting.url) {
            var data = $.extend({
                // 'pId': ''
            }, setting.params);

            if (setting.params && setting.params.searchValue) {
                data = setting.params;
            }
            setting.$tree.data('originalParam', data);
            zSetting.async = {
                autoParam: ['id=pId'],
                enable: true,
                url: setting.url,
                dataFilter: function() {
                    return _dataFilter.apply(this, $(arguments).toArray().concat(setting, data));
                },
                otherParam: data
            };
        }

        if (setting.datas) {
            if (!setting.parentNodeSelectable) {
                __disableParentNodeChk(setting.datas);
            }
            ____disableNodeChkByLevels(setting.datas, setting);
            setting.zNodes = __unblindNodes(setting.datas, setting);
        }

        if (setting.checkboxes) {
            zSetting.check = {
                enable: true,
                chkboxType: {
                    Y: 's',
                    N: 'ps'
                }
            };
            zSetting.callback.onCheck = function() {
                _onCheck.apply(this, $(arguments).toArray().concat(setting, $dom));
            };
            zSetting.callback.beforeCheck = function(treeId, treeNode, clickFlag) {
                _isSelectable.apply(this, [treeId, treeNode, clickFlag, setting]);
            };
        } else {
            zSetting.callback.onClick = function() {
                _onClick.apply(this, $(arguments).toArray().concat(setting, $dom));
            };
            zSetting.callback.beforeClick = function(treeId, treeNode, clickFlag) {
                _isSelectable.apply(this, [treeId, treeNode, clickFlag, setting]);
            };
        }
        return {
            setting: zSetting,
            zNodes: zNodes
        };
    }

    function _refreshTree(setting, value, $dom) {
        var zSetting = _getZtreeOption($dom, setting);
        var isCheckParent = false;
        if (setting.url) { // 有url参数时， 为远程搜索
            var params = null;
            if (value) {
                var source = {
                    '*tree': "1",
                    searchValue: value,
                    checkParent: true
                };
                params = $.extend({}, setting.params, source);
                zSetting.setting.async.dataFilter = function() {
                    return _searchDataFilter.apply(this, $(arguments).toArray().concat(setting, params));
                };
            } else {
                params = setting.$tree.data('originalParam');
            }
            isCheckParent = params && params.checkParent;
            zSetting.setting.async.otherParam = params;
        } else { // 没有url时， 为本地搜索
            var datas = null;
            if (value) {
                if (!setting.datas && console) {
                    console.error('tree need datas options');
                }
                datas = _filterLocalData(setting.$tree.data('localdata'), value, setting);
            } else {
                datas = setting.$tree.data('localdata');
            }
            zSetting.zNodes = datas;
        }
        setting.$tree.bhTree('destroyTree');
        setting.$tree.bhTree(zSetting);
    }

    // 前端搜索
    function _filterLocalData(data, val, setting) {
        var nodes = [];
        if (data.length) {
            data.map(function(item) {
                if (item.name.indexOf(val) > -1) {
                    nodes.push(item);
                }
            });
            // 向上遍历父节点加入搜索结果
            var len = nodes.length;
            for (var i = 0; i < len; i++) {
                nodes = nodes.concat(_getFatherNode(data, nodes[i]));
            }
        }
        if (typeof setting.downloadComplete === 'function') {
            var result = setting.downloadComplete(nodes, val);
            if (result) {
                nodes = result;
            }
        }
        return nodes;
    }

    function _getFatherNode(data, childNode) {
        if (childNode.pId !== undefined && childNode.pId !== null && childNode.pId !== '') {
            var node_list = [];
            var father_node = data.filter(function(item) {
                return item.id === childNode.pId;
            })[0];
            if (father_node) {
                node_list.push(father_node);
                if (father_node.pId !== undefined && father_node.pId !== null && father_node.pId !== '') {
                    node_list = node_list.concat(_getFatherNode(data, father_node));
                }
            }
            return node_list;
        } else {
            return [];
        }
    }

    function _dataFilter(treeId, parentNode, childNodes, setting, param) {
        var placeholder = __getPlaceHolder(parentNode, setting);
        var nodes = childNodes;
        if (childNodes.code === '0' && childNodes.datas.code) {
            nodes = childNodes.datas.code.rows;
            __unblindNodes(nodes, setting);
            if (parentNode) {
                var level = parentNode.getPath().length + 1;
                if (setting.unselectableLevel.length) {
                    var levels = setting.unselectableLevel;
                    var isMatch = levels.indexOf(level + '') > -1;
                    if (isMatch) {
                        nodes.forEach(function(item) {
                            if (item.pId === parentNode.id) {
                                item.chkDisabled = true;
                            }
                        });
                    }
                }
            } else {
                ____disableNodeChkByLevels(nodes, setting);
            }
            _checkNodesByValue(nodes, setting);
            nodes = _sortfyData(nodes);
        }
        if ($.isArray(childNodes)) {
            nodes = $.extend(true, [], childNodes);
            __unblindNodes(nodes, setting);
            ____disableNodeChkByLevels(nodes, setting);
            _checkNodesByValue(nodes, setting);
            nodes = _sortfyData(childNodes);
        }
        if (!setting.parentNodeSelectable) {
            __disableParentNodeChk(nodes, setting);
        }
        if (typeof setting.downloadComplete === 'function') {
            var result = setting.downloadComplete(nodes, param);
            if (result) {
                nodes = result;
            }
        }
        return placeholder.concat(nodes);
    }

    function __unblindNodes(nodes, setting) {
        if (setting.unblind) {
            var unblind = setting.unblind;
            nodes.forEach(function(node) {
                if (node.name) {
                    node.name = node.name.split(unblind).slice(-1)[0];
                }
            });
        }
    }

    function _checkNodesByValue(nodes, setting) {
        if (setting.checkboxes) {
            var values = setting.$tree.data('values');
            if (values && values.length) {
                var map = {};
                values.forEach(function(val) {
                    map[val.value] = val.label;
                });
                nodes.forEach(function(node) {
                    if (map[node.id]) {
                        node.checked = true;
                    }
                });
                setting.$tree.removeData('values');
            }
        }
    }

    function _searchDataFilter(treeId, parentNode, childNodes, setting, param) {
        var placeholder = __getPlaceHolder(parentNode, setting);
        var nodes = childNodes;
        if (childNodes.code === '0' && childNodes.datas.code) {
            ____disableNodeChkByLevels(childNodes.datas.code.rows, setting);
            __unblindNodes(childNodes.datas.code.rows, setting);
            nodes = _sortfyData(childNodes.datas.code.rows, true);
        } else {
            if ($.isArray(nodes)) {
                nodes = $.extend(true, [], nodes);
                ____disableNodeChkByLevels(nodes, setting);
                __unblindNodes(childNodes.datas.code.rows, setting);
                nodes = _sortfyData(nodes, true);
            }
        }
        if (!setting.parentNodeSelectable) {
            __disableParentNodeChk(nodes);
        }
        if (typeof setting.downloadComplete === 'function') {
            var result = setting.downloadComplete(nodes, param);
            if (result) {
                nodes = result;
            }
        }
        return placeholder.concat(nodes);
    }

    function __disableParentNodeChk(nodes) {
        nodes.forEach(function(node) {
            if (node.isParent) {
                node.chkDisabled = true;
            }
            if (node.children) {
                __disableParentNodeChk(node.children);
            }
        });
    }

    //allNodes是不含子数组的数组
    function ____disableNodeChkByLevels(allNodes, setting) {
        if (setting.unselectableLevel.length) {
            var levels = setting.unselectableLevel;
            allNodes.forEach(function(node) {
                var isDisable = _checkNodeIsSelectableByLevels(node, allNodes, levels);
                if (isDisable) {
                    node.chkDisabled = true;
                }
            });
        }
    }

    function __getPlaceHolder(parentNode, setting) {
        var placeholder = [];
        if (!parentNode) {
            if (!setting.checkboxes) {
                placeholder = [{
                    name: $.i18n('bh-ddt-pleaseChoose') + '...',
                    pId: '...',
                    id: undefined
                }];
            }
            if (setting.showBlankOption) {
                placeholder.push({
                    id: '@__blank__value',
                    name: '[' + $.i18n('bh-ddt-empty') + ']',
                    pId: '...'
                });
            }
        }
        return placeholder;
    }

    //按照如上格式序列化数据
    function _sortfyData(nodes, isOpen) {
        var cNodes = [];
        var pNodes = nodes.filter(function(node) {
            if (node.pId) {
                cNodes.push(node);
            } else {
                return true;
            }
        });
        __groupCNodesByPNodes(pNodes, cNodes, isOpen);
        return nodes;
    }

    function __groupCNodesByPNodes(pNodes, cNodes, isOpen) {
        pNodes.forEach(function(pNode) {
            pNode.isParent = false;
            $(cNodes).each(function(i) {
                if (this.pId === pNode.id) {
                    pNode.isParent = true;
                    pNode.open = !!isOpen;
                    cNodes.splice(i, 1);
                    return false;
                }
            });
        });
    }

    function __getNodeByPId(pId, nodes) {
        var node = null;
        $(nodes).each(function() {
            if (this.id === pId) {
                node = this;
                return false;
            }
            if (this.children) {
                var pNode = __getNodeByPId(pId, this.children);
                if (pNode) {
                    node = pNode;
                    return false;
                }
            }
        });
        return node;
    }

    function _isSelectable(treeId, treeNode, clickFlag, setting) {
        if (treeNode.id === '@__blank__value' || treeNode.id === '') {
            return true;
        }
        if (!setting.parentNodeSelectable && treeNode.isParent) {
            return false;
        }
        if (setting.unselectableLevel.length) {
            var levels = setting.unselectableLevel;
            var level = treeNode.level + 1;
            return levels.indexOf(level + '') === -1;
        }
        return true;
    }

    function _checkNodeIsSelectableByLevels(node, nodes, levels) {
        var level = 1;
        var getNodeLevel = function(zNode) {
            if (zNode.pId) {
                var node = __getNodeByPId(zNode.pId, nodes);
                if (node) {
                    level++;
                    return getNodeLevel(node);
                }
            }
            return level;
        };
        level = getNodeLevel(node) + '';
        return levels.indexOf(level) > -1;
    }

    function _onClick(event, treeId, treeNode, flag, setting, $dom) {
        __setData($dom, setting);
    }

    function _onCheck(event, treeId, treeNode, setting, $dom) {
        // 多选下拉树选中时获取全路径
        if (setting.showBlankOption) {
            var blank = {
                id: '@__blank__value',
                name: '[' + $.i18n('bh-ddt-empty') + ']',
                pId: '...'
            };
            var checked = treeNode.checked;
            if (treeNode.id === blank.id) {
                if (checked) {
                    if (setting.$select) {
                        setting.$select.find('input').prop('checked', false);
                    }
                    var treeObj = setting.$tree.bhTree(true);
                    setting.$tree.bhTree('getCheckedNodes').forEach(function(node) {
                        if (node.level === 0 && node.checked && node.id !== blank.id) {
                            treeObj.checkNode(node, false, true);
                        }
                    });
                }
            } else {
                var blankNode = setting.$tree.bhTree('getNodesByParam', 'id', blank.id);
                blankNode.forEach(function(node) {
                    setting.$tree.bhTree('checkNode', node, false);
                });
            }
        }

        var pNode = treeNode.getParentNode();
        if (pNode) {
            if (pNode.check_Child_State === 2 && pNode.checked === false) {
                setting.$tree.bhTree('checkNode', pNode);
            }
        }

        __setData($dom, setting);

        if (setting.oneKeySelect) {
            if (treeNode.checked) {
                var isSelectedAll = setting.$tree.bhTree('getCheckedNodes').length === setting.$tree.bhTree('getAllData').length;
                setting.$select.find('input').prop('checked', isSelectedAll);
            } else {
                setting.$select.find('input').prop('checked', false);
            }
        }
    }

    //赋值
    function __setData($dom, setting) {
        var items = [];
        if (setting.checkboxes) {
            //多选下拉树选中时获取全路径
            items = setting.$tree.bhTree('getCheckedNodes');
        } else {
            items = setting.$tree.bhTree('getSelectedNodes');
        }
        var values = [];
        if (setting.checkboxes) {
            items = items.filter(function(item) {
                if (item.isParent) {
                    return item.check_Child_State === 2 || item.check_Child_State === -1;
                }
                return true;
            });
        } else {
            var parentNodeSelectable = setting.parentNodeSelectable;
            var unselectableLevel = setting.unselectableLevel;
            items = items.filter(function(node) {
                if (!parentNodeSelectable) {
                    return !node.isParent && unselectableLevel.indexOf(node.level + 1 + '') === -1;
                }
                return unselectableLevel.indexOf(node.level + 1 + '') === -1;
            });
            if (items.length) {
                var isSelectable = $dom.triggerHandler("select", [values, setting.$tree, items[0]]);
                if (!(isSelectable === undefined || isSelectable)) {
                    return;
                }
            } else {
                return;
            }
        }

        var dropDownContent = items.map(function(cv) {
            if (WIS_I18N.lang == 'zh') {
                if (cv.name !== "加载中...") {
                    values.push({
                        "label": cv.name,
                        "value": cv.id
                    });
                    if (cv.getPath) {
                        return cv.getPath().map(function(item) {
                            return item.name;
                        }).join("/");
                    }
                }
            } else {
                if (cv.name !== "Loading...") {
                    values.push({
                        "label": cv.name,
                        "value": cv.id
                    });
                    if (cv.getPath) {
                        return cv.getPath().map(function(item) {
                            return item.name;
                        }).join("/");
                    }
                }
            }
        }).join(",");
        dropDownContent = dropDownContent.replace(/,+/g, ',').replace(/,$/, '') || setting.placeholderContent;

        $dom.jqxDropDownButton('setContent', dropDownContent);
        $dom.data({
            "values": values
        });

        $dom.trigger('change');

        if (!setting.checkboxes && values.length) {
            if (items.length) {
                $dom.jqxDropDownButton('close');
            }
        }
    }

    $.fn.emapDropdownZTree = function(options, params) {
        var instance;
        instance = this.data('emapDropdownZTree');
        if (options === true) {
            return instance;
        }
        if (!instance) {
            return this.each(function() {
                return $(this).data('emapDropdownZTree', new Plugin(this, options));
            });
        }
        if ($.type(options) === 'string') {
            return instance[options](params);
        }
        return this;
    };


    /**
     * @memberof module:emapDropdownZTree
     * @prop {Array} datas - 下拉树数据，emap格式，与url二选一必须
     * @prop {String} url - 下拉树数据请求地址， 与datas二选一必须
     * @prop {Boolean} [checkboxes=false] - 是否多选
     * @prop {Boolean} [search=true] - 是否允许搜索
     * @prop {String} [unblind] - 节点层次关系分隔符
     * @prop {String} [placeholder=请选择] - 占位符提示文字
     * @prop {Boolean} [parentNodeSelectable=true] - 父级节点是否允许选中
     * @prop {String} [unselectableLevel] - 指定层级无法选中如 '1,2', 多层级用 , 分隔
     * @prop {Function} [downloadComplete] - 数据请求完毕后的回调函数
     * @prop {Object} [treeParams] - 树组件参数，如配置下拉属于父子节点联动：
     * $('.tree_multi_linkage').emapDropdownZTree({
                url: url,
                checkboxes: true,
                treeParams: {
                    hasThreeStates: true
                }
            })

     * @prop {Boolean} [showBlankOption=false] - 是否显示空值选项
     */
    $.fn.emapDropdownZTree.defaults = {
        // url: 'http://demoapp.wisedu.com/emap/code/c9fe4e9d-5460-4372-87ca-437d373c2531.do',
        placeholder: $.i18n('bh-ddt-pleaseChoose') + '...',
        width: "100%",
        unblind: '',
        checkboxes: false,
        showBlankOption: false,
        search: true,
        parentNodeSelectable: true,
        unselectableLevel: "",
        oneKeySelect: false,
        downloadComplete: null
    };
})(jQuery);
